(function(as,$t){typeof exports=="object"&&typeof module<"u"?$t(exports):typeof define=="function"&&define.amd?define(["exports"],$t):(as=typeof globalThis<"u"?globalThis:as||self,$t(as.vpcr={}))})(this,function(as){"use strict";var qz=Object.defineProperty;var jz=(as,$t,yr)=>$t in as?qz(as,$t,{enumerable:!0,configurable:!0,writable:!0,value:yr}):as[$t]=yr;var ka=(as,$t,yr)=>(jz(as,typeof $t!="symbol"?$t+"":$t,yr),yr);var $t=typeof document<"u"?document.currentScript:null;/**
 * @license
 * PlayCanvas Engine v1.69.1 revision 71bd87f (RELEASE)
 * Copyright 2011-2024 PlayCanvas Ltd. All rights reserved.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */const yr="RenderFrame",_E="RenderFrameTime",gE="RenderPass",yE="RenderPassDetail",vE="RenderAction",xE="RenderTargetAlloc",SE="TextureAlloc",bE="ShaderAlloc",TE="ShaderCompile",wE="VRAM.Texture",EE="VRAM.Vb",AE="VRAM.Ib",CE="BindGroupAlloc",ME="BindGroupFormatAlloc",PE="RenderPipelineAlloc",RE="ComputePipelineAlloc",IE="PipelineLayoutAlloc",DE="Element",LE="Textures",FE="RenderQueue",oy="GpuTimings",jf="1.69.1",Yf="71bd87f",OE={},BE={},NE={},kE={},UE=["undefined","number","string","boolean"],zE={"[object Array]":"array","[object Object]":"object","[object Function]":"function","[object Date]":"date","[object RegExp]":"regexp","[object Float32Array]":"float32array"};function Uc(o){if(o===null)return"null";const e=typeof o;return UE.includes(e)?e:zE[Object.prototype.toString.call(o)]}function Gi(o,e){for(const t in e){const s=e[t];Uc(s)==="object"?o[t]=Gi({},s):Uc(s)==="array"?o[t]=Gi([],s):o[t]=s}return o}class Ua{static set(e,t=!0){}static get(e){return Ua._traceChannels.has(e)}}Ua._traceChannels=new Set,Ua.stack=!1;class ly{constructor(e,t,s,i,n=!1){this.handler=void 0,this.name=void 0,this.callback=void 0,this.scope=void 0,this._once=void 0,this._removed=!1,this.handler=e,this.name=t,this.callback=s,this.scope=i,this._once=n}off(){this._removed||this.handler.off(this.name,this.callback,this.scope)}on(e,t,s=this){return this.handler._addCallback(e,t,s,!1)}once(e,t,s=this){return this.handler._addCallback(e,t,s,!0)}set removed(e){e&&(this._removed=!0)}get removed(){return this._removed}}class Q{constructor(){this._callbacks=new Map,this._callbackActive=new Map}initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(e,t,s,i){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){const r=this._callbackActive.get(e);r&&r===this._callbacks.get(e)&&this._callbackActive.set(e,r.slice())}const n=new ly(this,e,t,s,i);return this._callbacks.get(e).push(n),n}on(e,t,s=this){return this._addCallback(e,t,s,!1)}once(e,t,s=this){return this._addCallback(e,t,s,!0)}off(e,t,s){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(const[i,n]of this._callbackActive)this._callbacks.has(i)&&this._callbacks.get(i)===n&&this._callbackActive.set(i,n.slice());if(e)if(t){const i=this._callbacks.get(e);if(!i)return this;for(let n=0;n<i.length;n++)i[n].callback===t&&(s&&i[n].scope!==s||(i[n].removed=!0,i.splice(n,1),n--));i.length===0&&this._callbacks.delete(e)}else{const i=this._callbacks.get(e);if(i){for(let n=0;n<i.length;n++)i[n].removed=!0;this._callbacks.delete(e)}}else{for(const i of this._callbacks.values())for(let n=0;n<i.length;n++)i[n].removed=!0;this._callbacks.clear()}return this}fire(e,t,s,i,n,r,a,l,h){if(!e)return this;const c=this._callbacks.get(e);if(!c)return this;let d;this._callbackActive.has(e)?this._callbackActive.get(e)!==c&&(d=c.slice()):this._callbackActive.set(e,c);for(let u=0;(d||this._callbackActive.get(e))&&u<(d||this._callbackActive.get(e)).length;u++){const f=(d||this._callbackActive.get(e))[u];if(f.callback&&(f.callback.call(f.scope,t,s,i,n,r,a,l,h),f._once)){const p=this._callbacks.get(e),_=p?p.indexOf(f):-1;if(_!==-1){this._callbackActive.get(e)===p&&this._callbackActive.set(e,this._callbackActive.get(e).slice());const m=this._callbacks.get(e);if(!m)continue;m[_].removed=!0,m.splice(_,1),m.length===0&&this._callbacks.delete(e)}}}return d||this._callbackActive.delete(e),this}hasEvent(e){var t;return!!((t=this._callbacks.get(e))!=null&&t.length)}}const zc={attach(o){const e=zc;return o._addCallback=e._addCallback,o.on=e.on,o.off=e.off,o.fire=e.fire,o.once=e.once,o.hasEvent=e.hasEvent,Q.prototype.initEventHandler.call(o),o},_addCallback:Q.prototype._addCallback,on:Q.prototype.on,off:Q.prototype.off,fire:Q.prototype.fire,once:Q.prototype.once,hasEvent:Q.prototype.hasEvent},hy={create(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){const e=Math.random()*16|0;return(o==="x"?e:e&3|8).toString(16)})}},ce={delimiter:"/",join(...o){let e=o[0];for(let t=0;t<o.length-1;t++){const s=o[t],i=o[t+1];if(i[0]===ce.delimiter){e=i;continue}s&&i&&s[s.length-1]!==ce.delimiter&&i[0]!==ce.delimiter?e+=ce.delimiter+i:e+=i}return e},normalize(o){const e=o.startsWith(ce.delimiter),t=o.endsWith(ce.delimiter),s=o.split("/");let i="",n=[];for(let r=0;r<s.length;r++)if(s[r]!==""&&s[r]!=="."){if(s[r]===".."&&n.length>0){n=n.slice(0,n.length-2);continue}r>0&&n.push(ce.delimiter),n.push(s[r])}return i=n.join(""),!e&&i[0]===ce.delimiter&&(i=i.slice(1)),t&&i[i.length-1]!==ce.delimiter&&(i+=ce.delimiter),i},split(o){const e=o.lastIndexOf(ce.delimiter);return e!==-1?[o.substring(0,e),o.substring(e+1)]:["",o]},getBasename(o){return ce.split(o)[1]},getDirectory(o){return ce.split(o)[0]},getExtension(o){const e=o.split("?")[0].split(".").pop();return e!==o?"."+e:""},isRelativePath(o){return o.charAt(0)!=="/"&&o.match(/:\/\//)===null},extractPath(o){let e="";const t=o.split("/");let s=0;if(t.length>1)if(ce.isRelativePath(o))if(t[0]===".")for(s=0;s<t.length-1;++s)e+=s===0?t[s]:"/"+t[s];else if(t[0]==="..")for(s=0;s<t.length-1;++s)e+=s===0?t[s]:"/"+t[s];else for(e=".",s=0;s<t.length-1;++s)e+="/"+t[s];else for(s=0;s<t.length-1;++s)e+=s===0?t[s]:"/"+t[s];return e}};var cy,dy,uy;const VE=()=>{let o=!1;try{const e=Object.defineProperty({},"passive",{get:function(){return o=!0,!1}});window.addEventListener("testpassive",null,e),window.removeEventListener("testpassive",null,e)}catch{}return o},Si=typeof navigator<"u"?navigator.userAgent:"",En=typeof window<"u"?"browser":typeof global<"u"?"node":"worker",Pl=/android/i.test(Si)?"android":/ip([ao]d|hone)/i.test(Si)?"ios":/windows/i.test(Si)?"windows":/mac os/i.test(Si)?"osx":/linux/i.test(Si)?"linux":/cros/i.test(Si)?"cros":null,GE=En!=="browser"?null:/(Chrome\/|Chromium\/|Edg.*\/)/.test(Si)?"chrome":/Safari\//.test(Si)?"safari":/Firefox\//.test(Si)?"firefox":"other",WE=/xbox/i.test(Si),HE=En==="browser"&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),XE=En==="browser"&&(!!navigator.getGamepads||!!navigator.webkitGetGamepads),$E=typeof Worker<"u",qE=VE(),ge={name:Pl,environment:En,global:(cy=(dy=(uy=typeof globalThis<"u"&&globalThis)!=null?uy:En==="browser"&&window)!=null?dy:En==="node"&&global)!=null?cy:En==="worker"&&self,browser:En==="browser",desktop:["windows","osx","linux","cros"].includes(Pl),mobile:["android","ios"].includes(Pl),ios:Pl==="ios",android:Pl==="android",xbox:WE,gamepads:XE,touch:HE,workers:$E,passiveEvents:qE,browserName:GE},fy="abcdefghijklmnopqrstuvwxyz",py="ABCDEFGHIJKLMNOPQRSTUVWXYZ",jE=fy+py,Kf=55296,my=56319,_y=56320,YE=57343,KE=8205,gy=127462,yy=127487,ZE=127995,QE=127999,JE=8400,eA=8447,Zf=65024,Qf=65039;function Jf(o,e=0){const t=o.length;if(e<0||e>=t)return null;const s=o.charCodeAt(e);if(t>1&&s>=Kf&&s<=my){const i=o.charCodeAt(e+1);if(i>=_y&&i<=YE)return{code:(s-Kf)*1024+i-_y+65536,long:!0}}return{code:s,long:!1}}function An(o,e,t){if(!o)return!1;const s=Jf(o);if(s){const i=s.code;return i>=e&&i<=t}return!1}function tA(o,e){if(e===o.length-1)return 1;if(An(o[e],Kf,my)){const t=o.substring(e,e+2),s=o.substring(e+2,e+4);return An(s,ZE,QE)||An(t,gy,yy)&&An(s,gy,yy)?4:An(s,Zf,Qf)?3:2}return An(o[e+1],Zf,Qf)?2:1}const bi={ASCII_LOWERCASE:fy,ASCII_UPPERCASE:py,ASCII_LETTERS:jE,format(o,...e){for(let t=0;t<e.length;t++)o=o.replace(`{${t}}`,e[t]);return o},getCodePoint(o,e){const t=Jf(o,e);return t&&t.code},getCodePoints(o){if(typeof o!="string")throw new TypeError("Not a string");let e=0;const t=[];let s;for(;s=Jf(o,e);)t.push(s.code),e+=s.long?2:1;return t},getSymbols(o){if(typeof o!="string")throw new TypeError("Not a string");let e=0;const t=o.length,s=[];let i=0,n;for(;e<t;){if(i+=tA(o,e+i),n=o[e+i],An(n,JE,eA)&&(n=o[e+i++]),An(n,Zf,Qf)&&(n=o[e+i++]),n&&n.charCodeAt(0)===KE){n=o[e+i++];continue}const r=o.substring(e,e+i);s.push(r),e+=i,i=0}return s},fromCodePoint(){const o=[];let e,t,s;for(let i=0;i<arguments.length;++i)e=Number(arguments[i]),t=e-65536,s=e>65535?[(t>>10)+55296,t%1024+56320]:[e],o.push(String.fromCharCode.apply(null,s));return o.join("")}};class vy{constructor(){this._list=[],this._index={}}push(e,t){if(this._index[e])throw Error("Key already in index "+e);const s=this._list.push(t)-1;this._index[e]=s}has(e){return this._index[e]!==void 0}get(e){const t=this._index[e];return t!==void 0?this._list[t]:null}remove(e){const t=this._index[e];if(t!==void 0){this._list.splice(t,1),delete this._index[e];for(e in this._index){const s=this._index[e];s>t&&(this._index[e]=s-1)}return!0}return!1}list(){return this._list}clear(){this._list.length=0;for(const e in this._index)delete this._index[e]}}const sA=o=>{const e={};let t=e;return()=>(t===e&&(t=o()),t)};class qt{static loadScript(e,t){const s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>{t(null)},s.onerror=()=>{t(`Failed to load script='${e}'`)},document.body.appendChild(s)}static loadWasm(e,t,s){const i=qt.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;i?qt.loadScript(i,n=>{if(n)s(n,null);else{const r=window[e];window[e]=void 0,r({locateFile:()=>t.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then(a=>{s(null,a)})}}):s("No supported wasm modules found.",null)}static getModule(e){return qt.modules.hasOwnProperty(e)||(qt.modules[e]={config:null,initializing:!1,instance:null,callbacks:[]}),qt.modules[e]}static initialize(e,t){if(t.initializing)return;const s=t.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(t.initializing=!0,qt.loadWasm(e,s,(i,n)=>{i?s.errorHandler?s.errorHandler(i):console.error(`failed to initialize module=${e} error=${i}`):(t.instance=n,t.callbacks.forEach(r=>{r(n)}))}))}}qt.modules={},qt.wasmSupported=sA(()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){const o=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(o instanceof WebAssembly.Module)return new WebAssembly.Instance(o)instanceof WebAssembly.Instance}}catch{}return!1});class za{static setConfig(e,t){const s=qt.getModule(e);s.config=t,s.callbacks.length>0&&qt.initialize(e,s)}static getConfig(e){var t;return(t=qt.modules)==null||(t=t[e])==null?void 0:t.config}static getInstance(e,t){const s=qt.getModule(e);s.instance?t(s.instance):(s.callbacks.push(t),s.config&&qt.initialize(e,s))}}class ep{constructor(e){this.arraybuffer=e,this.dataView=new DataView(e),this.offset=0,this.stack=[]}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e=0){this.offset=e}skip(e){this.offset+=e}align(e){this.offset=this.offset+e-1&~(e-1)}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){let t="";for(let s=0;s<e;++s)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(e){for(let t=0;t<e.length;++t)e[t]=this.readU8()}readLine(){const e=this.dataView;let t="";for(;!(this.offset>=e.byteLength);){const s=String.fromCharCode(this.readU8());if(s===`
`)break;t+=s}return t}}class Rl{constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=void 0,this._sortHandler=void 0,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(e){let t=0,s=this.items.length-1;const i=e[this._sortBy];let n,r;for(;t<=s;)n=Math.floor((t+s)/2),r=this.items[n][this._sortBy],r<=i?t=n+1:r>i&&(s=n-1);return t}_doSort(e,t){const s=this._sortBy;return e[s]-t[s]}insert(e){const t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++}append(e){this.items.push(e),this.length++}remove(e){const t=this.items.indexOf(e);t<0||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)}sort(){const e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),e!==null&&(this.loopIndex=this.items.indexOf(e))}}class Va extends Q{constructor(e){super(),this._index={},this._list=[],this._parent=e}add(){let e=!1;const t=this._processArguments(arguments,!0);if(!t.length)return e;for(let s=0;s<t.length;s++)this._index[t[s]]||(e=!0,this._index[t[s]]=!0,this._list.push(t[s]),this.fire("add",t[s],this._parent));return e&&this.fire("change",this._parent),e}remove(){let e=!1;if(!this._list.length)return e;const t=this._processArguments(arguments,!0);if(!t.length)return e;for(let s=0;s<t.length;s++)this._index[t[s]]&&(e=!0,delete this._index[t[s]],this._list.splice(this._list.indexOf(t[s]),1),this.fire("remove",t[s],this._parent));return e&&this.fire("change",this._parent),e}clear(){if(!this._list.length)return;const e=this._list.slice(0);this._list=[],this._index={};for(let t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}has(){return this._list.length?this._has(this._processArguments(arguments)):!1}_has(e){if(!this._list.length||!e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].length===1){if(this._index[e[t][0]])return!0}else{let s=!0;for(let i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(e,t){const s=[];let i=[];if(!e||!e.length)return s;for(let n=0;n<e.length;n++)if(e[n]instanceof Array){t||(i=[]);for(let r=0;r<e[n].length;r++)typeof e[n][r]=="string"&&(t?s.push(e[n][r]):i.push(e[n][r]));!t&&i.length&&s.push(i)}else typeof e[n]=="string"&&(t?s.push(e[n]):s.push([e[n]]));return s}get size(){return this._list.length}}Va.EVENT_ADD="add",Va.EVENT_REMOVE="remove",Va.EVENT_CHANGE="change";const jt=typeof window<"u"&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now;function iA(o){let e="";if((o.authority||o.scheme)&&(o.host||o.hostpath))throw new Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(o.host&&o.hostpath)throw new Error("Can't have 'host' and 'hostpath' option");if(o.path&&o.hostpath)throw new Error("Can't have 'path' and 'hostpath' option");return o.scheme&&(e+=o.scheme+":"),o.authority&&(e+="//"+o.authority),o.host&&(e+=o.host),o.path&&(e+=o.path),o.hostpath&&(e+=o.hostpath),o.query&&(e+="?"+o.query),o.fragment&&(e+="#"+o.fragment),e}const nA=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class Vc{constructor(e){this.scheme=void 0,this.authority=void 0,this.path=void 0,this.query=void 0,this.fragment=void 0;const t=e.match(nA);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}toString(){let e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e}getQuery(){const e={};if(this.query){const t=decodeURIComponent(this.query).split("&");for(const s of t){const i=s.split("=");e[i[0]]=i[1]}}return e}setQuery(e){let t="";for(const s in e)e.hasOwnProperty(s)&&(t!==""&&(t+="&"),t+=encodeURIComponent(s)+"="+encodeURIComponent(e[s]));this.query=t}}const xy=0,Gc=1,tp=2,Sy=3,sp=4,by=5,U={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp(o,e,t){return o>=t?t:o<=e?e:o},intToBytes24(o){const e=o>>16&255,t=o>>8&255,s=o&255;return[e,t,s]},intToBytes32(o){const e=o>>24&255,t=o>>16&255,s=o>>8&255,i=o&255;return[e,t,s,i]},bytesToInt24(o,e,t){return o.length&&(t=o[2],e=o[1],o=o[0]),o<<16|e<<8|t},bytesToInt32(o,e,t,s){return o.length&&(s=o[3],t=o[2],e=o[1],o=o[0]),(o<<24|e<<16|t<<8|s)>>>0},lerp(o,e,t){return o+(e-o)*U.clamp(t,0,1)},lerpAngle(o,e,t){return e-o>180&&(e-=360),e-o<-180&&(e+=360),U.lerp(o,e,U.clamp(t,0,1))},powerOfTwo(o){return o!==0&&!(o&o-1)},nextPowerOfTwo(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,o++,o},nearestPowerOfTwo(o){return Math.pow(2,Math.round(Math.log(o)/Math.log(2)))},random(o,e){const t=e-o;return Math.random()*t+o},smoothstep(o,e,t){return t<=o?0:t>=e?1:(t=(t-o)/(e-o),t*t*(3-2*t))},smootherstep(o,e,t){return t<=o?0:t>=e?1:(t=(t-o)/(e-o),t*t*t*(t*(t*6-15)+10))},roundUp(o,e){return e===0?o:Math.ceil(o/e)*e},between(o,e,t,s){const i=Math.min(e,t),n=Math.max(e,t);return s?o>=i&&o<=n:o>i&&o<n}};var Ti;class H{constructor(e=0,t=0,s=0,i=1){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0;const n=e.length;n===3||n===4?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=e[3]!==void 0?e[3]:1):(this.r=e,this.g=t,this.b=s,this.a=i)}clone(){const e=this.constructor;return new e(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,s,i=1){return this.r=e,this.g=t,this.b=s,this.a=i,this}lerp(e,t,s){return this.r=e.r+s*(t.r-e.r),this.g=e.g+s*(t.g-e.g),this.b=e.b+s*(t.b-e.b),this.a=e.a+s*(t.a-e.a),this}fromString(e){const t=parseInt(e.replace("#","0x"),16);let s;return e.length>7?s=U.intToBytes32(t):(s=U.intToBytes24(t),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(e){let t="#"+(16777216+(Math.round(this.r*255)<<16)+(Math.round(this.g*255)<<8)+Math.round(this.b*255)).toString(16).slice(1);if(e===!0){const s=Math.round(this.a*255).toString(16);this.a<16/255?t+="0"+s:t+=s}return t}}Ti=H,H.BLACK=Object.freeze(new Ti(0,0,0,1)),H.BLUE=Object.freeze(new Ti(0,0,1,1)),H.CYAN=Object.freeze(new Ti(0,1,1,1)),H.GRAY=Object.freeze(new Ti(.5,.5,.5,1)),H.GREEN=Object.freeze(new Ti(0,1,0,1)),H.MAGENTA=Object.freeze(new Ti(1,0,1,1)),H.RED=Object.freeze(new Ti(1,0,0,1)),H.WHITE=Object.freeze(new Ti(1,1,1,1)),H.YELLOW=Object.freeze(new Ti(1,1,0,1));class Ty{constructor(e,t=0){this._curve=void 0,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t)}evaluate(e,t=!1){(t||e<this._left||e>=this._right)&&this._reset(e);let s;const i=this._curve.type;if(i===by)s=this._p0;else{const n=this._recip===0?0:(e-this._left)*this._recip;i===xy?s=U.lerp(this._p0,this._p1,n):i===Gc?s=U.lerp(this._p0,this._p1,n*n*(3-2*n)):s=this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,n)}return s}_reset(e){const t=this._curve.keys,s=t.length;if(!s)this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0;else if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else{let i=0;for(;e>=t[i+1][0];)i++;this._left=t[i][0],this._right=t[i+1][0];const n=1/(this._right-this._left);this._recip=isFinite(n)?n:0,this._p0=t[i][1],this._p1=t[i+1][1],this._isHermite()&&this._calcTangents(t,i)}}_isHermite(){return this._curve.type===tp||this._curve.type===Sy||this._curve.type===sp}_calcTangents(e,t){let s;const i=e[t],n=e[t+1];let r;if(t===0?s=[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:s=e[t-1],t===e.length-2?r=[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:r=e[t+2],this._curve.type===sp){const a=2*(n[0]-i[0])/(n[0]-s[0]),l=2*(n[0]-i[0])/(r[0]-i[0]);this._m0=this._curve.tension*(isFinite(a)?a:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(l)?l:0)*(r[1]-i[1])}else{const a=(n[0]-i[0])/(i[0]-s[0]),l=(n[0]-i[0])/(r[0]-n[0]),h=i[1]+(s[1]-i[1])*(isFinite(a)?a:0),c=n[1]+(r[1]-n[1])*(isFinite(l)?l:0),d=this._curve.type===tp?.5:this._curve.tension;this._m0=d*(n[1]-h),this._m1=d*(c-i[1])}}_evaluateHermite(e,t,s,i,n){const r=n*n,a=n+n,l=1-n,h=l*l;return e*((1+a)*h)+s*(n*h)+t*(r*(3-a))+i*(r*(n-1))}}class os{constructor(e){if(this.keys=[],this.type=Gc,this.tension=.5,this._eval=new Ty(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}get length(){return this.keys.length}add(e,t){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>e);n++);const r=[e,t];return this.keys.splice(n,0,r),r}get(e){return this.keys[e]}sort(){this.keys.sort(function(e,t){return e[0]-t[0]})}value(e){return this._eval.evaluate(e,!0)}closest(e){const t=this.keys,s=t.length;let i=2,n=null;for(let r=0;r<s;r++){const a=Math.abs(e-t[r][0]);if(i>=a)i=a,n=t[r];else break}return n}clone(){const e=new this.constructor;return e.keys=Gi(e.keys,this.keys),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);const t=new Float32Array(e),s=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){const i=this.quantize(e);for(let n=0;n<i.length;++n)i[n]=Math.min(s,Math.max(t,i[n]));return i}}class Wi{constructor(){if(this.curves=[],this._type=Gc,arguments.length>1)for(let e=0;e<arguments.length;e++)this.curves.push(new os(arguments[e]));else if(arguments.length===0)this.curves.push(new os);else{const e=arguments[0];if(typeof e=="number")for(let t=0;t<e;t++)this.curves.push(new os);else for(let t=0;t<e.length;t++)this.curves.push(new os(e[t]))}}get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){const s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){const e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);const t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let n=0;n<t;n++){const r=new Ty(this.curves[n]);for(let a=0;a<e;a++)s[a*t+n]=r.evaluate(i*a)}return s}quantizeClamped(e,t,s){const i=this.quantize(e);for(let n=0;n<i.length;++n)i[n]=Math.min(s,Math.max(t,i[n]));return i}}const ip=1/255,wy=new Float32Array(1),rA=new Int32Array(wy.buffer);class Fe{static float2Half(e){wy[0]=e;const t=rA[0];let s=t>>16&32768,i=t>>12&2047;const n=t>>23&255;return n<103?s:n>142?(s|=31744,s|=(n===255?0:1)&&t&8388607,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=i&1,s)}static float2Bytes(e,t,s,i){const n=255*e%1;if(t[s+0]=Math.round((e%1-ip*n)*255),i>1){const r=65025*e%1;if(t[s+1]=Math.round((n-ip*r)*255),i>2){const a=16581375*e%1;t[s+2]=Math.round((r-ip*a)*255),i>3&&(t[s+3]=Math.round(a*255))}}}static float2BytesRange(e,t,s,i,n,r){e=U.clamp((e-i)/(n-i),0,1),Fe.float2Bytes(e,t,s,r)}static float2MantissaExponent(e,t,s,i){const n=Math.floor(Math.log2(Math.abs(e)))+1;e/=Math.pow(2,n),Fe.float2BytesRange(e,t,s,-1,1,i-1),t[s+i-1]=Math.round(n+127)}}var Hi;class y{constructor(e=0,t=0,s=0){this.x=void 0,this.y=void 0,this.z=void 0,e.length===3?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=s)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){const e=this.constructor;return new e(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){const s=e.x,i=e.y,n=e.z,r=t.x,a=t.y,l=t.z;return this.x=i*l-a*n,this.y=n*r-l*s,this.z=s*a-r*i,this}distance(e){const t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){const t=this.x*e.x+this.y*e.y+this.z*e.z,s=e.x*e.x+e.y*e.y+e.z*e.z,i=t/s;return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}Hi=y,y.ZERO=Object.freeze(new Hi(0,0,0)),y.ONE=Object.freeze(new Hi(1,1,1)),y.UP=Object.freeze(new Hi(0,1,0)),y.DOWN=Object.freeze(new Hi(0,-1,0)),y.RIGHT=Object.freeze(new Hi(1,0,0)),y.LEFT=Object.freeze(new Hi(-1,0,0)),y.FORWARD=Object.freeze(new Hi(0,0,-1)),y.BACK=Object.freeze(new Hi(0,0,1));var np;class ls{constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}clone(){const e=this.constructor;return new e().copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e=new y){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new y){return e.set(this.data[3],this.data[4],this.data[5])}getZ(e=new y){return e.set(this.data[6],this.data[7],this.data[8])}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]}isIdentity(){const e=this.data;return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===1&&e[5]===0&&e[6]===0&&e[7]===0&&e[8]===1}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return"["+this.data.join(", ")+"]"}transpose(e=this){const t=e.data,s=this.data;if(t===s){let i;i=t[1],s[1]=t[3],s[3]=i,i=t[2],s[2]=t[6],s[6]=i,i=t[5],s[5]=t[7],s[7]=i}else s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=t[1],s[4]=t[4],s[5]=t[7],s[6]=t[2],s[7]=t[5],s[8]=t[8];return this}setFromMat4(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],this}invertMat4(e){const t=e.data,s=t[0],i=t[1],n=t[2],r=t[4],a=t[5],l=t[6],h=t[8],c=t[9],d=t[10],u=d*a-l*c,f=-d*i+n*c,p=l*i-n*a,_=-d*r+l*h,m=d*s-n*h,g=-l*s+n*r,x=c*r-a*h,S=-c*s+i*h,v=a*s-i*r,b=s*u+i*_+n*x;if(b===0)this.setIdentity();else{const w=1/b,T=this.data;T[0]=u*w,T[1]=f*w,T[2]=p*w,T[3]=_*w,T[4]=m*w,T[5]=g*w,T[6]=x*w,T[7]=S*w,T[8]=v*w}return this}transformVector(e,t=new y){const s=this.data,i=e.x,n=e.y,r=e.z;return t.x=i*s[0]+n*s[3]+r*s[6],t.y=i*s[1]+n*s[4]+r*s[7],t.z=i*s[2]+n*s[5]+r*s[8],t}}np=ls,ls.IDENTITY=Object.freeze(new np),ls.ZERO=Object.freeze(new np().set([0,0,0,0,0,0,0,0,0]));var vr;class G{constructor(e=0,t=0){this.x=void 0,this.y=void 0,e.length===2?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){const e=this.constructor;return new e(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){const t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s}return this}rotate(e){const t=Math.atan2(this.x,this.y)+e*U.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*s,this.y=Math.cos(t)*s,this}angle(){return Math.atan2(this.x,this.y)*U.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*U.RAD_TO_DEG}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}}vr=G,G.ZERO=Object.freeze(new vr(0,0)),G.ONE=Object.freeze(new vr(1,1)),G.UP=Object.freeze(new vr(0,1)),G.DOWN=Object.freeze(new vr(0,-1)),G.RIGHT=Object.freeze(new vr(1,0)),G.LEFT=Object.freeze(new vr(-1,0));var rp;class X{constructor(e=0,t=0,s=0,i=0){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,e.length===4?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){const e=this.constructor;return new e(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this.w=e.w+s*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=e.w*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}rp=X,X.ZERO=Object.freeze(new rp(0,0,0,0)),X.ONE=Object.freeze(new rp(1,1,1,1));var ap;const Il=new G,Zs=new y,wi=new y,Ei=new y,Wc=new y;class W{constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}static _getPerspectiveHalfSize(e,t,s,i,n){n?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/s):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*s)}add2(e,t){const s=e.data,i=t.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(e){return this.add2(this,e)}clone(){const e=this.constructor;return new e().copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],this}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]&&t[9]===s[9]&&t[10]===s[10]&&t[11]===s[11]&&t[12]===s[12]&&t[13]===s[13]&&t[14]===s[14]&&t[15]===s[15]}isIdentity(){const e=this.data;return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}mul2(e,t){const s=e.data,i=t.data,n=this.data,r=s[0],a=s[1],l=s[2],h=s[3],c=s[4],d=s[5],u=s[6],f=s[7],p=s[8],_=s[9],m=s[10],g=s[11],x=s[12],S=s[13],v=s[14],b=s[15];let w,T,E,C;return w=i[0],T=i[1],E=i[2],C=i[3],n[0]=r*w+c*T+p*E+x*C,n[1]=a*w+d*T+_*E+S*C,n[2]=l*w+u*T+m*E+v*C,n[3]=h*w+f*T+g*E+b*C,w=i[4],T=i[5],E=i[6],C=i[7],n[4]=r*w+c*T+p*E+x*C,n[5]=a*w+d*T+_*E+S*C,n[6]=l*w+u*T+m*E+v*C,n[7]=h*w+f*T+g*E+b*C,w=i[8],T=i[9],E=i[10],C=i[11],n[8]=r*w+c*T+p*E+x*C,n[9]=a*w+d*T+_*E+S*C,n[10]=l*w+u*T+m*E+v*C,n[11]=h*w+f*T+g*E+b*C,w=i[12],T=i[13],E=i[14],C=i[15],n[12]=r*w+c*T+p*E+x*C,n[13]=a*w+d*T+_*E+S*C,n[14]=l*w+u*T+m*E+v*C,n[15]=h*w+f*T+g*E+b*C,this}mulAffine2(e,t){const s=e.data,i=t.data,n=this.data,r=s[0],a=s[1],l=s[2],h=s[4],c=s[5],d=s[6],u=s[8],f=s[9],p=s[10],_=s[12],m=s[13],g=s[14];let x,S,v;return x=i[0],S=i[1],v=i[2],n[0]=r*x+h*S+u*v,n[1]=a*x+c*S+f*v,n[2]=l*x+d*S+p*v,n[3]=0,x=i[4],S=i[5],v=i[6],n[4]=r*x+h*S+u*v,n[5]=a*x+c*S+f*v,n[6]=l*x+d*S+p*v,n[7]=0,x=i[8],S=i[9],v=i[10],n[8]=r*x+h*S+u*v,n[9]=a*x+c*S+f*v,n[10]=l*x+d*S+p*v,n[11]=0,x=i[12],S=i[13],v=i[14],n[12]=r*x+h*S+u*v+_,n[13]=a*x+c*S+f*v+m,n[14]=l*x+d*S+p*v+g,n[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t=new y){const s=this.data,i=e.x,n=e.y,r=e.z;return t.x=i*s[0]+n*s[4]+r*s[8]+s[12],t.y=i*s[1]+n*s[5]+r*s[9]+s[13],t.z=i*s[2]+n*s[6]+r*s[10]+s[14],t}transformVector(e,t=new y){const s=this.data,i=e.x,n=e.y,r=e.z;return t.x=i*s[0]+n*s[4]+r*s[8],t.y=i*s[1]+n*s[5]+r*s[9],t.z=i*s[2]+n*s[6]+r*s[10],t}transformVec4(e,t=new X){const s=this.data,i=e.x,n=e.y,r=e.z,a=e.w;return t.x=i*s[0]+n*s[4]+r*s[8]+a*s[12],t.y=i*s[1]+n*s[5]+r*s[9]+a*s[13],t.z=i*s[2]+n*s[6]+r*s[10]+a*s[14],t.w=i*s[3]+n*s[7]+r*s[11]+a*s[15],t}setLookAt(e,t,s){Ei.sub2(e,t).normalize(),wi.copy(s).normalize(),Zs.cross(wi,Ei).normalize(),wi.cross(Ei,Zs);const i=this.data;return i[0]=Zs.x,i[1]=Zs.y,i[2]=Zs.z,i[3]=0,i[4]=wi.x,i[5]=wi.y,i[6]=wi.z,i[7]=0,i[8]=Ei.x,i[9]=Ei.y,i[10]=Ei.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}setFrustum(e,t,s,i,n,r){const a=2*n,l=t-e,h=i-s,c=r-n,d=this.data;return d[0]=a/l,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=a/h,d[6]=0,d[7]=0,d[8]=(t+e)/l,d[9]=(i+s)/h,d[10]=(-r-n)/c,d[11]=-1,d[12]=0,d[13]=0,d[14]=-a*r/c,d[15]=0,this}setPerspective(e,t,s,i,n){return W._getPerspectiveHalfSize(Il,e,t,s,n),this.setFrustum(-Il.x,Il.x,-Il.y,Il.y,s,i)}setOrtho(e,t,s,i,n,r){const a=this.data;return a[0]=2/(t-e),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(t+e)/(t-e),a[13]=-(i+s)/(i-s),a[14]=-(r+n)/(r-n),a[15]=1,this}setFromAxisAngle(e,t){t*=U.DEG_TO_RAD;const s=e.x,i=e.y,n=e.z,r=Math.cos(t),a=Math.sin(t),l=1-r,h=l*s,c=l*i,d=this.data;return d[0]=h*s+r,d[1]=h*i+a*n,d[2]=h*n-a*i,d[3]=0,d[4]=h*i-a*n,d[5]=c*i+r,d[6]=c*n+a*s,d[7]=0,d[8]=h*n+a*i,d[9]=c*n-s*a,d[10]=l*n*n+r,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,this}setTranslate(e,t,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=s,i[15]=1,this}setScale(e,t,s){const i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(e,t,s,i){const n=this.data;return n[0]=s*.5,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=i*.5,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=e+s*.5,n[13]=t+i*.5,n[14]=.5,n[15]=1,this}setReflection(e,t){const s=e.x,i=e.y,n=e.z,r=this.data;return r[0]=1-2*s*s,r[1]=-2*s*i,r[2]=-2*s*n,r[3]=0,r[4]=-2*s*i,r[5]=1-2*i*i,r[6]=-2*i*n,r[7]=0,r[8]=-2*s*n,r[9]=-2*i*n,r[10]=1-2*n*n,r[11]=0,r[12]=-2*s*t,r[13]=-2*i*t,r[14]=-2*n*t,r[15]=1,this}invert(e=this){const t=e.data,s=t[0],i=t[1],n=t[2],r=t[3],a=t[4],l=t[5],h=t[6],c=t[7],d=t[8],u=t[9],f=t[10],p=t[11],_=t[12],m=t[13],g=t[14],x=t[15],S=s*l-i*a,v=s*h-n*a,b=s*c-r*a,w=i*h-n*l,T=i*c-r*l,E=n*c-r*h,C=d*m-u*_,M=d*g-f*_,O=d*x-p*_,I=u*g-f*m,B=u*x-p*m,P=f*x-p*g,D=S*P-v*B+b*I+w*O-T*M+E*C;if(D===0)this.setIdentity();else{const R=1/D,A=this.data;A[0]=(l*P-h*B+c*I)*R,A[1]=(-i*P+n*B-r*I)*R,A[2]=(m*E-g*T+x*w)*R,A[3]=(-u*E+f*T-p*w)*R,A[4]=(-a*P+h*O-c*M)*R,A[5]=(s*P-n*O+r*M)*R,A[6]=(-_*E+g*b-x*v)*R,A[7]=(d*E-f*b+p*v)*R,A[8]=(a*B-l*O+c*C)*R,A[9]=(-s*B+i*O-r*C)*R,A[10]=(_*T-m*b+x*S)*R,A[11]=(-d*T+u*b-p*S)*R,A[12]=(-a*I+l*M-h*C)*R,A[13]=(s*I-i*M+n*C)*R,A[14]=(-_*w+m*v-g*S)*R,A[15]=(d*w-u*v+f*S)*R}return this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,s){const i=t.x,n=t.y,r=t.z,a=t.w,l=s.x,h=s.y,c=s.z,d=i+i,u=n+n,f=r+r,p=i*d,_=i*u,m=i*f,g=n*u,x=n*f,S=r*f,v=a*d,b=a*u,w=a*f,T=this.data;return T[0]=(1-(g+S))*l,T[1]=(_+w)*l,T[2]=(m-b)*l,T[3]=0,T[4]=(_-w)*h,T[5]=(1-(p+S))*h,T[6]=(x+v)*h,T[7]=0,T[8]=(m+b)*c,T[9]=(x-v)*c,T[10]=(1-(p+g))*c,T[11]=0,T[12]=e.x,T[13]=e.y,T[14]=e.z,T[15]=1,this}transpose(e=this){const t=e.data,s=this.data;if(t===s){let i;i=t[1],s[1]=t[4],s[4]=i,i=t[2],s[2]=t[8],s[8]=i,i=t[3],s[3]=t[12],s[12]=i,i=t[6],s[6]=t[9],s[9]=i,i=t[7],s[7]=t[13],s[13]=i,i=t[11],s[11]=t[14],s[14]=i}else s[0]=t[0],s[1]=t[4],s[2]=t[8],s[3]=t[12],s[4]=t[1],s[5]=t[5],s[6]=t[9],s[7]=t[13],s[8]=t[2],s[9]=t[6],s[10]=t[10],s[11]=t[14],s[12]=t[3],s[13]=t[7],s[14]=t[11],s[15]=t[15];return this}getTranslation(e=new y){return e.set(this.data[12],this.data[13],this.data[14])}getX(e=new y){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new y){return e.set(this.data[4],this.data[5],this.data[6])}getZ(e=new y){return e.set(this.data[8],this.data[9],this.data[10])}getScale(e=new y){return this.getX(Zs),this.getY(wi),this.getZ(Ei),e.set(Zs.length(),wi.length(),Ei.length()),e}get scaleSign(){return this.getX(Zs),this.getY(wi),this.getZ(Ei),Zs.cross(Zs,wi),Zs.dot(Ei)<0?-1:1}setFromEulerAngles(e,t,s){e*=U.DEG_TO_RAD,t*=U.DEG_TO_RAD,s*=U.DEG_TO_RAD;const i=Math.sin(-e),n=Math.cos(-e),r=Math.sin(-t),a=Math.cos(-t),l=Math.sin(-s),h=Math.cos(-s),c=this.data;return c[0]=a*h,c[1]=-a*l,c[2]=r,c[3]=0,c[4]=n*l+h*i*r,c[5]=n*h-i*r*l,c[6]=-a*i,c[7]=0,c[8]=i*l-n*h*r,c[9]=h*i+n*r*l,c[10]=n*a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}getEulerAngles(e=new y){this.getScale(Wc);const t=Wc.x,s=Wc.y,i=Wc.z;if(t===0||s===0||i===0)return e.set(0,0,0);const n=this.data,r=Math.asin(-n[2]/t),a=Math.PI*.5;let l,h;return r<a?r>-a?(l=Math.atan2(n[6]/s,n[10]/i),h=Math.atan2(n[1]/t,n[0]/t)):(h=0,l=-Math.atan2(n[4]/s,n[5]/s)):(h=0,l=Math.atan2(n[4]/s,n[5]/s)),e.set(l,r,h).mulScalar(U.RAD_TO_DEG)}toString(){return"["+this.data.join(", ")+"]"}}ap=W,W.IDENTITY=Object.freeze(new ap),W.ZERO=Object.freeze(new ap().set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));var op;class Z{constructor(e=0,t=0,s=0,i=1){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,e.length===4?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}clone(){const e=this.constructor;return new e(this.x,this.y,this.z,this.w)}conjugate(e=this){return this.x=e.x*-1,this.y=e.y*-1,this.z=e.z*-1,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){let t=Math.acos(this.w)*2;const s=Math.sin(t/2);return s!==0?(e.x=this.x/s,e.y=this.y/s,e.z=this.z/s,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*U.RAD_TO_DEG}getEulerAngles(e=new y){let t,s,i;const n=this.x,r=this.y,a=this.z,l=this.w,h=2*(l*r-n*a);return h<=-.99999?(t=2*Math.atan2(n,l),s=-Math.PI/2,i=0):h>=.99999?(t=2*Math.atan2(n,l),s=Math.PI/2,i=0):(t=Math.atan2(2*(l*n+r*a),1-2*(n*n+r*r)),s=Math.asin(h),i=Math.atan2(2*(l*a+n*r),1-2*(r*r+a*a))),e.set(t,s,i).mulScalar(U.RAD_TO_DEG)}invert(e=this){return this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(e){const t=this.x,s=this.y,i=this.z,n=this.w,r=e.x,a=e.y,l=e.z,h=e.w;return this.x=n*r+t*h+s*l-i*a,this.y=n*a+s*h+i*r-t*l,this.z=n*l+i*h+t*a-s*r,this.w=n*h-t*r-s*a-i*l,this}mul2(e,t){const s=e.x,i=e.y,n=e.z,r=e.w,a=t.x,l=t.y,h=t.z,c=t.w;return this.x=r*a+s*c+i*h-n*l,this.y=r*l+i*c+n*a-s*h,this.z=r*h+n*c+s*l-i*a,this.w=r*c-s*a-i*l-n*h,this}normalize(e=this){let t=e.length();return t===0?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setFromAxisAngle(e,t){t*=.5*U.DEG_TO_RAD;const s=Math.sin(t),i=Math.cos(t);return this.x=s*e.x,this.y=s*e.y,this.z=s*e.z,this.w=i,this}setFromEulerAngles(e,t,s){if(e instanceof y){const d=e;e=d.x,t=d.y,s=d.z}const i=.5*U.DEG_TO_RAD;e*=i,t*=i,s*=i;const n=Math.sin(e),r=Math.cos(e),a=Math.sin(t),l=Math.cos(t),h=Math.sin(s),c=Math.cos(s);return this.x=n*l*c-r*a*h,this.y=r*a*c+n*l*h,this.z=r*l*h-n*a*c,this.w=r*l*c+n*a*h,this}setFromMat4(e){let t,s,i,n,r,a,l,h,c,d,u,f,p,_;if(e=e.data,t=e[0],s=e[1],i=e[2],n=e[4],r=e[5],a=e[6],l=e[8],h=e[9],c=e[10],f=t*t+s*s+i*i,f===0)return this;if(f=1/Math.sqrt(f),p=n*n+r*r+a*a,p===0)return this;if(p=1/Math.sqrt(p),_=l*l+h*h+c*c,_===0)return this;_=1/Math.sqrt(_),t*=f,s*=f,i*=f,n*=p,r*=p,a*=p,l*=_,h*=_,c*=_;const m=t+r+c;return m>=0?(d=Math.sqrt(m+1),this.w=d*.5,d=.5/d,this.x=(a-h)*d,this.y=(l-i)*d,this.z=(s-n)*d):t>r?t>c?(u=t-(r+c)+1,u=Math.sqrt(u),this.x=u*.5,u=.5/u,this.w=(a-h)*u,this.y=(s+n)*u,this.z=(i+l)*u):(u=c-(t+r)+1,u=Math.sqrt(u),this.z=u*.5,u=.5/u,this.w=(s-n)*u,this.x=(l+i)*u,this.y=(h+a)*u):r>c?(u=r-(c+t)+1,u=Math.sqrt(u),this.y=u*.5,u=.5/u,this.w=(l-i)*u,this.z=(a+h)*u,this.x=(n+s)*u):(u=c-(t+r)+1,u=Math.sqrt(u),this.z=u*.5,u=.5/u,this.w=(s-n)*u,this.x=(l+i)*u,this.y=(h+a)*u),this}setFromDirections(e,t){const s=1+e.dot(t);return s<Number.EPSILON?Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x,this.w=0):(this.x=0,this.y=-e.z,this.z=e.y,this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=s),this.normalize()}slerp(e,t,s){const i=e.x,n=e.y,r=e.z,a=e.w;let l=t.x,h=t.y,c=t.z,d=t.w,u=a*d+i*l+n*h+r*c;if(u<0&&(d=-d,l=-l,h=-h,c=-c,u=-u),Math.abs(u)>=1)return this.w=a,this.x=i,this.y=n,this.z=r,this;const f=Math.acos(u),p=Math.sqrt(1-u*u);if(Math.abs(p)<.001)return this.w=a*.5+d*.5,this.x=i*.5+l*.5,this.y=n*.5+h*.5,this.z=r*.5+c*.5,this;const _=Math.sin((1-s)*f)/p,m=Math.sin(s*f)/p;return this.w=a*_+d*m,this.x=i*_+l*m,this.y=n*_+h*m,this.z=r*_+c*m,this}transformVector(e,t=new y){const s=e.x,i=e.y,n=e.z,r=this.x,a=this.y,l=this.z,h=this.w,c=h*s+a*n-l*i,d=h*i+l*s-r*n,u=h*n+r*i-a*s,f=-r*s-a*i-l*n;return t.x=c*h+f*-r+d*-l-u*-a,t.y=d*h+f*-a+u*-r-c*-l,t.z=u*h+f*-l+c*-a-d*-r,t}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}op=Z,Z.IDENTITY=Object.freeze(new op(0,0,0,1)),Z.ZERO=Object.freeze(new op(0,0,0,0));const Ga=new y,Wa=new y,Ey=new y,Ay=new y,aA=new y;class ye{constructor(e=new y,t=new y(.5,.5,.5)){this.center=void 0,this.halfExtents=void 0,this._min=new y,this._max=new y,this.center=e,this.halfExtents=t}add(e){const t=this.center,s=t.x,i=t.y,n=t.z,r=this.halfExtents,a=r.x,l=r.y,h=r.z;let c=s-a,d=s+a,u=i-l,f=i+l,p=n-h,_=n+h;const m=e.center,g=m.x,x=m.y,S=m.z,v=e.halfExtents,b=v.x,w=v.y,T=v.z,E=g-b,C=g+b,M=x-w,O=x+w,I=S-T,B=S+T;E<c&&(c=E),C>d&&(d=C),M<u&&(u=M),O>f&&(f=O),I<p&&(p=I),B>_&&(_=B),t.x=(c+d)*.5,t.y=(u+f)*.5,t.z=(p+_)*.5,r.x=(d-c)*.5,r.y=(f-u)*.5,r.z=(_-p)*.5}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)}clone(){return new ye(this.center.clone(),this.halfExtents.clone())}intersects(e){const t=this.getMax(),s=this.getMin(),i=e.getMax(),n=e.getMin();return s.x<=i.x&&t.x>=n.x&&s.y<=i.y&&t.y>=n.y&&s.z<=i.z&&t.z>=n.z}_intersectsRay(e,t){const s=Ga.copy(this.getMin()).sub(e.origin),i=Wa.copy(this.getMax()).sub(e.origin),n=e.direction;n.x===0?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),n.y===0?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),n.z===0?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const r=Ey.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),a=Ay.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),l=Math.min(Math.min(a.x,a.y),a.z),h=Math.max(Math.max(r.x,r.y),r.z),c=l>=h&&h>=0;return c&&t.copy(e.direction).mulScalar(h).add(e.origin),c}_fastIntersectsRay(e){const t=Ga,s=Wa,i=Ey,n=Ay,r=aA,a=e.direction;return t.sub2(e.origin,this.center),n.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),i.mul2(t,a),!(n.x>this.halfExtents.x&&i.x>=0||n.y>this.halfExtents.y&&i.y>=0||n.z>this.halfExtents.z&&i.z>=0||(r.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),s.cross(a,t),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),s.x>this.halfExtents.y*r.z+this.halfExtents.z*r.y)||s.y>this.halfExtents.x*r.z+this.halfExtents.z*r.x||s.z>this.halfExtents.x*r.y+this.halfExtents.y*r.x)}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){const t=this.getMin(),s=this.getMax();return!(e.x<t.x||e.x>s.x||e.y<t.y||e.y>s.y||e.z<t.z||e.z>s.z)}setFromTransformedAabb(e,t,s=!1){const i=e.center,n=e.halfExtents,r=t.data;let a=r[0],l=r[4],h=r[8],c=r[1],d=r[5],u=r[9],f=r[2],p=r[6],_=r[10];if(s){let m=a*a+l*l+h*h;if(m>0){const g=1/Math.sqrt(m);a*=g,l*=g,h*=g}if(m=c*c+d*d+u*u,m>0){const g=1/Math.sqrt(m);c*=g,d*=g,u*=g}if(m=f*f+p*p+_*_,m>0){const g=1/Math.sqrt(m);f*=g,p*=g,_*=g}}this.center.set(r[12]+a*i.x+l*i.y+h*i.z,r[13]+c*i.x+d*i.y+u*i.z,r[14]+f*i.x+p*i.y+_*i.z),this.halfExtents.set(Math.abs(a)*n.x+Math.abs(l)*n.y+Math.abs(h)*n.z,Math.abs(c)*n.x+Math.abs(d)*n.y+Math.abs(u)*n.z,Math.abs(f)*n.x+Math.abs(p)*n.y+Math.abs(_)*n.z)}static computeMinMax(e,t,s,i=e.length/3){if(i>0){let n=e[0],r=e[1],a=e[2],l=n,h=r,c=a;const d=i*3;for(let u=3;u<d;u+=3){const f=e[u],p=e[u+1],_=e[u+2];f<n&&(n=f),p<r&&(r=p),_<a&&(a=_),f>l&&(l=f),p>h&&(h=p),_>c&&(c=_)}t.set(n,r,a),s.set(l,h,c)}}compute(e,t){ye.computeMinMax(e,Ga,Wa,t),this.setMinMax(Ga,Wa)}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){const t=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let r=0;r<3;++r){let a=0;const l=e.center[n[r]],h=t[n[r]],c=s[n[r]];let d=0;l<h&&(d=h-l,a+=d*d),l>c&&(d=l-c,a+=d*d),i+=a}return i}_expand(e,t){Ga.add2(this.getMin(),e),Wa.add2(this.getMax(),t),this.setMinMax(Ga,Wa)}}const Hc=new y,oA=new y;class Cn{constructor(e=new y,t=.5){this.center=void 0,this.radius=void 0,this.center=e,this.radius=t}containsPoint(e){const t=Hc.sub2(e,this.center).lengthSq(),s=this.radius;return t<s*s}intersectsRay(e,t){const s=Hc.copy(e.origin).sub(this.center),i=s.dot(oA.copy(e.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const r=i*i-n;if(r<0)return!1;const a=Math.abs(-i-Math.sqrt(r));return t&&t.copy(e.direction).mulScalar(a).add(e.origin),!0}intersectsBoundingSphere(e){Hc.sub2(e.center,this.center);const t=e.radius+this.radius;return Hc.lengthSq()<=t*t}}class lp{constructor(){this.planes=[];for(let e=0;e<6;e++)this.planes[e]=[]}setFromMat4(e){const t=e.data;let s;const i=this.planes;s=i[0],s[0]=t[3]-t[0],s[1]=t[7]-t[4],s[2]=t[11]-t[8],s[3]=t[15]-t[12];let n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[1],s[0]=t[3]+t[0],s[1]=t[7]+t[4],s[2]=t[11]+t[8],s[3]=t[15]+t[12],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[2],s[0]=t[3]+t[1],s[1]=t[7]+t[5],s[2]=t[11]+t[9],s[3]=t[15]+t[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[3],s[0]=t[3]-t[1],s[1]=t[7]-t[5],s[2]=t[11]-t[9],s[3]=t[15]-t[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[4],s[0]=t[3]-t[2],s[1]=t[7]-t[6],s[2]=t[11]-t[10],s[3]=t[15]-t[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[5],s[0]=t[3]+t[2],s[1]=t[7]+t[6],s[2]=t[11]+t[10],s[3]=t[15]+t[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n}containsPoint(e){let t,s;for(t=0;t<6;t++)if(s=this.planes[t],s[0]*e.x+s[1]*e.y+s[2]*e.z+s[3]<=0)return!1;return!0}containsSphere(e){let t=0,s,i;const n=e.radius,r=e.center,a=r.x,l=r.y,h=r.z,c=this.planes;let d;for(i=0;i<6;i++){if(d=c[i],s=d[0]*a+d[1]*l+d[2]*h+d[3],s<=-n)return 0;s>n&&t++}return t===6?2:1}}class Mn{constructor(e,t){this.origin=new y,this.direction=y.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t)}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}}const Xc=new Mn,Cy=new y,hp=new Cn,lA=new W;class hA{constructor(e=new W,t=new y(.5,.5,.5)){this.halfExtents=void 0,this._modelTransform=void 0,this._worldTransform=void 0,this._aabb=void 0,this.halfExtents=t,this._modelTransform=e.clone().invert(),this._worldTransform=e.clone(),this._aabb=new ye(new y,this.halfExtents)}set worldTransform(e){this._worldTransform.copy(e),this._modelTransform.copy(e).invert()}get worldTransform(){return this._worldTransform}intersectsRay(e,t){if(this._modelTransform.transformPoint(e.origin,Xc.origin),this._modelTransform.transformVector(e.direction,Xc.direction),t){const s=this._aabb._intersectsRay(Xc,t);return lA.copy(this._modelTransform).invert().transformPoint(t,t),s}return this._aabb._fastIntersectsRay(Xc)}containsPoint(e){return this._modelTransform.transformPoint(e,Cy),this._aabb.containsPoint(Cy)}intersectsBoundingSphere(e){return this._modelTransform.transformPoint(e.center,hp.center),hp.radius=e.radius,!!this._aabb.intersectsBoundingSphere(hp)}}class cp{constructor(e=y.UP,t=0){this.normal=new y,this.distance=void 0,this.normal.copy(e),this.distance=t}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}intersectsLine(e,t,s){const i=this.distance,n=this.normal.dot(e)+i,r=this.normal.dot(t)+i,a=n/(n-r),l=a>=0&&a<=1;return l&&s&&s.lerp(e,t,a),l}intersectsRay(e,t){const s=this.normal.dot(e.direction);if(s===0)return!1;const i=-(this.normal.dot(e.origin)+this.distance)/s;return i>=0&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),i>=0}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}clone(){const e=this.constructor;return new e().copy(this)}}const Dl="linear",Ll="inverse",dp="exponential",Qe=0,q=1,Ha=2,Fl=0,ut=1,up=2,My=3,$c=4,fp=5,Ol=6,Py=7,Bl=8,Ry=9,Iy=10,pp=11,mp=12,hs=0,cA=1,Dy=2,Ly=3,Fy=4,St=0,Pn=1,_p=2,qc=3,xr=1,Sr=2,Xa=4,dA=0,uA=1,fA=2,pA=3,mA=4,_A=5,Je=0,Ai=1,br=2,gp=3,de=0,Oe=1,Tr=2,wr=3,Er=4,Qs=5,Oy=0,jc=1,Nl=2,Yc=3,By=4,Ny=5,ky=6,Ci=7,kl=0,Yt=1,Mi=2,Kc=0,Ul=1,$a=2,Rn=3,qa=4,Ar=5,Es=6,oe=7,ja=8,zl=9,Cr=10,Mr=11,et=12,Pr=13,Ge=14,Pi=15,In=16,Dn=17,Ln=18,Vl=19,Gl=20,Ya=21,Wl=22,Hl=23,Rr=24,Ir=25,Ka=26,Za=27,Zc=28,Qc=29,Jc=30,ed=31,Xl=32,td=33,$l=34,ql=35,jl=36,Yl=37,Kl=38,sd=39,Zl=40,Ql=41,Jl=42,eh=43,th=44,id=45,sh=46,ih=47,nh=48,rh=49,Qa=50,ah=51,Ja=new Map([[Kc,{name:"A8",size:1}],[Ul,{name:"L8",size:1}],[$a,{name:"LA8",size:2}],[Rn,{name:"RGB565",size:2}],[qa,{name:"RGBA5551",size:2}],[Ar,{name:"RGBA4",size:2}],[Es,{name:"RGB8",size:4}],[oe,{name:"RGBA8",size:4}],[Qa,{name:"R16F",size:2}],[ah,{name:"RG16F",size:4}],[Mr,{name:"RGB16F",size:8}],[et,{name:"RGBA16F",size:8}],[Pr,{name:"RGB32F",size:16}],[Ge,{name:"RGBA32F",size:16}],[Pi,{name:"R32F",size:4}],[In,{name:"DEPTH",size:4}],[Dn,{name:"DEPTHSTENCIL",size:4}],[Ln,{name:"111110F",size:4}],[Vl,{name:"SRGB",size:4}],[Gl,{name:"SRGBA",size:4}],[ed,{name:"BGRA8",size:4}],[ja,{name:"DXT1",blockSize:8}],[zl,{name:"DXT3",blockSize:16}],[Cr,{name:"DXT5",blockSize:16}],[Ya,{name:"ETC1",blockSize:8}],[Wl,{name:"ETC2_RGB",blockSize:8}],[Hl,{name:"ETC2_RGBA",blockSize:16}],[Rr,{name:"PVRTC_2BPP_RGB_1",blockSize:8}],[Ir,{name:"PVRTC_2BPP_RGBA_1",blockSize:8}],[Ka,{name:"PVRTC_4BPP_RGB_1",blockSize:8}],[Za,{name:"PVRTC_4BPP_RGBA_1",blockSize:8}],[Zc,{name:"ASTC_4x4",blockSize:16}],[Qc,{name:"ATC_RGB",blockSize:8}],[Jc,{name:"ATC_RGBA",blockSize:16}],[Xl,{name:"R8I",size:1,isInt:!0}],[td,{name:"R8U",size:1,isInt:!0}],[$l,{name:"R16I",size:2,isInt:!0}],[ql,{name:"R16U",size:2,isInt:!0}],[jl,{name:"R32I",size:4,isInt:!0}],[Yl,{name:"R32U",size:4,isInt:!0}],[Kl,{name:"RG8I",size:2,isInt:!0}],[sd,{name:"RG8U",size:2,isInt:!0}],[Zl,{name:"RG16I",size:4,isInt:!0}],[Ql,{name:"RG16U",size:4,isInt:!0}],[Jl,{name:"RG32I",size:8,isInt:!0}],[eh,{name:"RG32U",size:8,isInt:!0}],[th,{name:"RGBA8I",size:4,isInt:!0}],[id,{name:"RGBA8U",size:4,isInt:!0}],[sh,{name:"RGBA16I",size:8,isInt:!0}],[ih,{name:"RGBA16U",size:8,isInt:!0}],[nh,{name:"RGBA32I",size:16,isInt:!0}],[rh,{name:"RGBA32U",size:16,isInt:!0}]]),nd=o=>{var e;return((e=Ja.get(o))==null?void 0:e.blockSize)!==void 0},Dr=o=>{var e;return((e=Ja.get(o))==null?void 0:e.isInt)===!0},Uy=o=>{switch(o){case Pi:case Pr:case Ge:return Float32Array;case jl:case Jl:case nh:return Int32Array;case Yl:case eh:case rh:return Uint32Array;case $l:case Zl:case sh:return Int16Array;case ql:case Ql:case ih:case Rn:case qa:case Ar:case Qa:case ah:case Mr:case et:return Uint16Array;case Xl:case Kl:case th:return Int8Array;default:return Uint8Array}},Lr=0,eo=1,rd=2,ad=3,Js=4,As=5,Xi=6,We="POSITION",Dt="NORMAL",ei="TANGENT",ti="BLENDWEIGHT",Kt="BLENDINDICES",_t="COLOR",od="TEXCOORD",Lt="TEXCOORD0",Ri="TEXCOORD1",to="TEXCOORD2",so="TEXCOORD3",io="TEXCOORD4",no="TEXCOORD5",ro="TEXCOORD6",ao="TEXCOORD7",zy="ATTR",oo="ATTR0",oh="ATTR1",ld="ATTR2",hd="ATTR3",yp="ATTR4",Vy="ATTR5",Gy="ATTR6",Wy="ATTR7",Fn="ATTR8",On="ATTR9",cd="ATTR10",dd="ATTR11",lo="ATTR12",Bn="ATTR13",ho="ATTR14",Nn="ATTR15",Hy=1,Fr=0,gA=1,Xy=2,$y=3,yA=4,qy=5,vA=6,xA=7,ud=0,vp=1,fd=2,bt="default",Cs="rgbm",pd="rgbe",Or="rgbp",Br="swizzleGGGR",SA=0,bA=1,TA=2,wA=3,EA="1d",Ft="2d",co="2d-array",uo="cube",AA="cube-array",lh="3d",kn=0,Un=1,Nr=2,fo=3,po=4,jy="none",md="cube",xp="equirect",Yy="octahedral",CA="glsl",mo="wgsl",si=0,Zt=1,ii=2,Ms=3,xe=4,tt=5,le=6,_d=7,kr=0,zn=1,Ps=2,$i=3,Qt=4,Vn=5,Gn=6,Wn=7,Hn=8,_o=9,go=10,yo=11,hh=12,vo=13,Ur=14,Ky=15,Zy=16,ch=17,Qy=18,Jy=19,ev=20,dh=21,uh=22,gd=23,Sp=24,tv=25,zr=26,Vr=27,Gr=28,Wr=29,Hr=30,fh=31,ph=32,Xr=33,mh=34,_h=35,$r=36,gh=37,yh=38,vh=39,yd=40,vd=41,sv=42,iv=43,nv=44,rv=45,av=46,ov=47,lv=48,hv=49,bp=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],MA=new Uint8Array([xe,xe,le,le,le,le,xe,xe,xe,xe,xe,xe,le,le,le,xe,xe,le,xe,xe,xe,le,le,le,le,xe,tt,tt,tt,tt,xe,tt,xe,xe,tt,xe,xe,tt,xe,xe,tt,xe,xe,tt,xe,tt,xe,tt,xe,tt]),xo="webgl1",qr="webgl2",Tp="webgpu",xh="null",jr=1,Jt=2,cv=4,So=0,xd=1,dv=["mesh","view"],bo="default",Yr=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],To=[1,1,2,2,4,4,4,2],PA=["INT8","UINT8","INT16","UINT16","INT32","UINT32","FLOAT32","FLOAT16"],RA={Int8Array:si,Uint8Array:Zt,Int16Array:ii,Uint16Array:Ms,Int32Array:xe,Uint32Array:tt,Float32Array:le},Sd=[Uint8Array,Uint16Array,Uint32Array],uv=[1,2,4],Se={};Se[We]=0,Se[Dt]=1,Se[ti]=2,Se[Kt]=3,Se[_t]=4,Se[Lt]=5,Se[Ri]=6,Se[to]=7,Se[so]=8,Se[io]=9,Se[no]=10,Se[ro]=11,Se[ao]=12,Se[ei]=13,Se[oo]=0,Se[oh]=1,Se[ld]=2,Se[hd]=3,Se[yp]=4,Se[Vy]=5,Se[Gy]=6,Se[Wy]=7,Se[Fn]=8,Se[On]=9,Se[cd]=10,Se[dd]=11,Se[lo]=12,Se[Bn]=13,Se[ho]=14,Se[Nn]=15;const IA="1.51",DA="1.55",LA="1.56",FA="1.57",OA="1.58",BA="1.60",NA="1.62",fv="1.65";function gt(){return gt=Object.assign?Object.assign.bind():function(o){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(o[s]=t[s])}return o},gt.apply(this,arguments)}const Be={set(o,e,t,s=1){return o&~(s<<t)|e<<t},get(o,e,t=1){return o>>e&t},all(o,e,t=1){const s=t<<e;return(o&s)===s},any(o,e,t=1){return(o&t<<e)!==0}};var Sh;const bd=7,Xn=15,pv=0,mv=3,_v=7,gv=11,yv=14,vv=18,wp=22,xv=23,Sv=24,bv=25,Tv=26,kA=15,UA=wp;class Ee{constructor(e=!1,t=hs,s=ut,i=Fl,n,r,a,l=!0,h=!0,c=!0,d=!0){this.target0=0,this.setColorBlend(t,s,i),this.setAlphaBlend(n??t,r??s,a??i),this.setColorWrite(l,h,c,d),this.blend=e}set blend(e){this.target0=Be.set(this.target0,e?1:0,Tv)}get blend(){return Be.all(this.target0,Tv)}setColorBlend(e,t,s){this.target0=Be.set(this.target0,e,pv,bd),this.target0=Be.set(this.target0,t,mv,Xn),this.target0=Be.set(this.target0,s,_v,Xn)}setAlphaBlend(e,t,s){this.target0=Be.set(this.target0,e,gv,bd),this.target0=Be.set(this.target0,t,yv,Xn),this.target0=Be.set(this.target0,s,vv,Xn)}setColorWrite(e,t,s,i){this.redWrite=e,this.greenWrite=t,this.blueWrite=s,this.alphaWrite=i}get colorOp(){return Be.get(this.target0,pv,bd)}get colorSrcFactor(){return Be.get(this.target0,mv,Xn)}get colorDstFactor(){return Be.get(this.target0,_v,Xn)}get alphaOp(){return Be.get(this.target0,gv,bd)}get alphaSrcFactor(){return Be.get(this.target0,yv,Xn)}get alphaDstFactor(){return Be.get(this.target0,vv,Xn)}set redWrite(e){this.target0=Be.set(this.target0,e?1:0,wp)}get redWrite(){return Be.all(this.target0,wp)}set greenWrite(e){this.target0=Be.set(this.target0,e?1:0,xv)}get greenWrite(){return Be.all(this.target0,xv)}set blueWrite(e){this.target0=Be.set(this.target0,e?1:0,Sv)}get blueWrite(){return Be.all(this.target0,Sv)}set alphaWrite(e){this.target0=Be.set(this.target0,e?1:0,bv)}get alphaWrite(){return Be.all(this.target0,bv)}get allWrite(){return Be.get(this.target0,UA,kA)}copy(e){return this.target0=e.target0,this}clone(){return new this.constructor().copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}}Sh=Ee,Ee.NOBLEND=Object.freeze(new Sh),Ee.NOWRITE=Object.freeze(new Sh(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1)),Ee.ALPHABLEND=Object.freeze(new Sh(!0,hs,Ol,Bl)),Ee.ADDBLEND=Object.freeze(new Sh(!0,hs,ut,ut));class bh{constructor(){this.map=new Map,this.id=0}get(e){let t=this.map.get(e);return t===void 0&&(t=this.id++,this.map.set(e,t)),t}}var Td;const zA=new bh,wv=7,Ev=0,Av=3;class ft{constructor(e=Yc,t=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t}set test(e){this.func=e?Yc:Ci,this.updateKey()}get test(){return this.func!==Ci}set write(e){this.data=Be.set(this.data,e?1:0,Av),this.updateKey()}get write(){return Be.all(this.data,Av)}set func(e){this.data=Be.set(this.data,e,Ev,wv),this.updateKey()}get func(){return Be.get(this.data,Ev,wv)}set depthBias(e){this._depthBias=e,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return new this.constructor().copy(this)}updateKey(){const{data:e,_depthBias:t,_depthBiasSlope:s}=this,i=`${e}-${t}-${s}`;this.key=zA.get(i)}equals(e){return this.key===e.key}}Td=ft,ft.DEFAULT=Object.freeze(new Td),ft.NODEPTH=Object.freeze(new Td(Ci,!1)),ft.WRITEDEPTH=Object.freeze(new Td(Ci,!0));class Cv{constructor(){this.globalId=0,this.revision=0}equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision}reset(){this.globalId=0,this.revision=0}}let Mv=0;class VA{constructor(){Mv++,this.version=new Cv,this.version.globalId=Mv}increment(){this.version.revision++}}class Ep{constructor(e){this.name=e,this.value=null,this.versionObject=new VA}toJSON(e){}setValue(e){this.value=e,this.versionObject.increment()}getValue(){return this.value}}class Pv{constructor(e){this.name=e,this.variables=new Map}resolve(e){return this.variables.has(e)||this.variables.set(e,new Ep(e)),this.variables.get(e)}removeValue(e){for(const t in this.variables){const s=this.variables[t];s.value===e&&(s.value=null)}}}let GA=0;class es{constructor(e,t,s,i=St,n){this.device=e,this.format=t,this.numVertices=s,this.usage=i,this.id=GA++,this.impl=e.createVertexBufferImpl(this,t),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*s,this.adjustVramSizeTracking(e._vram,this.numBytes),n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.vb+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength!==this.numBytes?!1:(this.storage=e,this.unlock(),!0)}}function Th(o){let e=0;for(let t=0,s=o.length;t<s;t++)e=(e<<5)-e+o.charCodeAt(t),e|=0;return e}function Rv(o){let t=2166136261;for(let s=0;s<o.length;s++)t^=o[s],t*=16777619;return t>>>0}class Rs{constructor(){this._cache=new Map}get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",()=>{this.remove(e)}),e.on("devicelost",()=>{var s;(s=this._cache.get(e))==null||s.loseContext==null||s.loseContext(e)})),this._cache.get(e)}remove(e){var t;(t=this._cache.get(e))==null||t.destroy==null||t.destroy(e),this._cache.delete(e)}}const WA=new bh,HA=[2,4,8,12,16],XA=new Rs;class Tt{constructor(e,t,s){this.device=e,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=s===void 0,this.instancing=!1,this.size=t.reduce((l,h)=>l+Math.ceil(h.components*To[h.type]/4)*4,0);let i=0,n;for(let l=0,h=t.length;l<h;l++){var r,a;const c=t[l];n=c.components*To[c.type],s&&(i=U.roundUp(i,n));const d=(r=c.asInt)!=null?r:!1,u=d?!1:(a=c.normalize)!=null?a:!1,f={name:c.semantic,offset:s?i:c.hasOwnProperty("offset")?c.offset:i,stride:s?n:c.hasOwnProperty("stride")?c.stride:this.size,dataType:c.type,numComponents:c.components,normalize:u,size:n,asInt:d};this._elements.push(f),s?i+=n*s:i+=Math.ceil(n/4)*4,c.semantic===Lt?this.hasUv0=!0:c.semantic===Ri?this.hasUv1=!0:c.semantic===_t?this.hasColor=!0:c.semantic===ei&&(this.hasTangents=!0)}s&&(this.verticesByteSize=i),this._evaluateHash()}get elements(){return this._elements}static getDefaultInstancingFormat(e){return XA.get(e,()=>new Tt(e,[{semantic:lo,components:4,type:le},{semantic:Bn,components:4,type:le},{semantic:ho,components:4,type:le},{semantic:Nn,components:4,type:le}]))}static isElementValid(e,t){const s=t.components*To[t.type];return!(e.isWebGPU&&!HA.includes(s))}update(){this._evaluateHash()}_evaluateHash(){const e=[],t=[],s=this._elements.length;for(let n=0;n<s;n++){const{name:r,dataType:a,numComponents:l,normalize:h,offset:c,stride:d,size:u,asInt:f}=this._elements[n],p=r+a+l+h+f;e.push(p);const _=p+c+d+u;t.push(_)}e.sort();const i=e.join();this.batchingHash=Th(i),this.shaderProcessingHashString=i,this.renderingHashString=t.join("_"),this.renderingHash=WA.get(this.renderingHashString)}}var Iv;const $A=new bh;class cs{set func(e){this._func=e,this._dirty=!0}get func(){return this._func}set ref(e){this._ref=e,this._dirty=!0}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=!0}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=!0}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=!0}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=!0}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=!0}get writeMask(){return this._writeMask}constructor(e={}){var t,s,i,n,r,a,l;this._func=void 0,this._ref=void 0,this._fail=void 0,this._zfail=void 0,this._zpass=void 0,this._readMask=void 0,this._writeMask=void 0,this._dirty=!0,this._key=void 0,this._func=(t=e.func)!=null?t:Ci,this._ref=(s=e.ref)!=null?s:0,this._readMask=(i=e.readMask)!=null?i:255,this._writeMask=(n=e.writeMask)!=null?n:255,this._fail=(r=e.fail)!=null?r:Fr,this._zfail=(a=e.zfail)!=null?a:Fr,this._zpass=(l=e.zpass)!=null?l:Fr,this._evalKey()}_evalKey(){const{_func:e,_ref:t,_fail:s,_zfail:i,_zpass:n,_readMask:r,_writeMask:a}=this,l=`${e},${t},${s},${i},${n},${r},${a}`;this._key=$A.get(l),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return new this.constructor().copy(this)}}Iv=cs,cs.DEFAULT=Object.freeze(new Iv);class Ue extends Q{constructor(e,t){var s,i,n,r,a,l,h,c;super(),this.canvas=void 0,this.backBuffer=null,this.backBufferSize=new G,this.backBufferFormat=void 0,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL1=!1,this.isWebGL2=!1,this.scope=void 0,this.boneLimit=void 0,this.maxAnisotropy=void 0,this.maxCubeMapSize=void 0,this.maxTextureSize=void 0,this.maxVolumeSize=void 0,this.maxColorAttachments=1,this.precision=void 0,this.samples=void 0,this.supportsStencil=void 0,this.supportsMrt=!1,this.supportsVolumeTextures=!1,this.supportsCompute=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.renderPassIndex=void 0,this.insideRenderPass=!1,this.supportsInstancing=void 0,this.supportsUniformBuffers=!1,this.textureFloatRenderable=void 0,this.textureHalfFloatRenderable=void 0,this.textureFloatFilterable=!1,this.textureHalfFloatFilterable=!1,this.quadVertexBuffer=void 0,this.blendState=new Ee,this.depthState=new ft,this.stencilEnabled=!1,this.stencilFront=new cs,this.stencilBack=new cs,this.dynamicBuffers=void 0,this.gpuProfiler=void 0,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:xr|Sr},this.canvas=e,this.initOptions=gt({},t),(i=(s=this.initOptions).depth)!=null||(s.depth=!0),(r=(n=this.initOptions).stencil)!=null||(n.stencil=!0),(l=(a=this.initOptions).antialias)!=null||(a.antialias=!0),(c=(h=this.initOptions).powerPreference)!=null||(h.powerPreference="high-performance"),this._maxPixelRatio=ge.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let d=Lr;d<=Xi;d++)this._primsPerFrame[d]=0;this._renderTargetCreationTime=0,this.scope=new Pv("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}postInit(){const e=new Tt(this,[{semantic:We,components:2,type:le}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new es(this,e,4,St,t)}destroy(){var e,t,s;this.fire("destroy"),(e=this.quadVertexBuffer)==null||e.destroy(),this.quadVertexBuffer=null,(t=this.dynamicBuffers)==null||t.destroy(),this.dynamicBuffers=null,(s=this.gpuProfiler)==null||s.destroy(),this.gpuProfiler=null}onDestroyShader(e){this.fire("destroy:shader",e);const t=this.shaders.indexOf(e);t!==-1&&this.shaders.splice(t,1)}postDestroy(){this.scope=null,this.canvas=null}toJSON(e){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new Ee,this.depthState=new ft,this.cullMode=Ai,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new H(0,0,0,0)}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,s,i){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e}setIndexBuffer(e){this.indexBuffer=e}setVertexBuffer(e){e&&this.vertexBuffers.push(e)}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e))}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement}resizeCanvas(e,t){const s=Math.min(this._maxPixelRatio,ge.browser?window.devicePixelRatio:1),i=Math.floor(e*s),n=Math.floor(t*s);(i!==this.canvas.width||n!==this.canvas.height)&&this.setResolution(i,n)}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(Ue.EVENT_RESIZE,e,t)}updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return!1}set maxPixelRatio(e){this._maxPixelRatio=e}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}getBoneLimit(){return this.boneLimit}setBoneLimit(e){this.boneLimit=e}startRenderPass(e){}endRenderPass(e){}startComputePass(){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){}getRenderableHdrFormat(e=[Ln,et,Ge],t=!0){for(let s=0;s<e.length;s++){const i=e[s];switch(i){case Ln:{if(this.textureRG11B10Renderable)return i;break}case et:if(this.textureHalfFloatRenderable&&(!t||this.textureHalfFloatFilterable))return i;break;case Ge:if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return i;break}}}}Ue.EVENT_RESIZE="resizecanvas";let qA=0;class qe{constructor(e={}){var t,s,i,n,r,a;this.name=void 0,this._device=void 0,this._colorBuffer=void 0,this._colorBuffers=void 0,this._depthBuffer=void 0,this._depth=void 0,this._stencil=void 0,this._samples=void 0,this.autoResolve=void 0,this._face=void 0,this.flipY=void 0,this.id=qA++;const l=arguments[1],h=arguments[2];if(e instanceof Ue?(this._colorBuffer=l,e=h):this._colorBuffer=e.colorBuffer,this._colorBuffer&&(this._colorBuffers=[this._colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=(t=e.face)!=null?t:0,this._depthBuffer){const m=this._depthBuffer._format;m===In?(this._depth=!0,this._stencil=!1):m===Dn?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else{var c,d;this._depth=(c=e.depth)!=null?c:!0,this._stencil=(d=e.stencil)!=null?d:!1}e.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0]));const u=((s=this._colorBuffer)==null?void 0:s.device)||((i=this._depthBuffer)==null?void 0:i.device)||e.graphicsDevice;this._device=u;const{maxSamples:f}=this._device;if(this._samples=Math.min((n=e.samples)!=null?n:1,f),u.isWebGPU&&(this._samples=this._samples>1?f:1),this.autoResolve=(r=e.autoResolve)!=null?r:!0,this.name=e.name,!this.name){var p;this.name=(p=this._colorBuffer)==null?void 0:p.name}if(!this.name){var _;this.name=(_=this._depthBuffer)==null?void 0:_.name}this.name||(this.name="Untitled"),this.flipY=(a=e.flipY)!=null?a:!1,this.validateMrt(),this.impl=u.createRenderTargetImpl(this)}destroy(){const e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){const e=this._device;e&&this.impl.destroy(e)}destroyTextureBuffers(){var e,t;(e=this._depthBuffer)==null||e.destroy(),this._depthBuffer=null,(t=this._colorBuffers)==null||t.forEach(s=>{s.destroy()}),this._colorBuffers=null,this._colorBuffer=null}resize(e,t){if(this.width!==e||this.height!==t){var s,i;const n=this._device;this.destroyFrameBuffers(),n.renderTarget===this&&n.setRenderTarget(null),(s=this._depthBuffer)==null||s.resize(e,t),(i=this._colorBuffers)==null||i.forEach(r=>{r.resize(e,t)}),this.validateMrt(),this.impl=n.createRenderTargetImpl(this)}}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(e=!0,t=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t)}copy(e,t,s){if(!this._device)if(e._device)this._device=e._device;else return!1;return this._device.copyRenderTarget(e,this,t,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){var t;return(t=this._colorBuffers)==null?void 0:t[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get width(){var e,t;return((e=this._colorBuffer)==null?void 0:e.width)||((t=this._depthBuffer)==null?void 0:t.width)||this._device.width}get height(){var e,t;return((e=this._colorBuffer)==null?void 0:e.height)||((t=this._depthBuffer)==null?void 0:t.height)||this._device.height}}class jA{constructor(){this.bindGroup=void 0}update(e){this.destroy();const t=e.device,s=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(s)}destroy(){this.bindGroup=null}createDescriptor(e,t){const s=[],i=t.format;let n=0;return t.uniformBuffers.forEach(a=>{const l=a.persistent?a.impl.buffer:a.allocation.gpuBuffer.buffer;s.push({binding:n++,resource:{buffer:l,offset:0,size:a.format.byteSize}})}),t.textures.forEach((a,l)=>{const h=a.impl,c=i.textureFormats[l],d=h.getView(e);s.push({binding:n++,resource:d});const u=h.getSampler(e,c.sampleType);s.push({binding:n++,resource:u})}),t.storageTextures.forEach((a,l)=>{const c=a.impl.getView(e);s.push({binding:n++,resource:c})}),{layout:t.format.impl.bindGroupLayout,entries:s}}}class Dv{static shaderStage(e){let t=0;return e&jr&&(t|=GPUShaderStage.VERTEX),e&Jt&&(t|=GPUShaderStage.FRAGMENT),e&cv&&(t|=GPUShaderStage.COMPUTE),t}}const ne=[];ne[Kc]="",ne[Ul]="r8unorm",ne[$a]="rg8unorm",ne[Rn]="",ne[qa]="",ne[Ar]="",ne[Es]="rgba8unorm",ne[oe]="rgba8unorm",ne[ja]="bc1-rgba-unorm",ne[zl]="bc2-rgba-unorm",ne[Cr]="bc3-rgba-unorm",ne[Mr]="",ne[et]="rgba16float",ne[Qa]="r16float",ne[ah]="rg16float",ne[Pr]="",ne[Ge]="rgba32float",ne[Pi]="r32float",ne[In]="depth32float",ne[Dn]="depth24plus-stencil8",ne[Ln]="rg11b10ufloat",ne[Vl]="",ne[Gl]="",ne[Ya]="",ne[Wl]="etc2-rgb8unorm",ne[Hl]="etc2-rgba8unorm",ne[Rr]="",ne[Ir]="",ne[Ka]="",ne[Za]="",ne[Zc]="astc-4x4-unorm",ne[Qc]="",ne[Jc]="",ne[ed]="bgra8unorm",ne[Xl]="r8sint",ne[td]="r8uint",ne[$l]="r16sint",ne[ql]="r16uint",ne[jl]="r32sint",ne[Yl]="r32uint",ne[Kl]="rg8sint",ne[sd]="rg8uint",ne[Zl]="rg16sint",ne[Ql]="rg16uint",ne[Jl]="rg32sint",ne[eh]="rg32uint",ne[th]="rgba8sint",ne[id]="rgba8uint",ne[sh]="rgba16sint",ne[ih]="rgba16uint",ne[nh]="rgba32sint",ne[rh]="rgba32uint";const wo=[];wo[kn]="filtering",wo[Un]="non-filtering",wo[Nr]="comparison",wo[fo]="comparison",wo[po]="comparison";const Eo=[];Eo[kn]="float",Eo[Un]="unfilterable-float",Eo[Nr]="depth",Eo[fo]="sint",Eo[po]="uint";const YA=new bh;class KA{constructor(e){const t=e.device,{key:s,descr:i}=this.createDescriptor(e);this.key=YA.get(s),this.bindGroupLayout=t.wgpu.createBindGroupLayout(i)}destroy(){this.bindGroupLayout=null}loseContext(){}getTextureSlot(e,t){return e.bufferFormats.length+t*2}createDescriptor(e){const t=[];let s="",i=0;return e.bufferFormats.forEach(r=>{const a=Dv.shaderStage(r.visibility);s+=`#${i}U:${a}`,t.push({binding:i++,visibility:a,buffer:{type:"uniform",hasDynamicOffset:!0}})}),e.textureFormats.forEach(r=>{const a=Dv.shaderStage(r.visibility),l=r.sampleType,h=r.textureDimension,c=!1,d=Eo[l];s+=`#${i}T:${a}-${d}-${h}-${c}`,t.push({binding:i++,visibility:a,texture:{sampleType:d,viewDimension:h,multisampled:c}});const u=wo[l];s+=`#${i}S:${a}-${u}`,t.push({binding:i++,visibility:a,sampler:{type:u}})}),e.storageTextureFormats.forEach(r=>{const{format:a,textureDimension:l}=r;s+=`#${i}ST:${a}-${l}`,t.push({binding:i++,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:ne[a],viewDimension:l}})}),{key:s,descr:{entries:t}}}}class Ap{constructor(){this.buffer=null}destroy(e){this.buffer&&(this.buffer.destroy(),this.buffer=null)}get initialized(){return!!this.buffer}loseContext(){}unlock(e,t,s,i){var n,r;const a=e.wgpu;if(!this.buffer){const d=i.byteLength+3&-4;this.buffer=e.wgpu.createBuffer({size:d,usage:s|GPUBufferUsage.COPY_DST})}const l=(n=i.byteOffset)!=null?n:0,h=new Uint8Array((r=i.buffer)!=null?r:i,l,i.byteLength),c=new Uint8Array(this.buffer.size);c.set(h),a.queue.writeBuffer(this.buffer,0,c,0,c.length)}}class ZA extends Ap{constructor(e){super(),this.format=null,this.format=e.format===Yt?"uint16":"uint32"}unlock(e){const t=e.device;super.unlock(t,e.usage,GPUBufferUsage.INDEX,e.storage)}}const QA={equals(o,e){if(o.size!==e.size)return!1;for(let t=0;t<o.length;t++)if(o[t]!==e[t])return!1;return!0}},qi=[];qi[si]="sint8",qi[Zt]="uint8",qi[ii]="sint16",qi[Ms]="uint16",qi[xe]="sint32",qi[tt]="uint32",qi[le]="float32",qi[_d]="float16";const ji=[];ji[si]="snorm8",ji[Zt]="unorm8",ji[ii]="snorm16",ji[Ms]="unorm16",ji[xe]="sint32",ji[tt]="uint32",ji[le]="float32",ji[_d]="float16";class JA{constructor(){this.cache=new Map}get(e,t=null){const s=this.getKey(e,t);let i=this.cache.get(s);return i||(i=this.create(e,t),this.cache.set(s,i)),i}getKey(e,t=null){return`${e==null?void 0:e.renderingHashString}-${t==null?void 0:t.renderingHashString}`}create(e,t){const s=[],i=n=>{const r=n.interleaved,a=n.instancing?"instance":"vertex";let l=[];const h=n.elements.length;for(let c=0;c<h;c++){const d=n.elements[c],u=Se[d.name],f=d.normalize?ji:qi;l.push({shaderLocation:u,offset:r?d.offset:0,format:`${f[d.dataType]}${d.numComponents>1?"x"+d.numComponents:""}`}),(!r||c===h-1)&&(s.push({attributes:l,arrayStride:d.stride,stepMode:a}),l=[])}};return e&&i(e),t&&i(t),s}}class Lv{constructor(e){this.device=e}getPipelineLayout(e){const t=[];e.forEach(n=>{t.push(n.bindGroupLayout)});const s={bindGroupLayouts:t};return this.device.wgpu.createPipelineLayout(s)}}const eC=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],Fv=["add","subtract","reverse-subtract","min","max"],wd=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],Cp=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],tC=["none","back","front"],Ao=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"];class sC{constructor(){this.pipeline=void 0,this.hashes=void 0}}class iC extends Lv{constructor(e){super(e),this.lookupHashes=new Uint32Array(13),this.vertexBufferLayout=new JA,this.cache=new Map}get(e,t,s,i,n,r,a,l,h,c,d,u){var f,p,_,m,g,x,S,v;const b=this.lookupHashes;b[0]=e.type,b[1]=i.id,b[2]=h,b[3]=l.key,b[4]=a.key,b[5]=(f=t==null?void 0:t.renderingHash)!=null?f:0,b[6]=(p=s==null?void 0:s.renderingHash)!=null?p:0,b[7]=n.impl.key,b[8]=(_=(m=r[0])==null?void 0:m.key)!=null?_:0,b[9]=(g=(x=r[1])==null?void 0:x.key)!=null?g:0,b[10]=(S=(v=r[2])==null?void 0:v.key)!=null?S:0,b[11]=c?d.key:0,b[12]=c?u.key:0;const w=Rv(b);let T=this.cache.get(w);if(T)for(let I=0;I<T.length;I++){const B=T[I];if(QA.equals(B.hashes,b))return B.pipeline}const E=eC[e.type],C=this.getPipelineLayout(r),M=this.vertexBufferLayout.get(t,s),O=new sC;return O.hashes=new Uint32Array(b),O.pipeline=this.create(E,i,n,C,a,l,M,h,c,d,u),T?T.push(O):T=[O],this.cache.set(w,T),O.pipeline}getBlend(e){let t;return e.blend&&(t={color:{operation:Fv[e.colorOp],srcFactor:wd[e.colorSrcFactor],dstFactor:wd[e.colorDstFactor]},alpha:{operation:Fv[e.alphaOp],srcFactor:wd[e.alphaSrcFactor],dstFactor:wd[e.alphaDstFactor]}}),t}getDepthStencil(e,t,s,i,n){let r;const{depth:a,stencil:l}=t;return(a||l)&&(r={format:t.impl.depthFormat},a?(r.depthWriteEnabled=e.write,r.depthCompare=Cp[e.func],r.depthBias=e.depthBias,r.depthBiasSlopeScale=e.depthBiasSlope):(r.depthWriteEnabled=!1,r.depthCompare="always"),l&&s&&(r.stencilReadMas=i.readMask,r.stencilWriteMask=i.writeMask,r.stencilFront={compare:Cp[i.func],failOp:Ao[i.fail],passOp:Ao[i.zpass],depthFailOp:Ao[i.zfail]},r.stencilBack={compare:Cp[n.func],failOp:Ao[n.fail],passOp:Ao[n.zpass],depthFailOp:Ao[n.zfail]})),r}create(e,t,s,i,n,r,a,l,h,c,d){const u=this.device.wgpu,f=t.impl,p={vertex:{module:f.getVertexShaderModule(),entryPoint:f.vertexEntryPoint,buffers:a},primitive:{topology:e,frontFace:"ccw",cullMode:tC[l]},depthStencil:this.getDepthStencil(r,s,h,c,d),multisample:{count:s.samples},layout:i},_=s.impl.colorAttachments;if(_.length>0){p.fragment={module:f.getFragmentShaderModule(),entryPoint:f.fragmentEntryPoint,targets:[]};let g=0;n.redWrite&&(g|=GPUColorWrite.RED),n.greenWrite&&(g|=GPUColorWrite.GREEN),n.blueWrite&&(g|=GPUColorWrite.BLUE),n.alphaWrite&&(g|=GPUColorWrite.ALPHA);const x=this.getBlend(n);_.forEach(S=>{p.fragment.targets.push({format:S.format,writeMask:g,blend:x})})}return u.createRenderPipeline(p)}}class nC extends Lv{get(e,t){const s=this.getPipelineLayout([t.impl]);return this.create(e,s)}create(e,t){const s=this.device.wgpu,i=e.impl,n={compute:{module:i.getComputeShaderModule(),entryPoint:i.computeEntryPoint},layout:t};return s.createComputePipeline(n)}}const rC=new bh;class aC{constructor(){this.format=void 0,this.multisampledBuffer=void 0}destroy(){var e;(e=this.multisampledBuffer)==null||e.destroy(),this.multisampledBuffer=null}}class oC{constructor(e){this.initialized=!1,this.key=void 0,this.colorAttachments=[],this.depthFormat=void 0,this.hasStencil=void 0,this.depthTexture=null,this.depthTextureInternal=!1,this.assignedColorTexture=null,this.renderPassDescriptor={},this.renderTarget=e,e._colorBuffers&&e._colorBuffers.forEach((t,s)=>{this.setColorAttachment(s,void 0,t.impl.format)}),this.updateKey()}destroy(e){if(this.initialized=!1,this.depthTextureInternal){var t;(t=this.depthTexture)==null||t.destroy(),this.depthTexture=null}this.assignedColorTexture=null,this.colorAttachments.forEach(s=>{s.destroy()}),this.colorAttachments.length=0}updateKey(){const e=this.renderTarget;let t=`${e.samples}:${e.depth?this.depthFormat:"nodepth"}`;this.colorAttachments.forEach(s=>{t+=`:${s.format}`}),this.key=rC.get(t)}setDepthFormat(e){this.depthFormat=e,this.hasStencil=e==="depth24plus-stencil8"}assignColorTexture(e){this.assignedColorTexture=e;const t=e.createView(),s=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?s.resolveTarget=t:s.view=t,this.setColorAttachment(0,void 0,e.format),this.updateKey()}setColorAttachment(e,t,s){this.colorAttachments[e]||(this.colorAttachments[e]=new aC),t&&(this.colorAttachments[e].multisampledBuffer=t),s&&(this.colorAttachments[e].format=s)}init(e,t){var s,i;const n=e.wgpu;this.initDepthStencil(n,t),this.renderPassDescriptor.colorAttachments=[];const r=(s=(i=t._colorBuffers)==null?void 0:i.length)!=null?s:1;for(let l=0;l<r;++l){var a;const h=this.initColor(n,t,l),c=l===0&&((a=this.colorAttachments[0])==null?void 0:a.format);(h.view||c)&&this.renderPassDescriptor.colorAttachments.push(h)}this.initialized=!0}initDepthStencil(e,t){const{samples:s,width:i,height:n,depth:r,depthBuffer:a}=t;if(r||a){if(a)this.depthTexture=a.impl.gpuTexture,this.setDepthFormat(a.impl.format);else{this.setDepthFormat("depth24plus-stencil8");const l={size:[i,n,1],dimension:"2d",sampleCount:s,format:this.depthFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT};s>1?l.usage|=GPUTextureUsage.TEXTURE_BINDING:l.usage|=GPUTextureUsage.COPY_SRC,this.depthTexture=e.createTexture(l),this.depthTextureInternal=!0}this.renderPassDescriptor.depthStencilAttachment={view:this.depthTexture.createView()}}}initColor(e,t,s){const i={},{samples:n,width:r,height:a}=t,l=t.getColorBuffer(s);let h=null;if(l&&(l.cubemap?h=l.impl.createView({dimension:"2d",baseArrayLayer:t.face,arrayLayerCount:1,mipLevelCount:1}):h=l.impl.createView({mipLevelCount:1})),n>1){var c,d;const u={size:[r,a,1],dimension:"2d",sampleCount:n,format:(c=(d=this.colorAttachments[s])==null?void 0:d.format)!=null?c:l.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},f=e.createTexture(u);this.setColorAttachment(s,f,u.format),i.view=f.createView(),i.resolveTarget=h}else i.view=h;return i}setupForRenderPass(e){var t,s;const i=(t=(s=this.renderPassDescriptor.colorAttachments)==null?void 0:s.length)!=null?t:0;for(let r=0;r<i;++r){const a=this.renderPassDescriptor.colorAttachments[r],l=e.colorArrayOps[r];a.clearValue=l.clearValue,a.loadOp=l.clear?"clear":"load",a.storeOp=l.store?"store":"discard"}const n=this.renderPassDescriptor.depthStencilAttachment;n&&(n.depthClearValue=e.depthStencilOps.clearDepthValue,n.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",n.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",n.depthReadOnly=!1,this.hasStencil&&(n.stencilClearValue=e.depthStencilOps.clearStencilValue,n.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",n.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",n.stencilReadOnly=!1))}loseContext(){this.initialized=!1}resolve(e,t,s,i){}}const ct=[];ct[Ps]=1,ct[$i]=2,ct[Qt]=3,ct[Vn]=4,ct[zn]=1,ct[Gn]=2,ct[Wn]=3,ct[Hn]=4,ct[kr]=1,ct[_o]=2,ct[go]=3,ct[yo]=4,ct[hh]=8,ct[vo]=12,ct[Ur]=16,ct[zr]=1,ct[Vr]=2,ct[Gr]=3,ct[Wr]=4;class rt{get isArrayType(){return this.count>0}constructor(e,t,s=0){if(this.name=void 0,this.type=void 0,this.byteSize=void 0,this.offset=void 0,this.scopeId=void 0,this.count=void 0,this.numComponents=void 0,this.shortName=e,this.name=s?`${e}[0]`:e,this.type=t,this.numComponents=ct[t],this.updateType=t,s>0)switch(t){case Ps:this.updateType=ch;break;case zn:this.updateType=Hr;break;case zr:this.updateType=fh;break;case kr:this.updateType=ph;break;case $i:this.updateType=dh;break;case Gn:this.updateType=Xr;break;case Vr:this.updateType=mh;break;case _o:this.updateType=_h;break;case Qt:this.updateType=uh;break;case Wn:this.updateType=$r;break;case Gr:this.updateType=gh;break;case go:this.updateType=yh;break;case Vn:this.updateType=gd;break;case Hn:this.updateType=vh;break;case Wr:this.updateType=yd;break;case yo:this.updateType=vd;break;case Ur:this.updateType=Sp;break}this.count=s;let i=this.numComponents;s&&(i=U.roundUp(i,4)),this.byteSize=i*4,s&&(this.byteSize*=s)}calculateOffset(e){let t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=U.roundUp(e,t),this.offset=e/4}}class wh{constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;let s=0;for(let i=0;i<t.length;i++){const n=t[i];n.calculateOffset(s),s=n.offset*4+n.byteSize,n.scopeId=this.scope.resolve(n.name),this.map.set(n.name,n)}this.byteSize=U.roundUp(s,16)}get(e){return this.map.get(e)}getShaderDeclaration(e,t){const s=dv[e];let i=`layout(set = ${e}, binding = ${t}, std140) uniform ub_${s} {
`;return this.uniforms.forEach(n=>{const r=bp[n.type];i+=`    ${r} ${n.shortName}${n.count?`[${n.count}]`:""};
`}),i+`};
`}}let lC=0;const hC={[Ft]:"texture2D",[uo]:"textureCube",[lh]:"texture3D",[co]:"texture2DArray"};class Eh{constructor(e,t){this.name=e,this.visibility=t}}class Yi{constructor(e,t,s=Ft,i=kn){this.scopeId=void 0,this.name=e,this.visibility=t,this.textureDimension=s,this.sampleType=i}}class cC{constructor(e,t=oe,s=Ft){this.scopeId=void 0,this.name=e,this.format=t,this.textureDimension=s}}class Ah{constructor(e,t=[],s=[],i=[],n={}){var r;this.compute=!1,this.id=lC++,this.compute=(r=n.compute)!=null?r:!1,this.device=e;const a=e.scope;this.bufferFormats=t,this.bufferFormatsMap=new Map,t.forEach((l,h)=>this.bufferFormatsMap.set(l.name,h)),this.textureFormats=s,this.textureFormatsMap=new Map,s.forEach((l,h)=>{this.textureFormatsMap.set(l.name,h),l.scopeId=a.resolve(l.name)}),this.storageTextureFormats=i,this.storageTextureFormatsMap=new Map,i.forEach((l,h)=>{this.storageTextureFormatsMap.set(l.name,h),l.scopeId=a.resolve(l.name)}),this.impl=e.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(e){const t=this.textureFormatsMap.get(e);return t!==void 0?this.textureFormats[t]:null}getStorageTexture(e){const t=this.storageTextureFormatsMap.get(e);return t!==void 0?this.storageTextureFormats[t]:null}getShaderDeclarationTextures(e){let t="",s=this.bufferFormats.length;return this.textureFormats.forEach(i=>{let n=hC[i.textureDimension],r="",a="";n==="texture2DArray"&&(r="_texture",a=`#define ${i.name} sampler2DArray(${i.name}${r}, ${i.name}_sampler)
`),i.sampleType===fo?n=`i${n}`:i.sampleType===po&&(n=`u${n}`),t+=`layout(set = ${e}, binding = ${s++}) uniform ${n} ${i.name}${r};
layout(set = ${e}, binding = ${s++}) uniform sampler ${i.name}_sampler;
`+a}),t}loseContext(){}}const Ov=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,Mp=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)([;]+)/g,Pp="@@@",dC=/([\w-]+)\[(.*?)\]/,uC=new Set(["highp","mediump","lowp"]),fC=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),pC={sampler2D:Ft,sampler3D:lh,samplerCube:uo,samplerCubeShadow:uo,sampler2DShadow:Ft,sampler2DArray:co,sampler2DArrayShadow:co,isampler2D:Ft,usampler2D:Ft,isampler3D:lh,usampler3D:lh,isamplerCube:uo,usamplerCube:uo,isampler2DArray:co,usampler2DArray:co};class mC{constructor(e,t){this.line=e;const s=e.trim().split(/\s+/);if(uC.has(s[0])&&(this.precision=s.shift()),this.type=s.shift(),e.includes(","),e.includes("[")){const i=s.join(" "),n=dC.exec(i);this.name=n[1],this.arraySize=Number(n[2]),isNaN(this.arraySize)&&(t.failed=!0)}else this.name=s.shift(),this.arraySize=0;this.isSampler=this.type.indexOf("sampler")!==-1,this.isSignedInt=this.type.indexOf("isampler")!==-1,this.isUnsignedInt=this.type.indexOf("usampler")!==-1}}class ds{static run(e,t,s){const i=new Map,n=ds.extract(t.vshader),r=ds.extract(t.fshader),a=ds.processAttributes(n.attributes,t.attributes,t.processingOptions),l=ds.processVaryings(n.varyings,i,!0),h=ds.processVaryings(r.varyings,i,!1),c=ds.processOuts(r.outs),d=n.uniforms.concat(r.uniforms),f=Array.from(new Set(d)).map(S=>new mC(S,s)),p=ds.processUniforms(e,f,t.processingOptions,s),_=a+`
`+l+`
`+p.code,m=n.src.replace(Pp,_),g=h+`
`+c+`
`+p.code,x=r.src.replace(Pp,g);return{vshader:m,fshader:x,meshUniformBufferFormat:p.meshUniformBufferFormat,meshBindGroupFormat:p.meshBindGroupFormat}}static extract(e){const t=[],s=[],i=[],n=[];let r=`${Pp}
`,a;for(;(a=Ov.exec(e))!==null;){const l=a[1];switch(l){case"attribute":case"varying":case"uniform":case"out":{Mp.lastIndex=a.index;const h=Mp.exec(e);l==="attribute"?t.push(h[2]):l==="varying"?s.push(h[2]):l==="out"?i.push(h[2]):l==="uniform"&&n.push(h[2]),e=ds.cutOut(e,a.index,Mp.lastIndex,r),Ov.lastIndex=a.index+r.length,r="";break}}}return{src:e,attributes:t,varyings:s,outs:i,uniforms:n}}static processUniforms(e,t,s,i){const n=[],r=[];t.forEach(f=>{f.isSampler?n.push(f):r.push(f)});const a=[];r.forEach(f=>{if(!s.hasUniform(f.name)){const p=bp.indexOf(f.type),_=new rt(f.name,p,f.arraySize);a.push(_)}});const l=a.length?new wh(e,a):null,h=[];l&&h.push(new Eh(bo,jr|Jt));const c=[];n.forEach(f=>{if(!s.hasTexture(f.name)){let p=kn;f.isSignedInt?p=fo:f.isUnsignedInt?p=po:(f.precision==="highp"&&(p=Un),fC.has(f.type)&&(p=Nr));const _=pC[f.type];c.push(new Yi(f.name,jr|Jt,_,p))}});const d=new Ah(e,h,c);let u="";return s.uniformFormats.forEach((f,p)=>{f&&(u+=f.getShaderDeclaration(p,0))}),l&&(u+=l.getShaderDeclaration(So,0)),s.bindGroupFormats.forEach((f,p)=>{f&&(u+=f.getShaderDeclarationTextures(p))}),u+=d.getShaderDeclarationTextures(So),{code:u,meshUniformBufferFormat:l,meshBindGroupFormat:d}}static processVaryings(e,t,s){let i="";const n=s?"out":"in";return e.forEach((r,a)=>{const l=ds.splitToWords(r),h=l[0],c=l[1];s?t.set(c,a):a=t.get(c),i+=`layout(location = ${a}) ${n} ${h} ${c};
`}),i}static processOuts(e){let t="";return e.forEach((s,i)=>{t+=`layout(location = ${i}) out ${s};
`}),t}static getTypeCount(e){const t=e.substring(e.length-1),s=parseInt(t,10);return isNaN(s)?1:s}static processAttributes(e,t,s){let i="";return e.forEach(n=>{const r=ds.splitToWords(n);let a=r[0],l=r[1];if(t.hasOwnProperty(l)){const h=t[l],c=Se[h];let d;const u=s.getVertexElement(h);if(u){const f=u.dataType;if(f!==le&&f!==_d&&!u.normalize&&!u.asInt){const p=ds.getTypeCount(a),_=`_private_${l}`;d=`vec${p} ${l} = vec${p}(${_});
`,l=_;const m=f===si||f===ii||f===xe;p===1?a=m?"int":"uint":a=m?`ivec${p}`:`uvec${p}`}}i+=`layout(location = ${c}) in ${a} ${l};
`,d&&(i+=d)}}),i}static splitToWords(e){return e=e.replace(/\s+/g," ").trim(),e.split(" ")}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}}class _C{constructor(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;const t=e.definition;if(t.shaderLanguage===mo){var s,i,n;this._vertexCode=(s=t.vshader)!=null?s:null,this._fragmentCode=(i=t.fshader)!=null?i:null,this._computeCode=(n=t.cshader)!=null?n:null,this.meshUniformBufferFormat=t.meshUniformBufferFormat,this.meshBindGroupFormat=t.meshBindGroupFormat,this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",e.ready=!0}else t.processingOptions&&this.process()}destroy(e){this._vertexCode=null,this._fragmentCode=null}createShaderModule(e,t){return this.shader.device.wgpu.createShaderModule({code:e})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}process(){const e=this.shader,t=ds.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=!0:e.failed=!0,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat}transpile(e,t,s){try{const i=this.shader.device.glslang.compileGLSL(e,t);return this.shader.device.twgsl.convertSpirV2WGSL(i)}catch(i){console.error(`Failed to transpile webgl ${t} shader [${this.shader.label}] to WebGPU: [${i.message}] while rendering undefined`,{processed:e,original:s,shader:this.shader})}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(e,t){}}class Ii{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,s=1){return 1+Math.floor(Math.log2(Math.max(e,t,s)))}static calcLevelGpuSize(e,t,s,i){var n,r,a;const l=Ja.get(i),h=(n=(r=Ja.get(i))==null?void 0:r.size)!=null?n:0;if(h>0)return e*t*s*h;const c=(a=l.blockSize)!=null?a:0;let d=Math.floor((e+3)/4);const u=Math.floor((t+3)/4),f=Math.floor((s+3)/4);return(i===Rr||i===Ir)&&(d=Math.max(Math.floor(d/2),1)),d*u*f*c}static calcGpuSize(e,t,s,i,n,r){let a=0;for(;a+=Ii.calcLevelGpuSize(e,t,s,i),!(!n||e===1&&t===1&&s===1);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),s=Math.max(s>>1,1);return a*(r?6:1)}}const Co=[];Co[Qe]="repeat",Co[q]="clamp-to-edge",Co[Ha]="mirror-repeat";const Ki=[];Ki[de]={level:"nearest",mip:"nearest"},Ki[Oe]={level:"linear",mip:"nearest"},Ki[Tr]={level:"nearest",mip:"nearest"},Ki[wr]={level:"nearest",mip:"linear"},Ki[Er]={level:"linear",mip:"nearest"},Ki[Qs]={level:"linear",mip:"linear"};const gC=o=>{};class yC{constructor(e){this.gpuTexture=void 0,this.view=void 0,this.samplers=[],this.descr=void 0,this.format=void 0,this.texture=e,this.format=ne[e.format],this.create(e.device)}create(e){const t=this.texture,s=e.wgpu,i=t.requiredMipLevels;this.descr={size:{width:t.width,height:t.height,depthOrArrayLayers:t.cubemap?6:t.array?t.arrayLength:1},format:this.format,mipLevelCount:i,sampleCount:1,dimension:t.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(nd(t.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(t.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=s.createTexture(this.descr);let n;this.texture.format===Dn&&(n={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(n)}destroy(e){}propertyChanged(e){this.samplers.length=0}getView(e){return this.uploadImmediate(e,this.texture),this.view}createView(e){var t,s,i,n,r,a,l;const h=e??{},c=this.descr,d=this.texture,u=()=>d.cubemap?"cube":d.volume?"3d":d.array?"2d-array":"2d",f={format:(t=h.format)!=null?t:c.format,dimension:(s=h.dimension)!=null?s:u(),aspect:(i=h.aspect)!=null?i:"all",baseMipLevel:(n=h.baseMipLevel)!=null?n:0,mipLevelCount:(r=h.mipLevelCount)!=null?r:c.mipLevelCount,baseArrayLayer:(a=h.baseArrayLayer)!=null?a:0,arrayLayerCount:(l=h.arrayLayerCount)!=null?l:c.depthOrArrayLayers};return this.gpuTexture.createView(f)}getSampler(e,t){let s=this.samplers[t];if(!s){const i=this.texture,n={addressModeU:Co[i.addressU],addressModeV:Co[i.addressV],addressModeW:Co[i.addressW]};!t&&i.compareOnRead&&(t=Nr),t===Nr||t===fo||t===po?(n.compare="less",n.magFilter="linear",n.minFilter="linear"):t===Un||this.texture.format===Ge||this.texture.format===Dn||this.texture.format===et||Dr(this.texture.format)?(n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest"):(n.magFilter=Ki[i.magFilter].level,n.minFilter=Ki[i.minFilter].level,n.mipmapFilter=Ki[i.minFilter].mip);const r=n.minFilter==="linear"&&n.magFilter==="linear"&&n.mipmapFilter==="linear";n.maxAnisotropy=r?U.clamp(Math.round(i._anisotropy),1,e.maxTextureAnisotropy):1,s=e.wgpu.createSampler(n),this.samplers[t]=s}return s}loseContext(){}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=!1,t._needsMipmapsUpload=!1)}uploadData(e){const t=this.texture;if(t._levels){let s=!1,i=!1;const n=t.requiredMipLevels;for(let r=0;r<n;r++){const a=t._levels[r];if(a){if(t.cubemap)for(let l=0;l<6;l++){const h=a[l];h?this.isExternalImage(h)?(this.uploadExternalImage(e,h,r,l),s=!0):ArrayBuffer.isView(h)&&(this.uploadTypedArrayData(e,h,r,l),s=!0):i=!0}else if(!t._volume)if(t.array)if(t.arrayLength===a.length)for(let l=0;l<t._arrayLength;l++){const h=a[l];this.isExternalImage(h)?(this.uploadExternalImage(e,h,r,l),s=!0):ArrayBuffer.isView(h)&&(this.uploadTypedArrayData(e,h,r,l),s=!0)}else i=!0;else this.isExternalImage(a)?(this.uploadExternalImage(e,a,r,0),s=!0):ArrayBuffer.isView(a)&&(this.uploadTypedArrayData(e,a,r,0),s=!0)}else i=!0}s&&i&&t.mipmaps&&!nd(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize)}}isExternalImage(e){return e instanceof ImageBitmap||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas}uploadExternalImage(e,t,s,i){const n={source:t,origin:[0,0],flipY:!1},r={texture:this.gpuTexture,mipLevel:s,origin:[0,0,i],aspect:"all"},a={width:this.descr.size.width,height:this.descr.size.height,depthOrArrayLayers:1};e.submit(),gC(t instanceof HTMLCanvasElement&&t.getContext("2d")),e.wgpu.queue.copyExternalImageToTexture(n,r,a)}uploadTypedArrayData(e,t,s,i){const n=this.texture,r=e.wgpu,a={texture:this.gpuTexture,origin:[0,0,i],mipLevel:s},l=Ii.calcLevelDimension(n.width,s),h=Ii.calcLevelDimension(n.height,s);Ii.calcLevelGpuSize(l,h,1,n.format);const c=Ja.get(n.format);let d,u;if(c.size)d={offset:0,bytesPerRow:c.size*l,rowsPerImage:h},u={width:l,height:h};else if(c.blockSize){const f=p=>Math.floor((p+3)/4);d={offset:0,bytesPerRow:c.blockSize*f(l),rowsPerImage:f(h)},u={width:Math.max(4,l),height:Math.max(4,h)}}e.submit(),r.queue.writeTexture(a,t,d,u)}}class vC extends Ap{constructor(e){super()}destroy(e){super.destroy(e)}unlock(e){const t=e.device;super.unlock(t,void 0,GPUBufferUsage.UNIFORM,e.storage)}}class xC extends Ap{constructor(e,t){super()}destroy(e){super.destroy(e)}unlock(e){const t=e.device;super.unlock(t,e.usage,GPUBufferUsage.VERTEX,e.storage)}}const $n=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension)/g,Bv=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,Nv=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,kv=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,Rp=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,Ip=/(endif|else|elif)([ \t]+[^\r\n]+)?\r?(?:\n|$)/g,Uv=/([\w-]+)/,SC=/(!|\s)?defined\(([\w-]+)\)/,bC=/[><=|&+-]/g;class qn{static run(e,t=!1){e=e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1"),e=e.split(/\r?\n/).map(n=>n.trimEnd()).join(`
`);const s=new Map;if(t){const n=new Map,r=/(pcFragColor[1-8])\b/g,a=e.match(r);a==null||a.forEach(l=>{var h;const c=parseInt(l.charAt(l.length-1),10);n.set(c,((h=n.get(c))!=null?h:0)+1)}),n.forEach((l,h)=>{l===1&&s.set(`REMOVE_COLOR_ATTACHMENT_${h}`,"")})}e=this._preprocess(e,s);const i=new Map;return s.forEach((n,r)=>{Number.isInteger(parseFloat(n))&&!n.includes(".")&&i.set(r,n)}),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,i),e}static processArraySize(e,t){return e!==null&&t.forEach((s,i)=>{e=e.replace(new RegExp(`\\[${i}\\]`,"g"),`[${s}]`)}),e}static RemoveEmptyLines(e){return e!==null&&(e=e.split(/\r?\n/).map(t=>t.trim()===""?"":t).join(`
`),e=e.replace(/(\n\n){3,}/gm,`

`)),e}static _preprocess(e,t=new Map){const s=e,i=[];let n=!1,r;for(;(r=$n.exec(e))!==null;){const a=r[1];switch(a){case"define":{Bv.lastIndex=r.index;const l=Bv.exec(e);n||(n=l===null);const h=l[1];Uv.lastIndex=l.index;const d=Uv.exec(h)[1];let u=h.substring(d.length).trim();u===""&&(u="true"),qn._keep(i)&&t.set(d,u),$n.lastIndex=l.index+l[0].length;break}case"undef":{kv.lastIndex=r.index;const l=kv.exec(e),h=l[1].trim();qn._keep(i)&&t.delete(h),$n.lastIndex=l.index+l[0].length;break}case"extension":{Nv.lastIndex=r.index;const l=Nv.exec(e);if(n||(n=l===null),l){const h=l[1];qn._keep(i)&&t.set(h,"true")}$n.lastIndex=l.index+l[0].length;break}case"ifdef":case"ifndef":case"if":{Rp.lastIndex=r.index;const l=Rp.exec(e),h=l[2],c=qn.evaluate(h,t);n||(n=c.error);let d=c.result;a==="ifndef"&&(d=!d),i.push({anyKeep:d,keep:d,start:r.index,end:Rp.lastIndex}),$n.lastIndex=l.index+l[0].length;break}case"endif":case"else":case"elif":{Ip.lastIndex=r.index;const l=Ip.exec(e),h=i.pop(),c=h.keep?e.substring(h.end,r.index):"";e=e.substring(0,h.start)+c+e.substring(Ip.lastIndex),$n.lastIndex=h.start+c.length;const d=l[1];if(d==="else"||d==="elif"){let u=!1;if(!h.anyKeep)if(d==="else")u=!h.keep;else{const f=qn.evaluate(l[2],t);u=f.result,n||(n=f.error)}i.push({anyKeep:h.anyKeep||u,keep:u,start:$n.lastIndex,end:$n.lastIndex})}break}}}return n?(console.warn("Failed to preprocess shader: ",{source:s}),s):e}static _keep(e){for(let t=0;t<e.length;t++)if(!e[t].keep)return!1;return!0}static evaluate(e,t){const s=bC.exec(e)===null;let i=!1;const n=SC.exec(e);n&&(i=n[1]==="!",e=n[2]),e=e.trim();let r=t.has(e);return i&&(r=!r),{result:r,error:!s}}}let TC=0;class Is{constructor(e,t){if(this.meshUniformBufferFormat=void 0,this.meshBindGroupFormat=void 0,this.id=TC++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),!t.cshader){t.vshader=qn.run(t.vshader);const s=e.isWebGL2&&(ge.name==="osx"||ge.name==="ios");t.fshader=qn.run(t.fshader,s)}this.impl=e.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}get label(){return`Shader Id ${this.id} ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}}let wC=0;class Ch{constructor(e,t,s){this.renderVersionUpdated=-1,this.uniformBuffers=void 0,this.uniformBufferOffsets=[],this.id=wC++,this.device=e,this.format=t,this.dirty=!0,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(bo,s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(e,t){const s=this.format.bufferFormatsMap.get(e);this.uniformBuffers[s]!==t&&(this.uniformBuffers[s]=t,this.dirty=!0)}setTexture(e,t){const s=this.format.textureFormatsMap.get(e);this.textures[s]!==t?(this.textures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(e,t){const s=this.format.storageTextureFormatsMap.get(e);this.storageTextures[s]!==t?(this.storageTextures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}update(){const{textureFormats:e,storageTextureFormats:t}=this.format;for(let s=0;s<e.length;s++){const i=e[s],n=i.scopeId.value;this.setTexture(i.name,n)}for(let s=0;s<t.length;s++){const i=t[s],n=i.scopeId.value;this.setStorageTexture(i.name,n)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let s=0;s<this.uniformBuffers.length;s++){const i=this.uniformBuffers[s];this.uniformBufferOffsets[s]=i.offset,this.renderVersionUpdated<i.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}}class EC{constructor(e){this.device=void 0,this.device=e}}class AC{constructor(){this.gpuBuffer=void 0,this.stagingBuffer=void 0,this.offset=void 0,this.size=void 0}}class CC{constructor(){this.storage=void 0,this.gpuBuffer=void 0,this.offset=void 0}}class MC{constructor(e,t,s){this.bufferSize=void 0,this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=s}destroy(){this.gpuBuffers.forEach(e=>{e.destroy(this.device)}),this.gpuBuffers=null,this.stagingBuffers.forEach(e=>{e.destroy(this.device)}),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null}alloc(e,t){if(this.activeBuffer){const n=U.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-n<t&&this.scheduleSubmit()}if(!this.activeBuffer){let n=this.gpuBuffers.pop();n||(n=this.createBuffer(this.device,this.bufferSize,!1));let r=this.stagingBuffers.pop();r||(r=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new AC,this.activeBuffer.stagingBuffer=r,this.activeBuffer.gpuBuffer=n,this.activeBuffer.offset=0,this.activeBuffer.size=0}const s=this.activeBuffer,i=U.roundUp(s.size,this.bufferAlignment);e.gpuBuffer=s.gpuBuffer,e.offset=i,e.storage=s.stagingBuffer.alloc(i,t),s.size=i+t}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit()}}const Me=[];Me[Ps]=function(o,e,t){const s=o.storageFloat32;s[t]=e},Me[$i]=(o,e,t)=>{const s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1]},Me[Qt]=(o,e,t)=>{const s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2]},Me[Vn]=(o,e,t)=>{const s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+3]=e[3]},Me[zn]=function(o,e,t){const s=o.storageInt32;s[t]=e},Me[Gn]=function(o,e,t){const s=o.storageInt32;s[t]=e[0],s[t+1]=e[1]},Me[Wn]=function(o,e,t){const s=o.storageInt32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2]},Me[Hn]=function(o,e,t){const s=o.storageInt32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+3]=e[3]},Me[hh]=(o,e,t)=>{const s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+4]=e[2],s[t+5]=e[3],s[t+8]=e[4],s[t+9]=e[5]},Me[vo]=(o,e,t)=>{const s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+4]=e[3],s[t+5]=e[4],s[t+6]=e[5],s[t+8]=e[6],s[t+9]=e[7],s[t+10]=e[8]},Me[ch]=function(o,e,t,s){const i=o.storageFloat32;for(let n=0;n<s;n++)i[t+n*4]=e[n]},Me[dh]=(o,e,t,s)=>{const i=o.storageFloat32;for(let n=0;n<s;n++)i[t+n*4]=e[n*2],i[t+n*4+1]=e[n*2+1]},Me[uh]=(o,e,t,s)=>{const i=o.storageFloat32;for(let n=0;n<s;n++)i[t+n*4]=e[n*3],i[t+n*4+1]=e[n*3+1],i[t+n*4+2]=e[n*3+2]},Me[zr]=(o,e,t,s)=>{const i=o.storageUint32;i[t]=e},Me[Vr]=(o,e,t,s)=>{const i=o.storageUint32;i[t]=e[0],i[t+1]=e[1]},Me[Gr]=(o,e,t,s)=>{const i=o.storageUint32;i[t]=e[0],i[t+1]=e[1],i[t+2]=e[2]},Me[Wr]=(o,e,t,s)=>{const i=o.storageUint32;i[t]=e[0],i[t+1]=e[1],i[t+2]=e[2],i[t+3]=e[3]},Me[Hr]=function(o,e,t,s){const i=o.storageInt32;for(let n=0;n<s;n++)i[t+n*4]=e[n]},Me[ph]=Me[Hr],Me[fh]=function(o,e,t,s){const i=o.storageUint32;for(let n=0;n<s;n++)i[t+n*4]=e[n]},Me[Xr]=(o,e,t,s)=>{const i=o.storageInt32;for(let n=0;n<s;n++)i[t+n*4]=e[n*2],i[t+n*4+1]=e[n*2+1]},Me[_h]=Me[Xr],Me[mh]=(o,e,t,s)=>{const i=o.storageUint32;for(let n=0;n<s;n++)i[t+n*4]=e[n*2],i[t+n*4+1]=e[n*2+1]},Me[$r]=(o,e,t,s)=>{const i=o.storageInt32;for(let n=0;n<s;n++)i[t+n*4]=e[n*3],i[t+n*4+1]=e[n*3+1],i[t+n*4+2]=e[n*3+2]},Me[yh]=Me[$r],Me[gh]=(o,e,t,s)=>{const i=o.storageUint32;for(let n=0;n<s;n++)i[t+n*4]=e[n*3],i[t+n*4+1]=e[n*3+1],i[t+n*4+2]=e[n*3+2]};class Ed{constructor(e,t,s=!0){if(this.device=void 0,this.persistent=void 0,this.allocation=void 0,this.storageFloat32=void 0,this.storageInt32=void 0,this.storageUint32=void 0,this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=s,s){this.impl=e.createUniformBufferImpl(this);const i=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(i)),e._vram.ub+=this.format.byteSize}else this.allocation=new CC}destroy(){if(this.persistent){const e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}loseContext(){var e;(e=this.impl)==null||e.loseContext()}setUniform(e){const t=e.offset,s=e.scopeId.value;if(s!=null){const i=Me[e.updateType];i?i(this,s,t,e.count):this.storageFloat32.set(s,t)}}set(e){const t=this.format.map.get(e);t&&this.setUniform(t)}update(){const e=this.persistent;if(!e){const s=this.allocation,i=s.gpuBuffer;this.device.dynamicBuffers.alloc(s,this.format.byteSize),this.assignStorage(s.storage),i!==s.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}const t=this.format.uniforms;for(let s=0;s<t.length;s++)this.setUniform(t[s]);e?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}}const PC={type:As,base:0,count:4,indexed:!1};class RC{constructor(e){const t=`

						struct ub_mesh {
								color : vec4f,
								depth: f32
						}

						@group(0) @binding(0) var<uniform> ubMesh : ub_mesh;

						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f
						}

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
								var output : VertexOutput;
								output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);
								return output;
						}

						@fragment
						fn fragmentMain() -> @location(0) vec4f {
								return ubMesh.color;
						}
				`;this.shader=new Is(e,{name:"WebGPUClearRendererShader",shaderLanguage:mo,vshader:t,fshader:t}),this.uniformBuffer=new Ed(e,new wh(e,[new rt("color",Vn),new rt("depth",Ps)]),!1);const s=new Ah(e,[new Eh(bo,jr|Jt)]);this.bindGroup=new Ch(e,s,this.uniformBuffer),this.colorData=new Float32Array(4),this.colorId=e.scope.resolve("color"),this.depthId=e.scope.resolve("depth")}destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null,this.bindGroup.destroy(),this.bindGroup=null}clear(e,t,s,i){var n;s=s||i;const r=(n=s.flags)!=null?n:i.flags;if(r!==0){if(r&xr&&t.colorBuffer){var a;const c=(a=s.color)!=null?a:i.color;this.colorData.set(c),e.setBlendState(Ee.NOBLEND)}else e.setBlendState(Ee.NOWRITE);if(this.colorId.setValue(this.colorData),r&Sr&&t.depth){var l;const c=(l=s.depth)!=null?l:i.depth;this.depthId.setValue(c),e.setDepthState(ft.WRITEDEPTH)}else this.depthId.setValue(1),e.setDepthState(ft.NODEPTH);r&Xa&&t.stencil,e.setCullMode(Je),e.setShader(this.shader);const h=this.bindGroup;h.defaultUniformBuffer.update(),h.update(),e.setBindGroup(So,h),e.draw(PC)}}}class IC{constructor(e){this.device=void 0,this.device=e;const t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
								@location(0) texCoord : vec2f
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var imgSampler : sampler;
						@group(0) @binding(1) var img : texture_2d<f32>;

						@fragment
						fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {
							return textureSample(img, imgSampler, texCoord);
						}
				`;this.shader=new Is(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:mo,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"})}destroy(){this.shader.destroy(),this.shader=null}generate(e){var t;const s=e.descr;if(s.mipLevelCount<=1||e.texture.volume)return;const i=this.device,n=i.wgpu,r=this.shader.impl,a=n.createRenderPipeline({layout:"auto",vertex:{module:r.getVertexShaderModule(),entryPoint:r.vertexEntryPoint},fragment:{module:r.getFragmentShaderModule(),entryPoint:r.fragmentEntryPoint,targets:[{format:s.format}]},primitive:{topology:"triangle-strip"}}),l=e.texture,h=l.cubemap?6:l.array?l.arrayLength:1,c=[];for(let u=0;u<h;u++)c.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:u}));const d=(t=i.commandEncoder)!=null?t:n.createCommandEncoder();for(let u=1;u<s.mipLevelCount;u++)for(let f=0;f<h;f++){const p=e.createView({dimension:"2d",baseMipLevel:u,mipLevelCount:1,baseArrayLayer:f}),_=d.beginRenderPass({colorAttachments:[{view:p,loadOp:"clear",storeOp:"store"}]}),m=n.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:c[f]}]});_.setPipeline(a),_.setBindGroup(0,m),_.draw(4),_.end(),c[f]=p}if(!i.commandEncoder){const u=d.finish();i.addCommandBuffer(u)}i.pipeline=null}}class DC extends EC{constructor(e,t,s){super(e),this.buffer=null,this.mappedRange=null,this.buffer=e.wgpu.createBuffer({size:t,usage:s?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:s}),s&&this.onAvailable(),e._vram.ub+=t}destroy(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null}onAvailable(){this.mappedRange=this.buffer.getMappedRange()}alloc(e,t){return new Int32Array(this.mappedRange,e,t/4)}}class LC extends MC{constructor(...e){super(...e),this.pendingStagingBuffers=[]}createBuffer(e,t,s){return new DC(e,t,s)}submit(){super.submit();const e=this.usedBuffers.length;if(e){const t=this.device,s=this.gpuBuffers,i=t.wgpu.createCommandEncoder();for(let r=e-1;r>=0;r--){const a=this.usedBuffers[r],{stagingBuffer:l,gpuBuffer:h,offset:c,size:d}=a,u=l.buffer;u.unmap(),i.copyBufferToBuffer(u,c,h.buffer,c,d),s.push(h)}const n=i.finish();t.addCommandBuffer(n,!0);for(let r=0;r<e;r++){const a=this.usedBuffers[r].stagingBuffer;this.pendingStagingBuffers.push(a)}this.usedBuffers.length=0}}onCommandBuffersSubmitted(){const e=this.pendingStagingBuffers.length;if(e){for(let t=0;t<e;t++){const s=this.pendingStagingBuffers[t];s.buffer.mapAsync(GPUMapMode.WRITE).then(()=>{this.stagingBuffers&&(s.onAvailable(),this.stagingBuffers.push(s))})}this.pendingStagingBuffers.length=0}}}class zv{constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0}loseContext(){this.pastFrameAllocations.clear()}set enabled(e){this._enableRequest=e}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))}request(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[]}report(e,t){if(t){const s=this.pastFrameAllocations.get(e);if(t.length>0&&(this._frameTime=t[0]),Ua.get(oy))for(let i=0;i<s.length;++i)s[i]}this.pastFrameAllocations.delete(e)}getSlot(e){const t=this.frameAllocations.length;return this.frameAllocations.push(e),t}get slotCount(){return this.frameAllocations.length}}class FC{constructor(e,t,s){this.querySet=void 0,this.stagingBuffers=[],this.activeStagingBuffer=null,this.bytesPerSlot=void 0,this.device=e,this.capacity=s,this.bytesPerSlot=t?8:4;const i=e.wgpu;this.querySet=i.createQuerySet({type:t?"timestamp":"occlusion",count:s}),this.queryBuffer=i.createBuffer({size:this.bytesPerSlot*s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}destroy(){var e,t;(e=this.querySet)==null||e.destroy(),this.querySet=null,(t=this.queryBuffer)==null||t.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach(s=>{s.destroy()}),this.stagingBuffers=null}getStagingBuffer(){let e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e}resolve(e){const t=this.device,s=t.wgpu.createCommandEncoder();s.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);const i=this.getStagingBuffer();this.activeStagingBuffer=i,s.copyBufferToBuffer(this.queryBuffer,0,i,0,this.bytesPerSlot*e);const n=s.finish();t.addCommandBuffer(n)}request(e,t){const s=this.activeStagingBuffer;return this.activeStagingBuffer=null,s.mapAsync(GPUMapMode.READ).then(()=>{var i;const n=new BigInt64Array(s.getMappedRange()),r=[];for(let a=0;a<e;a++)r.push(Number(n[a*2+1]-n[a*2])*1e-6);return s.unmap(),(i=this.stagingBuffers)==null||i.push(s),{renderVersion:t,timings:r}})}}class OC extends zv{constructor(e){super(),this.device=void 0,this.frameGPUMarkerSlot=void 0,this.device=e,this.timestampQueriesSet=e.supportsTimestampQuery?new FC(e,!0,512):null}destroy(){var e;(e=this.timestampQueriesSet)==null||e.destroy(),this.timestampQueriesSet=null}frameStart(){this.processEnableRequest()}frameEnd(){if(this._enabled){var e;(e=this.timestampQueriesSet)==null||e.resolve(this.slotCount*2)}}request(){if(this._enabled){var e;const t=this.device.renderVersion;(e=this.timestampQueriesSet)==null||e.request(this.slotCount,t).then(s=>{this.report(s.renderVersion,s.timings)}),super.request(t)}}}class BC{constructor(e){this.device=void 0,this.pipelineCache=new Map,this.device=e;const t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var img : texture_depth_multisampled_2d;

						@fragment
						fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {
								// load th depth value from sample index 0
								var depth = textureLoad(img, vec2i(fragColor.xy), 0u);
								return vec4<f32>(depth, 0.0, 0.0, 0.0);
						}
				`;this.shader=new Is(e,{name:"WebGPUResolverDepthShader",shaderLanguage:mo,vshader:t,fshader:t})}destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null}getPipeline(e){let t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t}createPipeline(e){const t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})}resolveDepth(e,t,s){const i=this.device,n=i.wgpu,r=this.getPipeline(s.format),a=t.depthOrArrayLayers;for(let l=0;l<a;l++){const h=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:l}),c=s.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:l}),d=e.beginRenderPass({colorAttachments:[{view:c,loadOp:"clear",storeOp:"store"}]}),u=n.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:h}]});d.setPipeline(r),d.setBindGroup(0,u),d.draw(4),d.end()}i.pipeline=null}}class NC{constructor(e){this.compute=e;const{device:t,shader:s}=e,{computeBindGroupFormat:i}=s.impl;this.bindGroup=new Ch(t,i),this.pipeline=t.computePipeline.get(s,i)}dispatch(e,t,s){const i=this.compute.device;i.startComputePass();const{bindGroup:n}=this;n.update(),i.setBindGroup(0,n);const r=i.passEncoder;r.setPipeline(this.pipeline),r.dispatchWorkgroups(e,t,s),i.endComputePass()}}class Vv extends Ue{constructor(e,t={}){var s,i;super(e,t),this.renderPipeline=new iC(this),this.computePipeline=new nC(this),this.clearRenderer=void 0,this.mipmapRenderer=void 0,this.pipeline=void 0,this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],this.limits=void 0,t=this.initOptions,t.alpha=(s=t.alpha)!=null?s:!0,this.backBufferAntialias=(i=t.antialias)!=null?i:!1,this.isWebGPU=!0,this._deviceType=Tp}destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0;const e=this.gpuAdapter.limits;this.limits=e,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=e.maxTextureDimension2D,this.maxCubeMapSize=e.maxTextureDimension2D,this.maxVolumeSize=e.maxTextureDimension3D,this.maxColorAttachments=e.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=e.maxUniformBufferBindingSize/16,this.vertexUniformsCount=e.maxUniformBufferBindingSize/16,this.supportsInstancing=!0,this.supportsUniformBuffers=!0,this.supportsVolumeTextures=!0,this.supportsBoneTextures=!0,this.supportsMorphTargetTexturesCore=!0,this.supportsAreaLights=!0,this.supportsDepthShadow=!0,this.supportsGpuParticles=!1,this.supportsMrt=!0,this.supportsCompute=!0,this.extUintElement=!0,this.extTextureFloat=!0,this.textureFloatRenderable=!0,this.textureHalfFloatFilterable=!0,this.extTextureHalfFloat=!0,this.textureHalfFloatRenderable=!0,this.textureHalfFloatUpdatable=!0,this.boneLimit=1024,this.supportsImageBitmap=!0,this.extStandardDerivatives=!0,this.extBlendMinmax=!0,this.areaLightLutFormat=this.textureFloatFilterable?Ge:oe,this.supportsTextureFetch=!0,this.samples=this.backBufferAntialias?4:1}async initWebGpu(e,t){if(!window.navigator.gpu)throw new Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");const s=c=>{if(!ce.isRelativePath(c))return c;const d=new URL(window.location.href);return d.pathname=c,d.search="",d.toString()},i=await Promise.all([import(`${s(t)}`).then(c=>twgsl(t.replace(".js",".wasm"))),import(`${s(e)}`).then(c=>c.default())]);this.twgsl=i[0],this.glslang=i[1];const n={powerPreference:this.initOptions.powerPreference!=="default"?this.initOptions.powerPreference:void 0};this.gpuAdapter=await window.navigator.gpu.requestAdapter(n);const r=[],a=c=>{const d=this.gpuAdapter.features.has(c);return d&&r.push(c),d};this.textureFloatFilterable=a("float32-filterable"),this.extCompressedTextureS3TC=a("texture-compression-bc"),this.extCompressedTextureETC=a("texture-compression-etc2"),this.extCompressedTextureASTC=a("texture-compression-astc"),this.supportsTimestampQuery=a("timestamp-query"),this.textureRG11B10Renderable=a("rg11b10ufloat-renderable");const l={requiredFeatures:r,requiredLimits:{},defaultQueue:{label:"Default Queue"}};this.wgpu=await this.gpuAdapter.requestDevice(l),this.initDeviceCaps(),this.gpuContext=this.canvas.getContext("webgpu");const h=navigator.gpu.getPreferredCanvasFormat();return this.backBufferFormat=h==="rgba8unorm"?oe:ed,this.canvasConfig={device:this.wgpu,colorSpace:"srgb",alphaMode:this.initOptions.alpha?"premultiplied":"opaque",format:h,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:[]},this.gpuContext.configure(this.canvasConfig),this.createBackbuffer(),this.clearRenderer=new RC(this),this.mipmapRenderer=new IC(this),this.resolver=new BC(this),this.postInit(),this}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new OC(this),this.dynamicBuffers=new LC(this,1024*1024,this.limits.minUniformBufferOffsetAlignment)}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new qe({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples})}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();const e=this.gpuContext.getCurrentTexture();(this.backBufferSize.x!==e.width||this.backBufferSize.y!==e.height)&&(this.backBufferSize.set(e.width,e.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());const t=this.backBuffer,s=t.impl;s.setColorAttachment(0,void 0,e.format),this.initRenderTarget(t),s.assignColorTexture(e)}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.gpuProfiler.request()}createUniformBufferImpl(e){return new vC(e)}createVertexBufferImpl(e,t){return new xC(e,t)}createIndexBufferImpl(e){return new ZA(e)}createShaderImpl(e){return new _C(e)}createTextureImpl(e){return new yC(e)}createRenderTargetImpl(e){return new oC(e)}createBindGroupFormatImpl(e){return new KA(e)}createBindGroupImpl(e){return new jA}createComputeImpl(e){return new NC(e)}setBindGroup(e,t){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl)}submitVertexBuffer(e,t){const s=e.format.elements,i=s.length,n=e.impl.buffer;for(let r=0;r<i;r++)this.passEncoder.setVertexBuffer(t+r,n,s[r].offset);return i}draw(e,t=1,s){if(this.shader.ready&&!this.shader.failed){const i=this.passEncoder,n=this.vertexBuffers[0],r=this.vertexBuffers[1];if(this.vertexBuffers.length=0,n){const h=this.submitVertexBuffer(n,0);r&&this.submitVertexBuffer(r,h)}const a=this.renderPipeline.get(e,n==null?void 0:n.format,r==null?void 0:r.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack);this.pipeline!==a&&(this.pipeline=a,i.setPipeline(a));const l=this.indexBuffer;l?(this.indexBuffer=null,i.setIndexBuffer(l.impl.buffer,l.impl.format),i.drawIndexed(e.count,t,e.base,0,0)):i.draw(e.count,t,e.base,0)}}setShader(e,t=!1){e!==this.shader&&(this.shader=e)}setBlendState(e){this.blendState.copy(e)}setDepthState(e){this.depthState.copy(e)}setStencilState(e,t){if(e||t){this.stencilEnabled=!0,this.stencilFront.copy(e??cs.DEFAULT),this.stencilBack.copy(t??cs.DEFAULT);const s=this.stencilFront.ref;this.stencilRef!==s&&(this.stencilRef=s,this.passEncoder.setStencilReference(s))}else this.stencilEnabled=!1}setBlendColor(e,t,s,i){const n=this.blendColor;(e!==n.r||t!==n.g||s!==n.b||i!==n.a)&&(n.set(e,t,s,i),this.passEncoder.setBlendConstant(n))}setCullMode(e){this.cullMode=e}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)}_uploadDirtyTextures(){this.textures.forEach(e=>{(e._needsUpload||e._needsMipmaps)&&e.upload()})}startRenderPass(e){this._uploadDirtyTextures();const t=e.renderTarget||this.backBuffer;this.renderTarget=t;const s=t.impl;this.commandEncoder=this.wgpu.createCommandEncoder(),t!==this.backBuffer&&this.initRenderTarget(t),s.setupForRenderPass(e);const i=s.renderPassDescriptor;if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){const a=this.gpuProfiler.getSlot(e.name);i.timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:a*2,endOfPassWriteIndex:a*2+1}}this.passEncoder=this.commandEncoder.beginRenderPass(i),this.setupPassEncoderDefaults();const{width:n,height:r}=t;this.setViewport(0,0,n,r),this.setScissor(0,0,n,r),this.insideRenderPass=!0}endRenderPass(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;for(let s=0;s<e.colorArrayOps.length;s++)e.colorArrayOps[s].mipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[s].impl);const t=this.commandEncoder.finish();this.addCommandBuffer(t),this.commandEncoder=null}startComputePass(){this.commandEncoder=this.wgpu.createCommandEncoder(),this.pipeline=null,this.passEncoder=this.commandEncoder.beginComputePass(),this.insideRenderPass=!0}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;const e=this.commandEncoder.finish();this.addCommandBuffer(e),this.commandEncoder=null}addCommandBuffer(e,t=!1){t?this.commandBuffers.unshift(e):this.commandBuffers.push(e)}submit(){this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())}clear(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions)}setViewport(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.vx=e,this.vy=t,this.vw=s,this.vh=i,this.passEncoder.setViewport(e,t,s,i,0,1))}setScissor(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.sx=e,this.sy=t,this.sw=s,this.sh=i,this.passEncoder.setScissorRect(e,t,s,i))}copyRenderTarget(e,t,s,i){var n;const r={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},a=(n=this.commandEncoder)!=null?n:this.wgpu.createCommandEncoder();if(s){const l={texture:e?e.colorBuffer.impl.gpuTexture:this.renderTarget.impl.assignedColorTexture,mipLevel:0},h={texture:t?t.colorBuffer.impl.gpuTexture:this.renderTarget.impl.assignedColorTexture,mipLevel:0};a.copyTextureToTexture(l,h,r)}if(i){const h=(e||this.renderTarget).impl.depthTexture;if(e.samples>1){const c=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(a,h,c)}else{const c=t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthTexture,d={texture:h,mipLevel:0},u={texture:c,mipLevel:0};a.copyTextureToTexture(d,u,r)}}if(!this.commandEncoder){const l=a.finish();this.addCommandBuffer(l)}return!0}}let kC=0;class re{constructor(e,t={}){var s,i,n,r,a,l,h,c,d,u,f,p,_,m,g,x,S,v,b;if(this.name=void 0,this._gpuSize=0,this.id=kC++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=ud,this.renderVersionDirty=0,this._storage=!1,this.device=e,this.name=(s=t.name)!=null?s:"",this._width=Math.floor((i=t.width)!=null?i:4),this._height=Math.floor((n=t.height)!=null?n:4),this._format=(r=t.format)!=null?r:oe,this._compressed=nd(this._format),this._integerFormat=Dr(this._format),this._integerFormat&&(t.mipmaps=!1,t.minFilter=de,t.magFilter=de),e.supportsVolumeTextures){var w,T,E;this._volume=(w=t.volume)!=null?w:!1,this._depth=Math.floor((T=t.depth)!=null?T:1),this._arrayLength=Math.floor((E=t.arrayLength)!=null?E:0)}else this._volume=!1,this._depth=1,this._arrayLength=0;this._storage=(a=t.storage)!=null?a:!1,this._cubemap=(l=t.cubemap)!=null?l:!1,this.fixCubemapSeams=(h=t.fixCubemapSeams)!=null?h:!1,this._flipY=(c=t.flipY)!=null?c:!1,this._premultiplyAlpha=(d=t.premultiplyAlpha)!=null?d:!1,this._mipmaps=(u=(f=t.mipmaps)!=null?f:t.autoMipmap)!=null?u:!0,this._minFilter=(p=t.minFilter)!=null?p:Qs,this._magFilter=(_=t.magFilter)!=null?_:Oe,this._anisotropy=(m=t.anisotropy)!=null?m:1,this._addressU=(g=t.addressU)!=null?g:Qe,this._addressV=(x=t.addressV)!=null?x:Qe,this._addressW=(S=t.addressW)!=null?S:Qe,this._compareOnRead=(v=t.compareOnRead)!=null?v:!1,this._compareFunc=(b=t.compareFunc)!=null?b:jc,this.type=bt,t.hasOwnProperty("type")?this.type=t.type:t.hasOwnProperty("rgbm")?this.type=t.rgbm?Cs:bt:t.hasOwnProperty("swizzleGGGR")&&(this.type=t.swizzleGGGR?Br:bt),this.projection=jy,this._cubemap?this.projection=md:t.projection&&t.projection!==md&&(this.projection=t.projection),this.impl=e.createTextureImpl(this),this.dirtyAll(),this._levels=t.levels,this._levels?this.upload():this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null],e.textures.push(this)}destroy(){const e=this.device;if(e){const t=e.textures.indexOf(this);t!==-1&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}resize(e,t,s=1){const i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(s),this.impl=i.createTextureImpl(this),this.dirtyAll()}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion}get requiredMipLevels(){return this.mipmaps?Ii.calcMipLevelsCount(this.width,this.height):1}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&(Dr(this._format)||(this._minFilter=e,this.propertyChanged(1)))}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(Dr(this._format)||(this._magFilter=e,this.propertyChanged(2)))}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(4))}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(8))}get addressV(){return this._addressV}set addressW(e){this.device.supportsVolumeTextures&&this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(16))}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(32))}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(64))}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(128))}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||Dr(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const e=this.pot&&this._mipmaps&&!(this._compressed&&this._levels.length===1);return Ii.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return U.powerOfTwo(this._width)&&U.powerOfTwo(this._height)}get encoding(){switch(this.type){case Cs:return"rgbm";case pd:return"rgbe";case Or:return"rgbp";default:return this.format===Mr||this.format===Pr||this.format===et||this.format===Ge||Dr(this.format)?"linear":"srgb"}}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)}lock(e={}){var t,s,i;(t=e.level)!=null||(e.level=0),(s=e.face)!=null||(e.face=0),(i=e.mode)!=null||(e.mode=fd),this._lockedMode=e.mode,this._lockedLevel=e.level;const n=this.cubemap?this._levels[e.face]:this._levels;if(n[e.level]===null){const r=Math.max(1,this._width>>e.level),a=Math.max(1,this._height>>e.level),l=Math.max(1,this._depth>>e.level),h=new ArrayBuffer(Ii.calcLevelGpuSize(r,a,l,this._format));n[e.level]=new(Uy(this._format))(h)}return n[e.level]}setSource(e,t=0){let s=!1,i,n;if(this._cubemap){if(e[0]){i=e[0].width||0,n=e[0].height||0;for(let r=0;r<6;r++){const a=e[r];if(!a||a.width!==i||a.height!==n||!this.device._isBrowserInterface(a)){s=!0;break}}}else s=!0;if(!s)for(let r=0;r<6;r++)this._levels[t][r]!==e[r]&&(this._levelsUpdated[t][r]=!0)}else this.device._isBrowserInterface(e)||(s=!0),s||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),i=e.width,n=e.height);if(s)if(this._width=4,this._height=4,this._cubemap)for(let r=0;r<6;r++)this._levels[t][r]=null,this._levelsUpdated[t][r]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else t===0&&(this._width=i,this._height=n),this._levels[t]=e;(this._invalid!==s||!s)&&(this._invalid=s,this.upload())}getSource(e=0){return this._levels[e]}unlock(){this._lockedMode,this._lockedMode===fd&&this.upload(),this._lockedLevel=-1,this._lockedMode=ud}upload(){var e,t;this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,(e=(t=this.impl).uploadImmediate)==null||e.call(t,this.device,this)}async downloadAsync(){const e=[];for(let i=0;i<(this.cubemap?6:1);i++){var t,s;const n=new qe({colorBuffer:this,depth:!1,face:i});this.device.setRenderTarget(n),this.device.initRenderTarget(n);const r=this.cubemap?this._levels[i]:this._levels;let a=r[0];r[0]&&this.device._isBrowserInterface(r[0])&&(r[0]=null),a=this.lock({face:i});const l=(t=(s=this.device).readPixelsAsync)==null?void 0:t.call(s,0,0,this.width,this.height,a).then(()=>n.destroy());e.push(l)}await Promise.all(e)}}class Gv{constructor(){this.bufferId=null}destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(e,t,s,i){const n=e.gl;if(this.bufferId)n.bindBuffer(s,this.bufferId),n.bufferSubData(s,0,i);else{let r;switch(t){case St:r=n.STATIC_DRAW;break;case Pn:r=n.DYNAMIC_DRAW;break;case _p:r=n.STREAM_DRAW;break;case qc:r=e.isWebGL2?n.DYNAMIC_COPY:n.STATIC_DRAW;break}this.bufferId=n.createBuffer(),n.bindBuffer(s,this.bufferId),n.bufferData(s,i,r)}}}class UC extends Gv{constructor(...e){super(...e),this.vao=null}destroy(e){super.destroy(e),e.unbindVertexArray()}loseContext(){super.loseContext(),this.vao=null}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage)}}class zC extends Gv{constructor(e){super();const t=e.device.gl,s=e.format;s===kl?this.glFormat=t.UNSIGNED_BYTE:s===Yt?this.glFormat=t.UNSIGNED_SHORT:s===Mi&&(this.glFormat=t.UNSIGNED_INT)}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage)}}class Dp{constructor(e,t,s,i){if(this.locationId=i,this.scopeId=e.scope.resolve(t),this.version=new Cv,t.substring(t.length-3)==="[0]")switch(s){case Ps:s=ch;break;case zn:s=Hr;break;case zr:s=fh;break;case kr:s=ph;break;case $i:s=dh;break;case Gn:s=Xr;break;case Vr:s=mh;break;case _o:s=_h;break;case Qt:s=uh;break;case Wn:s=$r;break;case Gr:s=gh;break;case go:s=yh;break;case Vn:s=gd;break;case Hn:s=vh;break;case Wr:s=yd;break;case yo:s=vd;break}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}const VC=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class GC{constructor(){this.map=new Map}destroy(e){this.map.forEach(t=>{e.gl.deleteShader(t)})}loseContext(e){this.map.clear()}}const WC=new Rs,HC=new Rs;class XC{constructor(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e)}destroy(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}loseContext(){this.init()}restoreContext(e,t){this.compile(e,t),this.link(e,t)}compile(e,t){const s=t.definition;this.glVertexShader=this._compileShaderSource(e,s.vshader,!0),this.glFragmentShader=this._compileShaderSource(e,s.fshader,!1)}link(e,t){if(this.glProgram)return;const s=e.gl;if(s.isContextLost())return;const i=s.createProgram();this.glProgram=i,s.attachShader(i,this.glVertexShader),s.attachShader(i,this.glFragmentShader);const n=t.definition,r=n.attributes;if(e.isWebGL2&&n.useTransformFeedback){const a=[];for(const l in r)r.hasOwnProperty(l)&&a.push("out_"+l);s.transformFeedbackVaryings(i,a,s.INTERLEAVED_ATTRIBS)}for(const a in r)if(r.hasOwnProperty(a)){const l=r[a],h=Se[l];s.bindAttribLocation(i,h,a)}s.linkProgram(i)}_compileShaderSource(e,t,s){const i=e.gl,r=(s?WC:HC).get(e,()=>new GC);let a=r.map.get(t);if(!a){if(a=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),!a&&i.isContextLost())return a;i.shaderSource(a,t),i.compileShader(a),r.map.set(t,a)}return a}finalize(e,t){const s=e.gl;if(s.isContextLost())return!0;const i=this.glProgram,n=t.definition;if(!s.getProgramParameter(i,s.LINK_STATUS)){if(!this._isCompiled(e,t,this.glVertexShader,n.vshader,"vertex")||!this._isCompiled(e,t,this.glFragmentShader,n.fshader,"fragment"))return!1;const c="Failed to link shader program. Error: "+s.getProgramInfoLog(i);return console.error(c),!1}const a=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);for(let c=0;c<a;c++){const d=s.getActiveAttrib(i,c),u=s.getAttribLocation(i,d.name);if(!VC.has(d.name))if(n.attributes[d.name]===void 0)console.error(`Vertex shader attribute "${d.name}" is not mapped to a semantic in shader definition, shader [${t.label}]`,t),t.failed=!0;else{const f=new Dp(e,n.attributes[d.name],e.pcUniformType[d.type],u);this.attributes.push(f)}}const l=e._samplerTypes,h=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(let c=0;c<h;c++){const d=s.getActiveUniform(i,c),u=s.getUniformLocation(i,d.name),f=new Dp(e,d.name,e.pcUniformType[d.type],u);l.has(d.type)?this.samplers.push(f):this.uniforms.push(f)}return t.ready=!0,!0}_isCompiled(e,t,s,i,n){const r=e.gl;if(!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=r.getShaderInfoLog(s),[l,h]=this._processError(i,a),c=`Failed to compile ${n} shader:

${a}
${l} while rendering undefined`;return console.error(c),!1}return!0}isLinked(e){const{extParallelShaderCompile:t}=e;return t?e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR):!0}_processError(e,t){const s={};let i="";if(e){const n=e.split(`
`);let r=0,a=n.length;if(t&&t.startsWith("ERROR:")){const l=t.match(/^ERROR:\s([0-9]+):([0-9]+):\s*(.+)/);l&&(s.message=l[3],s.line=parseInt(l[2],10),r=Math.max(0,s.line-6),a=Math.min(n.length,s.line+5))}for(let l=r;l<a;l++)i+=l+1+":	"+n[l]+`
`;s.source=e}return[i,s]}}function Wv(o,e){const t=o.width,s=o.height;if(t>e||s>e){const i=e/Math.max(t,s),n=Math.floor(t*i),r=Math.floor(s*i),a=document.createElement("canvas");return a.width=n,a.height=r,a.getContext("2d").drawImage(o,0,0,t,s,0,0,n,r),a}return o}class $C{constructor(){this._glTexture=null,this._glTarget=void 0,this._glFormat=void 0,this._glInternalFormat=void 0,this._glPixelType=void 0,this._glCreated=void 0,this.dirtyParameterFlags=0}destroy(e){if(this._glTexture){for(let t=0;t<e.textureUnits.length;t++){const s=e.textureUnits[t];for(let i=0;i<s.length;i++)s[i]===this._glTexture&&(s[i]=null)}e.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(e){this.dirtyParameterFlags|=e}initialize(e,t){const s=e.gl;switch(this._glTexture=s.createTexture(),this._glTarget=t._cubemap?s.TEXTURE_CUBE_MAP:t._volume?s.TEXTURE_3D:t.array?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,t._format){case Kc:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case Ul:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case $a:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case Rn:this._glFormat=s.RGB,this._glInternalFormat=s.RGB,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case qa:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case Ar:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case Es:this._glFormat=s.RGB,this._glInternalFormat=e.isWebGL2?s.RGB8:s.RGB,this._glPixelType=s.UNSIGNED_BYTE;break;case oe:this._glFormat=s.RGBA,this._glInternalFormat=e.isWebGL2?s.RGBA8:s.RGBA,this._glPixelType=s.UNSIGNED_BYTE;break;case ja:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case zl:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Cr:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case Ya:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case Rr:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case Ir:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case Ka:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case Za:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case Wl:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case Hl:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case Zc:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case Qc:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case Jc:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case Qa:e.isWebGL2?(this._glFormat=s.RED,this._glInternalFormat=s.R16F,this._glPixelType=s.HALF_FLOAT):(this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case ah:e.isWebGL2?(this._glFormat=s.RG,this._glInternalFormat=s.RG16F,this._glPixelType=s.HALF_FLOAT):(this._glFormat=s.RG,this._glInternalFormat=s.RG,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case Mr:this._glFormat=s.RGB,e.isWebGL2?(this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGB,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case et:this._glFormat=s.RGBA,e.isWebGL2?(this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGBA,this._glPixelType=e.extTextureHalfFloat.HALF_FLOAT_OES);break;case Pr:this._glFormat=s.RGB,e.isWebGL2?this._glInternalFormat=s.RGB32F:this._glInternalFormat=s.RGB,this._glPixelType=s.FLOAT;break;case Ge:this._glFormat=s.RGBA,e.isWebGL2?this._glInternalFormat=s.RGBA32F:this._glInternalFormat=s.RGBA,this._glPixelType=s.FLOAT;break;case Pi:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case In:e.isWebGL2?(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT):(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT,this._glPixelType=s.UNSIGNED_SHORT);break;case Dn:this._glFormat=s.DEPTH_STENCIL,e.isWebGL2?(this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8):(this._glInternalFormat=s.DEPTH_STENCIL,this._glPixelType=e.extDepthTexture.UNSIGNED_INT_24_8_WEBGL);break;case Ln:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case Vl:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case Gl:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break;case Xl:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8I,this._glPixelType=s.BYTE;break;case td:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case $l:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16I,this._glPixelType=s.SHORT;break;case ql:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case jl:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32I,this._glPixelType=s.INT;break;case Yl:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32UI,this._glPixelType=s.UNSIGNED_INT;break;case Kl:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8I,this._glPixelType=s.BYTE;break;case sd:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case Zl:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16I,this._glPixelType=s.SHORT;break;case Ql:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case Jl:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32I,this._glPixelType=s.INT;break;case eh:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32UI,this._glPixelType=s.UNSIGNED_INT;break;case th:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8I,this._glPixelType=s.BYTE;break;case id:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case sh:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16I,this._glPixelType=s.SHORT;break;case ih:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case nh:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32I,this._glPixelType=s.INT;break;case rh:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32UI,this._glPixelType=s.UNSIGNED_INT;break}this._glCreated=!1}upload(e,t){const s=e.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let i=0,n,r;const a=t.requiredMipLevels;for(t.array&&s.texStorage3D(s.TEXTURE_2D_ARRAY,a,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[i]||i===0;){if(!t._needsUpload&&i===0){i++;continue}else if(i&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(n=t._levels[i],r=1/Math.pow(2,i),i===1&&!t._compressed&&!t._integerFormat&&t._levels.length<a&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._cubemap){let l;if(e._isBrowserInterface(n[0]))for(l=0;l<6;l++){if(!t._levelsUpdated[0][l])continue;let h=n[l];e._isImageBrowserInterface(h)&&(h.width>e.maxCubeMapSize||h.height>e.maxCubeMapSize)&&(h=Wv(h,e.maxCubeMapSize),i===0&&(t._width=h.width,t._height=h.height)),e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,this._glFormat,this._glPixelType,h):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,this._glFormat,this._glPixelType,h)}else for(r=1/Math.pow(2,i),l=0;l<6;l++){if(!t._levelsUpdated[0][l])continue;const h=n[l];t._compressed?this._glCreated&&h?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,Math.max(t._width*r,1),Math.max(t._height*r,1),this._glInternalFormat,h):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),0,h):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&h?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,Math.max(t._width*r,1),Math.max(t._height*r,1),this._glFormat,this._glPixelType,h):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),0,this._glFormat,this._glPixelType,h))}}else if(t._volume)t._compressed?s.compressedTexImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),Math.max(t._depth*r,1),0,n):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),Math.max(t._depth*r,1),0,this._glFormat,this._glPixelType,n));else if(t.array&&typeof n=="object"){if(t._arrayLength===n.length)if(t._compressed)for(let l=0;l<t._arrayLength;l++)s.compressedTexSubImage3D(s.TEXTURE_2D_ARRAY,i,0,0,l,Math.max(Math.floor(t._width*r),1),Math.max(Math.floor(t._height*r),1),1,this._glFormat,n[l]);else for(let l=0;l<t._arrayLength;l++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,i,0,0,l,Math.max(Math.floor(t._width*r),1),Math.max(Math.floor(t._height*r),1),1,this._glFormat,this._glPixelType,n[l])}else{if(e._isBrowserInterface(n)){e._isImageBrowserInterface(n)&&(n.width>e.maxTextureSize||n.height>e.maxTextureSize)&&(n=Wv(n,e.maxTextureSize),i===0&&(t._width=n.width,t._height=n.height));const l=n.width||n.videoWidth,h=n.height||n.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===l&&t._height===h&&!e._isImageVideoInterface(n)?s.texSubImage2D(s.TEXTURE_2D,i,0,0,this._glFormat,this._glPixelType,n):(s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,this._glFormat,this._glPixelType,n),i===0&&(t._width=l,t._height=h))}else r=1/Math.pow(2,i),t._compressed?this._glCreated&&n?s.compressedTexSubImage2D(s.TEXTURE_2D,i,0,0,Math.max(Math.floor(t._width*r),1),Math.max(Math.floor(t._height*r),1),this._glInternalFormat,n):s.compressedTexImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(Math.floor(t._width*r),1),Math.max(Math.floor(t._height*r),1),0,n):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&n?s.texSubImage2D(s.TEXTURE_2D,i,0,0,Math.max(t._width*r,1),Math.max(t._height*r,1),this._glFormat,this._glPixelType,n):s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),0,this._glFormat,this._glPixelType,n));i===0?t._mipmapsUploaded=!1:t._mipmapsUploaded=!0}i++}if(t._needsUpload)if(t._cubemap)for(let l=0;l<6;l++)t._levelsUpdated[0][l]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&(t.pot||e.isWebGL2)&&t._levels.length===1&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=!0}}class qC{constructor(e,t){this.msaaFB=void 0,this.resolveFB=void 0,this.msaaFB=e,this.resolveFB=t}destroy(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}}class jC{constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}destroy(e){var t;const s=e.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(s.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach(i=>{s.deleteRenderbuffer(i)}),this._glMsaaColorBuffers.length=0,(t=this.colorMrtFramebuffers)==null||t.forEach(i=>{i.destroy(s)}),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(s.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null),this.suppliedColorFramebuffer=void 0}get initialized(){return this._isInitialized}init(e,t){const s=e.gl;this._isInitialized=!0;const i=[];if(this.suppliedColorFramebuffer!==void 0)this._glFrameBuffer=this.suppliedColorFramebuffer;else{var n,r,a,l;this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const d=(n=(r=t._colorBuffers)==null?void 0:r.length)!=null?n:0,u=e.isWebGL2?s.COLOR_ATTACHMENT0:(a=(l=e.extDrawBuffers)==null?void 0:l.COLOR_ATTACHMENT0_WEBGL)!=null?a:s.COLOR_ATTACHMENT0;for(let p=0;p<d;++p){const _=t.getColorBuffer(p);_&&(_.impl._glTexture||(_._width=Math.min(_.width,e.maxRenderBufferSize),_._height=Math.min(_.height,e.maxRenderBufferSize),e.setTexture(_,0)),s.framebufferTexture2D(s.FRAMEBUFFER,u+p,_._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,_.impl._glTexture,0),i.push(u+p))}e.drawBuffers&&e.drawBuffers(i);const f=t._depthBuffer;if(f)f.impl._glTexture||(f._width=Math.min(f.width,e.maxRenderBufferSize),f._height=Math.min(f.height,e.maxRenderBufferSize),e.setTexture(f,0)),t._stencil?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,f._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,f._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,0);else if(t._depth&&!(t._samples>1&&e.isWebGL2)){if(this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),t._stencil)s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer);else{const _=e.isWebGL2?s.DEPTH_COMPONENT32F:s.DEPTH_COMPONENT16;s.renderbufferStorage(s.RENDERBUFFER,_,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer)}s.bindRenderbuffer(s.RENDERBUFFER,null)}}if(e.isWebGL2&&t._samples>1){var h,c;this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const d=(h=(c=t._colorBuffers)==null?void 0:c.length)!=null?h:0;if(this.suppliedColorFramebuffer!==void 0){const u=s.createRenderbuffer();this._glMsaaColorBuffers.push(u);const f=e.backBufferFormat===oe?s.RGBA8:s.RGB8;s.bindRenderbuffer(s.RENDERBUFFER,u),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,f,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,u)}else for(let u=0;u<d;++u){const f=t.getColorBuffer(u);if(f){const p=s.createRenderbuffer();this._glMsaaColorBuffers.push(p),s.bindRenderbuffer(s.RENDERBUFFER,p),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,f.impl._glInternalFormat,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+u,s.RENDERBUFFER,p)}}t._depth&&(this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),t._stencil?(s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,s.DEPTH24_STENCIL8,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer)):(s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,s.DEPTH_COMPONENT32F,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer))),d>1&&(this._createMsaaMrtFramebuffers(e,t,d),e.setFramebuffer(this._glFrameBuffer),e.drawBuffers(i))}}_createMsaaMrtFramebuffers(e,t,s){const i=e.gl;this.colorMrtFramebuffers=[];for(let n=0;n<s;++n){const r=t.getColorBuffer(n),a=i.createFramebuffer();e.setFramebuffer(a);const l=this._glMsaaColorBuffers[n];i.bindRenderbuffer(i.RENDERBUFFER,l),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,r.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,l),e.drawBuffers([i.COLOR_ATTACHMENT0]);const h=i.createFramebuffer();e.setFramebuffer(h),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,r._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,r.impl._glTexture,0),this.colorMrtFramebuffers[n]=new qC(a,h)}}_checkFbo(e,t,s=""){const i=e.gl;switch(i.checkFramebufferStatus(i.FRAMEBUFFER)){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:break;case i.FRAMEBUFFER_UNSUPPORTED:break}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}internalResolve(e,t,s,i,n){e.setScissor(0,0,i.width,i.height);const r=e.gl;r.bindFramebuffer(r.READ_FRAMEBUFFER,t),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,s),r.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,n,r.NEAREST)}resolve(e,t,s,i){if(e.isWebGL2){const n=e.gl;if(this.colorMrtFramebuffers){if(s)for(let r=0;r<this.colorMrtFramebuffers.length;r++){const a=this.colorMrtFramebuffers[r];this.internalResolve(e,a.msaaFB,a.resolveFB,t,n.COLOR_BUFFER_BIT)}i&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,n.DEPTH_BUFFER_BIT)}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0));n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)}}}var Hv=`
#define pcFragColor0 gl_FragData[0]
#if COLOR_ATTACHMENT_1
#define pcFragColor1 gl_FragData[1]
#endif
#if COLOR_ATTACHMENT_2
#define pcFragColor2 gl_FragData[2]
#endif
#if COLOR_ATTACHMENT_3
#define pcFragColor3 gl_FragData[3]
#endif
#if COLOR_ATTACHMENT_4
#define pcFragColor4 gl_FragData[4]
#endif
#if COLOR_ATTACHMENT_5
#define pcFragColor5 gl_FragData[5]
#endif
#if COLOR_ATTACHMENT_6
#define pcFragColor6 gl_FragData[6]
#endif
#if COLOR_ATTACHMENT_7
#define pcFragColor7 gl_FragData[7]
#endif
#define texture2DBias texture2D
#define itexture2D texture2D
#define utexture2D texture2D
#define SHADOWMAP_PASS(name) name
#define SHADOWMAP_ACCEPT(name) sampler2D name
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#ifndef SUPPORTS_TEXLOD
	#define texture2DLodEXT texture2D
	#define texture2DProjLodEXT textureProj
	#define textureCubeLodEXT textureCube
	#define textureShadow texture2D
#else
	#define textureShadow(res, uv) texture2DGradEXT(res, uv, vec2(1, 1), vec2(1, 1))
#endif
#ifdef SUPPORTS_MRT
	#define gl_FragColor pcFragColor0
#endif
`,Xv=`
#ifndef outType_0
#define outType_0 vec4
#endif
layout(location = 0) out highp outType_0 pc_fragColor;
#ifndef REMOVE_COLOR_ATTACHMENT_1
#if COLOR_ATTACHMENT_1
layout(location = 1) out highp outType_1 pc_fragColor1;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_2
#if COLOR_ATTACHMENT_2
layout(location = 2) out highp outType_2 pc_fragColor2;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_3
#if COLOR_ATTACHMENT_3
layout(location = 3) out highp outType_3 pc_fragColor3;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_4
#if COLOR_ATTACHMENT_4
layout(location = 4) out highp outType_4 pc_fragColor4;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_5
#if COLOR_ATTACHMENT_5
layout(location = 5) out highp outType_5 pc_fragColor5;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_6
#if COLOR_ATTACHMENT_6
layout(location = 6) out highp outType_6 pc_fragColor6;
#endif
#endif
#ifndef REMOVE_COLOR_ATTACHMENT_7
#if COLOR_ATTACHMENT_7
layout(location = 7) out highp outType_7 pc_fragColor7;
#endif
#endif
#define gl_FragColor pc_fragColor
#define pcFragColor0 pc_fragColor
#define pcFragColor1 pc_fragColor1
#define pcFragColor2 pc_fragColor2
#define pcFragColor3 pc_fragColor3
#define pcFragColor4 pc_fragColor4
#define pcFragColor5 pc_fragColor5
#define pcFragColor6 pc_fragColor6
#define pcFragColor7 pc_fragColor7
#define varying in
#define texture2D texture
#define texture2DBias texture
#define textureCube texture
#define texture2DProj textureProj
#define texture2DLodEXT textureLod
#define texture2DProjLodEXT textureProjLod
#define textureCubeLodEXT textureLod
#define texture2DGradEXT textureGrad
#define texture2DProjGradEXT textureProjGrad
#define textureCubeGradEXT textureGrad
#define utexture2D texture
#define itexture2D texture
#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))
#define SHADOWMAP_PASS(name) name
#define SHADOWMAP_ACCEPT(name) sampler2DShadow name
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define GL2
#define SUPPORTS_TEXLOD
#define SUPPORTS_MRT
`,$v=`
#define attribute in
#define varying out
#define texture2D texture
#define utexture2D texture
#define itexture2D texture
#define GL2
#define VERTEXSHADER
`,qv=`
#extension GL_EXT_samplerless_texture_functions : require
#ifndef outType_0
#define outType_0 vec4
#endif
#ifndef outType_1
#define outType_1 vec4
#endif
#ifndef outType_2
#define outType_2 vec4
#endif
#ifndef outType_3
#define outType_3 vec4
#endif
#ifndef outType_4
#define outType_4 vec4
#endif
#ifndef outType_5
#define outType_5 vec4
#endif
#ifndef outType_6
#define outType_6 vec4
#endif
#ifndef outType_7
#define outType_7 vec4
#endif
layout(location = 0) out highp outType_0 pc_fragColor;
layout(location = 1) out highp outType_1 pc_fragColor1;
layout(location = 2) out highp outType_2 pc_fragColor2;
layout(location = 3) out highp outType_3 pc_fragColor3;
layout(location = 4) out highp outType_4 pc_fragColor4;
layout(location = 5) out highp outType_5 pc_fragColor5;
layout(location = 6) out highp outType_6 pc_fragColor6;
layout(location = 7) out highp outType_7 pc_fragColor7;
#define gl_FragColor pc_fragColor
#define pcFragColor0 pc_fragColor
#define pcFragColor1 pc_fragColor1
#define pcFragColor2 pc_fragColor2
#define pcFragColor3 pc_fragColor3
#define pcFragColor4 pc_fragColor4
#define pcFragColor5 pc_fragColor5
#define pcFragColor6 pc_fragColor6
#define pcFragColor7 pc_fragColor7
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)
#define texture2DLodEXT(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)
#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)
#define textureCubeLodEXT(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)
#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define SHADOWMAP_PASS(name) name, name ## _sampler
#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define GL2
#define WEBGPU
#define SUPPORTS_TEXLOD
#define SUPPORTS_MRT
`,jv=`
#extension GL_EXT_samplerless_texture_functions : require
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define GL2
#define WEBGPU
#define VERTEXSHADER
`,Yv=`
vec2 getGrabScreenPos(vec4 clipPos) {
	vec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
vec2 getImageEffectUV(vec2 uv) {
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
`;const YC={vertex_position:We,vertex_normal:Dt,vertex_tangent:ei,vertex_texCoord0:Lt,vertex_texCoord1:Ri,vertex_texCoord2:to,vertex_texCoord3:so,vertex_texCoord4:io,vertex_texCoord5:no,vertex_texCoord6:ro,vertex_texCoord7:ao,vertex_color:_t,vertex_boneIndices:Kt,vertex_boneWeights:ti};class je{static createDefinition(e,t){var s,i;const n=(u,f,p,_,m)=>{const g=e.isWebGPU?u:e.isWebGL2?f:je.gl1Extensions(e,m)+p;let x="";if(!_){var S;let b=(S=m.fragmentOutputTypes)!=null?S:"vec4";Array.isArray(b)||(b=[b]);for(let w=0;w<e.maxColorAttachments;w++){var v;x+=`#define COLOR_ATTACHMENT_${w}
`;const T=(v=b[w])!=null?v:"vec4";x+=`#define outType_${w} ${T}
`}}return x+g},r=(s=t.name)!=null?s:"Untitled",a=t.vertexDefines||n(jv,$v,"",!0,t),l=je.versionCode(e)+a+Yv+je.getShaderNameCode(r)+t.vertexCode,h=t.fragmentDefines||n(qv,Xv,Hv,!1,t),c=(t.fragmentPreamble||"")+je.versionCode(e)+h+je.precisionCode(e)+`
`+Yv+je.getShaderNameCode(r)+(t.fragmentCode||je.dummyFragmentCode()),d=(i=t.attributes)!=null?i:je.collectAttributes(t.vertexCode);return{name:r,attributes:d,vshader:l,fshader:c,useTransformFeedback:t.useTransformFeedback}}static getShaderNameCode(e){return`#define SHADER_NAME ${e}
`}static gl1Extensions(e,t,s){let i;return s?i=t.vertexExtensions?`${t.vertexExtensions}
`:"":(i=t.fragmentExtensions?`${t.fragmentExtensions}
`:"",e.extStandardDerivatives&&(i+=`#extension GL_OES_standard_derivatives : enable
`),e.extTextureLod&&(i+=`#extension GL_EXT_shader_texture_lod : enable
`,i+=`#define SUPPORTS_TEXLOD
`),e.extDrawBuffers&&(i+=`#extension GL_EXT_draw_buffers : require
`,i+=`#define SUPPORTS_MRT
`)),i}static dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(e){return e.isWebGPU?`#version 450
`:e.isWebGL2?`#version 300 es
`:""}static precisionCode(e,t){let s="";t&&t!=="highp"&&t!=="mediump"&&t!=="lowp"&&(t=null),t&&(t==="highp"&&e.maxPrecision!=="highp"&&(t="mediump"),t==="mediump"&&e.maxPrecision==="lowp"&&(t="lowp"));const i=t||e.precision;return e.isWebGPU?s=`precision ${i} float;
precision ${i} int;
`:(s=`precision ${i} float;
`,e.isWebGL2&&(s+=`precision ${i} sampler2DShadow;
`)),s}static collectAttributes(e){const t={};let s=0,i=e.indexOf("attribute");for(;i>=0&&!(i>0&&e[i-1]==="/");){const n=e.indexOf(";",i),r=e.lastIndexOf(" ",n),a=e.substring(r+1,n),l=YC[a];l!==void 0?t[a]=l:(t[a]="ATTR"+s,s++),i=e.indexOf("attribute",i+1)}return t}}class KC{constructor(){this.renderVersion=void 0,this.queries=[]}destroy(e){this.queries.forEach(t=>e.deleteQuery(t)),this.queries=null}}class ZC extends zv{constructor(e){super(),this.device=void 0,this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=e,this.ext=e.extDisjointTimerQuery}destroy(){this.freeQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.frameQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.previousFrameQueries.forEach(e=>e.destroy(this.device.gl)),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]}restoreContext(){this.ext=this.device.extDisjointTimerQuery}getQuery(){var e;return(e=this.freeQueries.pop())!=null?e:this.device.gl.createQuery()}start(e){if(this.ext){const t=this.getSlot(e),s=this.getQuery();return this.frameQueries[t]=s,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),t}}end(e){e!==void 0&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot)}request(){if(this._enabled){const e=this.ext,t=this.device.gl,s=this.device.renderVersion,i=this.frameQueries;if(i.length>0){this.frameQueries=[];const n=new KC;n.queries=i,n.renderVersion=s,this.previousFrameQueries.push(n)}if(this.previousFrameQueries.length>0){const n=this.previousFrameQueries[0],r=n.queries,a=r[r.length-1],l=t.getQueryParameter(a,t.QUERY_RESULT_AVAILABLE),h=t.getParameter(e.GPU_DISJOINT_EXT);if(l&&!h){this.previousFrameQueries.shift();const c=this.timings;c.length=0;for(let d=0;d<r.length;d++){const u=r[d],f=t.getQueryParameter(u,t.QUERY_RESULT);c[d]=f*1e-6,this.freeQueries.push(u)}this.report(n.renderVersion,c)}h&&(this.previousFrameQueries.forEach(c=>{this.report(c.renderVersion,null),c.destroy(t)}),this.previousFrameQueries.length=0)}super.request(s)}}}const Mo=[],Lp=`
attribute vec2 vertex_position;
varying vec2 vUv0;
void main(void)
{
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = vertex_position.xy*0.5+0.5;
}
`,QC=`
void main(void) { 
	gl_FragColor = vec4(2147483648.0);
}
`,JC=`
uniform sampler2D source;
vec4 packFloat(float depth) {
	const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);
	const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);
	vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);
	res -= res.xxyz * bit_mask;
	return res;
}
void main(void) {
	float c = texture2D(source, vec2(0.0)).r;
	float diff = abs(c - 2147483648.0) / 2147483648.0;
	gl_FragColor = packFloat(diff);
}
`,eM=`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`;function Fp(o,e,t){const s=o.renderTarget;o.setRenderTarget(e),o.updateBegin(),o.setCullMode(Je),o.setBlendState(Ee.NOBLEND),o.setDepthState(ft.NODEPTH),o.setStencilState(null,null),o.setVertexBuffer(o.quadVertexBuffer,0),o.setShader(t),o.draw({type:As,base:0,count:4,indexed:!1}),o.updateEnd(),o.setRenderTarget(s),o.updateBegin()}function Kv(o,e){let t=!0;const s=o.createTexture();o.bindTexture(o.TEXTURE_2D,s),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,2,2,0,o.RGBA,e,null);const i=o.createFramebuffer();return o.bindFramebuffer(o.FRAMEBUFFER,i),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,s,0),o.checkFramebufferStatus(o.FRAMEBUFFER)!==o.FRAMEBUFFER_COMPLETE&&(t=!1),o.bindTexture(o.TEXTURE_2D,null),o.deleteTexture(s),o.bindFramebuffer(o.FRAMEBUFFER,null),o.deleteFramebuffer(i),t}function tM(o,e){let t=!0;const s=o.createTexture();o.bindTexture(o.TEXTURE_2D,s),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);const i=new Uint16Array(4*2*2);return o.texImage2D(o.TEXTURE_2D,0,o.RGBA,2,2,0,o.RGBA,e,i),o.getError()!==o.NO_ERROR&&(t=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),o.bindTexture(o.TEXTURE_2D,null),o.deleteTexture(s),t}function sM(o){if(!o.textureFloatRenderable)return!1;const e=new Is(o,je.createDefinition(o,{name:"ptest1",vertexCode:Lp,fragmentCode:QC})),t=new Is(o,je.createDefinition(o,{name:"ptest2",vertexCode:Lp,fragmentCode:JC})),s={format:Ge,width:1,height:1,mipmaps:!1,minFilter:de,magFilter:de,name:"testFHP"},i=new re(o,s),n=new qe({colorBuffer:i,depth:!1});Fp(o,n,e),s.format=oe;const r=new re(o,s),a=new qe({colorBuffer:r,depth:!1});o.constantTexSource.setValue(i),Fp(o,a,t);const l=o.activeFramebuffer;o.setFramebuffer(a.impl._glFrameBuffer);const h=new Uint8Array(4);o.readPixels(0,0,1,1,h),o.setFramebuffer(l);const c=h[0]/255,d=h[1]/255,u=h[2]/255,f=h[3]/255,p=c/(256*256*256)+d/(256*256)+u/256+f;return i.destroy(),n.destroy(),r.destroy(),a.destroy(),e.destroy(),t.destroy(),p===0}class Op extends Ue{constructor(e,t={}){var s;super(e,t),this.gl=void 0,this._defaultFramebuffer=null,this._defaultFramebufferChanged=!1,t=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=!1,this._contextLostHandler=_=>{_.preventDefault(),this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored")};const i=typeof navigator<"u"&&navigator.userAgent;if(this.forceDisableMultisampling=i&&i.includes("AppleWebKit")&&(i.includes("15.4")||i.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=!1),ge.browserName==="firefox"&&ge.name==="windows"){const m=(typeof navigator<"u"?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),g=m?m[1]:null;if(g){const x=parseFloat(g);(x>=120||x===115)&&(t.antialias=!1)}}let n=null;if(this.backBufferAntialias=(s=t.antialias)!=null?s:!1,t.antialias=!1,t.gl)n=t.gl;else{const m=(t.preferWebGl2!==void 0?t.preferWebGl2:!0)?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];for(let g=0;g<m.length&&(n=e.getContext(m[g],t),!n);g++);}if(!n)throw new Error("WebGL not supported");this.gl=n,this.isWebGL2=typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext,this.isWebGL1=!this.isWebGL2,this._deviceType=this.isWebGL2?qr:xo,this.updateBackbufferFormat(null);const r=ge.browserName==="chrome",a=ge.browserName==="safari",l=ge.browser&&navigator.appVersion.indexOf("Mac")!==-1;this._tempEnableSafariTextureUnitWorkaround=a,this._tempMacChromeBlitFramebufferWorkaround=l&&r&&!t.alpha,e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!a&&typeof ImageBitmap<"u",this._samplerTypes=new Set([n.SAMPLER_2D,n.SAMPLER_CUBE,...this.isWebGL2?[n.UNSIGNED_INT_SAMPLER_2D,n.INT_SAMPLER_2D,n.SAMPLER_2D_SHADOW,n.SAMPLER_CUBE_SHADOW,n.SAMPLER_3D,n.INT_SAMPLER_3D,n.UNSIGNED_INT_SAMPLER_3D,n.SAMPLER_2D_ARRAY,n.INT_SAMPLER_2D_ARRAY,n.UNSIGNED_INT_SAMPLER_2D_ARRAY]:[]]),this.glAddress=[n.REPEAT,n.CLAMP_TO_EDGE,n.MIRRORED_REPEAT],this.glBlendEquation=[n.FUNC_ADD,n.FUNC_SUBTRACT,n.FUNC_REVERSE_SUBTRACT,this.isWebGL2?n.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:n.FUNC_ADD,this.isWebGL2?n.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:n.FUNC_ADD],this.glBlendFunctionColor=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_COLOR,n.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[n.NEVER,n.LESS,n.EQUAL,n.LEQUAL,n.GREATER,n.NOTEQUAL,n.GEQUAL,n.ALWAYS],this.glStencilOp=[n.KEEP,n.ZERO,n.REPLACE,n.INCR,n.INCR_WRAP,n.DECR,n.DECR_WRAP,n.INVERT],this.glClearFlag=[0,n.COLOR_BUFFER_BIT,n.DEPTH_BUFFER_BIT,n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT],this.glCull=[0,n.BACK,n.FRONT,n.FRONT_AND_BACK],this.glFilter=[n.NEAREST,n.LINEAR,n.NEAREST_MIPMAP_NEAREST,n.NEAREST_MIPMAP_LINEAR,n.LINEAR_MIPMAP_NEAREST,n.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[n.POINTS,n.LINES,n.LINE_LOOP,n.LINE_STRIP,n.TRIANGLES,n.TRIANGLE_STRIP,n.TRIANGLE_FAN],this.glType=[n.BYTE,n.UNSIGNED_BYTE,n.SHORT,n.UNSIGNED_SHORT,n.INT,n.UNSIGNED_INT,n.FLOAT,n.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[n.BOOL]=kr,this.pcUniformType[n.INT]=zn,this.pcUniformType[n.FLOAT]=Ps,this.pcUniformType[n.FLOAT_VEC2]=$i,this.pcUniformType[n.FLOAT_VEC3]=Qt,this.pcUniformType[n.FLOAT_VEC4]=Vn,this.pcUniformType[n.INT_VEC2]=Gn,this.pcUniformType[n.INT_VEC3]=Wn,this.pcUniformType[n.INT_VEC4]=Hn,this.pcUniformType[n.BOOL_VEC2]=_o,this.pcUniformType[n.BOOL_VEC3]=go,this.pcUniformType[n.BOOL_VEC4]=yo,this.pcUniformType[n.FLOAT_MAT2]=hh,this.pcUniformType[n.FLOAT_MAT3]=vo,this.pcUniformType[n.FLOAT_MAT4]=Ur,this.pcUniformType[n.SAMPLER_2D]=Ky,this.pcUniformType[n.SAMPLER_CUBE]=Zy,this.pcUniformType[n.UNSIGNED_INT]=zr,this.pcUniformType[n.UNSIGNED_INT_VEC2]=Vr,this.pcUniformType[n.UNSIGNED_INT_VEC3]=Gr,this.pcUniformType[n.UNSIGNED_INT_VEC4]=Wr,this.isWebGL2&&(this.pcUniformType[n.SAMPLER_2D_SHADOW]=Qy,this.pcUniformType[n.SAMPLER_CUBE_SHADOW]=Jy,this.pcUniformType[n.SAMPLER_2D_ARRAY]=tv,this.pcUniformType[n.SAMPLER_3D]=ev,this.pcUniformType[n.INT_SAMPLER_2D]=sv,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_2D]=iv,this.pcUniformType[n.INT_SAMPLER_CUBE]=nv,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_2D]=rv,this.pcUniformType[n.INT_SAMPLER_3D]=av,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_3D]=ov,this.pcUniformType[n.INT_SAMPLER_2D_ARRAY]=lv,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_2D_ARRAY]=hv),this.targetToSlot={},this.targetToSlot[n.TEXTURE_2D]=0,this.targetToSlot[n.TEXTURE_CUBE_MAP]=1,this.targetToSlot[n.TEXTURE_3D]=2;let h,c,d,u,f;this.commitFunction=[],this.commitFunction[kr]=function(_,m){_.value!==m&&(n.uniform1i(_.locationId,m),_.value=m)},this.commitFunction[zn]=this.commitFunction[kr],this.commitFunction[Ps]=function(_,m){_.value!==m&&(n.uniform1f(_.locationId,m),_.value=m)},this.commitFunction[$i]=function(_,m){f=_.value,h=m[0],c=m[1],(f[0]!==h||f[1]!==c)&&(n.uniform2fv(_.locationId,m),f[0]=h,f[1]=c)},this.commitFunction[Qt]=function(_,m){f=_.value,h=m[0],c=m[1],d=m[2],(f[0]!==h||f[1]!==c||f[2]!==d)&&(n.uniform3fv(_.locationId,m),f[0]=h,f[1]=c,f[2]=d)},this.commitFunction[Vn]=function(_,m){f=_.value,h=m[0],c=m[1],d=m[2],u=m[3],(f[0]!==h||f[1]!==c||f[2]!==d||f[3]!==u)&&(n.uniform4fv(_.locationId,m),f[0]=h,f[1]=c,f[2]=d,f[3]=u)},this.commitFunction[Gn]=function(_,m){f=_.value,h=m[0],c=m[1],(f[0]!==h||f[1]!==c)&&(n.uniform2iv(_.locationId,m),f[0]=h,f[1]=c)},this.commitFunction[_o]=this.commitFunction[Gn],this.commitFunction[Wn]=function(_,m){f=_.value,h=m[0],c=m[1],d=m[2],(f[0]!==h||f[1]!==c||f[2]!==d)&&(n.uniform3iv(_.locationId,m),f[0]=h,f[1]=c,f[2]=d)},this.commitFunction[go]=this.commitFunction[Wn],this.commitFunction[Hn]=function(_,m){f=_.value,h=m[0],c=m[1],d=m[2],u=m[3],(f[0]!==h||f[1]!==c||f[2]!==d||f[3]!==u)&&(n.uniform4iv(_.locationId,m),f[0]=h,f[1]=c,f[2]=d,f[3]=u)},this.commitFunction[yo]=this.commitFunction[Hn],this.commitFunction[hh]=function(_,m){n.uniformMatrix2fv(_.locationId,!1,m)},this.commitFunction[vo]=function(_,m){n.uniformMatrix3fv(_.locationId,!1,m)},this.commitFunction[Ur]=function(_,m){n.uniformMatrix4fv(_.locationId,!1,m)},this.commitFunction[ch]=function(_,m){n.uniform1fv(_.locationId,m)},this.commitFunction[dh]=function(_,m){n.uniform2fv(_.locationId,m)},this.commitFunction[uh]=function(_,m){n.uniform3fv(_.locationId,m)},this.commitFunction[gd]=function(_,m){n.uniform4fv(_.locationId,m)},this.commitFunction[zr]=function(_,m){_.value!==m&&(n.uniform1ui(_.locationId,m),_.value=m)},this.commitFunction[Vr]=function(_,m){f=_.value,h=m[0],c=m[1],(f[0]!==h||f[1]!==c)&&(n.uniform2uiv(_.locationId,m),f[0]=h,f[1]=c)},this.commitFunction[Gr]=function(_,m){f=_.value,h=m[0],c=m[1],d=m[2],(f[0]!==h||f[1]!==c||f[2]!==d)&&(n.uniform3uiv(_.locationId,m),f[0]=h,f[1]=c,f[2]=d)},this.commitFunction[Wr]=function(_,m){f=_.value,h=m[0],c=m[1],d=m[2],u=m[3],(f[0]!==h||f[1]!==c||f[2]!==d||f[3]!==u)&&(n.uniform4uiv(_.locationId,m),f[0]=h,f[1]=c,f[2]=d,f[3]=u)},this.commitFunction[Hr]=function(_,m){n.uniform1iv(_.locationId,m)},this.commitFunction[fh]=function(_,m){n.uniform1uiv(_.locationId,m)},this.commitFunction[ph]=this.commitFunction[Hr],this.commitFunction[Xr]=function(_,m){n.uniform2iv(_.locationId,m)},this.commitFunction[mh]=function(_,m){n.uniform2uiv(_.locationId,m)},this.commitFunction[_h]=this.commitFunction[Xr],this.commitFunction[$r]=function(_,m){n.uniform3iv(_.locationId,m)},this.commitFunction[gh]=function(_,m){n.uniform3uiv(_.locationId,m)},this.commitFunction[yh]=this.commitFunction[$r],this.commitFunction[vh]=function(_,m){n.uniform4iv(_.locationId,m)},this.commitFunction[yd]=function(_,m){n.uniform4uiv(_.locationId,m)},this.commitFunction[vd]=this.commitFunction[vh],this.commitFunction[Sp]=function(_,m){n.uniformMatrix4fv(_.locationId,!1,m)},this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let p=this.vertexUniformsCount;p-=4*4,p-=8,p-=1,p-=4*4,this.boneLimit=Math.floor(p/3),this.boneLimit=Math.min(this.boneLimit,128),this.unmaskedRenderer==="Mali-450 MP"&&(this.boneLimit=34),this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.isWebGL2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=Kv(n,n.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.isWebGL2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=Kv(n,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore=this.maxPrecision==="highp"&&this.maxVertexTextures>=2,this.supportsDepthShadow=this.isWebGL2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.areaLightLutFormat=oe,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=et:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=Ge),this.postInit()}postInit(){super.postInit(),this.gpuProfiler=new ZC(this)}destroy(){super.destroy();const e=this.gl;this.isWebGL2&&this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createBackbuffer(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new qe({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e}updateBackbufferFormat(e){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);const s=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=s?oe:Es}updateBackbuffer(){const e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))}createVertexBufferImpl(e,t){return new UC}createIndexBufferImpl(e){return new zC(e)}createShaderImpl(e){return new XC(e)}createTextureImpl(e){return new $C}createRenderTargetImpl(e){return new jC}getPrecision(){const e=this.gl;let t="highp";if(e.getShaderPrecisionFormat){const s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),r=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(s&&i&&n&&r){const a=s.precision>0&&n.precision>0,l=i.precision>0&&r.precision>0;a||(l?t="mediump":t="lowp")}}return t}getExtension(){for(let e=0;e<arguments.length;e++)if(this.supportedExtensions.indexOf(arguments[e])!==-1)return this.gl.getExtension(arguments[e]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||this.isWebGL2&&(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){var e;const t=this.gl;if(this.supportedExtensions=(e=t.getSupportedExtensions())!=null?e:[],this._extDisjointTimerQuery=null,this.isWebGL2)this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.drawBuffers=t.drawBuffers.bind(t),this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.textureHalfFloatFilterable=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.extDepthTexture=!0,this.textureRG11B10Renderable=!0;else{var s;if(this.extBlendMinmax=this.getExtension("EXT_blend_minmax"),this.extDrawBuffers=this.getExtension("WEBGL_draw_buffers"),this.extInstancing=this.getExtension("ANGLE_instanced_arrays"),this.drawBuffers=(s=this.extDrawBuffers)==null?void 0:s.drawBuffersWEBGL.bind(this.extDrawBuffers),this.extInstancing){const i=this.extInstancing;t.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),t.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),t.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)}if(this.extStandardDerivatives=this.getExtension("OES_standard_derivatives"),this.extTextureFloat=this.getExtension("OES_texture_float"),this.extTextureLod=this.getExtension("EXT_shader_texture_lod"),this.extUintElement=this.getExtension("OES_element_index_uint"),this.extVertexArrayObject=this.getExtension("OES_vertex_array_object"),this.extVertexArrayObject){const i=this.extVertexArrayObject;t.createVertexArray=i.createVertexArrayOES.bind(i),t.deleteVertexArray=i.deleteVertexArrayOES.bind(i),t.isVertexArray=i.isVertexArrayOES.bind(i),t.bindVertexArray=i.bindVertexArrayOES.bind(i)}this.extColorBufferFloat=null,this.extDepthTexture=t.getExtension("WEBGL_depth_texture"),this.extTextureHalfFloat=this.getExtension("OES_texture_half_float"),this.extTextureHalfFloatLinear=this.getExtension("OES_texture_half_float_linear"),this.textureHalfFloatFilterable=!!this.extTextureHalfFloatLinear}this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float")}initializeCapabilities(){var e,t;const s=this.gl;let i;const n=typeof navigator<"u"?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const r=s.getContextAttributes();this.supportsMsaa=(e=r==null?void 0:r.antialias)!=null?e:!1,this.supportsStencil=(t=r==null?void 0:r.stencil)!=null?t:!1,this.supportsInstancing=!!this.extInstancing,this.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE),this.maxCubeMapSize=s.getParameter(s.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=s.getParameter(s.MAX_RENDERBUFFER_SIZE),this.maxTextures=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=s.getParameter(s.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=s.getParameter(s.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=s.getParameter(s.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=s.getParameter(s.MAX_FRAGMENT_UNIFORM_VECTORS),this.isWebGL2?(this.maxDrawBuffers=s.getParameter(s.MAX_DRAW_BUFFERS),this.maxColorAttachments=s.getParameter(s.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=s.getParameter(s.MAX_3D_TEXTURE_SIZE),this.supportsMrt=!0,this.supportsVolumeTextures=!0):(i=this.extDrawBuffers,this.supportsMrt=!!i,this.maxDrawBuffers=i?s.getParameter(i.MAX_DRAW_BUFFERS_WEBGL):1,this.maxColorAttachments=i?s.getParameter(i.MAX_COLOR_ATTACHMENTS_WEBGL):1,this.maxVolumeSize=1),i=this.extDebugRendererInfo,this.unmaskedRenderer=i?s.getParameter(i.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=i?s.getParameter(i.UNMASKED_VENDOR_WEBGL):"";const a=/\bMali-G52+/,l=/SM-[a-zA-Z0-9]+/;this.supportsGpuParticles=!(this.unmaskedVendor==="ARM"&&n.match(l))&&!this.unmaskedRenderer.match(a),i=this.extTextureFilterAnisotropic,this.maxAnisotropy=i?s.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;const h=this.isWebGL2&&!this.forceDisableMultisampling;this.maxSamples=h?s.getParameter(s.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=h&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=this.isWebGL2||!ge.android,this.supportsTextureFetch=this.isWebGL2,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){super.initializeRenderState();const e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),this.cullFace=e.BACK,e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=Ci,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=Fr,this.stencilZfailFront=this.stencilZfailBack=Fr,this.stencilZpassFront=this.stencilZpassBack=Fr,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.isWebGL2&&(e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new H(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),this.isWebGL2?e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST):this.extStandardDerivatives&&e.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}initTextureUnits(e=16){this.textureUnits=[];for(let t=0;t<e;t++)this.textureUnits.push([null,null,null])}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)}loseContext(){var e;this.contextLost=!0,this.backBufferSize.set(-1,-1);for(const t of this.shaders)t.loseContext();for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext();(e=this.gpuProfiler)==null||e.loseContext()}restoreContext(){var e;this.contextLost=!1,this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const t of this.shaders)t.restoreContext();for(const t of this.buffers)t.unlock();(e=this.gpuProfiler)==null||e.restoreContext()}setViewport(e,t,s,i){(this.vx!==e||this.vy!==t||this.vw!==s||this.vh!==i)&&(this.gl.viewport(e,t,s,i),this.vx=e,this.vy=t,this.vw=s,this.vh=i)}setScissor(e,t,s,i){(this.sx!==e||this.sy!==t||this.sw!==s||this.sh!==i)&&(this.gl.scissor(e,t,s,i),this.sx=e,this.sy=t,this.sw=s,this.sh=i)}setFramebuffer(e){if(this.activeFramebuffer!==e){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e}}copyRenderTarget(e,t,s,i){const n=this.gl;if(e===this.backBuffer&&(e=null),!this.isWebGL2&&i)return!1;if(s){if(t){if(e&&(!e._colorBuffer||!t._colorBuffer||e._colorBuffer._format!==t._colorBuffer._format))return!1}else if(!e._colorBuffer)return!1}if(i&&e&&!e._depth&&(!e._depthBuffer||!t._depthBuffer||e._depthBuffer._format!==t._depthBuffer._format))return!1;if(this.isWebGL2&&t){var r;const a=this.renderTarget;this.renderTarget=t,this.updateBegin();const l=e?e.impl._glFrameBuffer:(r=this.backBuffer)==null?void 0:r.impl._glFrameBuffer,h=t.impl._glFrameBuffer;n.bindFramebuffer(n.READ_FRAMEBUFFER,l),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,h);const c=e?e.width:t.width,d=e?e.height:t.height;n.blitFramebuffer(0,0,c,d,0,0,c,d,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=a,n.bindFramebuffer(n.FRAMEBUFFER,a?a.impl._glFrameBuffer:null)}else{const a=this.getCopyShader();this.constantTexSource.setValue(e._colorBuffer),Fp(this,t,a)}return!0}getCopyShader(){return this._copyShader||(this._copyShader=new Is(this,je.createDefinition(this,{name:"outputTex2D",vertexCode:Lp,fragmentCode:eM}))),this._copyShader}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart()}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()}startRenderPass(e){var t;const s=(t=e.renderTarget)!=null?t:this.backBuffer;this.renderTarget=s,this.updateBegin();const{width:i,height:n}=s;this.setViewport(0,0,i,n),this.setScissor(0,0,i,n);const r=e.colorOps,a=e.depthStencilOps;if(r!=null&&r.clear||a.clearDepth||a.clearStencil){let l=0;const h={};r!=null&&r.clear&&(l|=xr,h.color=[r.clearValue.r,r.clearValue.g,r.clearValue.b,r.clearValue.a]),a.clearDepth&&(l|=Sr,h.depth=a.clearDepthValue),a.clearStencil&&(l|=Xa,h.stencil=a.clearStencilValue),h.flags=l,this.clear(h)}this.insideRenderPass=!0}endRenderPass(e){this.unbindVertexArray();const t=this.renderTarget,s=e.colorArrayOps.length;if(t){var i;if(this.isWebGL2){Mo.length=0;const n=this.gl;for(let r=0;r<s;r++){const a=e.colorArrayOps[r];a.store||a.resolve||Mo.push(n.COLOR_ATTACHMENT0+r)}t!==this.backBuffer&&(e.depthStencilOps.storeDepth||Mo.push(n.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||Mo.push(n.STENCIL_ATTACHMENT)),Mo.length>0&&e.fullSizeClearRect&&n.invalidateFramebuffer(n.DRAW_FRAMEBUFFER,Mo)}(i=e.colorOps)!=null&&i.resolve&&this.isWebGL2&&e.samples>1&&t.autoResolve&&t.resolve(!0,!1);for(let n=0;n<s;n++)if(e.colorArrayOps[n].mipmaps){const a=t._colorBuffers[n];a&&a.impl._glTexture&&a.mipmaps&&(a.pot||this.isWebGL2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(a),this.gl.generateMipmap(a.impl._glTarget))}}this.insideRenderPass=!1}set defaultFramebuffer(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=!0)}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){var e;if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let i=0;i<this.textureUnits.length;++i)for(let n=0;n<3;++n)this.textureUnits[i][n]=null;const t=(e=this.renderTarget)!=null?e:this.backBuffer,s=t.impl;s.initialized||this.initRenderTarget(t),this.setFramebuffer(s._glFrameBuffer)}updateEnd(){this.unbindVertexArray();const e=this.renderTarget;if(e&&e!==this.backBuffer){this.isWebGL2&&e._samples>1&&e.autoResolve&&e.resolve();const t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(t.pot||this.isWebGL2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;const t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)}bindTexture(e){const t=e.impl,s=t._glTarget,i=t._glTexture,n=this.textureUnit,r=this.targetToSlot[s];this.textureUnits[n][r]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][r]=i)}bindTextureOnUnit(e,t){const s=e.impl,i=s._glTarget,n=s._glTexture,r=this.targetToSlot[i];this.textureUnits[t][r]!==n&&(this.activeTexture(t),this.gl.bindTexture(i,n),this.textureUnits[t][r]=n)}setTextureParameters(e){const t=this.gl,s=e.impl.dirtyParameterFlags,i=e.impl._glTarget;if(s&1){let n=e._minFilter;(!e.pot&&!this.isWebGL2||!e._mipmaps||e._compressed&&e._levels.length===1)&&(n===Tr||n===wr?n=de:(n===Er||n===Qs)&&(n=Oe)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,this.glFilter[n])}if(s&2&&t.texParameteri(i,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),s&4&&(this.isWebGL2?t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]):t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e.pot?e._addressU:q])),s&8&&(this.isWebGL2?t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]):t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e.pot?e._addressV:q])),s&16&&this.isWebGL2&&t.texParameteri(i,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),s&32&&this.isWebGL2&&t.texParameteri(i,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),s&64&&this.isWebGL2&&t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),s&128){const n=this.extTextureFilterAnisotropic;n&&t.texParameterf(i,n.TEXTURE_MAX_ANISOTROPY_EXT,U.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy))}}setTexture(e,t){const s=e.impl;s._glTexture||s.initialize(this,e),s.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),s.dirtyParameterFlags&&(this.setTextureParameters(e),s.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(s.upload(this,e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)}createVertexArray(e){let t,s;const i=e.length>1;if(i){t="";for(let n=0;n<e.length;n++){const r=e[n];t+=r.id+r.format.renderingHash}s=this._vaoMap.get(t)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let r=0;r<e.length;r++){const a=e[r];n.bindBuffer(n.ARRAY_BUFFER,a.impl.bufferId);const l=a.format.elements;for(let h=0;h<l.length;h++){const c=l[h],d=Se[c.name];c.asInt?n.vertexAttribIPointer(d,c.numComponents,this.glType[c.dataType],c.stride,c.offset):n.vertexAttribPointer(d,c.numComponents,this.glType[c.dataType],c.normalize,c.stride,c.offset),n.enableVertexAttribArray(d),a.format.instancing&&n.vertexAttribDivisor(d,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(t,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){const e=this.gl;let t;if(this.vertexBuffers.length===1){const i=this.vertexBuffers[0];i.impl.vao||(i.impl.vao=this.createVertexArray(this.vertexBuffers)),t=i.impl.vao}else t=this.createVertexArray(this.vertexBuffers);this.boundVao!==t&&(this.boundVao=t,e.bindVertexArray(t)),this.vertexBuffers.length=0;const s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s)}draw(e,t,s){const i=this.gl;if(this.activateShader(this),!this.shaderValid)return;let n,r,a,l,h,c,d,u;const f=this.shader;if(!f)return;const p=f.impl.samplers,_=f.impl.uniforms;s||this.setBuffers();let m=0;for(let S=0,v=p.length;S<v;S++){if(n=p[S],r=n.scopeId.value,!r)return;if(r instanceof re)a=r,this.setTexture(a,m),n.slot!==m&&(i.uniform1i(n.locationId,m),n.slot=m),m++;else{n.array.length=0,l=r.length;for(let b=0;b<l;b++)a=r[b],this.setTexture(a,m),n.array[b]=m,m++;i.uniform1iv(n.locationId,n.array)}}for(let S=0,v=_.length;S<v;S++)h=_[S],c=h.scopeId,d=h.version,u=c.versionObject.version,(d.globalId!==u.globalId||d.revision!==u.revision)&&(d.globalId=u.globalId,d.revision=u.revision,c.value!==null&&this.commitFunction[h.dataType](h,c.value));this.isWebGL2&&this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));const g=this.glPrimitive[e.type],x=e.count;if(e.indexed){const S=this.indexBuffer,v=S.impl.glFormat,b=e.base*S.bytesPerIndex;t>0?i.drawElementsInstanced(g,x,v,b,t):i.drawElements(g,x,v,b)}else{const S=e.base;t>0?i.drawArraysInstanced(g,S,x,t):i.drawArrays(g,S,x)}this.isWebGL2&&this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(e){var t;const s=this.defaultClearOptions;e=e||s;const i=(t=e.flags)!=null?t:s.flags;if(i!==0){const l=this.gl;if(i&xr){var n;const h=(n=e.color)!=null?n:s.color,c=h[0],d=h[1],u=h[2],f=h[3],p=this.clearColor;(c!==p.r||d!==p.g||u!==p.b||f!==p.a)&&(this.gl.clearColor(c,d,u,f),this.clearColor.set(c,d,u,f)),this.setBlendState(Ee.NOBLEND)}if(i&Sr){var r;const h=(r=e.depth)!=null?r:s.depth;h!==this.clearDepth&&(this.gl.clearDepth(h),this.clearDepth=h),this.setDepthState(ft.WRITEDEPTH)}if(i&Xa){var a;const h=(a=e.stencil)!=null?a:s.stencil;h!==this.clearStencil&&(this.gl.clearStencil(h),this.clearStencil=h)}l.clear(this.glClearFlag[i])}}submit(){this.gl.flush()}readPixels(e,t,s,i,n){const r=this.gl;r.readPixels(e,t,s,i,r.RGBA,r.UNSIGNED_BYTE,n)}async readPixelsAsync(e,t,s,i,n){var r,a,l;const h=this.gl;if(!this.isWebGL2){this.readPixels(e,t,s,i,n);return}const c=(_,m)=>{const g=h.fenceSync(h.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise((x,S)=>{function v(){const b=h.clientWaitSync(g,_,0);b===h.WAIT_FAILED?(h.deleteSync(g),S(new Error("webgl clientWaitSync sync failed"))):b===h.TIMEOUT_EXPIRED?setTimeout(v,m):(h.deleteSync(g),x())}v()})},d=(r=this.renderTarget.colorBuffer)==null?void 0:r.impl,u=(a=d==null?void 0:d._glFormat)!=null?a:h.RGBA,f=(l=d==null?void 0:d._glPixelType)!=null?l:h.UNSIGNED_BYTE,p=h.createBuffer();h.bindBuffer(h.PIXEL_PACK_BUFFER,p),h.bufferData(h.PIXEL_PACK_BUFFER,n.byteLength,h.STREAM_READ),h.readPixels(e,t,s,i,u,f,0),h.bindBuffer(h.PIXEL_PACK_BUFFER,null),await c(0,20),h.bindBuffer(h.PIXEL_PACK_BUFFER,p),h.getBufferSubData(h.PIXEL_PACK_BUFFER,0,n),h.bindBuffer(h.PIXEL_PACK_BUFFER,null),h.deleteBuffer(p)}setAlphaToCoverage(e){this.isWebGL1||this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e&&(this.transformFeedbackBuffer=e,this.isWebGL2)){const t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}}setRaster(e){this.raster!==e&&(this.raster=e,this.isWebGL2&&(e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setStencilTest(e){if(this.stencil!==e){const t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}}setStencilFunc(e,t,s){(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s||this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s)&&(this.gl.stencilFunc(this.glComparison[e],t,s),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(e,t,s){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[e],t,s),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=s}}setStencilFuncBack(e,t,s){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[e],t,s),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=s}}setStencilOperation(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s||this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=s),(this.stencilWriteMaskFront!==i||this.stencilWriteMaskBack!==i)&&(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s)&&(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(e,t,s,i){(this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendState(e){const t=this.blendState;if(!t.equals(e)){const s=this.gl,{blend:i,colorOp:n,alphaOp:r,colorSrcFactor:a,colorDstFactor:l,alphaSrcFactor:h,alphaDstFactor:c}=e;if(t.blend!==i&&(i?s.enable(s.BLEND):s.disable(s.BLEND)),t.colorOp!==n||t.alphaOp!==r){const d=this.glBlendEquation;s.blendEquationSeparate(d[n],d[r])}(t.colorSrcFactor!==a||t.colorDstFactor!==l||t.alphaSrcFactor!==h||t.alphaDstFactor!==c)&&s.blendFuncSeparate(this.glBlendFunctionColor[a],this.glBlendFunctionColor[l],this.glBlendFunctionAlpha[h],this.glBlendFunctionAlpha[c]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e)}}setBlendColor(e,t,s,i){const n=this.blendColor;(e!==n.r||t!==n.g||s!==n.b||i!==n.a)&&(this.gl.blendColor(e,t,s,i),n.set(e,t,s,i))}setStencilState(e,t){if(e||t)if(this.setStencilTest(!0),e===t)this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask);else{var s,i;(s=e)!=null||(e=cs.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),(i=t)!=null||(t=cs.DEFAULT),this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask)}else this.setStencilTest(!1)}setDepthState(e){const t=this.depthState;if(!t.equals(e)){const s=this.gl,i=e.write;t.write!==i&&s.depthMask(i);let{func:n,test:r}=e;!r&&i&&(r=!0,n=Ci),t.func!==n&&s.depthFunc(this.glComparison[n]),t.test!==r&&(r?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST));const{depthBias:a,depthBiasSlope:l}=e;a||l?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),s.polygonOffset(l,a)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e)}}setCullMode(e){if(this.cullMode!==e){if(e===Je)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===Je&&this.gl.enable(this.gl.CULL_FACE);const t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}}setShader(e,t=!1){e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0)}activateShader(e){const{shader:t}=this,{impl:s}=t;this.shaderValid===void 0&&(t.failed?this.shaderValid=!1:t.ready||(this.shaderAsyncCompile?s.isLinked(e)?s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1):this.shaderValid=!1:s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1))),this.shaderValid===void 0&&(this.gl.useProgram(s.glProgram),this.shaderValid=!0)}clearVertexArrayObjectCache(){const e=this.gl;this._vaoMap.forEach((t,s,i)=>{e.deleteVertexArray(t)}),this._vaoMap.clear()}set fullscreen(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}get textureFloatHighPrecision(){return this._textureFloatHighPrecision===void 0&&(this._textureFloatHighPrecision=sM(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return this._textureHalfFloatUpdatable===void 0&&(this.isWebGL2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=tM(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}class iM{unlock(e){}}class nM{destroy(e){}init(e,t){}loseContext(){}resolve(e,t,s,i){}}class rM{destroy(e){}loseContext(){}restoreContext(e,t){}}class aM{destroy(e){}propertyChanged(e){}loseContext(){}}class oM{destroy(e){}unlock(e){}}class Zv extends Ue{constructor(e,t={}){super(e,t),t=this.initOptions,this.isNull=!0,this._deviceType=xh,this.samples=1}destroy(){super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsInstancing=!0,this.supportsUniformBuffers=!1,this.supportsVolumeTextures=!0,this.supportsBoneTextures=!0,this.supportsMorphTargetTexturesCore=!0,this.supportsAreaLights=!0,this.supportsDepthShadow=!0,this.supportsGpuParticles=!1,this.supportsMrt=!0,this.extUintElement=!0,this.extTextureFloat=!0,this.textureFloatRenderable=!0,this.extTextureHalfFloat=!0,this.textureHalfFloatRenderable=!0,this.textureHalfFloatUpdatable=!0,this.boneLimit=1024,this.supportsImageBitmap=!0,this.extStandardDerivatives=!0,this.extBlendMinmax=!0,this.areaLightLutFormat=oe,this.supportsTextureFetch=!0}postInit(){super.postInit()}frameStart(){super.frameStart()}frameEnd(){super.frameEnd()}updateBegin(){}updateEnd(){}readPixels(e,t,s,i,n){}createVertexBufferImpl(e,t){return new oM(e,t)}createIndexBufferImpl(e){return new iM(e)}createShaderImpl(e){return new rM(e)}createTextureImpl(e){return new aM(e)}createRenderTargetImpl(e){return new nM(e)}draw(e,t=1,s){}setShader(e,t=!1){}setBlendState(e){}setDepthState(e){}setStencilState(e,t){}setBlendColor(e,t,s,i){}setCullMode(e){}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}clear(e){}setViewport(e,t,s,i){}setScissor(e,t,s,i){}copyRenderTarget(e,t,s,i){return!0}}function lM(o,e={}){var t;const s=(t=e.deviceTypes)!=null?t:[];if(s.includes(qr)||s.push(qr),s.includes(xo)||s.push(xo),s.includes(xh)||s.push(xh),ge.browser&&navigator.xr){var i;(i=e.xrCompatible)!=null||(e.xrCompatible=!0)}const n=[];for(let a=0;a<s.length;a++){var r;const l=s[a];l===Tp&&(r=window)!=null&&(r=r.navigator)!=null&&r.gpu&&n.push(()=>new Vv(o,e).initWebGpu(e.glslangUrl,e.twgslUrl)),(l===xo||l===qr)&&n.push(()=>(e.preferWebGl2=l===qr,new Op(o,e))),l===xh&&n.push(()=>new Zv(o,e))}return new Promise((a,l)=>{let h=0;const c=()=>{h>=n.length?l(new Error("Failed to create a graphics device")):Promise.resolve(n[h++]()).then(d=>{d?a(d):c()}).catch(d=>{console.log(d),c()})};c()})}class hM{constructor(e,t){this.shader=null,this.device=e,this.shader=t,e.supportsCompute&&(this.impl=e.createComputeImpl(this))}dispatch(e,t,s){var i;(i=this.impl)==null||i.dispatch(e,t,s)}}let cM=0;class Di{constructor(e,t,s,i=St,n){this.device=e,this.format=t,this.numIndices=s,this.usage=i,this.id=cM++,this.impl=e.createIndexBufferImpl(this);const r=uv[t];this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.ib+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength!==this.numBytes?!1:(this.storage=e,this.unlock(),!0)}_lockTypedArray(){const e=this.lock();return this.format===Mi?new Uint32Array(e):this.format===Yt?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){const s=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),s.set(e);else for(let i=0;i<t;i++)s[i]=e[i];else s.set(e);this.unlock()}readData(e){const t=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else{e.length=0;for(let i=0;i<s;i++)e[i]=t[i]}return s}}class dM{constructor(){this.clearValue=new H(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.mipmaps=!1}}class uM{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.storeStencil=!1}}class Ot{get colorOps(){return this.colorArrayOps[0]}constructor(e){this._name=void 0,this.device=void 0,this._enabled=!0,this.executeEnabled=!0,this.renderTarget=void 0,this._options=void 0,this.samples=0,this.colorArrayOps=[],this.depthStencilOps=void 0,this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=e}set name(e){this._name=e}get name(){return this._name||(this._name=this.constructor.name),this._name}set options(e){if(this._options=e,e){var t,s;this._options.scaleX=(t=this._options.scaleX)!=null?t:1,this._options.scaleY=(s=this._options.scaleY)!=null?s:1}}get options(){return this._options}init(e=null,t=null){var s;this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.depthStencilOps=new uM;const i=e?(s=e._colorBuffers)==null?void 0:s.length:1;this.colorArrayOps.length=0;for(let r=0;r<i;r++){var n;const a=new dM;this.colorArrayOps[r]=a,this.samples===1&&(a.store=!0,a.resolve=!1),(n=this.renderTarget)!=null&&(n=n._colorBuffers)!=null&&n[r].mipmaps&&(a.mipmaps=!0)}this.postInit()}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){var e;const t=(e=this._options.resizeSource)!=null?e:this.device.backBuffer,s=Math.floor(t.width*this._options.scaleX),i=Math.floor(t.height*this._options.scaleY);this.renderTarget.resize(s,i)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(e){const t=this.colorArrayOps.length;for(let s=0;s<t;s++){const i=this.colorArrayOps[s];e&&i.clearValue.copy(e),i.clear=!!e}}setClearDepth(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=e!==void 0}setClearStencil(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=e!==void 0}render(){if(this.enabled){const e=this.device,t=this.renderTarget!==void 0;this.before(),this.executeEnabled&&(t&&e.startRenderPass(this),this.execute(),t&&e.endRenderPass(this)),this.after(),e.renderPassIndex++}}}class Zi{constructor(e,t,s){this.uniformFormats=[],this.bindGroupFormats=[],this.vertexFormat=void 0,this.uniformFormats[xd]=e,this.bindGroupFormats[xd]=t,this.vertexFormat=s}hasUniform(e){for(let t=0;t<this.uniformFormats.length;t++){const s=this.uniformFormats[t];if(s!=null&&s.get(e))return!0}return!1}hasTexture(e){for(let t=0;t<this.bindGroupFormats.length;t++){const s=this.bindGroupFormats[t];if(s!=null&&s.getTexture(e))return!0}return!1}getVertexElement(e){var t;return(t=this.vertexFormat)==null?void 0:t.elements.find(s=>s.name===e)}generateKey(e){let t=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);if(e.isWebGPU){var s;t+=(s=this.vertexFormat)==null?void 0:s.shaderProcessingHashString}return t}}class fM{constructor(e,t=qc){this.device=e.device;const s=this.device.gl;this._inputBuffer=e,t===qc&&e.usage!==t&&(s.bindBuffer(s.ARRAY_BUFFER,e.impl.bufferId),s.bufferData(s.ARRAY_BUFFER,e.storage,s.DYNAMIC_COPY)),this._outputBuffer=new es(e.device,e.format,e.numVertices,t,e.storage)}static createShader(e,t,s){return new Is(e,je.createDefinition(e,{name:s,vertexCode:t,useTransformFeedback:!0}))}destroy(){this._outputBuffer.destroy()}process(e,t=!0){const s=this.device,i=s.getRenderTarget();if(s.setRenderTarget(null),s.updateBegin(),s.setVertexBuffer(this._inputBuffer,0),s.setRaster(!1),s.setTransformFeedbackBuffer(this._outputBuffer),s.setShader(e),s.draw({type:Lr,base:0,count:this._inputBuffer.numVertices,indexed:!1}),s.setTransformFeedbackBuffer(null),s.setRaster(!0),s.updateEnd(),s.setRenderTarget(i),t){let n=this._inputBuffer.impl.bufferId;this._inputBuffer.impl.bufferId=this._outputBuffer.impl.bufferId,this._outputBuffer.impl.bufferId=n,n=this._inputBuffer.impl.vao,this._inputBuffer.impl.vao=this._outputBuffer.impl.vao,this._outputBuffer.impl.vao=n}}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}}function pM(o){this.array[this.index]=o}function mM(o,e){this.array[this.index]=o,this.array[this.index+1]=e}function _M(o,e,t){this.array[this.index]=o,this.array[this.index+1]=e,this.array[this.index+2]=t}function gM(o,e,t,s){this.array[this.index]=o,this.array[this.index+1]=e,this.array[this.index+2]=t,this.array[this.index+3]=s}function yM(o,e,t){this.array[o]=e[t]}function vM(o,e,t){this.array[o]=e[t],this.array[o+1]=e[t+1]}function xM(o,e,t){this.array[o]=e[t],this.array[o+1]=e[t+1],this.array[o+2]=e[t+2]}function SM(o,e,t){this.array[o]=e[t],this.array[o+1]=e[t+1],this.array[o+2]=e[t+2],this.array[o+3]=e[t+3]}function bM(o,e,t){e[t]=this.array[o]}function TM(o,e,t){e[t]=this.array[o],e[t+1]=this.array[o+1]}function wM(o,e,t){e[t]=this.array[o],e[t+1]=this.array[o+1],e[t+2]=this.array[o+2]}function EM(o,e,t){e[t]=this.array[o],e[t+1]=this.array[o+1],e[t+2]=this.array[o+2],e[t+3]=this.array[o+3]}class AM{constructor(e,t,s){switch(this.index=0,this.numComponents=t.numComponents,s.interleaved?this.array=new Yr[t.dataType](e,t.offset):this.array=new Yr[t.dataType](e,t.offset,s.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=pM,this.getToArray=bM,this.setFromArray=yM;break;case 2:this.set=mM,this.getToArray=TM,this.setFromArray=vM;break;case 3:this.set=_M,this.getToArray=wM,this.setFromArray=xM;break;case 4:this.set=gM,this.getToArray=EM,this.setFromArray=SM;break}}get(e){return this.array[this.index+e]}set(e,t,s,i){}getToArray(e,t,s){}setFromArray(e,t,s){}}class Kr{constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const t=this.vertexBuffer.getFormat();for(let s=0;s<t.elements.length;s++){const i=t.elements[s];this.accessors[s]=new AM(this.buffer,i,t),this.element[i.name]=this.accessors[s]}}next(e=1){let t=0;const s=this.accessors,i=this.accessors.length;for(;t<i;){const n=s[t++];n.index+=e*n.stride}}end(){this.vertexBuffer.unlock()}writeData(e,t,s){const i=this.element[e];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const n=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let r=0;for(let a=0;a<s;a++)i.setFromArray(r,t,a*n),r+=i.stride}else if(t.length>s*n){const r=s*n;if(ArrayBuffer.isView(t))t=t.subarray(0,r),i.array.set(t);else for(let a=0;a<r;a++)i.array[a]=t[a]}else i.array.set(t)}}readData(e,t){const s=this.element[e];let i=0;if(s){i=this.vertexBuffer.numVertices;let n;const r=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),s.index=0;let a=0;for(n=0;n<i;n++)s.getToArray(a,t,n*r),a+=s.stride}else if(ArrayBuffer.isView(t))t.set(s.array);else{t.length=0;const a=i*r;for(n=0;n<a;n++)t[n]=s.array[n]}}return i}}const Ad="mouse",Cd="keyboard",Md="gamepad",CM="mousex",MM="mousey",PM="padlx",RM="padly",IM="padrx",DM="padry",LM="key",FM="keydown",OM="keyup",Bp="mousedown",Mh="mousemove",Np="mouseup",Pd="mousewheel",BM="touchstart",NM="touchend",kM="touchmove",UM="touchcancel",zM="select",VM="selectstart",GM="selectend",WM=8,HM=9,XM=13,$M=13,qM=16,jM=17,YM=18,KM=19,ZM=20,QM=27,JM=32,eP=33,tP=34,sP=35,iP=36,nP=37,rP=38,aP=39,oP=40,lP=44,hP=45,cP=46,dP=48,uP=49,fP=50,pP=51,mP=52,_P=53,gP=54,yP=55,vP=56,xP=57,SP=59,bP=61,TP=65,wP=66,EP=67,AP=68,CP=69,MP=70,PP=71,RP=72,IP=73,DP=74,LP=75,FP=76,OP=77,BP=78,NP=79,kP=80,UP=81,zP=82,VP=83,GP=84,WP=85,HP=86,XP=87,$P=88,qP=89,jP=90,YP=91,KP=93,ZP=96,QP=97,JP=98,e1=99,t1=100,s1=101,i1=102,n1=103,r1=104,a1=105,o1=106,l1=107,h1=108,c1=109,d1=110,u1=111,f1=112,p1=113,m1=114,_1=115,g1=116,y1=117,v1=118,x1=119,S1=120,b1=121,T1=122,w1=123,E1=188,A1=190,C1=191,M1=219,P1=220,R1=221,I1=224,Qv=-1,D1=0,L1=1,F1=2,Jv=0,O1=1,B1=2,N1=3,e0=0,t0=1,s0=2,i0=3,n0=4,r0=5,a0=6,o0=7,l0=8,h0=9,c0=10,d0=11,u0=12,f0=13,p0=14,m0=15,_0=16,kp=0,Up=1,zp=2,Vp=3,g0="gamepadconnected",y0="gamepaddisconnected",v0=0,x0=1,S0=2,b0=3,T0=2,w0=0,E0=1,A0=3,C0=4,M0=5;class Gp{constructor(e,t){t?(this.key=t.keyCode,this.element=t.target,this.event=t):(this.key=null,this.element=null,this.event=null)}}const Rd=new Gp;function Wp(o){return Rd.key=o.keyCode,Rd.element=o.target,Rd.event=o,Rd}function Id(o){return typeof o=="string"?o.toUpperCase().charCodeAt(0):o}const k1={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class Po extends Q{constructor(e,t={}){super(),this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),this._keymap={},this._lastmap={},e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(e){e=Id(e);const t=k1[e.toString()];if(t)return t;let s=e.toString(16).toUpperCase();const i=s.length;for(let n=0;n<4-i;n++)s="0"+s;return"U+"+s}_handleKeyDown(e){const t=e.keyCode||e.charCode;if(t===void 0)return;const s=this.toKeyIdentifier(t);this._keymap[s]=!0,this.fire("keydown",Wp(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyUp(e){const t=e.keyCode||e.charCode;if(t===void 0)return;const s=this.toKeyIdentifier(t);delete this._keymap[s],this.fire("keyup",Wp(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyPress(e){this.fire("keypress",Wp(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleVisibilityChange(){document.visibilityState==="hidden"&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const e in this._lastmap)delete this._lastmap[e];for(const e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])}isPressed(e){const t=Id(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]}wasPressed(e){const t=Id(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(e){const t=Id(e),s=this.toKeyIdentifier(t);return!this._keymap[s]&&!!this._lastmap[s]}}Po.EVENT_KEYDOWN="keydown",Po.EVENT_KEYUP="keyup";function Hp(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}class Qi{constructor(e,t){let s={x:0,y:0};if(t){if(t instanceof Qi)throw Error("Expected MouseEvent");s=e._getTargetCoords(t)}else t={};if(s)this.x=s.x,this.y=s.y;else if(Hp())this.x=0,this.y=0;else return;this.wheelDelta=0,t.type==="wheel"&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),Hp()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),t.type==="mousedown"||t.type==="mouseup"?this.button=t.button:this.button=Qv,this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.event=t}}class ni extends Q{constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this._target=null,this._attached=!1,this.attach(e)}static isPointerLocked(){return Hp()}attach(e){if(this._target=e,this._attached)return;this._attached=!0;const t=ge.passiveEvents?{passive:!1}:!1;window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const e=ge.passiveEvents?{passive:!1}:!1;window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(e,t){if(!document.body.requestPointerLock){t&&t();return}const s=()=>{e(),document.removeEventListener("pointerlockchange",s)},i=()=>{t(),document.removeEventListener("pointerlockerror",i)};e&&document.addEventListener("pointerlockchange",s,!1),t&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(e){if(!document.exitPointerLock)return;const t=()=>{e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return!this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=!1;const t=new Qi(this,e);t.event&&this.fire(Np,t)}_handleDown(e){this._buttons[e.button]=!0;const t=new Qi(this,e);t.event&&this.fire(Bp,t)}_handleMove(e){const t=new Qi(this,e);t.event&&(this.fire(Mh,t),this._lastX=t.x,this._lastY=t.y)}_handleWheel(e){const t=new Qi(this,e);t.event&&this.fire(Pd,t)}_getTargetCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);return e.clientX<s||e.clientX>=s+this._target.clientWidth||e.clientY<i||e.clientY>=i+this._target.clientHeight?null:{x:e.clientX-s,y:e.clientY-i}}}ni.EVENT_MOUSEMOVE=Mh,ni.EVENT_MOUSEDOWN=Bp,ni.EVENT_MOUSEUP=Np,ni.EVENT_MOUSEWHEEL=Pd;class P0{constructor(e,t={}){this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,this._element=null,this._actions={},this._axes={},this._axesValues={},e&&this.attach(e)}attach(e){this._element=e,this._keyboard&&this._keyboard.attach(e),this._mouse&&this._mouse.attach(e)}detach(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null}disableContextMenu(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()}enableContextMenu(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()}update(e){this._keyboard&&this._keyboard.update(),this._mouse&&this._mouse.update(),this._gamepads&&this._gamepads.update(),this._axesValues={};for(const t in this._axes)this._axesValues[t]=[]}appendAction(e,t){this._actions[e]=this._actions[e]||[],this._actions[e].push(t)}registerKeys(e,t){if(this._keyboard||this._enableKeyboard(),this._actions[e])throw new Error(`Action: ${e} already registered`);if(t===void 0)throw new Error("Invalid button");t.length||(t=[t]),this.appendAction(e,{type:Cd,keys:t})}registerMouse(e,t){if(this._mouse||this._enableMouse(),t===void 0)throw new Error("Invalid button");this.appendAction(e,{type:Ad,button:t})}registerPadButton(e,t,s){if(s===void 0)throw new Error("Invalid button");this.appendAction(e,{type:Md,button:s,pad:t})}registerAxis(e){const t=e.name;this._axes[t]||(this._axes[t]=[]);const s=this._axes[t].push(t);e=e||{},e.pad=e.pad||Jv;const i=function(r,a,l,h){switch(a){case"mousex":r._mouse.on(Mh,function(c){r._axesValues[t][s]=c.dx/10});break;case"mousey":r._mouse.on(Mh,function(c){r._axesValues[t][s]=c.dy/10});break;case"key":r._axes[t].push(function(){return r._keyboard.isPressed(h)?l:0});break;case"padrx":r._axes[t].push(function(){return r._gamepads.getAxis(e.pad,zp)});break;case"padry":r._axes[t].push(function(){return r._gamepads.getAxis(e.pad,Vp)});break;case"padlx":r._axes[t].push(function(){return r._gamepads.getAxis(e.pad,kp)});break;case"padly":r._axes[t].push(function(){return r._gamepads.getAxis(e.pad,Up)});break;default:throw new Error("Unknown axis")}};i(this,e.positive,1,e.positiveKey),(e.negativeKey||e.negative!==e.positive)&&i(this,e.negative,-1,e.negativeKey)}isPressed(e){if(!this._actions[e])return!1;const t=this._actions[e].length;for(let s=0;s<t;++s){const i=this._actions[e][s];switch(i.type){case Cd:if(this._keyboard){const n=i.keys.length;for(let r=0;r<n;r++)if(this._keyboard.isPressed(i.keys[r]))return!0}break;case Ad:if(this._mouse&&this._mouse.isPressed(i.button))return!0;break;case Md:if(this._gamepads&&this._gamepads.isPressed(i.pad,i.button))return!0;break}}return!1}wasPressed(e){if(!this._actions[e])return!1;const t=this._actions[e].length;for(let s=0;s<t;++s){const i=this._actions[e][s];switch(i.type){case Cd:if(this._keyboard){const n=i.keys.length;for(let r=0;r<n;r++)if(this._keyboard.wasPressed(i.keys[r]))return!0}break;case Ad:if(this._mouse&&this._mouse.wasPressed(i.button))return!0;break;case Md:if(this._gamepads&&this._gamepads.wasPressed(i.pad,i.button))return!0;break}}return!1}getAxis(e){let t=0;if(this._axes[e]){const s=this._axes[e].length;for(let i=0;i<s;i++)if(Uc(this._axes[e][i])==="function"){const n=this._axes[e][i]();Math.abs(n)>Math.abs(t)&&(t=n)}else this._axesValues[e]&&Math.abs(this._axesValues[e][i])>Math.abs(t)&&(t=this._axesValues[e][i])}return t}_enableMouse(){if(this._mouse=new ni,!this._element)throw new Error("Controller must be attached to an Element");this._mouse.attach(this._element)}_enableKeyboard(){if(this._keyboard=new Po,!this._element)throw new Error("Controller must be attached to an Element");this._keyboard.attach(this._element)}}const R0=Object.freeze([]);let Xp=function(){return R0};typeof navigator<"u"&&(Xp=(navigator.getGamepads||navigator.webkitGetGamepads||Xp).bind(navigator));const I0={buttons:{PAD_FACE_1:e0,PAD_FACE_2:t0,PAD_FACE_3:s0,PAD_FACE_4:i0,PAD_L_SHOULDER_1:n0,PAD_R_SHOULDER_1:r0,PAD_L_SHOULDER_2:a0,PAD_R_SHOULDER_2:o0,PAD_SELECT:l0,PAD_START:h0,PAD_L_STICK_BUTTON:c0,PAD_R_STICK_BUTTON:d0,PAD_UP:u0,PAD_DOWN:f0,PAD_LEFT:p0,PAD_RIGHT:m0,PAD_VENDOR:_0,XRPAD_TRIGGER:w0,XRPAD_SQUEEZE:E0,XRPAD_TOUCHPAD_BUTTON:T0,XRPAD_STICK_BUTTON:A0,XRPAD_A:C0,XRPAD_B:M0},axes:{PAD_L_STICK_X:kp,PAD_L_STICK_Y:Up,PAD_R_STICK_X:zp,PAD_R_STICK_Y:Vp,XRPAD_TOUCHPAD_X:v0,XRPAD_TOUCHPAD_Y:x0,XRPAD_STICK_X:S0,XRPAD_STICK_Y:b0}},Ph={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},DEFAULT_DUAL:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],synthesizedButtons:{PAD_UP:{axis:0,min:0,max:1},PAD_DOWN:{axis:0,min:-1,max:0},PAD_LEFT:{axis:0,min:-1,max:0},PAD_RIGHT:{axis:0,min:0,max:1}}},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],mapping:"standard"},DEFAULT_XR:{buttons:["XRPAD_TRIGGER","XRPAD_SQUEEZE","XRPAD_TOUCHPAD_BUTTON","XRPAD_STICK_BUTTON","XRPAD_A","XRPAD_B"],axes:["XRPAD_TOUCHPAD_X","XRPAD_TOUCHPAD_Y","XRPAD_STICK_X","XRPAD_STICK_Y"],mapping:"xr-standard"}},D0={"Product: 0268":"PS3"},Dd={};function L0(o){const e=Dd[o.id];if(e)return e;for(const i in D0)if(o.id.indexOf(i)!==-1){const n=D0[i];if(!o.mapping){const r=Ph["RAW_"+n];if(r)return r}return Ph[n]}if(o.mapping==="xr-standard")return Ph.DEFAULT_XR;const t=Ph.DEFAULT,s=o.buttons.length<t.buttons.length?Ph.DEFAULT_DUAL:t;return s.mapping=o.mapping,s}let $p=.25;function U1(o){return new Promise(e=>{setTimeout(e,o)})}class qp{constructor(e,t){if(this.value=0,this.pressed=!1,this.touched=!1,this.wasPressed=!1,this.wasReleased=!1,this.wasTouched=!1,typeof e=="number")this.value=e,this.pressed=e===1,this.touched=e>0;else{var s;this.value=e.value,this.pressed=e.pressed,this.touched=(s=e.touched)!=null?s:e.value>0}if(t)if(typeof t=="number")this.wasPressed=t!==1&&this.pressed,this.wasReleased=t===1&&!this.pressed,this.wasTouched=t===0&&this.touched;else{var i;this.wasPressed=!t.pressed&&this.pressed,this.wasReleased=t.pressed&&!this.pressed,this.wasTouched=!((i=t.touched)!=null?i:t.value>0)&&this.touched}}update(e){var t;const{value:s,pressed:i}=e,n=(t=e.touched)!=null?t:s>0;this.wasPressed=!this.pressed&&i,this.wasReleased=this.pressed&&!i,this.wasTouched=!this.touched&&n,this.value=s,this.pressed=i,this.touched=n}}const jp=Object.freeze(new qp(0));class F0{constructor(e,t){this._compiledMapping={buttons:[],axes:[]},this.id=e.id,this.index=e.index,this._buttons=e.buttons.map(s=>new qp(s)),this._axes=[...e.axes],this._previousAxes=[...e.axes],this.mapping=t.mapping,this.map=t,this.hand=e.hand||"none",this.pad=e,this._compileMapping()}get connected(){return this.pad.connected}_compileMapping(){const{axes:e,buttons:t}=this._compiledMapping,s=I0.axes,i=I0.buttons;e.length=0,t.length=0,this.map.axes&&this.map.axes.forEach((l,h)=>{e[s[l]]=()=>this.pad.axes[h]||0});for(let l=0,h=e.length;l<h;l++)e[l]||(e[l]=()=>0);const r=this.map.buttons;r&&r.forEach((l,h)=>{t[i[l]]=()=>this._buttons[h]||jp});const a=this.map.synthesizedButtons;a&&Object.entries(a).forEach(l=>{const{axis:h,max:c,min:d}=l[1];t[i[l[0]]]=()=>{var u,f;return new qp(Math.abs(U.clamp((u=this._axes[h])!=null?u:0,d,c)),Math.abs(U.clamp((f=this._previousAxes[h])!=null?f:0,d,c)))}});for(let l=0,h=t.length;l<h;l++)t[l]||(t[l]=()=>jp)}update(e){this.pad=e;const t=this._previousAxes,s=this._axes;t.length=0,t.push(...s),s.length=0,s.push(...e.axes);const i=this._buttons;for(let n=0,r=i.length;n<r;n++)i[n].update(e.buttons[n]);return this}updateMap(e){e.mapping="custom",Dd[this.id]=e,this.map=e,this.mapping="custom",this._compileMapping()}resetMap(){if(Dd[this.id]){delete Dd[this.id];const e=L0(this.pad);this.map=e,this.mapping=e.mapping,this._compileMapping()}}get axes(){return this._compiledMapping.axes.map(e=>e())}get buttons(){return this._compiledMapping.buttons.map(e=>e())}async pulse(e,t,s){const i=this.pad.vibrationActuator?[this.pad.vibrationActuator]:this.pad.hapticActuators||R0;if(i.length){var n,r,a;const l=(n=s==null?void 0:s.startDelay)!=null?n:0,h=(r=s==null?void 0:s.strongMagnitude)!=null?r:e,c=(a=s==null?void 0:s.weakMagnitude)!=null?a:e;return(await Promise.all(i.map(async function(u){return u?u.playEffect?u.playEffect(u.type,{duration:t,startDelay:l,strongMagnitude:h,weakMagnitude:c}):u.pulse?(await U1(l),u.pulse(e,t)):!1:!0}))).some(u=>u===!0||u==="complete")}return!1}getButton(e){const t=this._compiledMapping.buttons[e];return t?t():jp}isPressed(e){return this.getButton(e).pressed}wasPressed(e){return this.getButton(e).wasPressed}wasReleased(e){return this.getButton(e).wasReleased}isTouched(e){return this.getButton(e).touched}wasTouched(e){return this.getButton(e).wasTouched}getValue(e){return this.getButton(e).value}getAxis(e){const t=this.axes[e];return t&&Math.abs(t)>$p?t:0}}class Rh extends Q{constructor(){super(),this.gamepadsSupported=ge.gamepads,this.current=[],this._previous=[],this._ongamepadconnectedHandler=this._ongamepadconnected.bind(this),this._ongamepaddisconnectedHandler=this._ongamepaddisconnected.bind(this),window.addEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.addEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1),this.poll()}set deadZone(e){$p=e}get deadZone(){return $p}get previous(){const e=this.current;for(let t=0,s=e.length;t<s;t++){const i=e[t]._buttons;this._previous[t]||(this._previous[t]=[]);for(let n=0,r=i.length;n<r;n++){const a=i[t];this.previous[t][n]=a?!a.wasPressed&&a.pressed||a.wasReleased:!1}}return this._previous.length=this.current.length,this._previous}_ongamepadconnected(e){const t=new F0(e.gamepad,this.getMap(e.gamepad)),s=this.current;let i=s.findIndex(n=>n.index===t.index);for(;i!==-1;)s.splice(i,1),i=s.findIndex(n=>n.index===t.index);s.push(t),this.fire(g0,t)}_ongamepaddisconnected(e){const t=this.current,s=t.findIndex(i=>i.index===e.gamepad.index);s!==-1&&(this.fire(y0,t[s]),t.splice(s,1))}update(){this.poll()}poll(e=[]){e.length>0&&(e.length=0);const t=Xp();for(let s=0,i=t.length;s<i;s++)if(t[s]){const n=this.findByIndex(t[s].index);if(n)e.push(n.update(t[s]));else{const r=new F0(t[s],this.getMap(t[s]));this.current.push(r),e.push(r)}}return e}destroy(){window.removeEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.removeEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1)}getMap(e){return L0(e)}isPressed(e,t){var s;return((s=this.current[e])==null?void 0:s.isPressed(t))||!1}wasPressed(e,t){var s;return((s=this.current[e])==null?void 0:s.wasPressed(t))||!1}wasReleased(e,t){var s;return((s=this.current[e])==null?void 0:s.wasReleased(t))||!1}getAxis(e,t){var s;return((s=this.current[e])==null?void 0:s.getAxis(t))||0}pulse(e,t,s,i){const n=this.current[e];return n?n.pulse(t,s,i):Promise.resolve(!1)}pulseAll(e,t,s){return Promise.all(this.current.map(i=>i.pulse(e,t,s)))}findById(e){return this.current.find(t=>t&&t.id===e)||null}findByIndex(e){return this.current.find(t=>t&&t.index===e)||null}}Rh.EVENT_GAMEPADCONNECTED="gamepadconnected",Rh.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected";function Yp(o){let e=0,t=0,s=o.target;for(;!(s instanceof HTMLElement);)s=s.parentNode;let i=s;do e+=i.offsetLeft-i.scrollLeft,t+=i.offsetTop-i.scrollTop,i=i.offsetParent;while(i);return{x:o.pageX-e,y:o.pageY-t}}class Ld{constructor(e){const t=Yp(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e}}class Ro{constructor(e,t){if(this.element=t.target,this.event=t,this.touches=[],this.changedTouches=[],t){for(let s=0,i=t.touches.length;s<i;s++)this.touches.push(new Ld(t.touches[s]));for(let s=0,i=t.changedTouches.length;s<i;s++)this.changedTouches.push(new Ld(t.changedTouches[s]))}}getTouchById(e,t){for(let s=0,i=t.length;s<i;s++)if(t[s].id===e)return t[s];return null}}class Kp extends Q{constructor(e){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e)}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(e){this.fire("touchstart",new Ro(this,e))}_handleTouchEnd(e){this.fire("touchend",new Ro(this,e))}_handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new Ro(this,e))}_handleTouchCancel(e){this.fire("touchcancel",new Ro(this,e))}}class fe{get(e,t,s){return typeof t=="function"&&(s=t,t={}),this.request("GET",e,t,s)}post(e,t,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=t,this.request("POST",e,s,i)}put(e,t,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=t,this.request("PUT",e,s,i)}del(e,t,s){return typeof t=="function"&&(s=t,t={}),this.request("DELETE",e,t,s)}request(e,t,s,i){let n,r,a,l=!1;if(typeof s=="function"&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,s.async==null&&(s.async=!0),s.headers==null&&(s.headers={}),s.postdata!=null)if(s.postdata instanceof Document)a=s.postdata;else if(s.postdata instanceof FormData)a=s.postdata;else if(s.postdata instanceof Object){let c=s.headers["Content-Type"];switch(c===void 0&&(s.headers["Content-Type"]=fe.ContentType.FORM_URLENCODED,c=s.headers["Content-Type"]),c){case fe.ContentType.FORM_URLENCODED:{a="";let d=!0;for(const u in s.postdata)if(s.postdata.hasOwnProperty(u)){d?d=!1:a+="&";const f=encodeURIComponent(u),p=encodeURIComponent(s.postdata[u]);a+=`${f}=${p}`}break}default:case fe.ContentType.JSON:c==null&&(s.headers["Content-Type"]=fe.ContentType.JSON),a=JSON.stringify(s.postdata);break}}else a=s.postdata;if(s.cache===!1){const c=jt();n=new Vc(t),n.query?n.query=n.query+"&ts="+c:n.query="ts="+c,t=n.toString()}s.query&&(n=new Vc(t),r=Gi(n.getQuery(),s.query),n.setQuery(r),t=n.toString());const h=new XMLHttpRequest;h.open(e,t,s.async),h.withCredentials=s.withCredentials!==void 0?s.withCredentials:!1,h.responseType=s.responseType||this._guessResponseType(t);for(const c in s.headers)s.headers.hasOwnProperty(c)&&h.setRequestHeader(c,s.headers[c]);h.onreadystatechange=()=>{this._onReadyStateChange(e,t,s,h)},h.onerror=()=>{this._onError(e,t,s,h),l=!0};try{h.send(a)}catch(c){l||s.error(h.status,h,c)}return h}_guessResponseType(e){const t=new Vc(e),s=ce.getExtension(t.path).toLowerCase();return fe.binaryExtensions.indexOf(s)>=0?fe.ResponseType.ARRAY_BUFFER:s===".json"?fe.ResponseType.JSON:s===".xml"?fe.ResponseType.DOCUMENT:fe.ResponseType.TEXT}_isBinaryContentType(e){return[fe.ContentType.BASIS,fe.ContentType.BIN,fe.ContentType.DDS,fe.ContentType.GLB,fe.ContentType.MP3,fe.ContentType.MP4,fe.ContentType.OGG,fe.ContentType.OPUS,fe.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===fe.ResponseType.ARRAY_BUFFER||e===fe.ResponseType.BLOB||e===fe.ResponseType.JSON}_onReadyStateChange(e,t,s,i){if(i.readyState===4)switch(i.status){case 0:{i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,s,i):this._onError(e,t,s,i);break}case 200:case 201:case 206:case 304:{this._onSuccess(e,t,s,i);break}default:{this._onError(e,t,s,i);break}}}_onSuccess(e,t,s,i){let n,r;const a=i.getResponseHeader("Content-Type");a&&(r=a.split(";")[0].trim());try{this._isBinaryContentType(r)||this._isBinaryResponseType(i.responseType)?n=i.response:r===fe.ContentType.JSON||t.split("?")[0].endsWith(".json")?n=JSON.parse(i.responseText):i.responseType===fe.ResponseType.DOCUMENT||r===fe.ContentType.XML?n=i.responseXML:n=i.responseText,s.callback(null,n)}catch(l){s.callback(l)}}_onError(e,t,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=U.clamp(Math.pow(2,s.retries)*fe.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${e}: ${t} - Error ${i.status}. Retrying in ${n} ms`),setTimeout(()=>{s.retrying=!1,this.request(e,t,s,s.callback)},n)}else s.callback(i.status===0?"Network error":i.status,null)}}fe.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},fe.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},fe.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],fe.retryDelay=100;const He=new fe;function Ji(){return typeof AudioContext<"u"||typeof webkitAudioContext<"u"}class Ih{constructor(e,t,s={}){var i,n,r;if(this.volume=(i=s.volume)!=null?i:1,this.loop=(n=s.loop)!=null?n:!1,this.pitch=(r=s.pitch)!=null?r:1,this.sound=t,this.paused=!1,this.suspended=!1,this.manager=e,this.source=null,Ji()){this.startTime=0,this.startOffset=0;const a=e.context;this.gain=a.createGain()}else t.audio&&(this.source=t.audio.cloneNode(!1),this.source.pause())}getVolume(){return this.volume}getLoop(){return this.loop}setLoop(e){this.loop=e,this.source&&(this.source.loop=e)}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume())}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())}onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())}play(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())}pause(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)}unpause(){if(this.source||!this.paused){console.warn("Call pause() before unpausing.");return}this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)}stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)}setVolume(e){e=U.clamp(e,0,1),this.volume=e,this.gain&&(this.gain.gain.value=e*this.manager.volume)}setPitch(e){this.pitch=e,this.source&&(this.source.playbackRate.value=e)}isPlaying(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE}getDuration(){return this.source?this.source.buffer.duration:0}_createSource(){const e=this.manager.context;this.sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}Ji()||Object.assign(Ih.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(o){o=U.clamp(o,0,1),this.volume=o,this.source&&(this.source.volume=o*this.manager.volume)},setPitch:function(o){this.pitch=o,this.source&&(this.source.playbackRate=o)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});const z1=1e4;class en extends Ih{constructor(e,t,s){super(e,t,s),this.position=new y,this.velocity=new y,Ji()?this.panner=e.context.createPanner():(this.maxDistance=z1,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=Ll)}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}getVelocity(){return this.velocity}setVelocity(e){this.velocity.copy(e)}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){this.panner.maxDistance=e}getMinDistance(){return this.panner.refDistance}setMinDistance(e){this.panner.refDistance=e}getRollOffFactor(){return this.panner.rolloffFactor}setRollOffFactor(e){this.panner.rolloffFactor=e}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){this.panner.distanceModel=e}_createSource(){const e=this.manager.context;this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this))}}if(!Ji()){let o=new y;const e=function(s,i,n,r,a,l){o=o.sub2(s,i);const h=o.length();if(h<n)return 1;if(h>r)return 0;let c=0;return l===Dl?c=1-a*(h-n)/(r-n):l===Ll?c=n/(n+a*(h-n)):l===dp&&(c=Math.pow(h/n,-a)),U.clamp(c,0,1)};Object.assign(en.prototype,{setPosition:function(t){if(this.position.copy(t),this.source){const i=this.manager.listener.getPosition(),n=e(i,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),r=this.getVolume();this.source.volume=r*n}},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(t){this.maxDistance=t},getMinDistance:function(){return this.minDistance},setMinDistance:function(t){this.minDistance=t},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(t){this.rollOffFactor=t},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(t){this.distanceModel=t}})}class O0{constructor(e){this._manager=e,this.position=new y,this.velocity=new y,this.orientation=new W}getPosition(){return this.position}setPosition(e){this.position.copy(e);const t=this.listener;t&&("positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z))}getVelocity(){return this.velocity}setVelocity(e){}setOrientation(e){this.orientation.copy(e);const t=this.listener;if(t){const s=e.data;"forwardX"in t?(t.forwardX.value=-s[8],t.forwardY.value=-s[9],t.forwardZ.value=-s[10],t.upX.value=s[4],t.upY.value=s[5],t.upZ.value=s[6]):t.setOrientation&&t.setOrientation(-s[8],-s[9],-s[10],s[4],s[5],s[6])}}getOrientation(){return this.orientation}get listener(){const e=this._manager.context;return e?e.listener:null}}const Fd="running",B0=["click","touchstart","mousedown"];class Io extends Q{constructor(){super(),this._context=null,this.AudioContext=typeof AudioContext<"u"&&AudioContext||typeof webkitAudioContext<"u"&&webkitAudioContext,this.AudioContext,this._unlockHandlerFunc=this._unlockHandler.bind(this),this._userSuspended=!1,this.listener=new O0(this),this._volume=1}set volume(e){e=U.clamp(e,0,1),this._volume=e,this.fire("volumechange",e)}get volume(){return this._volume}get suspended(){return this._userSuspended}get context(){return!this._context&&this.AudioContext&&(this._context=new this.AudioContext,this._context.state!==Fd&&this._registerUnlockListeners()),this._context}suspend(){this._userSuspended||(this._userSuspended=!0,this._context&&this._context.state===Fd&&this._suspend())}resume(){this._userSuspended&&(this._userSuspended=!1,this._context&&this._context.state!==Fd&&this._resume())}destroy(){if(this.fire("destroy"),this._context){var e;this._removeUnlockListeners(),(e=this._context)==null||e.close(),this._context=null}}playSound(e,t={}){let s=null;return Ih&&(s=new Ih(this,e,t),s.play()),s}playSound3d(e,t,s={}){let i=null;return en&&(i=new en(this,e,s),i.setPosition(t),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}_resume(){this._context.resume().then(()=>{const e=this._context.createBufferSource();e.buffer=this._context.createBuffer(1,1,this._context.sampleRate),e.connect(this._context.destination),e.start(0),e.onended=t=>{e.disconnect(0),this.fire("resume")}},e=>{}).catch(e=>{})}_suspend(){this._context.suspend().then(()=>{this.fire("suspend")},e=>{}).catch(e=>{})}_unlockHandler(){this._removeUnlockListeners(),!this._userSuspended&&this._context.state!==Fd&&this._resume()}_registerUnlockListeners(){B0.forEach(e=>{window.addEventListener(e,this._unlockHandlerFunc,!1)})}_removeUnlockListeners(){B0.forEach(e=>{window.removeEventListener(e,this._unlockHandlerFunc,!1)})}}class Zp{constructor(e){this.audio=void 0,this.buffer=void 0,e instanceof Audio?this.audio=e:this.buffer=e}get duration(){let e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}}const ts=0,Do=1,ri=2;function ss(o,e){return o%e||0}class us extends Q{constructor(e,t,s){super(),this.source=null,this._manager=e,this._volume=s.volume!==void 0?U.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0&&s.loop),this._sound=t,this._state=ri,this._suspended=!1,this._suspendEndEvent=0,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,Ji()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._waitingContextSuspension=!1,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}set currentTime(e){if(!(e<0))if(this._state===ts){const t=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t}else this._startOffset=e,this._currentTime=e}get currentTime(){return this._startOffset!==null?this._startOffset:this._state===Do?this._currentTime:this._state===ri||!this.source?0:(this._updateCurrentTime(),this._currentTime)}set duration(e){this._duration=Math.max(0,Number(e)||0);const t=this._state===ts;this.stop(),t&&this.play()}get duration(){return this._sound?this._duration?ss(this._duration,this._sound.duration):this._sound.duration:0}get isPaused(){return this._state===Do}get isPlaying(){return this._state===ts}get isStopped(){return this._state===ri}get isSuspended(){return this._suspended}set loop(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}get loop(){return this._loop}set pitch(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}get pitch(){return this._pitch}set sound(e){this._sound=e,this._state!==ri?this.stop():this._createSource()}get sound(){return this._sound}set startTime(e){this._startTime=Math.max(0,Number(e)||0);const t=this._state===ts;this.stop(),t&&this.play()}get startTime(){return this._startTime}set volume(e){e=U.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume)}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){if(this._suspendEndEvent>0){this._suspendEndEvent--;return}this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop()}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){this._state===ts&&!this._suspended&&(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}play(){return this._state!==ri&&this.stop(),this._state=ts,this._playWhenLoaded=!1,this._waitingContextSuspension?!1:this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=!0,!1):(this._playAudioImmediate(),!0)}_playAudioImmediate(){if(this._waitingContextSuspension=!1,this._state!==ts)return;this.source||this._createSource();let e=ss(this._startOffset,this.duration);e=ss(this._startTime+e,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay()}pause(){return this._playWhenLoaded=!1,this._state!==ts?!1:(this._state=Do,this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause()),!0)}resume(){if(this._state!==Do)return!1;let e=this.currentTime;return this._state=ts,this._waitingContextSuspension||(this.source||this._createSource(),this._startOffset!==null&&(e=ss(this._startOffset,this.duration),e=ss(this._startTime+e,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume()),!0}stop(){if(this._playWhenLoaded=!1,this._state===ri)return!1;const e=this._state===ts;return this._state=ri,this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop()),!0}setExternalNodes(e,t){if(!e){console.error("The firstNode must be a valid Audio Node");return}t||(t=e);const s=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=t,this._lastNode.connect(s))}clearExternalNodes(){const e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)}getExternalNodes(){return[this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;const e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=ss(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,ss(this._startTime+this._duration,this.source.buffer.duration)))),this.source}_updateCurrentTime(){this._currentTime=ss((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)}_onManagerDestroy(){this.source&&this._state===ts&&(this.source.stop(0),this.source=null)}}us.EVENT_PLAY="play",us.EVENT_PAUSE="pause",us.EVENT_RESUME="resume",us.EVENT_STOP="stop",us.EVENT_END="end",Ji()||(Object.assign(us.prototype,{play:function(){return this._state!==ri&&this.stop(),!this.source&&!this._createSource()?!1:(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=ts,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!this.source||this._state!==ts?!1:(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=Do,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!this.source||this._state!==Do?!1:(this._state=ts,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!this.source||this._state===ri?!1:(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=ri,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let o=ss(this._startOffset,this.duration);o=ss(this._startTime+o,this._sound.duration),this._startOffset=null,this.source.currentTime=o},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>ss(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=ss(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(us.prototype,"volume",{get:function(){return this._volume},set:function(o){o=U.clamp(o,0,1),this._volume=o,this.source&&(this.source.volume=o*this._manager.volume)}}),Object.defineProperty(us.prototype,"pitch",{get:function(){return this._pitch},set:function(o){this._pitch=Math.max(Number(o)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(us.prototype,"sound",{get:function(){return this._sound},set:function(o){this.stop(),this._sound=o}}),Object.defineProperty(us.prototype,"currentTime",{get:function(){return this._startOffset!==null?this._startOffset:this._state===ri||!this.source?0:this.source.currentTime-this._startTime},set:function(o){o<0||(this._startOffset=o,this.source&&this._isReady&&(this.source.currentTime=ss(this._startTime+ss(o,this.duration),this._sound.duration),this._startOffset=null))}}));const V1=1e4;class Zr extends us{constructor(e,t,s={}){super(e,t,s),this._position=new y,this._velocity=new y,s.position&&(this.position=s.position),this.maxDistance=s.maxDistance!==void 0?Number(s.maxDistance):V1,this.refDistance=s.refDistance!==void 0?Number(s.refDistance):1,this.rollOffFactor=s.rollOffFactor!==void 0?Number(s.rollOffFactor):1,this.distanceModel=s.distanceModel!==void 0?s.distanceModel:Dl}_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}set position(e){this._position.copy(e);const t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}get position(){return this._position}set velocity(e){this._velocity.copy(e)}get velocity(){return this._velocity}set maxDistance(e){this.panner.maxDistance=e}get maxDistance(){return this.panner.maxDistance}set refDistance(e){this.panner.refDistance=e}get refDistance(){return this.panner.refDistance}set rollOffFactor(e){this.panner.rolloffFactor=e}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(e){this.panner.distanceModel=e}get distanceModel(){return this.panner.distanceModel}}if(!Ji()){let o=new y;const e=function(s,i,n,r,a,l){o=o.sub2(s,i);const h=o.length();if(h<n)return 1;if(h>r)return 0;let c=0;return l===Dl?c=1-a*(h-n)/(r-n):l===Ll?c=n/(n+a*(h-n)):l===dp&&(c=Math.pow(h/n,-a)),U.clamp(c,0,1)};Object.defineProperty(Zr.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){const i=this._manager.listener.getPosition(),n=e(i,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),r=this.volume;this.source.volume=r*n*this._manager.volume}}}),Object.defineProperty(Zr.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty(Zr.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty(Zr.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty(Zr.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}const Qp=0,Od=1,Bt=2,Nt=3,jn=4,Bd=5,Nd=6,Jp=7,em=8,tm=9,sm=10,Dh="none",N0="linear",G1="exp",W1="exp2",H1=0,Lh=2,k0=0,X1=1,U0=2,im=15,is=0,kt=1,kd=2,Ds=3,Fh=4,ae=0,be=1,$1=be,Ie=2,q1=3,yt=0,z0=1,V0=2,G0=3,Ud=0,W0=1,at=0,j1=0,fs=1,Ls=2,ps=3,Fs=4,ai=5,At=6,tn={};tn[at]="PCF3",tn[fs]="VSM8",tn[Ls]="VSM16",tn[ps]="VSM32",tn[Fs]="PCF5",tn[ai]="PCF1",tn[At]="PCSS";const Y1=0,zd=1,Vd=0,K1=1,Z1=2,Q1=3,nm=0,J1=1,oi=0,H0=1,Oh=0,X0=1,eR=2,Os=0,Yn=1,Lo=0,Kn=1,Bh=2,rm=0,$0=1,li=0,Qr=1,am="mul",tR="add",sR="screen",iR="overlay",nR="min",rR="max",Fo=0,om=1,q0=2,Oo=3,Bo=0,j0=1,Y0=2,K0=3,Z0=4,Q0=0,Jr=1,Gd=2,Nh=1,No=2,lm=4,hm=8,cm=16,ko=32,kh=64,Wd=128,Uo=256,Hd=512,zo=1024,Vo=2048,Go=4096,Xd=8192,Bs=0,Zn=1,$d=2,Li=0,qd=1,ns=1,hi=2,ci=4,Wo=0,di=1,ui=2,ea=3,dm=4,Uh=5,aR="forward",oR="debug_albedo",lR="debug_world_normal",hR="debug_opacity",cR="debug_specularity",dR="debug_gloss",uR="debug_metalness",fR="debug_ao",pR="debug_emission",mR="debug_lighting",_R="debug_uv0",Fi=0,ot=1,st=2,gR=0,zh=1,Vh=0,yR=1,vR=2,Gh=0,J0=1,ex=2,um=3,tx=4,sx=5,jd=0,Yd=1,pe=0,Ae=1,Wh="infinite",ix="box",nx="dome",wt="none",fm="bayer8",xR="bluenoise";class pm{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}}let SR=0;class Oi{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=St,this.indicesUsage=St,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e)}}Oi.DEFAULT_COMPONENTS_POSITION=3,Oi.DEFAULT_COMPONENTS_NORMAL=3,Oi.DEFAULT_COMPONENTS_UV=2,Oi.DEFAULT_COMPONENTS_COLORS=4;class bR{constructor(e,t,s,i){this.data=e,this.componentCount=t,this.dataType=s,this.dataTypeNormalize=i}}class Ut extends pm{constructor(e){super(),this._aabbVer=0,this._aabb=new ye,this.id=SR++,this.device=e,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this._morph=null,this._geometryData=null,this.boneAabb=null}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++}get aabb(){return this._aabb}destroy(){const e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)}_initBoneAabbs(e){this.boneAabb=[],this.boneUsed=[];let t,s,i,n,r;const a=[],l=[],h=this.boneUsed,c=this.skin.boneNames.length;let d,u,f;for(let v=0;v<c;v++)a[v]=new y(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l[v]=new y(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const p=new Kr(this.vertexBuffer),_=p.element[We],m=p.element[ti],g=p.element[Kt],x=this.vertexBuffer.numVertices;for(let v=0;v<x;v++){for(let b=0;b<4;b++)if(m.array[m.index+b]>0){const T=g.array[g.index+b];if(h[T]=!0,t=_.array[_.index],s=_.array[_.index+1],i=_.array[_.index+2],n=l[T],r=a[T],r.x>t&&(r.x=t),r.y>s&&(r.y=s),r.z>i&&(r.z=i),n.x<t&&(n.x=t),n.y<s&&(n.y=s),n.z<i&&(n.z=i),e){let E=d=t,C=u=s,M=f=i;for(let O=0;O<e.length;O++){const I=e[O],B=I.deltaPositions[v*3],P=I.deltaPositions[v*3+1],D=I.deltaPositions[v*3+2];B<0?E+=B:d+=B,P<0?C+=P:u+=P,D<0?M+=D:f+=D}r.x>E&&(r.x=E),r.y>C&&(r.y=C),r.z>M&&(r.z=M),n.x<d&&(n.x=d),n.y<u&&(n.y=u),n.z<f&&(n.z=f)}}p.next()}const S=this.vertexBuffer.getFormat().elements.find(v=>v.name===We);if(S&&S.normalize){const v=(()=>{switch(S.dataType){case si:return b=>Math.max(b/127,-1);case Zt:return b=>b/255;case ii:return b=>Math.max(b/32767,-1);case Ms:return b=>b/65535;default:return b=>b}})();for(let b=0;b<c;b++)if(h[b]){const w=a[b],T=l[b];w.set(v(w.x),v(w.y),v(w.z)),T.set(v(T.x),v(T.y),v(T.z))}}for(let v=0;v<c;v++){const b=new ye;b.setMinMax(a[v],l[v]),this.boneAabb.push(b)}}_initGeometryData(){this._geometryData||(this._geometryData=new Oi,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(e,t,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=e?St:Pn,this._geometryData.indicesUsage=t?St:Pn}setVertexStream(e,t,s,i,n=le,r=!1){this._initGeometryData();const a=i||t.length/s;this._geometryData._changeVertexCount(a,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new bR(t,s,n,r)}getVertexStream(e,t){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[e];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(n.data):(t.length=0,t.push(n.data)))}return i||this.vertexBuffer&&(s=new Kr(this.vertexBuffer).readData(e,t)),s}setPositions(e,t=Oi.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(We,e,t,s,le,!1)}setNormals(e,t=Oi.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(Dt,e,t,s,le,!1)}setUvs(e,t,s=Oi.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(od+e,t,s,i,le,!1)}setColors(e,t=Oi.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(_t,e,t,s,le,!1)}setColors32(e,t){this.setVertexStream(_t,e,Oi.DEFAULT_COMPONENTS_COLORS,t,Zt,!0)}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length}getPositions(e){return this.getVertexStream(We,e)}getNormals(e){return this.getVertexStream(Dt,e)}getUvs(e,t){return this.getVertexStream(od+e,t)}getColors(e){return this.getVertexStream(_t,e)}getIndices(e){let t=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(s);else{e.length=0;for(let i=0,n=s.length;i<n;i++)e.push(s[i])}}else this.indexBuffer.length>0&&this.indexBuffer[0]&&(t=this.indexBuffer[0].readData(e));return t}update(e=Js,t=!0){if(this._geometryData){if(t){const n=this._geometryData.vertexStreamDictionary[We];n&&n.componentCount===3&&(this._aabb.compute(n.data,this._geometryData.vertexCount),this._aabbVer++)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(e){const t=[];for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];t.push({semantic:s,components:i.componentCount,type:i.dataType,normalize:i.dataTypeNormalize})}return new Tt(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){const s=this._geometryData.maxVertices,i=this._buildVertexFormat(s);this.vertexBuffer=new es(this.device,i,s,this._geometryData.verticesUsage)}const e=new Kr(this.vertexBuffer),t=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];e.writeData(s,i.data,t),delete this._geometryData.vertexStreamDictionary[s]}e.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const t=this._geometryData.maxVertices>65535?Mi:Yt;this.indexBuffer[0]=new Di(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage)}const e=this._geometryData.indices;e&&(this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null)}prepareRenderState(e){e===Kn?this.generateWireframe():e===Bh&&(this.primitive[Bh]={type:Lr,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[Bh]&&this.prepareRenderState(Bh),this.primitive[Kn]&&this.prepareRenderState(Kn)}generateWireframe(){this._destroyIndexBuffer(Kn);const e=this.vertexBuffer.numVertices,t=[];let s;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const r=[[0,1],[1,2],[2,0]],a=this.primitive[Lo].base,l=this.primitive[Lo].count,h=this.indexBuffer[Lo],c=new Sd[h.format](h.storage),d=new Set;for(let u=a;u<a+l;u+=3)for(let f=0;f<3;f++){const p=c[u+r[f][0]],_=c[u+r[f][1]],m=p>_?_*e+p:p*e+_;d.has(m)||(d.add(m),t.push(p,_))}s=h.format}else{for(let r=0;r<e;r+=3)t.push(r,r+1,r+1,r+2,r+2,r);s=t.length>65535?Mi:Yt}const i=new Di(this.vertexBuffer.device,s,t.length);new Sd[i.format](i.storage).set(t),i.unlock(),this.primitive[Kn]={type:eo,base:0,count:t.length,indexed:!0},this.indexBuffer[Kn]=i}}const ms=4/64,Ns=1-ms*2,Hh=[];function rx(o,e){const t=e.length/3,s=o.length/3,i=new y,n=new y,r=new y,a=new y,l=new y,h=new y,c=[];for(let d=0;d<o.length;d++)c[d]=0;for(let d=0;d<t;d++){const u=e[d*3],f=e[d*3+1],p=e[d*3+2];i.set(o[u*3],o[u*3+1],o[u*3+2]),n.set(o[f*3],o[f*3+1],o[f*3+2]),r.set(o[p*3],o[p*3+1],o[p*3+2]),a.sub2(n,i),l.sub2(r,i),h.cross(a,l).normalize(),c[u*3]+=h.x,c[u*3+1]+=h.y,c[u*3+2]+=h.z,c[f*3]+=h.x,c[f*3+1]+=h.y,c[f*3+2]+=h.z,c[p*3]+=h.x,c[p*3+1]+=h.y,c[p*3+2]+=h.z}for(let d=0;d<s;d++){const u=c[d*3],f=c[d*3+1],p=c[d*3+2],_=1/Math.sqrt(u*u+f*f+p*p);c[d*3]*=_,c[d*3+1]*=_,c[d*3+2]*=_}return c}function sn(o,e,t,s){const i=s.length/3,n=o.length/3,r=new y,a=new y,l=new y,h=new G,c=new G,d=new G,u=new y,f=new y,p=new Float32Array(n*3),_=new Float32Array(n*3),m=[];for(let b=0;b<i;b++){const w=s[b*3],T=s[b*3+1],E=s[b*3+2];r.set(o[w*3],o[w*3+1],o[w*3+2]),a.set(o[T*3],o[T*3+1],o[T*3+2]),l.set(o[E*3],o[E*3+1],o[E*3+2]),h.set(t[w*2],t[w*2+1]),c.set(t[T*2],t[T*2+1]),d.set(t[E*2],t[E*2+1]);const C=a.x-r.x,M=l.x-r.x,O=a.y-r.y,I=l.y-r.y,B=a.z-r.z,P=l.z-r.z,D=c.x-h.x,R=d.x-h.x,A=c.y-h.y,L=d.y-h.y,F=D*L-R*A;if(F===0)u.set(0,1,0),f.set(1,0,0);else{const N=1/F;u.set((L*C-A*M)*N,(L*O-A*I)*N,(L*B-A*P)*N),f.set((D*M-R*C)*N,(D*I-R*O)*N,(D*P-R*B)*N)}p[w*3+0]+=u.x,p[w*3+1]+=u.y,p[w*3+2]+=u.z,p[T*3+0]+=u.x,p[T*3+1]+=u.y,p[T*3+2]+=u.z,p[E*3+0]+=u.x,p[E*3+1]+=u.y,p[E*3+2]+=u.z,_[w*3+0]+=f.x,_[w*3+1]+=f.y,_[w*3+2]+=f.z,_[T*3+0]+=f.x,_[T*3+1]+=f.y,_[T*3+2]+=f.z,_[E*3+0]+=f.x,_[E*3+1]+=f.y,_[E*3+2]+=f.z}const g=new y,x=new y,S=new y,v=new y;for(let b=0;b<n;b++){S.set(e[b*3],e[b*3+1],e[b*3+2]),g.set(p[b*3],p[b*3+1],p[b*3+2]),x.set(_[b*3],_[b*3+1],_[b*3+2]);const w=S.dot(g);v.copy(S).mulScalar(w),v.sub2(g,v).normalize(),m[b*4]=v.x,m[b*4+1]=v.y,m[b*4+2]=v.z,v.cross(S,g),m[b*4+3]=v.dot(x)<0?-1:1}return m}function ks(o,e,t){const s=new Ut(o);return s.setPositions(e),t&&(t.normals&&s.setNormals(t.normals),t.tangents&&s.setVertexStream(ei,t.tangents,4),t.colors&&s.setColors32(t.colors),t.uvs&&s.setUvs(0,t.uvs),t.uvs1&&s.setUvs(1,t.uvs1),t.blendIndices&&s.setVertexStream(Kt,t.blendIndices,4,t.blendIndices.length/4,Zt),t.blendWeights&&s.setVertexStream(ti,t.blendWeights,4),t.indices&&s.setIndices(t.indices)),s.update(),s}function mm(o,e={}){var t,s,i,n,r,a;const l=(t=e.tubeRadius)!=null?t:.2,h=(s=e.ringRadius)!=null?s:.3,c=((i=e.sectorAngle)!=null?i:360)*U.DEG_TO_RAD,d=(n=e.segments)!=null?n:30,u=(r=e.sides)!=null?r:20,f=(a=e.calculateTangents)!=null?a:!1,p=[],_=[],m=[],g=[];for(let S=0;S<=u;S++)for(let v=0;v<=d;v++){const b=Math.cos(c*v/d)*(h+l*Math.cos(2*Math.PI*S/u)),w=Math.sin(2*Math.PI*S/u)*l,T=Math.sin(c*v/d)*(h+l*Math.cos(2*Math.PI*S/u)),E=Math.cos(c*v/d)*Math.cos(2*Math.PI*S/u),C=Math.sin(2*Math.PI*S/u),M=Math.sin(c*v/d)*Math.cos(2*Math.PI*S/u),O=S/u,I=1-v/d;if(p.push(b,w,T),_.push(E,C,M),m.push(O,1-I),S<u&&v<d){const B=S*(d+1)+v,P=(S+1)*(d+1)+v,D=S*(d+1)+(v+1),R=(S+1)*(d+1)+(v+1);g.push(B,P,D),g.push(P,R,D)}}const x={normals:_,uvs:m,uvs1:m,indices:g};return f&&(x.tangents=sn(p,_,m,g)),ks(o,p,x)}function _m(o,e,t,s,i,n){const r=new y,a=new y,l=new y,h=new y,c=new y,d=new y,u=[],f=[],p=[],_=[],m=[];let g;if(t>0)for(let x=0;x<=s;x++)for(let S=0;S<=i;S++){const v=S/i*2*Math.PI-Math.PI,b=Math.sin(v),w=Math.cos(v);c.set(b*o,-t/2,w*o),h.set(b*e,t/2,w*e),r.lerp(c,h,x/s),a.sub2(h,c).normalize(),d.set(w,0,-b),l.cross(d,a).normalize(),u.push(r.x,r.y,r.z),f.push(l.x,l.y,l.z);let T=S/i,E=x/s;p.push(T,1-E);const C=E;if(E=T,T=C,T=T*Ns+ms,E=E*Ns+ms,T/=3,_.push(T,1-E),x<s&&S<i){const M=x*(i+1)+S,O=x*(i+1)+(S+1),I=(x+1)*(i+1)+S,B=(x+1)*(i+1)+(S+1);m.push(M,O,I),m.push(O,B,I)}}if(n){const x=Math.floor(i/2),S=i,v=t/2;for(let b=0;b<=x;b++){const w=b*Math.PI*.5/x,T=Math.sin(w),E=Math.cos(w);for(let C=0;C<=S;C++){const M=C*2*Math.PI/S-Math.PI/2,O=Math.sin(M),B=Math.cos(M)*T,P=E,D=O*T;let R=1-C/S,A=1-b/x;u.push(B*e,P*e+v,D*e),f.push(B,P,D),p.push(R,1-A),R=R*Ns+ms,A=A*Ns+ms,R/=3,A/=3,R+=1/3,_.push(R,1-A)}}g=(s+1)*(i+1);for(let b=0;b<x;++b)for(let w=0;w<S;++w){const T=b*(S+1)+w,E=T+S+1;m.push(g+T+1,g+E,g+T),m.push(g+T+1,g+E+1,g+E)}for(let b=0;b<=x;b++){const w=Math.PI*.5+b*Math.PI*.5/x,T=Math.sin(w),E=Math.cos(w);for(let C=0;C<=S;C++){const M=C*2*Math.PI/S-Math.PI/2,O=Math.sin(M),B=Math.cos(M)*T,P=E,D=O*T;let R=1-C/S,A=1-b/x;u.push(B*e,P*e-v,D*e),f.push(B,P,D),p.push(R,1-A),R=R*Ns+ms,A=A*Ns+ms,R/=3,A/=3,R+=2/3,_.push(R,1-A)}}g=(s+1)*(i+1)+(S+1)*(x+1);for(let b=0;b<x;++b)for(let w=0;w<S;++w){const T=b*(S+1)+w,E=T+S+1;m.push(g+T+1,g+E,g+T),m.push(g+T+1,g+E+1,g+E)}}else{if(g=(s+1)*(i+1),o>0)for(let x=0;x<i;x++){const S=x/i*2*Math.PI,v=Math.sin(S),b=-t/2,w=Math.cos(S);let T=1-(v+1)/2,E=(w+1)/2;u.push(v*o,b,w*o),f.push(0,-1,0),p.push(T,1-E),T=T*Ns+ms,E=E*Ns+ms,T/=3,E/=3,T+=1/3,_.push(T,1-E),x>1&&m.push(g,g+x,g+x-1)}if(g+=i,e>0)for(let x=0;x<i;x++){const S=x/i*2*Math.PI,v=Math.sin(S),b=t/2,w=Math.cos(S);let T=1-(v+1)/2,E=(w+1)/2;u.push(v*e,b,w*e),f.push(0,1,0),p.push(T,1-E),T=T*Ns+ms,E=E*Ns+ms,T/=3,E/=3,T+=2/3,_.push(T,1-E),x>1&&m.push(g,g+x-1,g+x)}}return{positions:u,normals:f,uvs:p,uvs1:_,indices:m}}function gm(o,e={}){var t,s,i,n,r;const a=(t=e.radius)!=null?t:.5,l=(s=e.height)!=null?s:1,h=(i=e.heightSegments)!=null?i:5,c=(n=e.capSegments)!=null?n:20,d=(r=e.calculateTangents)!=null?r:!1,u=_m(a,a,l,h,c,!1);return d&&(u.tangents=sn(u.positions,u.normals,u.uvs,u.indices)),ks(o,u.positions,u)}function ym(o,e={}){var t,s,i,n,r;const a=(t=e.radius)!=null?t:.3,l=(s=e.height)!=null?s:1,h=(i=e.heightSegments)!=null?i:1,c=(n=e.sides)!=null?n:20,d=(r=e.calculateTangents)!=null?r:!1,u=_m(a,a,l-2*a,h,c,!0);return d&&(u.tangents=sn(u.positions,u.normals,u.uvs,u.indices)),ks(o,u.positions,u)}function vm(o,e={}){var t,s,i,n,r,a;const l=(t=e.baseRadius)!=null?t:.5,h=(s=e.peakRadius)!=null?s:0,c=(i=e.height)!=null?i:1,d=(n=e.heightSegments)!=null?n:5,u=(r=e.capSegments)!=null?r:18,f=(a=e.calculateTangents)!=null?a:!1,p=_m(l,h,c,d,u,!1);return f&&(p.tangents=sn(p.positions,p.normals,p.uvs,p.indices)),ks(o,p.positions,p)}function xm(o,e={}){var t,s,i,n;const r=(t=e.radius)!=null?t:.5,a=(s=e.latitudeBands)!=null?s:16,l=(i=e.longitudeBands)!=null?i:16,h=(n=e.calculateTangents)!=null?n:!1,c=[],d=[],u=[],f=[];for(let _=0;_<=a;_++){const m=_*Math.PI/a,g=Math.sin(m),x=Math.cos(m);for(let S=0;S<=l;S++){const v=S*2*Math.PI/l-Math.PI/2,b=Math.sin(v),T=Math.cos(v)*g,E=x,C=b*g,M=1-S/l,O=1-_/a;c.push(T*r,E*r,C*r),d.push(T,E,C),u.push(M,1-O)}}for(let _=0;_<a;++_)for(let m=0;m<l;++m){const g=_*(l+1)+m,x=g+l+1;f.push(g+1,x,g),f.push(g+1,x+1,x)}const p={normals:d,uvs:u,uvs1:u,indices:f};return h&&(p.tangents=sn(c,d,u,f)),ks(o,c,p)}function Sm(o,e={}){var t,s,i,n;const r=(t=e.halfExtents)!=null?t:new G(.5,.5),a=(s=e.widthSegments)!=null?s:5,l=(i=e.lengthSegments)!=null?i:5,h=(n=e.calculateTangents)!=null?n:!1,c=[],d=[],u=[],f=[];let p=0;for(let m=0;m<=a;m++)for(let g=0;g<=l;g++){const x=-r.x+2*r.x*m/a,S=0,v=-(-r.y+2*r.y*g/l),b=m/a,w=g/l;c.push(x,S,v),d.push(0,1,0),u.push(b,1-w),m<a&&g<l&&(f.push(p+l+1,p+1,p),f.push(p+l+1,p+l+2,p+1)),p++}const _={normals:d,uvs:u,uvs1:u,indices:f};return h&&(_.tangents=sn(c,d,u,f)),ks(o,c,_)}function Ho(o,e={}){var t,s,i,n,r,a;const l=(t=e.halfExtents)!=null?t:new y(.5,.5,.5),h=(s=e.widthSegments)!=null?s:1,c=(i=e.lengthSegments)!=null?i:1,d=(n=e.heightSegments)!=null?n:1,u=(r=e.calculateTangents)!=null?r:!1,f=(a=e.yOffset)!=null?a:0,p=-l.y+f,_=l.y+f,m=[new y(-l.x,p,l.z),new y(l.x,p,l.z),new y(l.x,_,l.z),new y(-l.x,_,l.z),new y(l.x,p,-l.z),new y(-l.x,p,-l.z),new y(-l.x,_,-l.z),new y(l.x,_,-l.z)],g=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],x=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],S={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},v=[],b=[],w=[],T=[],E=[];let C=0;const M=(I,B,P)=>{const D=new y,R=new y,A=new y,L=new y;for(let F=0;F<=B;F++)for(let N=0;N<=P;N++){D.lerp(m[g[I][0]],m[g[I][1]],F/B),R.lerp(m[g[I][0]],m[g[I][2]],N/P),A.sub2(R,m[g[I][0]]),L.add2(D,A);let V=F/B,k=N/P;v.push(L.x,L.y,L.z),b.push(x[I][0],x[I][1],x[I][2]),w.push(V,1-k),V=V*Ns+ms,k=k*Ns+ms,V/=3,k/=3,V+=I%3/3,k+=Math.floor(I/3)/3,T.push(V,1-k),F<B&&N<P&&(E.push(C+P+1,C+1,C),E.push(C+P+1,C+P+2,C+1)),C++}};M(S.FRONT,h,d),M(S.BACK,h,d),M(S.TOP,h,c),M(S.BOTTOM,h,c),M(S.RIGHT,c,d),M(S.LEFT,c,d);const O={normals:b,uvs:w,uvs1:T,indices:E};return u&&(O.tangents=sn(v,b,w,E)),ks(o,v,O)}function ax(o,e){let t=null;for(let s=0;s<Hh.length;s++)Hh[s].type===e&&Hh[s].device===o&&(t=Hh[s].primData);if(!t){let s,i;switch(e){case"box":s=Ho(o),i={x:2,y:2,z:2,uv:2/3};break;case"capsule":s=ym(o,{radius:.5,height:2}),i={x:Math.PI*2,y:Math.PI,z:Math.PI*2,uv:1/3+1/3/3*2};break;case"cone":s=vm(o,{baseRadius:.5,peakRadius:0,height:1}),i={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":s=gm(o,{radius:.5,height:1}),i={x:Math.PI,y:.79*2,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":s=Sm(o,{halfExtents:new G(.5,.5),widthSegments:1,lengthSegments:1}),i={x:0,y:1,z:0,uv:1};break;case"sphere":s=xm(o,{radius:.5}),i={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":s=mm(o,{tubeRadius:.2,ringRadius:.3}),i={x:Math.PI*.5*.5-Math.PI*.1*.1,y:.4,z:.4,uv:1};break;default:throw new Error("Invalid primitive type: "+e)}s.incRefCount(),t={mesh:s,area:i},Hh.push({type:e,device:o,primData:t})}return t}var TR=`
uniform float alpha_ref;
void alphaTest(float a) {
	if (a < alpha_ref) discard;
}
`,wR=`
void addAmbient(vec3 worldNormal) {
	dDiffuseLight += light_globalAmbient;
}
`,ER=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
void addAmbient(vec3 worldNormal) {
	vec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));
	vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
	vec4 raw = texture2D(texture_envAtlas, uv);
	vec3 linear = $DECODE(raw);
	dDiffuseLight += processEnvironment(linear);
}
`,AR=`
uniform vec3 ambientSH[9];
void addAmbient(vec3 worldNormal) {
	vec3 n = cubeMapRotate(worldNormal);
	vec3 color =
		ambientSH[0] +
		ambientSH[1] * n.x +
		ambientSH[2] * n.y +
		ambientSH[3] * n.z +
		ambientSH[4] * n.x * n.z +
		ambientSH[5] * n.z * n.y +
		ambientSH[6] * n.y * n.x +
		ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
		ambientSH[8] * (n.x * n.x - n.y * n.y);
	dDiffuseLight += processEnvironment(max(color, vec3(0.0)));
}
`,CR=`
void getAO() {
	dAo = 1.0;
	#ifdef MAPTEXTURE
	float aoBase = texture2DBias($SAMPLER, $UV, textureBias).$CH;
	dAo *= addAoDetail(aoBase);
	#endif
	#ifdef MAPVERTEX
	dAo *= saturate(vVertexColor.$VC);
	#endif
}
`,MR=`
float addAoDetail(float ao) {
#ifdef MAPTEXTURE
	float aoDetail = texture2DBias($SAMPLER, $UV, textureBias).$CH;
	return detailMode_$DETAILMODE(vec3(ao), vec3(aoDetail)).r;
#else
	return ao;
#endif
}
`,PR=`
void occludeDiffuse(float ao) {
	dDiffuseLight *= ao;
}
`,RR=`
uniform float material_occludeSpecularIntensity;
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	float specPow = exp2(gloss * 11.0);
	float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);
	specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);
	dSpecularLight *= specOcc;
	dReflection *= specOcc;
	
#ifdef LIT_SHEEN
	sSpecularLight *= specOcc;
	sReflection *= specOcc;
#endif
}
`,IR=`
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	float specPow = exp2(gloss * 11.0);
	float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);
	dSpecularLight *= specOcc;
	dReflection *= specOcc;
	
#ifdef LIT_SHEEN
	sSpecularLight *= specOcc;
	sReflection *= specOcc;
#endif
}
`,DR=`
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	dSpecularLight *= ao;
	dReflection *= ao;
#ifdef LIT_SHEEN
	sSpecularLight *= ao;
	sReflection *= ao;
#endif
}
`,LR=`
uniform float material_occludeSpecularIntensity;
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	float specOcc = mix(1.0, ao, material_occludeSpecularIntensity);
	dSpecularLight *= specOcc;
	dReflection *= specOcc;
#ifdef LIT_SHEEN
	sSpecularLight *= specOcc;
	sReflection *= specOcc;
#endif
}
`,FR=`
uniform vec3 view_position;
uniform vec3 light_globalAmbient;
float square(float x) {
	return x*x;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 saturate(vec3 x) {
	return clamp(x, vec3(0.0), vec3(1.0));
}
`,OR=`
attribute vec3 vertex_position;
attribute vec3 vertex_normal;
attribute vec4 vertex_tangent;
attribute vec2 vertex_texCoord0;
attribute vec2 vertex_texCoord1;
attribute vec4 vertex_color;
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
vec3 dPositionW;
mat4 dModelMatrix;
mat3 dNormalMatrix;
`,BR=`
#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,NR=`
#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
`,kR=`
#define NINESLICED
#define NINESLICETILED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,UR=`
float bayer2(vec2 p) {
	return mod(2.0 * p.y + p.x + 1.0, 4.0);
}
float bayer4(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	return 4.0 * bayer2(p1) + bayer2(p2);
}
float bayer8(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	vec2 p4 = floor(0.25 * mod(p, 8.0));
	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);
}
`,zR=`
#define SHADOWBIAS
#define SHADOW_SAMPLE_Z_BIAS
float getShadowBias(float resolution, float maxBias) {
	return maxBias;
}
`,VR=`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
#ifdef GAUSS
uniform float weight[SAMPLES];
#endif
#ifdef PACKED
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
#endif
void main(void) {
	vec3 moments = vec3(0.0);
	vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);
	for (int i=0; i<SAMPLES; i++) {
		vec4 c = texture2D(source, uv + pixelOffset * float(i));
		#ifdef PACKED
		c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));
		#endif
		#ifdef GAUSS
		moments += c.xyz * weight[i];
		#else
		moments += c.xyz;
		#endif
	}
	#ifndef GAUSS
	moments /= float(SAMPLES);
	#endif
	#ifdef PACKED
	gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));
	#else
	gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);
	#endif
}
`,GR=`
#ifdef MAPFLOAT
uniform float material_clearCoat;
#endif
void getClearCoat() {
	ccSpecularity = 1.0;
	#ifdef MAPFLOAT
	ccSpecularity *= material_clearCoat;
	#endif
	#ifdef MAPTEXTURE
	ccSpecularity *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	ccSpecularity *= saturate(vVertexColor.$VC);
	#endif
}
`,WR=`
#ifdef MAPFLOAT
uniform float material_clearCoatGloss;
#endif
void getClearCoatGlossiness() {
	ccGlossiness = 1.0;
	#ifdef MAPFLOAT
	ccGlossiness *= material_clearCoatGloss;
	#endif
	#ifdef MAPTEXTURE
	ccGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	ccGlossiness *= saturate(vVertexColor.$VC);
	#endif
	#ifdef MAPINVERT
	ccGlossiness = 1.0 - ccGlossiness;
	#endif
	ccGlossiness += 0.0000001;
}
`,HR=`
#ifdef MAPTEXTURE
uniform float material_clearCoatBumpiness;
#endif
void getClearCoatNormal() {
#ifdef MAPTEXTURE
	vec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);
	ccNormalW = normalize(dTBN * normalMap);
#else
	ccNormalW = dVertexNormalW;
#endif
}
`,XR=`
vec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)
{
	vec3 vAbs = abs(dir);
	float ma;
	vec2 uv;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		faceIndex = dir.z < 0.0 ? 5.0 : 4.0;
		ma = 0.5 / vAbs.z;
		uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);
		tileOffset.x = 2.0;
		tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;
	} else if(vAbs.y >= vAbs.x) {
		faceIndex = dir.y < 0.0 ? 3.0 : 2.0;
		ma = 0.5 / vAbs.y;
		uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);
		tileOffset.x = 1.0;
		tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;
	} else {
		faceIndex = dir.x < 0.0 ? 1.0 : 0.0;
		ma = 0.5 / vAbs.x;
		uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);
		tileOffset.x = 0.0;
		tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;
	}
	return uv * ma + 0.5;
}
vec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {
	float faceIndex;
	vec2 tileOffset;
	vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);
	float atlasFaceSize = omniAtlasViewport.z;
	float tileSize = shadowTextureResolution * atlasFaceSize;
	float offset = shadowEdgePixels / tileSize;
	uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);
	uv *= atlasFaceSize;
	uv += tileOffset * atlasFaceSize;
	uv += omniAtlasViewport.xy;
	return uv;
}
`,$R=`
vec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {
	vec4 pixel = mix(vec4(1.0), texture2DLodEXT(tex, uv, 0.0), intensity);
	return isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));
}
vec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {
	vec4 projPos = transform * vec4(worldPosition, 1.0);
	return _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, isRgb, cookieChannel);
}
vec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, isRgb, cookieChannel);
}
`,qR=`
void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {
	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);
	projPos.xyz /= projPos.w;
	dShadowCoord = projPos.xyz;
}
void getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {
	vec3 wPos = vPositionW + normal * shadowParams.y;
	_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
vec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
	float distScale = length(lightDir);
	vec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
	vec3 dir = wPos - lightPos;
	return dir;
}
#ifdef GL2
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		return textureShadow(shadowMap, vec3(uv, shadowZ));
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		vec3 shadowCoord = vec3(uv, shadowZ);
		return getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		vec3 shadowCoord = vec3(uv, shadowZ);
		return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
	}
	#endif
#else
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowOmniClusteredPCF1(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float depth = unpackFloat(textureShadow(shadowMap, uv));
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		return depth > shadowZ ? 1.0 : 0.0;
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowOmniClusteredPCF3(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		vec3 shadowCoord = vec3(uv, shadowZ);
		return getShadowPCF3x3(shadowMap, shadowCoord, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowOmniClusteredPCF5(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
		vec3 shadowCoord = vec3(uv, shadowZ);
		return getShadowPCF3x3(shadowMap, shadowCoord, shadowParams);
	}
	#endif
#endif
#ifdef GL2
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
		return textureShadow(shadowMap, shadowCoord);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
		return getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
		return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
	}
	#endif
#else
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowSpotClusteredPCF1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
		float depth = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));
		return depth > shadowCoord.z ? 1.0 : 0.0;
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowSpotClusteredPCF3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
		return getShadowSpotPCF3x3(shadowMap, shadowCoord, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowSpotClusteredPCF5(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
		return getShadowSpotPCF3x3(shadowMap, shadowCoord, shadowParams);
	}
	#endif
#endif
`,jR=`
uniform highp sampler2D clusterWorldTexture;
uniform highp sampler2D lightsTexture8;
uniform highp sampler2D lightsTextureFloat;
#if defined(CLUSTER_COOKIES)
	#define CLUSTER_COOKIES_OR_SHADOWS
#endif
#if defined(CLUSTER_SHADOWS)
	#define CLUSTER_COOKIES_OR_SHADOWS
#endif
#ifdef CLUSTER_SHADOWS
	#ifdef GL2
		uniform sampler2DShadow shadowAtlasTexture;
	#else
		uniform sampler2D shadowAtlasTexture;
	#endif
#endif
#ifdef CLUSTER_COOKIES
	uniform sampler2D cookieAtlasTexture;
#endif
#ifdef GL2
	uniform int clusterMaxCells;
#else
	uniform float clusterMaxCells;
	uniform vec4 lightsTextureInvSize;
#endif
uniform float clusterSkip;
uniform vec3 clusterCellsCountByBoundsSize;
uniform vec3 clusterTextureSize;
uniform vec3 clusterBoundsMin;
uniform vec3 clusterBoundsDelta;
uniform vec3 clusterCellsDot;
uniform vec3 clusterCellsMax;
uniform vec2 clusterCompressionLimit0;
uniform vec2 shadowAtlasParams;
struct ClusterLightData {
	vec3 halfWidth;
	float lightType;
	vec3 halfHeight;
	#ifdef GL2
		int lightIndex;
	#else
		float lightV;
	#endif
	vec3 position;
	float shape;
	vec3 direction;
	float falloffMode;
	vec3 color;
	float shadowIntensity;
	vec3 omniAtlasViewport;
	float range;
	vec4 cookieChannelMask;
	float shadowBias;
	float shadowNormalBias;
	float innerConeAngleCos;
	float outerConeAngleCos;
	float cookie;
	float cookieRgb;
	float cookieIntensity;
	float mask;
};
mat4 lightProjectionMatrix;
#define isClusteredLightCastShadow(light) ( light.shadowIntensity > 0.0 )
#define isClusteredLightCookie(light) (light.cookie > 0.5 )
#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )
#define isClusteredLightSpot(light) ( light.lightType > 0.5 )
#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )
#define isClusteredLightArea(light) ( light.shape > 0.1 )
#define isClusteredLightRect(light) ( light.shape < 0.3 )
#define isClusteredLightDisk(light) ( light.shape < 0.6 )
#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
	#define acceptLightMask(light) ( light.mask < 0.75)
#else
	#define acceptLightMask(light) ( light.mask > 0.25)
#endif
vec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {
	return vec4(
		bytes2floatRange4(d0, -2.0, 2.0),
		bytes2floatRange4(d1, -2.0, 2.0),
		bytes2floatRange4(d2, -2.0, 2.0),
		bytes2floatRange4(d3, -2.0, 2.0)
	);
}
#ifdef GL2
	vec4 sampleLightsTexture8(const ClusterLightData clusterLightData, int index) {
		return texelFetch(lightsTexture8, ivec2(index, clusterLightData.lightIndex), 0);
	}
	vec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {
		return texelFetch(lightsTextureFloat, ivec2(index, clusterLightData.lightIndex), 0);
	}
#else
	vec4 sampleLightsTexture8(const ClusterLightData clusterLightData, float index) {
		return texture2DLodEXT(lightsTexture8, vec2(index * lightsTextureInvSize.z, clusterLightData.lightV), 0.0);
	}
	vec4 sampleLightTextureF(const ClusterLightData clusterLightData, float index) {
		return texture2DLodEXT(lightsTextureFloat, vec2(index * lightsTextureInvSize.x, clusterLightData.lightV), 0.0);
	}
#endif
void decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {
	#ifdef GL2
		clusterLightData.lightIndex = int(lightIndex);
	#else
		clusterLightData.lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;
	#endif
	vec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);
	clusterLightData.lightType = lightInfo.x;
	clusterLightData.shape = lightInfo.y;
	clusterLightData.falloffMode = lightInfo.z;
	clusterLightData.shadowIntensity = lightInfo.w;
	vec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);
	vec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);
	clusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;
	clusterLightData.cookie = colorB.z;
	clusterLightData.mask = colorB.w;
	#ifdef CLUSTER_TEXTURE_FLOAT
		vec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);
		clusterLightData.position = lightPosRange.xyz;
		clusterLightData.range = lightPosRange.w;
		vec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);
		clusterLightData.direction = lightDir_Unused.xyz;
	#else
		vec4 encPosX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_X);
		vec4 encPosY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Y);
		vec4 encPosZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Z);
		clusterLightData.position = vec3(bytes2float4(encPosX), bytes2float4(encPosY), bytes2float4(encPosZ)) * clusterBoundsDelta + clusterBoundsMin;
		vec4 encRange = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_RANGE);
		clusterLightData.range = bytes2float4(encRange) * clusterCompressionLimit0.x;
		vec4 encDirX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_X);
		vec4 encDirY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Y);
		vec4 encDirZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Z);
		clusterLightData.direction = vec3(bytes2float4(encDirX), bytes2float4(encDirY), bytes2float4(encDirZ)) * 2.0 - 1.0;
	#endif
}
void decodeClusterLightSpot(inout ClusterLightData clusterLightData) {
	vec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);
	clusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;
	clusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;
}
void decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {
	#ifdef CLUSTER_TEXTURE_FLOAT
		clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;
	#else
		vec4 viewportA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_A);
		vec4 viewportB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_B);
		clusterLightData.omniAtlasViewport = vec3(bytes2float2(viewportA.xy), bytes2float2(viewportA.zw), bytes2float2(viewportB.xy));
	#endif
}
void decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {
	#ifdef CLUSTER_TEXTURE_FLOAT
		clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;
		clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;
	#else
		vec4 areaWidthX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_X);
		vec4 areaWidthY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Y);
		vec4 areaWidthZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Z);
		clusterLightData.halfWidth = vec3(mantissaExponent2Float(areaWidthX), mantissaExponent2Float(areaWidthY), mantissaExponent2Float(areaWidthZ));
		vec4 areaHeightX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_X);
		vec4 areaHeightY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Y);
		vec4 areaHeightZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Z);
		clusterLightData.halfHeight = vec3(mantissaExponent2Float(areaHeightX), mantissaExponent2Float(areaHeightY), mantissaExponent2Float(areaHeightZ));
	#endif
}
void decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {
	
	#ifdef CLUSTER_TEXTURE_FLOAT
		vec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);
		vec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);
		vec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);
		vec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);
	#else
		vec4 m00 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_00);
		vec4 m01 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_01);
		vec4 m02 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_02);
		vec4 m03 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_03);
		vec4 m0 = decodeClusterLowRange4Vec4(m00, m01, m02, m03);
		vec4 m10 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_10);
		vec4 m11 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_11);
		vec4 m12 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_12);
		vec4 m13 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_13);
		vec4 m1 = decodeClusterLowRange4Vec4(m10, m11, m12, m13);
		vec4 m20 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_20);
		vec4 m21 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_21);
		vec4 m22 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_22);
		vec4 m23 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_23);
		vec4 m2 = decodeClusterLowRange4Vec4(m20, m21, m22, m23);
		vec4 m30 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_30);
		vec4 m31 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_31);
		vec4 m32 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_32);
		vec4 m33 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_33);
		vec4 m3 = vec4(mantissaExponent2Float(m30), mantissaExponent2Float(m31), mantissaExponent2Float(m32), mantissaExponent2Float(m33));
	#endif
	
	lightProjectionMatrix = mat4(m0, m1, m2, m3);
}
void decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {
	
	vec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);
	clusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),
	clusterLightData.shadowNormalBias = bytes2float2(biases.zw);
}
void decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {
	vec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);
	clusterLightData.cookieIntensity = cookieA.x;
	clusterLightData.cookieRgb = cookieA.y;
	clusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);
}
void evaluateLight(
	ClusterLightData light, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir,
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	vec3 cookieAttenuation = vec3(1.0);
	float diffuseAttenuation = 1.0;
	float falloffAttenuation = 1.0;
	getLightDirPoint(light.position);
	#ifdef CLUSTER_AREALIGHTS
	if (isClusteredLightArea(light)) {
		decodeClusterLightAreaData(light);
		if (isClusteredLightRect(light)) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (isClusteredLightDisk(light)) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		falloffAttenuation = getFalloffWindow(light.range, dLightDirW);
	} else
	#endif
	{
		if (isClusteredLightFalloffLinear(light))
			falloffAttenuation = getFalloffLinear(light.range, dLightDirW);
		else
			falloffAttenuation = getFalloffInvSquared(light.range, dLightDirW);
	}
	if (falloffAttenuation > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (isClusteredLightArea(light)) {
			if (isClusteredLightRect(light)) {
				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;
			} else if (isClusteredLightDisk(light)) {
				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;
			} else {
				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;
			}
		} else
		#endif
		{
			falloffAttenuation *= getLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW); 
		}
		if (isClusteredLightSpot(light)) {
			decodeClusterLightSpot(light);
			falloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, dLightDirNormW);
		}
		#if defined(CLUSTER_COOKIES_OR_SHADOWS)
		if (falloffAttenuation > 0.00001) {
			if (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {
				if (isClusteredLightSpot(light)) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				float shadowTextureResolution = shadowAtlasParams.x;
				float shadowEdgePixels = shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (isClusteredLightCookie(light)) {
					decodeClusterLightCookieData(light);
					if (isClusteredLightSpot(light)) {
						cookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);
					} else {
						cookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (isClusteredLightCastShadow(light)) {
					decodeClusterLightShadowData(light);
					vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (isClusteredLightSpot(light)) {
						getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);
						
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)
							float shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					} else {
						vec3 dir = normalOffsetPointShadow(shadowParams, dLightPosW, dLightDirW, dLightDirNormW, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (isClusteredLightArea(light)) {
			{
				vec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;
				#if defined(LIT_SPECULAR)
					#if defined(LIT_CONSERVE_ENERGY)
						areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);
					#endif
				#endif
				dDiffuseLight += areaDiffuse;
			}
			#ifdef LIT_SPECULAR
				float areaLightSpecular;
				if (isClusteredLightRect(light)) {
					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);
				} else if (isClusteredLightDisk(light)) {
					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);
				} else {
					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);
				}
				dSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;
				#ifdef LIT_CLEARCOAT
					float areaLightSpecularCC;
					if (isClusteredLightRect(light)) {
						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);
					} else if (isClusteredLightDisk(light)) {
						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);
					} else {
						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);
					}
					ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;
				#endif
			#endif
		} else
		#endif
		{
			{
				vec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;
				#if defined(CLUSTER_AREALIGHTS)
				#if defined(LIT_SPECULAR)
				#if defined(LIT_CONSERVE_ENERGY)
					punctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);
				#endif
				#endif
				#endif
				dDiffuseLight += punctualDiffuse;
			}
	 
			#ifdef LIT_SPECULAR
				vec3 halfDir = normalize(-dLightDirNormW + viewDir);
				
				#ifdef LIT_SPECULAR_FRESNEL
					dSpecularLight += 
						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * 
						getFresnel(
							dot(viewDir, halfDir), 
							gloss, 
							specularity
						#if defined(LIT_IRIDESCENCE)
							, iridescenceFresnel,
							iridescence_intensity
						#endif
							);
				#else
					dSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;
				#endif
				#ifdef LIT_CLEARCOAT
					#ifdef LIT_SPECULAR_FRESNEL
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));
					#else
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; 
					#endif
				#endif
				#ifdef LIT_SHEEN
					sSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, dLightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;
				#endif
			#endif
		}
	}
	dAtten = falloffAttenuation;
	dAttenD = diffuseAttenuation;
	dAtten3 = cookieAttenuation;
}
void evaluateClusterLight(
	float lightIndex, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	ClusterLightData clusterLightData;
	decodeClusterLightCore(clusterLightData, lightIndex);
	if (acceptLightMask(clusterLightData))
		evaluateLight(
			clusterLightData, 
			worldNormal, 
			viewDir, 
			reflectionDir, 
#if defined(LIT_CLEARCOAT)
			clearcoatReflectionDir, 
#endif
			gloss, 
			specularity, 
			geometricNormal, 
			tbn, 
#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel,
#endif
			clearcoat_worldNormal,
			clearcoat_gloss,
			sheen_gloss,
			iridescence_intensity
		);
}
void addClusteredLights(
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	if (clusterSkip > 0.5)
		return;
	vec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);
	if (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {
		float cellIndex = dot(clusterCellsDot, cellCoords);
		float clusterV = floor(cellIndex * clusterTextureSize.y);
		float clusterU = cellIndex - (clusterV * clusterTextureSize.x);
		#ifdef GL2
			for (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {
				float lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;
				if (lightIndex <= 0.0)
						return;
				evaluateClusterLight(
					lightIndex * 255.0, 
					worldNormal, 
					viewDir, 
					reflectionDir,
#if defined(LIT_CLEARCOAT)
					clearcoatReflectionDir,
#endif
					gloss, 
					specularity, 
					geometricNormal, 
					tbn, 
#if defined(LIT_IRIDESCENCE)
					iridescenceFresnel,
#endif
					clearcoat_worldNormal,
					clearcoat_gloss,
					sheen_gloss,
					iridescence_intensity
				); 
			}
		#else
			clusterV = (clusterV + 0.5) * clusterTextureSize.z;
			const float maxLightCells = 256.0;
			for (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {
				float lightIndex = texture2DLodEXT(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV), 0.0).x;
				if (lightIndex <= 0.0)
					return;
				
				evaluateClusterLight(
					lightIndex * 255.0, 
					worldNormal, 
					viewDir, 
					reflectionDir,
#if defined(LIT_CLEARCOAT)
					clearcoatReflectionDir,
#endif
					gloss, 
					specularity, 
					geometricNormal, 
					tbn, 
#if defined(LIT_IRIDESCENCE)
					iridescenceFresnel,
#endif
					clearcoat_worldNormal,
					clearcoat_gloss,
					sheen_gloss,
					iridescence_intensity
				); 
				if (lightCellIndex >= clusterMaxCells) {
					break;
				}
			}
		#endif
	}
}
`,YR=`
vec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {
	vec3 ret = vec3(0);
#ifdef LIT_OLD_AMBIENT
	ret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;
#else
	ret += albedo * dDiffuseLight;
#endif
#ifdef LIT_SPECULAR
	ret += dSpecularLight;
#endif
#ifdef LIT_REFLECTIONS
	ret += dReflection.rgb * dReflection.a;
#endif
#ifdef LIT_SHEEN
	float sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
	ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
#endif
#ifdef LIT_CLEARCOAT
	float clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;
	ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;
#endif
	return ret;
}
`,KR=`
vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {
	return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);
}
`,ZR=`
uniform vec3 envBoxMin;
uniform vec3 envBoxMax;
vec3 cubeMapProject(vec3 nrdir) {
	nrdir = cubeMapRotate(nrdir);
	vec3 rbmax = (envBoxMax - vPositionW) / nrdir;
	vec3 rbmin = (envBoxMin - vPositionW) / nrdir;
	vec3 rbminmax;
	rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;
	rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;
	rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;
	float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
	vec3 posonbox = vPositionW + nrdir * fa;
	vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;
	return normalize(posonbox - envBoxPos);
}
`,QR=`
vec3 cubeMapProject(vec3 dir) {
	return cubeMapRotate(dir);
}
`,JR=`
#ifdef CUBEMAP_ROTATION
uniform mat3 cubeMapRotationMatrix;
#endif
vec3 cubeMapRotate(vec3 refDir) {
#ifdef CUBEMAP_ROTATION
	return refDir * cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`,eI=`
#ifdef DEBUG_ALBEDO_PASS
gl_FragColor = vec4(gammaCorrectOutput(litArgs_albedo), 1.0);
#endif
#ifdef DEBUG_UV0_PASS
gl_FragColor = vec4(litArgs_albedo , 1.0);
#endif
#ifdef DEBUG_WORLD_NORMAL_PASS
gl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif
#ifdef DEBUG_OPACITY_PASS
gl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);
#endif
#ifdef DEBUG_SPECULARITY_PASS
gl_FragColor = vec4(litArgs_specularity, 1.0);
#endif
#ifdef DEBUG_GLOSS_PASS
gl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);
#endif
#ifdef DEBUG_METALNESS_PASS
gl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);
#endif
#ifdef DEBUG_AO_PASS
gl_FragColor = vec4(vec3(litArgs_ao) , 1.0);
#endif
#ifdef DEBUG_EMISSION_PASS
gl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`,tI=`
#ifdef DEBUG_LIGHTING_PASS
litArgs_albedo = vec3(0.5);
#endif
#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
litArgs_albedo = vec3(vUv0, 0);
#else
litArgs_albedo = vec3(0);
#endif
#endif
`,ox=`
vec3 decodeLinear(vec4 raw) {
	return raw.rgb;
}
float decodeGamma(float raw) {
	return pow(raw, 2.2);
}
vec3 decodeGamma(vec3 raw) {
	return pow(raw, vec3(2.2));
}
vec3 decodeGamma(vec4 raw) {
	return pow(raw.xyz, vec3(2.2));
}
vec3 decodeRGBM(vec4 raw) {
	vec3 color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
vec3 decodeRGBP(vec4 raw) {
	vec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);
	return color * color;
}
vec3 decodeRGBE(vec4 raw) {
	if (raw.a == 0.0) {
		return vec3(0.0, 0.0, 0.0);
	} else {
		return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);
	}
}
vec4 passThrough(vec4 raw) {
	return raw;
}
`,sI=`
vec3 detailMode_mul(vec3 c1, vec3 c2) {
	return c1 * c2;
}
vec3 detailMode_add(vec3 c1, vec3 c2) {
	return c1 + c2;
}
vec3 detailMode_screen(vec3 c1, vec3 c2) {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
vec3 detailMode_overlay(vec3 c1, vec3 c2) {
	return mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));
}
vec3 detailMode_min(vec3 c1, vec3 c2) {
	return min(c1, c2);
}
vec3 detailMode_max(vec3 c1, vec3 c2) {
	return max(c1, c2);
}
`,iI=`
#ifdef MAPCOLOR
uniform vec3 material_diffuse;
#endif
void getAlbedo() {
	dAlbedo = vec3(1.0);
#ifdef MAPCOLOR
	dAlbedo *= material_diffuse.rgb;
#endif
#ifdef MAPTEXTURE
	vec3 albedoBase = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	dAlbedo *= addAlbedoDetail(albedoBase);
#endif
#ifdef MAPVERTEX
	dAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));
#endif
}
`,nI=`
vec3 addAlbedoDetail(vec3 albedo) {
#ifdef MAPTEXTURE
	vec3 albedoDetail = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	return detailMode_$DETAILMODE(albedo, albedoDetail);
#else
	return albedo;
#endif
}
`,rI=`
#ifdef MAPCOLOR
uniform vec3 material_emissive;
#endif
#ifdef MAPFLOAT
uniform float material_emissiveIntensity;
#endif
void getEmission() {
	dEmission = vec3(1.0);
	#ifdef MAPFLOAT
	dEmission *= material_emissiveIntensity;
	#endif
	#ifdef MAPCOLOR
	dEmission *= material_emissive;
	#endif
	#ifdef MAPTEXTURE
	dEmission *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	#endif
	#ifdef MAPVERTEX
	dEmission *= gammaCorrectInput(saturate(vVertexColor.$VC));
	#endif
}
`,lx=`
vec4 encodeLinear(vec3 source) {
	return vec4(source, 1.0);
}
vec4 encodeGamma(vec3 source) {
	return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);
}
vec4 encodeRGBM(vec3 source) {
	vec4 result;
	result.rgb = pow(source.rgb, vec3(0.5));
	result.rgb *= 1.0 / 8.0;
	result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );
	result.a = ceil(result.a * 255.0) / 255.0;
	result.rgb /= result.a;
	return result;
}
vec4 encodeRGBP(vec3 source) {
	vec3 gamma = pow(source, vec3(0.5));
	float maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));
	float v = 1.0 - ((maxVal - 1.0) / 7.0);
	v = ceil(v * 255.0) / 255.0;
	return vec4(gamma / (-v * 7.0 + 8.0), v);	
}
vec4 encodeRGBE(vec3 source) {
	float maxVal = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4(0, 0, 0, 0);
	} else {
		float e = ceil(log2(maxVal));
		return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
`,aI=`
	gl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);
	gl_FragColor.rgb += litArgs_emission;
	gl_FragColor.rgb = addFog(gl_FragColor.rgb);
	#ifndef HDR
	gl_FragColor.rgb = toneMap(gl_FragColor.rgb);
	gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);
	#endif
`,oI=`
`,lI=`
const float atlasSize = 512.0;
const float seamSize = 1.0 / atlasSize;
vec2 mapUv(vec2 uv, vec4 rect) {
	return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
vec2 mapRoughnessUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));
}
vec2 mapShinyUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));
}
`,hI=`
vec3 processEnvironment(vec3 color) {
	return color;
}
`,cI=`
uniform float skyboxIntensity;
vec3 processEnvironment(vec3 color) {
	return color * skyboxIntensity;
}
`,dI=`
`,uI=`
`,fI=`
float getFalloffWindow(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float invRadius = 1.0 / lightRadius;
	return square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );
}
float getFalloffInvSquared(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float falloff = 1.0 / (sqrDist + 1.0);
	float invRadius = 1.0 / lightRadius;
	falloff *= 16.0;
	falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );
	return falloff;
}
`,pI=`
float getFalloffLinear(float lightRadius, vec3 lightDir) {
	float d = length(lightDir);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`,mI=`
vec3 fixSeams(vec3 vec, float mipmapIndex) {
	return vec;
}
vec3 fixSeams(vec3 vec) {
	return vec;
}
vec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {
	return vec;
}
vec3 calcSeam(vec3 vec) {
	return vec3(0);
}
vec3 applySeam(vec3 vec, vec3 seam, float scale) {
	return vec;
}
`,_I=`
vec3 fixSeams(vec3 vec, float mipmapIndex) {
	vec3 avec = abs(vec);
	float scale = 1.0 - exp2(mipmapIndex) / 128.0;
	float M = max(max(avec.x, avec.y), avec.z);
	if (avec.x != M) vec.x *= scale;
	if (avec.y != M) vec.y *= scale;
	if (avec.z != M) vec.z *= scale;
	return vec;
}
vec3 fixSeams(vec3 vec) {
	vec3 avec = abs(vec);
	float scale = 1.0 - 1.0 / 128.0;
	float M = max(max(avec.x, avec.y), avec.z);
	if (avec.x != M) vec.x *= scale;
	if (avec.y != M) vec.y *= scale;
	if (avec.z != M) vec.z *= scale;
	return vec;
}
vec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {
	vec3 avec = abs(vec);
	float scale = invRecMipSize;
	float M = max(max(avec.x, avec.y), avec.z);
	if (avec.x != M) vec.x *= scale;
	if (avec.y != M) vec.y *= scale;
	if (avec.z != M) vec.z *= scale;
	return vec;
}
vec3 calcSeam(vec3 vec) {
	vec3 avec = abs(vec);
	float M = max(avec.x, max(avec.y, avec.z));
	return vec3(avec.x != M ? 1.0 : 0.0,
				avec.y != M ? 1.0 : 0.0,
				avec.z != M ? 1.0 : 0.0);
}
vec3 applySeam(vec3 vec, vec3 seam, float scale) {
	return vec * (seam * -scale + vec3(1.0));
}
`,gI=`
float bytes2float2(vec2 data) {
	return dot(data, vec2(1.0, 1.0 / 255.0));
}
float bytes2float3(vec3 data) {
	return dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));
}
float bytes2float4(vec4 data) {
	return dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));
}
float bytes2floatRange2(vec2 data, float min, float max) {
	return mix(min, max, bytes2float2(data));
}
float bytes2floatRange3(vec3 data, float min, float max) {
	return mix(min, max, bytes2float3(data));
}
float bytes2floatRange4(vec4 data, float min, float max) {
	return mix(min, max, bytes2float4(data));
}
float mantissaExponent2Float(vec4 pack)
{
	float value = bytes2floatRange3(pack.xyz, -1.0, 1.0);
	float exponent = floor(pack.w * 255.0 - 127.0);
	return value * exp2(exponent);
}
`,yI=`
uniform vec3 fog_color;
uniform float fog_density;
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = exp(-depth * fog_density);
	fogFactor = clamp(fogFactor, 0.0, 1.0);
	return mix(fog_color * dBlendModeFogFactor, color, fogFactor);
}
`,vI=`
uniform vec3 fog_color;
uniform float fog_density;
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = exp(-depth * depth * fog_density * fog_density);
	fogFactor = clamp(fogFactor, 0.0, 1.0);
	return mix(fog_color * dBlendModeFogFactor, color, fogFactor);
}
`,xI=`
uniform vec3 fog_color;
uniform float fog_start;
uniform float fog_end;
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = (fog_end - depth) / (fog_end - fog_start);
	fogFactor = clamp(fogFactor, 0.0, 1.0);
	return mix(fog_color * dBlendModeFogFactor, color, fogFactor);
}
`,SI=`
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	return color;
}
`,bI=`
vec3 getFresnel(
		float cosTheta, 
		float gloss, 
		vec3 specularity
#if defined(LIT_IRIDESCENCE)
		, vec3 iridescenceFresnel, 
		float iridescenceIntensity
#endif
	) {
	float fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);
	float glossSq = gloss * gloss;
	vec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;
#if defined(LIT_IRIDESCENCE)
	return mix(ret, iridescenceFresnel, iridescenceIntensity);
#else
	return ret;
#endif	
}
float getFresnelCC(float cosTheta) {
	float fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);
	return 0.04 + (1.0 - 0.04) * fresnel;
}
`,TI=`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,wI=`
attribute vec2 vertex_position;
varying vec2 vUv0;
void main(void)
{
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = vertex_position.xy*0.5+0.5;
}
`,EI=`
float gammaCorrectInput(float color) {
	return color;
}
vec3 gammaCorrectInput(vec3 color) {
	return color;
}
vec4 gammaCorrectInput(vec4 color) {
	return color;
}
vec3 gammaCorrectOutput(vec3 color) {
	return color;
}
`,AI=`
float gammaCorrectInput(float color) {
	return decodeGamma(color);
}
vec3 gammaCorrectInput(vec3 color) {
	return decodeGamma(color);
}
vec4 gammaCorrectInput(vec4 color) {
	return vec4(decodeGamma(color.xyz), color.w);
}
vec3 gammaCorrectOutput(vec3 color) {
#ifdef HDR
	return color;
#else
	return pow(color + 0.0000001, vec3(1.0 / 2.2));
#endif
}
`,CI=`
#ifdef MAPFLOAT
uniform float material_gloss;
#endif
void getGlossiness() {
	dGlossiness = 1.0;
	#ifdef MAPFLOAT
	dGlossiness *= material_gloss;
	#endif
	#ifdef MAPTEXTURE
	dGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dGlossiness *= saturate(vVertexColor.$VC);
	#endif
	#ifdef MAPINVERT
	dGlossiness = 1.0 - dGlossiness;
	#endif
	dGlossiness += 0.0000001;
}
`,MI=`
uniform float material_iridescenceRefractionIndex;
#ifndef PI
#define PI 3.14159265
#endif
float iridescence_iorToFresnel(float transmittedIor, float incidentIor) {
	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);
}
vec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {
	return pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));
}
vec3 iridescence_fresnelToIor(vec3 f0) {
	vec3 sqrtF0 = sqrt(f0);
	return (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);
}
vec3 iridescence_sensitivity(float opd, vec3 shift) {
	float phase = 2.0 * PI * opd * 1.0e-9;
	const vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);
	const vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);
	const vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);
	vec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);
	xyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));
	xyz /= vec3(1.0685e-07);
	const mat3 XYZ_TO_REC709 = mat3(
		3.2404542, -0.9692660,  0.0556434,
	   -1.5371385,  1.8760108, -0.2040259,
	   -0.4985314,  0.0415560,  1.0572252
	);
	return XYZ_TO_REC709 * xyz;
}
float iridescence_fresnel(float cosTheta, float f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2;
	return f0 + (1.0 - f0) * x5;
} 
vec3 iridescence_fresnel(float cosTheta, vec3 f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2; 
	return f0 + (vec3(1.0) - f0) * x5;
}
vec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {
	float iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));
	float sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));
	float cosTheta2Sq = 1.0 - sinTheta2Sq;
	if (cosTheta2Sq < 0.0) {
		return vec3(1.0);
	}
	float cosTheta2 = sqrt(cosTheta2Sq);
	float r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);
	float r12 = iridescence_fresnel(cosTheta, r0);
	float r21 = r12;
	float t121 = 1.0 - r12;
	float phi12 = iridescenceIor < outsideIor ? PI : 0.0;
	float phi21 = PI - phi12;
	vec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));
	vec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);
	vec3 r23 = iridescence_fresnel(cosTheta2, r1);
	vec3 phi23 = vec3(0.0);
	if (baseIor[0] < iridescenceIor) phi23[0] = PI;
	if (baseIor[1] < iridescenceIor) phi23[1] = PI;
	if (baseIor[2] < iridescenceIor) phi23[2] = PI;
	float opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;
	vec3 phi = vec3(phi21) + phi23; 
	vec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);
	vec3 r123 = sqrt(r123Sq);
	vec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);
	vec3 c0 = r12 + rs;
	vec3 i = c0;
	vec3 cm = rs - t121;
	for (int m = 1; m <= 2; m++) {
		cm *= r123;
		vec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);
		i += cm * sm;
	}
	return max(i, vec3(0.0));
}
vec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {
	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);
}
`,PI=`
#ifdef MAPFLOAT
uniform float material_iridescence;
#endif
void getIridescence() {
	float iridescence = 1.0;
	#ifdef MAPFLOAT
	iridescence *= material_iridescence;
	#endif
	#ifdef MAPTEXTURE
	iridescence *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	dIridescence = iridescence; 
}
`,RI=`
uniform float material_iridescenceThicknessMax;
#ifdef MAPTEXTURE
uniform float material_iridescenceThicknessMin;
#endif
void getIridescenceThickness() {
	#ifdef MAPTEXTURE
	float blend = texture2DBias($SAMPLER, $UV, textureBias).$CH;
	float iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);
	#else
	float iridescenceThickness = material_iridescenceThicknessMax;
	#endif
	dIridescenceThickness = iridescenceThickness; 
}
`,II=`
attribute vec4 instance_line1;
attribute vec4 instance_line2;
attribute vec4 instance_line3;
attribute vec4 instance_line4;
`,DI=`
#ifdef MAPFLOAT
uniform float material_refractionIndex;
#endif
void getIor() {
#ifdef MAPFLOAT
	dIor = material_refractionIndex;
#else
	dIor = 1.0 / 1.5;
#endif
}
`,LI=`
float getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return max(dot(worldNormal, -lightDirNorm), 0.0);
}
`,FI=`
void getLightDirPoint(vec3 lightPosW) {
	dLightDirW = vPositionW - lightPosW;
	dLightDirNormW = normalize(dLightDirW);
	dLightPosW = lightPosW;
}
`,OI=`
void addLightMap(
	vec3 lightmap, 
	vec3 dir, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
	float gloss, 
	vec3 specularity, 
	vec3 vertexNormal, 
	mat3 tbn
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel, 
	float iridescenceIntensity
#endif
) {
	dDiffuseLight += lightmap;
}
`,BI=`
void addLightMap(
	vec3 lightmap, 
	vec3 dir, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
	float gloss, 
	vec3 specularity, 
	vec3 vertexNormal, 
	mat3 tbn
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel, 
	float iridescenceIntensity
#endif
) {
	if (dot(dir, dir) < 0.0001) {
		dDiffuseLight += lightmap;
	} else {
		float vlight = saturate(dot(dir, -vertexNormal));
		float flight = saturate(dot(dir, -worldNormal));
		float nlight = (flight / max(vlight, 0.01)) * 0.5;
		dDiffuseLight += lightmap * nlight * 2.0;
		vec3 halfDir = normalize(-dir + viewDir);
		vec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);
#ifdef LIT_SPECULAR_FRESNEL
		specularLight *= 
			getFresnel(dot(viewDir, halfDir), 
			gloss, 
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
			);
#endif
		dSpecularLight += specularLight;
	}
}
`,NI=`
uniform sampler2D texture_lightMap;
uniform sampler2D texture_dirLightMap;
void getLightMap() {
	dLightmap = $DECODE(texture2DBias(texture_lightMap, $UV, textureBias)).$CH;
	vec3 dir = texture2DBias(texture_dirLightMap, $UV, textureBias).xyz * 2.0 - 1.0;
	float dirDot = dot(dir, dir);
	dLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);
}
`,kI=`
void getLightMap() {
	dLightmap = vec3(1.0);
	#ifdef MAPTEXTURE
	dLightmap *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	#endif
	#ifdef MAPVERTEX
	dLightmap *= saturate(vVertexColor.$VC);
	#endif
}
`,UI=`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {
	float PI = 3.141592653589793;
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	float anisotropy = material_anisotropy * roughness;
 
	float at = max((roughness + anisotropy), roughness / 4.0);
	float ab = max((roughness - anisotropy), roughness / 4.0);
	float NoH = dot(worldNormal, h);
	float ToH = dot(tbn[0], h);
	float BoH = dot(tbn[1], h);
	float a2 = at * ab;
	vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);
	float v2 = dot(v, v);
	float w2 = a2 / v2;
	float D = a2 * w2 * w2 * (1.0 / PI);
	float ToV = dot(tbn[0], viewDir);
	float BoV = dot(tbn[1], viewDir);
	float ToL = dot(tbn[0], -lightDirNorm);
	float BoL = dot(tbn[1], -lightDirNorm);
	float NoV = dot(worldNormal, viewDir);
	float NoL = dot(worldNormal, -lightDirNorm);
	float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));
	float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));
	float G = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);
}
`,zI=`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {
	float nh = max( dot( h, worldNormal ), 0.0 );
	float specPow = exp2(gloss * 11.0);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, h);
}
`,VI=`
float calcLightSpecular(float gloss, vec3 reflDir, vec3 lightDirNorm) {
	float specPow = gloss;
	return pow(max(dot(reflDir, -lightDirNorm), 0.0), specPow + 0.0001);
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, reflDir, lightDirNorm);
}
`,GI=`
float sheenD(vec3 normal, vec3 h, float roughness) {
	float invR = 1.0 / (roughness * roughness);
	float cos2h = max(dot(normal, h), 0.0);
	cos2h *= cos2h;
	float sin2h = max(1.0 - cos2h, 0.0078125);
	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);
}
float sheenV(vec3 normal, vec3 viewDir, vec3 light) {
	float NoV = max(dot(normal, viewDir), 0.000001);
	float NoL = max(dot(normal, light), 0.000001);
	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));
}
float getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {
	float D = sheenD(worldNormal, h, sheenGloss);
	float V = sheenV(worldNormal, viewDir, -lightDirNorm);
	return D * V;
}
`,WI=`
#ifndef LINEARIZE_DEPTH
#define LINEARIZE_DEPTH
float linearizeDepth(float z, vec4 cameraParams) {
	if (cameraParams.w == 0.0)
		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));
	else
		return cameraParams.z + z * (cameraParams.y - cameraParams.z);
}
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
#ifdef GL2
float linearizeDepth(float z) {
	return linearizeDepth(z, camera_params);
}
#else
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	return dot(rgbaDepth, bitShift);
}
#endif
#endif
#endif
`,HI=`
vec3 litArgs_albedo;
float litArgs_opacity;
vec3 litArgs_emission;
vec3 litArgs_worldNormal;
float litArgs_ao;
vec3 litArgs_lightmap;
vec3 litArgs_lightmapDir;
float litArgs_metalness;
vec3 litArgs_specularity;
float litArgs_specularityFactor;
float litArgs_gloss;
float litArgs_sheen_gloss;
vec3 litArgs_sheen_specularity;
float litArgs_transmission;
float litArgs_thickness;
float litArgs_ior;
float litArgs_iridescence_intensity;
float litArgs_iridescence_thickness;
vec3 litArgs_clearcoat_worldNormal;
float litArgs_clearcoat_specularity;
float litArgs_clearcoat_gloss;
`,XI=`
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	vec3 coord0;
	vec3 coord1;
	vec3 coord2;
	vec3 coord3;
};
float LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {
	vec3 v1 = rectCoords.coord1 - rectCoords.coord0;
	vec3 v2 = rectCoords.coord3 - rectCoords.coord0;
	
	vec3 lightNormal = cross( v1, v2 );
	float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 =  factor * cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords.coord0 - P );
	coords[ 1 ] = mat * ( rectCoords.coord1 - P );
	coords[ 2 ] = mat * ( rectCoords.coord2 - P );
	coords[ 3 ] = mat * ( rectCoords.coord3 - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
Coords dLTCCoords;
Coords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	Coords coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
float dSphereRadius;
Coords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	vec3 f = reflect(normalize(lightPos - view_position), vNormalW);
	vec3 w = normalize(cross(f, halfHeight));
	vec3 h = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
vec2 dLTCUV;
#ifdef LIT_CLEARCOAT
vec2 ccLTCUV;
#endif
vec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)
{
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	return LTC_Uv( worldNormal, viewDir, roughness );
}
vec3 dLTCSpecFres;
#ifdef LIT_CLEARCOAT
vec3 ccLTCSpecFres;
#endif
vec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)
{
	vec4 t2 = texture2DLodEXT(areaLightsLutTex2, uv, 0.0);
	#ifdef AREA_R8_G8_B8_A8_LUTS
	t2 *= vec4(0.693103,1,1,1);
	t2 += vec4(0.306897,0,0,0);
	#endif
	return specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;
}
void calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)
{
	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); 
#ifdef LIT_CLEARCOAT
	ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);
	ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));
#endif
}
void calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
void calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
void calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
vec3 SolveCubic(vec4 Coefficient)
{
	float pi = 3.14159;
	Coefficient.xyz /= Coefficient.w;
	Coefficient.yz /= 3.0;
	float A = Coefficient.w;
	float B = Coefficient.z;
	float C = Coefficient.y;
	float D = Coefficient.x;
	vec3 Delta = vec3(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);
	vec3 RootsA, RootsD;
	vec2 xlc, xsc;
	{
		float A_a = 1.0;
		float C_a = Delta.x;
		float D_a = -2.0 * B * Delta.x + Delta.y;
		float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;
		float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);
		float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);
		float xl;
		if ((x_1a + x_3a) > 2.0 * B)
			xl = x_1a;
		else
			xl = x_3a;
		xlc = vec2(xl - B, A);
	}
	{
		float A_d = D;
		float C_d = Delta.z;
		float D_d = -D * Delta.y + 2.0 * C * Delta.z;
		float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;
		float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);
		float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);
		float xs;
		if (x_1d + x_3d < 2.0 * C)
			xs = x_1d;
		else
			xs = x_3d;
		xsc = vec2(-D, xs + C);
	}
	float E =  xlc.y * xsc.y;
	float F = -xlc.x * xsc.y - xlc.y * xsc.x;
	float G =  xlc.x * xsc.x;
	vec2 xmc = vec2(C * F - B * G, -B * F + C * E);
	vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z)
		Root.xyz = Root.yxz;
	else if (Root.z < Root.x && Root.z < Root.y)
		Root.xyz = Root.xzy;
	return Root;
}
float LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)
{
	vec3 T1, T2;
	T1 = normalize(V - N * dot(V, N));
	T2 = cross(N, T1);
	mat3 R = transposeMat3( mat3( T1, T2, N ) );
	vec3 L_[ 3 ];
	L_[ 0 ] = R * ( points.coord0 - P );
	L_[ 1 ] = R * ( points.coord1 - P );
	L_[ 2 ] = R * ( points.coord2 - P );
	vec3 Lo_i = vec3(0);
	vec3 C  = 0.5 * (L_[0] + L_[2]);
	vec3 V1 = 0.5 * (L_[1] - L_[2]);
	vec3 V2 = 0.5 * (L_[1] - L_[0]);
	C  = Minv * C;
	V1 = Minv * V1;
	V2 = Minv * V2;
	float a, b;
	float d11 = dot(V1, V1);
	float d22 = dot(V2, V2);
	float d12 = dot(V1, V2);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001)
	{
		float tr = d11 + d22;
		float det = -d12 * d12 + d11 * d22;
		det = sqrt(det);
		float u = 0.5 * sqrt(tr - 2.0 * det);
		float v = 0.5 * sqrt(tr + 2.0 * det);
		float e_max = (u + v) * (u + v);
		float e_min = (u - v) * (u - v);
		vec3 V1_, V2_;
		if (d11 > d22)
		{
			V1_ = d12 * V1 + (e_max - d11) * V2;
			V2_ = d12 * V1 + (e_min - d11) * V2;
		}
		else
		{
			V1_ = d12*V2 + (e_max - d22)*V1;
			V2_ = d12*V2 + (e_min - d22)*V1;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	}
	else
	{
		a = 1.0 / dot(V1, V1);
		b = 1.0 / dot(V2, V2);
		V1 *= sqrt(a);
		V2 *= sqrt(b);
	}
	vec3 V3 = cross(V1, V2);
	if (dot(C, V3) < 0.0)
		V3 *= -1.0;
	float L  = dot(V3, C);
	float x0 = dot(V1, C) / L;
	float y0 = dot(V2, C) / L;
	float E1 = inversesqrt(a);
	float E2 = inversesqrt(b);
	a *= L * L;
	b *= L * L;
	float c0 = a * b;
	float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;
	float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);
	float c3 = 1.0;
	vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));
	float e1 = roots.x;
	float e2 = roots.y;
	float e3 = roots.z;
	vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);
	mat3 rotate = mat3(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	float L1 = sqrt(-e2 / e3);
	float L2 = sqrt(-e2 / e1);
	float formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));
	
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv*LUT_SCALE + LUT_BIAS;
	float scale = texture2DLodEXT(areaLightsLutTex2, uv, 0.0).w;
	return formFactor*scale;
}
float getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	float falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);
	return getLightDiffuse(worldNormal, viewDir, lightDir, lightDirNorm) * falloff;
}
mat3 getLTCLightInvMat(vec2 uv)
{
	vec4 t1 = texture2DLodEXT(areaLightsLutTex1, uv, 0.0);
	#ifdef AREA_R8_G8_B8_A8_LUTS
	t1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);
	t1 += vec4(0.0, -0.2976, -0.01381, 0.0);
	#endif
	return mat3(
		vec3( t1.x, 0, t1.y ),
		vec3(	0, 1,	0 ),
		vec3( t1.z, 0, t1.w )
	);
}
float calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);
}
float calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
float getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
`,$I=`
#ifdef MAPFLOAT
uniform float material_metalness;
#endif
void getMetalness() {
	float metalness = 1.0;
	#ifdef MAPFLOAT
	metalness *= material_metalness;
	#endif
	#ifdef MAPTEXTURE
	metalness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	metalness *= saturate(vVertexColor.$VC);
	#endif
	dMetalness = metalness;
}
`,qI=`
uniform sampler2D texture_msdfMap;
#ifdef GL_OES_standard_derivatives
#define USE_FWIDTH
#endif
#ifdef GL2
#define USE_FWIDTH
#endif
float median(float r, float g, float b) {
	return max(min(r, g), min(max(r, g), b));
}
float map (float min, float max, float v) {
	return (v - min) / (max - min);
}
uniform float font_sdfIntensity;
uniform float font_pxrange;
uniform float font_textureWidth;
#ifdef UNIFORM_TEXT_PARAMETERS
uniform vec4 outline_color;
uniform float outline_thickness;
uniform vec4 shadow_color;
uniform vec2 shadow_offset;
#else
varying vec4 outline_color;
varying float outline_thickness;
varying vec4 shadow_color;
varying vec2 shadow_offset;
#endif
vec4 applyMsdf(vec4 color) {
	vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;
	vec2 uvShdw = vUv0 - shadow_offset;
	vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;
	float sigDist = median(tsample.r, tsample.g, tsample.b);
	float sigDistShdw = median(ssample.r, ssample.g, ssample.b);
	float smoothingMax = 0.2;
	#ifdef USE_FWIDTH
	vec2 w = fwidth(vUv0);
	float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);
	#else
	float font_size = 16.0;
	float smoothing = clamp(font_pxrange / font_size, 0.0, smoothingMax);
	#endif
	float mapMin = 0.05;
	float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);
	float sigDistInner = map(mapMin, mapMax, sigDist);
	float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);
	float center = 0.5;
	float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);
	float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);
	float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);
	vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);
	tcolor = mix(tcolor, color, inside);
	vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;
	tcolor = mix(scolor, tcolor, outline);
	
	return tcolor;
}
`,jI=`
vec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {
	vec3 dielectricF0 = f0 * specularity;
	return mix(dielectricF0, albedo, metalness);
}
vec3 getAlbedoModulate(in vec3 albedo, in float metalness) {
	return albedo * (1.0 - metalness);
}
`,YI=`
attribute vec3 vertex_outlineParameters;
attribute vec3 vertex_shadowParameters;
varying vec4 outline_color;
varying float outline_thickness;
varying vec4 shadow_color;
varying vec2 shadow_offset;
void unpackMsdfParams() {
	vec3 little = mod(vertex_outlineParameters, 256.);
	vec3 big = (vertex_outlineParameters - little) / 256.;
	outline_color.rb = little.xy / 255.;
	outline_color.ga = big.xy / 255.;
	outline_thickness = little.z / 255. * 0.2;
	little = mod(vertex_shadowParameters, 256.);
	big = (vertex_shadowParameters - little) / 256.;
	shadow_color.rb = little.xy / 255.;
	shadow_color.ga = big.xy / 255.;
	shadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;
}
`,KI=`
#ifdef MORPHING_TEXTURE_BASED_NORMAL
uniform highp sampler2D morphNormalTex;
#endif
vec3 getNormal() {
	#ifdef SKIN
	dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);
	#elif defined(INSTANCING)
	dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);
	#else
	dNormalMatrix = matrix_normal;
	#endif
	vec3 tempNormal = vertex_normal;
	#ifdef MORPHING
	#ifdef MORPHING_NRM03
	tempNormal += morph_weights_a[0] * morph_nrm0;
	tempNormal += morph_weights_a[1] * morph_nrm1;
	tempNormal += morph_weights_a[2] * morph_nrm2;
	tempNormal += morph_weights_a[3] * morph_nrm3;
	#endif
	#ifdef MORPHING_NRM47
	tempNormal += morph_weights_b[0] * morph_nrm4;
	tempNormal += morph_weights_b[1] * morph_nrm5;
	tempNormal += morph_weights_b[2] * morph_nrm6;
	tempNormal += morph_weights_b[3] * morph_nrm7;
	#endif
	#endif
	#ifdef MORPHING_TEXTURE_BASED_NORMAL
		#ifdef WEBGPU
			ivec2 morphUV = getTextureMorphCoords();
			vec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;
		#else
			vec2 morphUV = getTextureMorphCoords();
			vec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;
		#endif
	tempNormal += morphNormal;
	#endif
	return normalize(dNormalMatrix * tempNormal);
}
`,ZI=`
#ifdef MAPTEXTURE
uniform float material_normalDetailMapBumpiness;
vec3 blendNormals(vec3 n1, vec3 n2) {
	n1 += vec3(0, 0, 1);
	n2 *= vec3(-1, -1, 1);
	return n1 * dot(n1, n2) / n1.z - n2;
}
#endif
vec3 addNormalDetail(vec3 normalMap) {
#ifdef MAPTEXTURE
	vec3 normalDetailMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));
	normalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);
	return blendNormals(normalMap, normalDetailMap);
#else
	return normalMap;
#endif
}
`,QI=`
vec3 getNormal() {
	dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);
	return normalize(dNormalMatrix * vertex_normal);
}
`,JI=`
#ifdef MAPTEXTURE
uniform float material_bumpiness;
#endif
void getNormal() {
#ifdef MAPTEXTURE
	vec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);
	dNormalW = normalize(dTBN * addNormalDetail(normalMap));
#else
	dNormalW = dVertexNormalW;
#endif
}
`,eD=`
vec3 getNormal() {
	dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);
	return normalize(dNormalMatrix * vertex_normal);
}
`,tD=`
vec3 unpackNormal(vec4 nmap) {
	vec3 normal;
	normal.xy = nmap.wy * 2.0 - 1.0;
	normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));
	return normal;
}
`,sD=`
vec3 unpackNormal(vec4 nmap) {
	return nmap.xyz * 2.0 - 1.0;
}
`,iD=`
#ifdef MAPFLOAT
uniform float material_opacity;
#endif
void getOpacity() {
	dAlpha = 1.0;
	#ifdef MAPFLOAT
	dAlpha *= material_opacity;
	#endif
	#ifdef MAPTEXTURE
	dAlpha *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);
	#endif
}
`,nD=`
uniform vec4 blueNoiseJitter;
#ifndef DITHER_BAYER8
	uniform sampler2D blueNoiseTex32;
#endif
void opacityDither(float alpha, float id) {
	#ifdef DITHER_BAYER8
		float noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;
	#else
		vec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);
		float noise = texture2DLodEXT(blueNoiseTex32, uv, 0.0).y;
	#endif
	if (alpha < noise)
		discard;
}
`,rD=`
`,aD=`
gl_FragColor.a = litArgs_opacity;
`,oD=`
	gl_FragColor.a = 1.0;
`,lD=`
gl_FragColor.rgb *= litArgs_opacity;
gl_FragColor.a = litArgs_opacity;
`,hD=`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,cD=`
vec4 packFloat(float depth) {
	const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);
	const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);
	vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);
	res -= res.xxyz * bit_mask;
	return res;
}
`,dD=`
#ifdef MAPCOLOR
uniform vec3 material_sheen;
#endif
void getSheen() {
	vec3 sheenColor = vec3(1, 1, 1);
	#ifdef MAPCOLOR
	sheenColor *= material_sheen;
	#endif
	#ifdef MAPTEXTURE
	sheenColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	#endif
	#ifdef MAPVERTEX
	sheenColor *= saturate(vVertexColor.$VC);
	#endif
	sSpecularity = sheenColor;
}
`,uD=`
#ifdef MAPFLOAT
uniform float material_sheenGloss;
#endif
void getSheenGlossiness() {
	float sheenGlossiness = 1.0;
	#ifdef MAPFLOAT
	sheenGlossiness *= material_sheenGloss;
	#endif
	#ifdef MAPTEXTURE
	sheenGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	sheenGlossiness *= saturate(vVertexColor.$VC);
	#endif
	#ifdef MAPINVERT
	sheenGlossiness = 1.0 - sheenGlossiness;
	#endif
	sheenGlossiness += 0.0000001;
	sGlossiness = sheenGlossiness;
}
`,fD=`
uniform float material_heightMapFactor;
void getParallax() {
	float parallaxScale = material_heightMapFactor;
	float height = texture2DBias($SAMPLER, $UV, textureBias).$CH;
	height = height * parallaxScale - parallaxScale*0.5;
	vec3 viewDirT = dViewDirW * dTBN;
	viewDirT.z += 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`,pD=`
varying vec4 texCoordsAlphaLife;
uniform sampler2D colorMap;
uniform sampler2D colorParam;
uniform float graphSampleSize;
uniform float graphNumSamples;
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
uniform float softening;
uniform float colorMult;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	float depth = dot(rgbaDepth, bitShift);
	return depth;
}
#endif
void main(void) {
	vec4 tex  = gammaCorrectInput(texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)));
	vec4 ramp = gammaCorrectInput(texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0)));
	ramp.rgb *= colorMult;
	ramp.a += texCoordsAlphaLife.z;
	vec3 rgb = tex.rgb * ramp.rgb;
	float a  = tex.a * ramp.a;
`,mD=`
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {
	return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );
}
vec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex,tc);
	vec4 b = texture2D(tex,tc + graphSampleSize);
	float c = fract(tc.x*graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a, b, c);
}
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY) {
	#ifdef SCREEN_SPACE
		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;
	#else
		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY) {
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
vec2 safeNormalize(vec2 v) {
	float l = length(v);
	return (l > 1e-06) ? v / l : v;
}
void main(void) {
	vec3 meshLocalPos = particle_vertexData.xyz;
	float id = floor(particle_vertexData.w);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	float uv = id / numParticlesPot;
	readInput(uv);
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);
	float particleLifetime = lifetime;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);
	vec2 quadXY = meshLocalPos.xy;
	float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	vec3 paramDiv;
	vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);
	float scale = params.y;
	float scaleDiv = paramDiv.x;
	float alphaDiv = paramDiv.z;
	scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);
#ifndef USE_MESH
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#else
	texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#endif
	vec3 particlePos = inPos;
	vec3 particlePosMoved = vec3(0.0);
	mat2 rotMatrix;
`,_D=`
	float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);
`,gD=`
	float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));
`,yD=`
	float animationIndex;
	if (animTexIndexParams.y == 1.0) {
		animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);
	} else {
		animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);
	}
	float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;
	float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;
	atlasX = fract(atlasX);
	texCoordsAlphaLife.xy *= animTexTilesParams.xy;
	texCoordsAlphaLife.xy += vec2(atlasX, atlasY);
`,vD=`
void readInput(float uv) {
	vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`,xD=`
#define PI2 6.283185307179586
uniform vec3 inBoundsSize;
uniform vec3 inBoundsCenter;
uniform float maxVel;
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
float decodeFloatRGBA( vec4 rgba ) {
	return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );
}
void readInput(float uv) {
	vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));
	vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));
	vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));
	inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3(0.5)) * maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	inLife = decodeFloatRGBA(tex3);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;
}
`,SD=`
void writeOutput() {
	if (gl_FragCoord.y<1.0) {
		gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);
	} else {
		gl_FragColor = vec4(outVel, outLife);
	}
}
`,bD=`
uniform vec3 outBoundsMul;
uniform vec3 outBoundsAdd;
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
vec4 encodeFloatRGBA( float v ) {
	vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;
	enc = fract(enc);
	enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);
	return enc;
}
void writeOutput() {
	outPos = outPos * outBoundsMul + outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / maxVel) + vec3(0.5);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (gl_FragCoord.y < 1.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (gl_FragCoord.y < 2.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (gl_FragCoord.y < 3.0) {
		gl_FragColor = vec4(outVel, visMode*0.5+0.5);
	} else {
		gl_FragColor = encodeFloatRGBA(outLife);
	}
}
`,TD=`
uniform mat3 spawnBounds;
uniform vec3 spawnPosInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	vec3 pos = inBounds - vec3(0.5);
	vec3 posAbs = abs(pos);
	vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));
	vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;
	pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);
	pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);
	pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);
#ifndef LOCAL_SPACE
	return emitterPos + spawnBounds * pos;
#else
	return spawnBounds * pos;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity -= vec3(0, 0, initialVelocity);
}
`,wD=`
	writeOutput();
}
`,ED=`
varying vec2 vUv0;
uniform highp sampler2D particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform highp sampler2D internalTex3;
uniform mat3 emitterMatrix, emitterMatrixInv;
uniform vec3 emitterScale;
uniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;
uniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;
uniform float startAngle, startAngle2;
uniform float initialVelocity;
uniform float graphSampleSize;
uniform float graphNumSamples;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
float visMode;
vec3 outPos;
vec3 outVel;
float outAngle;
bool outShow;
float outLife;
`,AD=`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = -1.0;
	}
`,CD=`
	visMode = outLife < 0.0? -1.0: visMode;
`,MD=`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = 1.0;
	}
	visMode = outLife < 0.0? 1.0: visMode;
`,PD=`
uniform float spawnBoundsSphere;
uniform float spawnBoundsSphereInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	float rnd4 = fract(rndFactor * 1000.0);
	vec3 norm = normalize(inBounds.xyz - vec3(0.5));
	float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;
#ifndef LOCAL_SPACE
	return emitterPos + norm * r * spawnBoundsSphere;
#else
	return norm * r * spawnBoundsSphere;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;
}
`,RD=`
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
vec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex, tc);
	vec4 b = texture2D(tex, tc + graphSampleSize);
	float c = fract(tc.x * graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a.xyz, b.xyz, c);
}
#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)
vec4 hash41(float p) {
	vec4 p4 = fract(vec4(p) * HASHSCALE4);
	p4 += dot(p4, p4.wzxy+19.19);
	return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
void main(void) {
	if (gl_FragCoord.x > numParticles) discard;
	readInput(vUv0.x);
	visMode = inShow? 1.0 : -1.0;
	vec4 rndFactor = hash41(gl_FragCoord.x + seed);
	float particleRate = rate + rateDiv * rndFactor.x;
	outLife = inLife + delta;
	float nlife = clamp(outLife / lifetime, 0.0, 1.0);
	vec3 localVelocityDiv;
	vec3 velocityDiv;
	vec3 paramDiv;
	vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);
	vec3 velocity =	  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);
	vec3 params =		tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);
	float rotSpeed = params.x;
	float rotSpeedDiv = paramDiv.y;
	vec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);
	float radialSpeed = radialParams.x;
	float radialSpeedDiv = radialParams.y;
	bool respawn = inLife <= 0.0 || outLife >= lifetime;
	inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;
	inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;
#ifndef LOCAL_SPACE
	vec3 radialVel = inPos - emitterPos;
#else
	vec3 radialVel = inPos;
#endif
	radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);
	radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;
	localVelocity +=	(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;
	velocity +=		 (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;
	rotSpeed +=		 (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(localVelocity, rndFactor.xyz);
#ifndef LOCAL_SPACE
	outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;
#else
	outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;
#endif
	outPos = inPos + outVel * delta;
	outAngle = inAngle + rotSpeed * delta;
`,ID=`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = billboard(particlePos, quadXY);
`,DD=`
	dBlendModeFogFactor = 0.0;
	rgb *= saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;
`,LD=`
	rgb = mix(vec3(1.0), rgb, vec3(a));
	if (rgb.r + rgb.g + rgb.b > 2.99) discard;
`,FD=`
	if (a < 0.01) discard;
`,OD=`
attribute vec4 particle_vertexData;
attribute vec4 particle_vertexData2;
attribute vec4 particle_vertexData3;
attribute float particle_vertexData4;
#ifndef USE_MESH
attribute vec2 particle_vertexData5;
#else
attribute vec4 particle_vertexData5;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
uniform float numParticles;
uniform float lifetime;
uniform float stretch;
uniform float seed;
uniform vec3 wrapBounds;
uniform vec3 emitterScale;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform vec3 emitterPos;
varying vec4 texCoordsAlphaLife;
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)
{
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
void main(void)
{
	vec3 particlePos = particle_vertexData.xyz;
	vec3 inPos = particlePos;
	vec3 vertPos = particle_vertexData3.xyz;
	vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);
	float id = floor(particle_vertexData4);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);
	vec2 quadXY = vertPos.xy;
#ifdef USE_MESH
	texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);
#else
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);
#endif
	mat2 rotMatrix;
	float inAngle = particle_vertexData2.x;
	vec3 particlePosMoved = vec3(0.0);
	vec3 meshLocalPos = particle_vertexData3.xyz;
`,BD=`
	localPos *= particle_vertexData2.y * emitterScale;
	localPos += particlePos;
	gl_Position = matrix_viewProjection * vec4(localPos, 1.0);
`,ND=`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = customFace(particlePos, quadXY);
`,kD=`
	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	gl_FragColor = vec4(rgb, a);
}
`,UD=`
	localPos *= scale * emitterScale;
	localPos += particlePos;
	#ifdef SCREEN_SPACE
	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);
	#else
	gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);
	#endif
`,zD=`
	vec3 negNormal = normal*0.5+0.5;
	vec3 posNormal = -normal*0.5+0.5;
	negNormal *= negNormal;
	posNormal *= posNormal;
`,VD=`
attribute vec4 particle_vertexData;
#ifdef USE_MESH
attribute vec2 particle_uv;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform float numParticles, numParticlesPot;
uniform float graphSampleSize;
uniform float graphNumSamples;
uniform float stretch;
uniform vec3 wrapBounds;
uniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;
uniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;
uniform sampler2D particleTexOUT, particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
varying vec4 texCoordsAlphaLife;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
`,GD=`
	vec3 negNormal = max(normal, vec3(0.0));
	vec3 posNormal = max(-normal, vec3(0.0));
`,WD=`
	vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +
						negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +
						negNormal.z*lightCube[4] + posNormal.z*lightCube[5];
	rgb *= light;
`,HD=`
	particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;
`,XD=`
	vec3 localPos = meshLocalPos;
	localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);
	localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);
	billboard(particlePos, quadXY);
`,$D=`
	Normal = normalize(localPos + matrix_viewInverse[2].xyz);
`,qD=`
	vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);
	vec3 normal = ParticleMat * normalMap;
`,jD=`
	inAngle = atan(velocityV.x, velocityV.y);
`,YD=`
	float depth = getLinearScreenDepth();
	float particleDepth = vDepth;
	float depthDiff = saturate(abs(particleDepth - depth) * softening);
	a *= depthDiff;
`,KD=`
	vDepth = getLinearDepth(localPos);
`,ZD=`
	vec3 moveDir = inVel * stretch;
	vec3 posPrev = particlePos - moveDir;
	posPrev += particlePosMoved;
	vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);
	float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`,QD=`
	mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);
	ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;
`,JD=`
	vec3 origParticlePos = particlePos;
	particlePos -= matrix_model[3].xyz;
	particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;
	particlePos += matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`,eL=`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	dReflDirW = normalize(-reflect(viewDir, worldNormal));
}
`,tL=`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	float roughness = sqrt(1.0 - min(gloss, 1.0));
	float anisotropy = material_anisotropy * roughness;
	vec3 anisotropicDirection = anisotropy >= 0.0 ? tbn[1] : tbn[0];
	vec3 anisotropicTangent = cross(anisotropicDirection, viewDir);
	vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);
	vec3 bentNormal = normalize(mix(normalize(worldNormal), normalize(anisotropicNormal), anisotropy));
	dReflDirW = reflect(-viewDir, bentNormal);
}
`,sL=`
#ifdef LIT_CLEARCOAT
void addReflectionCC(vec3 reflDir, float gloss) {
	ccReflection += calcReflection(reflDir, gloss);
}
#endif
`,iL=`
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 lookupVec = fixSeams(cubeMapProject(reflDir));
	lookupVec.x *= -1.0;
	return $DECODE(textureCube(texture_cubeMap, lookupVec));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,nL=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float flevel = level - ilevel;
	vec3 sharp = $DECODE_CUBEMAP(textureCube(texture_cubeMap, fixSeams(dir)));
	vec3 roughA = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));
	vec3 roughB = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,rL=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
uniform float material_reflectivity;
float shinyMipLevel(vec2 uv) {
	vec2 dx = dFdx(uv);
	vec2 dy = dFdy(uv);
	vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);
	vec2 dx2 = dFdx(uv2);
	vec2 dy2 = dFdy(uv2);
	float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);
}
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float level2 = shinyMipLevel(uv * atlasSize);
	float ilevel2 = floor(level2);
	vec2 uv0, uv1;
	float weight;
	if (ilevel == 0.0) {
		uv0 = mapShinyUv(uv, ilevel2);
		uv1 = mapShinyUv(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = uv1 = mapRoughnessUv(uv, ilevel);
		weight = 0.0;
	}
	vec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));
	vec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));
	vec3 linear0 = mix(linearA, linearB, weight);
	vec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,aL=`
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform sampler2D texture_sphereMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 reflDirV = (mat3(matrix_view) * reflDir).xyz;
	float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );
	vec2 sphereMapUv = reflDirV.xy / m + 0.5;
	return $DECODE(texture2D(texture_sphereMap, sphereMapUv));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,oL=`
void addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {
	float NoV = dot(worldNormal, viewDir);
	float alphaG = gloss * gloss;
	float a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;
	float b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;
	float DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );
	sReflection += calcReflection(worldNormal, 0.0) * saturate(DG);
}
`,lL=`
vec3 refract2(vec3 viewVec, vec3 normal, float IOR) {
	float vn = dot(viewVec, normal);
	float k = 1.0 - IOR * IOR * (1.0 - vn * vn);
	vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;
	return refrVec;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif 
) {
	vec4 tmpRefl = dReflection;
	vec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);
	dReflection = vec4(0);
	addReflection(reflectionDir, gloss);
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);
	dReflection = tmpRefl;
}
`,hL=`
uniform float material_invAttenuationDistance;
uniform vec3 material_attenuation;
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif
) {
	vec3 modelScale;
	modelScale.x = length(vec3(matrix_model[0].xyz));
	modelScale.y = length(vec3(matrix_model[1].xyz));
	modelScale.z = length(vec3(matrix_model[2].xyz));
	vec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * thickness * modelScale;
	vec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);
	vec4 projectionPoint = matrix_viewProjection * pointOfRefraction;
	vec2 uv = getGrabScreenPos(projectionPoint);
	#ifdef SUPPORTS_TEXLOD
		float iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);
		float refractionLod = log2(uScreenSize.x) * iorToRoughness;
		vec3 refraction = texture2DLodEXT(uSceneColorMap, uv, refractionLod).rgb;
	#else
		vec3 refraction = texture2D(uSceneColorMap, uv).rgb;
	#endif
	vec3 transmittance;
	if (material_invAttenuationDistance != 0.0)
	{
		vec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;
		transmittance = exp(-attenuation * length(refractionVector));
	}
	else
	{
		transmittance = refraction;
	}
	vec3 fresnel = vec3(1.0) - 
		getFresnel(
			dot(viewDir, worldNormal), 
			gloss, 
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
		);
	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);
}
`,cL=`
varying vec2 vUv0;
#ifdef CUBEMAP_SOURCE
	uniform samplerCube sourceCube;
#else
	uniform sampler2D sourceTex;
#endif
#ifdef USE_SAMPLES_TEX
	uniform sampler2D samplesTex;
	uniform vec2 samplesTexInverseSize;
#endif
uniform vec4 params;
uniform vec2 params2;
float targetFace() { return params.x; }
float specularPower() { return params.y; }
float sourceCubeSeamScale() { return params.z; }
float targetCubeSeamScale() { return params.w; }
float targetTotalPixels() { return params2.x; }
float sourceTotalPixels() { return params2.y; }
float PI = 3.141592653589793;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
${ox}
${lx}
vec3 modifySeams(vec3 dir, float scale) {
	vec3 adir = abs(dir);
	float M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3(
		adir.x == M ? 1.0 : scale,
		adir.y == M ? 1.0 : scale,
		adir.z == M ? 1.0 : scale
	);
}
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec3 fromSpherical(vec2 uv) {
	return vec3(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
vec3 getDirectionEquirect() {
	return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));
}
float signNotZero(float k){
	return(k >= 0.0) ? 1.0 : -1.0;
}
vec2 signNotZero(vec2 v) {
	return vec2(signNotZero(v.x), signNotZero(v.y));
}
vec3 octDecode(vec2 o) {
	vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);
	}
	return normalize(v);
}
vec3 getDirectionOctahedral() {
	return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);
}
vec2 octEncode(in vec3 v) {
	float l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	vec2 result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZero(result.xy);
	}
	return result;
}
#ifdef CUBEMAP_SOURCE
	vec4 sampleCubemap(vec3 dir) {
		return textureCube(sourceCube, modifySeams(dir, 1.0 - sourceCubeSeamScale()));
	}
	vec4 sampleCubemap(vec2 sph) {
	return sampleCubemap(fromSpherical(sph));
}
	vec4 sampleCubemap(vec3 dir, float mipLevel) {
		return textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()), mipLevel);
	}
	vec4 sampleCubemap(vec2 sph, float mipLevel) {
		return sampleCubemap(fromSpherical(sph), mipLevel);
	}
#else
	vec4 sampleEquirect(vec2 sph) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleEquirect(vec3 dir) {
		return sampleEquirect(toSpherical(dir));
	}
	vec4 sampleEquirect(vec2 sph, float mipLevel) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleEquirect(vec3 dir, float mipLevel) {
		return sampleEquirect(toSpherical(dir), mipLevel);
	}
	vec4 sampleOctahedral(vec3 dir) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleOctahedral(vec2 sph) {
		return sampleOctahedral(fromSpherical(sph));
	}
	vec4 sampleOctahedral(vec3 dir, float mipLevel) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleOctahedral(vec2 sph, float mipLevel) {
		return sampleOctahedral(fromSpherical(sph), mipLevel);
	}
#endif
vec3 getDirectionCubemap() {
	vec2 st = vUv0 * 2.0 - 1.0;
	float face = targetFace();
	vec3 vec;
	if (face == 0.0) {
		vec = vec3(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3(st.x, -st.y, 1);
	} else {
		vec = vec3(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0 / (1.0 - targetCubeSeamScale())));
}
mat3 matrixFromVector(vec3 n) {
	float a = 1.0 / (1.0 + n.z);
	float b = -n.x * n.y * a;
	vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
	vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3(b1, b2, n);
}
mat3 matrixFromVectorSlow(vec3 n) {
	vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);
	vec3 x = normalize(cross(up, n));
	vec3 y = cross(n, x);
	return mat3(x, y, n);
}
vec4 reproject() {
	if (NUM_SAMPLES <= 1) {
		return ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));
	} else {
		vec3 t = TARGET_FUNC();
		vec3 tu = dFdx(t);
		vec3 tv = dFdy(t);
		vec3 result = vec3(0.0);
		for (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {
			for (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {
				result += DECODE_FUNC(SOURCE_FUNC(normalize(t +
															tu * (u / NUM_SAMPLES_SQRT - 0.5) +
															tv * (v / NUM_SAMPLES_SQRT - 0.5))));
			}
		}
		return ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));
	}
}
vec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
#ifdef USE_SAMPLES_TEX
	void unpackSample(int i, out vec3 L, out float mipLevel) {
		float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;
		float v = (floor(u) + 0.5) * samplesTexInverseSize.y;
		vec4 raw;
		raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);
		L.xyz = raw.xyz * 2.0 - 1.0;
		mipLevel = raw.w * 8.0;
	}
	vec4 prefilterSamples() {
		mat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < NUM_SAMPLES; ++i) {
			unpackSample(i, L, mipLevel);
			result += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;
			totalWeight += L.z;
		}
		return ENCODE_FUNC(result / totalWeight);
	}
	vec4 prefilterSamplesUnweighted() {
		mat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < NUM_SAMPLES; ++i) {
			unpackSample(i, L, mipLevel);
			result += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));
		}
		return ENCODE_FUNC(result / float(NUM_SAMPLES));
	}
#endif
void main(void) {
	gl_FragColor = PROCESS_FUNC();
}
`,dL=`
vec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {
	vec2 samplePos = uv * texSize;
	vec2 texPos1 = floor(samplePos - 0.5) + 0.5;
	vec2 f = samplePos - texPos1;
	vec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));
	vec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);
	vec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));
	vec2 w3 = f * f * (-0.5 + 0.5 * f);
	vec2 w12 = w1 + w2;
	vec2 offset12 = w2 / (w1 + w2);
	vec2 texPos0 = (texPos1 - 1.0) / texSize;
	vec2 texPos3 = (texPos1 + 2.0) / texSize;
	vec2 texPos12 = (texPos1 + offset12) / texSize;
	vec4 result = vec4(0.0);
	result += texture2DLodEXT(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;
	result += texture2DLodEXT(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;
	result += texture2DLodEXT(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;
	result += texture2DLodEXT(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;
	result += texture2DLodEXT(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;
	result += texture2DLodEXT(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;
	result += texture2DLodEXT(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;
	result += texture2DLodEXT(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;
	result += texture2DLodEXT(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;
	return result;
}
`,uL=`
uniform highp sampler2D uSceneDepthMap;
#ifndef SCREENSIZE
#define SCREENSIZE
uniform vec4 uScreenSize;
#endif
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
#ifndef LINEARIZE_DEPTH
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
#define LINEARIZE_DEPTH
#ifdef GL2
float linearizeDepth(float z) {
	if (camera_params.w == 0.0)
		return (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));
	else
		return camera_params.z + z * (camera_params.y - camera_params.z);
}
#else
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	return dot(rgbaDepth, bitShift);
}
#endif
#endif
#endif
float getLinearScreenDepth(vec2 uv) {
	#ifdef GL2
		return linearizeDepth(texture2D(uSceneDepthMap, uv).r);
	#else
		return unpackFloat(texture2D(uSceneDepthMap, uv)) * camera_params.y;
	#endif
}
#ifndef VERTEXSHADER
float getLinearScreenDepth() {
	vec2 uv = gl_FragCoord.xy * uScreenSize.zw;
	return getLinearScreenDepth(uv);
}
#endif
float getLinearDepth(vec3 pos) {
	return -(matrix_view * vec4(pos, 1.0)).z;
}
`,fL=`
const float maxCascades = 4.0;
mat4 cascadeShadowMat;
void getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {
	float depth = 1.0 / gl_FragCoord.w;
	float cascadeIndex = 0.0;
	for (float i = 0.0; i < maxCascades; i++) {
		if (depth < shadowCascadeDistances[int(i)]) {
			cascadeIndex = i;
			break;
		}
	}
	cascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);
	#ifdef GL2
		cascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];
	#else
		if (cascadeIndex == 0.0) {
			cascadeShadowMat = shadowMatrixPalette[0];
		}
		else if (cascadeIndex == 1.0) {
			cascadeShadowMat = shadowMatrixPalette[1];
		}
		else if (cascadeIndex == 2.0) {
			cascadeShadowMat = shadowMatrixPalette[2];
		}
		else {
			cascadeShadowMat = shadowMatrixPalette[3];
		}
	#endif
}
void fadeShadow(float shadowCascadeDistances[4]) {				  
	float depth = 1.0 / gl_FragCoord.w;
	if (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {
		dShadowCoord.z = -9999999.0;
	}
}
`,pL=`
float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec3 moments = texture2D(tex, texCoords).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM$(shadowMap, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM$(shadowMap, shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
`,mL=`
float VSM$(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	float pixelSize = 1.0 / resolution;
	texCoords -= vec2(pixelSize);
	vec3 s00 = texture2D(tex, texCoords).xyz;
	vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;
	vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;
	vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;
	vec2 fr = fract(texCoords * resolution);
	vec3 h0 = mix(s00, s10, fr.x);
	vec3 h1 = mix(s01, s11, fr.x);
	vec3 moments = mix(h0, h1, fr.y);
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
`,_L=`
#define PCSS_SAMPLE_COUNT 16
uniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];
uniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];
vec2 vogelDisk(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float sine = sin(theta);
	float cosine = cos(theta);
	return vec2(r * cosine, r * sine);
}
vec3 vogelSphere(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float weight = float(sampleIndex) / count;
	return vec3(cos(theta) * r, weight, sin(theta) * r);
}
float noise(vec2 screenPos) {
	const float PHI = 1.61803398874989484820459;
	return fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);
}
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	return dot(rgbaDepth, bitShift);
}
#endif
float viewSpaceDepth(float depth, mat4 invProjection) {
	float z = depth * 2.0 - 1.0;
	vec4 clipSpace = vec4(0.0, 0.0, z, 1.0);
	vec4 viewSpace = invProjection * clipSpace;
	return viewSpace.z;
}
float PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec2 offset = sampleCoords[i] * searchSize;
		vec2 sampleUV = shadowCoords + offset;
	#ifdef GL2
		float blocker = textureLod(shadowMap, sampleUV, 0.0).r;
	#else
		float blocker = unpackFloat(texture2D(shadowMap, sampleUV));
	#endif		
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker /= blockers;
	return -1.0;
}
float PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {
	float receiverDepth = shadowCoords.z;
#ifndef GL2
	receiverDepth *= 1.0 / (cameraParams.y - cameraParams.z);
#endif
	vec2 samplePoints[PCSS_SAMPLE_COUNT];
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float pcssPresample = pcssDiskSamples[i];
		samplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);
	}
	float averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		vec2 filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea * cameraParams.x;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)
		{
			vec2 sampleUV = samplePoints[i] * filterRadius;
			sampleUV = shadowCoords.xy + sampleUV;
		#ifdef GL2
			float depth = textureLod(shadowMap, sampleUV, 0.0).r;
		#else
			float depth = unpackFloat(texture2D(shadowMap, sampleUV));
		#endif
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	} 
}
float PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;
		sampleDir = normalize(sampleDir);
	#ifdef GL2
		float blocker = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;
	#else
		float blocker = unpackFloat(textureCube(shadowMap, sampleDir));
	#endif
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker /= float(blockers);
	return -1.0;
}
float PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {
	
	vec3 samplePoints[PCSS_SAMPLE_COUNT];
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float r = pcssSphereSamples[i];
		samplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);
	}
	float receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 lightDirNorm = normalize(lightDir);
	
	float averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i++)
		{
			vec3 offset = samplePoints[i] * filterRadius;
			vec3 sampleDir = lightDirNorm + offset;
			sampleDir = normalize(sampleDir);
			#ifdef GL2
				float depth = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;
			#else
				float depth = unpackFloat(textureCube(shadowMap, sampleDir));
			#endif
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	}
}
float getShadowPointPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);
}
float getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);
}
float getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);
}
`,gL=`
vec3 getShadowSampleCoord$LIGHT(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
	vec3 surfacePosition = worldPosition;
#ifdef SHADOW_SAMPLE_POINT
	#ifdef SHADOW_SAMPLE_NORMAL_OFFSET
		float distScale = length(lightDir);
		surfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
		lightDir = surfacePosition - lightPos;
		return lightDir;
	#endif
#else
	#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER
		#ifdef SHADOW_SAMPLE_NORMAL_OFFSET
			surfacePosition = worldPosition + normal * shadowParams.y;
		#endif
	#else
		#ifdef SHADOW_SAMPLE_NORMAL_OFFSET
			#ifdef SHADOW_SAMPLE_ORTHO
				float distScale = 1.0;
			#else
				float distScale = abs(dot(vPositionW - lightPos, lightDirNorm));
			#endif
			surfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
		#endif
	#endif
	vec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);
	#ifdef SHADOW_SAMPLE_ORTHO
		positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;
	#else
		#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER
			positionInShadowSpace.xyz /= positionInShadowSpace.w;
		#else
			positionInShadowSpace.xy /= positionInShadowSpace.w;
			positionInShadowSpace.z = length(lightDir) * shadowParams.w;
		#endif
	#endif
	#ifdef SHADOW_SAMPLE_Z_BIAS
		positionInShadowSpace.z += getShadowBias(shadowParams.x, shadowParams.z);
	#endif
	surfacePosition = positionInShadowSpace.xyz;
#endif
	return surfacePosition;
}
`,yL=`
vec3 lessThan2(vec3 a, vec3 b) {
	return clamp((b - a)*1000.0, 0.0, 1.0);
}
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
	float unpackFloat(vec4 rgbaDepth) {
		const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
		return dot(rgbaDepth, bitShift);
	}
#endif
#ifdef GL2
float _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float sum = 0.0;
	float uw0 = (3.0 - 2.0 * s);
	float uw1 = (1.0 + 2.0 * s);
	float u0 = (2.0 - s) / uw0 - 1.0;
	float u1 = s / uw1 + 1.0;
	float vw0 = (3.0 - 2.0 * t);
	float vw1 = (1.0 + 2.0 * t);
	float v0 = (2.0 - t) / vw0 - 1.0;
	float v1 = t / vw1 + 1.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum *= 1.0f / 16.0;
	return sum;
}
float getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
float getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#else
float _xgetShadowPCF3x3(mat3 depthKernel, vec3 shadowCoord, sampler2D shadowMap, vec3 shadowParams) {
	mat3 shadowKernel;
	vec3 shadowZ = vec3(shadowCoord.z);
	shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));
	shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));
	shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));
	vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );
	shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);
	shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);
	vec4 shadowValues;
	shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);
	shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);
	shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);
	shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);
	return dot( shadowValues, vec4( 1.0 ) ) * 0.25;
}
float _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec3 shadowParams) {
	float xoffset = 1.0 / shadowParams.x;
	float dx0 = -xoffset;
	float dx1 = xoffset;
	mat3 depthKernel;
	depthKernel[0][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));
	depthKernel[0][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));
	depthKernel[0][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));
	depthKernel[1][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));
	depthKernel[1][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));
	depthKernel[1][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));
	depthKernel[2][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));
	depthKernel[2][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));
	depthKernel[2][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));
	return _xgetShadowPCF3x3(depthKernel, shadowCoord, shadowMap, shadowParams);
}
float getShadowPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(shadowMap, shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(shadowMap, shadowCoord, shadowParams.xyz);
}
float _getShadowPCF1x1(sampler2D shadowMap, vec3 shadowCoord) {
	float shadowSample = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));
	return shadowSample > shadowCoord.z ? 1.0 : 0.0;
}
float getShadowPCF1x1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF1x1(shadowMap, shadowCoord);
}
float getShadowSpotPCF1x1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF1x1(shadowMap, shadowCoord);
}
#endif
#ifndef WEBGPU
float _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {
	vec3 tc = normalize(dir);
	vec3 tcAbs = abs(tc);
	vec4 dirX = vec4(1,0,0, tc.x);
	vec4 dirY = vec4(0,1,0, tc.y);
	float majorAxisLength = tc.z;
	if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {
		dirX = vec4(0,0,1, tc.z);
		dirY = vec4(0,1,0, tc.y);
		majorAxisLength = tc.x;
	} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {
		dirX = vec4(1,0,0, tc.x);
		dirY = vec4(0,0,1, tc.z);
		majorAxisLength = tc.y;
	}
	float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);
	vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);
	vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);
	vec3 dx0 = -xoffset;
	vec3 dy0 = -yoffset;
	vec3 dx1 = xoffset;
	vec3 dy1 = yoffset;
	mat3 shadowKernel;
	mat3 depthKernel;
	depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));
	depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));
	depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));
	depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));
	depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));
	depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));
	depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));
	depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));
	depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));
	vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);
	shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));
	shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));
	shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));
	vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;
	vec2 fractionalCoord = fract( uv * shadowParams.x );
	shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);
	shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);
	vec4 shadowValues;
	shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);
	shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);
	shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);
	shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);
	return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;
}
float getShadowPointPCF3x3(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	return _getShadowPoint(shadowMap, shadowParams, lightDir);
}
#endif
`,vL=`
float _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float uw0 = (4.0 - 3.0 * s);
	float uw1 = 7.0;
	float uw2 = (1.0 + 3.0 * s);
	float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;
	float u1 = (3.0 + s) / uw1;
	float u2 = s / uw2 + 2.0;
	float vw0 = (4.0 - 3.0 * t);
	float vw1 = 7.0;
	float vw2 = (1.0 + 3.0 * t);
	float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;
	float v1 = (3.0 + t) / vw1;
	float v2 = t / vw2 + 2.0;
	float sum = 0.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	u2 = u2 * shadowMapSizeInv + base_uv.x;
	v2 = v2 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));
	sum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));
	sum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));
	sum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));
	sum *= 1.0f / 144.0;
	sum = saturate(sum);
	return sum;
}
float getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
`,xL=`
float calculateVSM8(vec3 moments, float Z, float vsmBias) {
	float VSMBias = vsmBias;
	float depthScale = VSMBias * Z;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);
}
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
float VSM8(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec4 c = texture2D(tex, texCoords);
	vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);
	return calculateVSM8(moments, Z, vsmBias);
}
float getShadowVSM8(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM8(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, 0.0);
}
float getShadowSpotVSM8(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM8(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);
}
`,SL=`
float linstep(float a, float b, float v) {
	return saturate((v - a) / (b - a));
}
float reduceLightBleeding(float pMax, float amount) {
	 return linstep(amount, 1.0, pMax);
}
float chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {
	float variance = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	float d = mean - moments.x;
	float pMax = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return (mean <= moments.x ? 1.0 : pMax);
}
float calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {
	Z = 2.0 * Z - 1.0;
	float warpedDepth = exp(exponent * Z);
	moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);
	float VSMBias = vsmBias;
	float depthScale = VSMBias * exponent * warpedDepth;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);
}
`,bL=`
attribute float vertex_boneIndices;
uniform vec4 matrix_pose[BONE_LIMIT * 3];
mat4 getBoneMatrix(const in float i) {
	vec4 v1 = matrix_pose[int(3.0 * i)];
	vec4 v2 = matrix_pose[int(3.0 * i + 1.0)];
	vec4 v3 = matrix_pose[int(3.0 * i + 2.0)];
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`,TL=`
attribute float vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
uniform vec4 texture_poseMapSize;
mat4 getBoneMatrix(const in float i) {
	float j = i * 3.0;
	float dx = texture_poseMapSize.z;
	float dy = texture_poseMapSize.w;
	float y = floor(j * dx);
	float x = j - (y * texture_poseMapSize.x);
	y = dy * (y + 0.5);
	vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));
	vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));
	vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`,wL=`
attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform vec4 matrix_pose[BONE_LIMIT * 3];
void getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {
	v1 = matrix_pose[int(3.0 * i)];
	v2 = matrix_pose[int(3.0 * i + 1.0)];
	v3 = matrix_pose[int(3.0 * i + 2.0)];
}
mat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {
	vec4 a1, a2, a3;
	getBoneMatrix(indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,EL=`
attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
uniform vec4 texture_poseMapSize;
void getBoneMatrix(const in float index, out vec4 v1, out vec4 v2, out vec4 v3) {
	float i = float(index);
	float j = i * 3.0;
	float dx = texture_poseMapSize.z;
	float dy = texture_poseMapSize.w;
	
	float y = floor(j * dx);
	float x = j - (y * texture_poseMapSize.x);
	y = dy * (y + 0.5);
	v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));
	v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));
	v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));
}
mat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {
	vec4 a1, a2, a3;
	getBoneMatrix(indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,AL=`
varying vec3 vViewDir;
uniform sampler2D texture_envAtlas;
uniform float mipLevel;
void main(void) {
	vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(normalize(dir));
	vec3 linear = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));
	gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
}
`,CL=`
varying vec3 vViewDir;
uniform samplerCube texture_cubeMap;
#ifdef SKYMESH
	varying vec3 vWorldPos;
	uniform mat3 cubeMapRotationMatrix;
	uniform vec3 projectedSkydomeCenter;
#endif
void main(void) {
	#ifdef SKYMESH
		vec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);
		vec3 dir = envDir * cubeMapRotationMatrix;
	#else
		vec3 dir = vViewDir;
	#endif
	dir.x *= -1.0;
	vec3 linear = $DECODE(textureCube(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)));
	gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
}
`,ML=`
attribute vec3 aPosition;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform mat4 matrix_projectionSkybox;
uniform mat3 cubeMapRotationMatrix;
varying vec3 vViewDir;
#ifdef SKYMESH
	uniform mat4 matrix_model;
	varying vec3 vWorldPos;
#endif
void main(void) {
	mat4 view = matrix_view;
	#ifdef SKYMESH
		vec4 worldPos = matrix_model * vec4(aPosition, 1.0);
		vWorldPos = worldPos.xyz;
		gl_Position = matrix_projectionSkybox * view * worldPos;
	#else
		view[3][0] = view[3][1] = view[3][2] = 0.0;
		gl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);
		vViewDir = aPosition * cubeMapRotationMatrix;
	#endif
	gl_Position.z = gl_Position.w - 0.00001;
}
`,PL=`
#ifdef MAPCOLOR
uniform vec3 material_specular;
#endif
void getSpecularity() {
	vec3 specularColor = vec3(1,1,1);
	#ifdef MAPCOLOR
	specularColor *= material_specular;
	#endif
	#ifdef MAPTEXTURE
	specularColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;
	#endif
	#ifdef MAPVERTEX
	specularColor *= saturate(vVertexColor.$VC);
	#endif
	dSpecularity = specularColor;
}
`,RL=`
const float PI = 3.141592653589793;
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec2 toSphericalUv(vec3 dir) {
	vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;
	return vec2(uv.x, 1.0 - uv.y);
}
`,IL=`
#ifdef MAPFLOAT
uniform float material_specularityFactor;
#endif
void getSpecularityFactor() {
	float specularityFactor = 1.0;
	#ifdef MAPFLOAT
	specularityFactor *= material_specularityFactor;
	#endif
	#ifdef MAPTEXTURE
	specularityFactor *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	specularityFactor *= saturate(vVertexColor.$VC);
	#endif
	dSpecularityFactor = specularityFactor;
}
`,DL=`
float getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {
	float cosAngle = dot(lightDirNorm, lightSpotDir);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}
`,LL=`
void main(void) {
	dReflection = vec4(0);
	#ifdef LIT_CLEARCOAT
	ccSpecularLight = vec3(0);
	ccReflection = vec3(0);
	#endif
`,FL=`
void main(void) {
	gl_Position = getPosition();
`,OL=`
	nineSlicedUv = vUv0;
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
`,BL=`
	vec2 tileMask = step(vMask, vec2(0.99999));
	vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);
	vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);
	vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
	
`,NL=`
float exponent = VSM_EXPONENT;
depth = 2.0 * depth - 1.0;
depth =  exp(exponent * depth);
gl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);
`,kL=`
vec3 getTangent() {
	return normalize(dNormalMatrix * vertex_tangent.xyz);
}
vec3 getBinormal() {
	return cross(vNormalW, vTangentW) * vertex_tangent.w;
}
`,UL=`
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	dTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));
}
`,zL=`
uniform float tbnBasis;
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	vec2 uv = $UV;
	vec3 dp1 = dFdx( vPositionW );
	vec3 dp2 = dFdy( vPositionW );
	vec2 duv1 = dFdx( uv );
	vec2 duv2 = dFdy( uv );
	vec3 dp2perp = cross( dp2, normal );
	vec3 dp1perp = cross( normal, dp1 );
	vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;
	vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;
	float denom = max( dot(T,T), dot(B,B) );
	float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );
	dTBN = mat3(T * invmax, -B * invmax, normal );
}
`,VL=`
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	dTBN = mat3(tangent, binormal, normal);
}
`,GL=`
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	vec3 B = cross(normal, vObjectSpaceUpW);
	vec3 T = cross(normal, B);
	if (dot(B,B)==0.0)
	{
		float major=max(max(normal.x, normal.y), normal.z);
		if (normal.x == major)
		{
			B=cross(normal, vec3(0,1,0));
			T=cross(normal, B);
		}
		else if (normal.y == major)
		{
			B=cross(normal, vec3(0,0,1));
			T=cross(normal, B);
		}
		else if (normal.z == major)
		{
			B=cross(normal, vec3(1,0,0));
			T=cross(normal, B);
		}
	}
	dTBN = mat3(normalize(T), normalize(B), normalize(normal));
}
`,WL=`
vec4 texture2DSRGB(sampler2D tex, vec2 uv) {
	return gammaCorrectInput(texture2D(tex, uv));
}
vec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {
	return gammaCorrectInput(texture2D(tex, uv, bias));
}
vec3 texture2DRGBM(sampler2D tex, vec2 uv) {
	return decodeRGBM(texture2D(tex, uv));
}
vec3 texture2DRGBM(sampler2D tex, vec2 uv, float bias) {
	return decodeRGBM(texture2D(tex, uv, bias));
}
vec3 texture2DRGBE(sampler2D tex, vec2 uv) {
	return decodeRGBM(texture2D(tex, uv));
}
vec3 texture2DRGBE(sampler2D tex, vec2 uv, float bias) {
	return decodeRGBM(texture2D(tex, uv, bias));
}
`,HL=`
#ifdef MAPFLOAT
uniform float material_thickness;
#endif
void getThickness() {
	dThickness = 1.0;
	#ifdef MAPFLOAT
	dThickness *= material_thickness;
	#endif
	#ifdef MAPTEXTURE
	dThickness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dThickness *= saturate(vVertexColor.$VC);
	#endif
}
`,XL=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	float tA = 2.51;
	float tB = 0.03;
	float tC = 2.43;
	float tD = 0.59;
	float tE = 0.14;
	vec3 x = color * exposure;
	return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);
}
`,$L=`
uniform float exposure;
const mat3 ACESInputMat = mat3(
	0.59719, 0.35458, 0.04823,
	0.07600, 0.90834, 0.01566,
	0.02840, 0.13383, 0.83777
);
const mat3 ACESOutputMat = mat3(
	 1.60475, -0.53108, -0.07367,
	-0.10208,  1.10813, -0.00605,
	-0.00327, -0.07276,  1.07602
);
vec3 RRTAndODTFit(vec3 v) {
	vec3 a = v * (v + 0.0245786) - 0.000090537;
	vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;
	return a / b;
}
vec3 toneMap(vec3 color) {
	color *= exposure / 0.6;
	color = color * ACESInputMat;
	color = RRTAndODTFit(color);
	color = color * ACESOutputMat;
	color = clamp(color, 0.0, 1.0);
	return color;
}
`,qL=`
const float A =  0.15;
const float B =  0.50;
const float C =  0.10;
const float D =  0.20;
const float E =  0.02;
const float F =  0.30;
const float W =  11.2;
uniform float exposure;
vec3 uncharted2Tonemap(vec3 x) {
	 return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
}
vec3 toneMap(vec3 color) {
	color = uncharted2Tonemap(color * exposure);
	vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));
	color = color * whiteScale;
	return color;
}
`,jL=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;
	const float Scl = 1.25;
	vec3 h = max( vec3(0.0), color - vec3(0.004) );
	return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);
}
`,YL=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	return color * exposure;
}
`,KL=`
vec3 toneMap(vec3 color) {
	return color;
}
`,ZL=`
#ifdef PIXELSNAP
uniform vec4 uScreenSize;
#endif
#ifdef SCREENSPACE
uniform float projectionFlipY;
#endif
#ifdef MORPHING
uniform vec4 morph_weights_a;
uniform vec4 morph_weights_b;
#endif
#ifdef MORPHING_TEXTURE_BASED
	uniform vec4 morph_tex_params;
	#ifdef WEBGPU
		ivec2 getTextureMorphCoords() {
			ivec2 textureSize = ivec2(morph_tex_params.xy);
			int morphGridV = int(morph_vertex_id / textureSize.x);
			int morphGridU = int(morph_vertex_id - (morphGridV * textureSize.x));
			morphGridV = textureSize.y - morphGridV - 1;
			return ivec2(morphGridU, morphGridV);
		}
	#else
		vec2 getTextureMorphCoords() {
			vec2 textureSize = morph_tex_params.xy;
			vec2 invTextureSize = morph_tex_params.zw;
			float morphGridV = floor(morph_vertex_id * invTextureSize.x);
			float morphGridU = morph_vertex_id - (morphGridV * textureSize.x);
			return vec2(morphGridU, morphGridV) * invTextureSize + (0.5 * invTextureSize);
		}
	#endif
#endif
#ifdef MORPHING_TEXTURE_BASED_POSITION
uniform highp sampler2D morphPositionTex;
#endif
mat4 getModelMatrix() {
	#ifdef DYNAMICBATCH
	return getBoneMatrix(vertex_boneIndices);
	#elif defined(SKIN)
	return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
	#elif defined(INSTANCING)
	return mat4(instance_line1, instance_line2, instance_line3, instance_line4);
	#else
	return matrix_model;
	#endif
}
vec4 getPosition() {
	dModelMatrix = getModelMatrix();
	vec3 localPos = vertex_position;
	#ifdef NINESLICED
	localPos.xz *= outerScale;
	vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
	vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
	localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
	vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;
	localPos.xz *= -0.5;
	localPos = localPos.xzy;
	#endif
	#ifdef MORPHING
	#ifdef MORPHING_POS03
	localPos.xyz += morph_weights_a[0] * morph_pos0;
	localPos.xyz += morph_weights_a[1] * morph_pos1;
	localPos.xyz += morph_weights_a[2] * morph_pos2;
	localPos.xyz += morph_weights_a[3] * morph_pos3;
	#endif
	#ifdef MORPHING_POS47
	localPos.xyz += morph_weights_b[0] * morph_pos4;
	localPos.xyz += morph_weights_b[1] * morph_pos5;
	localPos.xyz += morph_weights_b[2] * morph_pos6;
	localPos.xyz += morph_weights_b[3] * morph_pos7;
	#endif
	#endif
	#ifdef MORPHING_TEXTURE_BASED_POSITION
		#ifdef WEBGPU
			ivec2 morphUV = getTextureMorphCoords();
			vec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;
		#else
			vec2 morphUV = getTextureMorphCoords();
			vec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;
		#endif
		localPos += morphPos;
	#endif
	vec4 posW = dModelMatrix * vec4(localPos, 1.0);
	#ifdef SCREENSPACE
	posW.zw = vec2(0.0, 1.0);
	#endif
	dPositionW = posW.xyz;
	vec4 screenPos;
	#ifdef UV1LAYOUT
	screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);
		#ifdef WEBGPU
		screenPos.y *= -1.0;
		#endif
	#else
	#ifdef SCREENSPACE
	screenPos = posW;
	screenPos.y *= projectionFlipY;
	#else
	screenPos = matrix_viewProjection * posW;
	#endif
	#ifdef PIXELSNAP
	screenPos.xy = (screenPos.xy * 0.5) + 0.5;
	screenPos.xy *= uScreenSize.xy;
	screenPos.xy = floor(screenPos.xy);
	screenPos.xy *= uScreenSize.zw;
	screenPos.xy = (screenPos.xy * 2.0) - 1.0;
	#endif
	#endif
	return screenPos;
}
vec3 getWorldPosition() {
	return dPositionW;
}
`,QL=`
attribute vec3 vertex_position;
uniform mat4 matrix_model;
uniform mat4 matrix_viewProjection;
vec3 dPositionW;
mat4 dModelMatrix;
`,JL=`
#ifdef MAPFLOAT
uniform float material_refraction;
#endif
void getRefraction() {
	float refraction = 1.0;
	#ifdef MAPFLOAT
	refraction = material_refraction;
	#endif
	#ifdef MAPTEXTURE
	refraction *= texture2DBias($SAMPLER, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	refraction *= saturate(vVertexColor.$VC);
	#endif
	dTransmission = refraction;
}
`,e2=`
#ifdef NINESLICED
vec2 getUv0() {
	vec2 uv = vertex_position.xz;
	vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
	vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
	uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
	uv = uv * -0.5 + 0.5;
	uv = uv * atlasRect.zw + atlasRect.xy;
	vMask = vertex_texCoord0.xy;
	return uv;
}
#else
vec2 getUv0() {
	return vertex_texCoord0;
}
#endif
`,t2=`
vec2 getUv1() {
	return vertex_texCoord1;
}
`,s2=`
void getViewDir() {
	dViewDirW = normalize(view_position - vPositionW);
}
`,i2=`
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
vec3 getViewNormal() {
	return mat3(matrix_view) * vNormalW;
}
`;const z={alphaTestPS:TR,ambientConstantPS:wR,ambientEnvPS:ER,ambientSHPS:AR,aoPS:CR,aoDetailMapPS:MR,aoDiffuseOccPS:PR,aoSpecOccPS:RR,aoSpecOccConstPS:IR,aoSpecOccConstSimplePS:DR,aoSpecOccSimplePS:LR,basePS:FR,baseVS:OR,baseNineSlicedPS:BR,baseNineSlicedVS:NR,baseNineSlicedTiledPS:kR,bayerPS:UR,biasConstPS:zR,blurVSMPS:VR,clearCoatPS:GR,clearCoatGlossPS:WR,clearCoatNormalPS:HR,clusteredLightCookiesPS:$R,clusteredLightShadowsPS:qR,clusteredLightUtilsPS:XR,clusteredLightPS:jR,combinePS:YR,cookiePS:KR,cubeMapProjectBoxPS:ZR,cubeMapProjectNonePS:QR,cubeMapRotatePS:JR,debugOutputPS:eI,debugProcessFrontendPS:tI,detailModesPS:sI,diffusePS:iI,diffuseDetailMapPS:nI,decodePS:ox,emissivePS:rI,encodePS:lx,endPS:aI,endVS:oI,envAtlasPS:lI,envConstPS:hI,envMultiplyPS:cI,extensionPS:dI,extensionVS:uI,falloffInvSquaredPS:fI,falloffLinearPS:pI,fixCubemapSeamsNonePS:mI,fixCubemapSeamsStretchPS:_I,floatUnpackingPS:gI,fogExpPS:yI,fogExp2PS:vI,fogLinearPS:xI,fogNonePS:SI,fresnelSchlickPS:bI,fullscreenQuadPS:TI,fullscreenQuadVS:wI,gamma1_0PS:EI,gamma2_2PS:AI,gles2PS:Hv,gles3PS:Xv,gles3VS:$v,glossPS:CI,iridescenceDiffractionPS:MI,iridescencePS:PI,iridescenceThicknessPS:RI,instancingVS:II,iorPS:DI,lightDiffuseLambertPS:LI,lightDirPointPS:FI,lightmapAddPS:OI,lightmapDirAddPS:BI,lightmapDirPS:NI,lightmapSinglePS:kI,lightSpecularAnisoGGXPS:UI,lightSpecularBlinnPS:zI,lightSpecularPhongPS:VI,lightSheenPS:GI,linearizeDepthPS:WI,litShaderArgsPS:HI,ltcPS:XI,metalnessPS:$I,metalnessModulatePS:jI,msdfPS:qI,msdfVS:YI,normalVS:KI,normalDetailMapPS:ZI,normalInstancedVS:QI,normalMapPS:JI,normalSkinnedVS:eD,normalXYPS:tD,normalXYZPS:sD,opacityPS:iD,opacityDitherPS:nD,outputPS:rD,outputAlphaPS:aD,outputAlphaOpaquePS:oD,outputAlphaPremulPS:lD,outputTex2DPS:hD,packDepthPS:cD,sheenPS:dD,sheenGlossPS:uD,parallaxPS:fD,particlePS:pD,particleVS:mD,particleAnimFrameClampVS:_D,particleAnimFrameLoopVS:gD,particleAnimTexVS:yD,particleInputFloatPS:vD,particleInputRgba8PS:xD,particleOutputFloatPS:SD,particleOutputRgba8PS:bD,particleUpdaterAABBPS:TD,particleUpdaterEndPS:wD,particleUpdaterInitPS:ED,particleUpdaterNoRespawnPS:AD,particleUpdaterOnStopPS:CD,particleUpdaterRespawnPS:MD,particleUpdaterSpherePS:PD,particleUpdaterStartPS:RD,particle_billboardVS:ID,particle_blendAddPS:DD,particle_blendMultiplyPS:LD,particle_blendNormalPS:FD,particle_cpuVS:OD,particle_cpu_endVS:BD,particle_customFaceVS:ND,particle_endPS:kD,particle_endVS:UD,particle_halflambertPS:zD,particle_initVS:VD,particle_lambertPS:GD,particle_lightingPS:WD,particle_localShiftVS:HD,particle_meshVS:XD,particle_normalVS:$D,particle_normalMapPS:qD,particle_pointAlongVS:jD,particle_softPS:YD,particle_softVS:KD,particle_stretchVS:ZD,particle_TBNVS:QD,particle_wrapVS:JD,reflDirPS:eL,reflDirAnisoPS:tL,reflectionCCPS:sL,reflectionCubePS:iL,reflectionEnvHQPS:nL,reflectionEnvPS:rL,reflectionSpherePS:aL,reflectionSheenPS:oL,refractionCubePS:lL,refractionDynamicPS:hL,reprojectPS:cL,sampleCatmullRomPS:dL,screenDepthPS:uL,shadowCascadesPS:fL,shadowEVSMPS:pL,shadowEVSMnPS:mL,shadowPCSSPS:_L,shadowSampleCoordPS:gL,shadowStandardPS:yL,shadowStandardGL2PS:vL,shadowVSM8PS:xL,shadowVSM_commonPS:SL,skinBatchConstVS:bL,skinBatchTexVS:TL,skinConstVS:wL,skinTexVS:EL,skyboxEnvPS:AL,skyboxHDRPS:CL,skyboxVS:ML,specularPS:PL,sphericalPS:RL,specularityFactorPS:IL,spotPS:DL,startPS:LL,startVS:FL,startNineSlicedPS:OL,startNineSlicedTiledPS:BL,storeEVSMPS:NL,tangentBinormalVS:kL,TBNPS:UL,TBNderivativePS:zL,TBNfastPS:VL,TBNObjectSpacePS:GL,textureSamplePS:WL,thicknessPS:HL,tonemappingAcesPS:XL,tonemappingAces2PS:$L,tonemappingFilmicPS:qL,tonemappingHejlPS:jL,tonemappingLinearPS:YL,tonemappingNonePS:KL,transformVS:ZL,transformDeclVS:QL,transmissionPS:JL,uv0VS:e2,uv1VS:t2,viewDirPS:s2,viewNormalVS:i2,webgpuPS:qv,webgpuVS:jv},hx=new Rs;function Us(o){return hx.get(o)}function cx(o,e){hx.get(o,()=>e)}class me{static begin(){return`void main(void)
{
`}static end(){return`}
`}static skinCode(e,t=z){return e.supportsBoneTextures?t.skinTexVS:"#define BONE_LIMIT "+e.getBoneLimit()+`
`+t.skinConstVS}static fogCode(e,t=z){return e==="linear"?t.fogLinearPS?t.fogLinearPS:z.fogLinearPS:e==="exp"?t.fogExpPS?t.fogExpPS:z.fogExpPS:e==="exp2"?t.fogExp2PS?t.fogExp2PS:z.fogExp2PS:t.fogNonePS?t.fogNonePS:z.fogNonePS}static gammaCode(e,t=z){return e===om||e===q0?t.gamma2_2PS?t.gamma2_2PS:z.gamma2_2PS:e===Oo?`#define HDR
`+(t.gamma2_2PS?t.gamma2_2PS:z.gamma2_2PS):t.gamma1_0PS?t.gamma1_0PS:z.gamma1_0PS}static tonemapCode(e,t=z){return e===j0?t.tonemappingFilmicPS?t.tonemappingFilmicPS:z.tonemappingFilmicPS:e===Bo?t.tonemappingLinearPS?t.tonemappingLinearPS:z.tonemappingLinearPS:e===Y0?t.tonemappingHejlPS?t.tonemappingHejlPS:z.tonemappingHejlPS:e===K0?t.tonemappingAcesPS?t.tonemappingAcesPS:z.tonemappingAcesPS:e===Z0?t.tonemappingAces2PS?t.tonemappingAces2PS:z.tonemappingAces2PS:t.tonemapingNonePS?t.tonemapingNonePS:z.tonemappingNonePS}}function dx(o,e,t,s=!1,i={}){return typeof s=="boolean"?i.useTransformFeedback=s:typeof s=="object"&&(i=gt({},i,s)),new Is(o,je.createDefinition(o,gt({},i,{name:`${e}_${t}`,vertexCode:z[e],fragmentCode:z[t]})))}function zt(o,e,t,s,i,n=!1,r={}){typeof n=="boolean"?r.useTransformFeedback=n:typeof n=="object"&&(r=gt({},r,n));const a=Us(o);let l=a.getCachedShader(s);return l||(l=new Is(o,je.createDefinition(o,gt({},r,{name:s,vertexCode:e,fragmentCode:t,attributes:i}))),a.setCachedShader(s,l)),l}class n2 extends me{constructor(e,t){super(),this.key=e,this.shaderDefinition=t}generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}}function ux(o,e){var t;const s=o.definition,n=`${(t=s.name)!=null?t:"shader"}-id-${o.id}`,r=new n2(n,s),a="shader",l=Us(o.device);l.register(a,r);const h=l.getProgram(a,{},e);return o.definition.shaderLanguage===mo&&(h.meshUniformBufferFormat=s.meshUniformBufferFormat,h.meshBindGroupFormat=s.meshBindGroupFormat),l.unregister(a),h}z.createShader=dx,z.createShaderFromCode=zt;const r2={type:As,base:0,count:4,indexed:!1},Xh=new X,$h=new X;class qh{constructor(e){this.uniformBuffer=void 0,this.bindGroup=void 0;const t=e.device;if(this.shader=e,t.supportsUniformBuffers){const s=new Zi;this.shader=ux(e,s);const i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new Ed(t,i,!1));const n=this.shader.meshBindGroupFormat;this.bindGroup=new Ch(t,n,this.uniformBuffer)}}destroy(){var e,t;(e=this.uniformBuffer)==null||e.destroy(),this.uniformBuffer=null,(t=this.bindGroup)==null||t.destroy(),this.bindGroup=null}render(e,t){const s=this.shader.device;if(e){var i;Xh.set(s.vx,s.vy,s.vw,s.vh),$h.set(s.sx,s.sy,s.sw,s.sh),t=(i=t)!=null?i:e,s.setViewport(e.x,e.y,e.z,e.w),s.setScissor(t.x,t.y,t.z,t.w)}s.setVertexBuffer(s.quadVertexBuffer,0);const n=this.shader;if(s.setShader(n),s.supportsUniformBuffers){var r;const a=this.bindGroup;(r=a.defaultUniformBuffer)==null||r.update(),a.update(),s.setBindGroup(So,a)}s.draw(r2),e&&(s.setViewport(Xh.x,Xh.y,Xh.z,Xh.w),s.setScissor($h.x,$h.y,$h.z,$h.w))}}class a2 extends Ot{constructor(e,t,s,i){super(e),this.quad=t,this.rect=s,this.scissorRect=i}execute(){const{device:e}=this;e.setCullMode(Je),e.setDepthState(ft.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}}const o2=new X;function _s(o,e,t,s,i){const n=new qh(t);s||(s=o2,s.x=0,s.y=0,s.z=e?e.width:o.width,s.w=e?e.height:o.height);const r=new a2(o,n,s,i);r.init(e),r.colorOps.clear=!1,r.depthStencilOps.clearDepth=!1,o.isWebGPU&&e===null&&o.samples>1&&(r.colorOps.store=!0),r.render(),n.destroy()}function l2(o,e,t,s,i,n){s=s||o.getCopyShader(),o.constantTexSource.setValue(e),_s(o,t,s,i,n)}const h2=new Rs;class c2{constructor(e,t,s={}){this.index=void 0,this.name=void 0,this.shaderDefines=void 0,this.name=e,this.index=t,Object.assign(this,s),this.shaderDefines=this.buildShaderDefines()}buildShaderDefines(){let e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":this.index===ui?e="DEPTH":this.index===ea&&(e="PICK");const t=e?`#define ${e}_PASS
`:"",s=`#define ${this.name.toUpperCase()}_PASS
`;return t+s}}class zs{constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;const e=(t,s,i)=>{this.allocate(t,i)};e("forward",Wo,{isForward:!0}),e("forward_hdr",di,{isForward:!0}),e("depth"),e("pick"),e("shadow"),e("prepass")}static get(e){return h2.get(e,()=>new zs)}allocate(e,t){let s=this.passesNamed.get(e);return s===void 0&&(s=new c2(e,this.nextIndex,t),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}}class d2 extends me{generateKey(e){let t="basic";return e.fog&&(t+="_fog"),e.alphaTest&&(t+="_atst"),e.vertexColors&&(t+="_vcol"),e.diffuseMap&&(t+="_diff"),e.skin&&(t+="_skin"),e.screenSpace&&(t+="_ss"),e.useInstancing&&(t+="_inst"),e.useMorphPosition&&(t+="_morphp"),e.useMorphNormal&&(t+="_morphn"),e.useMorphTextureBased&&(t+="_morpht"),t+="_"+e.pass,t}createShaderDefinition(e,t){const s={vertex_position:We};t.skin&&(s.vertex_boneWeights=ti,s.vertex_boneIndices=Kt),t.vertexColors&&(s.vertex_color=_t),t.diffuseMap&&(s.vertex_texCoord0=Lt);const n=zs.get(e).getByIndex(t.pass).shaderDefines;let r=n;r+=z.transformDeclVS,t.skin?(r+=me.skinCode(e),r+=z.transformSkinnedVS):r+=z.transformVS,t.vertexColors&&(r+=`attribute vec4 vertex_color;
`,r+=`varying vec4 vColor;
`),t.diffuseMap&&(r+=`attribute vec2 vertex_texCoord0;
`,r+=`varying vec2 vUv0;
`),t.pass===ui&&(r+=`varying float vDepth;
`,r+=`#ifndef VIEWMATRIX
`,r+=`#define VIEWMATRIX
`,r+=`uniform mat4 matrix_view;
`,r+=`#endif
`,r+=`#ifndef CAMERAPLANES
`,r+=`#define CAMERAPLANES
`,r+=`uniform vec4 camera_params;

`,r+=`#endif
`),r+=me.begin(),r+=`   gl_Position = getPosition();
`,t.pass===ui&&(r+=`    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;
`),t.vertexColors&&(r+=`    vColor = vertex_color;
`),t.diffuseMap&&(r+=`    vUv0 = vertex_texCoord0;
`),r+=me.end();let a=n;return t.vertexColors?a+=`varying vec4 vColor;
`:a+=`uniform vec4 uColor;
`,t.diffuseMap&&(a+=`varying vec2 vUv0;
`,a+=`uniform sampler2D texture_diffuseMap;
`),t.fog&&(a+=me.fogCode(t.fog)),t.alphaTest&&(a+=z.alphaTestPS),t.pass===ui&&(a+=`varying float vDepth;
`,a+=z.packDepthPS),a+=me.begin(),t.vertexColors?a+=`    gl_FragColor = vColor;
`:a+=`    gl_FragColor = uColor;
`,t.diffuseMap&&(a+=`    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);
`),t.alphaTest&&(a+=`   alphaTest(gl_FragColor.a);
`),t.pass!==ea&&(t.pass===ui?a+=`    gl_FragColor = packFloat(vDepth);
`:t.fog&&(a+=`   glFragColor.rgb = addFog(gl_FragColor.rgb);
`)),a+=me.end(),je.createDefinition(e,{name:"BasicShader",attributes:s,vertexCode:r,fragmentCode:a})}}const u2=new d2,fx=new Rs;function Xo(o){return fx.get(o)}function f2(o,e){fx.get(o,()=>e)}const rs=[];rs[Qp]={src:ut,dst:ut,op:Dy},rs[Nt]={src:ut,dst:Fl,op:hs},rs[Bt]={src:Ol,dst:Bl,op:hs},rs[jn]={src:ut,dst:Bl,op:hs},rs[Od]={src:ut,dst:ut,op:hs},rs[Nd]={src:Ol,dst:ut,op:hs},rs[Jp]={src:$c,dst:up,op:hs},rs[em]={src:fp,dst:ut,op:hs},rs[Bd]={src:$c,dst:Fl,op:hs},rs[tm]={src:ut,dst:ut,op:Ly},rs[sm]={src:ut,dst:ut,op:Fy};let p2=0;class pt{constructor(){this._shader=null,this.meshInstances=[],this.name="Untitled",this.userId="",this.id=p2++,this.variants=new Map,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Ee,this._depthState=new ft,this.cull=Ai,this.stencilFront=null,this.stencilBack=null,this._shaderVersion=0,this._scene=null,this.dirty=!0}set depthBias(e){this._depthState.depthBias=e}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e}get alphaWrite(){return this._blendState.alphaWrite}set shader(e){this._shader=e}get shader(){return this._shader}get transparent(){return this._blendState.blend}_updateTransparency(){const e=this.transparent,t=this.meshInstances;for(let s=0;s<t.length;s++)t[s].transparent=e}set blendState(e){this._blendState.copy(e),this._updateTransparency()}get blendState(){return this._blendState}set blendType(e){const t=rs[e];this._blendState.setColorBlend(t.op,t.src,t.dst),this._blendState.setAlphaBlend(t.op,t.src,t.dst);const s=e!==Nt;this._blendState.blend!==s&&(this._blendState.blend=s,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return Nt;const{colorOp:e,colorSrcFactor:t,colorDstFactor:s,alphaOp:i,alphaSrcFactor:n,alphaDstFactor:r}=this._blendState;for(let a=0;a<rs.length;a++){const l=rs[a];if(l.src===t&&l.dst===s&&l.op===e&&l.src===n&&l.dst===r&&l.op===i)return a}return Bt}set depthState(e){this._depthState.copy(e)}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e}get depthWrite(){return this._depthState.write}copy(e){var t;return this.name=e.name,this._shader=e._shader,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=(t=e.stencilFront)==null?void 0:t.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this}clone(){return new this.constructor().copy(this)}_updateMeshInstanceKeys(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].updateKey()}updateUniforms(e,t){}getShaderVariant(e,t,s,i,n,r,a,l,h){const c=new Zi(a,l,h);return ux(this._shader,c)}update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();const e=this.meshInstances,t=e.length;for(let s=0;s<t;s++)e[s].clearShaders()}getParameter(e){return this.parameters[e]}setParameter(e,t){if(t===void 0&&typeof e=="object"){const i=e;if(i.length){for(let n=0;n<i.length;n++)this.setParameter(i[n]);return}e=i.name,t=i.value}const s=this.parameters[e];s?s.data=t:this.parameters[e]={scopeId:null,data:t}}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;t===void 0&&(t=s);for(const i in t){const n=s[i];n&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data))}}destroy(){this.variants.clear(),this._shader=null;for(let e=0;e<this.meshInstances.length;e++){const t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){const s=Xo(t.mesh.device);this!==s&&(t.material=s)}}this.meshInstances.length=0}addMeshInstanceRef(e){this.meshInstances.push(e)}removeMeshInstanceRef(e){const t=this.meshInstances,s=t.indexOf(e);s!==-1&&t.splice(s,1)}}class bm extends pt{constructor(...e){super(...e),this.color=new H(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}copy(e){return super.copy(e),this.color.copy(e.color),this.colorMap=e.colorMap,this.vertexColors=e.vertexColors,this}updateUniforms(e,t){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)}getShaderVariant(e,t,s,i,n,r,a,l,h){const c={skin:s&&(s&No)!==0,screenSpace:s&&(s&Uo)!==0,useInstancing:s&&(s&ko)!==0,useMorphPosition:s&&(s&zo)!==0,useMorphNormal:s&&(s&Vo)!==0,useMorphTextureBased:s&&(s&Go)!==0,alphaTest:this.alphaTest>0,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},d=new Zi(a,l,h),u=Us(e);return u.register("basic",u2),u.getProgram("basic",c,d,this.userId)}}class Kd{constructor(e,t,s){this._aabb=new ye,this.origMeshInstances=void 0,this.meshInstance=null,this.dynamic=void 0,this.batchGroupId=void 0,this.origMeshInstances=e,this.dynamic=t,this.batchGroupId=s}destroy(e,t){this.meshInstance&&(this.removeFromLayers(e,t),this.meshInstance.destroy(),this.meshInstance=null)}addToLayers(e,t){for(let s=0;s<t.length;s++){const i=e.layers.getLayerById(t[s]);i&&i.addMeshInstances([this.meshInstance])}}removeFromLayers(e,t){for(let s=0;s<t.length;s++){const i=e.layers.getLayerById(t[s]);i&&i.removeMeshInstances([this.meshInstance])}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let e=1;e<this.origMeshInstances.length;e++)this._aabb.add(this.origMeshInstances[e].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0}}class it{constructor(e,t,s,i,n=[is]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=void 0,this.name=void 0,this.dynamic=void 0,this.maxAabbSize=void 0,this.layers=void 0,this.id=e,this.name=t,this.dynamic=s,this.maxAabbSize=i,this.layers=n}}it.MODEL="model",it.ELEMENT="element",it.SPRITE="sprite",it.RENDER="render";const px=new W;class ta{constructor(e){this.bones=void 0,this.boneTextureSize=void 0,this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}set rootBone(e){this._rootBone=e}get rootBone(){return this._rootBone}init(e,t){if(e.supportsBoneTextures){const s=t*3;let i=Math.ceil(Math.sqrt(s));i=U.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new re(e,{width:i,height:n,format:Ge,mipmaps:!1,minFilter:de,magFilter:de,name:"skin"}),this.boneTextureSize=[i,n,1/i,1/n],this.matrixPalette=this.boneTexture.lock({mode:vp}),this.boneTexture.unlock()}else this.matrixPalette=new Float32Array(t*12)}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(e,t){this.rootBone=e;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const r=s.boneNames[n];let a=e.findByName(r);a||(a=t),i.push(a)}this.bones=i}initSkin(e){this.skin=e,this.bones=[];const t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(let s=0;s<t;s++)this.matrices[s]=new W}uploadBones(e){e.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,px.copy(e.getWorldTransform()).invert();for(let s=this.bones.length-1;s>=0;s--)this.matrices[s].mulAffine2(px,this.bones[s].getWorldTransform()),this.matrices[s].mulAffine2(this.matrices[s],this.skin.inverseBindPose[s])}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)}updateMatrixPalette(e,t){this._updateMatrices(e,t);const s=this.matrixPalette,i=this.bones.length;for(let n=0;n<i;n++){const r=this.matrices[n].data,a=n*12;s[a]=r[0],s[a+1]=r[4],s[a+2]=r[8],s[a+3]=r[12],s[a+4]=r[1],s[a+5]=r[5],s[a+6]=r[9],s[a+7]=r[13],s[a+8]=r[2],s[a+9]=r[6],s[a+10]=r[10],s[a+11]=r[14]}this.uploadBones(this.skin.device)}}class Tm extends ta{constructor(e,t,s){super();const i=t.length;this.init(e,i),this.device=e,this.rootNode=s,this.bones=t}updateMatrices(e,t){}updateMatrixPalette(e,t){const s=this.matrixPalette,i=this.bones.length;for(let n=0;n<i;n++){const r=this.bones[n].getWorldTransform().data,a=n*12;s[a]=r[0],s[a+1]=r[4],s[a+2]=r[8],s[a+3]=r[12],s[a+4]=r[1],s[a+5]=r[5],s[a+6]=r[9],s[a+7]=r[13],s[a+8]=r[2],s[a+9]=r[6],s[a+10]=r[10],s[a+11]=r[14]}this.uploadBones(this.device)}}const mx=new W,wm=new y,_x=new Z,Em=new Z,gx=new y,yx=new y,m2=new W,_2=new Z,gs=new y,vx=new W,ys=new Z,$o=new Z,xx=new W,Am=new y,Zd=new y;function Sx(o,e){return o instanceof Function?o:t=>{let s=t[o];return s instanceof Function&&(s=s()),s===e}}function bx(o,e){if(e(o))return o;const t=o._children,s=t.length;for(let i=0;i<s;++i){const n=bx(t[i],e);if(n)return n}return null}class we extends Q{constructor(e="Untitled"){super(),this.name=void 0,this.tags=new Va(this),this._labels={},this.localPosition=new y,this.localRotation=new Z,this.localScale=new y(1,1,1),this.localEulerAngles=new y,this.position=new y,this.rotation=new Z,this.eulerAngles=new y,this._scale=null,this.localTransform=new W,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new W,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new ls,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=e}get right(){return this._right||(this._right=new y),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new y),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new y),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){const e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),e}set enabled(e){if(this._enabled!==e){var t;this._enabled=e,(e&&(t=this._parent)!=null&&t.enabled||!e)&&this._notifyHierarchyStateChanged(this,e)}}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let e=this._parent;if(!e)return"";let t=this.name;for(;e&&e._parent;)t=`${e.name}/${t}`,e=e._parent;return t}get root(){let e=this;for(;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);const s=e._children;for(let i=0,n=s.length;i<n;i++)s[i]._enabled&&this._notifyHierarchyStateChanged(s[i],t)}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(e){e.name=this.name;const t=this.tags._list;e.tags.clear();for(let s=0;s<t.length;s++)e.tags.add(t[s]);e._labels=Object.assign({},this._labels),e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1}clone(){const e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();const e=this._children;for(;e.length;){const t=e.pop();t._parent=null,t.destroy()}this.fire("destroy",this),this.off()}find(e,t){const s=[],i=Sx(e,t);return this.forEach(n=>{i(n)&&s.push(n)}),s}findOne(e,t){const s=Sx(e,t);return bx(this,s)}findByTag(){const e=arguments,t=[],s=(i,n)=>{n&&i.tags.has(...e)&&t.push(i);for(let r=0;r<i._children.length;r++)s(i._children[r],!0)};return s(this,!1),t}findByName(e){return this.findOne("name",e)}findByPath(e){const t=Array.isArray(e)?e:e.split("/");let s=this;for(let i=0,n=t.length;i<n;++i)if(s=s.children.find(r=>r.name===t[i]),!s)return null;return s}forEach(e,t){e.call(t,this);const s=this._children,i=s.length;for(let n=0;n<i;++n)s[n].forEach(e,t)}isDescendantOf(e){let t=this._parent;for(;t;){if(t===e)return!0;t=t._parent}return!1}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new y),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return!this._dirtyLocal&&!this._dirtyWorld?this.worldTransform:(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform)}get worldScaleSign(){return this._worldScaleSign===0&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){var e;(e=this._parent)==null||e.removeChild(this)}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this))}setLocalEulerAngles(e,t,s){this.localRotation.setFromEulerAngles(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(e,t,s){e instanceof y?this.localPosition.copy(e):this.localPosition.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(e,t,s,i){e instanceof Z?this.localRotation.copy(e):this.localRotation.set(e,t,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(e,t,s){e instanceof y?this.localScale.copy(e):this.localScale.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let e=this._parent;for(;e;)e._frozen=!1,e=e._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(e,t,s){e instanceof y?gs.copy(e):gs.set(e,t,s),this._parent===null?this.localPosition.copy(gs):(vx.copy(this._parent.getWorldTransform()).invert(),vx.transformPoint(gs,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(e,t,s,i){if(e instanceof Z?ys.copy(e):ys.set(e,t,s,i),this._parent===null)this.localRotation.copy(ys);else{const n=this._parent.getRotation();$o.copy(n).invert(),this.localRotation.copy($o).mul(ys)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(e,t,s){if(this.localRotation.setFromEulerAngles(e,t,s),this._parent!==null){const i=this._parent.getRotation();$o.copy(i).invert(),this.localRotation.mul2($o,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)}addChildAndSaveTransform(e){const t=e.getPosition(),s=e.getRotation();this._prepareInsertChild(e),e.setPosition(m2.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(_2.copy(this.getRotation()).invert().mul(s)),this._children.push(e),this._onInsertChild(e)}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e)}_prepareInsertChild(e){e.remove()}_fireOnHierarchy(e,t,s){this.fire(e,s);for(let i=0;i<this._children.length;i++)this._children[i]._fireOnHierarchy(t,t,s)}_onInsertChild(e){e._parent=this;const t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()}removeChild(e){const t=this._children.indexOf(e);t!==-1&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let e;const t=this._parent;let s=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(e=i.worldTransform.getScale(),gx.mul2(e,this.localScale),s=gx))}Em.setFromMat4(t.worldTransform),_x.mul2(Em,this.localRotation);let n=t.worldTransform;t.scaleCompensation&&(yx.mul2(e,t.getLocalScale()),mx.setTRS(t.worldTransform.getTranslation(wm),Em,yx),n=mx),n.transformPoint(this.localPosition,wm),this.worldTransform.setTRS(wm,_x,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled||this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const e=this._children;for(let t=0,s=e.length;t<s;t++)e[t].syncHierarchy()}lookAt(e,t,s,i=0,n=1,r=0){if(e instanceof y)Am.copy(e),t instanceof y?Zd.copy(t):Zd.copy(y.UP);else{if(s===void 0)return;Am.set(e,t,s),Zd.set(i,n,r)}xx.setLookAt(this.getPosition(),Am,Zd),ys.setFromMat4(xx),this.setRotation(ys)}translate(e,t,s){e instanceof y?gs.copy(e):gs.set(e,t,s),gs.add(this.getPosition()),this.setPosition(gs)}translateLocal(e,t,s){e instanceof y?gs.copy(e):gs.set(e,t,s),this.localRotation.transformVector(gs,gs),this.localPosition.add(gs),this._dirtyLocal||this._dirtifyLocal()}rotate(e,t,s){if(ys.setFromEulerAngles(e,t,s),this._parent===null)this.localRotation.mul2(ys,this.localRotation);else{const i=this.getRotation(),n=this._parent.getRotation();$o.copy(n).invert(),ys.mul2($o,ys),this.localRotation.mul2(ys,i)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(e,t,s){ys.setFromEulerAngles(e,t,s),this.localRotation.mul(ys),this._dirtyLocal||this._dirtifyLocal()}}class g2{constructor(){this.cache=new Map}destroy(){this.cache.forEach((e,t)=>{t.destroy()}),this.cache.clear()}incRef(e){const t=(this.cache.get(e)||0)+1;this.cache.set(e,t)}decRef(e){if(e){let t=this.cache.get(e);t&&(t--,t===0?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}}}class nn{static incRef(e){this.cache.incRef(e)}static decRef(e){this.cache.decRef(e)}static destroy(){this.cache.destroy()}}nn.cache=new g2;let y2=0;const v2=new ye,Qd=new ye,Cm=new Cn,Mm=new Set;class x2{constructor(e){this.vertexBuffer=null,this.count=e}}class S2{constructor(){this.shader=void 0,this.bindGroup=null}getBindGroup(e){if(!this.bindGroup){const t=this.shader,s=t.meshUniformBufferFormat,i=new Ed(e,s,!1),n=t.meshBindGroupFormat;this.bindGroup=new Ch(e,n,i)}return this.bindGroup}destroy(){const e=this.bindGroup;if(e){var t;(t=e.defaultUniformBuffer)==null||t.destroy(),e.destroy(),this.bindGroup=null}}}class b2{constructor(){this.shaderInstances=new Map}destroy(){this.shaderInstances.forEach(e=>e.destroy()),this.shaderInstances.clear()}}class Te{constructor(e,t,s=null){if(this.visible=!0,this.castShadow=!1,this.transparent=!1,this._material=null,this._shaderCache=[],this.id=y2++,this.pick=!0,e instanceof we){const i=e;e=t,t=s,s=i}this._key=[0,0],this.node=s,this._mesh=e,e.incRefCount(),this.material=t,this._shaderDefs=ns<<16,this._shaderDefs|=e.vertexBuffer.format.hasUv0?lm:0,this._shaderDefs|=e.vertexBuffer.format.hasUv1?hm:0,this._shaderDefs|=e.vertexBuffer.format.hasColor?cm:0,this._shaderDefs|=e.vertexBuffer.format.hasTangents?Hd:0,this.layer=im,this._renderStyle=Lo,this._receiveShadow=!0,this._screenSpace=!1,this.cull=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.gsplatInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new ye,this._aabbVer=-1,this._aabbMeshVer=-1,this.drawOrder=0,this.visibleThisFrame=!1,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFacesFactor=1}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount())}get mesh(){return this._mesh}set aabb(e){this._aabb=e}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let e=this._customAabb,t=!!e;if(!e){if(e=v2,this.skinInstance){if(!this.mesh.boneAabb){const n=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(n)}const s=this.mesh.boneUsed;let i=!0;for(let n=0;n<this.mesh.boneAabb.length;n++)s[n]&&(Qd.setFromTransformedAabb(this.mesh.boneAabb[n],this.skinInstance.matrices[n]),i?(i=!1,e.center.copy(Qd.center),e.halfExtents.copy(Qd.halfExtents)):e.add(Qd));t=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){const s=this.mesh.morph.aabb;e._expand(s.getMin(),s.getMax())}t=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){const e=this._shaderCache;for(let s=0;s<e.length;s++){var t;(t=e[s])==null||t.destroy(),e[s]=null}}getShaderInstance(e,t,s,i,n,r){let a,l=this._shaderCache[e];if(l?a=l.shaderInstances.get(t):(l=new b2,this._shaderCache[e]=l),!a){const h=this._material,c=this._shaderDefs,d=e+"_"+c+"_"+t;if(a=new S2,a.shader=h.variants.get(d),!a.shader){const u=h.getShaderVariant(this.mesh.device,s,c,null,e,r,i,n,this._mesh.vertexBuffer.format);h.variants.set(d,u),a.shader=u}l.shaderInstances.set(t,a)}return a}set material(e){this.clearShaders();const t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey())}get material(){return this._material}set layer(e){this._layer=e,this.updateKey()}get layer(){return this._layer}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders())}set calculateSortDistance(e){this._calculateSortDistance=e}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?this._shaderDefs&~Nh:this._shaderDefs|Nh))}get receiveShadow(){return this._receiveShadow}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?this._shaderDefs|No:this._shaderDefs&~No),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(e){var t;(t=this._morphInstance)==null||t.destroy(),this._morphInstance=e;let s=this._shaderDefs;s=e&&e.morph.useTextureMorph?s|Go:s&~Go,s=e&&e.morph.morphPositions?s|zo:s&~zo,s=e&&e.morph.morphNormals?s|Vo:s&~Vo,this._updateShaderDefs(s)}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?this._shaderDefs|Uo:this._shaderDefs&~Uo))}get screenSpace(){return this._screenSpace}set key(e){this._key[Li]=e}get key(){return this._key[Li]}set mask(e){const t=this._shaderDefs&65535;this._updateShaderDefs(t|e<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var e,t;const s=this.mesh;s&&(this.mesh=null,s.refCount<1&&s.destroy()),this.setRealtimeLightmap(Te.lightmapParamNames[0],null),this.setRealtimeLightmap(Te.lightmapParamNames[1],null),(e=this._skinInstance)==null||e.destroy(),this._skinInstance=null,(t=this.morphInstance)==null||t.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null}static _prepareRenderStyleForArray(e,t){if(e){for(let s=0;s<e.length;s++){e[s]._renderStyle=t;const i=e[s].mesh;Mm.has(i)||(Mm.add(i),i.prepareRenderState(t))}Mm.clear()}}_isVisible(e){return this.visible?this.isVisibleFunc?this.isVisibleFunc(e):(Cm.center=this.aabb.center,Cm.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(Cm)):!1}updateKey(){const e=this.material,t=e.alphaToCoverage||e.alphaTest?Bt:e.blendType;this._key[Li]=(this.layer&15)<<27|(t===Nt?1:0)<<26|(e.id&33554431)<<0}setInstancing(e,t=!1){e?(this.instancingData=new x2(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=!0,this.cull=t):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(e?this._shaderDefs|ko:this._shaderDefs&~ko)}ensureMaterial(e){this.material||(this.material=Xo(e))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,s=-262141){if(t===void 0&&typeof e=="object"){const n=e;if(n.length){for(let r=0;r<n.length;r++)this.setParameter(n[r]);return}e=n.name,t=n.value}const i=this.parameters[e];i?(i.data=t,i.passFlags=s):this.parameters[e]={scopeId:null,data:t,passFlags:s}}setRealtimeLightmap(e,t){const s=this.getParameter(e);s!==t&&(s&&nn.decRef(s.data),t?(nn.incRef(t),this.setParameter(e,t)):this.deleteParameter(e))}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&t&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(e){e?this.mask=(this.mask|hi)&~(ns|ci):(this.setRealtimeLightmap(Te.lightmapParamNames[0],null),this.setRealtimeLightmap(Te.lightmapParamNames[1],null),this._shaderDefs&=~(kh|Wd|Xd),this.mask=(this.mask|ns)&~(hi|ci))}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}Te.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];function Tx(o,e){if(o&&!e||!o&&e)return!1;if(o=o.data,e=e.data,o===e)return!0;if(o instanceof Float32Array&&e instanceof Float32Array){if(o.length!==e.length)return!1;for(let t=0;t<o.length;t++)if(o[t]!==e[t])return!1;return!0}return!1}function T2(o,e){for(const t in o)if(o.hasOwnProperty(t)&&!Tx(o[t],e[t]))return!1;for(const t in e)if(e.hasOwnProperty(t)&&!Tx(e[t],o[t]))return!1;return!0}const w2=[0,1,3,2,3,1],E2=[0,1,3,0,3,2],wx=new ls;function Pm(o){return o.node.worldTransform.scaleSign}class Ex{constructor(e,t,s){this.device=e,this.rootNode=t,this.scene=s,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]}addGroup(e,t,s,i,n){if(i===void 0&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;const r=new it(i,e,t,s,n);return this._batchGroups[i]=r,r}removeGroup(e){if(!this._batchGroups[e])return;const t=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===e?this.destroyBatch(this._batchList[s]):t.push(this._batchList[s]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e]}markGroupDirty(e){this._dirtyGroups.indexOf(e)<0&&this._dirtyGroups.push(e)}getGroupByName(e){const t=this._batchGroups;for(const s in t)if(t.hasOwnProperty(s)&&t[s].name===e)return t[s];return null}getBatches(e){const t=[],s=this._batchList.length;for(let i=0;i<s;i++){const n=this._batchList[i];n.batchGroupId===e&&t.push(n)}return t}_removeModelsFromBatchGroup(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.render&&e.render.batchGroupId===t&&(e.render.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(let s=0;s<e._children.length;s++)this._removeModelsFromBatchGroup(e._children[s],t)}}insert(e,t,s){const i=this._batchGroups[t];i&&i._obj[e].indexOf(s)<0&&(i._obj[e].push(s),this.markGroupDirty(t))}remove(e,t,s){const i=this._batchGroups[t];if(i){const n=i._obj[e].indexOf(s);n>=0&&(i._obj[e].splice(n,1),this.markGroupDirty(t))}}_extractRender(e,t,s,i){return e.render&&(t=i[e.render.batchGroupId]=t.concat(e.render.meshInstances),e.render.removeFromLayers()),t}_extractModel(e,t,s,i){return e.model&&e.model.model&&(t=i[e.model.batchGroupId]=t.concat(e.model.meshInstances),e.model.removeModelFromLayers()),t}_extractElement(e,t,s){if(!e.element)return;let i=!1;e.element._text&&e.element._text._model.meshInstances.length>0?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),i=!0):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),(!e.element._image._renderable.unmaskMeshInstance.stencilFront||!e.element._image._renderable.unmaskMeshInstance.stencilBack)&&(e.element._dirtifyMask(),e.element._onPrerender())),i=!0),i&&(s._ui=!0)}_collectAndRemoveMeshInstances(e,t){for(let s=0;s<t.length;s++){const i=t[s],n=this._batchGroups[i];if(!n)continue;let r=e[i];r||(r=e[i]=[]);for(let a=0;a<n._obj.model.length;a++)r=this._extractModel(n._obj.model[a],r,n,e);for(let a=0;a<n._obj.render.length;a++)r=this._extractRender(n._obj.render[a],r,n,e);for(let a=0;a<n._obj.element.length;a++)this._extractElement(n._obj.element[a],r,n);for(let a=0;a<n._obj.sprite.length;a++){const l=n._obj.sprite[a];l.sprite&&l.sprite._meshInstance&&(n.dynamic||l.sprite.sprite._renderMode===Fi)&&(r.push(l.sprite._meshInstance),l.sprite.removeModelFromLayers(),n._sprite=!0,l.sprite._batchGroup=n)}}}generate(e){const t={};e||(e=Object.keys(this._batchGroups));const s=[];for(let l=0;l<this._batchList.length;l++){if(e.indexOf(this._batchList[l].batchGroupId)<0){s.push(this._batchList[l]);continue}this.destroyBatch(this._batchList[l])}if(this._batchList=s,this._collectAndRemoveMeshInstances(t,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else{const l=[];for(let h=0;h<this._dirtyGroups.length;h++)e.indexOf(this._dirtyGroups[h])<0&&l.push(this._dirtyGroups[h]);this._dirtyGroups=l}let i,n,r,a;for(const l in t)if(t.hasOwnProperty(l)&&(i=t[l],r=this._batchGroups[l],!!r)){n=this.prepare(i,r.dynamic,r.maxAabbSize,r._ui||r._sprite);for(let h=0;h<n.length;h++)a=this.create(n[h],r.dynamic,parseInt(l,10)),a&&a.addToLayers(this.scene,r.layers)}}prepare(e,t,s=Number.POSITIVE_INFINITY,i){if(e.length===0)return[];const n=s*.5,r=this.device.supportsBoneTextures?1024:this.device.boneLimit,a=this.device.extUintElement?4294967295:65535,l=new ye,h=new ye;let c=null,d;const u=[];let f=0;i&&e.sort(function(g,x){return g.drawOrder-x.drawOrder});let p=e,_;const m=i?function(g){c?c.add(g.aabb):c=g.aabb.clone(),_.push(g)}:function(g){_.push(g)};for(;p.length>0;){u[f]=[p[0]],_=[];const g=p[0].material,x=p[0].layer,S=p[0]._shaderDefs,v=p[0].parameters,b=p[0].stencilFront;let w=p[0].mesh.vertexBuffer.getNumVertices();const T=p[0].drawOrder;l.copy(p[0].aabb);const E=Pm(p[0]),C=p[0].mesh.vertexBuffer.format.batchingHash,M=p[0].mesh.primitive[0].indexed;c=null;for(let O=1;O<p.length;O++){const I=p[O];if(t&&u[f].length>=r){_=_.concat(p.slice(O));break}if(g!==I.material||x!==I.layer||C!==I.mesh.vertexBuffer.format.batchingHash||M!==I.mesh.primitive[0].indexed||S!==I._shaderDefs||w+I.mesh.vertexBuffer.getNumVertices()>a){m(I);continue}if(h.copy(l),h.add(I.aabb),h.halfExtents.x>n||h.halfExtents.y>n||h.halfExtents.z>n){m(I);continue}if(b&&(!(d=I.stencilFront)||b.func!==d.func||b.zpass!==d.zpass)){m(I);continue}if(E!==Pm(I)){m(I);continue}if(!T2(v,I.parameters)){m(I);continue}if(i&&c&&c.intersects(I.aabb)&&I.drawOrder!==T){m(I);continue}l.add(I.aabb),w+=I.mesh.vertexBuffer.getNumVertices(),u[f].push(I)}f++,p=_}return u}collectBatchedMeshData(e,t){let s=null,i=0,n=0,r=null;for(let a=0;a<e.length;a++)if(e[a].visible){const l=e[a].mesh,h=l.vertexBuffer.numVertices;if(i+=h,l.primitive[0].indexed)n+=l.primitive[0].count;else{const c=l.primitive[0].type;(c===Xi||c===As)&&l.primitive[0].count===4&&(n+=6)}if(!s){r=e[a].material,s={};const c=l.vertexBuffer.format.elements;for(let d=0;d<c.length;d++){const u=c[d].name;s[u]={numComponents:c[d].numComponents,dataType:c[d].dataType,normalize:c[d].normalize,count:0}}t&&(s[Kt]={numComponents:1,dataType:le,normalize:!1,count:0})}}return{streams:s,batchNumVerts:i,batchNumIndices:n,material:r}}create(e,t,s){if(!this._init){const c="#define BONE_LIMIT "+this.device.getBoneLimit()+`
`;this.transformVS=c+`#define DYNAMICBATCH
`+z.transformVS,this.skinTexVS=z.skinBatchTexVS,this.skinConstVS=z.skinBatchConstVS,this.vertexFormats={},this._init=!0}let i=null,n,r,a,l=null;const h=this.collectBatchedMeshData(e,t);if(h.streams){const c=h.streams;let d=h.material;const u=h.batchNumVerts,f=h.batchNumIndices;l=new Kd(e,t,s),this._batchList.push(l);let p,_,m,g=0,x=0,S;const v=new y,b=u<=65535?Uint16Array:Uint32Array,w=new b(f);for(n in c)i=c[n],i.typeArrayType=Yr[i.dataType],i.elementByteSize=To[i.dataType],i.buffer=new i.typeArrayType(u*i.numComponents);for(let C=0;C<e.length;C++)if(e[C].visible){r=e[C].mesh,a=r.vertexBuffer.numVertices,t||(S=e[C].node.getWorldTransform());for(n in c)if(n!==Kt){i=c[n];const M=new i.typeArrayType(i.buffer.buffer,i.elementByteSize*i.count),O=r.getVertexStream(n,M)*i.numComponents;if(i.count+=O,!t&&i.numComponents>=3){if(n===We)for(let I=0;I<O;I+=i.numComponents)v.set(M[I],M[I+1],M[I+2]),S.transformPoint(v,v),M[I]=v.x,M[I+1]=v.y,M[I+2]=v.z;else if(n===Dt||n===ei){wx.invertMat4(S).transpose();for(let I=0;I<O;I+=i.numComponents)v.set(M[I],M[I+1],M[I+2]),wx.transformVector(v,v),M[I]=v.x,M[I+1]=v.y,M[I+2]=v.z}}}if(t){i=c[Kt];for(let M=0;M<a;M++)i.buffer[i.count++]=C}if(r.primitive[0].indexed){p=r.primitive[0].base,_=r.primitive[0].count;const M=r.indexBuffer[0].getFormat();m=new Sd[M](r.indexBuffer[0].storage)}else{const M=r.primitive[0].type;if(M===Xi||M===As)if(r.primitive[0].count===4)p=0,_=6,m=M===Xi?w2:E2;else{_=0;continue}}for(let M=0;M<_;M++)w[M+x]=m[p+M]+g;x+=_,g+=a}r=new Ut(this.device);for(n in c)i=c[n],r.setVertexStream(n,i.buffer,i.numComponents,void 0,i.dataType,i.normalize);w.length>0&&r.setIndices(w),r.update(Js,!1),t&&(d=d.clone(),d.chunks.transformVS=this.transformVS,d.chunks.skinTexVS=this.skinTexVS,d.chunks.skinConstVS=this.skinConstVS,d.update());const T=new Te(r,d,this.rootNode);T.castShadow=l.origMeshInstances[0].castShadow,T.parameters=l.origMeshInstances[0].parameters,T.layer=l.origMeshInstances[0].layer,T._shaderDefs=l.origMeshInstances[0]._shaderDefs,T.cull=l.origMeshInstances[0].cull;const E=this._batchGroups[s];if(E&&E._ui&&(T.cull=!1),t){const C=[];for(let M=0;M<l.origMeshInstances.length;M++)C.push(l.origMeshInstances[M].node);T.skinInstance=new Tm(this.device,C,this.rootNode)}T._updateAabb=!1,T.drawOrder=l.origMeshInstances[0].drawOrder,T.stencilFront=l.origMeshInstances[0].stencilFront,T.stencilBack=l.origMeshInstances[0].stencilBack,T.flipFacesFactor=Pm(l.origMeshInstances[0]),T.castShadow=l.origMeshInstances[0].castShadow,l.meshInstance=T,l.updateBoundingBox()}return l}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this._batchList[e].updateBoundingBox()}clone(e,t){const s=new Kd(t,e.dynamic,e.batchGroupId);this._batchList.push(s);const i=[];for(let n=0;n<t.length;n++)i.push(t[n].node);return s.meshInstance=new Te(e.meshInstance.mesh,e.meshInstance.material,e.meshInstance.node),s.meshInstance._updateAabb=!1,s.meshInstance.parameters=t[0].parameters,s.meshInstance.cull=t[0].cull,s.meshInstance.layer=t[0].layer,e.dynamic&&(s.meshInstance.skinInstance=new Tm(this.device,i,this.rootNode)),s.meshInstance.castShadow=e.meshInstance.castShadow,s.meshInstance._shader=e.meshInstance._shader.slice(),s.meshInstance.castShadow=e.meshInstance.castShadow,s}destroyBatch(e){e.destroy(this.scene,this._batchGroups[e.batchGroupId].layers)}}const Ax=["uSceneColorMap","texture_grabPass"];class Cx extends Ot{constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null}destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(e,t,s){if((e==null?void 0:e.colorBuffer.format)!==s)return!0;const n=(t==null?void 0:t.width)||this.device.width,r=(t==null?void 0:t.height)||this.device.height;return!e||n!==e.width||r!==e.height}allocateRenderTarget(e,t,s,i){const n=s.isWebGL2,r=new re(s,{name:Ax[0],format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:n,minFilter:n?Qs:Oe,magFilter:Oe,addressU:q,addressV:q});return e?(e.destroyFrameBuffers(),e._colorBuffer=r,e._colorBuffers=[r]):e=new qe({name:"ColorGrabRT",colorBuffer:r,depth:!1,stencil:!1,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}frameUpdate(){var e;const t=this.device,s=this.source,i=(e=s==null?void 0:s.colorBuffer.format)!=null?e:this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,s==null?void 0:s.colorBuffer,i)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,s,t,i));const n=this.colorRenderTarget.colorBuffer;Ax.forEach(r=>t.scope.resolve(r).setValue(n))}execute(){const e=this.device,t=this.source,s=this.colorRenderTarget.colorBuffer;if(e.isWebGPU)e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl);else if(e.isWebGL2)e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(s),e.gl.generateMipmap(s.impl._glTarget);else{s.impl._glTexture||s.impl.initialize(e,s),e.bindTexture(s);const i=e.gl;i.copyTexImage2D(i.TEXTURE_2D,0,s.impl._glFormat,0,0,s.width,s.height,0),s._needsUpload=!1,s._needsMipmapsUpload=!1}}}const Mx=["uSceneDepthMap","uDepthMap"];class A2 extends Ot{constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t}destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(e,t){const s=(t==null?void 0:t.width)||this.device.width,i=(t==null?void 0:t.height)||this.device.height;return!e||s!==e.width||i!==e.height}allocateRenderTarget(e,t,s,i,n){const r=new re(s,{name:Mx[0],format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!1,minFilter:de,magFilter:de,addressU:q,addressV:q});return e?(e.destroyFrameBuffers(),n?e._depthBuffer=r:(e._colorBuffer=r,e._colorBuffers=[r])):e=new qe({name:"DepthGrabRT",colorBuffer:n?null:r,depthBuffer:n?r:null,depth:!n,stencil:s.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}before(){var e,t,s,i;const n=this.camera,r=this.device,a=(e=n==null?void 0:n.renderTarget)!=null?e:r.backBuffer;let l=!0,h=a.stencil?Dn:In;r.isWebGPU&&a.samples>1&&(h=Pi,l=!1);const c=(t=(s=n.renderTarget)==null?void 0:s.depthBuffer)!=null?t:(i=n.renderTarget)==null?void 0:i.colorBuffer;this.shouldReallocate(this.depthRenderTarget,c)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,r,h,l));const d=l?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;Mx.forEach(u=>r.scope.resolve(u).setValue(d))}execute(){const e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){const t=e.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;e.renderTarget=s,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,s.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT)}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,!1,!0)}}const C2=new H(254/255,254/255,254/255,254/255),Rm=[],M2=[[],[],[]],Im=["uSceneDepthMap","uDepthMap"];class P2 extends Ot{constructor(e,t,s){super(e),this.renderer=t,this.camera=s,this.setupRenderTarget()}destroy(){super.destroy(),this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}update(e){this.scene=e}setupRenderTarget(){const e=new re(this.device,{name:Im[0],format:oe,width:4,height:4,mipmaps:!1,minFilter:de,magFilter:de,addressU:q,addressV:q}),t=new qe({name:`${Im[0]}RT}`,colorBuffer:e,depth:!0,stencil:!1});this.init(t,{}),this.setClearColor(C2),this.setClearDepth(1)}before(){const e=this.device,t=this.renderTarget.colorBuffer;Im.forEach(s=>e.scope.resolve(s).setValue(t))}execute(){const{device:e,renderer:t,camera:s,scene:i,renderTarget:n}=this,r=i.layers.layerList,a=i.layers.subLayerEnabled,l=i.layers.subLayerList;for(let c=0;c<r.length;c++){const d=r[c];if(d.enabled&&a[c]&&d.camerasSet.has(s)){if(d.id===kt)break;const u=d.getCulledInstances(s),f=l[c]?u.transparent:u.opaque;for(let p=0;p<f.length;p++){var h;const _=f[p];(h=_.material)!=null&&h.depthWrite&&Rm.push(_)}t.setCameraUniforms(s,n),t.renderForward(s,Rm,M2,ui,p=>{e.setBlendState(Ee.NOBLEND)},d),Rm.length=0}}}}const qo=new y,jh=new y,Px=new y,Rx=new W,R2=[new y,new y,new y,new y,new y,new y,new y,new y];class sa{constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=jd,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new H(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[is,kt,kd,Fh,Ds],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=Os,this._rect=new X(0,0,1,1),this._renderTarget=null,this._scissorRect=new X(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=1/1e3,this._sensitivity=1e3,this._projMat=new W,this._projMatDirty=!0,this._projMatSkybox=new W,this._viewMat=new W,this._viewMatDirty=!0,this._viewProjMat=new W,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new W,this._viewProjCurrent=null,this._viewProjPrevious=new W,this._jitters=[0,0,0,0],this.frustum=new lp,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}destroy(){var e,t;(e=this.renderPassColorGrab)==null||e.destroy(),this.renderPassColorGrab=null,(t=this.renderPassDepthGrab)==null||t.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(e,t,s,i){if(this._shaderMatricesVersion!==i){var n,r;this._shaderMatricesVersion=i,this._viewProjPrevious.copy((n=this._viewProjCurrent)!=null?n:e),(r=this._viewProjCurrent)!=null||(this._viewProjCurrent=new W),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=s}}get fullSizeClearRect(){const e=this._scissorRectClear?this.scissorRect:this._rect;return e.x===0&&e.y===0&&e.z===1&&e.w===1}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}get aspectRatio(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}get farClip(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}get fov(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}get horizontalFov(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}get nearClip(){var e;return(e=this.xr)!=null&&e.active?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e)}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(e){this._aperture=e}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return new sa().copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(e,t){if(t)this.renderPassColorGrab||(this.renderPassColorGrab=new Cx(e));else{var s;(s=this.renderPassColorGrab)==null||s.destroy(),this.renderPassColorGrab=null}}_enableRenderPassDepthGrab(e,t,s){if(s)this.renderPassDepthGrab||(this.renderPassDepthGrab=e.isWebGL1?new P2(e,t,this):new A2(e,this));else{var i;(i=this.renderPassDepthGrab)==null||i.destroy(),this.renderPassDepthGrab=null}}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(e,t,s,i=new y){this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);const n=this._viewProjMat.data,r=e.x*n[3]+e.y*n[7]+e.z*n[11]+1*n[15];return i.x=(i.x/r+1)*.5*t,i.y=(1-i.y/r)*.5*s,i}screenToWorld(e,t,s,i,n,r=new y){const a=this.farClip-this.nearClip;if(qo.set(e/i,(n-t)/n,s/a),qo.mulScalar(2),qo.sub(y.ONE),this._projection===Os){W._getPerspectiveHalfSize(jh,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),jh.x*=qo.x,jh.y*=qo.y;const l=this._node.getWorldTransform();jh.z=-this.nearClip,l.transformPoint(jh,Px);const h=this._node.getPosition();r.sub2(Px,h),r.normalize(),r.mulScalar(s),r.add(h)}else this._updateViewProjMat(),Rx.copy(this._viewProjMat).invert(),Rx.transformPoint(qo,r);return r}_evaluateProjectionMatrix(){if(this._projMatDirty){if(this._projection===Os)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{const e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){const e=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(Math.pow(2,e)*1.2)}getScreenSize(e){if(this._projection===Os){const t=this._node.getPosition().distance(e.center);if(t<e.radius)return 1;const s=Math.asin(e.radius/t),i=Math.tan(s),n=Math.tan(this.fov/2*U.DEG_TO_RAD);return Math.min(i/n,1)}return U.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e=this.nearClip,t=this.farClip){const s=this.fov*Math.PI/180;let i=this._projection===Os?Math.tan(s/2)*e:this._orthoHeight,n=i*this.aspectRatio;const r=R2;return r[0].x=n,r[0].y=-i,r[0].z=-e,r[1].x=n,r[1].y=i,r[1].z=-e,r[2].x=-n,r[2].y=i,r[2].z=-e,r[3].x=-n,r[3].y=-i,r[3].z=-e,this._projection===Os&&(i=Math.tan(s/2)*t,n=i*this.aspectRatio),r[4].x=n,r[4].y=-i,r[4].z=-t,r[5].x=n,r[5].y=i,r[5].z=-t,r[6].x=-n,r[6].y=i,r[6].z=-t,r[7].x=-n,r[7].y=-i,r[7].z=-t,r}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=!0}}class Yh{constructor(){this.hasTangents=!1,this.chunks={},this.pass=0,this.alphaTest=!1,this.blendType=Nt,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBased=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.useAmbientTint=!1,this.customFragmentShader=null,this.pixelSnap=!1,this.shadingModel=0,this.ambientSH=!1,this.fastTbn=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=wt,this.opacityShadowDither=wt,this.cubeMapProjection=0,this.conserveEnergy=!1,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.fog=Dh,this.gamma=Fo,this.toneMap=-1,this.fixSeams=!1,this.reflectionSource=null,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={}}}class I2{constructor(){this.usedUvs=void 0,this.shaderChunk=void 0,this.litOptions=new Yh}}class Vs{static update(e,t,s,i,n,r){Vs.updateSharedOptions(e,t,s,i,n),Vs.updateMaterialOptions(e,t),Vs.updateEnvOptions(e,t,s),Vs.updateLightingOptions(e,t,i,r),n===di&&(e.gamma=Oo,e.toneMap=Bo)}static updateSharedOptions(e,t,s,i,n){e.chunks=t.chunks,e.pass=n,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=i&&(i&Uo)!==0,e.skin=i&&(i&No)!==0,e.useInstancing=i&&(i&ko)!==0,e.useMorphPosition=i&&(i&zo)!==0,e.useMorphNormal=i&&(i&Vo)!==0,e.useMorphTextureBased=i&&(i&Go)!==0,e.hasTangents=i&&(i&Hd)!==0,e.nineSlicedMode=t.nineSlicedMode||Fi,t.useLighting&&s.clusteredLightingEnabled?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,e.clusteredLightingShadowType=s.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(e,t){e.useAmbientTint=!1,e.separateAmbient=!1,e.customFragmentShader=null,e.pixelSnap=t.pixelSnap,e.shadingModel=t.shadingModel,e.ambientSH=t.ambientSH,e.fastTbn=t.fastTbn,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=t.occludeSpecularIntensity!==1,e.useMsdf=!1,e.msdfTextAttribute=!1,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.opacityShadowDither=t.opacityShadowDither,e.cubeMapProjection=rm,e.conserveEnergy=t.conserveEnergy&&t.shadingModel===Qr,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.vertexColors=!1,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap}static updateEnvOptions(e,t,s){e.fog=t.useFog?s.fog:"none",e.gamma=t.useGammaTonemap?s.gammaCorrection:Fo,e.toneMap=t.useGammaTonemap?s.toneMapping:-1,e.fixSeams=!1,t.useSkybox&&s.envAtlas&&s.skybox?(e.reflectionSource="envAtlasHQ",e.reflectionEncoding=s.envAtlas.encoding,e.reflectionCubemapEncoding=s.skybox.encoding):t.useSkybox&&s.envAtlas?(e.reflectionSource="envAtlas",e.reflectionEncoding=s.envAtlas.encoding):t.useSkybox&&s.skybox?(e.reflectionSource="cubeMap",e.reflectionEncoding=s.skybox.encoding):(e.reflectionSource=null,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource="ambientSH",e.ambientEncoding=null):e.reflectionSource&&s.envAtlas?(e.ambientSource="envAtlas",e.ambientEncoding=s.envAtlas.encoding):(e.ambientSource="constant",e.ambientEncoding=null);const i=!!e.reflectionSource;e.skyboxIntensity=i&&(s.skyboxIntensity!==1||s.physicalUnits),e.useCubeMapRotation=i&&s._skyboxRotationShaderInclude}static updateLightingOptions(e,t,s,i){if(e.lightMapWithoutAmbient=!1,t.useLighting){const n=[],r=s?s>>16:ns;e.lightMaskDynamic=!!(r&ns),e.lightMapWithoutAmbient=!1,i&&(Vs.collectLights(ae,i[ae],n,r),Vs.collectLights(be,i[be],n,r),Vs.collectLights(Ie,i[Ie],n,r)),e.lights=n}else e.lights=[];(e.lights.length===0||s&Nh)&&(e.noShadow=!0)}static collectLights(e,t,s,i){for(let n=0;n<t.length;n++){const r=t[n];r.enabled&&r.mask&i&&s.push(r)}}}class Gs{constructor(){this.code=""}append(...e){e.forEach(t=>{t.endsWith(`
`)?this.code+=t:this.code+=t+`
`})}prepend(...e){e.forEach(t=>{t.endsWith(`
`)?this.code=t+this.code:this.code=t+`
`+this.code})}}const D2={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP"},L2={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class fi{static decodeFunc(e){return D2[e]||"decodeGamma"}static encodeFunc(e){return L2[e]||"encodeGamma"}}const Ix=new W,Dx=new W,Lx=new W;class pi{static create(e,t,s){const i=new sa;switch(i.node=new we(e),i.aspectRatio=1,i.aspectRatioMode=Yd,i._scissorRectClear=!0,t){case be:i.node.setRotation(pi.pointLightRotations[s]),i.fov=90,i.projection=Os;break;case Ie:i.projection=Os;break;case ae:i.projection=Yn;break}return i}static evalSpotCookieMatrix(e){let t=pi._spotCookieCamera;t||(t=pi.create("SpotCookieCamera",Ie),pi._spotCookieCamera=t),t.fov=e._outerConeAngle*2;const s=t._node;s.setPosition(e._node.getPosition()),s.setRotation(e._node.getRotation()),s.rotateLocal(-90,0,0),Ix.setTRS(s.getPosition(),s.getRotation(),y.ONE).invert(),Dx.mul2(t.projectionMatrix,Ix);const i=e.cookieMatrix,n=e.atlasViewport;return Lx.setViewport(n.x,n.y,n.z,n.w),i.mul2(Lx,Dx),i}}pi.pointLightRotations=[new Z().setFromEulerAngles(0,90,180),new Z().setFromEulerAngles(0,-90,180),new Z().setFromEulerAngles(90,0,0),new Z().setFromEulerAngles(-90,0,0),new Z().setFromEulerAngles(0,180,180),new Z().setFromEulerAngles(0,0,180)],pi._spotCookieCamera=null;const Kh=1e-6,Et=new y,ia=new Float32Array(6),F2=new y(-.5,0,0),O2=new y(0,0,.5),vs={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT_ALWAYS:7,POSITION_X:7,POSITION_Y:8,POSITION_Z:9,RANGE:10,SPOT_DIRECTION_X:11,SPOT_DIRECTION_Y:12,SPOT_DIRECTION_Z:13,PROJ_MAT_00:14,ATLAS_VIEWPORT_A:14,PROJ_MAT_01:15,ATLAS_VIEWPORT_B:15,PROJ_MAT_02:16,PROJ_MAT_03:17,PROJ_MAT_10:18,PROJ_MAT_11:19,PROJ_MAT_12:20,PROJ_MAT_13:21,PROJ_MAT_20:22,PROJ_MAT_21:23,PROJ_MAT_22:24,PROJ_MAT_23:25,PROJ_MAT_30:26,PROJ_MAT_31:27,PROJ_MAT_32:28,PROJ_MAT_33:29,AREA_DATA_WIDTH_X:30,AREA_DATA_WIDTH_Y:31,AREA_DATA_WIDTH_Z:32,AREA_DATA_HEIGHT_X:33,AREA_DATA_HEIGHT_Y:34,AREA_DATA_HEIGHT_Z:35,COUNT:36},mt={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8},Zh=0,B2=1,N2=new Rs;class Qh{static getLightTextureFormat(e){return e.extTextureFloat&&e.maxTextures>8?Zh:B2}static getShaderDefines(e){return N2.get(e,()=>{const t=(r,a,l,h)=>Object.keys(a).map(c=>`#define ${l}${c} ${a[c]}${h}`).join(`
`),i=Qh.getLightTextureFormat(e)===Zh?"FLOAT":"8BIT",n=e.supportsTextureFetch?"":".5";return`
								
#define CLUSTER_TEXTURE_${i}
								${t(e,vs,"CLUSTER_TEXTURE_8_",n)}
								${t(e,mt,"CLUSTER_TEXTURE_F_",n)}
						`})}constructor(e){this.device=e,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let t=vs.COUNT_ALWAYS,s=0;this.lightTextureFormat=Qh.getLightTextureFormat(e),this.lightTextureFormat===Zh?s=mt.COUNT:t=vs.COUNT,this.lights8=new Uint8ClampedArray(4*t*this.maxLights),this.lightsTexture8=this.createTexture(this.device,t,this.maxLights,oe,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),s?(this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=this.createTexture(this.device,s,this.maxLights,Ge,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=s?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=s?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height,this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new y,this.boundsDelta=new y}destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null)}createTexture(e,t,s,i,n){return new re(e,{name:n,width:t,height:s,mipmaps:!1,format:i,addressU:q,addressV:q,type:bt,magFilter:de,minFilter:de,anisotropy:1})}setCompressionRanges(e,t){this.invMaxColorValue=1/t,this.invMaxAttenuation=1/e}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t)}uploadTextures(){this.lightsTextureFloat&&(this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock()),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),this.lightTextureFormat===Zh&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData)}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()}getLightAreaSizes(e){const t=e._node.getWorldTransform();return t.transformVector(F2,Et),ia[0]=Et.x,ia[1]=Et.y,ia[2]=Et.z,t.transformVector(O2,Et),ia[3]=Et.x,ia[4]=Et.y,ia[5]=Et.z,ia}addLightDataFlags(e,t,s,i,n,r){e[t+0]=i?255:0,e[t+1]=s._shape*64,e[t+2]=s._falloffMode*255,e[t+3]=n?r*255:0}addLightDataColor(e,t,s,i,n){const r=this.invMaxColorValue,a=i?s._linearFinalColor:s._finalColor;Fe.float2Bytes(a[0]*r,e,t+0,2),Fe.float2Bytes(a[1]*r,e,t+2,2),Fe.float2Bytes(a[2]*r,e,t+4,2),e[t+6]=n?255:0;const l=!!(s.mask&ns),h=!!(s.mask&hi);e[t+7]=l&&h?127:h?255:0}addLightDataSpotAngles(e,t,s){Fe.float2Bytes(s._innerConeAngleCos*(.5-Kh)+.5,e,t+0,2),Fe.float2Bytes(s._outerConeAngleCos*(.5-Kh)+.5,e,t+2,2)}addLightDataShadowBias(e,t,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);Fe.float2BytesRange(n.bias,e,t,-1,20,2),Fe.float2Bytes(n.normalBias,e,t+2,2)}addLightDataPositionRange(e,t,s,i){const n=Et.sub2(i,this.boundsMin).div(this.boundsDelta);Fe.float2Bytes(n.x,e,t+0,4),Fe.float2Bytes(n.y,e,t+4,4),Fe.float2Bytes(n.z,e,t+8,4),Fe.float2Bytes(s.attenuationEnd*this.invMaxAttenuation,e,t+12,4)}addLightDataSpotDirection(e,t,s){this.getSpotDirection(Et,s),Fe.float2Bytes(Et.x*(.5-Kh)+.5,e,t+0,4),Fe.float2Bytes(Et.y*(.5-Kh)+.5,e,t+4,4),Fe.float2Bytes(Et.z*(.5-Kh)+.5,e,t+8,4)}addLightDataLightProjMatrix(e,t,s){const i=s.data;for(let n=0;n<12;n++)Fe.float2BytesRange(i[n],e,t+4*n,-2,2,4);for(let n=12;n<16;n++)Fe.float2MantissaExponent(i[n],e,t+4*n,4)}addLightDataCookies(e,t,s){const i=s._cookieChannel==="rgb";if(e[t+0]=Math.floor(s.cookieIntensity*255),e[t+1]=i?255:0,!i){const n=s._cookieChannel;e[t+4]=n==="rrr"?255:0,e[t+5]=n==="ggg"?255:0,e[t+6]=n==="bbb"?255:0,e[t+7]=n==="aaa"?255:0}}addLightAtlasViewport(e,t,s){Fe.float2Bytes(s.x,e,t+0,2),Fe.float2Bytes(s.y,e,t+2,2),Fe.float2Bytes(s.z/3,e,t+4,2)}addLightAreaSizes(e,t,s){const i=this.getLightAreaSizes(s);for(let n=0;n<6;n++)Fe.float2MantissaExponent(i[n],e,t+4*n,4)}addLightData(e,t,s){const i=e._type===Ie,n=e.atlasViewportAllocated,r=this.cookiesEnabled&&!!e._cookie&&n,a=this.areaLightsEnabled&&e.shape!==yt,l=this.shadowsEnabled&&e.castShadows&&n,h=e._node.getPosition();let c=null,d=null;i?l?c=e.getRenderData(null,0).shadowMatrix:r&&(c=pi.evalSpotCookieMatrix(e)):(l||r)&&(d=e.atlasViewport);const u=this.lights8,f=t*this.lightsTexture8.width*4;if(this.addLightDataFlags(u,f+4*vs.FLAGS,e,i,l,e.shadowIntensity),this.addLightDataColor(u,f+4*vs.COLOR_A,e,s,r),i&&this.addLightDataSpotAngles(u,f+4*vs.SPOT_ANGLES,e),e.castShadows&&this.addLightDataShadowBias(u,f+4*vs.SHADOW_BIAS,e),r&&this.addLightDataCookies(u,f+4*vs.COOKIE_A,e),this.lightTextureFormat===Zh){const p=this.lightsFloat,_=t*this.lightsTextureFloat.width*4;if(p[_+4*mt.POSITION_RANGE+0]=h.x,p[_+4*mt.POSITION_RANGE+1]=h.y,p[_+4*mt.POSITION_RANGE+2]=h.z,p[_+4*mt.POSITION_RANGE+3]=e.attenuationEnd,i&&(this.getSpotDirection(Et,e),p[_+4*mt.SPOT_DIRECTION+0]=Et.x,p[_+4*mt.SPOT_DIRECTION+1]=Et.y,p[_+4*mt.SPOT_DIRECTION+2]=Et.z),c){const m=c.data;for(let g=0;g<16;g++)p[_+4*mt.PROJ_MAT_0+g]=m[g]}if(d&&(p[_+4*mt.ATLAS_VIEWPORT+0]=d.x,p[_+4*mt.ATLAS_VIEWPORT+1]=d.y,p[_+4*mt.ATLAS_VIEWPORT+2]=d.z/3),a){const m=this.getLightAreaSizes(e);p[_+4*mt.AREA_DATA_WIDTH+0]=m[0],p[_+4*mt.AREA_DATA_WIDTH+1]=m[1],p[_+4*mt.AREA_DATA_WIDTH+2]=m[2],p[_+4*mt.AREA_DATA_HEIGHT+0]=m[3],p[_+4*mt.AREA_DATA_HEIGHT+1]=m[4],p[_+4*mt.AREA_DATA_HEIGHT+2]=m[5]}}else this.addLightDataPositionRange(u,f+4*vs.POSITION_X,e,h),i&&this.addLightDataSpotDirection(u,f+4*vs.SPOT_DIRECTION_X,e),c&&this.addLightDataLightProjMatrix(u,f+4*vs.PROJ_MAT_00,c),d&&this.addLightAtlasViewport(u,f+4*vs.ATLAS_VIEWPORT_A,d),a&&this.addLightAreaSizes(u,f+4*vs.AREA_DATA_WIDTH_X,e)}}const Dm={vertex_normal:Dt,vertex_tangent:ei,vertex_texCoord0:Lt,vertex_texCoord1:Ri,vertex_color:_t,vertex_boneWeights:ti,vertex_boneIndices:Kt},Fx={vVertexColor:"vec4",vPositionW:"vec3",vNormalV:"vec3",vNormalW:"vec3",vTangentW:"vec3",vBinormalW:"vec3",vObjectSpaceUpW:"vec3",vUv0:"vec2",vUv1:"vec2"};class Ox{constructor(e,t){if(this.device=e,this.options=t,this.attributes={vertex_position:We},t.userAttributes)for(const[s,i]of Object.entries(t.userAttributes))this.attributes[i]=s;if(t.chunks){const s=t.chunks;this.chunks=Object.create(z);for(const i in z)if(s.hasOwnProperty(i)){const n=s[i];for(const r in Dm)Dm.hasOwnProperty(r)&&n.indexOf(r)>=0&&(this.attributes[r]=Dm[r]);this.chunks[i]=n}}else this.chunks=z;this.shaderPassInfo=zs.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=!!t.reflectionSource,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.varyings="",this.varyingDefines="",this.vshader=null,this.frontendDecl=null,this.frontendCode=null,this.frontendFunc=null,this.lightingUv=null,this.defines=[],this.fshader=null}_vsAddBaseCode(e,t,s){return e+=t.baseVS,(s.nineSlicedMode===ot||s.nineSlicedMode===st)&&(e+=t.baseNineSlicedVS),e}_vsAddTransformCode(e,t,s,i){return e+=this.chunks.transformVS,e}_setMapTransform(e,t,s,i){const n=s+i*100;if(!e[3][n]){const r=`texture_${t}MapTransform`;e[0]+=`uniform vec3 ${r}0;
`,e[0]+=`uniform vec3 ${r}1;
`,e[1]+=`varying vec2 vUV${i}_${s};
`,e[2]+=`   vUV${i}_${s} = vec2(dot(vec3(uv${i}, 1), ${r}0), dot(vec3(uv${i}, 1), ${r}1));
`,e[3][n]=!0}return e}_fsGetBaseCode(){const e=this.options,t=this.chunks;let s=this.chunks.basePS;return e.nineSlicedMode===ot?s+=t.baseNineSlicedPS:e.nineSlicedMode===st&&(s+=t.baseNineSlicedTiledPS),s}_fsGetStartCode(e,t,s,i){let n=s.startPS;return i.nineSlicedMode===ot?n+=s.startNineSlicedPS:i.nineSlicedMode===st&&(n+=s.startNineSlicedTiledPS),n}_getLightSourceShapeString(e){switch(e){case z0:return"Rect";case V0:return"Disk";case G0:return"Sphere";default:return""}}generateVertexShader(e,t,s){const i=this.device,n=this.options,r=this.chunks;let a="",l="";a=this._vsAddBaseCode(a,r,n),l+=`   vPositionW    = getWorldPosition();
`,this.options.pass===ui&&(a+=`varying float vDepth;
`,a+=`#ifndef VIEWMATRIX
`,a+=`#define VIEWMATRIX
`,a+=`uniform mat4 matrix_view;
`,a+=`#endif
`,a+=`#ifndef CAMERAPLANES
`,a+=`#define CAMERAPLANES
`,a+=`uniform vec4 camera_params;

`,a+=`#endif
`,l+=`    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;
`),this.options.pass,this.options.useInstancing&&(this.attributes.instance_line1=lo,this.attributes.instance_line2=Bn,this.attributes.instance_line3=ho,this.attributes.instance_line4=Nn,a+=r.instancingVS),this.needsNormal&&(this.attributes.vertex_normal=Dt,l+=`   vNormalW = getNormal();
`,n.reflectionSource==="sphereMap"&&i.fragmentUniformsCount<=16&&(a+=r.viewNormalVS,l+=`   vNormalV    = getViewNormal();
`),n.hasTangents&&(n.useHeights||n.useNormals||n.enableGGXSpecular)?(this.attributes.vertex_tangent=ei,a+=r.tangentBinormalVS,l+=`   vTangentW   = getTangent();
`,l+=`   vBinormalW  = getBinormal();
`):(n.enableGGXSpecular||!i.extStandardDerivatives)&&(l+=`   vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));
`));const h=2;for(let u=0;u<h;u++)e[u]&&(this.attributes["vertex_texCoord"+u]="TEXCOORD"+u,a+=r["uv"+u+"VS"],l+="   vec2 uv"+u+" = getUv"+u+`();
`),t[u]&&(l+="   vUv"+u+" = uv"+u+`;
`);const c=[a,this.varyings,l,[]];if(s.forEach(u=>{this._setMapTransform(c,u.name,u.id,u.uv)}),a=c[0],this.varyings=c[1],l=c[2],n.vertexColors&&(this.attributes.vertex_color=_t,l+=`   vVertexColor = vertex_color;
`),n.useMsdf&&n.msdfTextAttribute&&(this.attributes.vertex_outlineParameters=Fn,this.attributes.vertex_shadowParameters=On,l+=`    unpackMsdfParams();
`,a+=r.msdfVS),n.useMorphPosition||n.useMorphNormal)if(n.useMorphTextureBased){a+=`#define MORPHING_TEXTURE_BASED
`,n.useMorphPosition&&(a+=`#define MORPHING_TEXTURE_BASED_POSITION
`),n.useMorphNormal&&(a+=`#define MORPHING_TEXTURE_BASED_NORMAL
`),this.attributes.morph_vertex_id=Nn;const u=i.isWebGPU?"uint":"float";a+=`attribute ${u} morph_vertex_id;
`}else a+=`#define MORPHING
`,n.useMorphPosition?(this.attributes.morph_pos0=Fn,this.attributes.morph_pos1=On,this.attributes.morph_pos2=cd,this.attributes.morph_pos3=dd,a+=`#define MORPHING_POS03
`,a+=`attribute vec3 morph_pos0;
`,a+=`attribute vec3 morph_pos1;
`,a+=`attribute vec3 morph_pos2;
`,a+=`attribute vec3 morph_pos3;
`):n.useMorphNormal&&(this.attributes.morph_nrm0=Fn,this.attributes.morph_nrm1=On,this.attributes.morph_nrm2=cd,this.attributes.morph_nrm3=dd,a+=`#define MORPHING_NRM03
`,a+=`attribute vec3 morph_nrm0;
`,a+=`attribute vec3 morph_nrm1;
`,a+=`attribute vec3 morph_nrm2;
`,a+=`attribute vec3 morph_nrm3;
`),n.useMorphNormal?(this.attributes.morph_nrm4=lo,this.attributes.morph_nrm5=Bn,this.attributes.morph_nrm6=ho,this.attributes.morph_nrm7=Nn,a+=`#define MORPHING_NRM47
`,a+=`attribute vec3 morph_nrm4;
`,a+=`attribute vec3 morph_nrm5;
`,a+=`attribute vec3 morph_nrm6;
`,a+=`attribute vec3 morph_nrm7;
`):(this.attributes.morph_pos4=lo,this.attributes.morph_pos5=Bn,this.attributes.morph_pos6=ho,this.attributes.morph_pos7=Nn,a+=`#define MORPHING_POS47
`,a+=`attribute vec3 morph_pos4;
`,a+=`attribute vec3 morph_pos5;
`,a+=`attribute vec3 morph_pos6;
`,a+=`attribute vec3 morph_pos7;
`);n.skin?(this.attributes.vertex_boneWeights=ti,this.attributes.vertex_boneIndices=Kt,a+=me.skinCode(i,r),a+=`#define SKIN
`):n.useInstancing&&(a+=`#define INSTANCING
`),n.screenSpace&&(a+=`#define SCREENSPACE
`),n.pixelSnap&&(a+=`#define PIXELSNAP
`),a=this._vsAddTransformCode(a,i,r,n),this.needsNormal&&(a+=r.normalVS),a+=`
`,a+=r.startVS,a+=l,a+=r.endVS,a+="}",Object.keys(Fx).forEach(u=>{a.indexOf(u)>=0&&(this.varyings+=`varying ${Fx[u]} ${u};
`,this.varyingDefines+=`#define VARYING_${u.toUpperCase()}
`)});const d=this.shaderPassInfo.shaderDefines;this.vshader=d+this.varyings+a}_fsGetBeginCode(){let e=this.shaderPassInfo.shaderDefines;for(let t=0;t<this.defines.length;t++)e+=`#define ${this.defines[t]}
`;return e}_fsGetPickPassCode(){let e=this._fsGetBeginCode();return e+=`uniform vec4 uColor;
`,e+=this.varyings,e+=this.varyingDefines,e+=this.frontendDecl,e+=this.frontendCode,e+=me.begin(),e+=this.frontendFunc,e+=`    gl_FragColor = uColor;
`,e+=me.end(),e}_fsGetDepthPassCode(){const e=this.chunks;let t=this._fsGetBeginCode();return t+=`varying float vDepth;
`,t+=this.varyings,t+=this.varyingDefines,t+=e.packDepthPS,t+=this.frontendDecl,t+=this.frontendCode,t+=me.begin(),t+=this.frontendFunc,t+=`    gl_FragColor = packFloat(vDepth);
`,t+=me.end(),t}_fsGetPrePassVelocityCode(){return`
						void main(void)
						{
								gl_FragColor = vec4(1, 0, 0, 1);
						}
						`}_fsGetShadowPassCode(){const e=this.device,t=this.options,s=this.chunks,i=this.varyings,n=this.shaderPassInfo.lightType;let r=this.shaderPassInfo.shadowType;n!==ae&&t.clusteredLightingEnabled&&(r===fs||r===Ls||r===ps||r===At)&&(r=at);let a=this._fsGetBeginCode();e.extStandardDerivatives&&e.isWebGL1&&(a+=`uniform vec2 polygonOffset;
`),r===ps?e.textureFloatHighPrecision?a+=`#define VSM_EXPONENT 15.0

`:a+=`#define VSM_EXPONENT 5.54

`:r===Ls&&(a+=`#define VSM_EXPONENT 5.54

`),n!==ae&&(a+=`uniform vec3 view_position;
`,a+=`uniform float light_radius;
`),a+=i,a+=this.varyingDefines,a+=this.frontendDecl,a+=this.frontendCode;const l=r===ai||r===at||r===Fs||r===At,h=n===be&&r!==At&&!t.clusteredLightingEnabled,c=l&&!e.supportsDepthShadow||h;c?a+=s.packDepthPS:r===fs&&(a+=`vec2 encodeFloatRG( float v ) {
`,a+=`    vec2 enc = vec2(1.0, 255.0) * v;
`,a+=`    enc = fract(enc);
`,a+=`    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
`,a+=`    return enc;
`,a+=`}

`),r===At&&(a+=z.linearizeDepthPS),a+=me.begin(),a+=this.frontendFunc;const d=r===fs||r===Ls||r===ps,u=e.isWebGL1&&e.extStandardDerivatives,f=n===ae||!d&&n===Ie;let p=!1;return f?a+=`    float depth = gl_FragCoord.z;
`:(a+=`    float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);
`,p=!0),u&&(a+=`    float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);
`,a+=`    depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;
`,p=!0),c?a+=`    gl_FragColor = packFloat(depth);
`:d?r===fs?a+=`    gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));
`:a+=s.storeEVSMPS:r===At?a+=`    gl_FragColor.r = depth;
`:(p&&(a+=`    gl_FragDepth = depth;
`),a+=`    gl_FragColor = vec4(1.0);
`),a+=me.end(),a}_fsGetLitPassCode(){const e=this.device,t=this.options,s=this.chunks,i=new Gs,n=new Gs,r=new Gs,a=new Gs;t.opacityFadesSpecular===!1&&i.append("uniform float material_alphaFade;"),t.useSpecular&&(this.defines.push("LIT_SPECULAR"),this.reflections&&this.defines.push("LIT_REFLECTIONS"),t.useClearCoat&&this.defines.push("LIT_CLEARCOAT"),t.fresnelModel>0&&this.defines.push("LIT_SPECULAR_FRESNEL"),t.conserveEnergy&&this.defines.push("LIT_CONSERVE_ENERGY"),t.useSheen&&this.defines.push("LIT_SHEEN"),t.useIridescence&&this.defines.push("LIT_IRIDESCENCE"));const l=[];let h=0,c=!1,d=!1,u=!1,f=t.lights.some(function(P){return P._shape&&P._shape!==yt});t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled&&(f=!0);let p="highp";e.areaLightLutFormat===oe&&(i.append("#define AREA_R8_G8_B8_A8_LUTS"),p="lowp"),(f||t.clusteredLightingEnabled)&&(i.append("#define AREA_LIGHTS"),i.append(`uniform ${p} sampler2D areaLightsLutTex1;`),i.append(`uniform ${p} sampler2D areaLightsLutTex2;`));for(let P=0;P<t.lights.length;P++){const D=t.lights[P],R=D._type;if(t.clusteredLightingEnabled&&R!==ae)continue;const A=f&&D._shape?D._shape:yt;i.append("uniform vec3 light"+P+"_color;"),D._shadowType===At&&D.castShadows&&!t.noShadow&&(i.append(`uniform float light${P}_shadowSearchArea;`),i.append(`uniform vec4 light${P}_cameraParams;`)),R===ae?i.append("uniform vec3 light"+P+"_direction;"):(i.append("uniform vec3 light"+P+"_position;"),i.append("uniform float light"+P+"_radius;"),R===Ie&&(i.append("uniform vec3 light"+P+"_direction;"),i.append("uniform float light"+P+"_innerConeAngle;"),i.append("uniform float light"+P+"_outerConeAngle;"))),A!==yt&&(R===ae&&i.append("uniform vec3 light"+P+"_position;"),i.append("uniform vec3 light"+P+"_halfWidth;"),i.append("uniform vec3 light"+P+"_halfHeight;")),D.castShadows&&!t.noShadow&&(i.append("uniform mat4 light"+P+"_shadowMatrix;"),i.append("uniform float light"+P+"_shadowIntensity;"),R===ae&&(i.append("uniform mat4 light"+P+"_shadowMatrixPalette[4];"),i.append("uniform float light"+P+"_shadowCascadeDistances[4];"),i.append("uniform float light"+P+"_shadowCascadeCount;")),i.append("uniform vec4 light"+P+"_shadowParams;"),R===ae&&(c=!0),R===be?i.append("uniform samplerCube light"+P+"_shadowMap;"):D._isPcf&&e.supportsDepthShadow?i.append("uniform sampler2DShadow light"+P+"_shadowMap;"):i.append("uniform sampler2D light"+P+"_shadowMap;"),h++,l[D._shadowType]=!0,D._isVsm&&(d=!0),D._shadowType===At&&(u=!0)),D._cookie&&(D._cookie._cubemap?R===be&&(i.append("uniform samplerCube light"+P+"_cookie;"),i.append("uniform float light"+P+"_cookieIntensity;"),(!D.castShadows||t.noShadow)&&i.append("uniform mat4 light"+P+"_shadowMatrix;")):R===Ie&&(i.append("uniform sampler2D light"+P+"_cookie;"),i.append("uniform float light"+P+"_cookieIntensity;"),(!D.castShadows||t.noShadow)&&i.append("uniform mat4 light"+P+"_shadowMatrix;"),D._cookieTransform&&(i.append("uniform vec4 light"+P+"_cookieMatrix;"),i.append("uniform vec2 light"+P+"_cookieOffset;"))))}const _=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);if(_&&(t.hasTangents?n.append(t.fastTbn?s.TBNfastPS:s.TBNPS):e.extStandardDerivatives&&(t.useNormals||t.useClearCoatNormals)?n.append(s.TBNderivativePS.replace(/\$UV/g,this.lightingUv)):n.append(s.TBNObjectSpacePS)),n.append(s.sphericalPS),n.append(s.decodePS),n.append(me.gammaCode(t.gamma,s)),n.append(me.tonemapCode(t.toneMap,s)),n.append(me.fogCode(t.fog,s)),n.append(this.frontendCode),t.useCubeMapRotation&&i.append("#define CUBEMAP_ROTATION"),this.needsNormal&&(n.append(s.cubeMapRotatePS),n.append(t.cubeMapProjection>0?s.cubeMapProjectBoxPS:s.cubeMapProjectNonePS),n.append(t.skyboxIntensity?s.envMultiplyPS:s.envConstPS)),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&n.append(s.metalnessModulatePS),t.fresnelModel===Lh&&n.append(s.fresnelSchlickPS),t.useIridescence&&n.append(s.iridescenceDiffractionPS)),t.useAo)switch(n.append(s.aoDiffuseOccPS),t.occludeSpecular){case Jr:n.append(t.occludeSpecularFloat?s.aoSpecOccSimplePS:s.aoSpecOccConstSimplePS);break;case Gd:n.append(t.occludeSpecularFloat?s.aoSpecOccPS:s.aoSpecOccConstPS);break}t.reflectionSource==="envAtlasHQ"?(n.append(t.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS),n.append(s.envAtlasPS),n.append(s.reflectionEnvHQPS.replace(/\$DECODE_CUBEMAP/g,fi.decodeFunc(t.reflectionCubemapEncoding)).replace(/\$DECODE/g,fi.decodeFunc(t.reflectionEncoding)))):t.reflectionSource==="envAtlas"?(n.append(s.envAtlasPS),n.append(s.reflectionEnvPS.replace(/\$DECODE/g,fi.decodeFunc(t.reflectionEncoding)))):t.reflectionSource==="cubeMap"?(n.append(t.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS),n.append(s.reflectionCubePS.replace(/\$DECODE/g,fi.decodeFunc(t.reflectionEncoding)))):t.reflectionSource==="sphereMap"&&n.append(s.reflectionSpherePS.replace(/\$DECODE/g,fi.decodeFunc(t.reflectionEncoding))),this.reflections&&(t.useClearCoat&&n.append(s.reflectionCCPS),t.useSheen&&n.append(s.reflectionSheenPS)),t.useRefraction&&(t.useDynamicRefraction?n.append(s.refractionDynamicPS):this.reflections&&n.append(s.refractionCubePS)),t.useSheen&&n.append(s.lightSheenPS),t.clusteredLightingEnabled&&(n.append(s.clusteredLightUtilsPS),t.clusteredLightingCookiesEnabled&&n.append(s.clusteredLightCookiesPS),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(l[at]=!0,l[Fs]=!0,l[At]=!0)),(h>0||t.clusteredLightingEnabled)&&(c&&n.append(s.shadowCascadesPS),(l[ai]||l[at])&&n.append(s.shadowStandardPS),l[Fs]&&!e.isWebGL1&&n.append(s.shadowStandardGL2PS),d&&(n.append(s.shadowVSM_commonPS),l[fs]&&n.append(s.shadowVSM8PS),l[Ls]&&n.append(e.extTextureHalfFloatLinear?s.shadowEVSMPS.replace(/\$/g,"16"):s.shadowEVSMnPS.replace(/\$/g,"16")),l[ps]&&n.append(e.extTextureFloatLinear?s.shadowEVSMPS.replace(/\$/g,"32"):s.shadowEVSMnPS.replace(/\$/g,"32"))),u&&(n.append(s.linearizeDepthPS),n.append(s.shadowPCSSPS)),e.isWebGL2||e.isWebGPU||e.extStandardDerivatives||n.append(s.biasConstPS)),t.enableGGXSpecular&&n.append("uniform float material_anisotropy;"),this.lighting&&(n.append(s.lightDiffuseLambertPS),(f||t.clusteredLightingAreaLightsEnabled)&&n.append(s.ltcPS));let m=!1;t.useSpecular&&(this.lighting&&n.append(t.shadingModel===li?s.lightSpecularPhongPS:t.enableGGXSpecular?s.lightSpecularAnisoGGXPS:s.lightSpecularBlinnPS),!t.fresnelModel&&!this.reflections&&!t.diffuseMapEnabled&&(i.append("uniform vec3 material_ambient;"),i.append("#define LIT_OLD_AMBIENT"),m=!0)),n.append(s.combinePS),t.lightMapEnabled&&n.append(t.useSpecular&&t.dirLightMapEnabled?s.lightmapDirAddPS:s.lightmapAddPS);const g=!t.lightMapEnabled||t.lightMapWithoutAmbient;g&&(t.ambientSource==="ambientSH"?n.append(s.ambientSHPS):t.ambientSource==="envAtlas"?(t.reflectionSource!=="envAtlas"&&t.reflectionSource!=="envAtlasHQ"&&n.append(s.envAtlasPS),n.append(s.ambientEnvPS.replace(/\$DECODE/g,fi.decodeFunc(t.ambientEncoding)))):n.append(s.ambientConstantPS)),t.useAmbientTint&&!m&&i.append("uniform vec3 material_ambient;"),t.useMsdf&&(t.msdfTextAttribute||i.append("#define UNIFORM_TEXT_PARAMETERS"),n.append(s.msdfPS)),this.needsNormal&&(n.append(s.viewDirPS),t.useSpecular&&n.append(t.enableGGXSpecular?s.reflDirAnisoPS:s.reflDirPS));let x=!1,S=!1,v=!1,b=!1,w=!1,T;if(t.clusteredLightingEnabled&&this.lighting&&(b=!0,x=!0,S=!0,w=!0,n.append(s.floatUnpackingPS),t.lightMaskDynamic&&i.append("#define CLUSTER_MESH_DYNAMIC_LIGHTS"),t.clusteredLightingCookiesEnabled&&i.append("#define CLUSTER_COOKIES"),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(i.append("#define CLUSTER_SHADOWS"),i.append("#define CLUSTER_SHADOW_TYPE_"+tn[t.clusteredLightingShadowType])),t.clusteredLightingAreaLightsEnabled&&i.append("#define CLUSTER_AREALIGHTS"),i.append(Qh.getShaderDefines(e)),t.clusteredLightingShadowsEnabled&&!t.noShadow&&n.append(s.clusteredLightShadowsPS),n.append(s.clusteredLightPS)),t.twoSidedLighting&&i.append("uniform float twoSidedLightingNegScaleFactor;"),a.append(this._fsGetStartCode(a,e,s,t)),this.needsNormal&&(t.twoSidedLighting?a.append("    dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);"):a.append("    dVertexNormalW = normalize(vNormalW);"),(t.useHeights||t.useNormals)&&t.hasTangents&&(t.twoSidedLighting?(a.append("    dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;"),a.append("    dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;")):(a.append("    dTangentW = vTangentW;"),a.append("    dBinormalW = vBinormalW;"))),a.append("    getViewDir();"),_&&a.append("    getTBN(dTangentW, dBinormalW, dVertexNormalW);")),a.append(this.frontendFunc),this.needsNormal&&(t.useSpecular&&r.append("    getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);"),t.useClearCoat&&r.append("    ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));")),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&(r.append("    float f0 = 1.0 / litArgs_ior; f0 = (f0 - 1.0) / (f0 + 1.0); f0 *= f0;"),r.append("    litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);"),r.append("    litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);")),t.useIridescence&&r.append("    vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);")),g&&(r.append("    addAmbient(litArgs_worldNormal);"),t.conserveEnergy&&t.useSpecular&&r.append("   dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);"),t.separateAmbient&&r.append(`
										vec3 dAmbientLight = dDiffuseLight;
										dDiffuseLight = vec3(0);
								`)),t.useAmbientTint&&!m&&r.append("    dDiffuseLight *= material_ambient;"),t.useAo&&!t.occludeDirect&&r.append("    occludeDiffuse(litArgs_ao);"),t.lightMapEnabled&&r.append(`    addLightMap(
								litArgs_lightmap, 
								litArgs_lightmapDir, 
								litArgs_worldNormal, 
								dViewDirW, 
								dReflDirW, 
								litArgs_gloss, 
								litArgs_specularity, 
								dVertexNormalW,
								dTBN
						#if defined(LIT_IRIDESCENCE)
								, iridescenceFresnel,
								litArgs_iridescence_intensity
						#endif
								);`),this.lighting||this.reflections){this.reflections&&(t.useClearCoat&&(r.append("    addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);"),t.fresnelModel>0?(r.append("    ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));"),r.append("    ccReflection.rgb *= ccFresnel;")):r.append("    ccFresnel = 0.0;")),t.useSpecularityFactor&&r.append("    ccReflection.rgb *= litArgs_specularityFactor;"),t.useSheen&&r.append("    addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);"),r.append("    addReflection(dReflDirW, litArgs_gloss);"),t.fresnelModel>0?r.append(`    dReflection.rgb *= 
												getFresnel(
														dot(dViewDirW, litArgs_worldNormal), 
														litArgs_gloss, 
														litArgs_specularity
												#if defined(LIT_IRIDESCENCE)
														, iridescenceFresnel,
														litArgs_iridescence_intensity
												#endif
														);`):r.append("    dReflection.rgb *= litArgs_specularity;"),t.useSpecularityFactor&&r.append("    dReflection.rgb *= litArgs_specularityFactor;")),f&&(r.append("    dSpecularLight *= litArgs_specularity;"),t.useSpecular&&r.append("    calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);"));for(let P=0;P<t.lights.length;P++){const D=t.lights[P],R=D._type;if(t.clusteredLightingEnabled&&R!==ae)continue;T=!1;const A=f&&D._shape?D.shape:yt,L=f&&D._shape?this._getLightSourceShapeString(A):"";if(A!==yt&&r.append("    calc"+L+"LightValues(light"+P+"_position, light"+P+"_halfWidth, light"+P+"_halfHeight);"),R===ae?(r.append("    dLightDirNormW = light"+P+"_direction;"),r.append("    dAtten = 1.0;")):(D._cookie&&(R===Ie&&!D._cookie._cubemap||R===be&&D._cookie._cubemap)&&(w=!0,T=!0),r.append("    getLightDirPoint(light"+P+"_position);"),x=!0,T&&(R===Ie?r.append("    dAtten3 = getCookie2D"+(D._cookieFalloff?"":"Clip")+(D._cookieTransform?"Xform":"")+"(light"+P+"_cookie, light"+P+"_shadowMatrix, light"+P+"_cookieIntensity"+(D._cookieTransform?", light"+P+"_cookieMatrix, light"+P+"_cookieOffset":"")+")."+D._cookieChannel+";"):r.append("    dAtten3 = getCookieCube(light"+P+"_cookie, light"+P+"_shadowMatrix, light"+P+"_cookieIntensity)."+D._cookieChannel+";")),A===yt?D._falloffMode===Ud?(r.append("    dAtten = getFalloffLinear(light"+P+"_radius, dLightDirW);"),S=!0):(r.append("    dAtten = getFalloffInvSquared(light"+P+"_radius, dLightDirW);"),v=!0):(r.append("    dAtten = getFalloffWindow(light"+P+"_radius, dLightDirW);"),v=!0),r.append("    if (dAtten > 0.00001) {"),R===Ie&&(T&&!D._cookieFalloff||(r.append("    dAtten *= getSpotEffect(light"+P+"_direction, light"+P+"_innerConeAngle, light"+P+"_outerConeAngle, dLightDirNormW);"),b=!0))),A!==yt?R===ae?r.append("    dAttenD = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"):r.append("    dAttenD = get"+L+"LightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW) * 16.0;"):r.append("    dAtten *= getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"),D.castShadows&&!t.noShadow){const F=D._shadowType===At,N=D._shadowType===fs||D._shadowType===Ls||D._shadowType===ps,V=D._shadowType===ai||D._shadowType===at||D._shadowType===Fs;let k=null,$;switch(D._shadowType){case fs:k="VSM8",$="0.0";break;case Ls:k="VSM16",$="5.54";break;case ps:k="VSM32",e.textureFloatHighPrecision?$="15.0":$="5.54";break;case ai:k="PCF1x1";break;case Fs:k="PCF5x5";break;case At:k="PCSS";break;case at:default:k="PCF3x3";break}if(k!==null){D._normalOffsetBias&&!D._isVsm&&n.append("#define SHADOW_SAMPLE_NORMAL_OFFSET"),R===ae&&n.append("#define SHADOW_SAMPLE_ORTHO"),((V||F)&&e.isWebGL2||e.isWebGPU||e.extStandardDerivatives)&&n.append("#define SHADOW_SAMPLE_SOURCE_ZBUFFER"),R===be&&n.append("#define SHADOW_SAMPLE_POINT");const j=s.shadowSampleCoordPS;n.append(j.replace("$LIGHT",P)),n.append("#undef SHADOW_SAMPLE_NORMAL_OFFSET"),n.append("#undef SHADOW_SAMPLE_ORTHO"),n.append("#undef SHADOW_SAMPLE_SOURCE_ZBUFFER"),n.append("#undef SHADOW_SAMPLE_POINT");let K=`light${P}_shadowMatrix`;R===ae&&D.numCascades>1&&(r.append(`    getShadowCascadeMatrix(light${P}_shadowMatrixPalette, light${P}_shadowCascadeDistances, light${P}_shadowCascadeCount);`),K="cascadeShadowMat"),r.append(`    dShadowCoord = getShadowSampleCoord${P}(${K}, light${P}_shadowParams, vPositionW, dLightPosW, dLightDirW, dLightDirNormW, dVertexNormalW);`),R===ae&&r.append(`    fadeShadow(light${P}_shadowCascadeDistances);`);var E=`SHADOWMAP_PASS(light${P}_shadowMap), dShadowCoord, light${P}_shadowParams`;if(N)E=`${E}, ${$}, dLightDirW`;else if(F){let ee=`vec2(light${P}_shadowSearchArea)`;A!==yt&&(ee=`vec2(length(light${P}_halfWidth), length(light${P}_halfHeight)) * light${P}_shadowSearchArea`),E=`${E}, light${P}_cameraParams, ${ee}, dLightDirW`}R===be?(k=`Point${k}`,F||(E=`${E}, dLightDirW`)):R===Ie&&(k=`Spot${k}`),r.append(`    float shadow${P} = getShadow${k}(${E});`),r.append(`    dAtten *= mix(1.0, shadow${P}, light${P}_shadowIntensity);`)}}if(A!==yt?t.conserveEnergy&&t.useSpecular?r.append("    dDiffuseLight += ((dAttenD * dAtten) * light"+P+"_color"+(T?" * dAtten3":"")+") * (1.0 - dLTCSpecFres);"):r.append("    dDiffuseLight += (dAttenD * dAtten) * light"+P+"_color"+(T?" * dAtten3":"")+";"):f&&t.conserveEnergy&&t.useSpecular?r.append("    dDiffuseLight += (dAtten * light"+P+"_color"+(T?" * dAtten3":"")+") * (1.0 - litArgs_specularity);"):r.append("    dDiffuseLight += dAtten * light"+P+"_color"+(T?" * dAtten3":"")+";"),t.useSpecular&&r.append("    dHalfDirW = normalize(-dLightDirNormW + dViewDirW);"),D.affectSpecularity)if(A!==yt)t.useClearCoat&&r.append(`    ccSpecularLight += ccLTCSpecFres * get${L}LightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * light${P}_color`+(T?" * dAtten3":"")+";"),t.useSpecular&&r.append(`    dSpecularLight += dLTCSpecFres * get${L}LightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * light${P}_color`+(T?" * dAtten3":"")+";");else{var C=!1;R===ae&&t.fresnelModel>0&&(C=!0),t.useClearCoat&&r.append(`    ccSpecularLight += getLightSpecular(dHalfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * light${P}_color`+(T?" * dAtten3":"")+(C?" * getFresnelCC(dot(dViewDirW, dHalfDirW));":";")),t.useSheen&&r.append(`    sSpecularLight += getLightSpecularSheen(dHalfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * light${P}_color`+(T?" * dAtten3;":";")),t.useSpecular&&r.append(`    dSpecularLight += getLightSpecular(dHalfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * light${P}_color`+(T?" * dAtten3":"")+(C?` 
																		* getFresnel(
																				dot(dViewDirW, dHalfDirW), 
																				litArgs_gloss, 
																				litArgs_specularity
																		#if defined(LIT_IRIDESCENCE)
																				, iridescenceFresnel, 
																				litArgs_iridescence_intensity
																		#endif
																		);`:"* litArgs_specularity;"))}R!==ae&&r.append("    }")}t.clusteredLightingEnabled&&this.lighting&&(S=!0,v=!0,x=!0,r.append(`    addClusteredLights(
																				litArgs_worldNormal, 
																				dViewDirW, 
																				dReflDirW,
																#if defined(LIT_CLEARCOAT)
																				ccReflDirW,
																#endif
																				litArgs_gloss, 
																				litArgs_specularity, 
																				dVertexNormalW, 
																				dTBN, 
																#if defined(LIT_IRIDESCENCE)
																				iridescenceFresnel,
																#endif
																				litArgs_clearcoat_worldNormal, 
																				litArgs_clearcoat_gloss,
																				litArgs_sheen_gloss,
																				litArgs_iridescence_intensity
																		);`)),f&&(t.useClearCoat&&r.append("    litArgs_clearcoat_specularity = 1.0;"),t.useSpecular&&r.append("    litArgs_specularity = vec3(1);")),t.useRefraction&&r.append(`    addRefraction(
												litArgs_worldNormal, 
												dViewDirW, 
												litArgs_thickness, 
												litArgs_gloss, 
												litArgs_specularity, 
												litArgs_albedo, 
												litArgs_transmission,
												litArgs_ior
										#if defined(LIT_IRIDESCENCE)
												, iridescenceFresnel, 
												litArgs_iridescence_intensity
										#endif
										);`)}t.useAo&&(t.occludeDirect&&r.append("    occludeDiffuse(litArgs_ao);"),(t.occludeSpecular===Jr||t.occludeSpecular===Gd)&&r.append("    occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);")),t.useSpecularityFactor&&r.append("    dSpecularLight *= litArgs_specularityFactor;"),t.opacityFadesSpecular===!1&&((t.blendType===Bt||t.blendType===jn)&&(r.append("float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));"),r.append(`#ifdef LIT_CLEARCOAT
 specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));
#endif`),r.append("litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);")),r.append("litArgs_opacity *= material_alphaFade;")),r.append(s.endPS),t.blendType===Bt||t.blendType===Nd||t.alphaToCoverage?r.append(s.outputAlphaPS):t.blendType===jn?r.append(s.outputAlphaPremulPS):r.append(s.outputAlphaOpaquePS),t.useMsdf&&r.append("    gl_FragColor = applyMsdf(gl_FragColor);"),r.append(s.outputPS),r.append(s.debugOutputPS),x&&n.prepend(s.lightDirPointPS),S&&n.prepend(s.falloffLinearPS),v&&n.prepend(s.falloffInvSquaredPS),b&&n.prepend(s.spotPS),w&&!t.clusteredLightingEnabled&&n.prepend(s.cookiePS);let M="";const O=`void evaluateBackend() {
${r.code}
}`;n.append(O),a.append(s.debugProcessFrontendPS),a.append("    evaluateBackend();"),a.append(me.end());const I=i.code+n.code+a.code;return I.includes("dTBN")&&(M+=`mat3 dTBN;
`),I.includes("dVertexNormalW")&&(M+=`vec3 dVertexNormalW;
`),I.includes("dTangentW")&&(M+=`vec3 dTangentW;
`),I.includes("dBinormalW")&&(M+=`vec3 dBinormalW;
`),I.includes("dViewDirW")&&(M+=`vec3 dViewDirW;
`),I.includes("dReflDirW")&&(M+=`vec3 dReflDirW;
`),I.includes("dHalfDirW")&&(M+=`vec3 dHalfDirW;
`),I.includes("ccReflDirW")&&(M+=`vec3 ccReflDirW;
`),I.includes("dLightDirNormW")&&(M+=`vec3 dLightDirNormW;
`),I.includes("dLightDirW")&&(M+=`vec3 dLightDirW;
`),I.includes("dLightPosW")&&(M+=`vec3 dLightPosW;
`),I.includes("dShadowCoord")&&(M+=`vec3 dShadowCoord;
`),I.includes("dReflection")&&(M+=`vec4 dReflection;
`),I.includes("dDiffuseLight")&&(M+=`vec3 dDiffuseLight;
`),I.includes("dSpecularLight")&&(M+=`vec3 dSpecularLight;
`),I.includes("dAtten")&&(M+=`float dAtten;
`),I.includes("dAttenD")&&(M+=`float dAttenD;
`),I.includes("dAtten3")&&(M+=`vec3 dAtten3;
`),I.includes("dMsdf")&&(M+=`vec4 dMsdf;
`),I.includes("ccFresnel")&&(M+=`float ccFresnel;
`),I.includes("ccReflection")&&(M+=`vec3 ccReflection;
`),I.includes("ccSpecularLight")&&(M+=`vec3 ccSpecularLight;
`),I.includes("ccSpecularityNoFres")&&(M+=`float ccSpecularityNoFres;
`),I.includes("sSpecularLight")&&(M+=`vec3 sSpecularLight;
`),I.includes("sReflection")&&(M+=`vec3 sReflection;
`),this._fsGetBeginCode()+this.varyings+this.varyingDefines+this._fsGetBaseCode()+M+this.frontendDecl+I}generateFragmentShader(e,t,s,i){var n;const r=this.options;this.frontendDecl=e,this.frontendCode=t,this.frontendFunc=s,this.lightingUv=i,r.pass===ea?this.fshader=this._fsGetPickPassCode():r.pass===ui?this.fshader=this._fsGetDepthPassCode():r.pass===Uh?this.fshader=this._fsGetPrePassVelocityCode():this.shadowPass?this.fshader=this._fsGetShadowPassCode():r.customFragmentShader?this.fshader=this._fsGetBeginCode()+r.customFragmentShader:this.fshader=this._fsGetLitPassCode(),(n=this.handleCompatibility)==null||n.call(this)}getDefinition(){const e=je.createDefinition(this.device,{name:"LitShader",attributes:this.attributes,vertexCode:this.vshader,fragmentCode:this.fshader});return this.shaderPassInfo.isForward&&(e.tag=Hy),e}}const Jd={generateKey(o){return"lit"+Object.keys(o).sort().map(e=>e==="chunks"?Jd.generateChunksKey(o):e==="lights"?Jd.generateLightsKey(o):e+o[e]).join(`
`)},generateLightsKey(o){return"lights:"+o.lights.map(e=>!o.clusteredLightingEnabled||e._type===ae?`${e.key},`:"").join("")},generateChunksKey(o){var e;return`chunks:
`+Object.keys((e=o.chunks)!=null?e:{}).sort().map(t=>t+o.chunks[t]).join("")}},k2=[0,1,2,3,4,5,6,7];class U2 extends me{generateKey(e){return"lit"+k2.map((s,i)=>e.usedUvs[i]?"1":"0").join("")+e.shaderChunk+Jd.generateKey(e.litOptions)}createShaderDefinition(e,t){const s=new Ox(e,t.litOptions),i=new Gs,n=new Gs,r=new Gs;i.append("uniform float textureBias;"),i.append(s.chunks.litShaderArgsPS),n.append(t.shaderChunk),r.code="evaluateFrontend();",r.code=`
${r.code.split(`
`).map(h=>`    ${h}`).join(`
`)}

`;const a=t.usedUvs||[!0],l=[];return s.generateVertexShader(a,a,l),s.generateFragmentShader(i.code,n.code,r.code,"vUv0"),s.getDefinition()}}const z2=new U2,eu=new I2;class V2 extends pt{constructor(...e){super(...e),this.usedUvs=[!0],this.shaderChunk=`void evaluateFrontend() {}
`,this.chunks=null,this.useLighting=!0,this.useFog=!0,this.useGammaTonemap=!0,this.useSkybox=!0,this.shadingModel=Qr,this.ambientSH=null,this.pixelSnap=!1,this.nineSlicedMode=null,this.fastTbn=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=Jr,this.occludeSpecularIntensity=1,this.opacityFadesSpecular=!0,this.opacityDither=wt,this.opacityShadowDither=wt,this.conserveEnergy=!0,this.ggxSpecular=!1,this.fresnelModel=Lh,this.dynamicRefraction=!1,this.hasAo=!1,this.hasSpecular=!1,this.hasSpecularityFactor=!1,this.hasLighting=!1,this.hasHeights=!1,this.hasNormals=!1,this.hasSheen=!1,this.hasRefraction=!1,this.hasIrridescence=!1,this.hasMetalness=!1,this.hasClearCoat=!1,this.hasClearCoatNormals=!1}getShaderVariant(e,t,s,i,n,r,a,l,h){eu.usedUvs=this.usedUvs.slice(),eu.shaderChunk=this.shaderChunk,Vs.update(eu.litOptions,this,t,s,n,r);const c=new Zi(a,l,h),d=Us(e);return d.register("lit",z2),d.getProgram("lit",eu,c,this.userId)}}const tu=new y,su=new y,iu=new y,Lm=new ye,Bx=1e-6;class Nx{constructor(){this.light=null,this.min=new y,this.max=new y}}class nu{constructor(e){this.clusterTexture=void 0,this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new y,this.boundsMax=new y,this.boundsDelta=new y,this._cells=new y(1,1,1),this._cellsLimit=new y,this.cells=this._cells,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new Nx),this.lightsBuffer=new Qh(e),this.registerUniforms(e)}set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){tu.copy(e).floor(),this._cells.equals(tu)||(this._cells.copy(tu),this._cellsLimit.copy(tu).sub(y.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=e.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const e=this._cells.x,t=this._cells.y,s=this._cells.z,i=e*t*s,n=this.maxCellLightCount*i;let r=Math.ceil(Math.sqrt(n));r=U.roundUp(r,this.maxCellLightCount);const a=Math.ceil(n/r);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*s*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=r,this._clusterTextureSizeData[1]=1/r,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,r,a,Ul,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);const e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(e,t,s){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),s.copy(e.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),t.max(y.ZERO),s.min(this._cellsLimit)}collectLights(e){const t=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;e.forEach(n=>{const r=!!(n.mask&(ns|hi)),a=n.type===Ie&&n._outerConeAngle===0;if(n.enabled&&n.type!==ae&&n.visibleThisFrame&&n.intensity>0&&r&&!a&&i<t){let l;i<s.length?l=s[i]:(l=new Nx,s.push(l)),l.light=n,n.getBoundingBox(Lm),l.min.copy(Lm.getMin()),l.max.copy(Lm.getMax()),i++}}),s.length=i}evaluateBounds(){const e=this._usedLights,t=this.boundsMin,s=this.boundsMax;if(e.length>1){t.copy(e[1].min),s.copy(e[1].max);for(let i=2;i<e.length;i++)t.min(e[i].min),s.max(e[i].max)}else t.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,t),this.lightsBuffer.setBounds(t,this.boundsDelta)}evaluateCompressionLimits(e){let t=0,s=0;const i=this._usedLights;for(let n=1;n<i.length;n++){const r=i[n].light;t=Math.max(r.attenuationEnd,t);const a=e?r._linearFinalColor:r._finalColor;s=Math.max(a[0],s),s=Math.max(a[1],s),s=Math.max(a[2],s)}this._maxAttenuation=t+Bx,this._maxColorValue=s+Bx,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(e){this.counts.fill(0),this.clusters.fill(0);const t=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,r=this.clusters,a=this.maxCellLightCount,l=this._usedLights;for(let h=1;h<l.length;h++){const c=l[h],d=c.light;this.lightsBuffer.addLightData(d,h,e),this.evalLightCellMinMax(c,su,iu);const u=su.x,f=iu.x,p=su.y,_=iu.y,m=su.z,g=iu.z;for(let x=u;x<=f;x++)for(let S=m;S<=g;S++)for(let v=p;v<=_;v++){const b=x+t*(S+v*s),w=i[b];w<n&&(r[a*b+w]=h,i[b]=w+1)}}}update(e,t,s){this.updateParams(s),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.evaluateCompressionLimits(t),this.updateClusters(t),this.uploadTextures()}activate(){this.updateUniforms()}}const kx=2.399963229728653,Jh={circlePoint(o){const e=Math.sqrt(Math.random()),t=Math.random()*2*Math.PI;o.x=e*Math.cos(t),o.y=e*Math.sin(t)},circlePointDeterministic(o,e,t){const s=e*kx,i=Math.sqrt(e)/Math.sqrt(t);o.x=i*Math.cos(s),o.y=i*Math.sin(s)},spherePointDeterministic(o,e,t,s=0,i=1){s=1-2*s,i=1-2*i;const n=U.lerp(s,i,e/t),r=Math.sqrt(1-n*n),a=kx*e;o.x=Math.cos(a)*r,o.y=n,o.z=Math.sin(a)*r},radicalInverse(o){let e=(o<<16|o>>>16)>>>0;return e=((e&1431655765)<<1|(e&2863311530)>>>1)>>>0,e=((e&858993459)<<2|(e&3435973836)>>>2)>>>0,e=((e&252645135)<<4|(e&4042322160)>>>4)>>>0,e=((e&16711935)<<8|(e&4278255360)>>>8)>>>0,e*23283064365386963e-26}},Ux=o=>{switch(o){case md:return"Cubemap";case Yy:return"Octahedral";default:return"Equirect"}},ru=(o,e,t)=>{if(o<=0)e[t+0]=0,e[t+1]=0,e[t+2]=0,e[t+3]=0;else if(o>=1)e[t+0]=255,e[t+1]=0,e[t+2]=0,e[t+3]=0;else{let s=1*o%1,i=255*o%1,n=65025*o%1;const r=16581375*o%1;s-=i/255,i-=n/255,n-=r/255,e[t+0]=Math.min(255,Math.floor(s*256)),e[t+1]=Math.min(255,Math.floor(i*256)),e[t+2]=Math.min(255,Math.floor(n*256)),e[t+3]=Math.min(255,Math.floor(r*256))}},G2=o=>{const e=o.length,t=Math.min(e,512),s=Math.ceil(e/t),i=new Uint8Array(t*s*4);let n=0;for(let r=0;r<e;r+=4)ru(o[r+0]*.5+.5,i,n+0),ru(o[r+1]*.5+.5,i,n+4),ru(o[r+2]*.5+.5,i,n+8),ru(o[r+3]/8,i,n+12),n+=16;return{width:t,height:s,data:i}},W2=(o,e,t,s)=>{const i=t*2*Math.PI,n=Math.pow(1-e,1/(s+1)),r=Math.sqrt(1-n*n);o.set(Math.cos(i)*r,Math.sin(i)*r,n).normalize()},H2=(o,e,t)=>{const s=t*2*Math.PI,i=Math.sqrt(1-e),n=Math.sqrt(e);o.set(Math.cos(s)*n,Math.sin(s)*n,i).normalize()},X2=(o,e,t,s)=>{const i=t*2*Math.PI,n=Math.sqrt((1-e)/(1+(s*s-1)*e)),r=Math.sqrt(1-n*n);o.set(Math.cos(i)*r,Math.sin(i)*r,n).normalize()},$2=(o,e)=>{const t=o*e,s=e/(1-o*o+t*t);return s*s*(1/Math.PI)},q2=(o,e)=>{const t=new y,s=[];for(let i=0;i<o;++i)W2(t,i/o,Jh.radicalInverse(i),e),s.push(t.x,t.y,t.z,0);return s},j2=(o,e)=>{const t=e/o,s=new y,i=[];for(let n=0;n<o;++n){H2(s,n/o,Jh.radicalInverse(n));const r=s.z/Math.PI,a=.5*Math.log2(t/r);i.push(s.x,s.y,s.z,a)}return i},Y2={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},K2=(o,e)=>{const t=Y2[o];return t&&t[e]||o},Z2=(o,e,t)=>{const s=t/o,i=1-Math.log2(e)/11,n=i*i,r=new y,a=new y,l=new y(0,0,1),h=[],c=K2(o,e);for(let d=0;d<c;++d){X2(r,d/c,Jh.radicalInverse(d),n);const u=r.z;if(a.set(r.x,r.y,r.z).mulScalar(2*u).sub(l),a.z>0){const f=$2(Math.min(1,u),n)/4+.001,p=.5*Math.log2(s/f);h.push(a.x,a.y,a.z,p)}}for(;h.length<o*4;)h.push(0,0,0,0);return h},Q2=(o,e,t)=>{const s=G2(t);return new re(o,{name:e,width:s.width,height:s.height,mipmaps:!1,minFilter:de,magFilter:de,levels:[s.data]})};class zx{constructor(e=!0){this.map=new Map,this.destroyContent=e}destroy(){this.destroyContent&&this.map.forEach((e,t)=>{e.destroy()})}get(e,t){if(!this.map.has(e)){const s=t();return this.map.set(e,s),s}return this.map.get(e)}}const J2=new zx(!1),eF=new Rs,Fm=(o,e,t)=>eF.get(o,()=>new zx).get(e,()=>Q2(o,e,J2.get(e,t))),tF=(o,e,t)=>{const s=`lambert-samples-${e}-${t}`;return Fm(o,s,()=>j2(e,t))},sF=(o,e,t)=>{const s=`phong-samples-${e}-${t}`;return Fm(o,s,()=>q2(e,t))},iF=(o,e,t,s)=>{const i=`ggx-samples-${e}-${t}-${s}`;return Fm(o,i,()=>Z2(e,t,s))},nF=`
attribute vec2 vertex_position;

uniform vec4 uvMod;

varying vec2 vUv0;

void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		vUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);
}
`;function Bi(o,e,t={}){var s,i,n,r,a;o instanceof Ue&&(o=arguments[1],e=arguments[2],t={},arguments[3]!==void 0&&(t.specularPower=arguments[3]),arguments[4]!==void 0&&(t.numSamples=arguments[4]));const l=(s=t.seamPixels)!=null?s:0,h=((i=(n=t.rect)==null?void 0:n.z)!=null?i:e.width)-l*2,c=((r=(a=t.rect)==null?void 0:a.w)!=null?r:e.height)-l*2;if(h<1||c<1)return!1;const d={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"},u=t.hasOwnProperty("specularPower")?t.specularPower:1,f=t.hasOwnProperty("face")?t.face:null,p=t.hasOwnProperty("distribution")?t.distribution:u===1?"none":"phong",_=d[p]||"reproject",m=_.startsWith("prefilterSamples"),g=fi.decodeFunc(o.encoding),x=fi.encodeFunc(e.encoding),S=`sample${Ux(o.projection)}`,v=`getDirection${Ux(e.projection)}`,b=t.hasOwnProperty("numSamples")?t.numSamples:1024,w=`${_}_${g}_${x}_${S}_${v}_${b}`,T=o.device;let E=Us(T).getCachedShader(w);if(!E){const R=`#define PROCESS_FUNC ${_}
`+(m?`#define USE_SAMPLES_TEX
`:"")+(o.cubemap?`#define CUBEMAP_SOURCE
`:"")+`#define DECODE_FUNC ${g}
#define ENCODE_FUNC ${x}
#define SOURCE_FUNC ${S}
#define TARGET_FUNC ${v}
#define NUM_SAMPLES ${b}
#define NUM_SAMPLES_SQRT ${Math.round(Math.sqrt(b)).toFixed(1)}
`;E=zt(T,nF,`${R}
${z.reprojectPS}`,w)}T.setBlendState(Ee.NOBLEND),T.scope.resolve(o.cubemap?"sourceCube":"sourceTex").setValue(o);const M=T.scope.resolve("params"),O=T.scope.resolve("params2"),I=T.scope.resolve("uvMod");l>0?I.setValue([(h+l*2)/h,(c+l*2)/c,-l/h,-l/c]):I.setValue([1,1,0,0]);const B=[0,u,o.fixCubemapSeams?1/o.width:0,e.fixCubemapSeams?1/e.width:0],P=[e.width*e.height*(e.cubemap?6:1),o.width*o.height*(o.cubemap?6:1)];if(m){const R=o.width*o.height*(o.cubemap?6:1),A=p==="ggx"?iF(T,b,u,R):p==="lambert"?tF(T,b,R):sF(T,b,u);T.scope.resolve("samplesTex").setValue(A),T.scope.resolve("samplesTexInverseSize").setValue([1/A.width,1/A.height])}for(let R=0;R<(e.cubemap?6:1);R++)if(f===null||R===f){var D;const A=new qe({colorBuffer:e,face:R,depth:!1,flipY:T.isWebGPU});B[0]=R,M.setValue(B),O.setValue(P),_s(T,A,E,(D=t)==null?void 0:D.rect),A.destroy()}return!0}const rF=!0,Om=(o,e=0)=>1+Math.floor(Math.log2(Math.max(o,e))),aF=o=>o.extTextureHalfFloat&&o.textureHalfFloatRenderable,oF=o=>o.extTextureFloat&&o.textureFloatRenderable,lF=o=>aF(o)?et:oF(o)?Ge:oe,hF=o=>oe,cF=(o,e,t,s)=>new re(o,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:t,type:t===oe?Or:bt,addressU:q,addressV:q,fixCubemapSeams:rF,mipmaps:!!s});class Bm{static generateSkyboxCubemap(e,t){const s=e.device,i=cF(s,t||(e.cubemap?e.width:e.width/4),oe,!1);return Bi(e,i,{numSamples:1024}),i}static generateLightingSource(e,t){const s=e.device,i=lF(s),n=(t==null?void 0:t.target)||new re(s,{name:"lighting-source",cubemap:!0,width:(t==null?void 0:t.size)||128,height:(t==null?void 0:t.size)||128,format:i,type:i===oe?Or:bt,addressU:q,addressV:q,fixCubemapSeams:!1,mipmaps:!0});return Bi(e,n,{numSamples:e.mipmaps?1:1024}),n}static generateAtlas(e,t){const s=e.device,i=hF(),n=(t==null?void 0:t.target)||new re(s,{name:"envAtlas",width:(t==null?void 0:t.size)||512,height:(t==null?void 0:t.size)||512,format:i,type:Or,projection:xp,addressU:q,addressV:q,mipmaps:!1}),r=n.width/512,a=new X(0,0,512*r,256*r),l=Om(256)-Om(4);for(let h=0;h<l;++h)Bi(e,n,{numSamples:1,rect:a,seamPixels:r}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(a.z*.5)),a.w=Math.max(1,Math.floor(a.w*.5));a.set(0,256*r,256*r,128*r);for(let h=1;h<7;++h)Bi(e,n,{numSamples:(t==null?void 0:t.numReflectionSamples)||1024,distribution:(t==null?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>h*2),rect:a,seamPixels:r}),a.y+=a.w,a.z=Math.max(1,Math.floor(a.z*.5)),a.w=Math.max(1,Math.floor(a.w*.5));return a.set(128*r,384*r,64*r,32*r),Bi(e,n,{numSamples:(t==null?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:a,seamPixels:r}),n}static generatePrefilteredAtlas(e,t){const s=e[0].device,i=e[0].format,n=e[0].type,r=(t==null?void 0:t.target)||new re(s,{name:"envPrefilteredAtlas",width:(t==null?void 0:t.size)||512,height:(t==null?void 0:t.size)||512,format:i,type:n,projection:xp,addressU:q,addressV:q,mipmaps:!1}),a=r.width/512,l=new X(0,0,512*a,256*a),h=Om(512);for(let c=0;c<h;++c)Bi(e[0],r,{numSamples:1,rect:l,seamPixels:a}),l.x+=l.w,l.y+=l.w,l.z=Math.max(1,Math.floor(l.z*.5)),l.w=Math.max(1,Math.floor(l.w*.5));l.set(0,256*a,256*a,128*a);for(let c=1;c<e.length;++c)Bi(e[c],r,{numSamples:1,rect:l,seamPixels:a}),l.y+=l.w,l.z=Math.max(1,Math.floor(l.z*.5)),l.w=Math.max(1,Math.floor(l.w*.5));return l.set(128*a,384*a,64*a,32*a),t!=null&&t.legacyAmbient?Bi(e[5],r,{numSamples:1,rect:l,seamPixels:a}):Bi(e[0],r,{numSamples:(t==null?void 0:t.numSamples)||2048,distribution:"lambert",rect:l,seamPixels:a}),r}}class jo{constructor(){this.forceUv1=!1,this.ambientTint=!1,this.diffuseTint=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveTint=!1,this.opacityTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.litOptions=new Yh}get pass(){return this.litOptions.pass}}const Yo=[],Nm=o=>Object.keys(o).filter(e=>e!=="litOptions").sort();class dF extends me{constructor(...e){super(...e),this.optionsContext=new jo,this.optionsContextMin=new jo}generateKey(e){let t;return e===this.optionsContextMin?(this.propsMin||(this.propsMin=Nm(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=Nm(e)),t=this.props):t=Nm(e),`standard:
`+t.map(i=>i+e[i]).join(`
`)+Jd.generateKey(e.litOptions)}_getUvSourceExpression(e,t,s){const i=s[e],n=s[t],r=s.litOptions.pass===Wo||s.litOptions.pass===di;let a;return r&&s.litOptions.nineSlicedMode===ot||r&&s.litOptions.nineSlicedMode===st?a="nineSlicedUv":(i===0?a="vUv"+n:a="vUV"+n+"_"+i,s.heightMap&&e!=="heightMapTransform"&&(a+=" + dUvOffset")),a}_addMapDef(e,t){return t?`#define ${e}
`:`#undef ${e}
`}_addMapDefs(e,t,s,i,n){return this._addMapDef("MAPFLOAT",e)+this._addMapDef("MAPCOLOR",t)+this._addMapDef("MAPVERTEX",s)+this._addMapDef("MAPTEXTURE",i)+this._addMapDef("MAPINVERT",n)}_addMap(e,t,s,i,n,r=null){const a=e+"Map",l=a+"Uv",h=a+"Identifier",c=a+"Transform",d=a+"Channel",u=e+"VertexColorChannel",f=e+"Tint",p=e+"VertexColor",_=e+"Mode",m=e+"Invert",g=s[f],x=s[p],S=s[a],v=s[h],b=s[_];let w=i[t];if(S){const M=this._getUvSourceExpression(c,l,s);if(w=w.replace(/\$UV/g,M).replace(/\$CH/g,s[d]),n&&w.search(/\$SAMPLER/g)!==-1){let O="texture_"+a;const I=n[v];I?O=I:n[v]=O,w=w.replace(/\$SAMPLER/g,O)}if(r&&(s[d]==="aaa"?w=w.replace(/\$DECODE/g,"passThrough"):w=w.replace(/\$DECODE/g,fi.decodeFunc(!s.litOptions.gamma&&r==="srgb"?"linear":r)),w.indexOf("$texture2DSAMPLE"))){const O={linear:"texture2D",srgb:"texture2DSRGB",rgbm:"texture2DRGBM",rgbe:"texture2DRGBE"};w=w.replace(/\$texture2DSAMPLE/g,O[r]||"texture2D")}}x&&(w=w.replace(/\$VC/g,s[u])),b&&(w=w.replace(/\$DETAILMODE/g,b));const T=!!(g&1),E=!!(g&2),C=!!s[m];return w=this._addMapDefs(T,E,x,S,C)+w,w.replace(/\$/g,"")}_correctChannel(e,t,s){if(s[e]>0){if(s[e]<t.length)return t.substring(0,s[e]);if(s[e]>t.length){let i=t;const n=i.charAt(i.length-1),r=s[e]-i.length;for(let a=0;a<r;a++)i+=n;return i}return t}}createShaderDefinition(e,t){const i=zs.get(e).getByIndex(t.litOptions.pass).isForward,n=new Ox(e,t.litOptions),r=[],a=[],l=[],h=2,c={};for(const m in Yo){const g=m+"Map";if(t[m+"VertexColor"]){const x=m+"VertexColorChannel";t[x]=this._correctChannel(m,t[x],Yo)}if(t[g]){const x=g+"Channel",S=g+"Transform",v=g+"Uv";t[v]=Math.min(t[v],h-1),t[x]=this._correctChannel(m,t[x],Yo);const b=t[v];r[b]=!0,a[b]=a[b]||t[g]&&!t[S],t[S]&&l.push({name:m,id:t[S],uv:t[v]})}}t.forceUv1&&(r[1]=!0,a[1]=a[1]!==void 0?a[1]:!0),n.generateVertexShader(r,a,l),t.litOptions.shadingModel===li?(t.litOptions.fresnelModel=0,t.litOptions.ambientSH=!1):t.litOptions.fresnelModel=t.litOptions.fresnelModel===0?Lh:t.litOptions.fresnelModel;const d=new Gs,u=new Gs,f=new Gs,p=new Gs;let _="";if(t.litOptions.nineSlicedMode===st?d.append("const float textureBias = -1000.0;"):d.append("uniform float textureBias;"),i){if(t.heightMap&&(d.append("vec2 dUvOffset;"),u.append(this._addMap("height","parallaxPS",t,n.chunks,c)),f.append("getParallax();")),t.litOptions.blendType!==Nt||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==wt){d.append("float dAlpha;"),u.append(this._addMap("opacity","opacityPS",t,n.chunks,c)),f.append("getOpacity();"),p.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(u.append(n.chunks.alphaTestPS),f.append("alphaTest(dAlpha);"));const m=t.litOptions.opacityDither;m!==wt&&(m===fm&&d.append(n.chunks.bayerPS),d.append(`#define DITHER_${m.toUpperCase()}
`),d.append(n.chunks.opacityDitherPS),f.append("opacityDither(dAlpha, 0.0);"))}else d.append("float dAlpha = 1.0;");if(n.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&(u.append(t.packedNormal?n.chunks.normalXYPS:n.chunks.normalXYZPS),!t.litOptions.hasTangents)){const m=t.normalMap?"normalMap":"clearCoatNormalMap";_=this._getUvSourceExpression(`${m}Transform`,`${m}Uv`,t)}d.append("vec3 dNormalW;"),u.append(this._addMap("normalDetail","normalDetailMapPS",t,n.chunks,c)),u.append(this._addMap("normal","normalMapPS",t,n.chunks,c)),f.append("getNormal();"),p.append("litArgs_worldNormal = dNormalW;")}if(n.needsSceneColor&&d.append("uniform sampler2D uSceneColorMap;"),n.needsScreenSize&&d.append("uniform vec4 uScreenSize;"),n.needsTransforms&&(d.append("uniform mat4 matrix_viewProjection;"),d.append("uniform mat4 matrix_model;")),(t.diffuseDetail||t.aoDetail)&&u.append(n.chunks.detailModesPS),d.append("vec3 dAlbedo;"),t.diffuseDetail&&u.append(this._addMap("diffuseDetail","diffuseDetailMapPS",t,n.chunks,c,t.diffuseDetailEncoding)),u.append(this._addMap("diffuse","diffusePS",t,n.chunks,c,t.diffuseEncoding)),f.append("getAlbedo();"),p.append("litArgs_albedo = dAlbedo;"),t.litOptions.useRefraction&&(d.append("float dTransmission;"),u.append(this._addMap("refraction","transmissionPS",t,n.chunks,c)),f.append("getRefraction();"),p.append("litArgs_transmission = dTransmission;"),d.append("float dThickness;"),u.append(this._addMap("thickness","thicknessPS",t,n.chunks,c)),f.append("getThickness();"),p.append("litArgs_thickness = dThickness;")),t.litOptions.useIridescence&&(d.append("float dIridescence;"),u.append(this._addMap("iridescence","iridescencePS",t,n.chunks,c)),f.append("getIridescence();"),p.append("litArgs_iridescence_intensity = dIridescence;"),d.append("float dIridescenceThickness;"),u.append(this._addMap("iridescenceThickness","iridescenceThicknessPS",t,n.chunks,c)),f.append("getIridescenceThickness();"),p.append("litArgs_iridescence_thickness = dIridescenceThickness;")),n.lighting&&t.litOptions.useSpecular||n.reflections?(d.append("vec3 dSpecularity;"),d.append("float dGlossiness;"),t.litOptions.useSheen&&(d.append("vec3 sSpecularity;"),u.append(this._addMap("sheen","sheenPS",t,n.chunks,c,t.sheenEncoding)),f.append("getSheen();"),p.append("litArgs_sheen_specularity = sSpecularity;"),d.append("float sGlossiness;"),u.append(this._addMap("sheenGloss","sheenGlossPS",t,n.chunks,c)),f.append("getSheenGlossiness();"),p.append("litArgs_sheen_gloss = sGlossiness;")),t.litOptions.useMetalness&&(d.append("float dMetalness;"),u.append(this._addMap("metalness","metalnessPS",t,n.chunks,c)),f.append("getMetalness();"),p.append("litArgs_metalness = dMetalness;"),d.append("float dIor;"),u.append(this._addMap("ior","iorPS",t,n.chunks,c)),f.append("getIor();"),p.append("litArgs_ior = dIor;")),t.litOptions.useSpecularityFactor&&(d.append("float dSpecularityFactor;"),u.append(this._addMap("specularityFactor","specularityFactorPS",t,n.chunks,c)),f.append("getSpecularityFactor();"),p.append("litArgs_specularityFactor = dSpecularityFactor;")),t.useSpecularColor?u.append(this._addMap("specular","specularPS",t,n.chunks,c,t.specularEncoding)):u.append("void getSpecularity() { dSpecularity = vec3(1); }"),u.append(this._addMap("gloss","glossPS",t,n.chunks,c)),f.append("getGlossiness();"),f.append("getSpecularity();"),p.append("litArgs_specularity = dSpecularity;"),p.append("litArgs_gloss = dGlossiness;")):(d.append("vec3 dSpecularity = vec3(0.0);"),d.append("float dGlossiness = 0.0;")),t.aoDetail&&u.append(this._addMap("aoDetail","aoDetailMapPS",t,n.chunks,c)),(t.aoMap||t.aoVertexColor)&&(d.append("float dAo;"),u.append(this._addMap("ao","aoPS",t,n.chunks,c)),f.append("getAO();"),p.append("litArgs_ao = dAo;")),d.append("vec3 dEmission;"),u.append(this._addMap("emissive","emissivePS",t,n.chunks,c,t.emissiveEncoding)),f.append("getEmission();"),p.append("litArgs_emission = dEmission;"),t.litOptions.useClearCoat&&(d.append("float ccSpecularity;"),d.append("float ccGlossiness;"),d.append("vec3 ccNormalW;"),u.append(this._addMap("clearCoat","clearCoatPS",t,n.chunks,c)),u.append(this._addMap("clearCoatGloss","clearCoatGlossPS",t,n.chunks,c)),u.append(this._addMap("clearCoatNormal","clearCoatNormalPS",t,n.chunks,c)),f.append("getClearCoat();"),f.append("getClearCoatGlossiness();"),f.append("getClearCoatNormal();"),p.append("litArgs_clearcoat_specularity = ccSpecularity;"),p.append("litArgs_clearcoat_gloss = ccGlossiness;"),p.append("litArgs_clearcoat_worldNormal = ccNormalW;")),t.lightMap||t.lightVertexColor){const m=t.dirLightMap&&t.litOptions.useSpecular,g=m?"lightmapDirPS":"lightmapSinglePS";d.append("vec3 dLightmap;"),m&&d.append("vec3 dLightmapDir;"),u.append(this._addMap("light",g,t,n.chunks,c,t.lightMapEncoding)),f.append("getLightMap();"),p.append("litArgs_lightmap = dLightmap;"),m&&p.append("litArgs_lightmapDir = dLightmapDir;")}(u.code.indexOf("texture2DSRGB")!==-1||u.code.indexOf("texture2DRGBM")!==-1||u.code.indexOf("texture2DRGBE")!==-1)&&u.prepend(n.chunks.textureSamplePS)}else{const m=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||m)&&(d.append("float dAlpha;"),u.append(this._addMap("opacity","opacityPS",t,n.chunks,c)),f.append("getOpacity();"),p.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(u.append(n.chunks.alphaTestPS),f.append("alphaTest(dAlpha);")),m!==wt&&(m===fm&&d.append(n.chunks.bayerPS),d.append(`#define DITHER_${m.toUpperCase()}
`),d.append(n.chunks.opacityDitherPS),f.append("opacityDither(dAlpha, 0.0);")))}d.append(n.chunks.litShaderArgsPS),u.append(`void evaluateFrontend() { 
${f.code}
${p.code}
 }
`),f.code="evaluateFrontend();";for(const m in c)d.append(`uniform sampler2D ${c[m]};`);return f.code=`
${f.code.split(`
`).map(m=>`    ${m}`).join(`
`)}

`,n.generateFragmentShader(d.code,u.code,f.code,_),n.getDefinition()}}const km=new dF,Vx=(o,e)=>{if(o.length!==e.length)return!1;for(let t=0;t<o.length;++t)if(o[t]!==e[t])return!1;return!0},au=o=>o.r!==1||o.g!==1||o.b!==1,uF=o=>o.r!==0||o.g!==0||o.b!==0;class fF{constructor(){this._mapXForms=null}updateMinRef(e,t,s,i,n,r){this._updateSharedOptions(e,t,s,i,n),this._updateMinOptions(e,s),this._updateUVOptions(e,s,i,!0)}updateRef(e,t,s,i,n,r){this._updateSharedOptions(e,t,s,i,n),this._updateEnvOptions(e,s,t),this._updateMaterialOptions(e,s),n===di&&(e.litOptions.gamma&&(e.litOptions.gamma=Oo),e.litOptions.toneMap=Bo),e.litOptions.hasTangents=i&&(i&Hd)!==0,this._updateLightOptions(e,t,s,i,r),this._updateUVOptions(e,s,i,!1)}_updateSharedOptions(e,t,s,i,n){e.forceUv1=s.forceUv1,s.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),e.litOptions.chunks=s.chunks||{},e.litOptions.pass=n,e.litOptions.alphaTest=s.alphaTest>0,e.litOptions.blendType=s.blendType,e.litOptions.screenSpace=i&&(i&Uo)!==0,e.litOptions.skin=i&&(i&No)!==0,e.litOptions.useInstancing=i&&(i&ko)!==0,e.litOptions.useMorphPosition=i&&(i&zo)!==0,e.litOptions.useMorphNormal=i&&(i&Vo)!==0,e.litOptions.useMorphTextureBased=i&&(i&Go)!==0,e.litOptions.nineSlicedMode=s.nineSlicedMode||0,t.clusteredLightingEnabled&&s.useLighting?(e.litOptions.clusteredLightingEnabled=!0,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=!1,e.litOptions.clusteredLightingCookiesEnabled=!1,e.litOptions.clusteredLightingShadowsEnabled=!1,e.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(e,t,s,i){let n=!1,r=!1,a=!1;s&&(n=(s&lm)!==0,r=(s&hm)!==0,a=(s&cm)!==0),e.litOptions.vertexColors=!1,this._mapXForms=[];const l={};for(const h in Yo)this._updateTexOptions(e,t,h,n,r,a,i,l);this._mapXForms=null,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor,e.litOptions.diffuseMapEnabled=e.diffuseMap}_updateTexOptions(e,t,s,i,n,r,a,l){const h=s==="opacity";if(!a||h){const c=s+"Map",d=s+"VertexColor",u=s+"VertexColorChannel",f=c+"Channel",p=c+"Transform",_=c+"Uv",m=c+"Identifier";if(s!=="light"&&(e[c]=!1,e[m]=void 0,e[f]="",e[p]=0,e[_]=0),e[d]=!1,e[u]="",h&&t.blendType===Nt&&t.alphaTest===0&&!t.alphaToCoverage&&t.opacityDither===wt)return;if(s!=="height"&&t[d]&&r&&(e[d]=t[d],e[u]=t[u],e.litOptions.vertexColors=!0),t[c]){let g=!0;if(t[_]===0&&!i&&(g=!1),t[_]===1&&!n&&(g=!1),g){const x=t[c].id;let S=l[x];S===void 0&&(l[x]=s,S=s),e[c]=!!t[c],e[m]=S,e[p]=this._getMapTransformID(t.getUniform(p),t[_]),e[f]=t[f],e[_]=t[_]}}}}_updateMinOptions(e,t){e.opacityTint=t.opacity!==1&&(t.blendType!==Nt||t.opacityShadowDither!==wt),e.litOptions.opacityShadowDither=t.opacityShadowDither,e.litOptions.lights=[]}_updateMaterialOptions(e,t){var s,i,n,r;const a=(t.diffuseTint||!t.diffuseMap&&!t.diffuseVertexColor)&&au(t.diffuse),l=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||uF(t.specular)||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),h=!t.useMetalness||t.useMetalnessSpecularColor,c=l&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&au(t.specular),d=l&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),u=!t.emissiveMap||au(t.emissive)&&t.emissiveTint,f=t.emissiveIntensity!==1,p=t.normalMap?t.normalMap.format===Cr||t.normalMap.type===Br:!1;e.opacityTint=t.opacity!==1&&(t.blendType!==Nt||t.alphaTest>0||t.opacityDither!==wt)?1:0,e.ambientTint=t.ambientTint,e.diffuseTint=a?2:0,e.specularTint=c?2:0,e.specularityFactorTint=d?1:0,e.metalnessTint=t.useMetalness&&t.metalness<1?1:0,e.glossTint=1,e.emissiveTint=(u?2:0)+(f?1:0),e.diffuseEncoding=(s=t.diffuseMap)==null?void 0:s.encoding,e.diffuseDetailEncoding=(i=t.diffuseDetailMap)==null?void 0:i.encoding,e.emissiveEncoding=(n=t.emissiveMap)==null?void 0:n.encoding,e.lightMapEncoding=(r=t.lightMap)==null?void 0:r.encoding,e.packedNormal=p,e.refractionTint=t.refraction!==1?1:0,e.refractionIndexTint=t.refractionIndex!==1/1.5?1:0,e.thicknessTint=t.useDynamicRefraction&&t.thickness!==1?1:0,e.specularEncoding=t.specularEncoding||"linear",e.sheenEncoding=t.sheenEncoding||"linear",e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoMap,e.diffuseDetail=!!t.diffuseMap,e.normalDetail=!!t.normalMap,e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatTint=t.clearCoat!==1?1:0,e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatGlossTint=t.clearCoatGloss!==1?1:0,e.iorTint=t.refractionIndex!==1/1.5?1:0,e.iridescenceTint=t.iridescence!==1?1:0,e.sheenTint=t.useSheen&&au(t.sheen)?2:0,e.sheenGlossTint=1,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=h,e.litOptions.separateAmbient=!1,e.litOptions.useAmbientTint=t.ambientTint,e.litOptions.customFragmentShader=t.customFragmentShader,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.shadingModel=t.shadingModel,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.fastTbn=t.fastTbn,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=t.occludeSpecularIntensity!==1,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.conserveEnergy=t.conserveEnergy&&t.shadingModel!==li,e.litOptions.useSpecular=l,e.litOptions.useSpecularityFactor=(d||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||!!e.litOptions.reflectionSource),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&t.iridescence!==0,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction}_updateEnvOptions(e,t,s){e.litOptions.fog=t.useFog?s.fog:"none",e.litOptions.gamma=t.useGammaTonemap?s.gammaCorrection:Fo,e.litOptions.toneMap=t.useGammaTonemap?s.toneMapping:-1,e.litOptions.fixSeams=t.cubeMap?t.cubeMap.fixCubemapSeams:!1;const i=t.shadingModel===li;let n=!1;if(t.envAtlas&&t.cubeMap&&!i?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas&&!i?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource="sphereMap",e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&s.envAtlas&&s.skybox&&!i?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=s.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=s.skybox.encoding,n=!0):t.useSkybox&&s.envAtlas&&!i?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=s.envAtlas.encoding,n=!0):t.useSkybox&&s.skybox?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=s.skybox.encoding,n=!0):(e.litOptions.reflectionSource=null,e.litOptions.reflectionEncoding=null),t.ambientSH&&!i)e.litOptions.ambientSource="ambientSH",e.litOptions.ambientEncoding=null;else{const r=t.envAtlas||(t.useSkybox&&s.envAtlas?s.envAtlas:null);r&&!i?(e.litOptions.ambientSource="envAtlas",e.litOptions.ambientEncoding=r.encoding):(e.litOptions.ambientSource="constant",e.litOptions.ambientEncoding=null)}e.litOptions.skyboxIntensity=n&&(s.skyboxIntensity!==1||s.physicalUnits),e.litOptions.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}_updateLightOptions(e,t,s,i,n){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.litOptions.noShadow=(i&Nh)!==0,i&kh&&(e.lightMapEncoding=t.lightmapPixelFormat===oe?"rgbm":"linear",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!s.lightMap,i&Wd&&(e.dirLightMap=!0),i&Xd&&(e.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){const r=[],a=i?i>>16:ns;e.litOptions.lightMaskDynamic=!!(a&ns),n&&(Vs.collectLights(ae,n[ae],r,a),Vs.collectLights(be,n[be],r,a),Vs.collectLights(Ie,n[Ie],r,a)),e.litOptions.lights=r}else e.litOptions.lights=[];e.litOptions.lights.length===0&&(e.litOptions.noShadow=!0)}_getMapTransformID(e,t){if(!e)return 0;let s=this._mapXForms[t];s||(s=[],this._mapXForms[t]=s);for(let i=0;i<s.length;i++)if(Vx(s[i][0].value,e[0].value)&&Vx(s[i][1].value,e[1].value))return i+1;return s.push(e)}}function Ze(o,e=!0,t=!0){const s={};return s[`${o}Map`]="texture",s[`${o}MapTiling`]="vec2",s[`${o}MapOffset`]="vec2",s[`${o}MapRotation`]="number",s[`${o}MapUv`]="number",e&&(s[`${o}MapChannel`]="string",t&&(s[`${o}VertexColor`]="boolean",s[`${o}VertexColorChannel`]="string")),s}const Ko=gt({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean"},Ze("ao"),Ze("aoDetail",!0,!1),{aoDetailMode:"string",diffuse:"rgb",diffuseTint:"boolean"},Ze("diffuse"),Ze("diffuseDetail",!0,!1),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},Ze("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},Ze("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean"},Ze("metalness"),{useMetalnessSpecularColor:"boolean",conserveEnergy:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean"},Ze("gloss"),{clearCoat:"number"},Ze("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},Ze("clearCoatGloss"),{clearCoatBumpiness:"number"},Ze("clearCoatNormal",!1),{useSheen:"boolean",sheen:"rgb",sheenTint:"boolean"},Ze("sheen"),{sheenGloss:"number",sheenGlossTint:"boolean",sheenGlossInvert:"boolean"},Ze("sheenGloss"),{fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean"},Ze("emissive"),{emissiveIntensity:"number"},Ze("normal",!1),{bumpiness:"number"},Ze("normalDetail",!1),{normalDetailMapBumpiness:"number"},Ze("height",!0,!1),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},Ze("opacity"),{opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean"},Ze("refraction"),{refractionIndex:"number",thickness:"number",thicknessTint:"boolean"},Ze("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},Ze("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},Ze("iridescenceThickness"),Ze("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean"}),ou=[];for(const o in Ko)Ko[o]==="texture"&&ou.push(o);const Um=[];for(const o in Ko)Ko[o]==="cubemap"&&Um.push(o);const pF={aoMapVertexColor:"boolean",diffuseMapTint:"boolean",diffuseMapVertexColor:"boolean",emissiveMapTint:"boolean",emissiveMapVertexColor:"boolean",glossMapVertexColor:"boolean",metalnessMapVertexColor:"boolean",opacityMapVertexColor:"boolean",specularAntialias:"boolean",specularMapTint:"boolean",specularMapVertexColor:"boolean"},lu={},Gx={};let ec=new Set;class Ct extends pt{constructor(){super(),this.userAttributes=new Map,this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new fF,this.reset()}reset(){Object.keys(lu).forEach(e=>{this[`_${e}`]=lu[e].value()}),this._chunks={},this._uniformCache={}}set shader(e){}get shader(){return null}set chunks(e){this._dirtyShader=!0,this._chunks=e}get chunks(){return this._dirtyShader=!0,this._chunks}copy(e){super.copy(e),Object.keys(lu).forEach(t=>{this[t]=e[t]});for(const t in e._chunks)e._chunks.hasOwnProperty(t)&&(this._chunks[t]=e._chunks[t]);return this}setAttribute(e,t){this.userAttributes.set(t,e)}_setParameter(e,t){ec.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach(t=>{this._setParameter(t.name,t.value)})}_processParameters(e){const t=this[e];t.forEach(s=>{ec.has(s)||delete this.parameters[s]}),this[e]=ec,ec=t,ec.clear()}_updateMap(e){const t=e+"Map",s=this[t];if(s){this._setParameter("texture_"+t,s);const i=t+"Transform",n=this.getUniform(i);n&&this._setParameters(n)}}_allocUniform(e,t){let s=this._uniformCache[e];return s||(s=t(),this._uniformCache[e]=s),s}getUniform(e,t,s){return Gx[e](this,t,s)}updateUniforms(e,t){const s=n=>this.getUniform(n,e,t);this._setParameter("material_ambient",s("ambient")),(!this.diffuseMap||this.diffuseTint)&&this._setParameter("material_diffuse",s("diffuse")),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),(!this.specularityFactorMap||this.specularityFactorTint)&&this._setParameter("material_specularityFactor",this.specularityFactor),(!this.sheenMap||this.sheenTint)&&this._setParameter("material_sheen",s("sheen")),(!this.sheenGlossMap||this.sheenGlossTint)&&this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",s("gloss")),(!this.emissiveMap||this.emissiveTint)&&this._setParameter("material_emissive",s("emissive")),this.emissiveIntensity!==1&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",this.attenuationDistance===0?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),this.opacityFadesSpecular===!1&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),this.cubeMapProjection===$0&&this._setParameter(s("cubeMapProjectionBox"));for(const n in Yo)this._updateMap(n);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor"));const i=this.shadingModel===li;this.envAtlas&&this.cubeMap&&!i?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas&&!i?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&this.clearVariants()}updateEnvUniforms(e,t){const s=this.shadingModel===li;!(this.envAtlas&&!s||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox&&!s?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas&&!s?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(e,t,s,i,n,r,a,l,h){this.updateEnvUniforms(e,t);const c=zs.get(e).getByIndex(n),d=n===ui||n===ea||n===Uh||c.isShadow;let u=d?km.optionsContextMin:km.optionsContext;d?this.shaderOptBuilder.updateMinRef(u,t,this,s,n,r):this.shaderOptBuilder.updateRef(u,t,this,s,n,r),this.onUpdateShader&&(u=this.onUpdateShader(u));const f=new Zi(a,l,h),p=Us(e);p.register("standard",km);const _=p.getProgram("standard",u,f,this.userId);return this._dirtyShader=!1,_}destroy(){for(const e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}}Ct.TEXTURE_PARAMETERS=ou,Ct.CUBEMAP_PARAMETERS=Um;const hu=(o,e)=>{Gx[o]=e},zm=(o,e,t,s)=>{Object.defineProperty(Ct.prototype,o,{get:s||function(){return this[`_${o}`]},set:t}),lu[o]={value:e}},mF=o=>{const e=`_${o.name}`,t=o.dirtyShaderFunc||(()=>!0),s=function(n){const r=this[e];r!==n&&(this._dirtyShader=this._dirtyShader||t(r,n),this[e]=n)};zm(o.name,()=>o.defaultValue,s,o.getterFunc)},_F=o=>{const e=`_${o.name}`,t=o.dirtyShaderFunc||(()=>!0),s=function(n){const r=this[e];r.equals(n)||(this._dirtyShader=this._dirtyShader||t(r,n),this[e]=r.copy(n))};zm(o.name,()=>o.defaultValue.clone(),s,o.getterFunc)},Ws=o=>o.defaultValue&&o.defaultValue.clone?_F(o):mF(o);function Ye(o,e="rgb",t=!0,s=0){Yo[o]=e.length||-1,Ws({name:`${o}Map`,defaultValue:null,dirtyShaderFunc:(l,h)=>!!l!=!!h||l&&(l.type!==h.type||l.fixCubemapSeams!==h.fixCubemapSeams||l.format!==h.format)}),Ws({name:`${o}MapTiling`,defaultValue:new G(1,1)}),Ws({name:`${o}MapOffset`,defaultValue:new G(0,0)}),Ws({name:`${o}MapRotation`,defaultValue:0}),Ws({name:`${o}MapUv`,defaultValue:s}),e&&(Ws({name:`${o}MapChannel`,defaultValue:e}),t&&(Ws({name:`${o}VertexColor`,defaultValue:!1}),Ws({name:`${o}VertexColorChannel`,defaultValue:e})));const i=`${o}MapTiling`,n=`${o}MapOffset`,r=`${o}MapRotation`,a=`${o}MapTransform`;hu(a,(l,h,c)=>{const d=l[i],u=l[n],f=l[r];if(d.x===1&&d.y===1&&u.x===0&&u.y===0&&f===0)return null;const p=l._allocUniform(a,()=>[{name:`texture_${a}0`,value:new Float32Array(3)},{name:`texture_${a}1`,value:new Float32Array(3)}]),_=Math.cos(f*U.DEG_TO_RAD),m=Math.sin(f*U.DEG_TO_RAD),g=p[0].value;g[0]=_*d.x,g[1]=-m*d.y,g[2]=u.x;const x=p[1].value;return x[0]=m*d.x,x[1]=_*d.y,x[2]=1-d.y-u.y,p})}function Zo(o,e){Ws({name:o,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${o}`]}}),hu(o,(t,s,i)=>{const n=t._allocUniform(o,()=>new Float32Array(3)),r=t[o];return t.useGammaTonemap&&i.gammaCorrection?(n[0]=Math.pow(r.r,2.2),n[1]=Math.pow(r.g,2.2),n[2]=Math.pow(r.b,2.2)):(n[0]=r.r,n[1]=r.g,n[2]=r.b),n})}function ze(o,e,t){Ws({name:o,defaultValue:e,dirtyShaderFunc:(s,i)=>(s===0||s===1)!=(i===0||i===1)}),hu(o,t)}function tc(o,e){Ws({name:o,defaultValue:null,dirtyShaderFunc:(t,s)=>!!t==!!s}),hu(o,e)}function ve(o,e){Ws({name:o,defaultValue:e})}function gF(){Zo("ambient",new H(.7,.7,.7)),Zo("diffuse",new H(1,1,1)),Zo("specular",new H(0,0,0)),Zo("emissive",new H(0,0,0)),Zo("sheen",new H(1,1,1)),Zo("attenuation",new H(1,1,1)),ze("emissiveIntensity",1),ze("specularityFactor",1),ze("sheenGloss",0),ze("gloss",.25,(s,i,n)=>s.shadingModel===li?Math.pow(2,s.gloss*11):s.gloss),ze("heightMapFactor",1,(s,i,n)=>s.heightMapFactor*.025),ze("opacity",1),ze("alphaFade",1),ze("alphaTest",0),ze("bumpiness",1),ze("normalDetailMapBumpiness",1),ze("reflectivity",1),ze("occludeSpecularIntensity",1),ze("refraction",0),ze("refractionIndex",1/1.5),ze("thickness",0),ze("attenuationDistance",0),ze("metalness",1),ze("anisotropy",0),ze("clearCoat",0),ze("clearCoatGloss",1),ze("clearCoatBumpiness",1),ze("aoUvSet",0,null),ze("iridescence",0),ze("iridescenceRefractionIndex",1/1.5),ze("iridescenceThicknessMin",0),ze("iridescenceThicknessMax",0),tc("ambientSH"),tc("cubeMapProjectionBox",(s,i,n)=>{const r=s._allocUniform("cubeMapProjectionBox",()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]),a=s.cubeMapProjectionBox.getMin(),l=r[0].value;l[0]=a.x,l[1]=a.y,l[2]=a.z;const h=s.cubeMapProjectionBox.getMax(),c=r[1].value;return c[0]=h.x,c[1]=h.y,c[2]=h.z,r}),ve("ambientTint",!1),ve("diffuseTint",!1),ve("specularTint",!1),ve("specularityFactorTint",!1),ve("emissiveTint",!1),ve("fastTbn",!1),ve("useMetalness",!1),ve("useMetalnessSpecularColor",!1),ve("useSheen",!1),ve("enableGGXSpecular",!1),ve("occludeDirect",!1),ve("normalizeNormalMap",!0),ve("conserveEnergy",!0),ve("opacityFadesSpecular",!0),ve("occludeSpecular",Jr),ve("shadingModel",Qr),ve("fresnelModel",Lh),ve("useDynamicRefraction",!1),ve("cubeMapProjection",rm),ve("customFragmentShader",null),ve("useFog",!0),ve("useLighting",!0),ve("useGammaTonemap",!0),ve("useSkybox",!0),ve("forceUv1",!1),ve("pixelSnap",!1),ve("twoSidedLighting",!1),ve("nineSlicedMode",void 0),ve("msdfTextAttribute",!1),ve("useIridescence",!1),ve("glossInvert",!1),ve("sheenGlossInvert",!1),ve("clearCoatGlossInvert",!1),ve("opacityDither",wt),ve("opacityShadowDither",wt),Ye("diffuse"),Ye("specular"),Ye("emissive"),Ye("thickness","g"),Ye("specularityFactor","g"),Ye("normal",""),Ye("metalness","g"),Ye("gloss","g"),Ye("opacity","a"),Ye("refraction","g"),Ye("height","g",!1),Ye("ao","g"),Ye("light","rgb",!0,1),Ye("msdf",""),Ye("diffuseDetail","rgb",!1),Ye("normalDetail",""),Ye("aoDetail","g",!1),Ye("clearCoat","g"),Ye("clearCoatGloss","g"),Ye("clearCoatNormal",""),Ye("sheen","rgb"),Ye("sheenGloss","g"),Ye("iridescence","g"),Ye("iridescenceThickness","g"),ve("diffuseDetailMode",am),ve("aoDetailMode",am),tc("cubeMap"),tc("sphereMap"),tc("envAtlas");const o=function(){return this._prefilteredCubemaps},e=function(i){const n=this._prefilteredCubemaps;i=i||[];let r=!1,a=!0;for(let l=0;l<6;++l){const h=i[l]||null;n[l]!==h&&(n[l]=h,r=!0),a=a&&!!n[l]}r&&(a?this.envAtlas=Bm.generatePrefilteredAtlas(n,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)},t=[null,null,null,null,null,null];zm("prefilteredCubemaps",()=>t.slice(),e,o)}gF(),new y(1,1,1),new y(40,0,0);class na{constructor(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const e=this.renderTargets;for(let t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0}static getShadowFormat(e,t){return t===ps?Ge:t===Ls?et:t===Fs||(t===ai||t===at)&&e.supportsDepthShadow?In:t===At&&!e.isWebGL1?Pi:oe}static getShadowFiltering(e,t){return(t===ai||t===at||t===At)&&!e.supportsDepthShadow?de:t===ps?e.extTextureFloatLinear?Oe:de:t===Ls?e.extTextureHalfFloatLinear?Oe:de:Oe}static create(e,t){let s=null;return t._type===be?s=this.createCubemap(e,t._shadowResolution,t._shadowType):s=this.create2dMap(e,t._shadowResolution,t._shadowType),s}static createAtlas(e,t,s){const i=this.create2dMap(e,t,s),n=i.renderTargets,r=n[0];for(let a=0;a<5;a++)n.push(r);return i}static create2dMap(e,t,s){const i=this.getShadowFormat(e,s),n=this.getShadowFiltering(e,s),r=new re(e,{format:i,width:t,height:t,mipmaps:!1,minFilter:n,magFilter:n,addressU:q,addressV:q,name:"ShadowMap2D"});let a=null;return s===Fs||(s===ai||s===at)&&e.supportsDepthShadow?(r.compareOnRead=!0,r.compareFunc=jc,a=new qe({depthBuffer:r})):a=new qe({colorBuffer:r,depth:!0}),e.isWebGPU&&(a.flipY=!0),new na(r,[a])}static createCubemap(e,t,s){const i=s===At&&!e.isWebGL1?Pi:oe,n=new re(e,{format:i,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:de,magFilter:de,addressU:q,addressV:q,name:"ShadowMapCube"}),r=[];for(let a=0;a<6;a++){const l=new qe({colorBuffer:n,face:a,depth:!0});r.push(l)}return new na(n,r)}}const yF=[],vF=[],rn=new X,Vm=new X;class Gm{constructor(e){this.size=Math.floor(e.w*1024),this.used=!1,this.lightId=-1,this.rect=e}}class xF{constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new re(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:oe,cubemap:!1,mipmaps:!1,minFilter:de,magFilter:de,addressU:q,addressV:q}),this.cookieRenderTarget=new qe({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new G(0,0),new G(0,1),new G(1,0),new G(1,1),new G(2,0),new G(2,1)],this.scissorVec=new X,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){var e;(e=this.shadowAtlas)==null||e.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){var e,t;(e=this.cookieAtlas)==null||e.destroy(),this.cookieAtlas=null,(t=this.cookieRenderTarget)==null||t.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(e){if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=na.createAtlas(this.device,e,at),this.shadowAtlas.cached=!0;const t=4/this.shadowAtlasResolution;this.scissorVec.set(t,t,-2*t,-2*t)}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=this.shadowAtlas.renderTargets[0],i=!this.device.isWebGL1&&!0?t.depthBuffer:t.colorBuffer;this._shadowAtlasTextureId.setValue(i),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(e,t){let s=t.atlasSplit;if(!s){const n=Math.ceil(Math.sqrt(e));s=vF,s[0]=n,s.length=1}if(!((n,r)=>n.length===r.length&&n.every((a,l)=>a===r[l]))(s,this.atlasSplit)){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const n=this.atlasSplit[0];if(n>1){const r=1/n;for(let a=0;a<n;a++)for(let l=0;l<n;l++){const h=new X(a*r,l*r,r,r),c=this.atlasSplit[1+a*n+l];if(c>1)for(let d=0;d<c;d++)for(let u=0;u<c;u++){const f=r/c,p=new X(h.x+d*f,h.y+u*f,f,f);this.slots.push(new Gm(p))}else this.slots.push(new Gm(h))}}else this.slots.push(new Gm(new X(0,0,1,1)));this.slots.sort((r,a)=>a.size-r.size)}}collectLights(e,t){const s=t.cookiesEnabled,i=t.shadowsEnabled;let n=!1,r=!1;const a=yF;return a.length=0,(s||i)&&(h=>{for(let c=0;c<h.length;c++){const d=h[c];if(d.visibleThisFrame){const u=i&&d.castShadows,f=s&&!!d.cookie;n||(n=u),r||(r=f),(u||f)&&a.push(d)}}})(e),a.sort((h,c)=>c.maxScreenSize-h.maxScreenSize),n&&this.allocateShadowAtlas(this.shadowAtlasResolution),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(n||r)&&this.subdivide(a.length,t),a}setupSlot(e,t){e.atlasViewport.copy(t);const s=e.numShadowFaces;for(let i=0;i<s;i++)if(e.castShadows||e._cookie){if(rn.copy(t),Vm.copy(t),e._type===Ie&&rn.add(this.scissorVec),e._type===be){const n=rn.z/3,r=this.cubeSlotsOffsets[i];rn.x+=n*r.x,rn.y+=n*r.y,rn.z=n,rn.w=n,Vm.copy(rn)}if(e.castShadows){const n=e.getRenderData(null,i);n.shadowViewport.copy(rn),n.shadowScissor.copy(Vm)}}}assignSlot(e,t,s){e.atlasViewportAllocated=!0;const i=this.slots[t];i.lightId=e.id,i.used=!0,s&&(e.atlasSlotUpdated=!0,e.atlasVersion=this.version,e.atlasSlotIndex=t)}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;const s=this.collectLights(e,t);if(s.length>0){const i=this.slots;for(let a=0;a<i.length;a++)i[a].used=!1;const n=Math.min(s.length,i.length);for(let a=0;a<n;a++){const l=s[a];l.castShadows&&(l._shadowMap=this.shadowAtlas);const h=i[l.atlasSlotIndex];if(l.atlasVersion===this.version&&l.id===(h==null?void 0:h.lightId)){const c=i[l.atlasSlotIndex];c.size===i[a].size&&!c.used&&this.assignSlot(l,l.atlasSlotIndex,!1)}}let r=0;for(let a=0;a<n;a++){for(;r<i.length&&i[r].used;)r++;const l=s[a];l.atlasViewportAllocated||this.assignSlot(l,r,!0);const h=i[l.atlasSlotIndex];this.setupSlot(l,h.rect)}}this.updateUniforms()}}const SF=[new y(-1,0,0),new y(1,0,0),new y(0,-1,0),new y(0,1,0),new y(0,0,-1),new y(0,0,1)];class bF{constructor(){this.colors=new Float32Array(6*3)}update(e,t){const s=this.colors,{r:i,g:n,b:r}=e;for(let a=0;a<6;a++)s[a*3]=i,s[a*3+1]=n,s[a*3+2]=r;for(let a=0;a<t.length;a++){const l=t[a];if(l._type===ae)for(let h=0;h<6;h++){const c=Math.max(SF[h].dot(l._direction),0)*l._intensity,d=l._color;s[h*3]+=d.r*c,s[h*3+1]+=d.g*c,s[h*3+2]+=d.b*c}}}}class TF{constructor(){this.cache=new Map}destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach(e=>{e.forEach(t=>{t.destroy()})}),this.cache.clear()}getKey(e){const t=e._type===be,s=e._shadowType,i=e._shadowResolution;return`${t}-${s}-${i}`}get(e,t){const s=this.getKey(t),i=this.cache.get(s);if(i&&i.length)return i.pop();const n=na.create(e,t);return n.cached=!0,n}add(e,t){const s=this.getKey(e),i=this.cache.get(s);i?i.push(t):this.cache.set(s,[t])}}class wF extends Ot{constructor(e,t,s,i,n){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.light=s,this.face=i,this.applyVsm=n,this.shadowCamera=t.prepareFace(s,null,i),t.setupRenderPass(this,this.shadowCamera,!0)}execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}}class EF{constructor(e,t){this.shadowLights=[],this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s=null){const i=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=!0,i||e._shadowMap||(e._shadowMap=na.create(this.device,e));const n=e._type,r=n===Ie?1:6;for(let a=0;a<r;a++){const l=e.getRenderData(null,a),h=l.shadowCamera;h.nearClip=e.attenuationEnd/1e3,h.farClip=e.attenuationEnd,l.depthRangeCompensation=h.farClip-h.nearClip;const c=h._node,d=e._node;if(c.setPosition(d.getPosition()),n===Ie)h.fov=e._outerConeAngle*2,c.setRotation(d.getRotation()),c.rotateLocal(-90,0,0);else if(n===be)if(i){const p=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;h.fov=Math.atan(1+p)*U.RAD_TO_DEG*2}else h.fov=90;this.renderer.updateCameraFrustum(h),this.shadowRenderer.cullShadowCasters(t,e,l.visibleCasters,h,s)}}prepareLights(e,t){let s;for(let i=0;i<t.length;i++){const n=t[i];if(this.shadowRenderer.needsShadowRendering(n)&&n.atlasViewportAllocated){e.push(n);for(let r=0;r<n.numShadowFaces;r++)s=this.shadowRenderer.prepareFace(n,null,r)}}return s}buildNonClusteredRenderPasses(e,t){for(let s=0;s<t.length;s++){const i=t[s];if(this.shadowRenderer.needsShadowRendering(i)){const n=i._type===Ie,r=i.numShadowFaces;for(let a=0;a<r;a++){const l=new wF(this.device,this.shadowRenderer,i,a,n);e.addRenderPass(l)}}}}}class AF extends Ot{constructor(e,t,s,i,n){super(e),this.shadowRenderer=t,this.light=s,this.camera=i,this.allCascadesRendering=n}execute(){const{light:e,camera:t,shadowRenderer:s,allCascadesRendering:i}=this,n=e.numShadowFaces,r=e.shadowUpdateOverrides;for(let a=0;a<n;a++)(r==null?void 0:r[a])!==Bs&&s.renderFace(e,t,a,!i),(r==null?void 0:r[a])===Zn&&(r[a]=Bs)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}}const cu=new ye,an=new y,Wx=new W,Ne=[new y,new y,new y,new y,new y,new y,new y,new y],Wm={min:0,max:0};function CF(o,e,t){Ne[0].x=Ne[1].x=Ne[2].x=Ne[3].x=e.x,Ne[1].y=Ne[3].y=Ne[7].y=Ne[5].y=e.y,Ne[2].z=Ne[3].z=Ne[6].z=Ne[7].z=e.z,Ne[4].x=Ne[5].x=Ne[6].x=Ne[7].x=t.x,Ne[0].y=Ne[2].y=Ne[4].y=Ne[6].y=t.y,Ne[0].z=Ne[1].z=Ne[4].z=Ne[5].z=t.z;let s=9999999999,i=-9999999999;for(let n=0;n<8;++n){o.transformPoint(Ne[n],Ne[n]);const r=Ne[n].z;r<s&&(s=r),r>i&&(i=r)}return Wm.min=s,Wm.max=i,Wm}class MF{constructor(e,t){this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s,i=null){e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=na.create(this.device,e));const n=s._nearClip;this.generateSplitDistances(e,n,Math.min(s._farClip,e.shadowDistance));const r=e.shadowUpdateOverrides;for(let a=0;a<e.numCascades&&(r==null?void 0:r[a])!==Bs;a++){const l=e.getRenderData(s,a),h=l.shadowCamera;h.renderTarget=e._shadowMap.renderTargets[0],l.shadowViewport.copy(e.cascades[a]),l.shadowScissor.copy(e.cascades[a]);const c=h._node,d=e._node;c.setPosition(d.getPosition()),c.setRotation(d.getRotation()),c.rotateLocal(-90,0,0);const u=a===0?n:e._shadowCascadeDistances[a-1],f=e._shadowCascadeDistances[a],p=s.getFrustumCorners(u,f);an.set(0,0,0);const _=s.node.getWorldTransform();for(let P=0;P<8;P++)_.transformPoint(p[P],p[P]),an.add(p[P]);an.mulScalar(1/8);let m=0;for(let P=0;P<8;P++){const D=p[P].sub(an).length();D>m&&(m=D)}const g=c.right,x=c.up,S=c.forward,v=.25*e._shadowResolution/m,b=Math.ceil(an.dot(x)*v)/v,w=Math.ceil(an.dot(g)*v)/v,T=x.mulScalar(b),E=g.mulScalar(w),C=an.dot(S),M=S.mulScalar(C);an.add2(T,E).add(M),c.setPosition(an),c.translateLocal(0,0,1e6),h.nearClip=.01,h.farClip=2e6,h.orthoHeight=m,this.renderer.updateCameraFrustum(h),this.shadowRenderer.cullShadowCasters(t,e,l.visibleCasters,h,i);let O=!0;const I=l.visibleCasters;for(let P=0;P<I.length;P++){const D=I[P];O?(O=!1,cu.copy(D.aabb)):cu.add(D.aabb)}Wx.copy(c.getWorldTransform()).invert();const B=CF(Wx,cu.getMin(),cu.getMax());c.translateLocal(0,0,B.max+.1),h.farClip=B.max-B.min+.2,l.depthRangeCompensation=h.farClip,l.projectionCompensation=m}}generateSplitDistances(e,t,s){e._shadowCascadeDistances.fill(s);for(let i=1;i<e.numCascades;i++){const n=i/e.numCascades,r=t+(s-t)*n,a=t*(s/t)**n,l=U.lerp(r,a,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=l}}getLightRenderPass(e,t){let s=null;if(this.shadowRenderer.needsShadowRendering(e)){const i=e.numShadowFaces,n=e.shadowUpdateOverrides;let r=!0,a;for(let l=0;l<i;l++)(n==null?void 0:n[l])===Bs&&(r=!1),a=this.shadowRenderer.prepareFace(e,t,l);s=new AF(this.device,this.shadowRenderer,e,t,r),this.shadowRenderer.setupRenderPass(s,a,r)}return s}}function PF(o,e){return Math.exp(-(o*o)/(2*e*e))}function RF(o){const e=(o-1)/6,t=(o-1)*.5,s=new Array(o);let i=0;for(let n=0;n<o;++n)s[n]=PF(n-t,e),i+=s[n];for(let n=0;n<o;++n)s[n]/=i;return s}const Hm=new Set,Hx=new W,Xx=new W,ra=new Float32Array(2),sc=new X(1,1,0,0),$x=new W;class du{constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;const s=this.device.scope;this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[z.blurVSMPS,`#define GAUSS
`+z.blurVSMPS];const i=`#define PACKED
`;this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Ee,this.blendStateNoWrite=new Ee,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}static createShadowCamera(e,t,s,i){const n=pi.create("ShadowCamera",s,i);return t>=fs&&t<=ps?n.clearColor=new H(0,0,0,0):n.clearColor=new H(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n}static setShadowCameraSettings(e,t,s,i,n){let r=s===Fs||(s===ai||s===at)&&t.supportsDepthShadow;i===be&&!n&&(r=!1),e.clearColorBuffer=!r}_cullShadowCastersInternal(e,t,s){const i=e.length;for(let n=0;n<i;n++){const r=e[n];r.castShadow&&(!r.cull||r._isVisible(s))&&(r.visibleThisFrame=!0,t.push(r))}}cullShadowCasters(e,t,s,i,n){if(s.length=0,n)this._cullShadowCastersInternal(n,s,i);else{const r=e.layerList,a=r.length;for(let l=0;l<a;l++){const h=r[l];h._lightsSet.has(t)&&(Hm.has(h)||(Hm.add(h),this._cullShadowCastersInternal(h.shadowCasters,s,i)))}Hm.clear()}s.sort(this.renderer.sortCompareDepth)}setupRenderState(e,t){e.isWebGL1&&e.extStandardDerivatives&&(t._type===be?(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)):(this.polygonOffset[0]=t.shadowBias*-1e3,this.polygonOffset[1]=t.shadowBias*-1e3,this.polygonOffsetId.setValue(this.polygonOffset)));const s=this.renderer.scene.clusteredLightingEnabled,i=e.isWebGL2||e.isWebGPU,n=s?t._isPcf&&i:t._isPcf&&i&&t._type!==be;e.setBlendState(n?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null)}dispatchUniforms(e,t,s,i){const n=t._node;e._type!==ae&&(this.renderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),Hx.setTRS(n.getPosition(),n.getRotation(),y.ONE).invert(),Xx.mul2(t.projectionMatrix,Hx);const r=s.shadowViewport;t.rect=r,t.scissorRect=s.shadowScissor,$x.setViewport(r.x,r.y,r.z,r.w),s.shadowMatrix.mul2($x,Xx),e._type===ae&&e._shadowMatrixPalette.set(s.shadowMatrix.data,i*16)}getShadowPass(e){var t;const s=e._type,i=e._shadowType;let n=(t=this.shadowPassCache[s])==null?void 0:t[i];if(!n){const r=`ShadowPass_${s}_${i}`;n=zs.get(this.device).allocate(r,{isShadow:!0,lightType:s,shadowType:i}),this.shadowPassCache[s]||(this.shadowPassCache[s]=[]),this.shadowPassCache[s][i]=n}return n.index}submitCasters(e,t){const s=this.device,i=this.renderer,n=i.scene,r=1<<dm,a=this.getShadowPass(t),l=e.length;for(let h=0;h<l;h++){const c=e[h],d=c.mesh;c.ensureMaterial(s);const u=c.material;i.setBaseConstants(s,u),i.setSkinning(s,c),u.dirty&&(u.updateUniforms(s,n),u.dirty=!1),u.chunks&&(i.setupCullMode(!0,1,c),u.setParameters(s),c.setParameters(s,r));const f=c.getShaderInstance(a,0,n,this.viewUniformFormat,this.viewBindGroupFormat),p=f.shader;c._key[qd]=p.id,s.setShader(p),i.setVertexBuffers(s,d),i.setMorphing(s,c.morphInstance),this.renderer.setupMeshUniformBuffers(f,c);const _=c.renderStyle;s.setIndexBuffer(d.indexBuffer[_]),i.drawInstance(s,c,d,_),i._shadowDrawCalls++}}needsShadowRendering(e){const t=e.enabled&&e.castShadows&&e.shadowUpdateMode!==Bs&&e.visibleThisFrame;return e.shadowUpdateMode===Zn&&(e.shadowUpdateMode=Bs),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,s){return e.getRenderData(e._type===ae?t:null,s)}setupRenderPass(e,t,s){const i=t.renderTarget;e.init(i),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=s,i.depthBuffer?e.depthStencilOps.storeDepth=!0:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=s,e.depthStencilOps.storeDepth=!1),e.requiresCubemaps=!1}prepareFace(e,t,s){const i=e._type,n=e._shadowType,r=this.renderer.scene.clusteredLightingEnabled,l=this.getLightRenderData(e,t,s).shadowCamera;du.setShadowCameraSettings(l,this.device,n,i,r);const h=i===ae?0:s;return l.renderTarget=e._shadowMap.renderTargets[h],l}renderFace(e,t,s,i,n=!0){const r=this.device,a=this.getLightRenderData(e,t,s),l=a.shadowCamera;this.dispatchUniforms(e,l,a,s);const h=l.renderTarget,c=this.renderer;c.setCameraUniforms(l,h),r.supportsUniformBuffers&&c.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,1),n?(c.setupViewport(l,h),i&&c.clear(l)):c.clearView(l,h,!0,!1),this.setupRenderState(r,e),this.submitCasters(a.visibleCasters,e)}render(e,t,s=!0){if(this.needsShadowRendering(e)){const i=e.numShadowFaces;for(let n=0;n<i;n++)this.prepareFace(e,t,n),this.renderFace(e,t,n,!0,s);this.renderVsm(e,t)}}renderVsm(e,t){e._isVsm&&e._vsmBlurSize>1&&(!this.renderer.scene.clusteredLightingEnabled||e._type===ae)&&this.applyVsmBlur(e,t)}getVsmBlurShader(e,t,s){let i=(e?this.blurPackedVsmShader:this.blurVsmShader)[t][s];if(!i){this.blurVsmWeights[s]=RF(s);const n=z.fullscreenQuadVS;let r="#define SAMPLES "+s+`
`;e?r+=this.blurPackedVsmShaderCode[t]:r+=this.blurVsmShaderCode[t];const a="blurVsm"+t+s+e;i=zt(this.device,n,r,a),e?this.blurPackedVsmShader[t][s]=i:this.blurVsmShader[t][s]=i}return i}applyVsmBlur(e,t){const s=this.device;s.setBlendState(Ee.NOBLEND);const r=e.getRenderData(e._type===ae?t:null,0).shadowCamera.renderTarget,a=this.renderer.shadowMapCache.get(s,e),l=a.renderTargets[0],h=e._shadowType===fs,c=e.vsmBlurMode,d=e._vsmBlurSize,u=this.getVsmBlurShader(h,c,d);sc.z=e._shadowResolution-2,sc.w=sc.z,this.sourceId.setValue(r.colorBuffer),ra[0]=1/e._shadowResolution,ra[1]=0,this.pixelOffsetId.setValue(ra),c===zd&&this.weightId.setValue(this.blurVsmWeights[d]),_s(s,l,u,null,sc),this.sourceId.setValue(l.colorBuffer),ra[1]=ra[0],ra[0]=0,this.pixelOffsetId.setValue(ra),_s(s,r,u,null,sc),this.renderer.shadowMapCache.add(e,a)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new wh(this.device,[new rt("matrix_viewProjection",Ur)]),this.viewBindGroupFormat=new Ah(this.device,[new Eh(bo,jr|Jt)],[]))}frameUpdate(){this.initViewBindGroupFormat()}}const uu=[];class IF{constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e}destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach(e=>{e.destroy()}),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){const e=new nu(this.device);e.name="ClusterEmpty",e.update([],!1,null),this._empty=e}return this._empty}assign(e){const t=this.empty;uu.push(...this._allocated),this._allocated.length=0,this._clusters.clear();const s=e.length;for(let n=0;n<s;n++){const a=e[n].renderActions;if(a){const l=a.length;for(let h=0;h<l;h++){const c=a[h];c.lightClusters=null;const d=c.layer;if(d.hasClusteredLights&&d.meshInstances.length){const u=d.getLightIdHash(),f=this._clusters.get(u);let p=f==null?void 0:f.lightClusters;if(!p){var i;p=(i=uu.pop())!=null?i:new nu(this.device),this._allocated.push(p),this._clusters.set(u,c)}c.lightClusters=p}c.lightClusters||(c.lightClusters=t)}}}uu.forEach(n=>n.destroy()),uu.length=0}update(e,t,s){this.assign(e),this._clusters.forEach(i=>{const n=i.layer;i.lightClusters.update(n.clusteredLightsSet,t,s)})}}const qx=`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
		#ifndef WEBGPU
			uv0.y = 1.0 - uv0.y;
		#endif
	}`,DF=`
	varying vec2 uv0;
	uniform sampler2D blitTexture;
	void main(void) {
		gl_FragColor = texture2D(blitTexture, uv0);
	}`,LF=`
	varying vec2 uv0;
	uniform samplerCube blitTexture;
	uniform mat4 invViewProj;
	void main(void) {
		vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);
		vec4 worldPos = invViewProj * projPos;
		gl_FragColor = textureCube(blitTexture, worldPos.xyz);
	}`,Qn=new X,Xm=[];class $m extends Ot{constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._cubeSlotsOffsets=t,this.requiresCubemaps=!1,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj")}destroy(){var e,t;(e=this._quadRenderer2D)==null||e.destroy(),this._quadRenderer2D=null,(t=this._quadRendererCube)==null||t.destroy(),this._quadRendererCube=null}static create(e,t){const s=new $m(e.device,t);return s.init(e),s.colorOps.clear=!1,s.depthStencilOps.clearDepth=!1,s}update(e){const t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0}filter(e,t){for(let s=0;s<e.length;s++){const i=e[s];i._type!==ae&&i.atlasViewportAllocated&&i.atlasSlotUpdated&&i.enabled&&i.cookie&&i.visibleThisFrame&&t.push(i)}}initInvViewProjMatrices(){if(!Xm.length)for(let e=0;e<6;e++){const t=pi.create(null,be,e),s=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();Xm[e]=new W().mul2(s,i).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){const e=zt(this.device,qx,DF,"cookieRenderer2d");this._quadRenderer2D=new qh(e)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){const e=zt(this.device,qx,LF,"cookieRendererCube");this._quadRendererCube=new qh(e)}return this._quadRendererCube}execute(){const e=this.device;e.setBlendState(Ee.NOBLEND),e.setCullMode(Je),e.setDepthState(ft.NODEPTH),e.setStencilState();const t=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,i=this._filteredLights;for(let n=0;n<i.length;n++){const r=i[n],a=r.numShadowFaces,l=a>1?this.quadRendererCube:this.quadRenderer2D;a>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(r.cookie);for(let h=0;h<a;h++){if(Qn.copy(r.atlasViewport),a>1){const c=Qn.z/3,d=s[h];Qn.x+=c*d.x,Qn.y+=c*d.y,Qn.z=c,Qn.w=c,this.invViewProjId.setValue(Xm[h].data)}Qn.mulScalar(t),l.render(Qn)}}i.length=0}}class FF extends Ot{constructor(e,t,s){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.shadowRendererLocal=s}update(e){const t=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(t,e),i=t.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,s,!1)}execute(){const e=this.shadowRendererLocal.shadowLights,t=e.length;for(let s=0;s<t;s++){const i=e[s];for(let n=0;n<i.numShadowFaces;n++)this.shadowRenderer.renderFace(i,null,n,!0)}e.length=0}}class OF extends Ot{constructor(e,t,s,i,n){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=$m.create(n.cookieRenderTarget,n.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new FF(e,s,i),this.beforePasses.push(this.shadowRenderPass)}update(e,t,s,i,n){this.frameGraph=e,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(n)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){const{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.gammaCorrection,t.lighting)}}const BF="muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==";let on=null;const jx=()=>{if(!on){const o=atob(BF);on=Uint8Array.from(o,e=>e.charCodeAt(0))}},NF=()=>(jx(),on);class kF{constructor(e=0){this.seed=0,this.seed=e*4,jx()}_next(){this.seed=(this.seed+4)%on.length}value(){return this._next(),on[this.seed]/255}vec4(e=new X){return this._next(),e.set(on[this.seed],on[this.seed+1],on[this.seed+2],on[this.seed+3]).mulScalar(1/255)}}const UF=new Rs;function zF(o){return UF.get(o,()=>{const e=NF(),t=Math.sqrt(e.length/4),s=new re(o,{name:`BlueNoise${t}`,width:t,height:t,format:oe,addressU:Qe,addressV:Qe,type:bt,magFilter:de,minFilter:de,anisotropy:1,mipmaps:!1});return s.lock().set(e),s.unlock(),s})}let qm=0;const Jn=new W,er=new W,Qo=new W,Yx=new ls,jm=new Cn,Kx=new W().setScale(1,-1,1),Ym=new Set,Km=new Set,VF=new X,Zx=new W().set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),Qx=[new G(.5,.333333),new G(.25,.666667),new G(.75,.111111),new G(.125,.444444),new G(.625,.777778),new G(.375,.222222),new G(.875,.555556),new G(.0625,.888889),new G(.5625,.037037),new G(.3125,.37037),new G(.8125,.703704),new G(.1875,.148148),new G(.6875,.481481),new G(.4375,.814815),new G(.9375,.259259),new G(.03125,.592593)],GF=new W,WF=new W,HF=new W,XF=new W,$F=new W,qF=new W,Jo=new Set,Zm=[],Qm=[];class jF{constructor(e){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.worldClustersAllocator=void 0,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new kF(123),this.device=e,this.scene=null,this.worldClustersAllocator=new IF(e),this.lightTextureAtlas=new xF(e),this.shadowMapCache=new TF,this.shadowRenderer=new du(this,this.lightTextureAtlas),this._shadowRendererLocal=new EF(this,this.shadowRenderer),this._shadowRendererDirectional=new MF(this,this.shadowRenderer),this._renderPassUpdateClustered=new OF(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;const t=e.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.boneTextureSizeId=t.resolve("texture_poseMapSize"),this.poseMatrixId=t.resolve("matrix_pose[0]"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphWeightsA=t.resolve("morph_weights_a"),this.morphWeightsB=t.resolve("morph_weights_b"),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new bF,this.constantLightCube=t.resolve("lightCube[0]")}destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist;if(e.zdist2&&t.zdist2)return e.zdist2-t.zdist2}return t._key[Li]-e._key[Li]}sortCompareMesh(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist}const s=e._key[Li],i=t._key[Li];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}sortCompareDepth(e,t){const s=e._key[qd],i=t._key[qd];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}setupViewport(e,t){const s=this.device,i=t?t.width:s.width,n=t?t.height:s.height,r=e.rect;let a=Math.floor(r.x*i),l=Math.floor(r.y*n),h=Math.floor(r.z*i),c=Math.floor(r.w*n);if(s.setViewport(a,l,h,c),e._scissorRectClear){const d=e.scissorRect;a=Math.floor(d.x*i),l=Math.floor(d.y*n),h=Math.floor(d.z*i),c=Math.floor(d.w*n)}s.setScissor(a,l,h,c)}setCameraUniforms(e,t){const s=t==null?void 0:t.flipY;let i=1;if(e.xr&&e.xr.session){var n;const l=((n=e._node)==null||(n=n.parent)==null?void 0:n.getWorldTransform())||null,h=e.xr.views;i=h.list.length;for(let c=0;c<i;c++){const d=h.list[c];d.updateTransforms(l),e.frustum.setFromMat4(d.projViewOffMat)}}else{let l=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(l,Vh);let h=e.getProjectionMatrixSkybox();s&&(l=GF.mul2(Kx,l),h=WF.mul2(Kx,h)),this.device.isWebGPU&&(l=HF.mul2(Zx,l),h=XF.mul2(Zx,h));const{jitter:c}=e;let d=X.ZERO,u=0,f=0;if(c>0){const p=t?t.width:this.device.width,_=t?t.height:this.device.height,m=Qx[this.device.renderVersion%Qx.length];u=c*(m.x*2-1)/p,f=c*(m.y*2-1)/_,l=$F.copy(l),l.data[8]=u,l.data[9]=f,h=qF.copy(h),h.data[8]=u,h.data[9]=f,d=this.blueNoise.vec4(VF)}if(this.blueNoiseJitterId.setValue([d.x,d.y,d.z,d.w]),this.projId.setValue(l.data),this.projSkyboxId.setValue(h.data),e.calculateTransform)e.calculateTransform(er,Vh);else{const p=e._node.getPosition(),_=e._node.getRotation();er.setTRS(p,_,y.ONE)}this.viewInvId.setValue(er.data),Qo.copy(er).invert(),this.viewId.setValue(Qo.data),Yx.setFromMat4(Qo),this.viewId3.setValue(Yx.data),Jn.mul2(l,Qo),this.viewProjId.setValue(Jn.data),e._storeShaderMatrices(Jn,u,f,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(Jn)}this.tbnBasis.setValue(s?-1:1);const r=e._nearClip,a=e._farClip;return this.nearClipId.setValue(r),this.farClipId.setValue(a),this.cameraParams[0]=1/a,this.cameraParams[1]=a,this.cameraParams[2]=r,this.cameraParams[3]=e.projection===Yn?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),i}clear(e,t,s,i){const n=(t??e._clearColorBuffer?xr:0)|(s??e._clearDepthBuffer?Sr:0)|(i??e._clearStencilBuffer?Xa:0);n&&this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:n})}setCamera(e,t,s,i=null){this.setCameraUniforms(e,t),this.clearView(e,t,s,!1)}clearView(e,t,s,i){const n=this.device;if(n.setRenderTarget(t),n.updateBegin(),i&&(n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0)),this.setupViewport(e,t),s){const r=e._clearOptions;n.clear(r||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?xr:0)|(e._clearDepthBuffer?Sr:0)|(e._clearStencilBuffer?Xa:0),stencil:e._clearStencil})}}setupCullMode(e,t,s){const i=s.material;let n=Je;if(e){let r=1;(i.cull===br||i.cull===Ai)&&(r=t*s.flipFacesFactor*s.node.worldScaleSign),r<0?n=i.cull===br?Ai:br:n=i.cull}this.device.setCullMode(n),n===Je&&i.cull===Je&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){const s=e.xr.views.list[0];Jn.mul2(s.projMat,s.viewOffMat),e.frustum.setFromMat4(Jn);return}const t=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(t,Vh),e.calculateTransform)e.calculateTransform(er,Vh);else{const s=e._node.getPosition(),i=e._node.getRotation();er.setTRS(s,i,y.ONE),this.viewInvId.setValue(er.data)}Qo.copy(er).invert(),Jn.mul2(t,Qo),e.frustum.setFromMat4(Jn)}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest)}updateCpuSkinMatrices(e){qm++;const t=e.length;if(t!==0)for(let s=0;s<t;s++){const i=e[s].skinInstance;i&&(i.updateMatrices(e[s].node,qm),i._dirty=!0)}}updateGpuSkinMatrices(e){for(const t of e){const s=t.skinInstance;s&&s._dirty&&(s.updateMatrixPalette(t.node,qm),s._dirty=!1)}}updateMorphing(e){for(const t of e){const s=t.morphInstance;s&&s._dirty&&s.update()}}updateGSplats(e){for(const s of e){var t;(t=s.gsplatInstance)==null||t.update()}}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e)}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer)}setMorphing(e,t){if(t)if(t.morph.useTextureMorph)e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams);else{for(let s=0;s<t._activeVertexBuffers.length;s++){const i=t._activeVertexBuffers[s];if(i){const n=zy+(s+8);i.format.elements[0].name=n,i.format.elements[0].scopeId=e.scope.resolve(n),i.format.update(),e.setVertexBuffer(i)}}this.morphWeightsA.setValue(t._shaderMorphWeightsA),this.morphWeightsB.setValue(t._shaderMorphWeightsB)}}setSkinning(e,t){const s=t.skinInstance;if(s)if(this._skinDrawCalls++,e.supportsBoneTextures){const i=s.boneTexture;this.boneTextureId.setValue(i),this.boneTextureSizeId.setValue(s.boneTextureSize)}else this.poseMatrixId.setValue(s.matrixPalette)}dispatchViewPos(e){const t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){const t=[new rt("matrix_viewProjection",Ur),new rt("cubeMapRotationMatrix",vo),new rt("view_position",Qt),new rt("skyboxIntensity",Ps),new rt("exposure",Ps),new rt("textureBias",Ps)];e&&t.push(new rt("clusterCellsCountByBoundsSize",Qt),new rt("clusterTextureSize",Qt),new rt("clusterBoundsMin",Qt),new rt("clusterBoundsDelta",Qt),new rt("clusterCellsDot",Qt),new rt("clusterCellsMax",Qt),new rt("clusterCompressionLimit0",$i),new rt("shadowAtlasParams",$i),new rt("clusterMaxCells",zn),new rt("clusterSkip",Ps)),this.viewUniformFormat=new wh(this.device,t);const s=[new Eh(bo,jr|Jt)],i=[new Yi("lightsTextureFloat",Jt,Ft,Un),new Yi("lightsTexture8",Jt,Ft,Un),new Yi("shadowAtlasTexture",Jt,Ft,Nr),new Yi("cookieAtlasTexture",Jt,Ft,kn),new Yi("areaLightsLutTex1",Jt,Ft,kn),new Yi("areaLightsLutTex2",Jt,Ft,kn)];e&&i.push(new Yi("clusterWorldTexture",Jt,Ft,Un)),this.viewBindGroupFormat=new Ah(this.device,s,i)}}setupViewUniformBuffers(e,t,s,i){const n=this.device;for(;e.length<i;){const a=new Ed(n,t,!1),l=new Ch(n,s,a);e.push(l)}const r=e[0];r.defaultUniformBuffer.update(),r.update(),n.setBindGroup(xd,r)}setupMeshUniformBuffers(e,t){const s=this.device;if(s.supportsUniformBuffers){this.modelMatrixId.setValue(t.node.worldTransform.data),this.normalMatrixId.setValue(t.node.normalMatrix.data);const i=e.getBindGroup(s);i.defaultUniformBuffer.update(),i.update(),s.setBindGroup(So,i)}}drawInstance(e,t,s,i,n){const r=t.node.worldTransform;this.modelMatrixId.setValue(r.data),n&&this.normalMatrixId.setValue(t.node.normalMatrix.data);const a=t.instancingData;a?a.count>0&&(this._instancedDrawCalls++,e.setVertexBuffer(a.vertexBuffer),e.draw(s.primitive[i],a.count)):e.draw(s.primitive[i])}drawInstance2(e,t,s,i){const n=t.instancingData;n?n.count>0&&(this._instancedDrawCalls++,e.draw(s.primitive[i],n.count,!0)):e.draw(s.primitive[i],void 0,!0)}cull(e,t,s){const i=s.opaque;i.length=0;const n=s.transparent;n.length=0;const r=e.frustumCulling,a=t.length;for(let l=0;l<a;l++){const h=t[l];h.visible&&(!r||!h.cull||h._isVisible(e))&&(h.visibleThisFrame=!0,(h.transparent?n:i).push(h),(h.skinInstance||h.morphInstance||h.gsplatInstance)&&(this.processingMeshInstances.add(h),h.gsplatInstance&&h.gsplatInstance.cameras.push(e)))}}collectLights(e){this.lights.length=0,this.localLights.length=0;const t=this.scene._stats,s=e.layerList.length;for(let i=0;i<s;i++){const n=e.layerList[i];if(!Km.has(n)){Km.add(n);const r=n._lights;for(let a=0;a<r.length;a++){const l=r[a];Ym.has(l)||(Ym.add(l),this.lights.push(l),l._type!==ae&&this.localLights.push(l))}}}t.lights=this.lights.length,Ym.clear(),Km.clear()}cullLights(e,t){const s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits;for(let n=0;n<t.length;n++){const r=t[n];if(r.enabled)if(r._type!==ae)if(r.getBoundingSphere(jm),e.frustum.containsSphere(jm)){r.visibleThisFrame=!0,r.usePhysicalUnits=i;const a=e.getScreenSize(jm);r.maxScreenSize=Math.max(r.maxScreenSize,a)}else s||r.castShadows&&!r.shadowMap&&(r.visibleThisFrame=!0);else r.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(e){const t=this.scene.clusteredLightingEnabled;for(let n=0;n<this.localLights.length;n++){const r=this.localLights[n];r._type!==ae&&(t?r.atlasSlotUpdated&&r.shadowUpdateMode===Bs&&(r.shadowUpdateMode=Zn):r.shadowUpdateMode===Bs&&r.castShadows&&(r.getRenderData(null,0).shadowCamera.renderTarget||(r.shadowUpdateMode=Zn)),r.visibleThisFrame&&r.castShadows&&r.shadowUpdateMode!==Bs&&this._shadowRendererLocal.cull(r,e))}this.cameraDirShadowLights.clear();const s=e.cameras;for(let n=0;n<s.length;n++){const r=s[n];if(r.enabled){const a=r.camera;let l;const h=a.layers;for(let c=0;c<h.length;c++){const d=e.getLayerById(h[c]);if(d){const u=d.splitLights[ae];for(let f=0;f<u.length;f++){const p=u[f];if(p.castShadows&&!Jo.has(p)){var i;Jo.add(p),l=(i=l)!=null?i:[],l.push(p),this._shadowRendererDirectional.cull(p,e,a)}}}}l&&this.cameraDirShadowLights.set(a,l),Jo.clear()}}}cullComposition(e){this.processingMeshInstances.clear();const t=e.cameras.length;for(let i=0;i<t;i++){const n=e.cameras[i];let r,a=!0;this._camerasRendered++;const l=n.layers;for(let h=0;h<l.length;h++){const c=e.getLayerById(l[h]);if(c&&c.enabled){var s;const d=(s=n.renderTarget)!=null?s:c.renderTarget;(a||d!==r)&&(a=!1,r=d,n.frameUpdate(d),this.updateCameraFrustum(n.camera)),this.cullLights(n.camera,c._lights),c.onPreCull==null||c.onPreCull(e.camerasMap.get(n));const u=c.getCulledInstances(n.camera);this.cull(n.camera,c.meshInstances,u),c.onPostCull==null||c.onPostCull(e.camerasMap.get(n))}}}this.scene.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e)}updateShaders(e,t){const s=e.length;for(let i=0;i<s;i++){const n=e[i].material;if(n&&!Jo.has(n)&&(Jo.add(n),n.getShaderVariant!==pt.prototype.getShaderVariant)){if(t&&(!n.useLighting||n.emitter&&!n.emitter.lighting))continue;n.clearVariants()}}Jo.clear()}updateFrameUniforms(){this.blueNoiseTextureId.setValue(zF(this.device))}beginFrame(e){const t=this.scene,s=t.updateShaders,i=e.layerList,n=i.length;for(let l=0;l<n;l++){const c=i[l].meshInstances,d=c.length;for(let u=0;u<d;u++){const f=c[u];f.visibleThisFrame=!1,s&&Zm.push(f),f.skinInstance&&Qm.push(f)}}if(s){const l=!t.updateShaders;this.updateShaders(Zm,l),t.updateShaders=!1,t._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(Qm),Zm.length=0,Qm.length=0;const r=this.lights,a=r.length;for(let l=0;l<a;l++)r[l].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(e){const t=e.layerList.length;for(let n=0;n<t;n++)e.layerList[n]._postRenderCounter=0;const i=this.scene._shaderVersion;for(let n=0;n<t;n++){const r=e.layerList[n];r._shaderVersion=i,r._preRenderCalledForCameras=0,r._postRenderCalledForCameras=0,e.subLayerList[n]?r._postRenderCounter|=2:r._postRenderCounter|=1,r._postRenderCounterMax=r._postRenderCounter}e._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}}class Jx{constructor(){this.layer=null,this.transparent=!1,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}setupClears(e,t){this.clearColor=(e==null?void 0:e.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(e==null?void 0:e.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(e==null?void 0:e.clearStencilBuffer)||t.clearStencilBuffer}}class eS extends Ot{constructor(e,t,s,i){super(e),this.layerComposition=void 0,this.scene=void 0,this.renderer=void 0,this.renderActions=[],this.noDepthClear=!1,this.layerComposition=t,this.scene=s,this.renderer=i}addRenderAction(e){this.renderActions.push(e)}addLayer(e,t,s,i=!0){const n=new Jx;if(n.renderTarget=this.renderTarget,n.camera=e,n.layer=t,n.transparent=s,i){const r=this.renderActions.length===0;n.setupClears(r?e:void 0,t)}this.addRenderAction(n)}addLayers(e,t,s,i,n,r=!0){const{layerList:a,subLayerEnabled:l,subLayerList:h}=e;let c=i,d=s;for(;d<a.length;){const u=a[d],f=h[d],p=u.enabled&&l[d],_=t.camera.layersSet.has(u.id);if(p&&_&&(this.addLayer(t,u,f,c),c=!1),d++,u.id===n&&f===r)break}return d}updateDirectionalShadows(){const{renderer:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const r=t[s].camera.camera,a=this.renderer.cameraDirShadowLights.get(r);if(a)for(let l=0;l<a.length;l++){const h=a[l];if(e.dirLightShadows.get(h)!==r){e.dirLightShadows.set(h,r);const c=e._shadowRendererDirectional.getLightRenderPass(h,r);c&&this.beforePasses.push(c)}}}}updateClears(){const e=this.renderActions[0];if(e){const s=e.camera.camera,i=s.fullSizeClearRect;this.setClearColor(i&&e.clearColor?s.clearColor:void 0),this.setClearDepth(i&&e.clearDepth&&!this.noDepthClear?s.clearDepth:void 0),this.setClearStencil(i&&e.clearStencil?s.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){const{renderActions:e}=this;if(e.length){const t=e[0];t.camera.onPreRender&&t.firstCameraUse&&t.camera.onPreRender()}}execute(){const{layerComposition:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const i=t[s];e.isEnabled(i.layer,i.transparent)&&this.renderRenderAction(i,s===0)}}after(){const{renderActions:e}=this;if(e.length){const t=e[e.length-1];t.camera.onPostRender&&t.lastCameraUse&&t.camera.onPostRender()}this.beforePasses.length=0}renderRenderAction(e,t){const{renderer:s,layerComposition:i}=this,n=s.device,{layer:r,transparent:a,camera:l}=e,h=i.camerasMap.get(l);if(!a&&r.onPreRenderOpaque?r.onPreRenderOpaque(h):a&&r.onPreRenderTransparent&&r.onPreRenderTransparent(h),r._preRenderCalledForCameras&1<<h||(r.onPreRender&&r.onPreRender(h),r._preRenderCalledForCameras|=1<<h),l){var c,d;const u={lightClusters:e.lightClusters},f=(c=(d=l.camera.shaderPassInfo)==null?void 0:d.index)!=null?c:r.shaderPass;(!t||!l.camera.fullSizeClearRect)&&(u.clearColor=e.clearColor,u.clearDepth=e.clearDepth,u.clearStencil=e.clearStencil),s.renderForwardLayer(l.camera,e.renderTarget,r,a,f,e.viewBindGroups,u),n.setBlendState(Ee.NOBLEND),n.setStencilState(null,null),n.setAlphaToCoverage(!1)}!a&&r.onPostRenderOpaque?r.onPostRenderOpaque(h):a&&r.onPostRenderTransparent&&r.onPostRenderTransparent(h),r.onPostRender&&!(r._postRenderCalledForCameras&1<<h)&&(r._postRenderCounter&=~(a?2:1),r._postRenderCounter===0&&(r.onPostRender(h),r._postRenderCalledForCameras|=1<<h,r._postRenderCounter=r._postRenderCounterMax))}}class YF extends Ot{constructor(e,t,s){super(e),this.renderer=t,this.renderAction=s,this.requiresCubemaps=!1}execute(){this.renderAction.camera.onPostprocessing()}}const KF=[[],[],[]],aa={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};function ZF(o){const e=[];for(let t=0;t<o;++t){const s=Math.sqrt(t+.5)/Math.sqrt(o);e.push(s)}return e}function QF(o){const e=[];for(let t=0;t<o;t++){const s=t/o,i=Math.sqrt(1-s*s);e.push(i)}return e}class fu extends jF{constructor(e){super(e);const t=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;const s=t.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=ZF(16),this.pcssSphereSamples=QF(16)}destroy(){super.destroy()}dispatchGlobalLights(e){if(this.ambientColor[0]=e.ambientLight.r,this.ambientColor[1]=e.ambientLight.g,this.ambientColor[2]=e.ambientLight.b,e.gammaCorrection)for(let t=0;t<3;t++)this.ambientColor[t]=Math.pow(this.ambientColor[t],2.2);if(e.physicalUnits)for(let t=0;t<3;t++)this.ambientColor[t]*=e.ambientLuminance;this.ambientId.setValue(this.ambientColor),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data)}_resolveLight(e,t){const s="light"+t;this.lightColorId[t]=e.resolve(s+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(s+"_direction"),this.lightShadowMapId[t]=e.resolve(s+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(s+"_shadowParams"),this.lightShadowIntensity[t]=e.resolve(s+"_shadowIntensity"),this.lightShadowSearchAreaId[t]=e.resolve(s+"_shadowSearchArea"),this.lightRadiusId[t]=e.resolve(s+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(s+"_position"),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(s+"_halfWidth"),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(s+"_halfHeight"),this.lightInAngleId[t]=e.resolve(s+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(s+"_outerConeAngle"),this.lightCookieId[t]=e.resolve(s+"_cookie"),this.lightCookieIntId[t]=e.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(s+"_cookieOffset"),this.lightCameraParamsId[t]=e.resolve(s+"_cameraParams"),this.shadowMatrixPaletteId[t]=e.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[t]=e.resolve(s+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[t]=e.resolve(s+"_shadowCascadeCount")}setLTCDirectionalLight(e,t,s,i,n){this.lightPos[t][0]=i.x-s.x*n,this.lightPos[t][1]=i.y-s.y*n,this.lightPos[t][2]=i.z-s.z*n,this.lightPosId[t].setValue(this.lightPos[t]);const r=e.transformVector(new y(-.5,0,0));this.lightWidth[t][0]=r.x*n,this.lightWidth[t][1]=r.y*n,this.lightWidth[t][2]=r.z*n,this.lightWidthId[t].setValue(this.lightWidth[t]);const a=e.transformVector(new y(0,0,.5));this.lightHeight[t][0]=a.x*n,this.lightHeight[t][1]=a.y*n,this.lightHeight[t][2]=a.z*n,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchDirectLights(e,t,s,i){let n=0;const r=this.device.scope;for(let a=0;a<e.length;a++){if(!(e[a].mask&s))continue;const l=e[a],h=l._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(r,n),this.lightColorId[n].setValue(t.gammaCorrection?l._linearFinalColor:l._finalColor),h.getY(l._direction).mulScalar(-1),l._direction.normalize(),this.lightDir[n][0]=l._direction.x,this.lightDir[n][1]=l._direction.y,this.lightDir[n][2]=l._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),l.shape!==yt&&this.setLTCDirectionalLight(h,n,l._direction,i._node.getPosition(),i.farClip),l.castShadows){const c=l.getRenderData(i,0),d=l._getUniformBiasValues(c);this.lightShadowMapId[n].setValue(c.shadowBuffer),this.lightShadowMatrixId[n].setValue(c.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(l._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(l._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(l.numCascades),this.lightShadowIntensity[n].setValue(l.shadowIntensity);const u=50/c.projectionCompensation,f=l.penumbraSize/c.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[n].setValue(f*u);const p=l._shadowCameraParams;p.length=4,p[0]=c.depthRangeCompensation,p[1]=c.shadowCamera._farClip,p[2]=c.shadowCamera._nearClip,p[3]=1,this.lightCameraParamsId[n].setValue(p);const _=l._shadowRenderParams;_.length=4,_[0]=l._shadowResolution,_[1]=d.normalBias,_[2]=d.bias,_[3]=0,this.lightShadowParamsId[n].setValue(_)}n++}return n}setLTCPositionalLight(e,t){const s=e.transformVector(new y(-.5,0,0));this.lightWidth[t][0]=s.x,this.lightWidth[t][1]=s.y,this.lightWidth[t][2]=s.z,this.lightWidthId[t].setValue(this.lightWidth[t]);const i=e.transformVector(new y(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchOmniLight(e,t,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(t,i),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(e.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),s.shape!==yt&&this.setLTCPositionalLight(n,i),s.castShadows){const r=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(r.shadowBuffer);const a=s._getUniformBiasValues(r),l=s._shadowRenderParams;l.length=4,l[0]=s._shadowResolution,l[1]=a.normalBias,l[2]=a.bias,l[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(l),this.lightShadowIntensity[i].setValue(s.shadowIntensity);const h=s.penumbraSize/r.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[i].setValue(h);const c=s._shadowCameraParams;c.length=4,c[0]=r.depthRangeCompensation,c[1]=r.shadowCamera._farClip,c[2]=r.shadowCamera._nearClip,c[3]=0,this.lightCameraParamsId[i].setValue(c)}s._cookie&&(this.lightCookieId[i].setValue(s._cookie),this.lightShadowMatrixId[i].setValue(n.data),this.lightCookieIntId[i].setValue(s.cookieIntensity))}dispatchSpotLight(e,t,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(t,i),this.lightInAngleId[i].setValue(s._innerConeAngleCos),this.lightOutAngleId[i].setValue(s._outerConeAngleCos),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(e.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),s.shape!==yt&&this.setLTCPositionalLight(n,i),n.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[i][0]=s._direction.x,this.lightDir[i][1]=s._direction.y,this.lightDir[i][2]=s._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),s.castShadows){const r=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(r.shadowBuffer),this.lightShadowMatrixId[i].setValue(r.shadowMatrix.data);const a=s._getUniformBiasValues(r),l=s._shadowRenderParams;l.length=4,l[0]=s._shadowResolution,l[1]=a.normalBias,l[2]=a.bias,l[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(l),this.lightShadowIntensity[i].setValue(s.shadowIntensity);const h=s.penumbraSize/r.shadowCamera.renderTarget.width,c=r.shadowCamera._fov*Math.PI/180,d=1/Math.tan(c/2);this.lightShadowSearchAreaId[i].setValue(h*d);const u=s._shadowCameraParams;u.length=4,u[0]=r.depthRangeCompensation,u[1]=r.shadowCamera._farClip,u[2]=r.shadowCamera._nearClip,u[3]=0,this.lightCameraParamsId[i].setValue(u)}if(s._cookie){if(!s.castShadows){const r=pi.evalSpotCookieMatrix(s);this.lightShadowMatrixId[i].setValue(r.data)}this.lightCookieId[i].setValue(s._cookie),this.lightCookieIntId[i].setValue(s.cookieIntensity),s._cookieTransform&&(s._cookieTransformUniform[0]=s._cookieTransform.x,s._cookieTransformUniform[1]=s._cookieTransform.y,s._cookieTransformUniform[2]=s._cookieTransform.z,s._cookieTransformUniform[3]=s._cookieTransform.w,this.lightCookieMatrixId[i].setValue(s._cookieTransformUniform),s._cookieOffsetUniform[0]=s._cookieOffset.x,s._cookieOffsetUniform[1]=s._cookieOffset.y,this.lightCookieOffsetId[i].setValue(s._cookieOffsetUniform))}}dispatchLocalLights(e,t,s,i){let n=i;const r=this.device.scope,a=e[be],l=a.length;for(let d=0;d<l;d++){const u=a[d];u.mask&s&&(this.dispatchOmniLight(t,r,u,n),n++)}const h=e[Ie],c=h.length;for(let d=0;d<c;d++){const u=h[d];u.mask&s&&(this.dispatchSpotLight(t,r,u,n),n++)}}renderForwardPrepareMaterials(e,t,s,i,n){var r;const a=(m,g,x,S)=>{aa.drawCalls.push(m),aa.shaderInstances.push(g),aa.isNewMaterial.push(x),aa.lightMaskChanged.push(S)};aa.clear();const l=this.device,h=this.scene,c=h.clusteredLightingEnabled,d=(r=i==null?void 0:i.getLightHash(c))!=null?r:0;let u=null,f,p;const _=t.length;for(let m=0;m<_;m++){const g=t[m];g.ensureMaterial(l);const x=g.material,S=g._shaderDefs,v=g.mask;x&&x===u&&S!==f&&(u=null),x!==u&&(this._materialSwitches++,x._scene=h,x.dirty&&(x.updateUniforms(l,h),x.dirty=!1));const b=g.getShaderInstance(n,d,h,this.viewUniformFormat,this.viewBindGroupFormat,s);a(g,b,x!==u,!u||v!==p),u=x,f=S,p=v}return aa}renderForwardInternal(e,t,s,i,n,r){const a=this.device,l=this.scene,h=1<<i,c=r?-1:1,d=this.scene.clusteredLightingEnabled,u=t.drawCalls.length;for(let _=0;_<u;_++){var f,p;const m=t.drawCalls[_],g=t.isNewMaterial[_],x=t.lightMaskChanged[_],S=t.shaderInstances[_],v=m.material,b=m.mask;if(g){if(a.setShader(S.shader,!1),v.setParameters(a),x){const O=this.dispatchDirectLights(s[ae],l,b,e);d||this.dispatchLocalLights(s,l,b,O)}this.alphaTestId.setValue(v.alphaTest),a.setBlendState(v.blendState),a.setDepthState(v.depthState),a.setAlphaToCoverage(v.alphaToCoverage)}this.setupCullMode(e._cullFaces,c,m);const w=(f=m.stencilFront)!=null?f:v.stencilFront,T=(p=m.stencilBack)!=null?p:v.stencilBack;a.setStencilState(w,T);const E=m.mesh;m.setParameters(a,h),this.setVertexBuffers(a,E),this.setMorphing(a,m.morphInstance),this.setSkinning(a,m),this.setupMeshUniformBuffers(S,m);const C=m.renderStyle;if(a.setIndexBuffer(E.indexBuffer[C]),n==null||n(m,_),e.xr&&e.xr.session&&e.xr.views.list.length){const M=e.xr.views;for(let O=0;O<M.list.length;O++){const I=M.list[O];a.setViewport(I.viewport.x,I.viewport.y,I.viewport.z,I.viewport.w),this.projId.setValue(I.projMat.data),this.projSkyboxId.setValue(I.projMat.data),this.viewId.setValue(I.viewOffMat.data),this.viewInvId.setValue(I.viewInvOffMat.data),this.viewId3.setValue(I.viewMat3.data),this.viewProjId.setValue(I.projViewOffMat.data),this.viewPosId.setValue(I.positionData),this.viewIndexId.setValue(O),O===0?this.drawInstance(a,m,E,C,!0):this.drawInstance2(a,m,E,C),this._forwardDrawCalls++}}else this.drawInstance(a,m,E,C,!0),this._forwardDrawCalls++;_<u-1&&!t.isNewMaterial[_+1]&&v.setParameters(a,m.parameters)}}renderForward(e,t,s,i,n,r,a){const l=this.renderForwardPrepareMaterials(e,t,s,r,i);this.renderForwardInternal(e,l,s,i,n,a),aa.clear()}renderForwardLayer(e,t,s,i,n,r,a={}){var l,h,c;const{scene:d,device:u}=this,f=d.clusteredLightingEnabled;this.setupViewport(e,t);const p=(l=a.clearColors)!=null?l:!1,_=(h=a.clearDepth)!=null?h:!1,m=(c=a.clearStencil)!=null?c:!1;(p||_||m)&&this.clear(e,p,_,m);let g,x;if(s){s.sortVisible(e,i);const E=s.getCulledInstances(e);g=i?E.transparent:E.opaque,d.immediate.onPreRenderLayer(s,g,i),s.requiresLightCube&&(this.lightCube.update(d.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),x=s.splitLights}else{var S;g=a.meshInstances,x=(S=a.splitLights)!=null?S:KF}if(f){var v;((v=a.lightClusters)!=null?v:this.worldClustersAllocator.empty).activate(),s&&!this.clustersDebugRendered&&d.lighting.debugLayer===s.id&&(this.clustersDebugRendered=!0)}d._activeCamera=e;const b=this.setCameraUniforms(e,t);u.supportsUniformBuffers&&this.setupViewUniformBuffers(r,this.viewUniformFormat,this.viewBindGroupFormat,b);const w=!!(e._flipFaces^(t==null?void 0:t.flipY)),T=this._forwardDrawCalls;this.renderForward(e,g,x,n,s==null?void 0:s.onDrawCall,s,w),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-T)}setSceneConstants(){const e=this.scene;if(this.dispatchGlobalLights(e),e.fog!==Dh){if(this.fogColor[0]=e.fogColor.r,this.fogColor[1]=e.fogColor.g,this.fogColor[2]=e.fogColor.b,e.gammaCorrection)for(let s=0;s<3;s++)this.fogColor[s]=Math.pow(this.fogColor[s],2.2);this.fogColorId.setValue(this.fogColor),e.fog===N0?(this.fogStartId.setValue(e.fogStart),this.fogEndId.setValue(e.fogEnd)):this.fogDensityId.setValue(e.fogDensity)}const t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(e,t){const s=this.scene,i=this.device.isWebGL1;if(e.reset(),this.update(t),s.clusteredLightingEnabled){const{shadowsEnabled:h,cookiesEnabled:c}=s.lighting;this._renderPassUpdateClustered.update(e,h,c,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);let n=0,r=!0,a=null;const l=t._renderActions;for(let h=n;h<l.length;h++){const c=l[h],{layer:d,camera:u}=c;if(c.useCameraPasses)u.camera.renderPasses.forEach(f=>{e.addRenderPass(f)});else{const f=u.camera.renderPassDepthGrab;f&&i&&c.firstCameraUse&&(f.options.resizeSource=u.camera.renderTarget,f.update(this.scene),e.addRenderPass(f));const p=d.id===kt;if(i&&p&&!u.renderSceneColorMap)continue;const _=p&&(u.renderSceneColorMap||u.renderSceneDepthMap);r&&(r=!1,n=h,a=c.renderTarget);const m=l[h+1],x=(m?m.layer.id===kt:!1)&&(u.renderSceneColorMap||u.renderSceneDepthMap)&&!i,S=m?m.firstCameraUse&&this.cameraDirShadowLights.has(m.camera.camera):!1;if(!m||m.renderTarget!==a||S||x||_){if(p&&n===h||this.addMainRenderPass(e,t,a,n,h),p){if(u.renderSceneColorMap){const b=u.camera.renderPassColorGrab;b.source=u.renderTarget,e.addRenderPass(b)}u.renderSceneDepthMap&&!i&&e.addRenderPass(u.camera.renderPassDepthGrab)}if(c.triggerPostprocess&&u!=null&&u.onPostprocessing){const b=new YF(this.device,this,c);e.addRenderPass(b)}r=!0}}}}addMainRenderPass(e,t,s,i,n){const r=new eS(this.device,t,this.scene,this);r.init(s);const a=t._renderActions;for(let l=i;l<=n;l++)r.addRenderAction(a[l]);e.addRenderPass(r)}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances)}}function JF(o,e){return o.drawOrder-e.drawOrder}function eO(o,e){const t=o._key[Li],s=e._key[Li];return t===s&&o.mesh&&e.mesh?e.mesh.id-o.mesh.id:s-t}function tO(o,e){return e.zdist-o.zdist}function sO(o,e){return o.zdist-e.zdist}const iO=[null,JF,eO,tO,sO];let Jm=0;const ic=[],pu=new Set;class nO{constructor(){this.opaque=[],this.transparent=[]}}class ln{constructor(e={}){var t,s,i,n;this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,e.id!==void 0?(this.id=e.id,Jm=Math.max(this.id+1,Jm)):this.id=Jm++,this.name=e.name,this._enabled=(t=e.enabled)!=null?t:!0,this._refCounter=this._enabled?1:0,this.opaqueSortMode=(s=e.opaqueSortMode)!=null?s:ex,this.transparentSortMode=(i=e.transparentSortMode)!=null?i:um,e.renderTarget&&(this.renderTarget=e.renderTarget),this.shaderPass=(n=e.shaderPass)!=null?n:Wo,this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onPreCull=e.onPreCull,this.onPreRender=e.onPreRender,this.onPreRenderOpaque=e.onPreRenderOpaque,this.onPreRenderTransparent=e.onPreRenderTransparent,this.onPostCull=e.onPostCull,this.onPostRender=e.onPostRender,this.onPostRenderOpaque=e.onPostRenderOpaque,this.onPostRenderTransparent=e.onPostRenderTransparent,this.onDrawCall=e.onDrawCall,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=e.layerReference,this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}set enabled(e){e!==this._enabled&&(this._dirtyComposition=!0,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){this._refCounter===0&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(this._refCounter===1)this._enabled=!1,this.onDisable&&this.onDisable();else if(this._refCounter===0)return;this._refCounter--}addMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let n=0;n<e.length;n++){const r=e[n];i.has(r)||(s.push(r),i.add(r),pu.add(r.material))}if(t||this.addShadowCasters(e),pu.size>0){const n=this._shaderVersion;pu.forEach(r=>{n>=0&&r._shaderVersion!==n&&(r.getShaderVariant!==pt.prototype.getShaderVariant&&r.clearVariants(),r._shaderVersion=n)}),pu.clear()}}removeMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let n=0;n<e.length;n++){const r=e[n];if(i.has(r)){i.delete(r);const a=s.indexOf(r);a>=0&&s.splice(a,1)}}t||this.removeShadowCasters(e)}addShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const n=e[i];n.castShadow&&!s.has(n)&&(s.add(n),t.push(n))}}removeShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const n=e[i];if(s.has(n)){s.delete(n);const r=t.indexOf(n);r>=0&&t.splice(r,1)}}}clearMeshInstances(e=!1){this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}addLight(e){const t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),t.type!==ae&&this._clusteredLightsSet.add(t)}removeLight(e){const t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),t.type!==ae&&this._clusteredLightsSet.delete(t)}clearLights(){this._lightsSet.forEach(e=>e.removeLayer(this)),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;const e=this._splitLights;for(let s=0;s<e.length;s++)e[s].length=0;const t=this._lights;for(let s=0;s<t.length;s++){const i=t[s];i.enabled&&e[i._type].push(i)}for(let s=0;s<e.length;s++)e[s].sort((i,n)=>i.key-n.key)}return this._splitLights}evaluateLightHash(e,t,s){let i=0;const n=this._lights;for(let r=0;r<n.length;r++){const a=n[r].type!==ae;(e&&a||t&&!a)&&ic.push(s?n[r].id:n[r].key)}return ic.length>0&&(ic.sort(),i=Rv(ic),ic.length=0),i}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!e,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=!0)}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);const t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(e,t,s,i){for(let n=0;n<t;n++){const r=e[n];if(r.layer<=U0)continue;if(r.calculateSortDistance){r.zdist=r.calculateSortDistance(r,s,i);continue}const a=r.aabb.center,l=a.x-s.x,h=a.y-s.y,c=a.z-s.z;r.zdist=l*i.x+h*i.y+c*i.z}}getCulledInstances(e){let t=this._visibleInstances.get(e);return t||(t=new nO,this._visibleInstances.set(e,t)),t}sortVisible(e,t){const s=t?this.transparentSortMode:this.opaqueSortMode;if(s===Gh)return;const i=this.getCulledInstances(e),n=t?i.transparent:i.opaque,r=e.node;if(s===sx){const a=r.getPosition(),l=r.forward;this.customCalculateSortValues&&this.customCalculateSortValues(n,n.length,a,l),this.customSortCallback&&n.sort(this.customSortCallback)}else{if(s===um||s===tx){const a=r.getPosition(),l=r.forward;this._calculateSortDistances(n,n.length,a,l)}n.sort(iO[s])}}}const rO=(o,e)=>o.priority-e.priority,nc=o=>o.sort(rO);class mu extends Q{constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this.camerasMap=new Map,this._renderActions=[],this._dirty=!1,this.name=e,this._opaqueOrder={},this._transparentOrder={}}destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach(e=>e.destroy()),this._renderActions.length=0}_update(){const e=this.layerList.length;if(!this._dirty){for(let t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=!0;break}}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(let s=0;s<e;s++){const i=this.layerList[s];i._dirtyComposition=!1;for(let n=0;n<i.cameras.length;n++){const r=i.cameras[n];this.cameras.indexOf(r)<0&&this.cameras.push(r)}}this.cameras.length>1&&nc(this.cameras),this.camerasMap.clear();for(let s=0;s<this.cameras.length;s++)this.camerasMap.set(this.cameras[s],s);let t=0;this.destroyRenderActions();for(let s=0;s<this.cameras.length;s++){const i=this.cameras[s];if(i.camera.renderPasses.length>0){this.addDummyRenderAction(t,i),t++;continue}let n=!0;const r=t;let a=null,l=!1;for(let h=0;h<e;h++){const c=this.layerList[h];if(c.enabled&&this.subLayerEnabled[h]&&c.cameras.length>0&&i.layers.indexOf(c.id)>=0){!l&&c.id===i.disablePostEffectsLayer&&(l=!0,a&&(a.triggerPostprocess=!0));const u=this.subLayerList[h];a=this.addRenderAction(t,c,u,i,n,l),t++,n=!1}}r<t&&(a.lastCameraUse=!0),!l&&a&&(a.triggerPostprocess=!0),i.renderTarget&&i.postEffectsEnabled&&this.propagateRenderTarget(r-1,i)}this._logRenderActions()}}getNextRenderAction(e){const t=new Jx;return this._renderActions.push(t),t}addDummyRenderAction(e,t){const s=this.getNextRenderAction(e);s.camera=t,s.useCameraPasses=!0}addRenderAction(e,t,s,i,n,r){let a=t.renderTarget;i&&i.renderTarget&&t.id!==kt&&(a=i.renderTarget);let l=!1;const h=this._renderActions;for(let f=e-1;f>=0;f--)if(h[f].camera===i&&h[f].renderTarget===a){l=!0;break}r&&i.postEffectsEnabled&&(a=null);const c=this.getNextRenderAction(e);c.triggerPostprocess=!1,c.layer=t,c.transparent=s,c.camera=i,c.renderTarget=a,c.firstCameraUse=n,c.lastCameraUse=!1;const d=n||!l,u=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return(d||u)&&c.setupClears(d?i:void 0,t),c}propagateRenderTarget(e,t){for(let s=e;s>=0;s--){const i=this._renderActions[s],n=i.layer;if(i.renderTarget&&n.id!==kt)break;if(n.id===kt)continue;if(i.useCameraPasses)break;const r=i==null?void 0:i.camera.camera;if(r&&(!t.camera.rect.equals(r.rect)||!t.camera.scissorRect.equals(r.scissorRect)))break;i.renderTarget=t.renderTarget}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)!==void 0}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insert(e,t){if(this._isLayerAdded(e))return;this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(t,s-1),this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}remove(e){let t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this.fire("remove",e);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps()}pushOpaque(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertOpaque(e,t){if(this._isSublayerAdded(e,!1))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeOpaque(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}pushTransparent(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertTransparent(e,t){if(this._isSublayerAdded(e,!0))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeTransparent(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}getOpaqueIndex(e){var t;return(t=this.layerOpaqueIndexMap.get(e))!=null?t:-1}getTransparentIndex(e){var t;return(t=this.layerTransparentIndexMap.get(e))!=null?t:-1}isEnabled(e,t){const s=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);return this.subLayerEnabled[s]}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let e=0;e<this.layerList.length;e++){const t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t),(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e)}}getLayerById(e){var t;return(t=this.layerIdMap.get(e))!=null?t:null}getLayerByName(e){var t;return(t=this.layerNameMap.get(e))!=null?t:null}_updateOpaqueOrder(e,t){for(let s=e;s<=t;s++)this.subLayerList[s]===!1&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(e,t){for(let s=e;s<=t;s++)this.subLayerList[s]===!0&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(e,t,s){let i=-1,n=-1;for(let r=0,a=e.length;r<a;r++){const l=e[r];s.hasOwnProperty(l)&&(i=Math.max(i,s[l]))}for(let r=0,a=t.length;r<a;r++){const l=t[r];s.hasOwnProperty(l)&&(n=Math.max(n,s[l]))}return i===-1&&n!==-1?1:n===-1&&i!==-1?-1:n-i}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}}const _u=new y,mi={bias:0,normalBias:0},e_={r:0,g:1,b:2,a:3},t_={directional:ae,omni:be,point:be,spot:Ie},aO=[[new X(0,0,1,1)],[new X(0,0,.5,.5),new X(0,.5,.5,.5)],[new X(0,0,.5,.5),new X(0,.5,.5,.5),new X(.5,0,.5,.5)],[new X(0,0,.5,.5),new X(0,.5,.5,.5),new X(.5,0,.5,.5),new X(.5,.5,.5,.5)]];let oO=0;class lO{constructor(e,t,s,i){this.light=i,this.camera=t,this.shadowCamera=du.createShadowCamera(e,i._shadowType,i._type,s),this.shadowMatrix=new W,this.shadowViewport=new X(0,0,1,1),this.shadowScissor=new X(0,0,1,1),this.depthRangeCompensation=0,this.projectionCompensation=0,this.face=s,this.visibleCasters=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}get shadowBuffer(){const e=this.shadowCamera.renderTarget;if(e){const t=this.light;return t._type===be?e.colorBuffer:t._isPcf&&t.device.supportsDepthShadow?e.depthBuffer:e.colorBuffer}return null}}class el{constructor(e,t){this.layers=new Set,this.clusteredLighting=void 0,this.shadowDepthState=ft.DEFAULT.clone(),this.device=e,this.clusteredLighting=t,this.id=oO++,this._type=ae,this._color=new H(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=ns,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=Ud,this._shadowType=at,this._vsmBlurSize=11,this.vsmBlurMode=zd,this.vsmBias=.01*.25,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=yt,this._finalColor=new Float32Array([.8,.8,.8]);const s=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([s,s,s]),this._position=new y(0,0,0),this._direction=new y(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this.shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=$d,this.shadowUpdateOverrides=null,this._penumbraSize=1,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}destroy(){this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}releaseRenderData(){if(this._renderData){for(let e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0}}addLayer(e){this.layers.add(e)}removeLayer(e){this.layers.delete(e)}set shadowBias(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias())}get shadowBias(){return this._shadowBias}set numCascades(e){(!this.cascades||this.numCascades!==e)&&(this.cascades=aO[e-1],this._shadowMatrixPalette=new Float32Array(4*16),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e)}get shadowMap(){return this._shadowMap}set mask(e){this._mask!==e&&(this._mask=e,this.updateKey())}get mask(){return this._mask}get numShadowFaces(){const e=this._type;return e===ae?this.numCascades:e===be?6:1}set type(e){if(this._type===e)return;this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey();const t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t}get type(){return this._type}set shape(e){if(this._shape===e)return;this._shape=e,this._destroyShadowMap(),this.updateKey();const t=this._shadowType;this._shadowType=null,this.shadowType=t}get shape(){return this._shape}set usePhysicalUnits(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateFinalColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(e){if(this._shadowType===e)return;const t=this.device;this._type===be&&e!==at&&e!==At&&(e=at);const s=t.supportsDepthShadow;e===Fs&&!s&&(e=at),e===ps&&(!t.textureFloatRenderable||!t.textureFloatFilterable)&&(e=Ls),e===Ls&&!t.textureHalfFloatRenderable&&(e=fs),this._isVsm=e>=fs&&e<=ps,this._isPcf=e===ai||e===at||e===Fs,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty())}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&this._mask!==ci&&this._mask!==0}set shadowResolution(e){this._shadowResolution!==e&&(this._type===be?e=Math.min(e,this.device.maxCubeMapSize):e=Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2===0&&e++,this._vsmBlurSize=e)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){this._normalOffsetBias!==e&&((!this._normalOffsetBias&&e||this._normalOffsetBias&&!e)&&this.updateKey(),this._normalOffsetBias=e)}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180),this._usePhysicalUnits&&this._updateFinalColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateFinalColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(e){this._penumbraSize=e}get penumbraSize(){return this._penumbraSize}_updateOuterAngle(e){const t=e*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t)}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateFinalColor())}get intensity(){return this._intensity}set affectSpecularity(e){this._type===ae&&(this._affectSpecularity=e,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateFinalColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new W),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new X(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3){const t=e.charAt(e.length-1),s=3-e.length;for(let i=0;i<s;i++)e+=t}this._cookieChannel=e,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new G,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){if(this._cookieOffset===e)return;!!(this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new X(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=this._type===ae&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),this.shadowUpdateMode===Bs&&(this.shadowUpdateMode=Zn),this.shadowUpdateOverrides)for(let e=0;e<this.shadowUpdateOverrides.length;e++)this.shadowUpdateOverrides[e]===Bs&&(this.shadowUpdateOverrides[e]=Zn)}getRenderData(e,t){for(let i=0;i<this._renderData.length;i++){const n=this._renderData[i];if(n.camera===e&&n.face===t)return n}const s=new lO(this.device,e,t,this);return this._renderData.push(s),s}clone(){const e=new el(this.device,this.clusteredLighting);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.affectSpecularity=this._affectSpecularity,e.luminance=this._luminance,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.penumbraSize=this.penumbraSize,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,this.shadowUpdateOverrides&&(e.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.shape=this._shape,e.shadowDepthState.copy(this.shadowDepthState),e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e}static getLightUnitConversion(e,t=Math.PI/4,s=0){switch(e){case Ie:{const i=Math.cos(t),n=Math.cos(s);return 2*Math.PI*(1-n+(n-i)/2)}case be:return 4*Math.PI;case ae:return 1}}_getUniformBiasValues(e){const t=e.shadowCamera._farClip;switch(this._type){case be:mi.bias=this.shadowBias,mi.normalBias=this._normalOffsetBias;break;case Ie:this._isVsm?mi.bias=-1e-5*20:(mi.bias=this.shadowBias*20,this.device.isWebGL1&&this.device.extStandardDerivatives&&(mi.bias*=-100)),mi.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case ae:this._isVsm?mi.bias=-1e-5*20:(mi.bias=this.shadowBias/t*100,this.device.isWebGL1&&this.device.extStandardDerivatives&&(mi.bias*=-100)),mi.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias;break}return mi}getColor(){return this._color}getBoundingSphere(e){if(this._type===Ie){const t=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,n=this._node;_u.copy(n.up),s>45?(e.radius=t*this._outerConeAngleSin,_u.mulScalar(-t*i)):(e.radius=t/(2*i),_u.mulScalar(-e.radius)),e.center.add2(n.getPosition(),_u)}else this._type===be&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)}getBoundingBox(e){if(this._type===Ie){const t=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*U.DEG_TO_RAD)*t);e.center.set(0,-t*.5,0),e.halfExtents.set(n,t*.5,n),e.setFromTransformedAabb(e,i.getWorldTransform(),!0)}else this._type===be&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateShadowBias(){const e=this.device;if(e.isWebGL2||e.isWebGPU)if(this._type===be&&!this.clusteredLighting)this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0;else{const t=this.shadowBias*-1e3;this.shadowDepthState.depthBias=t,this.shadowDepthState.depthBiasSlope=t}}_updateFinalColor(){const e=this._color,t=e.r,s=e.g,i=e.b;let n=this._intensity;this._usePhysicalUnits&&(n=this._luminance/el.getLightUnitConversion(this._type,this._outerConeAngle*U.DEG_TO_RAD,this._innerConeAngle*U.DEG_TO_RAD));const r=this._finalColor,a=this._linearFinalColor;r[0]=t*n,r[1]=s*n,r[2]=i*n,n>=1?(a[0]=Math.pow(t,2.2)*n,a[1]=Math.pow(s,2.2)*n,a[2]=Math.pow(i,2.2)*n):(a[0]=Math.pow(r[0],2.2),a[1]=Math.pow(r[1],2.2),a[2]=Math.pow(r[2],2.2))}setColor(){arguments.length===1?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):arguments.length===3&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateFinalColor()}layersDirty(){this.layers.forEach(e=>{e.markLightsDirty()})}updateKey(){let e=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(this._normalOffsetBias!==0?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|e_[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8|(this.affectSpecularity?1:0)<<7|this.mask<<6;this._cookieChannel.length===3&&(e|=e_[this._cookieChannel.charAt(1)]<<16,e|=e_[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e}}class s_{constructor(e,t,s){this._areaLightsEnabled=!1,this._cells=new y(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=at,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.debugLayer=void 0,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=s}applySettings(e){var t,s,i,n,r,a,l;this.shadowsEnabled=(t=e.lightingShadowsEnabled)!=null?t:this.shadowsEnabled,this.cookiesEnabled=(s=e.lightingCookiesEnabled)!=null?s:this.cookiesEnabled,this.areaLightsEnabled=(i=e.lightingAreaLightsEnabled)!=null?i:this.areaLightsEnabled,this.shadowAtlasResolution=(n=e.lightingShadowAtlasResolution)!=null?n:this.shadowAtlasResolution,this.cookieAtlasResolution=(r=e.lightingCookieAtlasResolution)!=null?r:this.cookieAtlasResolution,this.maxLightsPerCell=(a=e.lightingMaxLightsPerCell)!=null?a:this.maxLightsPerCell,this.shadowType=(l=e.lightingShadowType)!=null?l:this.shadowType,e.lightingCells&&(this.cell=new y(e.lightingCells))}set cells(e){this._cells.copy(e)}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=U.clamp(e,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=U.clamp(e,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=U.clamp(e,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const hO=`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
	}
	`,cO=new Ee(!0,hs,ut,ut);class tr{constructor(e){this.morph=e,e.incRefCount(),this.device=e.device,this._weights=[],this._weightMap=new Map;for(let t=0;t<e._targets.length;t++){const s=e._targets[t];s.name&&this._weightMap.set(s.name,t),this.setWeight(t,s.defaultWeight)}if(this._activeTargets=[],e.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const t=(s,i)=>(this[i]=e._createTexture(s,e._renderTextureFormat),new qe({colorBuffer:this[i],depth:!1}));e.morphPositions&&(this.rtPositions=t("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=t("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight,1/e.morphTextureWidth,1/e.morphTextureHeight]);for(let s=0;s<this.maxSubmitCount;s++)this["morphBlendTex"+s]=this.device.scope.resolve("morphBlendTex"+s);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,4*4,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}destroy(){this.shader=null;const e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new tr(this.morph)}_getWeightIndex(e){return typeof e=="string"?this._weightMap.get(e):e}getWeight(e){const t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){const s=this._getWeightIndex(e);this._weights[s]=t,this._dirty=!0}_getFragmentShader(e){let t="";e>0&&(t+=`varying vec2 uv0;
uniform highp float morphFactor[`+e+`];
`);for(let s=0;s<e;s++)t+="uniform highp sampler2D morphBlendTex"+s+`;
`;t+=`void main (void) {
    highp vec4 color = vec4(0, 0, 0, 1);
`;for(let s=0;s<e;s++)t+="    color.xyz += morphFactor["+s+"] * texture2D(morphBlendTex"+s+`, uv0).xyz;
`;return t+=`    gl_FragColor = color;
}
`,t}_getShader(e){let t=this.shaderCache[e];if(!t){const s=this._getFragmentShader(e);t=zt(this.device,hO,s,"textureMorph"+e),this.shaderCache[e]=t}return t}_updateTextureRenderTarget(e,t){const s=this.device,i=(l,h)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlendState(h?cO:Ee.NOBLEND);const c=this._getShader(l);_s(s,e,c)};let n=0,r=!1;const a=this._activeTargets.length;for(let l=0;l<a;l++){const h=this._activeTargets[l],c=h.target[t];c&&(this["morphBlendTex"+n].setValue(c),this._shaderMorphWeights[n]=h.weight,n++,n>=this.maxSubmitCount&&(i(n,r),n=0,r=!0))}(n>0||a===0&&!this.zeroTextures)&&i(n,r)}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=this._activeTargets.length===0)}_updateVertexMorph(){const e=this.maxSubmitCount;for(let i=0;i<e;i++)this._shaderMorphWeights[i]=0,this._activeVertexBuffers[i]=null;let t=0,s=this.morph.morphPositions?4:0;for(let i=0;i<this._activeTargets.length;i++){const n=this._activeTargets[i].target;n._vertexBufferPositions&&(this._activeVertexBuffers[t]=n._vertexBufferPositions,this._shaderMorphWeights[t]=this._activeTargets[i].weight,t++),n._vertexBufferNormals&&(this._activeVertexBuffers[s]=n._vertexBufferNormals,this._shaderMorphWeights[s]=this._activeTargets[i].weight,s++)}}update(){this._dirty=!1;const e=this.morph._targets;let t=0;const s=1e-5;for(let n=0;n<e.length;n++){const r=Math.abs(this.getWeight(n));if(r>s){this._activeTargets.length<=t&&(this._activeTargets[t]={});const a=this._activeTargets[t++];a.absWeight=r,a.weight=this.getWeight(n),a.target=e[n]}}this._activeTargets.length=t;const i=this.morph.maxActiveTargets;this._activeTargets.length>i&&(this._activeTargets.sort(function(n,r){return n.absWeight<r.absWeight?1:r.absWeight<n.absWeight?-1:0}),this._activeTargets.length=i),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}}class _i{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(e){this.graph=e}getCameras(){return this.cameras}setCameras(e){this.cameras=e}getLights(){return this.lights}setLights(e){this.lights=e}getMaterials(){const e=[];for(let t=0;t<this.meshInstances.length;t++){const s=this.meshInstances[t];e.indexOf(s.material)===-1&&e.push(s.material)}return e}clone(){const e=[],t=[],i=function h(c){const d=c.clone();e.push(c),t.push(d);for(let u=0;u<c._children.length;u++)d.addChild(h(c._children[u]));return d}(this.graph),n=[],r=[],a=[];for(let h=0;h<this.skinInstances.length;h++){const c=this.skinInstances[h].skin,d=new ta(c),u=[];for(let f=0;f<c.boneNames.length;f++){const p=c.boneNames[f],_=i.findByName(p);u.push(_)}d.bones=u,r.push(d)}for(let h=0;h<this.morphInstances.length;h++){const c=this.morphInstances[h].morph,d=new tr(c);a.push(d)}for(let h=0;h<this.meshInstances.length;h++){const c=this.meshInstances[h],d=e.indexOf(c.node),u=new Te(c.mesh,c.material,t[d]);if(c.skinInstance){const f=this.skinInstances.indexOf(c.skinInstance);u.skinInstance=r[f]}if(c.morphInstance){const f=this.morphInstances.indexOf(c.morphInstance);u.morphInstance=a[f]}n.push(u)}const l=new _i;return l.graph=i,l.meshInstances=n,l.skinInstances=r,l.morphInstances=a,l.getGraph().syncHierarchy(),l}destroy(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0}generateWireframe(){Te._prepareRenderStyleForArray(this.meshInstances,Kn)}}class gu extends pm{constructor(e,t,{preferHighPrecision:s=!1}={}){super(),this._aabb=void 0,this.preferHighPrecision=void 0,this.device=t,this.preferHighPrecision=s,this._targets=e.slice();const i=this.device;if(i.supportsMorphTargetTexturesCore){const n=i.extTextureHalfFloat&&i.textureHalfFloatRenderable?et:void 0,r=i.extTextureFloat&&i.textureFloatRenderable?Ge:void 0;this._renderTextureFormat=this.preferHighPrecision?r??n:n??r;const a=i.extTextureHalfFloat&&i.textureHalfFloatUpdatable?et:void 0,l=i.extTextureFloat?Pr:void 0;this._textureFormat=this.preferHighPrecision?l??a:a??l,this._renderTextureFormat!==void 0&&this._textureFormat!==void 0&&(this._useTextureMorph=!0)}this._init(),this._updateMorphFlags()}get aabb(){if(!this._aabb){const e=new y,t=new y;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;e.min(i.getMin()),t.max(i.getMax())}this._aabb=new ye,this._aabb.setMinMax(e,t)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let e=0;e<this._targets.length;e++)this._targets[e]._initVertexBuffers(this.device);for(let e=0;e<this._targets.length;e++)this._targets[e]._postInit()}_findSparseSet(e,t,s,i){let n=1;const r=e[0].length;for(let a=0;a<r;a+=3){let l=!1;for(let h=0;h<e.length;h++){const c=e[h];if(c[a]!==0||c[a+1]!==0||c[a+2]!==0){l=!0;break}}l?(t.push(n+i),s.push(a/3),n++):t.push(0+i)}return n}_initTextureBased(){const e=this.device.isWebGPU,t=e?0:.2,s=[],i=[];for(let m=0;m<this._targets.length;m++){const g=this._targets[m];g.options.deltaPositions&&(s.push(g.options.deltaPositions),i.push({target:g,name:"texturePositions"})),g.options.deltaNormals&&(s.push(g.options.deltaNormals),i.push({target:g,name:"textureNormals"}))}const n=[],r=[],a=this._findSparseSet(s,n,r,t),l=Math.min(this.device.maxTextureSize,4096);let h=Math.ceil(Math.sqrt(a));h=Math.min(h,l);const c=Math.ceil(a/h);if(c>l)return!1;this.morphTextureWidth=h,this.morphTextureHeight=c;let d=!1,u=3;const f=Fe.float2Half;this._textureFormat===et&&(d=!0,u=4);const p=[];for(let m=0;m<s.length;m++)p.push(this._createTexture("MorphTarget",this._textureFormat));for(let m=0;m<s.length;m++){const g=s[m],x=p[m],S=x.lock();if(d)for(let b=0;b<r.length;b++){const w=r[b]*3,T=b*u+u;S[T]=f(g[w]),S[T+1]=f(g[w+1]),S[T+2]=f(g[w+2])}else for(let b=0;b<r.length;b++){const w=r[b]*3,T=b*u+u;S[T]=g[w],S[T+1]=g[w+1],S[T+2]=g[w+2]}x.unlock(),i[m].target._setTexture(i[m].name,x)}const _=[{semantic:Nn,components:1,type:e?tt:le}];return this.vertexBufferIds=new es(this.device,new Tt(this.device,_,n.length),n.length,St,e?new Uint32Array(n):new Float32Array(n)),!0}destroy(){var e;(e=this.vertexBufferIds)==null||e.destroy(),this.vertexBufferIds=null;for(let t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let e=0;e<this._targets.length;e++){const t=this._targets[e];t.morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)}}_createTexture(e,t){return new re(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:de,magFilter:de,addressU:q,addressV:q,name:e})}}class rc{constructor(e){this.used=!1,arguments.length===2&&(e=arguments[1]),this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions}destroy(){var e,t,s,i;(e=this._vertexBufferPositions)==null||e.destroy(),this._vertexBufferPositions=null,(t=this._vertexBufferNormals)==null||t.destroy(),this._vertexBufferNormals=null,(s=this.texturePositions)==null||s.destroy(),this.texturePositions=null,(i=this.textureNormals)==null||i.destroy(),this.textureNormals=null}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new ye,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}get morphPositions(){return!!this._vertexBufferPositions||!!this.texturePositions}get morphNormals(){return!!this._vertexBufferNormals||!!this.textureNormals}clone(){return new rc(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}_initVertexBuffers(e){const t=this.options;this._vertexBufferPositions=this._createVertexBuffer(e,t.deltaPositions,t.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(e,t.deltaNormals,t.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())}_createVertexBuffer(e,t,s=le){if(t){const i=[{semantic:oo,components:3,type:s}];return new es(e,new Tt(e,i),t.length/3,St,t)}return null}_setTexture(e,t){this[e]=t}}class dO extends me{generateKey(e){let t="particle";for(const s in e)e.hasOwnProperty(s)&&(t+=e[s]);return t}_animTex(e){let t="";return t+=e.animTexLoop?z.particleAnimFrameLoopVS:z.particleAnimFrameClampVS,t+=z.particleAnimTexVS,t}createShaderDefinition(e,t){const s=`#define PARTICLE_${t.useCpu?"CPU":"GPU"}
`;let i=`#define PARTICLE
`+s,n=`#define VERTEXSHADER
`+s;t.mesh&&(n+=`#define USE_MESH
`),t.localSpace&&(n+=`#define LOCAL_SPACE
`),t.screenSpace&&(n+=`#define SCREEN_SPACE
`),t.animTex&&(n+=`
uniform vec2 animTexTilesParams;
`),t.animTex&&(n+=`
uniform vec4 animTexParams;
`),t.animTex&&(n+=`
uniform vec2 animTexIndexParams;
`),t.normal===2&&(n+=`
varying mat3 ParticleMat;
`),t.normal===1&&(n+=`
varying vec3 Normal;
`),t.soft&&(n+=`
varying float vDepth;
`);const r=t.customFace?z.particle_customFaceVS:z.particle_billboardVS;return t.useCpu?(t.soft>0&&(n+=z.screenDepthPS),n+=z.particle_cpuVS,t.localSpace&&(n+=z.particle_localShiftVS),t.animTex&&(n+=this._animTex(t)),t.alignToMotion&&(n+=z.particle_pointAlongVS),n+=t.mesh?z.particle_meshVS:r,t.normal===1&&(n+=z.particle_normalVS),t.normal===2&&(n+=z.particle_TBNVS),t.stretch>0&&(n+=z.particle_stretchVS),n+=z.particle_cpu_endVS,t.soft>0&&(n+=z.particle_softVS)):(n+=z.particle_initVS,n+=t.pack8?z.particleInputRgba8PS:z.particleInputFloatPS,t.soft>0&&(n+=z.screenDepthPS),n+=z.particleVS,t.localSpace&&(n+=z.particle_localShiftVS),t.animTex&&(n+=this._animTex(t)),t.wrap&&(n+=z.particle_wrapVS),t.alignToMotion&&(n+=z.particle_pointAlongVS),n+=t.mesh?z.particle_meshVS:r,t.normal===1&&(n+=z.particle_normalVS),t.normal===2&&(n+=z.particle_TBNVS),t.stretch>0&&(n+=z.particle_stretchVS),n+=z.particle_endVS,t.soft>0&&(n+=z.particle_softVS)),n+=`}
`,t.normal>0&&(t.normal===1?i+=`
varying vec3 Normal;
`:t.normal===2&&(i+=`
varying mat3 ParticleMat;
`),i+=`
uniform vec3 lightCube[6];
`),t.soft&&(i+=`
varying float vDepth;
`),t.normal===0&&t.fog==="none"&&(t.srgb=!1),i+=z.decodePS,i+=me.gammaCode(t.gamma),i+=me.tonemapCode(t.toneMap),t.fog==="linear"?i+=z.fogLinearPS:t.fog==="exp"?i+=z.fogExpPS:t.fog==="exp2"?i+=z.fogExp2PS:i+=z.fogNonePS,t.normal===2&&(i+=`
uniform sampler2D normalMap;
`),t.soft>0&&(i+=z.screenDepthPS),i+=z.particlePS,t.soft>0&&(i+=z.particle_softPS),t.normal===1&&(i+=`
vec3 normal = Normal;
`),t.normal===2&&(i+=z.particle_normalMapPS),t.normal>0&&(i+=t.halflambert?z.particle_halflambertPS:z.particle_lambertPS),t.normal>0&&(i+=z.particle_lightingPS),t.blend===Bt?i+=z.particle_blendNormalPS:t.blend===Od?i+=z.particle_blendAddPS:t.blend===Bd&&(i+=z.particle_blendMultiplyPS),i+=z.particle_endPS,je.createDefinition(e,{name:"ParticleShader",vertexCode:n,fragmentCode:i})}}const uO=new dO;let hn,tS=1;const J=4,i_=new W,n_=new W,Ni=new y,Xe=new y,gi=new y,tl=new y,xs=new y,lt=new y,sl=new y,il=new y,ac=new y,sS=new y,Mt=new y,yu=new y,oa=new y;function nl(o){return o-Math.floor(o)}function fO(o){return Math.max(Math.min(o,1),0)}function r_(o,e){return o-e*Math.floor(o/e)}function pO(o){let e=nl(o),t=nl(255*o),s=nl(65025*o),i=nl(160581375*o);return e-=t/255,t-=s/255,s-=i/255,i-=i/255,[e,t,s,i]}function vu(o){let e=nl(o),t=nl(255*o);return e-=t/255,t-=t/255,[e,t]}class mO{constructor(e){this._emitter=e}calcSpawnPosition(e,t,s,i,n){const r=this._emitter,a=Math.random(),l=Math.random(),h=Math.random(),c=Math.random();if(r.useCpu&&(e[n*J+0+r.numParticlesPot*2*J]=a,e[n*J+1+r.numParticlesPot*2*J]=l,e[n*J+2+r.numParticlesPot*2*J]=h),Xe.x=a-.5,Xe.y=l-.5,Xe.z=h-.5,r.emitterShape===oi){const f=Math.max(Math.abs(Xe.x),Math.max(Math.abs(Xe.y),Math.abs(Xe.z))),p=f+(.5-f)*s[0],_=f+(.5-f)*s[1],m=f+(.5-f)*s[2];Xe.x=p*(f===Math.abs(Xe.x)?Math.sign(Xe.x):2*Xe.x),Xe.y=_*(f===Math.abs(Xe.y)?Math.sign(Xe.y):2*Xe.y),Xe.z=m*(f===Math.abs(Xe.z)?Math.sign(Xe.z):2*Xe.z),r.localSpace?Ni.copy(t.transformPoint(Xe)):Ni.copy(i).add(t.transformPoint(Xe))}else{Xe.normalize();const f=r.emitterRadius===0?0:r.emitterRadiusInner/r.emitterRadius,p=c*(1-f)+f;r.localSpace?Ni.copy(Xe.mulScalar(p*r.emitterRadius)):Ni.copy(i).add(Xe.mulScalar(p*r.emitterRadius))}let u=-U.lerp(r.rate,r.rate2,a)*n;if(r.pack8){const f=(Ni.x-r.worldBounds.center.x)/r.worldBoundsSize.x+.5,p=(Ni.y-r.worldBounds.center.y)/r.worldBoundsSize.y+.5,_=(Ni.z-r.worldBounds.center.z)/r.worldBoundsSize.z+.5;let m=U.lerp(r.startAngle*U.DEG_TO_RAD,r.startAngle2*U.DEG_TO_RAD,a);m=m%(Math.PI*2)/(Math.PI*2);const g=vu(f);e[n*J]=g[0],e[n*J+1]=g[1];const x=vu(p);e[n*J+2]=x[0],e[n*J+3]=x[1];const S=vu(_);e[n*J+0+r.numParticlesPot*J]=S[0],e[n*J+1+r.numParticlesPot*J]=S[1];const v=vu(m);e[n*J+2+r.numParticlesPot*J]=v[0],e[n*J+3+r.numParticlesPot*J]=v[1];const b=1;e[n*J+3+r.numParticlesPot*J*2]=b;const w=Math.max(r.lifetime,(r.numParticles-1)*Math.max(r.rate,r.rate2)),T=r.lifetime+1;u=(u+w)/(w+T);const E=pO(u);e[n*J+0+r.numParticlesPot*J*3]=E[0],e[n*J+1+r.numParticlesPot*J*3]=E[1],e[n*J+2+r.numParticlesPot*J*3]=E[2],e[n*J+3+r.numParticlesPot*J*3]=E[3]}else e[n*J]=Ni.x,e[n*J+1]=Ni.y,e[n*J+2]=Ni.z,e[n*J+3]=U.lerp(r.startAngle*U.DEG_TO_RAD,r.startAngle2*U.DEG_TO_RAD,a),e[n*J+3+r.numParticlesPot*J]=u}update(e,t,s,i,n,r,a,l){let h,c,d;const u=this._emitter;if(u.meshInstance.node){const C=u.meshInstance.node.worldTransform;for(let M=0;M<12;M++)i_.data[M]=C.data[M];n_.copy(i_),n_.invert(),hn=u.meshInstance.node.localScale,tS=Math.max(Math.max(hn.x,hn.y),hn.z)}r=u.meshInstance.node===null||u.localSpace?y.ZERO:u.meshInstance.node.getPosition();const f=u.camera?u.camera._node.getPosition():y.ZERO,p=u.useMesh?17:15;let _,m,g,x,S,v,b,w,T;const E=u.precision-1;for(let C=0;C<u.numParticles;C++){const M=Math.floor(u.vbCPU[C*u.numParticleVerts*(u.useMesh?6:4)+3]),O=s[M*J+0+u.numParticlesPot*2*J];gi.x=O,gi.y=s[M*J+1+u.numParticlesPot*2*J],gi.z=s[M*J+2+u.numParticlesPot*2*J];const I=u.rate+(u.rate2-u.rate)*O,B=u.lifetime;let P=s[M*J+3+u.numParticlesPot*J]+a;const D=fO(P/B);let R=0,A=0;const L=0;(P-a<=0||P>=B)&&this.calcSpawnPosition(s,i,n,r,M);let N=P>0&&P<B;N&&(d=D*E,_=Math.floor(d),m=Math.ceil(d),d%=1,h=u.qRotSpeed[_],c=u.qRotSpeed[m],g=h+(c-h)*d,h=u.qRotSpeed2[_],c=u.qRotSpeed2[m],x=h+(c-h)*d,h=u.qScale[_],c=u.qScale[m],R=h+(c-h)*d,h=u.qScale2[_],c=u.qScale2[m],S=h+(c-h)*d,h=u.qAlpha[_],c=u.qAlpha[m],v=h+(c-h)*d,h=u.qAlpha2[_],c=u.qAlpha2[m],b=h+(c-h)*d,h=u.qRadialSpeed[_],c=u.qRadialSpeed[m],w=h+(c-h)*d,h=u.qRadialSpeed2[_],c=u.qRadialSpeed2[m],T=h+(c-h)*d,w+=(T-w)*(O*100%1),tl.x=s[M*J],tl.y=s[M*J+1],tl.z=s[M*J+2],u.localSpace?ac.copy(tl):ac.copy(tl).sub(r),ac.normalize().mulScalar(w),_*=3,m*=3,h=u.qLocalVelocity[_],c=u.qLocalVelocity[m],lt.x=h+(c-h)*d,h=u.qLocalVelocity[_+1],c=u.qLocalVelocity[m+1],lt.y=h+(c-h)*d,h=u.qLocalVelocity[_+2],c=u.qLocalVelocity[m+2],lt.z=h+(c-h)*d,h=u.qLocalVelocity2[_],c=u.qLocalVelocity2[m],il.x=h+(c-h)*d,h=u.qLocalVelocity2[_+1],c=u.qLocalVelocity2[m+1],il.y=h+(c-h)*d,h=u.qLocalVelocity2[_+2],c=u.qLocalVelocity2[m+2],il.z=h+(c-h)*d,h=u.qVelocity[_],c=u.qVelocity[m],xs.x=h+(c-h)*d,h=u.qVelocity[_+1],c=u.qVelocity[m+1],xs.y=h+(c-h)*d,h=u.qVelocity[_+2],c=u.qVelocity[m+2],xs.z=h+(c-h)*d,h=u.qVelocity2[_],c=u.qVelocity2[m],sl.x=h+(c-h)*d,h=u.qVelocity2[_+1],c=u.qVelocity2[m+1],sl.y=h+(c-h)*d,h=u.qVelocity2[_+2],c=u.qVelocity2[m+2],sl.z=h+(c-h)*d,lt.x+=(il.x-lt.x)*gi.x,lt.y+=(il.y-lt.y)*gi.y,lt.z+=(il.z-lt.z)*gi.z,u.initialVelocity>0&&(u.emitterShape===H0?(Xe.copy(gi).mulScalar(2).sub(y.ONE).normalize(),lt.add(Xe.mulScalar(u.initialVelocity))):lt.add(y.FORWARD.mulScalar(u.initialVelocity))),xs.x+=(sl.x-xs.x)*gi.x,xs.y+=(sl.y-xs.y)*gi.y,xs.z+=(sl.z-xs.z)*gi.z,g+=(x-g)*gi.y,R=(R+(S-R)*(O*1e4%1))*tS,A=(b-v)*(O*1e3%1),u.meshInstance.node&&(u.localSpace?(lt.x/=hn.x,lt.y/=hn.y,lt.z/=hn.z):i_.transformPoint(lt,lt)),u.localSpace?(n_.transformPoint(xs,xs),lt.add(xs).add(ac)):(lt.add(xs.mul(hn)),lt.add(ac.mul(hn))),yu.copy(lt),sS.copy(tl).add(lt.mulScalar(a)),Mt.copy(sS),s[M*J]=Mt.x,s[M*J+1]=Mt.y,s[M*J+2]=Mt.z,s[M*J+3]+=g*a,u.wrap&&u.wrapBounds&&(u.localSpace||Mt.sub(r),Mt.x=r_(Mt.x,u.wrapBounds.x)-u.wrapBounds.x*.5,Mt.y=r_(Mt.y,u.wrapBounds.y)-u.wrapBounds.y*.5,Mt.z=r_(Mt.z,u.wrapBounds.z)-u.wrapBounds.z*.5,u.localSpace||Mt.add(r)),u.sort>0&&(u.sort===1?(oa.copy(Mt).sub(f),u.particleDistance[M]=-(oa.x*oa.x+oa.y*oa.y+oa.z*oa.z)):u.sort===2?u.particleDistance[M]=P:u.sort===3&&(u.particleDistance[M]=-P))),l?P<0&&(s[M*J+3+u.numParticlesPot*2*J]=-1):(P>=B&&(P-=Math.max(B,(u.numParticles-1)*I),s[M*J+3+u.numParticlesPot*2*J]=u.loop?1:-1),P<0&&u.loop&&(s[M*J+3+u.numParticlesPot*2*J]=1)),s[M*J+3+u.numParticlesPot*2*J]<0&&(N=!1),s[M*J+3+u.numParticlesPot*J]=P;for(let V=0;V<u.numParticleVerts;V++){const k=(C*u.numParticleVerts+V)*(u.useMesh?6:4);let $=u.vbCPU[k],j=u.vbCPU[k+1],K=u.vbCPU[k+2];N||($=j=K=0);const ee=C*u.numParticleVerts*p+V*p;e[ee]=Mt.x,e[ee+1]=Mt.y,e[ee+2]=Mt.z,e[ee+3]=D,e[ee+4]=u.alignToMotion?L:s[M*J+3],e[ee+5]=R,e[ee+6]=A,e[ee+7]=yu.x,e[ee+8]=$,e[ee+9]=j,e[ee+10]=K,e[ee+11]=yu.y,e[ee+12]=M,e[ee+13]=yu.z,e[ee+14]=u.vbCPU[k+3],u.useMesh&&(e[ee+15]=u.vbCPU[k+4],e[ee+16]=u.vbCPU[k+5])}}if(u.sort>Vd&&u.camera){const C=u.useMesh?6:4,M=u.particleDistance;for(let O=0;O<u.numParticles;O++)t[O][0]=O,t[O][1]=M[Math.floor(u.vbCPU[O*u.numParticleVerts*C+3])];u.vbOld.set(u.vbCPU),t.sort(function(O,I){return O[1]-I[1]});for(let O=0;O<u.numParticles;O++){const I=t[O][0]*u.numParticleVerts*C,B=O*u.numParticleVerts*C;for(let P=0;P<u.numParticleVerts*C;P++)u.vbCPU[B+P]=u.vbOld[I+P]}}}}const iS=new ls,nS=new ls,rS=new ls;class _O{constructor(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(e,t,s,i,n){const r=this._emitter;e.setBlendState(Ee.NOBLEND),e.setDepthState(ft.NODEPTH),e.setCullMode(Je),this.randomize(),this.constantGraphSampleSize.setValue(1/r.precision),this.constantGraphNumSamples.setValue(r.precision),this.constantNumParticles.setValue(r.numParticles),this.constantNumParticlesPot.setValue(r.numParticlesPot),this.constantInternalTex0.setValue(r.internalTex0),this.constantInternalTex1.setValue(r.internalTex1),this.constantInternalTex2.setValue(r.internalTex2),this.constantInternalTex3.setValue(r.internalTex3);const a=r.meshInstance.node,l=a===null?y.ONE:a.localScale;if(r.pack8){this.worldBoundsMulUniform[0]=r.worldBoundsMul.x,this.worldBoundsMulUniform[1]=r.worldBoundsMul.y,this.worldBoundsMulUniform[2]=r.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=r.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=r.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=r.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let f=r.maxVel*Math.max(Math.max(l.x,l.y),l.z);f=Math.max(f,1),this.constantMaxVel.setValue(f)}const h=a===null||r.localSpace?y.ZERO:a.getPosition(),c=a===null?W.IDENTITY:a.getWorldTransform();r.emitterShape===oi?(iS.setFromMat4(t),this.constantSpawnBounds.setValue(iS.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(r.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(r.emitterRadius===0?0:r.emitterRadiusInner/r.emitterRadius)),this.constantInitialVelocity.setValue(r.initialVelocity),nS.setFromMat4(c),rS.invertMat4(c),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(r.rate),this.constantRateDiv.setValue(r.rate2-r.rate),this.constantStartAngle.setValue(r.startAngle*U.DEG_TO_RAD),this.constantStartAngle2.setValue(r.startAngle2*U.DEG_TO_RAD),this.constantSeed.setValue(r.seed),this.constantLifetime.setValue(r.lifetime),this.emitterScaleUniform[0]=l.x,this.emitterScaleUniform[1]=l.y,this.emitterScaleUniform[2]=l.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(nS.data),this.constantEmitterMatrixInv.setValue(rS.data),this.constantLocalVelocityDivMult.setValue(r.localVelocityUMax),this.constantVelocityDivMult.setValue(r.velocityUMax),this.constantRotSpeedDivMult.setValue(r.rotSpeedUMax[0]);let d=r.swapTex?r.particleTexOUT:r.particleTexIN;d=r.beenReset?r.particleTexStart:d;const u=r.swapTex?r.particleTexIN:r.particleTexOUT;this.constantParticleTexIN.setValue(d),_s(e,r.swapTex?r.rtParticleTexIN:r.rtParticleTexOUT,n?r.shaderParticleUpdateOnStop:r.loop?r.shaderParticleUpdateRespawn:r.shaderParticleUpdateNoRespawn),r.material.setParameter("particleTexOUT",d),r.material.setParameter("particleTexIN",u),r.beenReset=!1,r.swapTex=!r.swapTex,r.prevWorldBoundsSize.copy(r.worldBoundsSize),r.prevWorldBoundsCenter.copy(r.worldBounds.center),r.pack8&&this._setInputBounds()}}const aS=[[-1,-1],[1,-1],[1,1],[-1,1]];function Hs(o,e,t,s,i=Ge,n,r){let a=de;r&&i===oe&&(a=Oe);const l=new re(o,{width:e,height:t,format:i,cubemap:!1,mipmaps:!1,minFilter:a,magFilter:a,addressU:q,addressV:q,name:"ParticleSystemTexture"}),h=l.lock();if(i===oe){const c=new Uint8Array(s.length);for(let d=0;d<s.length;d++)c[d]=s[d]*n*255;s=c}return h.set(s),l.unlock(),l}function oS(o){return Math.max(Math.min(o,1),0)}const lS=new os([0,0,1,0]),hS=new os([0,1,1,1]),cS=new Wi([0,0,1,0],[0,0,1,0],[0,0,1,0]),gO=new Wi([0,1,1,1],[0,1,1,1],[0,1,1,1]);let cn=2;const xu=4,dn=new Float32Array(3),la=new W,dS=new y,Su=new y,bu=new y;let a_,Tu;function te(o,e){Tu[o]!==void 0&&Tu[o]!==null?a_[o]=Tu[o]:a_[o]=e}function uS(o,e,t){return(o*255<<16|e*255<<8|t*255)/(1<<24)}function fS(o,e){const t=o.length/3,s=new Array(t*4);for(let i=0;i<t;i++)s[i*4]=o[i*3],s[i*4+1]=o[i*3+1],s[i*4+2]=o[i*3+2],s[i*4+3]=uS(e[i*3],e[i*3+1],e[i*3+2]);return s}function yO(o,e){const t=new Array(e.length*4);for(let s=0;s<e.length;s++)t[s*4]=o[s*3],t[s*4+1]=o[s*3+1],t[s*4+2]=o[s*3+2],t[s*4+3]=e[s];return t}function vO(o,e,t,s,i){const n=new Array(o.length*4);for(let r=0;r<o.length;r++)n[r*4]=o[r],n[r*4+1]=e[r],n[r*4+2]=0,n[r*4+3]=uS(t[r],s[r],i[r]);return n}function xO(o,e){const t=new Array(o.length*4);for(let s=0;s<o.length;s++)t[s*4]=o[s],t[s*4+1]=e[s],t[s*4+2]=0,t[s*4+3]=0;return t}function SO(o){const e=Math.max(o.rate,o.rate2)*o.numParticles+o.lifetime;return Date.now()+e*1e3}function bO(o,e){const t=new Float32Array(o.length);for(let s=0;s<o.length;s++)t[s]=o[s]-e[s];return t}function ha(o,e){const t=e.length,s=o.length/t;for(let i=0;i<s;i++)for(let n=0;n<t;n++){const r=Math.abs(o[i*t+n]);e[n]=Math.max(e[n],r)}}function TO(o,e){const t=e.length,s=o.length/t;for(let i=0;i<s;i++)for(let n=0;n<t;n++)o[i*t+n]/=e[n]===0?1:e[n],o[i*t+n]*=.5,o[i*t+n]+=.5}function ca(o,e,t){const s=bO(e,o);return ha(s,t),TO(s,t),s}const wO=new Rs;class o_{constructor(e,t){this.graphicsDevice=e;const s=e,i=32;this.precision=i,this._addTimeTime=0,a_=this,Tu=t,te("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),te("rate",1),te("rate2",this.rate),te("lifetime",50),te("emitterExtents",new y(0,0,0)),te("emitterExtentsInner",new y(0,0,0)),te("emitterRadius",0),te("emitterRadiusInner",0),te("emitterShape",oi),te("initialVelocity",1),te("wrap",!1),te("localSpace",!1),te("screenSpace",!1),te("wrapBounds",null),te("colorMap",this.defaultParamTexture),te("normalMap",null),te("loop",!0),te("preWarm",!1),te("sort",Vd),te("mode",nm),te("scene",null),te("lighting",!1),te("halfLambert",!1),te("intensity",1),te("stretch",0),te("alignToMotion",!1),te("depthSoftening",0),te("mesh",null),te("particleNormal",new y(0,1,0)),te("orientation",Oh),te("depthWrite",!1),te("noFog",!1),te("blendType",Bt),te("node",null),te("startAngle",0),te("startAngle2",this.startAngle),te("animTilesX",1),te("animTilesY",1),te("animStartFrame",0),te("animNumFrames",1),te("animNumAnimations",1),te("animIndex",0),te("randomizeAnimIndex",!1),te("animSpeed",1),te("animLoop",!0),this._gpuUpdater=new _O(this,s),this._cpuUpdater=new mO(this),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),te("colorGraph",gO),te("colorGraph2",this.colorGraph),te("scaleGraph",hS),te("scaleGraph2",this.scaleGraph),te("alphaGraph",hS),te("alphaGraph2",this.alphaGraph),te("localVelocityGraph",cS),te("localVelocityGraph2",this.localVelocityGraph),te("velocityGraph",cS),te("velocityGraph2",this.velocityGraph),te("rotationSpeedGraph",lS),te("rotationSpeedGraph2",this.rotationSpeedGraph),te("radialSpeedGraph",lS),te("radialSpeedGraph2",this.radialSpeedGraph),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!e.supportsGpuParticles,this.pack8=!0,this.localBounds=new ye,this.worldBoundsNoTrail=new ye,this.worldBoundsTrail=[new ye,new ye],this.worldBounds=new ye,this.worldBoundsSize=new y,this.prevWorldBoundsSize=new y,this.prevWorldBoundsCenter=new y,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new y,this.worldBoundsAdd=new y,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}get defaultParamTexture(){return wO.get(this.graphicsDevice,()=>{const s=new Float32Array(1024);for(let n=0;n<16;n++)for(let r=0;r<16;r++){const a=r+1-8.5,l=n+1-8.5,h=oS(1-oS(Math.sqrt(a*a+l*l)/16)-.5),c=n*16+r;s[c*4]=1,s[c*4+1]=1,s[c*4+2]=1,s[c*4+3]=h}const i=Hs(this.graphicsDevice,16,16,s,oe,1,!0);return i.minFilter=Oe,i.magFilter=Oe,i})}onChangeCamera(){this.regenShader(),this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let s=!1;this.emitterShape===oi?s=!this.emitterExtents.equals(this.prevEmitterExtents):s=this.emitterRadius!==this.prevEmitterRadius,s&&this.calculateLocalBounds()}const e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);const t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?W.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let e=Number.MAX_VALUE,t=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=-Number.MAX_VALUE,r=-Number.MAX_VALUE,a=0,l=0;const h=this.lifetime/this.precision,c=[this.qVelocity,this.qVelocity2],d=[this.qLocalVelocity,this.qLocalVelocity2],u=[0,0],f=[0,0],p=[0,0],_=[0,0],m=[0,0];let g,x,S;for(let b=0;b<this.precision+1;b++){const w=Math.min(b,this.precision-1);for(let T=0;T<2;T++)g=d[T][w*3+0]*h+u[T],x=d[T][w*3+1]*h+f[T],S=d[T][w*3+2]*h+p[T],e=Math.min(g,e),t=Math.min(x,t),s=Math.min(S,s),i=Math.max(g,i),n=Math.max(x,n),r=Math.max(S,r),u[T]=g,f[T]=x,p[T]=S;for(let T=0;T<2;T++)m[T]+=h*Math.sqrt(c[T][w*3+0]*c[T][w*3+0]+c[T][w*3+1]*c[T][w*3+1]+c[T][w*3+2]*c[T][w*3+2]);_[0]+=this.qRadialSpeed[w]*h,_[1]+=this.qRadialSpeed2[w]*h,a=Math.max(a,Math.max(Math.abs(_[0]),Math.abs(_[1]))),l=Math.max(l,this.qScale[w])}this.emitterShape===oi?(g=this.emitterExtents.x*.5,x=this.emitterExtents.y*.5,S=this.emitterExtents.z*.5):(g=this.emitterRadius,x=this.emitterRadius,S=this.emitterRadius);const v=Math.max(m[0],m[1]);Su.x=e-l-g-a-v,Su.y=t-l-x-a-v,Su.z=s-l-S-a-v,bu.x=i+l+g+a+v,bu.y=n+l+x+a+v,bu.z=r+l+S+a+v,this.localBounds.setMinMax(Su,bu)}rebuild(){const e=this.graphicsDevice;this.colorMap===null&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=this.emitterShape===oi?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>Vd||e.maxVertexTextures<=1||e.fragmentUniformsCount<64||e.forceCpuParticles||!e.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,cn=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh&&(this.numParticles*this.mesh.vertexBuffer.numVertices>65535||(this.useMesh=!0)),this.numParticlesPot=U.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?W.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let c=0;c<this.numParticles;c++)this.vbToSort[c]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*cn*xu);const t=this.node===null||this.localSpace?y.ZERO:this.node.getPosition();this.emitterShape===oi&&(this.node===null||this.localSpace?la.setTRS(y.ZERO,Z.IDENTITY,this.spawnBounds):la.setTRS(y.ZERO,this.node.getRotation(),dS.copy(this.spawnBounds).mul(this.node.localScale)),dn[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,dn[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,dn[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let c=0;c<this.numParticles;c++)this._cpuUpdater.calcSpawnPosition(this.particleTex,la,dn,t,c),this.useCpu&&(this.particleTex[c*xu+3+this.numParticlesPot*2*xu]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*cn*xu);for(let c=0;c<this.particleTexStart.length;c++)this.particleTexStart[c]=this.particleTex[c];this.useCpu||(this.pack8?(this.particleTexIN=Hs(e,this.numParticlesPot,cn,this.particleTex,oe,1,!1),this.particleTexOUT=Hs(e,this.numParticlesPot,cn,this.particleTex,oe,1,!1),this.particleTexStart=Hs(e,this.numParticlesPot,cn,this.particleTexStart,oe,1,!1)):(this.particleTexIN=Hs(e,this.numParticlesPot,cn,this.particleTex),this.particleTexOUT=Hs(e,this.numParticlesPot,cn,this.particleTex),this.particleTexStart=Hs(e,this.numParticlesPot,cn,this.particleTexStart)),this.rtParticleTexIN=new qe({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new qe({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);const s=(this.localSpace?`#define LOCAL_SPACE
`:"")+z.particleUpdaterInitPS+(this.pack8?z.particleInputRgba8PS+z.particleOutputRgba8PS:z.particleInputFloatPS+z.particleOutputFloatPS)+(this.emitterShape===oi?z.particleUpdaterAABBPS:z.particleUpdaterSpherePS)+z.particleUpdaterStartPS,i=s+z.particleUpdaterRespawnPS+z.particleUpdaterEndPS,n=s+z.particleUpdaterNoRespawnPS+z.particleUpdaterEndPS,r=s+z.particleUpdaterOnStopPS+z.particleUpdaterEndPS,a=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=zt(e,z.fullscreenQuadVS,i,"fsQuad0"+a),this.shaderParticleUpdateNoRespawn=zt(e,z.fullscreenQuadVS,n,"fsQuad1"+a),this.shaderParticleUpdateOnStop=zt(e,z.fullscreenQuadVS,r,"fsQuad2"+a),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);const l=new Ut(e);l.vertexBuffer=this.vertexBuffer,l.indexBuffer[0]=this.indexBuffer,l.primitive[0].type=Js,l.primitive[0].base=0,l.primitive[0].count=this.numParticles*this.numParticleIndices,l.primitive[0].indexed=!0,this.material=new pt,this.material.name=this.node.name,this.material.cull=Je,this.material.alphaWrite=!1,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial();const h=this.meshInstance?this.meshInstance.visible:!0;this.meshInstance=new Te(l,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=h,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){const e=this.precision,t=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(let s=0;s<e;s++)this.qRotSpeed[s]*=U.DEG_TO_RAD,this.qRotSpeed2[s]*=U.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=ca(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=ca(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=ca(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=ca(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=ca(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=ca(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=ca(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){const s=[0,0,0];ha(this.qVelocity,s);const i=[0,0,0];ha(this.qVelocity2,i);const n=[0,0,0];ha(this.qLocalVelocity,n);const r=[0,0,0];ha(this.qLocalVelocity2,r);const a=[0];ha(this.qRadialSpeed,a);const l=[0];ha(this.qRadialSpeed2,l);let h=Math.max(s[0],i[0]);h=Math.max(h,s[1]),h=Math.max(h,i[1]),h=Math.max(h,s[2]),h=Math.max(h,i[2]);let c=Math.max(n[0],r[0]);c=Math.max(c,n[1]),c=Math.max(c,r[1]),c=Math.max(c,n[2]),c=Math.max(c,r[2]);const d=Math.max(a[0],l[0]);this.maxVel=h+c+d}this.useCpu||(this.internalTex0=Hs(t,e,1,fS(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Hs(t,e,1,fS(this.qVelocity,this.qVelocityDiv)),this.internalTex2=Hs(t,e,1,vO(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=Hs(t,e,1,xO(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=Hs(t,e,1,yO(this.qColor,this.qAlpha),oe,1,!0)}_initializeTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}regenShader(){const e=Us(this.graphicsDevice);e.register("particle",uO);const t=this.normalMap!==null;this.normalOption=0,this.lighting&&(this.normalOption=t?2:1),this.material.getShaderVariant=function(s,i,n,r,a,l,h,c){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());const d=this.emitter.inTools,u=new Zi(h,c);return e.getProgram("particle",{pass:Wo,useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:d?!1:this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!==Oh},u)},this.material.shader=this.material.getShaderVariant()}resetMaterial(){const e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&e.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&e.setParameter("normalMap",this.normalMap),this.depthSoftening>0&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(e.cull=Je),this._compParticleFaceParams()}_compParticleFaceParams(){let e,t;if(this.orientation===Oh)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else{let s;this.orientation===X0?s=this.particleNormal.normalize():s=(this.node===null?W.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();const i=new y(1,0,0);Math.abs(i.dot(s))===1&&i.set(0,0,1);const n=new y().cross(s,i).normalize();i.cross(n,s).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([n.x,n.y,n.z])}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t)}_allocate(e){const t=e*this.numParticleVerts,s=e*this.numParticleIndices;if(this.vertexBuffer===void 0||this.vertexBuffer.getNumVertices()!==t){if(this.useCpu){const c=[{semantic:oo,components:4,type:le},{semantic:oh,components:4,type:le},{semantic:ld,components:4,type:le},{semantic:hd,components:1,type:le},{semantic:yp,components:this.useMesh?4:2,type:le}],d=new Tt(this.graphicsDevice,c);this.vertexBuffer=new es(this.graphicsDevice,d,t,Pn),this.indexBuffer=new Di(this.graphicsDevice,Yt,s)}else{const c=[{semantic:oo,components:4,type:le}];this.useMesh&&c.push({semantic:oh,components:2,type:le});const d=new Tt(this.graphicsDevice,c);this.vertexBuffer=new es(this.graphicsDevice,d,t,Pn),this.indexBuffer=new Di(this.graphicsDevice,Yt,s)}const i=new Float32Array(this.vertexBuffer.lock());let n,r,a;if(this.useMesh){n=new Float32Array(this.mesh.vertexBuffer.lock()),r=n.length/this.mesh.vertexBuffer.numVertices;for(let c=0;c<this.mesh.vertexBuffer.format.elements.length;c++)if(this.mesh.vertexBuffer.format.elements[c].name===Lt){a=this.mesh.vertexBuffer.format.elements[c].offset/4;break}}for(let c=0;c<t;c++){const d=Math.floor(c/this.numParticleVerts);if(this.useMesh){const u=c%this.numParticleVerts;i[c*6]=n[u*r],i[c*6+1]=n[u*r+1],i[c*6+2]=n[u*r+2],i[c*6+3]=d,i[c*6+4]=n[u*r+a+0],i[c*6+5]=1-n[u*r+a+1]}else{const u=c%4;i[c*4]=aS[u][0],i[c*4+1]=aS[u][1],i[c*4+2]=0,i[c*4+3]=d}}this.useCpu&&(this.vbCPU=new Float32Array(i),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let l=0;const h=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(let c=0;c<e;c++)if(this.useMesh)for(let d=0;d<this.numParticleIndices;d++)h[c*this.numParticleIndices+d]=n[d]+c*this.numParticleVerts;else{const d=c*4;h[l++]=d,h[l++]=d+1,h[l++]=d+2,h[l++]=d,h[l++]=d+2,h[l++]=d+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let t=0;t<this.particleTexStart.length;t++)this.particleTex[t]=this.particleTexStart[t];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();const e=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=e,this.preWarm&&this.prewarm(this.lifetime)}prewarm(e){const t=e/this.lifetime,s=Math.min(Math.floor(t*this.precision),this.precision),i=e/s;for(let n=0;n<s;n++)this.addTime(i,!1)}resetTime(){this.endTime=SO(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(e,t){const s=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){const r=this.animTilesParams;r[0]=1/this.animTilesX,r[1]=1/this.animTilesY;const a=this.animParams;a[0]=this.animStartFrame,a[1]=this.animNumFrames*this.animSpeed,a[2]=this.animNumFrames-1,a[3]=this.animNumAnimations-1;const l=this.animIndexParams;l[0]=this.animIndex,l[1]=this.randomizeAnimIndex}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),this.emitterShape===oi&&(dn[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,dn[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,dn[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0,this.meshInstance.node===null?la.setTRS(y.ZERO,Z.IDENTITY,this.emitterExtents):la.setTRS(y.ZERO,this.meshInstance.node.getRotation(),dS.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));let i;const n=this.meshInstance.node===null?y.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),!this.useCpu)this._gpuUpdater.update(s,la,dn,e,t);else{const r=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(r,this.vbToSort,this.particleTex,la,dn,i,e,t)}this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)}destroy(){this.camera=null,this._destroyResources()}}class EO extends me{generateKey(e){return`skybox-${e.type}-${e.encoding}-${e.useIntensity}-${e.gamma}-${e.toneMapping}-${e.skymesh}`+(e.type==="cubemap"?`-${e.fixSeams}-${e.mip}`:"")}createShaderDefinition(e,t){const s=t.skymesh===Wh?"":`#define SKYMESH
`,i=s+z.skyboxVS;let n=s;if(t.type==="cubemap"){const r=[128,64,16,8,4,2];n+=t.mip?z.fixCubemapSeamsStretchPS:z.fixCubemapSeamsNonePS,n+=t.useIntensity?z.envMultiplyPS:z.envConstPS,n+=z.decodePS,n+=me.gammaCode(t.gamma),n+=me.tonemapCode(t.toneMapping),n+=z.skyboxHDRPS.replace(/\$DECODE/g,fi.decodeFunc(t.encoding)).replace(/\$FIXCONST/g,1-1/r[t.mip]+"")}else n+=t.useIntensity?z.envMultiplyPS:z.envConstPS,n+=z.decodePS,n+=me.gammaCode(t.gamma),n+=me.tonemapCode(t.toneMapping),n+=z.sphericalPS,n+=z.envAtlasPS,n+=z.skyboxEnvPS.replace(/\$DECODE/g,fi.decodeFunc(t.encoding));return je.createDefinition(e,{name:"SkyboxShader",attributes:{aPosition:We},vertexCode:i,fragmentCode:n})}}const AO=new EO;class oc{static create(e,t){switch(t){case ix:return oc.box(e);case nx:return oc.dome(e)}return oc.infinite(e)}static infinite(e){return Ho(e)}static box(e){return Ho(e,{yOffset:.5})}static dome(e){const l=[],h=[];for(let c=0;c<=50;c++){const d=c*Math.PI/50,u=Math.sin(d),f=Math.cos(d);for(let p=0;p<=50;p++){const _=p*2*Math.PI/50-Math.PI/2,m=Math.sin(_),x=Math.cos(_)*u;let S=f;const v=m*u;S<0&&(S*=.3,x*x+v*v<.9025&&(S=-.1)),S+=.1,l.push(x*.5,S*.5,v*.5)}}for(let c=0;c<50;++c)for(let d=0;d<50;++d){const u=c*51+d,f=u+50+1;h.push(u+1,f,u),h.push(u+1,f+1,f)}return ks(e,l,{indices:h})}}class CO{constructor(e,t,s,i,n){this.meshInstance=null;const r=new pt;r.name="SkyMaterial",r.getShaderVariant=function(l,h,c,d,u,f,p,_){const m={pass:u,encoding:i.encoding,useIntensity:t.skyboxIntensity!==1||t.physicalUnits,gamma:u===di?t.gammaCorrection?Oo:Fo:t.gammaCorrection,toneMapping:u===di?Bo:t.toneMapping,skymesh:n};i.cubemap?(m.type="cubemap",m.mip=i.fixCubemapSeams?t.skyboxMip:0,m.fixSeams=i.fixCubemapSeams):m.type="envAtlas";const g=new Zi(p,_),x=Us(e);return x.register("skybox",AO),x.getProgram("skybox",m,g)},i.cubemap?r.setParameter("texture_cubeMap",i):(r.setParameter("texture_envAtlas",i),r.setParameter("mipLevel",t._skyboxMip)),r.cull=br,r.depthWrite=!1;const a=t.layers.getLayerById(kd);if(a){const l=oc.create(e,n),h=new Te(l,r,s);this.meshInstance=h,h.cull=!1,h.pick=!1,a.addMeshInstances([h]),this.skyLayer=a}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}}class MO{constructor(e){this._type=Wh,this._center=new y(0,1,0),this.skyMesh=null,this.node=new we("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new y(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}applySettings(e){var t,s,i,n;this.type=(t=e.skyType)!=null?t:Wh,this.node.setLocalPosition(new y((s=e.skyMeshPosition)!=null?s:[0,0,0])),this.node.setLocalEulerAngles(new y((i=e.skyMeshRotation)!=null?i:[0,0,0])),this.node.setLocalScale(new y((n=e.skyMeshScale)!=null?n:[1,1,1])),e.skyCenter&&(this._center=new y(e.skyCenter))}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(e){this._center.copy(e)}get center(){return this._center}updateSkyMesh(){const e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new CO(this.device,this.scene,this.node,e,this.type),this.scene.fire("set:skybox",e))}resetSkyMesh(){var e;(e=this.skyMesh)==null||e.destroy(),this.skyMesh=null}update(){if(this.type!==Wh){const{center:e,centerArray:t}=this,s=new y;this.node.getWorldTransform().transformPoint(e,s),t[0]=s.x,t[1]=s.y,t[2]=s.z,this.projectedSkydomeCenterId.setValue(t)}}}const wu=new we;wu.worldTransform=W.IDENTITY,wu._dirtyWorld=wu._dirtyNormal=!1;class PO{constructor(e,t,s){this.material=t,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Ut(e),this.meshInstance=null}addLines(e,t){const s=this.positions,i=e.length;for(let r=0;r<i;r++){const a=e[r];s.push(a.x,a.y,a.z)}const n=this.colors;if(t.length)for(let r=0;r<i;r++){const a=t[r];n.push(a.r,a.g,a.b,a.a)}else for(let r=0;r<i;r++)n.push(t.r,t.g,t.b,t.a)}addLinesArrays(e,t){const s=this.positions;for(let n=0;n<e.length;n+=3)s.push(e[n],e[n+1],e[n+2]);const i=this.colors;if(t.length)for(let n=0;n<t.length;n+=4)i.push(t[n],t[n+1],t[n+2],t[n+3]);else{const n=e.length/3;for(let r=0;r<n;r++)i.push(t.r,t.g,t.b,t.a)}}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(eo,!1),this.meshInstance||(this.meshInstance=new Te(this.mesh,this.material,wu)),this.positions.length=0,this.colors.length=0,e.push(this.meshInstance))}}class RO{constructor(e){this.device=e,this.map=new Map}getBatch(e,t){let s=this.map.get(e);return s||(s=new PO(this.device,e,t),this.map.set(e,s)),s}onPreRender(e,t){this.map.forEach(s=>{s.onPreRender(e,t)})}}const Xs=[],rl=new y;class IO{constructor(e){this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(e){const t=new bm;return t.vertexColors=!0,t.blendType=Bt,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(e,t){let s=this.batchesMap.get(e);s||(s=new RO(this.device),this.batchesMap.set(e,s)),this.allBatches.add(s);const i=t?this.materialDepth:this.materialNoDepth;return s.getBatch(i,e)}getShader(e,t){if(!this[e]){const s=`
				attribute vec2 vertex_position;
				uniform mat4 matrix_model;
				varying vec2 uv0;
				void main(void) {
					gl_Position = matrix_model * vec4(vertex_position, 0, 1);
					uv0 = vertex_position.xy + 0.5;
				}
			`;this[e]=zt(this.device,s,t,`DebugShader:${e}`)}return this[e]}getTextureShader(){return this.getShader("textureShader",`
			varying vec2 uv0;
			uniform sampler2D colorMap;
			void main (void) {
				gl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);
			}
		`)}getUnfilterableTextureShader(){return this.getShader("textureShaderUnfilterable",`
			varying vec2 uv0;
			uniform highp sampler2D colorMap;
			void main (void) {
				ivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));
				gl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);
			}
		`)}getDepthTextureShader(){return this.getShader("depthTextureShader",`
			${z.screenDepthPS}
			varying vec2 uv0;
			void main() {
				float depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;
				gl_FragColor = vec4(vec3(depth), 1.0);
			}
		`)}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Ut(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(As)),this.quadMesh}drawMesh(e,t,s,i,n){if(!i){const a=this.getGraphNode(t);i=new Te(s,e,a)}let r=this.layerMeshInstances.get(n);r||(r=[],this.layerMeshInstances.set(n,r)),r.push(i)}drawWireAlignedBox(e,t,s,i,n,r){if(r){const l=(h,c,d)=>{rl.set(h,c,d),r.transformPoint(rl,rl),Xs.push(rl.x,rl.y,rl.z)};l(e.x,e.y,e.z),l(e.x,t.y,e.z),l(e.x,t.y,e.z),l(t.x,t.y,e.z),l(t.x,t.y,e.z),l(t.x,e.y,e.z),l(t.x,e.y,e.z),l(e.x,e.y,e.z),l(e.x,e.y,t.z),l(e.x,t.y,t.z),l(e.x,t.y,t.z),l(t.x,t.y,t.z),l(t.x,t.y,t.z),l(t.x,e.y,t.z),l(t.x,e.y,t.z),l(e.x,e.y,t.z),l(e.x,e.y,e.z),l(e.x,e.y,t.z),l(e.x,t.y,e.z),l(e.x,t.y,t.z),l(t.x,t.y,e.z),l(t.x,t.y,t.z),l(t.x,e.y,e.z),l(t.x,e.y,t.z)}else Xs.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(n,i).addLinesArrays(Xs,s),Xs.length=0}drawWireSphere(e,t,s,i,n,r){const a=2*Math.PI/i;let l=0;for(let c=0;c<i;c++){const d=Math.sin(l),u=Math.cos(l);l+=a;const f=Math.sin(l),p=Math.cos(l);Xs.push(e.x+t*d,e.y,e.z+t*u),Xs.push(e.x+t*f,e.y,e.z+t*p),Xs.push(e.x+t*d,e.y+t*u,e.z),Xs.push(e.x+t*f,e.y+t*p,e.z),Xs.push(e.x,e.y+t*d,e.z+t*u),Xs.push(e.x,e.y+t*f,e.z+t*p)}this.getBatch(r,n).addLinesArrays(Xs,s),Xs.length=0}getGraphNode(e){const t=new we("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t}onPreRenderLayer(e,t,s){if(this.batchesMap.forEach((i,n)=>{n===e&&i.onPreRender(t,s)}),!this.updatedLayers.has(e)){this.updatedLayers.add(e);const i=this.layerMeshInstances.get(e);if(i){for(let n=0;n<i.length;n++)t.push(i[n]);i.length=0}}}onPostRender(){this.allBatches.clear(),this.updatedLayers.clear()}}class Vt extends Q{constructor(e){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new H(0,0,0),this.ambientLuminance=0,this.exposure=1,this.fogColor=new H(0,0,0),this.fogDensity=0,this.fogEnd=1e3,this.fogStart=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=zh,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this.device=e,this._gravity=new y(0,-9.8,0),this._layers=null,this._fog=Dh,this._gammaCorrection=om,this._toneMapping=0,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new Z,this._skyboxRotationMat3=new ls,this._skyboxRotationMat4=new W,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new s_(this.device.supportsAreaLights,this.device.maxTextureSize,()=>{this.updateShaders=!0}),this._sky=new MO(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new IO(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(Ds)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=U.clamp(Math.floor(e),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=U.clamp(e,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){if(!(this.device.isWebGPU&&!e)){if(!this._clusteredLightingEnabled&&e){console.error("Turning on disabled clustered lighting is not currently supported");return}this._clusteredLightingEnabled=e}}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=q,e.addressV=q,e.minFilter=Oe,e.magFilter=Oe,e.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set fog(e){e!==this._fog&&(this._fog=e,this.updateShaders=!0)}get fog(){return this._fog}set gammaCorrection(e){e!==this._gammaCorrection&&(this._gammaCorrection=e,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set layers(e){const t=this._layers;this._layers=e,this.fire("set:layers",t,e)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];const t=this._prefilteredCubemaps;(t.length!==e.length||t.some((i,n)=>i!==e[n]))&&(e.length===6&&e.every(n=>!!n)?(this._internalEnvAtlas=Bm.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh())}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){const t=e.equals(Z.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(y.ZERO,e,y.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),!this._skyboxRotationShaderInclude&&!t&&(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}set toneMapping(e){e!==this._toneMapping&&(this._toneMapping=e,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(e,t,s=H.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([e,t],[s,s])}drawLines(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(e,t)}drawLineArrays(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(e,t)}applySettings(e){var t,s,i,n;const r=e.physics,a=e.render;this._gravity.set(r.gravity[0],r.gravity[1],r.gravity[2]),this.ambientLight.set(a.global_ambient[0],a.global_ambient[1],a.global_ambient[2]),this.ambientLuminance=a.ambientLuminance,this._fog=a.fog,this.fogColor.set(a.fog_color[0],a.fog_color[1],a.fog_color[2]),this.fogStart=a.fog_start,this.fogEnd=a.fog_end,this.fogDensity=a.fog_density,this._gammaCorrection=a.gamma_correction,this._toneMapping=a.tonemapping,this.lightmapSizeMultiplier=a.lightmapSizeMultiplier,this.lightmapMaxResolution=a.lightmapMaxResolution,this.lightmapMode=a.lightmapMode,this.exposure=a.exposure,this._skyboxIntensity=(t=a.skyboxIntensity)!=null?t:1,this._skyboxLuminance=(s=a.skyboxLuminance)!=null?s:2e4,this._skyboxMip=(i=a.skyboxMip)!=null?i:0,a.skyboxRotation&&(this.skyboxRotation=new Z().setFromEulerAngles(a.skyboxRotation[0],a.skyboxRotation[1],a.skyboxRotation[2])),this.sky.applySettings(a),this.clusteredLightingEnabled=(n=a.clusteredLightingEnabled)!=null?n:!1,this.lighting.applySettings(a),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(l=>{a.hasOwnProperty(l)&&(this[l]=a[l])}),this._resetSkyMesh()}_getSkyboxTex(){const e=this._prefilteredCubemaps;return this._skyboxMip?e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap:this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||oe}}Vt.EVENT_SETLAYERS="set:layers",Vt.EVENT_SETSKYBOX="set:skybox";class Eu{constructor(e,t,s){this.device=e,this.inverseBindPose=t,this.boneNames=s}}const DO=[0,0,1,0,0,1,0,0,1,0,0,1],LO=[0,1,3,2,3,1];class pS extends Q{constructor(e,t){super(),this._device=e,this._pixelsPerUnit=t&&t.pixelsPerUnit!==void 0?t.pixelsPerUnit:1,this._renderMode=t&&t.renderMode!==void 0?t.renderMode:Fi,this._atlas=t&&t.atlas!==void 0?t.atlas:null,this._frameKeys=t&&t.frameKeys!==void 0?t.frameKeys:null,this._meshes=[],this._updatingProperties=!1,this._meshesDirty=!1,this._atlas&&this._frameKeys&&this._createMeshes()}set frameKeys(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",e)}get frameKeys(){return this._frameKeys}set atlas(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",e))}get atlas(){return this._atlas}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&this.renderMode===Fi&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(e){if(this._renderMode===e)return;const t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(t===Fi||e===Fi)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){const e=this._meshes.length;for(let i=0;i<e;i++){const n=this._meshes[i];n&&n.destroy()}const t=this._frameKeys.length;this._meshes=new Array(t);const s=this.renderMode===ot||this._renderMode===st?this._create9SliceMesh:this._createSimpleMesh;for(let i=0;i<t;i++){const n=this._atlas.frames[this._frameKeys[i]];this._meshes[i]=n?s.call(this,n):null}this.fire("set:meshes")}_createSimpleMesh(e){const t=e.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,n=t.z/this._pixelsPerUnit,r=t.w/this._pixelsPerUnit,a=e.pivot.x,l=e.pivot.y,h=[-a*n,-l*r,0,(1-a)*n,-l*r,0,(1-a)*n,(1-l)*r,0,-a*n,(1-l)*r,0],c=t.x/s,d=1-t.y/i,u=(t.x+t.z)/s,f=1-(t.y+t.w)/i,p=[c,d,u,d,u,f,c,f];return ks(this._device,h,{uvs:p,normals:DO,indices:LO})}_create9SliceMesh(){const e=G.ONE,t=3,s=3,i=[],n=[],r=[],a=[];let l=0;for(let c=0;c<=t;c++){const d=c===0||c===t?0:1;for(let u=0;u<=s;u++){const f=-e.x+2*e.x*(c<=1?0:3)/t,p=0,_=-(-e.y+2*e.y*(u<=1?0:3)/s),m=u===0||u===s?0:1;i.push(-f,p,_),n.push(0,1,0),r.push(d,m),c<t&&u<s&&(a.push(l+s+1,l+1,l),a.push(l+s+1,l+s+2,l+1)),l++}}const h={normals:n,uvs:r,indices:a};return ks(this._device,i,h)}_onSetFrames(e){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()}_onFrameChanged(e,t){const s=this._frameKeys.indexOf(e);s<0||(t?this.renderMode===Fi&&(this._meshes[s]=this._createSimpleMesh(t)):this._meshes[s]=null,this.fire("set:meshes"))}_onFrameRemoved(e){const t=this._frameKeys.indexOf(e);t<0||(this._meshes[t]=null,this.fire("set:meshes"))}startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1}endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1}destroy(){for(const e of this._meshes)e&&e.destroy();this._meshes.length=0}}class mS extends Q{constructor(){super(),this._texture=null,this._frames=null}set texture(e){this._texture=e,this.fire("set:texture",e)}get texture(){return this._texture}set frames(e){this._frames=e,this.fire("set:frames",e)}get frames(){return this._frames}setFrame(e,t){let s=this._frames[e];s?(s.rect.copy(t.rect),s.pivot.copy(t.pivot),s.border.copy(t.border)):(s={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=s),this.fire("set:frame",e.toString(),s)}removeFrame(e){const t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t))}destroy(){this._texture&&this._texture.destroy()}}class Au{constructor(e,t,s,i){this.time=e,this.position=t,this.rotation=s,this.scale=i}}class Cu{constructor(){this._name="",this._keys=[]}}class un{constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}getNode(e){return this._nodeDict[e]}addNode(e){this._nodes.push(e),this._nodeDict[e._name]=e}get nodes(){return this._nodes}}class FO{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new Z,this._pos=new y,this._scale=new y,this._targetNode=null}getTarget(){return this._targetNode}setTarget(e){this._targetNode=e}}class $s{constructor(e){this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;const t=s=>{const i=new FO;i._name=s.name,this._interpolatedKeys.push(i),this._interpolatedKeyDict[s.name]=i,this._currKeyIndices[s.name]=0;for(let n=0;n<s._children.length;n++)t(s._children[n])};t(e)}set animation(e){this._animation=e,this.currentTime=0}get animation(){return this._animation}set currentTime(e){this._time=e;const t=this._interpolatedKeys.length;for(let s=0;s<t;s++){const n=this._interpolatedKeys[s]._name;this._currKeyIndices[n]=0}this.addTime(0),this.updateGraph()}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(e){if(this._animation!==null){const t=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=e,this._time>s){this._time=this.looping?0:s;for(let n=0;n<t.length;n++){const a=t[n]._name;this._currKeyIndices[a]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let n=0;n<t.length;n++){const r=t[n],a=r._name;this._currKeyIndices[a]=r._keys.length-2}}const i=e>=0?1:-1;for(let n=0;n<t.length;n++){const r=t[n],a=r._name,l=r._keys,h=this._interpolatedKeyDict[a];if(h===void 0)continue;let c=!1;if(l.length!==1)for(let d=this._currKeyIndices[a];d<l.length-1&&d>=0;d+=i){const u=l[d],f=l[d+1];if(u.time<=this._time&&f.time>=this._time){const p=(this._time-u.time)/(f.time-u.time);h._pos.lerp(u.position,f.position,p),h._quat.slerp(u.rotation,f.rotation,p),h._scale.lerp(u.scale,f.scale,p),h._written=!0,this._currKeyIndices[a]=d,c=!0;break}}(l.length===1||!c&&this._time===0&&this.looping)&&(h._pos.copy(l[0].position),h._quat.copy(l[0].rotation),h._scale.copy(l[0].scale),h._written=!0)}}}blend(e,t,s){const i=this._interpolatedKeys.length;for(let n=0;n<i;n++){const r=e._interpolatedKeys[n],a=t._interpolatedKeys[n],l=this._interpolatedKeys[n];r._written&&a._written?(l._quat.slerp(r._quat,t._interpolatedKeys[n]._quat,s),l._pos.lerp(r._pos,t._interpolatedKeys[n]._pos,s),l._scale.lerp(r._scale,a._scale,s),l._written=!0):r._written?(l._quat.copy(r._quat),l._pos.copy(r._pos),l._scale.copy(r._scale),l._written=!0):a._written&&(l._quat.copy(a._quat),l._pos.copy(a._pos),l._scale.copy(a._scale),l._written=!0)}}setGraph(e){if(this.graph=e,e)for(let t=0;t<this._interpolatedKeys.length;t++){const s=this._interpolatedKeys[t],i=e.findByName(s._name);this._interpolatedKeys[t].setTarget(i)}else for(let t=0;t<this._interpolatedKeys.length;t++)this._interpolatedKeys[t].setTarget(null)}updateGraph(){if(this.graph)for(let e=0;e<this._interpolatedKeys.length;e++){const t=this._interpolatedKeys[e];if(t._written){const s=t.getTarget();s.localPosition.copy(t._pos),s.localRotation.copy(t._quat),s.localScale.copy(t._scale),s._dirtyLocal||s._dirtifyLocal(),t._written=!1}}}}const OO=new X;let l_=class{constructor(e){this.device=e,this.needsDepthBuffer=!1}render(e,t,s){}drawQuad(e,t,s){let i;if(s){const n=e?e.width:this.device.width,r=e?e.height:this.device.height;i=OO.set(s.x*n,s.y*r,s.z*n,s.w*r)}this.device.setBlendState(Ee.NOBLEND),_s(this.device,e,t,i)}};l_.quadVertexShader=`
				attribute vec2 aPosition;
				varying vec2 vUv0;
				void main(void)
				{
						gl_Position = vec4(aPosition, 0.0, 1.0);
						vUv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
				}
		`;class Mu extends Ot{constructor(...e){super(...e),this._shader=null,this.quadRender=null,this.cullMode=Je,this.blendState=Ee.NOBLEND,this.depthState=ft.NODEPTH,this.stencilFront=null,this.stencilBack=null}set shader(e){var t,s;(t=this.quadRender)==null||t.destroy(),this.quadRender=null,(s=this._shader)==null||s.destroy(),this._shader=e,e&&(this.quadRender=new qh(e))}get shader(){return this._shader}createQuadShader(e,t,s={}){return zt(this.device,Mu.quadVertexShader,t,e,{aPosition:We},s)}destroy(){var e;(e=this.shader)==null||e.destroy(),this.shader=null}execute(){const e=this.device;e.setBlendState(this.blendState),e.setCullMode(this.cullMode),e.setDepthState(this.depthState),e.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render()}}Mu.quadVertexShader=`
				attribute vec2 aPosition;
				varying vec2 uv0;
				void main(void)
				{
						gl_Position = vec4(aPosition, 0.0, 1.0);
						uv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
				}
		`;function Pu(o,e){return Math.atan2(o*e,Math.sqrt(o*o+e*e+1))}function BO(o,e,t){let s=2*(o+.5)/t-1,i=2*(e+.5)/t-1;s*=1-1/t,i*=1-1/t;const n=1/t,r=s-n,a=i-n,l=s+n,h=i+n;let c=Pu(r,a)-Pu(r,h)-Pu(l,a)+Pu(l,h);return o===0&&e===0||o===t-1&&e===0||o===0&&e===t-1||o===t-1&&e===t-1?c/=3:(o===0||e===0||o===t-1||e===t-1)&&(c*=.5),c}function NO(o,e,t){if(e.format!==oe||!e._levels[0]||!e._levels[0][0])return null;const s=e.width;if(!e._levels[0][0].length)if(e._levels[0][0]instanceof HTMLImageElement){const w=zt(o,z.fullscreenQuadVS,z.fullscreenQuadPS,"fsQuadSimple"),T=o.scope.resolve("source");for(let E=0;E<6;E++){const C=e._levels[0][E],M=new re(o,{name:"prefiltered-cube",cubemap:!1,type:bt,format:e.format,width:s,height:s,mipmaps:!1});M._levels[0]=C,M.upload();const O=new re(o,{name:"prefiltered-cube",cubemap:!1,type:bt,format:e.format,width:s,height:s,mipmaps:!1}),I=new qe({colorBuffer:O,depth:!1});T.setValue(M),o.setBlendState(Ee.NOBLEND),_s(o,I,w);const B=o.gl;B.bindFramebuffer(B.FRAMEBUFFER,I.impl._glFrameBuffer);const P=new Uint8Array(s*s*4);B.readPixels(0,0,M.width,M.height,B.RGBA,B.UNSIGNED_BYTE,P),e._levels[0][E]=P}}else return null;const i=[];for(let w=0;w<s;w++)for(let T=0;T<s;T++){const E=T/(s-1)*2-1,C=w/(s-1)*2-1;i[w*s+T]=new y(E,C,1).normalize()}const n=new Float32Array(9*3),r=0,a=1*3,l=2*3,h=3*3,c=4*3,d=5*3,u=6*3,f=7*3,p=8*3,_=0,m=1,g=2,x=3,S=4,v=5;let b=0;for(let w=0;w<6;w++)for(let T=0;T<s;T++)for(let E=0;E<s;E++){const C=T*s+E,M=BO(E,T,s),O=M*4/17,I=M*8/17,B=M*15/17,P=M*5/68,D=M*15/68,R=i[C];let A,L,F;w===_?(A=R.z,L=-R.y,F=-R.x):w===m?(A=-R.z,L=-R.y,F=R.x):w===g?(A=R.x,L=R.z,F=R.y):w===x?(A=R.x,L=-R.z,F=-R.y):w===S?(A=R.x,L=-R.y,F=R.z):w===v&&(A=-R.x,L=-R.y,F=-R.z),t||(A=-A);const N=e._levels[0][w][C*4+3]/255;for(let V=0;V<3;V++){let k=e._levels[0][w][C*4+V]/255;e.type===Cs?(k*=N*8,k*=k):k=Math.pow(k,2.2),n[r+V]+=k*O,n[a+V]+=k*I*A,n[l+V]+=k*I*L,n[h+V]+=k*I*F,n[c+V]+=k*B*A*F,n[d+V]+=k*B*F*L,n[u+V]+=k*B*L*A,n[f+V]+=k*P*(3*F*F-1),n[p+V]+=k*D*(A*A-L*L),b+=M}}for(let w=0;w<n.length;w++)n[w]*=4*Math.PI/b;return n}class h_{constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new jo,this._defaultStdMatOptionMin=new jo,t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},t,null,[],Wo,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,dm,null),e.on("destroy:shader",s=>{this.removeFromCache(s)})}destroy(){this.clearCache()}register(e,t){this._generators.has(e)||this._generators.set(e,t)}unregister(e){this._generators.has(e)&&this._generators.delete(e)}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,s,i){let n=this.definitionsCache.get(s);if(!n){var r,a,l;let h;(r=i.litOptions)!=null&&r.lights&&(h=i.litOptions.lights,i.litOptions.lights=h.map(function(d){const u=d.clone?d.clone():d;return u.key=d.key,u})),this.storeNewProgram(t,i),(a=i.litOptions)!=null&&a.lights&&(i.litOptions.lights=h),this._precached;const c=this._device;n=e.createShaderDefinition(c,i),n.name=(l=n.name)!=null?l:i.pass?`${t}-pass:${i.pass}`:t,this.definitionsCache.set(s,n)}return n}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t)}getProgram(e,t,s,i){const n=this._generators.get(e);if(!n)return null;const r=n.generateKey(t),a=Th(r),l=s.generateKey(this._device),h=Th(l),c=`${a}#${h}`;let d=this.getCachedShader(c);if(!d){const u=this.generateShaderDefinition(n,e,a,t);let f="",p;t.pass!==void 0&&(p=zs.get(this._device).getByIndex(t.pass),f=`-${p.name}`),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:p,definition:u});const _={name:`${u.name}${f}-proc`,attributes:u.attributes,vshader:u.vshader,fshader:u.fshader,processingOptions:s,shaderLanguage:u.shaderLanguage};d=new Is(this._device,_),this.setCachedShader(c,d)}return d}storeNewProgram(e,t){let s={};if(e==="standard"){const i=this._getDefaultStdMatOptions(t.pass);for(const n in t)(t.hasOwnProperty(n)&&i[n]!==t[n]||n==="pass")&&(s[n]=t[n]);for(const n in t.litOptions)s[n]=t.litOptions[n]}else s=t;this._programsCollection.push(JSON.stringify({name:e,options:s}))}dumpPrograms(){let e=`let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;
`;e+="let shaders = [",this._programsCollection[0]&&(e+=`
	`+this._programsCollection[0]);for(let s=1;s<this._programsCollection.length;++s)e+=`,
	`+this._programsCollection[s];e+=`
];
`,e+=`device.getProgramLibrary().precompile(shaders);
`,e+='if (pc.version != "'+jf+'" || pc.revision != "'+Yf+`")
`,e+='	console.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach(e=>{e.destroy()}),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(e){this._isClearingCache||this.processedCache.forEach((t,s)=>{e===t&&this.processedCache.delete(s)})}_getDefaultStdMatOptions(e){const t=zs.get(this._device).getByIndex(e);return e===ui||e===ea||e===Uh||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e){const t=new Array(e.length);for(let s=0;s<e.length;s++){if(e[s].name==="standard"){const i=e[s].options,n=this._getDefaultStdMatOptions(i.pass);for(const r in n)n.hasOwnProperty(r)&&i[r]===void 0&&(i[r]=n[r])}t[s]=this.getProgram(e[s].name,e[s].options)}}this._precached=!0}}var kO=`
	vec4 dirLm = texture2D(texture_dirLightMap, vUv1);
	if (bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);
			dAtten = saturate(dAtten);
			gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);
			gl_FragColor.a = dirLm.w + dAtten;
			gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);
		} else {
			gl_FragColor = dirLm;
		}
	} else {
		gl_FragColor.rgb = dirLm.xyz;
		gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);
	}
`,UO=`
#ifdef LIGHTMAP_RGBM
	gl_FragColor.rgb = dDiffuseLight;
	gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));
	gl_FragColor.rgb /= 8.0;
	gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );
	gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;
	gl_FragColor.rgb /= gl_FragColor.a;
#else
	gl_FragColor = vec4(dDiffuseLight, 1.0);
#endif
`,zO=`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
void main(void) {
	vec4 c = texture2DLodEXT(source, vUv0, 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 - pixelOffset, 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(0, pixelOffset.y), 0.0);
	c = c.a>0.0? c : texture2DLodEXT(source, vUv0 + pixelOffset, 0.0);
	gl_FragColor = c;
}
`,VO=`
float normpdf3(in vec3 v, in float sigma) {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
vec3 decodeRGBM(vec4 rgbm) {
	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 encodeRGBM(vec3 color) {
	vec4 encoded;
	encoded.rgb = pow(color.rgb, vec3(0.5));
	encoded.rgb *= 1.0 / 8.0;
	encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded.rgb /= encoded.a;
	return encoded;
}
#define MSIZE 15
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
uniform vec2 sigmas;
uniform float bZnorm;
uniform float kernel[MSIZE];
void main(void) {
	
	vec4 pixelRgbm = texture2DLodEXT(source, vUv0, 0.0);
	if (pixelRgbm.a <= 0.0) {
		gl_FragColor = pixelRgbm;
		return ;
	}
	float sigma = sigmas.x;
	float bSigma = sigmas.y;
	vec3 pixelHdr = decodeRGBM(pixelRgbm);
	vec3 accumulatedHdr = vec3(0.0);
	float accumulatedFactor = 0.0;
	const int kSize = (MSIZE-1)/2;
	for (int i = -kSize; i <= kSize; ++i) {
		for (int j = -kSize; j <= kSize; ++j) {
			
			vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;
			vec4 rgbm = texture2DLodEXT(source, coord, 0.0);
			if (rgbm.a > 0.0) {
				vec3 hdr = decodeRGBM(rgbm);
				float factor = kernel[kSize + j] * kernel[kSize + i];
				factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;
				accumulatedHdr += factor * hdr;
				accumulatedFactor += factor;
			}
		}
	}
	gl_FragColor = encodeRGBM(accumulatedHdr / accumulatedFactor);
}
`;const lc={bakeDirLmEndPS:kO,bakeLmEndPS:UO,dilatePS:zO,bilateralDeNoisePS:VO},sr=new y,ir=new W,al=new Z,_S=new Z,c_=new ye,gS=new ye,$e=[new y,new y,new y,new y,new y,new y,new y,new y],GO=[$e[0],$e[1],$e[1],$e[3],$e[3],$e[2],$e[2],$e[0],$e[4],$e[5],$e[5],$e[7],$e[7],$e[6],$e[6],$e[4],$e[0],$e[4],$e[1],$e[5],$e[2],$e[6],$e[3],$e[7]],WO=new H(1,1,0,.4),yS=(o,e)=>{const t=e.x,s=e.y,i=e.z,n=Math.sqrt(e.rx*e.rx+e.ry*e.ry+e.rz*e.rz+e.rw*e.rw),r=e.rx/n,a=e.ry/n,l=e.rz/n,h=e.rw/n;o.data.set([1-2*(l*l+h*h),2*(a*l+r*h),2*(a*h-r*l),0,2*(a*l-r*h),1-2*(a*a+h*h),2*(l*h+r*a),0,2*(a*h+r*l),2*(l*h-r*a),1-2*(a*a+l*l),0,t,s,i,1])};class ol{constructor(e,t=!0){this.elements=void 0,this.vertexElement=void 0,this.elements=e,this.vertexElement=e.find(s=>s.name==="vertex"),!this.isCompressed&&t&&(ir.setScale(-1,-1,1),this.transform(ir))}get numSplats(){return this.vertexElement.count}static calcSplatAabb(e,t){yS(ir,t),c_.center.set(0,0,0),c_.halfExtents.set(t.sx*2,t.sy*2,t.sz*2),e.setFromTransformedAabb(c_,ir)}transform(e){const t=this.getProp("x"),s=this.getProp("y"),i=this.getProp("z"),n=this.getProp("rot_0"),r=this.getProp("rot_1"),a=this.getProp("rot_2"),l=this.getProp("rot_3");_S.setFromMat4(e);for(let h=0;h<this.numSplats;++h)sr.set(t[h],s[h],i[h]),e.transformPoint(sr,sr),t[h]=sr.x,s[h]=sr.y,i[h]=sr.z,al.set(r[h],a[h],l[h],n[h]).mul2(_S,al),n[h]=al.w,r[h]=al.x,a[h]=al.y,l[h]=al.z}getProp(e){var t;return(t=this.vertexElement.properties.find(s=>s.name===e&&s.storage))==null?void 0:t.storage}addProp(e,t){this.vertexElement.properties.push({type:"float",name:e,storage:t,byteSize:4})}calcAabb(e,t){const s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),r=this.getProp("rot_0"),a=this.getProp("rot_1"),l=this.getProp("rot_2"),h=this.getProp("rot_3"),c=this.getProp("scale_0"),d=this.getProp("scale_1"),u=this.getProp("scale_2"),f={x:0,y:0,z:0,rx:0,ry:0,rz:0,rw:0,sx:0,sy:0,sz:0};let p=!0;for(let _=0;_<this.numSplats;++_)t&&!t(_)||(f.x=s[_],f.y=i[_],f.z=n[_],f.rx=r[_],f.ry=a[_],f.rz=l[_],f.rw=h[_],f.sx=Math.exp(c[_]),f.sy=Math.exp(d[_]),f.sz=Math.exp(u[_]),p?(p=!1,ol.calcSplatAabb(e,f)):(ol.calcSplatAabb(gS,f),e.add(gS)));return!p}calcFocalPoint(e,t){const s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),r=this.getProp("scale_0"),a=this.getProp("scale_1"),l=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;let h=0;for(let c=0;c<this.numSplats;++c){if(t&&!t(c))continue;const d=1/(1+Math.exp(Math.max(r[c],a[c],l[c])));e.x+=s[c]*d,e.y+=i[c]*d,e.z+=n[c]*d,h+=d}e.mulScalar(1/h)}renderWireframeBounds(e,t){const s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),r=this.getProp("rot_0"),a=this.getProp("rot_1"),l=this.getProp("rot_2"),h=this.getProp("rot_3"),c=this.getProp("scale_0"),d=this.getProp("scale_1"),u=this.getProp("scale_2"),f={x:0,y:0,z:0,rx:0,ry:0,rz:0,rw:0,sx:0,sy:0,sz:0};for(let p=0;p<this.numSplats;++p){f.x=s[p],f.y=i[p],f.z=n[p],f.rx=r[p],f.ry=a[p],f.rz=l[p],f.rw=h[p],f.sx=Math.exp(c[p]),f.sy=Math.exp(d[p]),f.sz=Math.exp(u[p]),yS(ir,f),ir.mul2(t,ir);for(let _=0;_<8;++_)sr.set(f.sx*2*(_&1?1:-1),f.sy*2*(_&2?1:-1),f.sz*2*(_&4?1:-1)),ir.transformPoint(sr,$e[_]);e.drawLineArrays(GO,WO)}}get isCompressed(){return this.elements.some(e=>e.name==="chunk")&&["packed_position","packed_rotation","packed_scale","packed_color"].every(e=>this.getProp(e))}decompress(){const e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","rot_0","rot_1","rot_2","rot_3","scale_0","scale_1","scale_2"],t=this.elements.find(D=>D.name==="chunk"),s=this.vertexElement,i={};e.forEach(D=>{i[D]=new Float32Array(s.count)});const n=D=>{var R;return(R=t.properties.find(A=>A.name===D&&A.storage))==null?void 0:R.storage},r=n("min_x"),a=n("min_y"),l=n("min_z"),h=n("max_x"),c=n("max_y"),d=n("max_z"),u=n("min_scale_x"),f=n("min_scale_y"),p=n("min_scale_z"),_=n("max_scale_x"),m=n("max_scale_y"),g=n("max_scale_z"),x=this.getProp("packed_position"),S=this.getProp("packed_rotation"),v=this.getProp("packed_scale"),b=this.getProp("packed_color"),w=(D,R)=>{const A=(1<<R)-1;return(D&A)/A},T=(D,R)=>{D.x=w(R>>>21,11),D.y=w(R>>>11,10),D.z=w(R,11)},E=(D,R)=>{D.x=w(R>>>24,8),D.y=w(R>>>16,8),D.z=w(R>>>8,8),D.w=w(R,8)},C=(D,R)=>{const A=1/(Math.sqrt(2)*.5),L=(w(R>>>20,10)-.5)*A,F=(w(R>>>10,10)-.5)*A,N=(w(R,10)-.5)*A,V=Math.sqrt(1-(L*L+F*F+N*N));switch(R>>>30){case 0:D.set(V,L,F,N);break;case 1:D.set(L,V,F,N);break;case 2:D.set(L,F,V,N);break;case 3:D.set(L,F,N,V);break}},M=(D,R,A)=>D*(1-A)+R*A,O=new y,I=new Z,B=new y,P=new X;for(let D=0;D<s.count;++D){const R=Math.floor(D/256);T(O,x[D]),C(I,S[D]),T(B,v[D]),E(P,b[D]),i.x[D]=M(r[R],h[R],O.x),i.y[D]=M(a[R],c[R],O.y),i.z[D]=M(l[R],d[R],O.z),i.rot_0[D]=I.x,i.rot_1[D]=I.y,i.rot_2[D]=I.z,i.rot_3[D]=I.w,i.scale_0[D]=M(u[R],_[R],B.x),i.scale_1[D]=M(f[R],m[R],B.y),i.scale_2[D]=M(p[R],g[R],B.z);const A=.28209479177387814;i.f_dc_0[D]=(P.x-.5)/A,i.f_dc_1[D]=(P.y-.5)/A,i.f_dc_2[D]=(P.z-.5)/A,i.opacity[D]=-Math.log(1/P.w-1)}return new ol([{name:"vertex",count:s.count,properties:e.map(D=>({name:D,type:"float",byteSize:4,storage:i[D]}))}],!1)}}const HO=new y,XO=new y,$O=new y,hc=new y,cc=new y,dc=new y,vS=new y,xS=new y;class SS{constructor(e,t,s){if(this.device=void 0,this.numSplats=void 0,this.vertexFormat=void 0,this.halfFormat=void 0,this.colorTexture=void 0,this.transformATexture=void 0,this.transformBTexture=void 0,this.transformCTexture=void 0,this.centers=void 0,this.aabb=void 0,this.device=e,this.numSplats=t,this.aabb=s,this.vertexFormat=new Tt(e,[{semantic:Bn,components:1,type:e.isWebGL1?le:tt,asInt:!e.isWebGL1}]),this.halfFormat=this.getTextureFormat(e,!0),this.halfFormat!==void 0){const i=this.evalTextureSize(t);this.colorTexture=this.createTexture(e,"splatColor",oe,i),this.transformATexture=this.createTexture(e,"transformA",this.halfFormat?et:Ge,i),this.transformBTexture=this.createTexture(e,"transformB",this.halfFormat?et:Ge,i),this.transformCTexture=this.createTexture(e,"transformC",this.halfFormat?Qa:Pi,i)}}destroy(){var e,t,s,i;(e=this.colorTexture)==null||e.destroy(),(t=this.transformATexture)==null||t.destroy(),(s=this.transformBTexture)==null||s.destroy(),(i=this.transformCTexture)==null||i.destroy()}setupMaterial(e){if(this.colorTexture){e.setParameter("splatColor",this.colorTexture),e.setParameter("transformA",this.transformATexture),e.setParameter("transformB",this.transformBTexture),e.setParameter("transformC",this.transformCTexture);const{width:t,height:s}=this.colorTexture;e.setParameter("tex_params",new Float32Array([t,s,1/t,1/s]))}}evalTextureSize(e){const t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new G(t,s)}createTexture(e,t,s,i){return new re(e,{name:t,width:i.x,height:i.y,format:s,cubemap:!1,mipmaps:!1,minFilter:de,magFilter:de,addressU:q,addressV:q})}getTextureFormat(e,t){e.isWebGL1&&(t=!1);const s=e.extTextureHalfFloat&&e.textureHalfFloatUpdatable,i=e.extTextureFloat;let n;return t?i?n=!1:s&&(n=!0):s?n=!0:i&&(n=!1),n}updateColorData(e,t,s,i){const n=.28209479177387814,r=this.colorTexture;if(!r)return;const a=r.lock(),l=h=>{if(h>0)return 1/(1+Math.exp(-h));const c=Math.exp(h);return c/(1+c)};for(let h=0;h<this.numSplats;++h)e&&t&&s&&(a[h*4+0]=U.clamp((.5+n*e[h])*255,0,255),a[h*4+1]=U.clamp((.5+n*t[h])*255,0,255),a[h*4+2]=U.clamp((.5+n*s[h])*255,0,255)),a[h*4+3]=i?U.clamp(l(i[h])*255,0,255):255;r.unlock()}updateTransformData(e,t,s,i,n,r,a,l,h,c){const{halfFormat:d}=this,u=Fe.float2Half;if(!this.transformATexture)return;const f=this.transformATexture.lock(),p=this.transformBTexture.lock(),_=this.transformCTexture.lock(),m=new Z,g=new ls,x=new y,S=new y;for(let v=0;v<this.numSplats;v++)m.set(i[v],n[v],r[v],a[v]).normalize(),m.w<0&&m.conjugate(),xS.set(m.x,m.y,m.z),this.quatToMat3(xS,g),vS.set(Math.exp(l[v]),Math.exp(h[v]),Math.exp(c[v])),this.computeCov3d(g,vS,x,S),d?(f[v*4+0]=u(e[v]),f[v*4+1]=u(t[v]),f[v*4+2]=u(s[v]),f[v*4+3]=u(S.x),p[v*4+0]=u(x.x),p[v*4+1]=u(x.y),p[v*4+2]=u(x.z),p[v*4+3]=u(S.y),_[v]=u(S.z)):(f[v*4+0]=e[v],f[v*4+1]=t[v],f[v*4+2]=s[v],f[v*4+3]=S.x,p[v*4+0]=x.x,p[v*4+1]=x.y,p[v*4+2]=x.z,p[v*4+3]=S.y,_[v]=S.z);this.transformATexture.unlock(),this.transformBTexture.unlock(),this.transformCTexture.unlock()}quatToMat3(e,t){const s=e.x,i=e.y,n=e.z,r=Math.sqrt(1-e.dot(e)),a=t.data;a[0]=1-2*(n*n+r*r),a[1]=2*(i*n+s*r),a[2]=2*(i*r-s*n),a[3]=2*(i*n-s*r),a[4]=1-2*(i*i+r*r),a[5]=2*(n*r+s*i),a[6]=2*(i*r+s*n),a[7]=2*(n*r-s*i),a[8]=1-2*(i*i+n*n)}computeCov3d(e,t,s,i){const n=e.getX(HO).mulScalar(t.x),r=e.getY(XO).mulScalar(t.y),a=e.getZ($O).mulScalar(t.z);hc.set(n.x,r.x,a.x),cc.set(n.y,r.y,a.y),dc.set(n.z,r.z,a.z),s.set(hc.dot(hc),hc.dot(cc),hc.dot(dc)),i.set(cc.dot(cc),cc.dot(dc),dc.dot(dc))}}const qO=`
		attribute vec3 vertex_position;

		uniform mat4 matrix_model;
		uniform mat4 matrix_view;
		uniform mat4 matrix_projection;
		uniform mat4 matrix_viewProjection;

		uniform vec2 viewport;

		varying vec2 texCoord;
		varying vec4 color;
		varying float id;

		#ifndef GL2
		#ifndef WEBGPU
		mat3 transpose(in mat3 m) {
				return mat3(
						m[0].x, m[1].x, m[2].x,
						m[0].y, m[1].y, m[2].y,
						m[0].z, m[1].z, m[2].z
				);
		}
		#endif
		#endif

		uniform vec4 tex_params;
		uniform sampler2D splatColor;

		uniform highp sampler2D transformA;
		uniform highp sampler2D transformB;
		uniform highp sampler2D transformC;

		vec3 center;
		vec3 covA;
		vec3 covB;

		#ifdef INT_INDICES

				attribute uint vertex_id;
				ivec2 dataUV;
				void evalDataUV() {

						// turn vertex_id into int grid coordinates
						ivec2 textureSize = ivec2(tex_params.xy);
						vec2 invTextureSize = tex_params.zw;

						int gridV = int(float(vertex_id) * invTextureSize.x);
						int gridU = int(vertex_id) - gridV * textureSize.x;
						dataUV = ivec2(gridU, gridV);
				}

				vec4 getColor() {
						return texelFetch(splatColor, dataUV, 0);
				}

				void getTransform() {
						vec4 tA = texelFetch(transformA, dataUV, 0);
						vec4 tB = texelFetch(transformB, dataUV, 0);
						vec4 tC = texelFetch(transformC, dataUV, 0);

						center = tA.xyz;
						covA = tB.xyz;
						covB = vec3(tA.w, tB.w, tC.x);
				}

		#else

				// TODO: use texture2DLodEXT on WebGL

				attribute float vertex_id;
				vec2 dataUV;
				void evalDataUV() {
						vec2 textureSize = tex_params.xy;
						vec2 invTextureSize = tex_params.zw;

						// turn vertex_id into int grid coordinates
						float gridV = floor(vertex_id * invTextureSize.x);
						float gridU = vertex_id - (gridV * textureSize.x);

						// convert grid coordinates to uv coordinates with half pixel offset
						dataUV = vec2(gridU, gridV) * invTextureSize + (0.5 * invTextureSize);
				}

				vec4 getColor() {
						return texture2D(splatColor, dataUV);
				}

				void getTransform() {
						vec4 tA = texture2D(transformA, dataUV);
						vec4 tB = texture2D(transformB, dataUV);
						vec4 tC = texture2D(transformC, dataUV);

						center = tA.xyz;
						covA = tB.xyz;
						covB = vec3(tA.w, tB.w, tC.x);
				}

		#endif

		vec3 evalCenter() {
				evalDataUV();

				// get data
				getTransform();

				return center;
		}

		vec4 evalSplat(vec4 centerWorld)
		{
				vec4 splat_cam = matrix_view * centerWorld;
				vec4 splat_proj = matrix_projection * splat_cam;

				// cull behind camera
				if (splat_proj.z < -splat_proj.w) {
						return vec4(0.0, 0.0, 2.0, 1.0);
				}

				color = getColor();

				mat3 Vrk = mat3(
						covA.x, covA.y, covA.z, 
						covA.y, covB.x, covB.y,
						covA.z, covB.y, covB.z
				);

				float focal = viewport.x * matrix_projection[0][0];

				float J1 = focal / splat_cam.z;
				vec2 J2 = -J1 / splat_cam.z * splat_cam.xy;
				mat3 J = mat3(
						J1, 0., J2.x, 
						0., J1, J2.y, 
						0., 0., 0.
				);

				mat3 W = transpose(mat3(matrix_view) * mat3(matrix_model));

				mat3 T = W * J;
				mat3 cov = transpose(T) * Vrk * T;

				float diagonal1 = cov[0][0] + 0.3;
				float offDiagonal = cov[0][1];
				float diagonal2 = cov[1][1] + 0.3;

				float mid = 0.5 * (diagonal1 + diagonal2);
				float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
				float lambda1 = mid + radius;
				float lambda2 = max(mid - radius, 0.1);
				vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
				vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;
				vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);

				// early out tiny splats
				// TODO: figure out length units and expose as uniform parameter
				// TODO: perhaps make this a shader compile-time option
				if (dot(v1, v1) < 4.0 && dot(v2, v2) < 4.0) {
						return vec4(0.0, 0.0, 2.0, 1.0);
				}

				texCoord = vertex_position.xy * 2.0;

				splat_proj.xy += (texCoord.x * v1 + texCoord.y * v2) / viewport * splat_proj.w;
				return splat_proj;

				id = float(vertex_id);
		}
`,jO=`
		varying vec2 texCoord;
		varying vec4 color;
		varying float id;

		#ifdef PICK_PASS
				uniform vec4 uColor;
		#endif

		vec4 evalSplat() {

				#ifdef DEBUG_RENDER

						if (color.a < 0.2) discard;
						return color;

				#else

						float A = -dot(texCoord, texCoord);
						if (A < -4.0) discard;
						float B = exp(A) * color.a;

						#ifdef PICK_PASS
								if (B < 0.3) discard;
								return(uColor);
						#endif

						#ifndef DITHER_NONE
								opacityDither(B, id * 0.013);
						#endif

						// the color here is in gamma space, so bring it to linear
						vec3 diffuse = decodeGamma(color.rgb);

						// apply tone-mapping and gamma correction as needed
						diffuse = toneMap(diffuse);
						diffuse = gammaCorrectOutput(diffuse);

						return vec4(diffuse, B);

				#endif
		}
`;class YO{generateKey(e){const t=Th(e.vertex),s=Th(e.fragment);return`splat-${e.pass}-${e.gamma}-${e.toneMapping}-${t}-${s}-${e.debugRender}-${e.dither}}`}createShaderDefinition(e,t){const n=zs.get(e).getByIndex(t.pass).shaderDefines+(t.debugRender?`#define DEBUG_RENDER
`:"")+(e.isWebGL1?"":`#define INT_INDICES
`)+`#define DITHER_${t.dither.toUpperCase()}
`,r=n+qO+t.vertex,a=n+z.decodePS+(t.dither===wt?"":z.bayerPS+z.opacityDitherPS)+me.tonemapCode(t.toneMapping)+me.gammaCode(t.gamma)+jO+t.fragment;return je.createDefinition(e,{name:"SplatShader",attributes:{vertex_position:We,vertex_id:Bn},vertexCode:r,fragmentCode:a})}}const KO=new YO,ZO=`
		void main(void)
		{
				vec3 centerLocal = evalCenter();
				vec4 centerWorld = matrix_model * vec4(centerLocal, 1.0);

				gl_Position = evalSplat(centerWorld);
		}
`,QO=`
		void main(void)
		{
				gl_FragColor = evalSplat();
		}
`,JO=(o={})=>{var e;const{debugRender:t}=o,s=(e=o.dither)!=null?e:wt,i=s!==wt,n=new pt;return n.name="splatMaterial",n.cull=t?Ai:Je,n.blendType=i?Nt:Bt,n.depthWrite=i,n.getShaderVariant=function(r,a,l,h,c,d,u,f){var p,_;const m={pass:c,gamma:c===di?a.gammaCorrection?Oo:Fo:a.gammaCorrection,toneMapping:c===di?Bo:a.toneMapping,vertex:(p=o.vertex)!=null?p:ZO,fragment:(_=o.fragment)!=null?_:QO,debugRender:t,dither:s},g=new Zi(u,f),x=Us(r);return x.register("splat",KO),x.getProgram("splat",m,g)},n.update(),n};function eB(){let t,s,i,n,r;const a={x:0,y:0,z:0},l={x:0,y:0,z:0},h={x:0,y:0,z:0},c={x:0,y:0,z:0};let d,u,f,p;const _=()=>{var m;if(!s||!t||!i||!n)return;const g=i.x,x=i.y,S=i.z,v=n.x,b=n.y,w=n.z,T=.001;if(Math.abs(g-a.x)<T&&Math.abs(x-a.y)<T&&Math.abs(S-a.z)<T&&Math.abs(v-l.x)<T&&Math.abs(b-l.y)<T&&Math.abs(w-l.z)<T)return;a.x=g,a.y=x,a.z=S,l.x=v,l.y=b,l.z=w;const E=s.length/3;((m=d)==null?void 0:m.length)!==E&&(d=new Uint32Array(E),u=new Uint32Array(E),f=new Float32Array(E));let C,M;for(let R=0;R<8;++R){const A=R&1?h.x:c.x,L=R&2?h.y:c.y,F=R&4?h.z:c.z,N=(A-g)*v+(L-x)*b+(F-S)*w;R===0?C=M=N:(C=Math.min(C,N),M=Math.max(M,N))}p||(p=new Uint32Array(65537));for(let R=0;R<65537;R++)p[R]=0;const I=1/(M-C)*2**16;for(let R=0;R<E;++R){const A=R*3,L=(s[A+0]-g)*v+(s[A+1]-x)*b+(s[A+2]-S)*w,F=Math.floor((L-C)*I);d[R]=F,u[R]=R,p[F]++}for(let R=1;R<65537;R++)p[R]+=p[R-1];const B=r?new Uint32Array(f.buffer):f,P=r?0:.2;for(let R=E-1;R>=0;R--){const A=d[R],L=u[R];B[p[A]-1]=L+P,p[A]--}const D=t;t=f,f=D,self.postMessage({data:t.buffer},[t.buffer]),t=null};self.onmessage=m=>{if(m.data.data&&(t=new Float32Array(m.data.data)),m.data.centers){s=new Float32Array(m.data.centers),h.x=c.x=s[0],h.y=c.y=s[1],h.z=c.z=s[2];const g=s.length/3;for(let x=1;x<g;++x){const S=s[x*3+0],v=s[x*3+1],b=s[x*3+2];h.x=Math.min(h.x,S),h.y=Math.min(h.y,v),h.z=Math.min(h.z,b),c.x=Math.max(c.x,S),c.y=Math.max(c.y,v),c.z=Math.max(c.z,b)}}m.data.intIndices&&(r=m.data.intIndices),m.data.cameraPosition&&(i=m.data.cameraPosition),m.data.cameraDirection&&(n=m.data.cameraDirection),_()}}class tB extends Q{constructor(){super(),this.worker=void 0,this.vertexBuffer=void 0,this.worker=new Worker(URL.createObjectURL(new Blob([`(${eB.toString()})()`],{type:"application/javascript"}))),this.worker.onmessage=e=>{const t=e.data.data,s=this.vertexBuffer.storage;this.worker.postMessage({data:s},[s]),setTimeout(()=>{this.vertexBuffer.setData(t),this.fire("updated")})}}destroy(){this.worker.terminate(),this.worker=null}init(e,t,s){this.vertexBuffer=e;const i=e.storage.slice(0);this.worker.postMessage({data:i,centers:t.buffer,intIndices:s},[i,t.buffer])}setCamera(e,t){this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}})}}const sB=new W,ll=new y,hl=new y,d_=[0,0];class Ru{constructor(e,t){this.splat=void 0,this.mesh=void 0,this.meshInstance=void 0,this.material=void 0,this.vb=void 0,this.options={},this.sorter=null,this.lastCameraPosition=new y,this.lastCameraDirection=new y,this.cameras=[],this.splat=e,t=Object.assign(this.options,t);const s=t.debugRender;this.createMaterial(t);const i=e.device;s?this.mesh=Ho(i,{halfExtents:new y(1,1,1)}):(this.mesh=new Ut(i),this.mesh.setPositions(new Float32Array([-1,-1,1,-1,1,1,-1,-1,1,1,-1,1]),2),this.mesh.update()),this.mesh.aabb.copy(e.aabb);const n=e.numSplats;let r;if(i.isWebGL1){r=new Float32Array(n);for(let l=0;l<n;++l)r[l]=l+.2}else{r=new Uint32Array(n);for(let l=0;l<n;++l)r[l]=l}const a=new es(i,e.vertexFormat,n,Pn,r.buffer);this.vb=a,this.meshInstance=new Te(this.mesh,this.material),this.meshInstance.setInstancing(a,!0),this.meshInstance.gsplatInstance=this,this.centers=new Float32Array(e.centers),(!t.dither||t.dither===wt)&&(this.sorter=new tB,this.sorter.init(this.vb,this.centers,!this.splat.device.isWebGL1))}destroy(){var e;this.material.destroy(),this.vb.destroy(),this.meshInstance.destroy(),(e=this.sorter)==null||e.destroy()}clone(){return new Ru(this.splat,this.options)}createMaterial(e){this.material=JO(e),this.splat.setupMaterial(this.material),this.meshInstance&&(this.meshInstance.material=this.material)}updateViewport(){const e=this.splat.device;d_[0]=e.width,d_[1]=e.height,this.material.setParameter("viewport",d_)}sort(e){if(this.sorter){const t=e.getWorldTransform();t.getTranslation(ll),t.getZ(hl);const s=this.meshInstance.node.getWorldTransform(),i=sB.invert(s);i.transformPoint(ll,ll),i.transformVector(hl,hl),(!ll.equalsApprox(this.lastCameraPosition)||!hl.equalsApprox(this.lastCameraDirection))&&(this.lastCameraPosition.copy(ll),this.lastCameraDirection.copy(hl),this.sorter.setCamera(ll,hl))}this.updateViewport()}update(){if(this.cameras.length>0){const e=this.cameras[0];this.sort(e._node),this.cameras.length=0}}}const u_="NONE",bS="FILL_WINDOW",Iu="KEEP_ASPECT",f_="AUTO",TS="FIXED";let wS;function qs(){return wS}function p_(o){wS=o}class js{static push(e,t){t&&js._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):js._types.push(e)}}js._types=[];let Du=!1,ES=!1;const vt={app:null,create(o,e){if(!Du)return;const t=e(vt.app);t._pcScriptName=o,js.push(t,Du),this.fire("created",o,e)},attribute(o,e,t,s){},createLoadingScreen(o){if(ES)return;ES=!0;const e=qs();o(e)}};Object.defineProperty(vt,"legacy",{get:function(){return Du},set:function(o){Du=o}}),zc.attach(vt);class iB{constructor(){this.renderPasses=[],this.renderTargetMap=new Map}addRenderPass(e){e.frameUpdate();const t=e.beforePasses;for(let i=0;i<t.length;i++){const n=t[i];n.enabled&&this.addRenderPass(n)}e.enabled&&this.renderPasses.push(e);const s=e.afterPasses;for(let i=0;i<s.length;i++){const n=s[i];n.enabled&&this.addRenderPass(n)}}reset(){this.renderPasses.length=0}compile(){const e=this.renderTargetMap,t=this.renderPasses;for(let n=0;n<t.length;n++){const r=t[n],a=r.renderTarget;if(a!==void 0){const l=e.get(a);if(l){const h=r.colorArrayOps.length;for(let c=0;c<h;c++)r.colorArrayOps[c].clear||(l.colorArrayOps[c].store=!0);r.depthStencilOps.clearDepth||(l.depthStencilOps.storeDepth=!0),r.depthStencilOps.clearStencil||(l.depthStencilOps.storeStencil=!0)}e.set(a,r)}}let s=null,i=null;for(let n=0;n<t.length;n++){const r=t[n],a=r.renderTarget,l=a==null?void 0:a.colorBuffer;if(l!=null&&l.cubemap){if(s===l){const h=i.colorArrayOps.length;for(let c=0;c<h;c++)i.colorArrayOps[c].mipmaps=!1}s=a.colorBuffer,i=r}else r.requiresCubemaps&&(s=null,i=null)}e.clear()}render(e){this.compile();const t=this.renderPasses;for(let s=0;s<t.length;s++)t[s].render()}}class nB{constructor(e,t){this.texture0=e,this.texture1=t}destroy(){var e,t;(e=this.texture0)==null||e.destroy(),(t=this.texture1)==null||t.destroy()}}const AS=new Rs;class da{static createTexture(e,t,s,i=""){return new re(e,{name:`AreaLightLUT${i}`,width:s,height:s,format:t,addressU:q,addressV:q,type:bt,magFilter:Oe,minFilter:de,anisotropy:1,mipmaps:!1})}static applyTextures(e,t,s){AS.remove(e),AS.get(e,()=>new nB(t,t===s?null:s)),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(e){const t=da.createTexture(e,e.areaLightLutFormat,2,"placeholder");t.lock().fill(0),t.unlock(),da.applyTextures(e,t,t)}static set(e,t,s){function i(_,m,g){const x=da.createTexture(_,g,64);return x.lock().set(m),x.unlock(),x}function n(_,m,g){const x=_.length,S=new Float32Array(x);for(let v=0;v<x;v++){const b=v%4;S[v]=(_[v]+m[b])*g[b]}return S}function r(_){const m=_.length,g=new Uint16Array(m),x=Fe.float2Half;for(let S=0;S<m;S++)g[S]=x(_[S]);return g}function a(_){const m=_.length,g=new Uint8ClampedArray(m);for(let x=0;x<m;x++)g[x]=_[x]*255;return g}const l=t,h=s;let c,d;const u=e.areaLightLutFormat;if(u===Ge)c=l,d=h;else if(u===et)c=r(l),d=r(h);else{const _=[0,.2976,.01381,0],m=[.999,3.08737,1.6546,.603249],g=[-.306897,0,0,0],x=[1.442787,1,1,1];c=a(n(l,_,m)),d=a(n(h,g,x))}const f=i(e,c,u),p=i(e,d,u);da.applyTextures(e,f,p)}}const Lu="en-US",Fu={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},m_={};function nr(o,e){for(let t=0,s=o.length;t<s;t++)m_[o[t]]=e}function fn(o){const e=o.indexOf("-");return e!==-1?o.substring(0,e):o}function rB(o,e){const t=o.indexOf("-");return t!==-1?e+o.substring(t):e}function CS(o,e){if(e[o])return o;let t=Fu[o];if(t&&e[t])return t;const s=fn(o);return t=Fu[s],e[t]?t:e[s]?s:Lu}nr(["ja","ko","th","vi","zh","id"],function(o){return 0}),nr(["fa","hi"],function(o){return o>=0&&o<=1?0:1}),nr(["fr","pt"],function(o){return o>=0&&o<2?0:1}),nr(["da"],function(o){return o===1||!Number.isInteger(o)&&o>=0&&o<=1?0:1}),nr(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],function(o){return o===1?0:1}),nr(["ru","uk"],function(o){if(Number.isInteger(o)){const e=o%10,t=o%100;if(e===1&&t!==11)return 0;if(e>=2&&e<=4&&(t<12||t>14))return 1;if(e===0||e>=5&&e<=9||t>=11&&t<=14)return 2}return 3}),nr(["pl"],function(o){if(Number.isInteger(o)){if(o===1)return 0;const e=o%10,t=o%100;if(e>=2&&e<=4&&(t<12||t>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||t>=12&&t<=14)return 2}return 3}),nr(["ar"],function(o){if(o===0)return 0;if(o===1)return 1;if(o===2)return 2;if(Number.isInteger(o)){const e=o%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5});const aB=m_[fn(Lu)];function __(o){return m_[o]||aB}const ua=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i"),oB="animation",lB="audio",hB="image",cB="json",dB="model",uB="material",fB="text",pB="texture",mB="textureatlas",_B="cubemap",gB="shader",yB="css",vB="html",xB="script",SB="container";class bB{constructor(e="",t="",s=null,i=null,n=null,r=null){this.url=e,this.filename=t,this.hash=s,this.size=i,this.opt=n,this.contents=r}equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}}let TB=-1;const wB={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},MS=["pvr","dxt","etc2","etc1","basis"];class se extends Q{constructor(e,t,s,i,n){super(),this._id=TB--,this._name=e||"",this.type=t,this.tags=new Va(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this.urlObject=null,this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}set id(e){this._id=e}get id(){return this._id}set name(e){if(this._name===e)return;const t=this._name;this._name=e,this.fire("name",this,this._name,t)}get name(){return this._name}set file(e){if(e&&e.variants&&["texture","textureatlas","bundle"].indexOf(this.type)!==-1){var t;const n=((t=this.registry)==null||(t=t._loader)==null?void 0:t._app)||qs(),r=n==null?void 0:n.graphicsDevice;if(r)for(let a=0,l=MS.length;a<l;a++){const h=MS[a];if(e.variants[h]&&r[wB[h]]){e=e.variants[h];break}if(n.enableBundles){const c=n.bundles.listBundlesForAsset(this);if(c&&c.find(d=>{var u;return d==null||(u=d.file)==null?void 0:u.variants[h]}))break}}}const s=this._file,i=e?new bB(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!i!=!!s||i&&!i.equals(s))&&(this._file=i,this.fire("change",this,"file",i,s),this.reload())}get file(){return this._file}set data(e){const t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(e){const t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}get resource(){return this._resources[0]}set resources(e){const t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(e){e=!!e,(!this.hasOwnProperty("_loadFaces")||e!==this._loadFaces)&&(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const e=this.file;if(!e||!e.url)return null;let t=e.url;if(this.registry&&this.registry.prefix&&!ua.test(t)&&(t=this.registry.prefix+t),this.type!=="script"&&e.hash){const s=t.indexOf("?")!==-1?"&":"?";t+=s+"t="+e.hash}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;const t=ce.getDirectory(this.file.url);return ce.join(t,e)}getLocalizedAssetId(e){return e=CS(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)}removeLocalizedAssetId(e){const t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",function(s){e.call(t,s)})}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&this._resources.length===0)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let t=0;t<e.length;++t){const s=e[t];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(e,t,s,i=0){var n;s!=null&&(n=s.file)!=null&&n.contents?setTimeout(()=>{t(null,s.file.contents)}):He.get(e,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},t)}}se.EVENT_LOAD="load",se.EVENT_UNLOAD="unload",se.EVENT_REMOVE="remove",se.EVENT_ERROR="error",se.EVENT_CHANGE="change",se.EVENT_ADDLOCALIZED="add:localized",se.EVENT_REMOVELOCALIZED="remove:localized";class EB{constructor(e=null){this._index={},this._key=void 0,this._key=e}addItem(e){const t=e.tags._list;for(const s of t)this.add(s,e)}removeItem(e){const t=e.tags._list;for(const s of t)this.remove(s,e)}add(e,t){this._index[e]&&this._index[e].list.indexOf(t)!==-1||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))}remove(e,t){if(!this._index[e]||this._key&&!this._index[e].keys[t[this._key]])return;const s=this._index[e].list.indexOf(t);s!==-1&&(this._index[e].list.splice(s,1),this._key&&delete this._index[e].keys[t[this._key]],this._index[e].list.length===0&&delete this._index[e])}find(e){const t={},s=[];let i,n,r,a,l;const h=(c,d)=>this._index[c].list.length-this._index[d].list.length;for(let c=0;c<e.length;c++){if(n=e[c],n instanceof Array){if(n.length===0)continue;if(n.length===1)n=n[0];else{l=!1;for(let d=0;d<n.length;d++)if(!this._index[n[d]]){l=!0;break}if(l)continue;r=n.slice(0).sort(h),a=r.slice(1),a.length===1&&(a=a[0]);for(let d=0;d<this._index[r[0]].list.length;d++)i=this._index[r[0]].list[d],(this._key?!t[i[this._key]]:s.indexOf(i)===-1)&&i.tags.has(a)&&(this._key&&(t[i[this._key]]=!0),s.push(i));continue}}if(n&&typeof n=="string"&&this._index[n])for(let d=0;d<this._index[n].list.length;d++)i=this._index[n].list[d],this._key?t[i[this._key]]||(t[i[this._key]]=!0,s.push(i)):s.indexOf(i)===-1&&s.push(i)}return s}}class fa extends Q{constructor(e){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new EB("_id"),this.prefix=null,this.bundles=null,this._loader=e}list(e={}){const t=Array.from(this._assets);return e.preload!==void 0?t.filter(s=>s.preload===e.preload):t}add(e){var t,s;this._assets.has(e)||(this._assets.add(e),this._idToAsset.set(e.id,e),(t=e.file)!=null&&t.url&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),(s=e.file)!=null&&s.url&&this.fire("add:url:"+e.file.url,e),e.preload&&this.load(e))}remove(e){var t,s;if(!this._assets.has(e))return!1;if(this._assets.delete(e),this._idToAsset.delete(e.id),(t=e.file)!=null&&t.url&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){const i=this._nameToAsset.get(e.name);i.delete(e),i.size===0&&this._nameToAsset.delete(e.name)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),(s=e.file)!=null&&s.url&&this.fire("remove:url:"+e.file.url,e),!0}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if((e.loading||e.loaded)&&!(t!=null&&t.force))return;const s=e.file,i=()=>{this.fire("load",e),this.fire("load:"+e.id,e),s&&s.url&&this.fire("load:url:"+s.url,e),e.fire("load",e)},n=a=>{if(a instanceof Array?e.resources=a:e.resource=a,this._loader.patch(e,this),e.type==="bundle"){const l=e.data.assets;for(let h=0;h<l.length;h++){const c=this._idToAsset.get(l[h]);c&&!c.loaded&&this.load(c,{force:!0})}e.resource.loaded?i():(this.fire("load:start",e),this.fire("load:start:"+e.id,e),s&&s.url&&this.fire("load:start:url:"+s.url,e),e.fire("load:start",e),e.resource.on("load",i))}else i()},r=(a,l,h)=>{if(e.loaded=!0,e.loading=!1,a)this.fire("error",a,e),this.fire("error:"+e.id,a,e),e.fire("error",a,e);else{if(!vt.legacy&&e.type==="script"){const c=this._loader.getHandler("script");c._cache[e.id]&&c._cache[e.id].parentNode===document.head&&document.head.removeChild(c._cache[e.id]),c._cache[e.id]=h}n(l)}};if(s||e.type==="cubemap"){this.fire("load:start",e),this.fire("load:"+e.id+":start",e),e.loading=!0;const a=e.getFileUrl();if(e.type==="bundle"){const l=e.data.assets;for(let h=0;h<l.length;h++){const c=this._idToAsset.get(l[h]);c&&(c.loaded||c.resource||c.loading||(c.loading=!0))}}this._loader.load(a,e.type,r,e,t)}else{const a=this._loader.open(e.type,e.data);e.loaded=!0,n(a)}}loadFromUrl(e,t,s){this.loadFromUrlAndFilename(e,null,t,s)}loadFromUrlAndFilename(e,t,s,i){const n=ce.getBasename(t||e),r={filename:t||n,url:e};let a=this.getByUrl(e);if(!a)a=new se(n,s,r),this.add(a);else if(a.loaded){i(a.loadFromUrlError||null,a);return}const l=h=>{h.once("load",c=>{s==="material"?this._loadTextures(c,(d,u)=>{i(d,c)}):i(null,c)}),h.once("error",c=>{c&&(this.loadFromUrlError=c),i(c,h)}),this.load(h)};a.resource?i(null,a):s==="model"?this._loadModel(a,l):l(a)}_loadModel(e,t){const s=e.getFileUrl(),i=ce.getExtension(s);if(i===".json"||i===".glb"){const n=ce.getDirectory(s),r=ce.getBasename(s),a=ce.join(n,r.replace(i,".mapping.json"));this._loader.load(a,"json",(l,h)=>{l?(e.data={mapping:[]},t(e)):this._loadMaterials(e,h,(c,d)=>{e.data=h,t(e)})})}else t(e)}_loadMaterials(e,t,s){const i=[];let n=0;const r=(a,l)=>{this._loadTextures(l,(h,c)=>{i.push(l),i.length===n&&s(null,i)})};for(let a=0;a<t.mapping.length;a++){const l=t.mapping[a].path;if(l){n++;const h=e.getAbsoluteUrl(l);this.loadFromUrl(h,"material",r)}}n===0&&s(null,i)}_loadTextures(e,t){const s=[];let i=0;const n=e.data;if(n.mappingFormat!=="path"){t(null,s);return}const r=(l,h)=>{l&&console.error(l),s.push(h),s.length===i&&t(null,s)},a=ou;for(let l=0;l<a.length;l++){const h=n[a[l]];if(h&&typeof h=="string"){i++;const c=e.getAbsoluteUrl(h);this.loadFromUrl(c,"texture",r)}}i===0&&t(null,s)}_onTagAdd(e,t){this._tags.add(e,t)}_onTagRemove(e,t){this._tags.remove(e,t)}_onNameChange(e,t,s){if(this._nameToAsset.has(s)){const i=this._nameToAsset.get(s);i.delete(e),i.size===0&&this._nameToAsset.delete(s)}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e)}findByTag(){return this._tags.find(arguments)}filter(e){return Array.from(this._assets).filter(t=>e(t))}find(e,t){const s=this._nameToAsset.get(e);if(!s)return null;for(const i of s)if(!t||i.type===t)return i;return null}findAll(e,t){const s=this._nameToAsset.get(e);if(!s)return[];const i=Array.from(s);return t?i.filter(n=>n.type===t):i}}fa.EVENT_LOAD="load",fa.EVENT_ADD="add",fa.EVENT_REMOVE="remove",fa.EVENT_ERROR="error";class PS{constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}_onAssetAdd(e){if(e.type==="bundle"){this._idToBundle.set(e.id,e),this._assets.on(`load:start:${e.id}`,this._onBundleLoadStart,this),this._assets.on(`load:${e.id}`,this._onBundleLoad,this),this._assets.on(`error:${e.id}`,this._onBundleError,this);const t=e.data.assets;for(let s=0;s<t.length;s++)this._indexAssetInBundle(t[s],e)}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e)}_unbindAssetEvents(e){this._assets.off("load:start:"+e,this._onBundleLoadStart,this),this._assets.off("load:"+e,this._onBundleLoad,this),this._assets.off("error:"+e,this._onBundleError,this)}_indexAssetInBundle(e,t){let s=this._assetToBundles.get(e);s||(s=new Set,this._assetToBundles.set(e,s)),s.add(t);const i=this._assets.get(e);i&&this._indexAssetFileUrls(i)}_indexAssetFileUrls(e){const t=this._getAssetFileUrls(e);if(t)for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(e.id);i&&this._urlsToBundles.set(t[s],i)}}_getAssetFileUrls(e){let t=e.getFileUrl();if(!t)return null;t=t.split("?")[0];const s=[t];if(e.type==="font"){const i=e.data.info.maps.length;for(let n=1;n<i;n++)s.push(t.replace(".png",n+".png"))}return s}_onAssetRemove(e){if(e.type==="bundle"){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);const t=e.data.assets;for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(t[s]);if(i&&(i.delete(e),i.size===0)){this._assetToBundles.delete(t[s]);for(const[n,r]of this._urlsToBundles)r===i&&this._urlsToBundles.delete(n)}}this._onBundleError(`Bundle ${e.id} was removed`)}else{if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);const s=this._getAssetFileUrls(e);if(!s)return;for(let i=0;i<s.length;i++)this._urlsToBundles.delete(s[i])}}_onBundleLoadStart(e){e.resource.on("add",(t,s)=>{const i=this._fileRequests.get(t);if(i){for(let n=0;n<i.length;n++)i[n](null,s);this._fileRequests.delete(t)}})}_onBundleLoad(e){if(!e.resource){this._onBundleError(`Bundle ${e.id} failed to load`);return}if(this._fileRequests)for(const[t,s]of this._fileRequests){const i=this._urlsToBundles.get(t);if(!i||!i.has(e))continue;const n=decodeURIComponent(t);let r,a;if(e.resource.has(n))a=e.resource.get(n);else if(e.resource.loaded)r=`Bundle ${e.id} does not contain URL ${t}`;else continue;for(let l=0;l<s.length;l++)s[l](r,r||a);this._fileRequests.delete(t)}}_onBundleError(e){for(const[t,s]of this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(t)){for(let n=0;n<s.length;n++)s[n](e);this._fileRequests.delete(t)}}_findLoadedOrLoadingBundleForUrl(e){const t=this._urlsToBundles.get(e);if(!t)return null;let s=null;for(const i of t){if(i.loaded&&i.resource)return i;i.loading&&(s=i)}return s}listBundlesForAsset(e){const t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return!!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){const s=this._findLoadedOrLoadingBundleForUrl(e);if(!s){t(`URL ${e} not found in any bundles`);return}if(s.loaded){const n=decodeURIComponent(e);if(s.resource.has(n)){t(null,s.resource.get(n));return}else if(s.resource.loaded){t(`Bundle ${s.id} does not contain URL ${e}`);return}}let i=this._fileRequests.get(e);i||(i=[],this._fileRequests.set(e,i)),i.push(t)}destroy(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(const e of this._idToBundle.keys())this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}}class RS extends Q{constructor(){super(),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.audiosource=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.joint=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.zone=void 0,this.list=[]}add(e){const t=e.id;if(this[t])throw new Error(`ComponentSystem name '${t}' already registered or not allowed`);this[t]=e,this.list.push(e)}remove(e){const t=e.id;if(!this[t])throw new Error(`No ComponentSystem named '${t}' registered`);delete this[t];const s=this.list.indexOf(this[t]);s!==-1&&this.list.splice(s,1)}destroy(){this.off();for(let e=0;e<this.list.length;e++)this.list[e].destroy()}}class Ou extends Q{constructor(...e){super(...e),this._index=new Map,this._loaded=!1}addFile(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t))}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear()}set loaded(e){!e||this._loaded||(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}}Ou.EVENT_ADD="add",Ou.EVENT_LOAD="load";class AB extends Q{constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then(s=>{this.pump(s.done,s.value)}).catch(s=>{this.fire("error",s)})}pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;const s=new Uint8Array(this.data.length+t.length);for(s.set(this.data),s.set(t,this.data.length),this.data=s;this.readFile(););return this.reader.read().then(i=>{this.pump(i.done,i.value)}).catch(i=>{this.fire("error",i)})}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){var e;this.headerRead=!0;const t=new DataView(this.data.buffer,this.bytesRead,this.headerSize);(e=this.decoder)!=null||(this.decoder=new TextDecoder("windows-1252"));const s=this.decoder.decode(t);if(this.fileName=s.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(s.substring(124,136),8),this.fileType=s.substring(156,157),this.ustarFormat=s.substring(257,263),this.ustarFormat.indexOf("ustar")!==-1){const i=s.substring(345,500).replace(/\0/g,"");i.length>0&&(this.fileName=i.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(this.fileType===""||this.fileType==="0"){const s=new DataView(this.data.buffer,this.bytesRead,this.fileSize),i={name:this.prefix+this.fileName,size:this.fileSize,data:s};this.fire("file",i)}this.bytesRead+=this.fileSize,this.headerRead=!1;const t=this.bytesRead%this.paddingSize;return t!==0&&(this.bytesRead+=this.paddingSize-t),!0}return!1}}class Le{constructor(e,t){this.handlerType="",this._app=void 0,this._maxRetries=0,this._app=e,this.handlerType=t}set maxRetries(e){this._maxRetries=e}get maxRetries(){return this._maxRetries}load(e,t,s){}open(e,t,s){return t}patch(e,t){}}class IS extends Le{constructor(e){super(e,"bundle"),this._assets=e.assets}_fetchRetries(e,t,s=0){return new Promise((i,n)=>{const r=()=>{fetch(e,t).then(i).catch(a=>{s++,s<this.maxRetries?r():n(a)})};r()})}load(e,t){typeof e=="string"&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors",credentials:"include"},this.maxRetries).then(s=>{const i=new Ou;t(null,i);const n=new AB(s,this._assets.prefix);n.on("file",r=>{i.addFile(r.name,r.data)}),n.on("done",()=>{i.loaded=!0}),n.on("error",r=>{t(r)})}).catch(s=>{t(s)})}open(e,t){return t}}class pa{constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e}addHandler(e,t){this._handlers[e]=t,t._loader=this}removeHandler(e){delete this._handlers[e]}getHandler(e){return this._handlers[e]}static makeKey(e,t){return`${e}-${t}`}load(e,t,s,i,n){const r=this._handlers[t];if(!r){const h=`No resource handler for asset type: '${t}' when loading [${e}]`;s(h);return}if(!e){this._loadNull(r,s,i);return}const a=pa.makeKey(e,t);if(this._cache[a]!==void 0)s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else{this._requests[a]=[s];const h=this,c=function(f,p){if(f){h._onFailure(a,f);return}if(p.load instanceof DataView){if(r.openBinary){if(!h._requests[a])return;try{const _=r.openBinary(p.load);h._onSuccess(a,_)}catch(_){h._onFailure(a,_)}return}p.load=URL.createObjectURL(new Blob([p.load])),i&&(i.urlObject&&URL.revokeObjectURL(i.urlObject),i.urlObject=p.load)}r.load(p,function(_,m,g){if(h._requests[a]){if(_){h._onFailure(a,_);return}try{h._onSuccess(a,r.open(p.original,m,i),g)}catch(x){h._onFailure(a,x)}}},i)},d=e.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(d)&&!(n&&n.bundlesIgnore)){if(!this._app.bundles.urlIsLoadedOrLoading(d)){var l;const u=this._app.bundles.listBundlesForAsset(i);let f;n&&n.bundlesFilter&&(f=n.bundlesFilter(u)),f||(u==null||u.sort((p,_)=>p.file.size-_.file.size),f=u==null?void 0:u[0]),f&&((l=this._app.assets)==null||l.load(f))}this._app.bundles.loadUrl(d,function(u,f){c(u,{load:f,original:d})})}else c(null,{load:e,original:i&&i.file.filename||e})}}_loadNull(e,t,s){const i=function(r,a,l){if(r)t(r);else try{t(null,e.open(null,a,s),l)}catch(h){t(h)}};e.load(null,i,s)}_onSuccess(e,t,s){t!==null?this._cache[e]=t:delete this._cache[e];for(let i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,s);delete this._requests[e]}_onFailure(e,t){if(console.error(t),this._requests[e]){for(let s=0;s<this._requests[e].length;s++)this._requests[e][s](t);delete this._requests[e]}}open(e,t){const s=this._handlers[e];return s?s.open(null,t):(console.warn("No resource handler found for: "+e),t)}patch(e,t){const s=this._handlers[e.type];if(!s){console.warn("No resource handler found for: "+e.type);return}s.patch&&s.patch(e,t)}clearCache(e,t){const s=pa.makeKey(e,t);delete this._cache[s]}getFromCache(e,t){const s=pa.makeKey(e,t);if(this._cache[s])return this._cache[s]}enableRetry(e=5){e=Math.max(0,e)||0;for(const t in this._handlers)this._handlers[t].maxRetries=e}disableRetry(){for(const e in this._handlers)this._handlers[e].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class CB{_validate(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(e.header.version!==1)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(e.data){if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array')}else throw new Error('pc.I18n#addData: Missing "data" field');for(let t=0,s=e.data.length;t<s;t++){const i=e.data[t];if(!i.info)throw new Error(`pc.I18n#addData: missing "data[${t}].info" field`);if(!i.info.locale)throw new Error(`pc.I18n#addData: missing "data[${t}].info.locale" field`);if(typeof i.info.locale!="string")throw new Error(`pc.I18n#addData: "data[${t}].info.locale" must be a string`);if(!i.messages)throw new Error(`pc.I18n#addData: missing "data[${t}].messages" field`)}}parse(e){return e.data}}class DS extends Q{constructor(e){super(),this.locale=Lu,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new CB}set assets(e){const t={};for(let i=0,n=e.length;i<n;i++){const r=e[i]instanceof se?e[i].id:e[i];t[r]=!0}let s=this._assets.length;for(;s--;){const i=this._assets[s];if(!t[i]){this._app.assets.off("add:"+i,this._onAssetAdd,this);const n=this._app.assets.get(i);n&&this._onAssetRemove(n),this._assets.splice(s,1)}}for(const i in t){const n=parseInt(i,10);if(this._assets.indexOf(n)!==-1)continue;this._assets.push(n);const r=this._app.assets.get(n);r?this._onAssetAdd(r):this._app.assets.once("add:"+n,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(e){if(this._locale===e)return;let t=fn(e);if(t==="in"&&(t="id",e=rB(e,t),this._locale===e))return;const s=this._locale;this._locale=e,this._lang=t,this._pluralFn=__(this._lang),this.fire("set:locale",e,s)}get locale(){return this._locale}static findAvailableLocale(e,t){return CS(e,t)}findAvailableLocale(e){if(this._translations[e])return e;const t=fn(e);return this._findFallbackLocale(e,t)}getText(e,t){let s=e,i;t||(t=this._locale,i=this._lang);let n=this._translations[t];return n||(i||(i=fn(t)),t=this._findFallbackLocale(t,i),n=this._translations[t]),n&&n.hasOwnProperty(e)&&(s=n[e],Array.isArray(s)&&(s=s[0]),s==null&&(s=e)),s}getPluralText(e,t,s){let i=e,n,r;s?(n=fn(s),r=__(n)):(s=this._locale,n=this._lang,r=this._pluralFn);let a=this._translations[s];if(a||(s=this._findFallbackLocale(s,n),n=fn(s),r=__(n),a=this._translations[s]),a&&a[e]&&r){const l=r(t);i=a[e][l],i==null&&(i=e)}return i}addData(e){let t;try{t=this._parser.parse(e)}catch(s){console.error(s);return}for(let s=0,i=t.length;s<i;s++){const n=t[s],r=n.info.locale,a=n.messages;if(!this._translations[r]){this._translations[r]={};const l=fn(r);this._availableLangs[l]||(this._availableLangs[l]=r)}Object.assign(this._translations[r],a),this.fire("data:add",r,a)}}removeData(e){let t;try{t=this._parser.parse(e)}catch(s){console.error(s);return}for(let s=0,i=t.length;s<i;s++){const n=t[s],r=n.info.locale,a=this._translations[r];if(!a)continue;const l=n.messages;for(const h in l)delete a[h];Object.keys(a).length===0&&(delete this._translations[r],delete this._availableLangs[fn(r)]),this.fire("data:remove",r,l)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(e,t){let s=Fu[e];return s&&this._translations[s]||(s=Fu[t],s&&this._translations[s])||(s=this._availableLangs[t],s&&this._translations[s])?s:Lu}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)}_onAssetLoad(e){this.addData(e.resource)}_onAssetChange(e){e.resource&&this.addData(e.resource)}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)}_onAssetUnload(e){e.resource&&this.removeData(e.resource)}}class LS extends Q{constructor(e){super(),this.app=e,this._scripts={},this._list=[]}destroy(){this.app=null,this.off()}add(e){const t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout(()=>{if(e.prototype.swap){const s=this._scripts[t],i=this._list.indexOf(s);this._list[i]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire("swap:"+t,e)}else console.warn(`script registry already has '${t}' script, define 'swap' method for new script type to enable code hot swapping`)}),!1):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire("add:"+t,e),setTimeout(()=>{if(!this._scripts.hasOwnProperty(t)||!this.app||!this.app.systems||!this.app.systems.script)return;const s=this.app.systems.script._components;let i;const n=[],r=[];for(s.loopIndex=0;s.loopIndex<s.length;s.loopIndex++){const a=s.items[s.loopIndex];if(a._scriptsIndex[t]&&a._scriptsIndex[t].awaiting){a._scriptsData&&a._scriptsData[t]&&(i=a._scriptsData[t].attributes);const l=a.create(t,{preloading:!0,ind:a._scriptsIndex[t].ind,attributes:i});l&&n.push(l)}}for(let a=0;a<n.length;a++)n[a].__initializeAttributes();for(let a=0;a<n.length;a++)n[a].enabled&&(n[a]._initialized=!0,r.push(n[a]),n[a].initialize&&n[a].initialize());for(let a=0;a<r.length;a++)!r[a].enabled||r[a]._postInitialized||(r[a]._postInitialized=!0,r[a].postInitialize&&r[a].postInitialize())}),!0)}remove(e){let t=e,s=e;if(typeof s!="string"?s=t.__name:t=this.get(s),this.get(s)!==t)return!1;delete this._scripts[s];const i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",s,t),this.fire("remove:"+s,t),!0}get(e){return this._scripts[e]||null}has(e){if(typeof e=="string")return this._scripts.hasOwnProperty(e);if(!e)return!1;const t=e.__name;return this._scripts[t]===e}list(){return this._list}}const uc=[];class Ce extends we{constructor(e,t=qs()){super(e),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.gsplat=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.c={},this._app=void 0,this._destroying=!1,this._guid=null,this._template=!1,this._app=t}addComponent(e,t){const s=this._app.systems[e];return!s||this.c[e]?null:s.addComponent(this,t)}removeComponent(e){const t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)}findComponent(e){const t=this.findOne(function(s){return s.c&&s.c[e]});return t&&t.c[e]}findComponents(e){return this.find(function(s){return s.c&&s.c[e]}).map(function(s){return s.c[e]})}findScript(e){const t=this.findOne(s=>{var i;return(i=s.c)==null||(i=i.script)==null?void 0:i.has(e)});return t==null?void 0:t.c.script.get(e)}findScripts(e){return this.find(s=>{var i;return(i=s.c)==null||(i=i.script)==null?void 0:i.has(e)}).map(s=>s.c.script.get(e))}getGuid(){return this._guid||this.setGuid(hy.create()),this._guid}setGuid(e){const t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this}_notifyHierarchyStateChanged(e,t){let s=!1;e===this&&uc.length===0&&(s=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&uc.push(e);const i=e._children;for(let n=0,r=i.length;n<r;n++)i[n]._enabled&&this._notifyHierarchyStateChanged(i[n],t);if(e._beingEnabled=!1,s){for(let n=0;n<uc.length;n++)uc[n]._onHierarchyStatePostChanged();uc.length=0}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);const t=this.c;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];i.enabled&&(e?i.onEnable():i.onDisable())}}_onHierarchyStatePostChanged(){const e=this.c;for(const t in e)e.hasOwnProperty(t)&&e[t].onPostStateChange()}findByGuid(e){if(this._guid===e)return this;const t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){this._destroying=!0;for(const e in this.c)this.c[e].enabled=!1;for(const e in this.c)this.c[e].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,FS(this,this,t,e),t}_cloneRecursively(e){const t=new this.constructor(void 0,this._app);super._cloneInternal(t);for(const s in this.c)this.c[s].system.cloneComponent(this,t);for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof Ce){const n=i._cloneRecursively(e);t.addChild(n),e[i.getGuid()]=n}}return t}}Ce.EVENT_DESTROY="destroy";function FS(o,e,t,s){if(e instanceof Ce){const i=e.c;for(const a in i){const l=i[a],h=l.system.getPropertiesOfType("entity");for(let c=0,d=h.length;c<d;c++){const f=h[c].name,p=l[f];if(!!o.findByGuid(p)){const m=s[p].getGuid();m&&(t.c[a][f]=m)}}}i.script&&!t._app.useLegacyScriptAttributeCloning&&t.script.resolveDuplicatedEntityReferenceProperties(i.script,s),i.render&&t.render.resolveDuplicatedEntityReferenceProperties(i.render,s),i.anim&&t.anim.resolveDuplicatedEntityReferenceProperties(i.anim,s);const n=e.children.filter(function(a){return a instanceof Ce}),r=t.children.filter(function(a){return a instanceof Ce});for(let a=0,l=n.length;a<l;a++)FS(o,n[a],r[a],s)}}class g_{constructor(e,t){this.name=void 0,this.url=void 0,this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=e,this.url=t}get loaded(){return!!this.data}get loading(){return this._loading}}class OS{constructor(e){this._app=void 0,this._list=[],this._index={},this._urlIndex={},this._app=e}destroy(){this._app=null}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return!1;const s=new g_(e,t),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){const t=this._index[e];let s=this._list[t];delete this._urlIndex[s.url],delete this._index[e],this._list.splice(t,1);for(let i=0;i<this._list.length;i++)s=this._list[i],this._index[s.name]=i,this._urlIndex[s.url]=i}}_loadSceneData(e,t,s){const i=this._app;let n=e;if(typeof e=="string"&&(e=this.findByUrl(n)||this.find(n)||new g_("Untitled",n)),n=e.url,!n){s("Cannot find scene to load");return}if(e.loaded){s(null,e);return}i.assets&&i.assets.prefix&&!ua.test(n)&&(n=ce.join(i.assets.prefix,n)),e._onLoadedCallbacks.push(s),e._loading||i.loader.getHandler("hierarchy").load(n,(a,l)=>{e.data=l,e._loading=!1;for(let h=0;h<e._onLoadedCallbacks.length;h++)e._onLoadedCallbacks[h](a,e);t||(e.data=null),e._onLoadedCallbacks.length=0}),e._loading=!0}loadSceneData(e,t){this._loadSceneData(e,!0,t)}unloadSceneData(e){typeof e=="string"&&(e=this.findByUrl(e)),e&&(e.data=null)}_loadSceneHierarchy(e,t,s){this._loadSceneData(e,!1,(i,n)=>{if(i){s&&s(i);return}t&&t(n);const r=this._app,a=()=>{const l=r.loader.getHandler("hierarchy");r.systems.script.preloading=!0;const h=l.open(n.url,n.data);r.systems.script.preloading=!1,r.loader.clearCache(n.url,"hierarchy"),r.root.addChild(h),r.systems.fire("initialize",h),r.systems.fire("postInitialize",h),r.systems.fire("postPostInitialize",h),s&&s(null,h)};r._preloadScripts(n.data,a)})}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t)}loadSceneSettings(e,t){this._loadSceneData(e,!1,(s,i)=>{s?t&&t(s):(this._app.applySceneSettings(i.data.settings),t&&t(null))})}changeScene(e,t){const s=this._app,i=n=>{const{children:r}=s.root;for(;r.length;)r[0].destroy();s.applySceneSettings(n.data.settings)};this._loadSceneHierarchy(e,i,t)}loadScene(e,t){const s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!ua.test(e)&&(e=ce.join(s.assets.prefix,e)),i.load(e,(n,r)=>{if(n)t&&t(n);else{const a=()=>{s.systems.script.preloading=!0;const l=i.open(e,r),h=this.findByUrl(e);h&&!h.loaded&&(h.data=r),s.systems.script.preloading=!1,s.loader.clearCache(e,"scene"),s.loader.patch({resource:l,type:"scene"},s.assets),s.root.addChild(l.root),s.systems.rigidbody&&typeof Ammo<"u"&&s.systems.rigidbody.gravity.set(l._gravity.x,l._gravity.y,l._gravity.z),t&&t(null,l)};s._preloadScripts(r,a)}})}}class MB{constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return qs().scene._stats}get lightmapper(){var e;return(e=qs().lightmapper)==null?void 0:e.stats}get batcher(){const e=qs()._batcher;return e?e._stats:null}}class BS{constructor(e){this.length=e,this.count=0}inc(){this.count++}done(){return this.count===this.length}}let y_=null;class nt extends Q{constructor(e){super(),this.frameRequestId=void 0,nt._applications[e.id]=this,p_(this),y_=this,this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=vt.legacy,this._librariesLoaded=!1,this._fillMode=Iu,this._resolutionMode=TS,this._allowResize=!0,this.context=this}init(e){const t=e.graphicsDevice;this.graphicsDevice=t,this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new MB(t),this._soundManager=e.soundManager,this.loader=new pa(this),this._entityIndex={},this.scene=new Vt(t),this._registerSceneImmediate(this.scene),this.root=new Ce,this.root._enabledInHierarchy=!0,this.assets=new fa(this.loader),e.assetPrefix&&(this.assets.prefix=e.assetPrefix),this.bundles=new PS(this.assets),this.enableBundles=typeof TextDecoder<"u",this.scriptsOrder=e.scriptsOrder||[],this.scripts=new LS(this),this.i18n=new DS(this),this.scenes=new OS(this),this.defaultLayerWorld=new ln({name:"World",id:is}),this.defaultLayerDepth=new ln({name:"Depth",id:kt,enabled:!1,opaqueSortMode:Gh}),this.defaultLayerSkybox=new ln({name:"Skybox",id:kd,opaqueSortMode:Gh}),this.defaultLayerUi=new ln({name:"UI",id:Fh,transparentSortMode:J0}),this.defaultLayerImmediate=new ln({name:"Immediate",id:Ds,opaqueSortMode:Gh});const s=new mu("default");s.pushOpaque(this.defaultLayerWorld),s.pushOpaque(this.defaultLayerDepth),s.pushOpaque(this.defaultLayerSkybox),s.pushTransparent(this.defaultLayerWorld),s.pushOpaque(this.defaultLayerImmediate),s.pushTransparent(this.defaultLayerImmediate),s.pushTransparent(this.defaultLayerUi),this.scene.layers=s,da.createPlaceholder(t),this.renderer=new fu(t),this.renderer.scene=this.scene,this.frameGraph=new iB,this.lightmapper=null,e.lightmapper&&(this.lightmapper=new e.lightmapper(t,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),this._batcher=null,e.batchManager&&(this._batcher=new e.batchManager(t,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=e.keyboard||null,this.mouse=e.mouse||null,this.touch=e.touch||null,this.gamepads=e.gamepads||null,this.elementInput=e.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.xr=e.xr?new e.xr(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=e.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new IS(this)),e.resourceHandlers.forEach(i=>{const n=new i(this);this.loader.addHandler(n.handlerType,n)}),this.systems=new RS,e.componentSystems.forEach(i=>{this.systems.add(new i(this))}),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),typeof document<"u"&&(document.hidden!==void 0?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):document.mozHidden!==void 0?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):document.msHidden!==void 0?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):document.webkitHidden!==void 0&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=PB(this)}static getApplication(e){return e?nt._applications[e]:qs()}_initDefaultMaterial(){const e=new Ct;e.name="Default Material",e.shadingModel=Qr,f2(this.graphicsDevice,e)}_initProgramLibrary(){const e=new h_(this.graphicsDevice,new Ct);cx(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){He.get(e,(s,i)=>{if(s){t(s);return}const n=i.application_properties,r=i.scenes,a=i.assets;this._parseApplicationProperties(n,l=>{this._parseScenes(r),this._parseAssets(a),t(l||null)})})}preload(e){this.fire("preload:start");const t=this.assets.list({preload:!0}),s=new BS(t.length);let i=!1;const n=()=>{this.graphicsDevice&&!i&&s.done()&&(i=!0,this.fire("preload:end"),e())},r=t.length;if(s.length){const a=h=>{s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()},l=(h,c)=>{s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()};for(let h=0;h<t.length;h++)t[h].loaded?(s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()):(t[h].once("load",a),t[h].once("error",l),this.assets.load(t[h]))}else n()}_preloadScripts(e,t){if(!vt.legacy){t();return}this.systems.script.preloading=!0;const s=this._getScriptReferences(e),i=s.length,n=new BS(i),r=/^http(s)?:\/\//;if(i){const a=(l,h)=>{l&&console.error(l),n.inc(),n.done()&&(this.systems.script.preloading=!1,t())};for(let l=0;l<i;l++){let h=s[l];!r.test(h.toLowerCase())&&this._scriptPrefix&&(h=ce.join(this._scriptPrefix,s[l])),this.loader.load(h,"script",a)}}else this.systems.script.preloading=!1,t()}_parseApplicationProperties(e,t){if(typeof e.maxAssetRetries=="number"&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){const s=new mu("application"),i={};for(const n in e.layers){const r=e.layers[n];r.id=parseInt(n,10),r.enabled=r.id!==kt,i[n]=new ln(r)}for(let n=0,r=e.layerOrder.length;n<r;n++){const a=e.layerOrder[n],l=i[a.layer];l&&(a.transparent?s.pushTransparent(l):s.pushOpaque(l),s.subLayerEnabled[n]=a.enabled)}this.scene.layers=s}if(e.batchGroups){const s=this.batcher;if(s)for(let i=0,n=e.batchGroups.length;i<n;i++){const r=e.batchGroups[i];s.addGroup(r.name,r.dynamic,r.maxAabbSize,r.id,r.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)}_loadLibraries(e,t){const s=e.length;let i=s;const n=/^http(s)?:\/\//;if(s){const r=(a,l)=>{i--,a?t(a):i===0&&(this.onLibrariesLoaded(),t(null))};for(let a=0;a<s;++a){let l=e[a];!n.test(l.toLowerCase())&&this._scriptPrefix&&(l=ce.join(this._scriptPrefix,l)),this.loader.load(l,"script",r)}}else this.onLibrariesLoaded(),t(null)}_parseScenes(e){if(e)for(let t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)}_parseAssets(e){const t=[],s={},i={};if(vt.legacy){if(this.enableBundles)for(const n in e)e[n].type==="bundle"&&(i[n]=!0,t.push(e[n]));for(const n in e)i[n]||t.push(e[n])}else{for(let n=0;n<this.scriptsOrder.length;n++){const r=this.scriptsOrder[n];e[r]&&(s[r]=!0,t.push(e[r]))}if(this.enableBundles)for(const n in e)e[n].type==="bundle"&&(i[n]=!0,t.push(e[n]));for(const n in e)s[n]||i[n]||t.push(e[n])}for(let n=0;n<t.length;n++){const r=t[n],a=new se(r.name,r.type,r.file,r.data);if(a.id=parseInt(r.id,10),a.preload=r.preload?r.preload:!1,a.loaded=r.type==="script"&&r.data&&r.data.loadingType>0,a.tags.add(r.tags),r.i18n)for(const l in r.i18n)a.addLocalizedAssetId(l,r.i18n[l]);this.assets.add(a)}}_getScriptReferences(e){let t=[];e.settings.priority_scripts&&(t=e.settings.priority_scripts);const s=[],i={};for(let r=0;r<t.length;r++)s.push(t[r]),i[t[r]]=!0;const n=e.entities;for(const r in n){if(!n[r].components.script)continue;const a=n[r].components.script.scripts;for(let l=0;l<a.length;l++)i[a[l].url]||(s.push(a[l].url),i[a[l].url]=!0)}return s}start(){this.frame=0,this.fire("start",{timestamp:jt(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.updateClientRect(),vt.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}frameStart(){this.graphicsDevice.frameStart()}frameEnd(){this.graphicsDevice.frameEnd()}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(e){this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(e,t,s){const i=this.stats.frame;i.dt=t,i.ms=s,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;const t=this.graphicsDevice._primsPerFrame;e.triangles=t[Js]/3+Math.max(t[As]-2,0)+Math.max(t[Xi]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let s=0;s<t.length;s++)s<Js&&(e.otherPrimitives+=t[s]),t[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,e=this.stats.drawCalls,e.forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,e=this.stats.particles,e.updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,t,s){this._fillMode=e,this.resizeCanvas(t,s)}setCanvasResolution(e,t,s){this._resolutionMode=e,e===f_&&t===void 0&&(t=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,t){if(!this._allowResize||this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if(this._fillMode===Iu){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height,r=s/i;n>r?(e=s,t=e/n):(t=i,e=t*n)}else this._fillMode===bS&&(e=s,t=i);return this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=t+"px",this.updateCanvasSize(),{width:e,height:t}}updateCanvasSize(){var e;if(!(!this._allowResize||(e=this.xr)!=null&&e.active)&&this._resolutionMode===f_){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){let t;if(this.systems.rigidbody&&typeof Ammo<"u"){const s=e.physics.gravity;this.systems.rigidbody.gravity.set(s[0],s[1],s[2])}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox),t?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(e,t){e&&t&&da.set(this.graphicsDevice,e,t)}setSkybox(e){if(e!==this._skyboxAsset){const t=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.on("change",s,this),this.scene.skyboxMip===0&&!this._skyboxAsset.loadFaces&&(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){var e;(e=this.lightmapper)==null||e.bake(null,this.scene.lightmapMode)}_firstBatch(){var e;(e=this.batcher)==null||e.generate()}_processTimestamp(e){return e}drawLine(e,t,s,i,n){this.scene.drawLine(e,t,s,i,n)}drawLines(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(e,t,s,i)}drawLineArrays(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(e,t,s,i)}drawWireSphere(e,t,s=H.WHITE,i=20,n=!0,r=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(e,t,s,i,n,r)}drawWireAlignedBox(e,t,s=H.WHITE,i=!0,n=this.scene.defaultDrawLayer,r){this.scene.immediate.drawWireAlignedBox(e,t,s,i,n,r)}drawMeshInstance(e,t=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,e,t)}drawMesh(e,t,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,s,e,null,i)}drawQuad(e,t,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(e,t,s,i,n,r,a=this.scene.defaultDrawLayer,l=!0){if(l===!1&&!this.graphicsDevice.isWebGPU)return;const h=new W;h.setTRS(new y(e,t,0),Z.IDENTITY,new y(s,-i,0)),r||(r=new pt,r.cull=Je,r.setParameter("colorMap",n),r.shader=l?this.scene.immediate.getTextureShader():this.scene.immediate.getUnfilterableTextureShader(),r.update()),this.drawQuad(h,r,a)}drawDepthTexture(e,t,s,i,n=this.scene.defaultDrawLayer){const r=new pt;r.cull=Je,r.shader=this.scene.immediate.getDepthTextureShader(),r.update(),this.drawTexture(e,t,s,i,null,r,n)}destroy(){var e,t,s,i;if(this._inFrameUpdate){this._destroyRequested=!0;return}const n=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),typeof document<"u"&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const r=this.assets.list();for(let l=0;l<r.length;l++)r[l].unload(),r[l].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;const a=this.loader.getHandler("script");a==null||a.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,(e=this.lightmapper)==null||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,(t=this.xr)==null||t.end(),(s=this.xr)==null||s.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),(i=this._soundManager)==null||i.destroy(),this._soundManager=null,vt.app=null,nt._applications[n]=null,qs()===this&&p_(null),nt.cancelTick(this)}static cancelTick(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}}nt._applications={};const v_={},PB=function(e){const t=e;return function(s,i){var n;if(!t.graphicsDevice)return;t.frameRequestId=null,t._inFrameUpdate=!0,p_(t),y_=t;const r=t._processTimestamp(s)||jt(),a=r-(t._time||r);let l=a/1e3;if(l=U.clamp(l,0,t.maxDeltaTime),l*=t.timeScale,t._time=r,(n=t.xr)!=null&&n.session?t.frameRequestId=t.xr.session.requestAnimationFrame(t.tick):t.frameRequestId=ge.browser?window.requestAnimationFrame(t.tick):null,t.graphicsDevice.contextLost)return;t._fillFrameStatsBasic(r,l,a),t.fire("frameupdate",a);let h=!0;if(i){var c;h=(c=t.xr)==null?void 0:c.update(i),t.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer}else t.graphicsDevice.defaultFramebuffer=null;h&&(t.update(l),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.updateCanvasSize(),t.frameStart(),t.render(),t.frameEnd(),t.renderNextFrame=!1),v_.timestamp=jt(),v_.target=t,t.fire("frameend",v_)),t._inFrameUpdate=!1,t._destroyRequested&&t.destroy()}};class NS{constructor(){this.elementInput=void 0,this.keyboard=void 0,this.mouse=void 0,this.touch=void 0,this.gamepads=void 0,this.scriptPrefix=void 0,this.assetPrefix=void 0,this.scriptsOrder=void 0,this.soundManager=void 0,this.graphicsDevice=void 0,this.lightmapper=void 0,this.batchManager=void 0,this.xr=void 0,this.componentSystems=[],this.resourceHandlers=[]}}const fc=new Cn;class kS{constructor(e,t){this.scene=e,this.light=t,this.store(),t.numCascades=1,t.type!==ae&&(t._node.getWorldTransform(),t.getBoundingSphere(fc),this.lightBounds=new ye,this.lightBounds.center.copy(fc.center),this.lightBounds.halfExtents.set(fc.radius,fc.radius,fc.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades}restore(){const e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades}startBake(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()}endBake(e){const t=this.light;t.enabled=!1,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null)}}const Bu=new G;class RB extends kS{get numVirtualLights(){return this.light.type===ae?this.light.bakeNumSamples:1}prepareVirtualLight(e,t){const s=this.light;if(s._node.setLocalRotation(this.rotation),e>0){const r=s.bakeArea;Jh.circlePointDeterministic(Bu,e,t),Bu.mulScalar(r*.5),s._node.rotateLocal(Bu.x,0,Bu.y)}s._node.getWorldTransform();const i=this.scene.gammaCorrection?2.2:1,n=Math.pow(this.intensity,i);s.intensity=Math.pow(n/t,1/i)}}const US=new y;class zS extends kS{constructor(e){const t=new Ce("AmbientLight");t.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:e.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:at,color:H.WHITE,intensity:1,bakeDir:!1}),super(e,t.light.light)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(e,t){Jh.spherePointDeterministic(US,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(US.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=this.scene.gammaCorrection?2.2:1,i=2*Math.PI*this.scene.ambientBakeSpherePart,n=Math.pow(i,s);this.light.intensity=Math.pow(n/t,1/s)}}class Nu{constructor(e,t=null){this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}const VS=15;class IB{constructor(e){this.device=e,this.shaderDilate=zt(e,z.fullscreenQuadVS,lc.dilatePS,"lmDilate"),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=null,this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(e){this.constantTexSource.setValue(e)}prepare(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(e,t){this.shaderDenoise||(this.shaderDenoise=zt(this.device,z.fullscreenQuadVS,lc.bilateralDeNoisePS,"lmBilateralDeNoise"),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t)}evaluateDenoiseUniforms(e,t){function s(a,l){return .39894*Math.exp(-.5*a*a/(l*l))/l}this.kernel=this.kernel||new Float32Array(VS);const i=this.kernel,n=Math.floor((VS-1)/2);for(let a=0;a<=n;++a){const l=s(a,e);i[n+a]=l,i[n-a]=l}this.constantKernel.setValue(this.kernel);const r=1/s(0,t);this.bZnorm.setValue(r)}}class DB extends Ot{constructor(e,t,s,i,n,r){super(e),this.viewBindGroups=[],this.renderer=t,this.camera=s,this.worldClusters=i,this.receivers=n,this.lightArray=r}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}execute(){this.device;const{renderer:e,camera:t,receivers:s,renderTarget:i,worldClusters:n,lightArray:r}=this;e.renderForwardLayer(t,i,null,void 0,di,this.viewBindGroups,{meshInstances:s,splitLights:r,lightClusters:n})}}const LB=2048,FB=0,OB=1,ku=new y;class GS{constructor(e,t,s,i,n){this.device=e,this.root=t,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new H,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){var e;nn.decRef(this.blackTex),this.blackTex=null,nn.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,(e=this.camera)==null||e.destroy(),this.camera=null}initBake(e){if(!this._initCalled){this._initCalled=!0,this.lightmapFilters=new IB(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new re(this.device,{width:4,height:4,format:oe,type:Cs,name:"lightmapBlack"}),nn.incRef(this.blackTex);const t=new sa;t.clearColor.set(0,0,0,0),t.clearColorBuffer=!0,t.clearDepthBuffer=!1,t.clearStencilBuffer=!1,t.frustumCulling=!1,t.projection=Yn,t.aspectRatio=1,t.node=new we,this.camera=t}if(this.scene.clusteredLightingEnabled){const t=new s_(e.supportsAreaLights,e.maxTextureSize,()=>{});this.lightingParams=t;const s=this.scene.lighting;t.shadowsEnabled=s.shadowsEnabled,t.shadowAtlasResolution=s.shadowAtlasResolution,t.cookiesEnabled=s.cookiesEnabled,t.cookieAtlasResolution=s.cookieAtlasResolution,t.areaLightsEnabled=s.areaLightsEnabled,t.cells=new y(3,3,3),t.maxLightsPerCell=4,this.worldClusters=new nu(e),this.worldClusters.name="ClusterLightmapper"}}finishBake(e){this.materials=[];function t(s){nn.decRef(s.colorBuffer),s.destroy()}this.renderTargets.forEach(s=>{t(s)}),this.renderTargets.clear(),e.forEach(s=>{s.renderTargets.forEach(i=>{t(i)}),s.renderTargets.length=0}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(e,t,s,i){const n=new Ct;n.name=`lmMaterial-pass:${s}-ambient:${i}`,n.chunks.APIVersion=fv;const r=`#define UV1LAYOUT
`;if(n.chunks.transformVS=r+z.transformVS,s===FB){let a=lc.bakeLmEndPS;i?a=`
										dDiffuseLight = ((dDiffuseLight - 0.5) * max(${t.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;
										dDiffuseLight += vec3(${t.ambientBakeOcclusionBrightness.toFixed(1)});
										dDiffuseLight = saturate(dDiffuseLight);
										dDiffuseLight *= dAmbientLight;
								`+a:(n.ambient=new H(0,0,0),n.ambientTint=!0),n.chunks.basePS=z.basePS+(t.lightmapPixelFormat===oe?`
#define LIGHTMAP_RGBM
`:""),n.chunks.endPS=a,n.lightMap=this.blackTex}else n.chunks.basePS=z.basePS+`
uniform sampler2D texture_dirLightMap;
uniform float bakeDir;
`,n.chunks.endPS=lc.bakeDirLmEndPS;return n.chunks.outputAlphaPS=`
`,n.chunks.outputAlphaOpaquePS=`
`,n.chunks.outputAlphaPremulPS=`
`,n.cull=Je,n.forceUv1=!0,n.update(),n}createMaterials(e,t,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(e,t,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(e,t,0,!0),this.ambientAOMaterial.onUpdateShader=function(i){return i.litOptions.lightMapWithoutAmbient=!0,i.litOptions.separateAmbient=!0,i})}createTexture(e,t){return new re(this.device,{width:e,height:e,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:this.scene.lightmapPixelFormat===oe?Cs:bt,minFilter:de,magFilter:de,addressU:q,addressV:q,name:t})}collectModels(e,t,s){var i,n,r;if(!e.enabled)return;let a;if((i=e.model)!=null&&i.model&&(n=e.model)!=null&&n.enabled&&(s&&s.push(new Nu(e)),e.model.lightmapped&&t&&(a=e.model.model.meshInstances)),(r=e.render)!=null&&r.enabled&&(s&&s.push(new Nu(e)),e.render.lightmapped&&t&&(a=e.render.meshInstances)),a){let l=!0;for(let h=0;h<a.length;h++)if(!a[h].mesh.vertexBuffer.format.hasUv1){l=!1;break}if(l){const h=[];for(let c=0;c<a.length;c++){const d=a[c].mesh;this._tempSet.has(d)?t.push(new Nu(e,[a[c]])):h.push(a[c]),this._tempSet.add(d)}this._tempSet.clear(),h.length>0&&t.push(new Nu(e,h))}}for(let l=0;l<e._children.length;l++)this.collectModels(e._children[l],t,s)}prepareShadowCasters(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const n=e[s].meshInstances;for(let r=0;r<n.length;r++)n[r].visibleThisFrame=!0,t.push(n[r])}}return t}updateTransforms(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;for(let i=0;i<s.length;i++)s[i].node.getWorldTransform()}}calculateLightmapSize(e){let t;const s=this.scene.lightmapSizeMultiplier||16,i=ku;let n,r;e.model?(r=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data,t.area&&(n=t.area)):e.model._area&&(t=e.model,t._area&&(n=t._area))):e.render&&(r=e.render.lightmapSizeMultiplier,e.render.type!=="asset"&&e.render._area&&(t=e.render,t._area&&(n=t._area)));const a={x:1,y:1,z:1,uv:1};n&&(a.x=n.x,a.y=n.y,a.z=n.z,a.uv=n.uv);const l=r||1;a.x*=l,a.y*=l,a.z*=l;const h=e.render||e.model,c=this.computeNodeBounds(h.meshInstances);i.copy(c.halfExtents);let d=a.x*i.y*i.z+a.y*i.x*i.z+a.z*i.x*i.y;return d/=a.uv,d=Math.sqrt(d),Math.min(U.nextPowerOfTwo(d*s),this.scene.lightmapMaxResolution||LB)}setLightmapping(e,t,s,i){for(let n=0;n<e.length;n++){const r=e[n],a=r.meshInstances;for(let l=0;l<a.length;l++){const h=a[l];if(h.setLightmapped(t),t){i&&(h._shaderDefs|=i),h.mask=hi;for(let c=0;c<s;c++){const d=r.renderTargets[c].colorBuffer;d.minFilter=Oe,d.magFilter=Oe,h.setRealtimeLightmap(Te.lightmapParamNames[c],d)}}}}}bake(e,t=zh){const s=this.device,i=jt();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,r=s._renderTargetCreationTime,a=s._shaderStats.compileTime,l=[],h=[];if(e){for(let d=0;d<e.length;d++)this.collectModels(e[d],l,null);this.collectModels(this.root,null,h)}else this.collectModels(this.root,l,h);if(l.length>0){this.renderer.shadowRenderer.frameUpdate();const d=t===zh?2:1;this.setLightmapping(l,!1,d),this.initBake(s),this.bakeInternal(d,l,h);let u=kh;t===zh&&(u|=Wd),this.scene.ambientBake&&(u|=Xd),this.setLightmapping(l,!0,d,u),this.finishBake(l)}const c=jt();this.stats.totalRenderTime=c-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-a,this.stats.fboTime=s._renderTargetCreationTime-r,this.stats.lightmapCount=l.length}allocateTextures(e,t){for(let s=0;s<e.length;s++){const i=e[s],n=this.calculateLightmapSize(i.node);for(let r=0;r<t;r++){const a=this.createTexture(n,"lightmapper_lightmap_"+s);nn.incRef(a),i.renderTargets[r]=new qe({colorBuffer:a,depth:!1})}if(!this.renderTargets.has(n)){const r=this.createTexture(n,"lightmapper_temp_lightmap_"+n);nn.incRef(r),this.renderTargets.set(n,new qe({colorBuffer:r,depth:!1}))}}}prepareLightsToBake(e,t,s){if(this.scene.ambientBake){const n=new zS(this.scene);s.push(n)}const i=this.renderer.lights;for(let n=0;n<i.length;n++){const r=i[n],a=new RB(this.scene,r);t.push(a),r.enabled&&r.mask&ci&&(r.mask=ci|hi|ns,r.shadowUpdateMode=r.type===ae?$d:Zn,s.push(a))}s.sort()}restoreLights(e){for(let t=0;t<e.length;t++)e[t].restore()}setupScene(){this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog=Dh,this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight)}computeNodeBounds(e){const t=new ye;if(e.length>0){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb)}return t}computeNodesBounds(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(s)}}computeBounds(e){const t=new ye;for(let s=0;s<e.length;s++){t.copy(e[0].aabb);for(let i=1;i<e.length;i++)t.add(e[i].aabb)}return t}backupMaterials(e){for(let t=0;t<e.length;t++)this.materials[t]=e[t].material}restoreMaterials(e){for(let t=0;t<e.length;t++)e[t].material=this.materials[t]}lightCameraPrepare(e,t){const s=t.light;let i;return s.type===Ie&&(i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=Os,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=s._outerConeAngle*2,this.renderer.updateCameraFrustum(i)),i}lightCameraPrepareAndCull(e,t,s,i){const n=e.light;let r=!0;if(n.type===ae){ku.copy(i.center),ku.y+=i.halfExtents.y,this.camera.node.setPosition(ku),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=i.halfExtents.y*2;const a=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=a}else e.lightBounds.intersects(t.bounds)||(r=!1);if(n.type===Ie){let a=!1;const l=t.meshInstances;for(let h=0;h<l.length;h++)if(l[h]._isVisible(s)){a=!0;break}a||(r=!1)}return r}setupLightArray(e,t){e[ae].length=0,e[be].length=0,e[Ie].length=0,e[t.type][0]=t,t.visibleThisFrame=!0}renderShadowMap(e,t,s,i){const n=i.light,r=this.scene.clusteredLightingEnabled,a=n.castShadows&&(!r||this.scene.lighting.shadowsEnabled);if(!t&&a)if(!n.shadowMap&&!r&&(n.shadowMap=this.shadowMapCache.get(this.device,n)),n.type===ae){this.renderer._shadowRendererDirectional.cull(n,e,this.camera,s);const l=this.renderer._shadowRendererDirectional.getLightRenderPass(n,this.camera);l==null||l.render()}else{if(this.device.isWebGPU)return!0;this.renderer._shadowRendererLocal.cull(n,e,s),this.renderer.shadowRenderer.render(n,this.camera,!1)}return!0}postprocessTextures(e,t,s){const n=this.lightmapFilters.shaderDilate,r=this.scene.lightmapFilterEnabled;r&&this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness),e.setBlendState(Ee.NOBLEND),e.setDepthState(ft.NODEPTH),e.setStencilState(null,null);for(let a=0;a<t.length;a++){const l=t[a];for(let h=0;h<s;h++){const c=l.renderTargets[h],d=c.colorBuffer,u=this.renderTargets.get(d.width),f=u.colorBuffer;this.lightmapFilters.prepare(d.width,d.height);for(let p=0;p<1;p++)this.lightmapFilters.setSourceTexture(d),_s(e,u,r&&h===0&&p===0?this.lightmapFilters.shaderDenoise:n),this.lightmapFilters.setSourceTexture(f),_s(e,c,n)}}}bakeInternal(e,t,s){const i=this.scene,n=i.layers,r=this.device,a=i.clusteredLightingEnabled;this.createMaterials(r,i,e),this.setupScene(),n._update(),this.computeNodesBounds(t),this.allocateTextures(t,e),this.renderer.collectLights(n);const l=[],h=[];this.prepareLightsToBake(n,l,h),this.updateTransforms(s);const c=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(c),this.renderer.gpuUpdate(c);const d=this.computeBounds(c);let u,f,p,_;for(u=0;u<t.length;u++)for(p=t[u].meshInstances,f=0;f<p.length;f++)_=p[f],_.setLightmapped(!1),_.mask=ci,_.setRealtimeLightmap(Te.lightmapParamNames[0],_.material.lightMap?_.material.lightMap:this.blackTex),_.setRealtimeLightmap(Te.lightmapParamNames[1],this.blackTex);for(f=0;f<h.length;f++)h[f].light.enabled=!1;const m=[[],[],[]];let g,x,S=!1;for(u=0;u<h.length;u++){const v=h[u],b=v instanceof zS,w=v.light.type===ae;let T=v.numVirtualLights;e>1&&T>1&&v.light.bakeDir&&(T=1);for(let E=0;E<T;E++){T>1&&v.prepareVirtualLight(E,T),v.startBake();let C=!1;const M=this.lightCameraPrepare(r,v);for(x=0;x<t.length;x++){const O=t[x];if(p=O.meshInstances,!this.lightCameraPrepareAndCull(v,O,M,d))continue;this.setupLightArray(m,v.light);const B=w?[]:[v.light];for(a&&this.renderer.lightTextureAtlas.update(B,this.lightingParams),C=this.renderShadowMap(n,C,c,v),a&&this.worldClusters.update(B,this.scene.gammaCorrection,this.lightingParams),this.backupMaterials(p),g=0;g<e&&!(g>0&&E>0||b&&g>0);g++){const P=O.renderTargets[g],D=O.renderTargets[g].colorBuffer.width,R=this.renderTargets.get(D),A=R.colorBuffer;g===0?S=i.updateShaders:S&&(i.updateShaders=!0);let L=this.passMaterials[g];for(b&&E+1===T&&g===0&&(L=this.ambientAOMaterial),f=0;f<p.length;f++)p[f].material=L;if(this.renderer.updateShaders(p),g===OB&&this.constantBakeDir.setValue(v.light.bakeDir?1:0),r.isWebGPU){const F=new DB(r,this.renderer,this.camera,a?this.worldClusters:null,p,m);F.init(R),F.render(),F.destroy()}else this.renderer.setCamera(this.camera,R,!0),a&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,p,m,di),r.updateEnd();for(O.renderTargets[g]=R,this.renderTargets.set(D,P),f=0;f<p.length;f++)_=p[f],_.setRealtimeLightmap(Te.lightmapParamNames[g],A),_._shaderDefs|=kh}this.restoreMaterials(p)}v.endBake(this.shadowMapCache)}}for(this.postprocessTextures(r,t,e),x=0;x<s.length;x++)s[x].restore();this.restoreLights(l),this.restoreScene(),a||this.shadowMapCache.clear()}}class he extends Q{constructor(e,t){super(),this.system=void 0,this.entity=void 0,this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(s,i,n){this.fire("set_"+s,s,i,n)}),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(e,t){t.forEach(function(s){const i=typeof s=="object"?s.name:s;Object.defineProperty(e,i,{get:function(){return this.data[i]},set:function(n){const r=this.data,a=r[i];r[i]=n,this.fire("set",i,a,n)},configurable:!0})}),e._accessorsBuilt=!0}buildAccessors(e){he._buildAccessors(this,e)}onSetEnabled(e,t,s){t!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}}class Ve extends Q{constructor(e){super(),this.app=e,this.store={},this.schema=[]}addComponent(e,t={}){const s=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=s,e.c[this.id]=s,this.initializeComponentData(s,t,[]),this.fire("add",e,s),s}removeComponent(e){const t=this.store[e.getGuid()],s=e.c[this.id];this.fire("beforeremove",e,s),delete this.store[e.getGuid()],e[this.id]=void 0,delete e.c[this.id],this.fire("remove",e,t.data)}cloneComponent(e,t){const s=this.store[e.getGuid()];return this.addComponent(t,s.data)}initializeComponentData(e,t={},s){for(let i=0,n=s.length;i<n;i++){const r=s[i];let a,l;typeof r=="object"?(a=r.name,l=r.type):(a=r,l=void 0);let h=t[a];h!==void 0?(l!==void 0&&(h=BB(h,l)),e[a]=h):e[a]=e.data[a]}e.enabled&&e.entity.enabled&&e.onEnable()}getPropertiesOfType(e){const t=[];return(this.schema||[]).forEach(function(i){i&&typeof i=="object"&&i.type===e&&t.push(i)}),t}destroy(){this.off()}}function BB(o,e){if(!o)return o;switch(e){case"rgb":return o instanceof H?o.clone():new H(o[0],o[1],o[2]);case"rgba":return o instanceof H?o.clone():new H(o[0],o[1],o[2],o[3]);case"vec2":return o instanceof G?o.clone():new G(o[0],o[1]);case"vec3":return o instanceof y?o.clone():new y(o[0],o[1],o[2]);case"vec4":return o instanceof X?o.clone():new X(o[0],o[1],o[2],o[3]);case"boolean":case"number":case"string":return o;case"entity":return o;default:throw new Error("Could not convert unhandled type: "+e)}}const x_=0,Uu=1,zu=2;class NB{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(e,t){if(e<this._left||e>=this._right){const s=t.length;if(!s)this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0;else if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[s-1])this._left=t[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const i=this._findKey(e,t);this._left=t[i],this._right=t[i+1],this._len=this._right-this._left;const n=1/this._len;this._recip=isFinite(n)?n:0,this._p0=i,this._p1=i+1}}this._t=this._recip===0?0:(e-this._left)*this._recip,this._hermite.valid=!1}_findKey(e,t){let s=0;for(;e>=t[s+1];)s++;return s}eval(e,t,s){const i=s._data,n=s._components,r=this._p0*n;if(t===x_)for(let a=0;a<n;++a)e[a]=i[r+a];else{const a=this._t,l=this._p1*n;switch(t){case Uu:for(let h=0;h<n;++h)e[h]=U.lerp(i[r+h],i[l+h],a);break;case zu:{const h=this._hermite;if(!h.valid){const p=a*a,_=a+a,m=1-a,g=m*m;h.valid=!0,h.p0=(1+_)*g,h.m0=a*g,h.p1=p*(3-_),h.m1=p*(a-1)}const c=(this._p0*3+1)*n,d=(this._p0*3+2)*n,u=(this._p1*3+1)*n,f=(this._p1*3+0)*n;for(let p=0;p<n;++p)e[p]=h.p0*i[c+p]+h.m0*i[d+p]*this._len+h.p1*i[u+p]+h.m1*i[f+p]*this._len;break}}}}}class S_{constructor(e){this._name=e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let i=0;i<e._inputs.length;++i)this._cache[i]=new NB;const t=e._curves,s=e._outputs;for(let i=0;i<t.length;++i){const n=t[i],r=s[n._output],a=[];for(let l=0;l<r._components;++l)a[l]=0;this._results[i]=a}}}class ma{constructor(e,t,s,i,n,r){this._name=e.name,this._track=e,this._snapshot=new S_(e),this._playing=i,this._time=t,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=r,this.alignCursorToCurrentTime()}set name(e){this._name=e}get name(){return this._name}set track(e){this._track=e,this._snapshot=new S_(e)}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(e){const t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return this.nextEvent?this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e:!1}nextEventBehindTime(e){return this.nextEvent?e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e:!1}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(e){const t=ma.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,gt({track:this.track},this.nextEvent)),this.moveEventCursor()}fireNextEventInFrame(e,t){return this.nextEventAheadOfTime(e)&&this.nextEventBehindTime(t)?(this.fireNextEvent(),!0):!1}activeEventsForFrame(e,t){const s=ma.eventFrame;this.clipFrameTime(t);const i=this.eventCursor;for(;this.fireNextEventInFrame(e,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){let t=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>s&&(n?t=t%s||0:(t=this._track.duration,this.pause())):t<0&&(n?t=s+(t%s||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}ma.eventFrame={start:0,end:0,residual:0};const b_="NONE",WS="PREV_STATE",HS="NEXT_STATE",XS="PREV_STATE_NEXT_STATE",$S="NEXT_STATE_PREV_STATE",qS="GREATER_THAN",jS="LESS_THAN",YS="GREATER_THAN_EQUAL_TO",KS="LESS_THAN_EQUAL_TO",ZS="EQUAL_TO",QS="NOT_EQUAL_TO",T_="INTEGER",w_="FLOAT",E_="BOOLEAN",pc="TRIGGER",JS="1D",eb="2D_DIRECTIONAL",tb="2D_CARTESIAN",sb="DIRECT",cl="START",Vu="END",rr="ANY",mc=[cl,Vu,rr],A_="OVERWRITE",ib="ADDITIVE";class Pt{static dot(e,t){const s=e.length;let i=0;for(let n=0;n<s;++n)i+=e[n]*t[n];return i}static normalize(e){let t=Pt.dot(e,e);if(t>0){t=1/Math.sqrt(t);const s=e.length;for(let i=0;i<s;++i)e[i]*=t}}static set(e,t,s){const i=e.length;if(s==="quaternion"){let n=Pt.dot(t,t);n>0&&(n=1/Math.sqrt(n));for(let r=0;r<i;++r)e[r]=t[r]*n}else for(let n=0;n<i;++n)e[n]=t[n]}static blendVec(e,t,s,i){const n=i?1:1-s,r=e.length;for(let a=0;a<r;++a)e[a]=e[a]*n+t[a]*s}static blendQuat(e,t,s,i){const n=e.length,r=i?1:1-s;Pt.dot(e,t)<0&&(s=-s);for(let a=0;a<n;++a)e[a]=e[a]*r+t[a]*s;i||Pt.normalize(e)}static blend(e,t,s,i,n){i==="quaternion"?Pt.blendQuat(e,t,s,n):Pt.blendVec(e,t,s,n)}static stableSort(e,t){const s=e.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(t(e[n],e[i])){const r=e[i];e[i]=e[n],e[n]=r}}}class ke{constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=!0,this.value=t===ke.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return this.dirty&&this.updateWeights(),this._normalizeWeights&&this.totalWeight===0||!this.mask[e]?0:this._normalizeWeights?this.weights[e]/this.totalWeight:U.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===A_&&(this.mask=this.mask.fill(0,0,e)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=!1}updateValue(e,t){if(this.counter===0&&(Pt.set(this.value,ke.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||Pt.blend(this.value,this.baseValue,1,this.valueType)),!(!this.mask[e]||this.getWeight(e)===0)){if(this._layerBlendType(e)===ib&&!this._normalizeWeights)if(this.valueType===ke.TYPE_QUAT){const s=ke.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=ke.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=ke.q3.set(t[0],t[1],t[2],t[3]),r=i.invert().mul(n);r.slerp(Z.IDENTITY,r,this.getWeight(e)),s.mul(r),ke.quatArr[0]=s.x,ke.quatArr[1]=s.y,ke.quatArr[2]=s.z,ke.quatArr[3]=s.w,Pt.set(this.value,ke.quatArr,this.valueType)}else ke.vecArr[0]=t[0]-this.baseValue[0],ke.vecArr[1]=t[1]-this.baseValue[1],ke.vecArr[2]=t[2]-this.baseValue[2],Pt.blend(this.value,ke.vecArr,this.getWeight(e),this.valueType,!0);else Pt.blend(this.value,t,this.getWeight(e),this.valueType);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}}ke.TYPE_QUAT="quaternion",ke.TYPE_VEC3="vector3",ke.q1=new Z,ke.q2=new Z,ke.q3=new Z,ke.quatArr=[0,0,0,1],ke.vecArr=[0,0,0],ke.IDENTITY_QUAT_ARR=[0,0,0,1];class C_{constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}addClip(e){const t=this._targets,s=this._binder,i=e.track.curves,n=e.snapshot,r=[],a=[];for(let l=0;l<i.length;++l){const c=i[l].paths;for(let d=0;d<c.length;++d){const u=c[d],f=s.resolve(u);let p=t[f&&f.targetPath||null];if(!p&&f){p={target:f,value:[],curves:0,blendCounter:0};for(let _=0;_<p.target.components;++_)p.value.push(0);if(t[f.targetPath]=p,s.animComponent){if(!s.animComponent.targets[f.targetPath]){let _;f.targetPath.substring(f.targetPath.length-13)==="localRotation"?_=ke.TYPE_QUAT:_=ke.TYPE_VEC3,s.animComponent.targets[f.targetPath]=new ke(s.animComponent,_)}s.animComponent.targets[f.targetPath].layerCounter++,s.animComponent.targets[f.targetPath].setMask(s.layerIndex,1)}}p&&(p.curves++,r.push(n._results[l]),a.push(p))}}this._clips.push(e),this._inputs.push(r),this._outputs.push(a)}removeClip(e){const t=this._targets,s=this._binder,i=this._clips,r=i[e].track.curves;for(let a=0;a<r.length;++a){const h=r[a].paths;for(let c=0;c<h.length;++c){const d=h[c],u=this._binder.resolve(d);u&&(u.curves--,u.curves===0&&(s.unresolve(d),delete t[u.targetPath],s.animComponent&&s.animComponent.targets[u.targetPath].layerCounter--))}}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(e,t){this._clips.forEach(s=>{s.name.includes(e)&&(s.track=t)}),this.rebind()}findClip(e){const t=this._clips;for(let s=0;s<t.length;++s){const i=t[s];if(i.name===e)return i}return null}rebind(){this._binder.rebind(),this._targets={};const e=[...this.clips];this.removeClips(),e.forEach(t=>{this.addClip(t)})}assignMask(e){return this._binder.assignMask(e)}update(e,t=!0){const s=this._clips,i=s.map(function(a,l){return l});Pt.stableSort(i,function(a,l){return s[a].blendOrder<s[l].blendOrder});for(let a=0;a<i.length;++a){const l=i[a],h=s[l],c=this._inputs[l],d=this._outputs[l],u=h.blendWeight;if(u>0&&h._update(e),!t)break;let f,p,_;if(u>=1)for(let m=0;m<c.length;++m)f=c[m],p=d[m],_=p.value,Pt.set(_,f,p.target.type),p.blendCounter++;else if(u>0)for(let m=0;m<c.length;++m)f=c[m],p=d[m],_=p.value,p.blendCounter===0?Pt.set(_,f,p.target.type):Pt.blend(_,f,u,p.target.type),p.blendCounter++}const n=this._targets,r=this._binder;for(const a in n)if(n.hasOwnProperty(a)){const l=n[a];if(r.animComponent&&l.target.isTransform){const h=r.animComponent.targets[a];h.counter===h.layerCounter&&(h.counter=0),h.path||(h.path=a,h.baseValue=l.target.get(),h.setter=l.target.set),h.updateValue(r.layerIndex,l.value),h.counter++}else l.target.set(l.value);l.blendCounter=0}this._binder.update(e)}}class M_{constructor(e){this._events=[...e],this._events.sort((t,s)=>t.time-s.time)}get events(){return this._events}}var nb;class ki{constructor(e,t,s,i,n,r=new M_([])){this._name=e,this._duration=t,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=r}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e}get events(){return this._animEvents.events}eval(e,t){t._time=e;const s=this._inputs,i=this._outputs,n=this._curves,r=t._cache,a=t._results;for(let l=0;l<s.length;++l)r[l].update(e,s[l]._data);for(let l=0;l<n.length;++l){const h=n[l],c=i[h._output],d=a[l];r[h._input].eval(d,h._interpolation,c)}}}nb=ki,ki.EMPTY=Object.freeze(new nb("empty",Number.MAX_VALUE,[],[],[]));class _a{static joinPath(e,t){t=t||".";const s=function(n){return n.replace(/\\/g,"\\\\").replace(new RegExp("\\"+t,"g"),"\\"+t)};return e.map(s).join(t)}static splitPath(e,t){t=t||".";const s=[];let i="",n=0;for(;n<e.length;){let r=e[n++];r==="\\"&&n<e.length?(r=e[n++],r==="\\"||r===t?i+=r:i+="\\"+r):r===t?(s.push(i),i=""):i+=r}return i.length>0&&s.push(i),s}static encode(e,t,s){return`${Array.isArray(e)?e.join("/"):e}/${t}/${Array.isArray(s)?s.join("/"):s}`}resolve(e){return null}unresolve(e){}update(e){}}class Gu{constructor(e,t,s,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=s,this._targetPath=i,this._isTransform=this._targetPath.substring(this._targetPath.length-13)==="localRotation"||this._targetPath.substring(this._targetPath.length-13)==="localPosition"||this._targetPath.substring(this._targetPath.length-10)==="localScale"}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class pn{constructor(e){if(this._isPathInMask=(n,r)=>{const a=this._mask[n];if(a){if(a.children||r&&a.value!==!1)return!0}else return!1;return!1},this.graph=e,!e)return;this._mask=null;const t={};(function n(r){t[r.name]=r;for(let a=0;a<r.children.length;++a)n(r.children[a])})(e),this.nodes=t,this.targetCache={};const i=function(r){let a=r;for(;a&&!(a instanceof Ce);)a=a.parent;let l;return a&&(a.render?l=a.render.meshInstances:a.model&&(l=a.model.meshInstances)),l};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(n){const r=n.localPosition,a=function(h){r.set(...h)};return pn.createAnimTarget(a,"vector",3,n,"localPosition")},localRotation:function(n){const r=n.localRotation,a=function(h){r.set(...h)};return pn.createAnimTarget(a,"quaternion",4,n,"localRotation")},localScale:function(n){const r=n.localScale,a=function(h){r.set(...h)};return pn.createAnimTarget(a,"vector",3,n,"localScale")},weight:function(n,r){r.indexOf("name.")===0?r=r.replace("name.",""):r=Number(r);const a=i(n);let l;if(a){for(let h=0;h<a.length;++h)if(a[h].node.name===n.name&&a[h].morphInstance){const c=a[h].morphInstance,d=u=>{c.setWeight(r,u[0])};l||(l=[]),l.push(d)}}if(l){const h=c=>{for(let d=0;d<l.length;++d)l[d](c)};return pn.createAnimTarget(h,"number",1,n,`weight.${r}`)}return null},materialTexture:(n,r)=>{const a=i(n);if(a){let l;for(let h=0;h<a.length;++h)if(a[h].node.name===n.name){l=a[h];break}if(l){const h=c=>{const d=this.animComponent.system.app.assets.get(c[0]);d&&d.resource&&d.type==="texture"&&(l.material[r]=d.resource,l.material.update())};return pn.createAnimTarget(h,"vector",1,n,"materialTexture","material")}}return null}}}_isPathActive(e){if(!this._mask)return!0;const t=[e.entityPath[0],this.graph.name];for(let s=0;s<t.length;++s){let i=t[s];if(this._isPathInMask(i,e.entityPath.length===1))return!0;for(let n=1;n<e.entityPath.length;n++)if(i+="/"+e.entityPath[n],this._isPathInMask(i,n===e.entityPath.length-1))return!0}return!1}findNode(e){if(!this._isPathActive(e))return null;let t;return this.graph&&(t=this.graph.findByPath(e.entityPath),t||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t}static createAnimTarget(e,t,s,i,n,r){const a=_a.encode(i.path,r||"entity",n);return new Gu(e,t,s,a)}resolve(e){const t=_a.encode(e.entityPath,e.component,e.propertyPath);let s=this.targetCache[t];if(s)return s;const i=this.findNode(e);if(!i)return null;const n=this.handlers[e.propertyPath];return!n||(s=n(i),!s)?null:(this.targetCache[t]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s)}unresolve(e){if(e.component!=="graph")return;const t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,this.nodeCounts[t.path]===0){const s=this.activeNodes,i=s.indexOf(t.node),n=s.length;i<n-1&&(s[i]=s[n-1]),s.pop()}}update(e){const t=this.activeNodes;for(let s=0;s<t.length;++s)t[s]._dirtifyLocal()}assignMask(e){return e!==this._mask?(this._mask=e,!0):!1}}class P_ extends he{constructor(e,t){super(e,t),this._animations={},this._assets=[],this._loop=!0,this.animEvaluator=null,this.model=null,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animationsIndex={},this.prevAnim=null,this.currAnim=null,this.blend=0,this.blending=!1,this.blendSpeed=0,this.activate=!0,this.speed=1}set animations(e){this._animations=e,this.onSetAnimations()}get animations(){return this._animations}set assets(e){const t=this._assets;if(t&&t.length){for(let i=0;i<t.length;i++)if(t[i]){const n=this.system.app.assets.get(t[i]);if(n){n.off("change",this.onAssetChanged,this),n.off("remove",this.onAssetRemoved,this);const r=this.animationsIndex[n.id];this.currAnim===r&&this._stopCurrentAnimation(),delete this.animations[r],delete this.animationsIndex[n.id]}}}this._assets=e;const s=e.map(i=>i instanceof se?i.id:i);this.loadAnimationAssets(s)}get assets(){return this._assets}set currentTime(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator){const t=this.animEvaluator.clips;for(let s=0;s<t.length;++s)t[s].time=e}}get currentTime(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){const e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.currAnim?this.animations[this.currAnim].duration:0}set loop(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(let t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].loop=e}get loop(){return this._loop}play(e,t=0){if(!(!this.enabled||!this.entity.enabled)&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){!this.skeleton&&!this.animEvaluator&&this._createAnimationController();const s=this.animations[this.prevAnim],i=this.animations[this.currAnim];if(this.blending=t>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/t),this.skeleton&&(this.blending?(this.fromSkel.animation=s,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=i):this.skeleton.animation=i),this.animEvaluator){const n=this.animEvaluator;if(this.blending)for(;n.clips.length>1;)n.removeClip(0);else this.animEvaluator.removeClips();const r=new ma(this.animations[this.currAnim],0,1,!0,this.loop);r.name=this.currAnim,r.blendWeight=this.blending?0:1,r.reset(),this.animEvaluator.addClip(r)}}this.playing=!0}}getAnimation(e){return this.animations[e]}setModel(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim))}onSetAnimations(){const e=this.entity.model;if(e){const t=e.model;t&&t!==this.model&&this.setModel(t)}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){const t=Object.keys(this._animations);t.length>0&&this.play(t[0])}}_resetAnimationController(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}_createAnimationController(){const e=this.model,t=this.animations;let s=!1,i=!1;for(const r in t)t.hasOwnProperty(r)&&(t[r].constructor===ki?i=!0:s=!0);const n=e.getGraph();s?(this.fromSkel=new $s(n),this.toSkel=new $s(n),this.skeleton=new $s(n),this.skeleton.looping=this.loop,this.skeleton.setGraph(n)):i&&(this.animEvaluator=new C_(new pn(this.entity)))}loadAnimationAssets(e){if(!e||!e.length)return;const t=this.system.app.assets,s=n=>{if(n.resources.length>1)for(let r=0;r<n.resources.length;r++)this.animations[n.resources[r].name]=n.resources[r],this.animationsIndex[n.id]=n.resources[r].name;else this.animations[n.name]=n.resource,this.animationsIndex[n.id]=n.name;this.animations=this.animations},i=n=>{n.off("change",this.onAssetChanged,this),n.on("change",this.onAssetChanged,this),n.off("remove",this.onAssetRemoved,this),n.on("remove",this.onAssetRemoved,this),n.resource?s(n):(n.once("load",s,this),this.enabled&&this.entity.enabled&&t.load(n))};for(let n=0,r=e.length;n<r;n++){const a=t.get(e[n]);a?i(a):t.on("add:"+e[n],i)}}onAssetChanged(e,t,s,i){if(t==="resource"||t==="resources")if(t==="resources"&&s&&s.length===0&&(s=null),s){let n=!1;if(s.length>1){if(i&&i.length>1)for(let r=0;r<i.length;r++)delete this.animations[i[r].name];else delete this.animations[e.name];n=!1;for(let r=0;r<s.length;r++)this.animations[s[r].name]=s[r],!n&&this.currAnim===s[r].name&&this.playing&&this.enabled&&this.entity.enabled&&(n=!0,this.play(s[r].name));n||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let r=0;r<i.length;r++)delete this.animations[i[r].name];this.animations[e.name]=s[0]||s,n=!1,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(n=!0,this.play(e.name)),n||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[e.id]=e.name}else{if(i.length>1)for(let n=0;n<i.length;n++)delete this.animations[i[n].name],this.currAnim===i[n].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}onAssetRemoved(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}_stopCurrentAnimation(){if(this.currAnim=null,this.playing=!1,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(let e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips()}}onEnable(){super.onEnable();const e=this.assets,t=this.system.app.assets;if(e)for(let s=0,i=e.length;s<i;s++){let n=e[s];n instanceof se||(n=t.get(n)),n&&!n.resource&&t.load(n)}if(this.activate&&!this.currAnim){const s=Object.keys(this.animations);s.length>0&&this.play(s[0])}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let t=this.assets[e];typeof t=="number"&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}update(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){const s=this.skeleton;if(s!==null&&this.model!==null){if(this.blending)s.blend(this.fromSkel,this.toSkel,this.blend);else{const i=e*this.speed;s.addTime(i),this.speed>0&&s._time===s.animation.duration&&!this.loop?this.playing=!1:this.speed<0&&s._time===0&&!this.loop&&(this.playing=!1)}this.blending&&this.blend===1&&(s.animation=this.toSkel.animation),s.updateGraph()}}const t=this.animEvaluator;if(t){for(let s=0;s<t.clips.length;++s){const i=t.clips[s];i.speed=this.speed,this.playing?i.resume():i.pause()}this.blending&&t.clips.length>1&&(t.clips[1].blendWeight=this.blend),t.update(e)}this.blending&&this.blend===1&&(this.blending=!1)}}class kB{constructor(){this.enabled=!0}}const R_=["enabled"];class rb extends Ve{constructor(e){super(e),this.id="animation",this.ComponentType=P_,this.DataType=kB,this.schema=R_,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["activate","enabled","loop","speed","assets"];for(const i of s)t.hasOwnProperty(i)&&(e[i]=t[i]);super.initializeComponentData(e,t,R_)}cloneComponent(e,t){this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.speed=e.animation.speed,t.animation.loop=e.animation.loop,t.animation.activate=e.animation.activate,t.animation.enabled=e.animation.enabled;const s={},i=e.animation.animations;for(const a in i)i.hasOwnProperty(a)&&(s[a]=i[a]);t.animation.animations=s;const n={},r=e.animation.animationsIndex;for(const a in r)r.hasOwnProperty(a)&&(n[a]=r[a]);return t.animation.animationsIndex=n,t.animation}onBeforeRemove(e,t){t.onBeforeRemove()}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];i.data.enabled&&i.entity.enabled&&i.entity.animation.update(e)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}he._buildAccessors(P_.prototype,R_);class _c{constructor(e,t,s,i,n=1){this._state=e,this._parent=t,this._name=s,Array.isArray(i)?(this._point=new G(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const e=this._state.totalWeight;return e===0?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e}get animTrack(){return this._animTrack}}class dl extends _c{constructor(e,t,s,i,n,r,a,l,h){super(e,t,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=h,this._syncAnimations=a!==!1,this._pointCache={};for(let c=0;c<r.length;c++){const d=r[c];d.children?this._children.push(l(d.type,this,null,s,1,d.parameter?[d.parameter]:d.parameters,d.children,l,h)):this._children.push(new _c(e,this,d.name,d.point,d.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(let t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){let e=!0;for(let t=0;t<this._parameterValues.length;t++){const s=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==s&&(this._parameterValues[t]=s,e=!1)}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){let e=0;for(let t=0;t<this._children.length;t++)this._children[t].constructor===dl?e+=this._children[t].getNodeCount():e++;return e}}class UB extends dl{constructor(e,t,s,i,n,r,a,l,h){r.sort((c,d)=>c.point-d.point),super(e,t,s,i,n,r,a,l,h)}calculateWeights(){if(this.updateParameterValues())return;let e=0;this._children[0].weight=0;for(let t=0;t<this._children.length;t++){const s=this._children[t];if(t!==this._children.length-1){const i=this._children[t+1];if(s.point===i.point)s.weight=.5,i.weight=.5;else if(U.between(this._parameterValues[0],s.point,i.point,!0)){const n=Math.abs(s.point-i.point),r=Math.abs(s.point-this._parameterValues[0]),a=(n-r)/n;s.weight=a,i.weight=1-a}else i.weight=0}this._syncAnimations&&(e+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let t=0;t<this._children.length;t++){const s=this._children[t];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/e}}}class mn extends dl{pointDistanceCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;mn._p.set(...this._parameterValues),e=0,t=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;mn._pip.set(mn._p.x,mn._p.y).sub(n);let r=Number.MAX_VALUE;for(let a=0;a<this._children.length;a++){if(s===a)continue;const l=this.pointDistanceCache(s,a),h=U.clamp(1-mn._pip.dot(l)/l.lengthSq(),0,1);h<r&&(r=h)}i.weight=r,e+=r,this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)}}}mn._p=new G,mn._pip=new G;class _n extends dl{pointCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=new G((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),G.angleRad(this._children[e].point,this._children[t].point)*2)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;_n._p.set(...this._parameterValues);const s=_n._p.length();e=0,t=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],r=n.point,a=n.pointLength;let l=Number.MAX_VALUE;for(let h=0;h<this._children.length;h++){if(i===h)continue;const c=this.pointCache(i,h),d=this._children[h].pointLength;_n._pip.set((s-a)/((d+a)/2),G.angleRad(r,_n._p)*2);const u=U.clamp(1-Math.abs(_n._pip.dot(c)/c.lengthSq()),0,1);u<l&&(l=u)}n.weight=l,e+=l,this._syncAnimations&&(t+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let i=0;i<this._children.length;i++){const n=this._children[i];if(n.weight=n._weight/e,this._syncAnimations){const r=n.animTrack.duration/t*e;n.weightedSpeed=n.absoluteSpeed*r}}}}_n._p=new G,_n._pip=new G;class zB extends dl{calculateWeights(){if(this.updateParameterValues())return;let e=0,t=0;for(let s=0;s<this._children.length;s++)if(e+=Math.max(this._parameterValues[s],0),this._syncAnimations){const i=this._children[s];t+=i.animTrack.duration/i.absoluteSpeed*i.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s],n=Math.max(this._parameterValues[s],0);e?(i.weight=n/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}class ab{constructor(e,t,s=1,i=!0,n){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=s,this._loop=i,this._hasAnimations=!1,n?this._blendTree=this._createTree(n.type,this,null,t,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,this._controller.findParameter):this._blendTree=new _c(this,null,t,1,s)}_createTree(e,t,s,i,n,r,a,l,h,c){switch(e){case JS:return new UB(t,s,i,n,r,a,l,h,c);case tb:return new mn(t,s,i,n,r,a,l,h,c);case eb:return new _n(t,s,i,n,r,a,l,h,c);case sb:return new zB(t,s,i,n,r,a,l,h,c)}}_getNodeFromPath(e){let t=this._blendTree;for(let s=1;s<e.length;s++)t=t.getChild(e[s]);return t}addAnimation(e,t){const s=e.join("."),i=this._animationList.findIndex(function(n){return n.path===s});if(i>=0)this._animationList[i].animTrack=t;else{const n=this._getNodeFromPath(e);n.animTrack=t,this._animationList.push(n)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every(e=>e.animTrack&&e.animTrack!==ki.EMPTY)}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}get nodeCount(){return!this._blendTree||this._blendTree.constructor===_c?1:this._blendTree.getNodeCount()}get playable(){return mc.indexOf(this.name)!==-1||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const e=this.name+"."+this.animations[0].animTrack.name,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}get totalWeight(){let e=0;for(let t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){let e=0;for(let t=0;t<this.animations.length;t++){const s=this.animations[t];s.animTrack.duration>e&&(e=s.animTrack.duration)}return e}}class Wu{constructor({from:e,to:t,time:s=0,priority:i=0,conditions:n=[],exitTime:r=null,transitionOffset:a=null,interruptionSource:l=b_}){this._from=e,this._to=t,this._time=s,this._priority=i,this._conditions=n,this._exitTime=r,this._transitionOffset=a,this._interruptionSource=l}get from(){return this._from}set to(e){this._to=e}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class ob{constructor(e,t,s,i,n,r,a){this.findParameter=l=>this._findParameter(l),this._animEvaluator=e,this._states={},this._stateNames=[],this._eventHandler=n,this._findParameter=r,this._consumeTrigger=a;for(let l=0;l<t.length;l++)this._states[t[l].name]=new ab(this,t[l].name,t[l].speed,t[l].loop,t[l].blendTree),this._stateNames.push(t[l].name);this._transitions=s.map(l=>new Wu(gt({},l))),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=cl,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._activate=i,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=b_,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let e=!0;for(let t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}set playing(e){this._playing=e}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let e=0;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this._animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(e=Math.max(e,s.track.duration))}this._activeStateDuration=e,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this.animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(s.time=e)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===cl||this.activeStateName===Vu||this.activeStateName===rr)return 1;const t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){let t=this._findTransitionsFromStateCache[e];return t||(t=this._transitions.filter(function(s){return s.from===e}),nc(t),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){let s=this._findTransitionsBetweenStatesCache[e+"->"+t];return s||(s=this._transitions.filter(function(i){return i.from===e&&i.to===t}),nc(s),this._findTransitionsBetweenStatesCache[e+"->"+t]=s),s}_transitionHasConditionsMet(e){const t=e.conditions;for(let s=0;s<t.length;s++){const i=t[s],n=this._findParameter(i.parameterName);switch(i.predicate){case qS:if(!(n.value>i.value))return!1;break;case jS:if(!(n.value<i.value))return!1;break;case YS:if(!(n.value>=i.value))return!1;break;case KS:if(!(n.value<=i.value))return!1;break;case ZS:if(n.value!==i.value)return!1;break;case QS:if(n.value===i.value)return!1;break}}return!0}_findTransition(e,t){let s=[];if(e&&t)s=s.concat(this._findTransitionsBetweenStates(e,t));else if(!this._isTransitioning)s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(rr));else switch(this._transitionInterruptionSource){case WS:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(rr));break;case HS:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(rr));break;case XS:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(rr));break;case $S:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(rr));break}if(s=s.filter(i=>{if(i.to===this.activeStateName)return!1;if(i.hasExitTime){let n=this._getActiveStateProgressForTime(this._timeInStateBefore),r=this._getActiveStateProgressForTime(this._timeInState);if(i.exitTime<1&&this.activeState.loop&&(n-=Math.floor(n),r-=Math.floor(r)),r===n){if(r!==i.exitTime)return null}else if(!(i.exitTime>n&&i.exitTime<=r))return null}return this._transitionHasConditionsMet(i)}),s.length>0){const i=s[0];if(i.to===Vu){const n=this._findTransitionsFromState(cl)[0];i.to=n.to}return i}return null}updateStateFromTransition(e){let t,s,i;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=!0;for(let h=0;h<e.conditions.length;h++){const c=e.conditions[h];this._findParameter(c.parameterName).type===pc&&this._consumeTrigger(c.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const h=Math.min(this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1,1);for(let c=0;c<this._transitionPreviousStates.length;c++){this._isTransitioning?c!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[c].weight*=1-h:this._transitionPreviousStates[c].weight=h:this._transitionPreviousStates[c].weight=1,t=this._findState(this._transitionPreviousStates[c].name);for(let d=0;d<t.animations.length;d++)s=t.animations[d],i=this._animEvaluator.findClip(s.name+".previous."+c),i||(i=this._animEvaluator.findClip(s.name),i.name=s.name+".previous."+c),c!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;const n=this.activeState,r=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1;let a=0,l=0;if(r){const h=n.timelineDuration*e.transitionOffset;a=h,l=h}this._timeInState=a,this._timeInStateBefore=l;for(let h=0;h<n.animations.length;h++){if(i=this._animEvaluator.findClip(n.animations[h].name),i)i.reset();else{const c=Number.isFinite(n.animations[h].speed)?n.animations[h].speed:n.speed;i=new ma(n.animations[h].animTrack,this._timeInState,c,!0,n.loop,this._eventHandler),i.name=n.animations[h].name,this._animEvaluator.addClip(i)}if(e.time>0?i.blendWeight=0:i.blendWeight=n.animations[h].normalizedWeight,i.play(),r)i.time=n.timelineDuration*e.transitionOffset;else{const c=n.speed>=0?0:this.activeStateDuration;i.time=c}}}_transitionToState(e){if(!this._findState(e))return;let t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new Wu({from:null,to:e})),this.updateStateFromTransition(t)}assignAnimation(e,t,s,i){const n=e.split(".");let r=this._findState(n[0]);r||(r=new ab(this,n[0],s),this._states[n[0]]=r,this._stateNames.push(n[0])),r.addAnimation(n,t),this._animEvaluator.updateClipTrack(r.name,t),s!==void 0&&(r.speed=s),i!==void 0&&(r.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(e){if(mc.indexOf(e)!==-1)return!1;const t=this._findState(e);return t?(t.animations=[],!0):!1}play(e){e&&this._transitionToState(e),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=cl,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(e){if(!this._playing)return;let t,s,i;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){const r=this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1;for(let a=0;a<this._transitionPreviousStates.length;a++){t=this._findState(this._transitionPreviousStates[a].name);const l=this._transitionPreviousStates[a].weight;for(let h=0;h<t.animations.length;h++)s=t.animations[h],i=this._animEvaluator.findClip(s.name+".previous."+a),i&&(i.blendWeight=(1-r)*s.normalizedWeight*l)}t=this.activeState;for(let a=0;a<t.animations.length;a++)s=t.animations[a],this._animEvaluator.findClip(s.name).blendWeight=r*s.normalizedWeight}else{this._isTransitioning=!1;const r=this.activeStateAnimations.length,a=this._animEvaluator.clips.length;for(let l=0;l<a-r;l++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(let l=0;l<t.animations.length;l++)s=t.animations[l],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==_c){t=this.activeState;for(let r=0;r<t.animations.length;r++)s=t.animations[r],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(e,this.activeState.hasAnimations)}}const I_=new G,Hu=new y,gc=new X,yc=new H,vc=new Z;class gn extends pn{constructor(e,t,s,i,n){super(t),this.animComponent=e,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(e){return e[0]}static _packBoolean(e){return!!e[0]}static _packVec2(e){return I_.x=e[0],I_.y=e[1],I_}static _packVec3(e){return Hu.x=e[0],Hu.y=e[1],Hu.z=e[2],Hu}static _packVec4(e){return gc.x=e[0],gc.y=e[1],gc.z=e[2],gc.w=e[3],gc}static _packColor(e){return yc.r=e[0],yc.g=e[1],yc.b=e[2],yc.a=e[3],yc}static _packQuat(e){return vc.x=e[0],vc.y=e[1],vc.z=e[2],vc.w=e[3],vc}resolve(e){const t=_a.encode(e.entityPath,e.component,e.propertyPath);let s=this.targetCache[t];if(s)return s;let i,n,r;switch(e.component){case"entity":i=this._getEntityFromHierarchy(e.entityPath),r=_a.encode(i.path,"entity",e.propertyPath),n=i;break;case"graph":if(n=this.findNode(e),!n)return null;r=_a.encode(n.path,"graph",e.propertyPath);break;default:if(i=this._getEntityFromHierarchy(e.entityPath),n=i.findComponent(e.component),!n)return null;r=_a.encode(i.path,e.component,e.propertyPath);break}return s=this._createAnimTargetForProperty(n,e.propertyPath,r),this.targetCache[t]=s,s}update(e){const t=this.activeNodes;if(t)for(let s=0;s<t.length;s++)t[s]._dirtifyLocal()}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;const t=this.animComponent.entity;return e.length===1?t:t._parent.findByPath(e)}_resolvePath(e,t,s){const i=t.length-(s?0:1);for(let n=0;n<i;n++)e=e[t[n]];return e}_setter(e,t,s){const i=this._resolvePath(e,t),n=t[t.length-1],r="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[r]){let h=i["get"+n.substring(0,1).toUpperCase()+n.substring(1)].bind(i)();h=[h.x,h.y,h.z,h.w];const c=i[r].bind(i);return{set:d=>{c(s(d))},get:()=>h}}const a=i[n];if(typeof a=="object"&&a.hasOwnProperty("copy"))return function(l){a.copy(s(l))};if([G,y,X,H,Z].indexOf(i.constructor)!==-1&&t.length>1){const l=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,h=t[t.length-2];return function(c){i[n]=s(c),l[h]=i}}return function(l){i[n]=s(l)}}_createAnimTargetForProperty(e,t,s){if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&t[0]==="material"&&t.length===2){const l=t[1];if(l.endsWith("Map"))return this.handlers.materialTexture(e,l)}const i=this._resolvePath(e,t,!0);if(typeof i>"u")return null;let n,r,a;if(typeof i=="number")n=this._setter(e,t,gn._packFloat),r="vector",a=1;else if(typeof i=="boolean")n=this._setter(e,t,gn._packBoolean),r="vector",a=1;else if(typeof i=="object")switch(i.constructor){case G:n=this._setter(e,t,gn._packVec2),r="vector",a=2;break;case y:n=this._setter(e,t,gn._packVec3),r="vector",a=3;break;case X:n=this._setter(e,t,gn._packVec4),r="vector",a=4;break;case H:n=this._setter(e,t,gn._packColor),r="vector",a=4;break;case Z:n=this._setter(e,t,gn._packQuat),r="quaternion",a=4;break;default:return null}return t.indexOf("material")!==-1?new Gu(function(l){n(l),e.material.update()},r,a,s):new Gu(n,r,a,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const e={};(function s(i){e[i.name]=i;for(let n=0;n<i.children.length;++n)s(i.children[n])})(this.graph),this.nodes=e}}class lb{constructor(e,t,s,i=1,n=A_,r=!0){this._name=e,this._controller=t,this._component=s,this._weight=i,this._blendType=n,this._normalizedWeight=r,this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0}get name(){return this._name}set playing(e){this._controller.playing=e}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){const t=this._controller,s=t.playing;t.playing=!0,t.activeStateCurrentTime=e,s||t.update(0),t.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}get mask(){return this._mask}play(e){this._controller.play(e)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=U.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e)}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0}assignMask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}assignAnimation(e,t,s,i){t instanceof ki&&(this._controller.assignAnimation(e,t,s,i),this._controller._transitions.length===0&&this._controller._transitions.push(new Wu({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)}getAnimationAsset(e){return this._component.animationAssets[`${this.name}:${e}`]}transition(e,t=0,s=null){this._controller.updateStateFromTransition(new Wu({from:this._controller.activeStateName,to:e,time:t,transitionOffset:s}))}}class xc{constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(const t in e.layers){const s=e.layers[t],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let n=0;n<s.states.length;n++)i.states.push(e.states[s.states[n]]);for(let n=0;n<s.transitions.length;n++){const r=e.transitions[s.transitions[n]];if(r.conditions&&!Array.isArray(r.conditions)){const a=Object.keys(r.conditions),l=[];for(let h=0;h<a.length;h++){const c=r.conditions[a[h]];c.parameterName&&l.push(c)}r.conditions=l}Number.isInteger(r.from)&&(r.from=e.states[r.from].name),Number.isInteger(r.to)&&(r.to=e.states[r.to].name),i.transitions.push(r)}this._layers.push(i)}for(const t in e.parameters){const s=e.parameters[t];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}class D_ extends he{constructor(e,t){super(e,t),this.findParameter=s=>this._parameters[s],this.consumeTrigger=s=>{this._consumedTriggers.add(s)},this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1}set stateGraphAsset(e){if(e===null){this.removeStateGraph();return}this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);let t,s;e instanceof se?(t=e.id,s=this.system.app.assets.get(t),s||(this.system.app.assets.add(e),s=this.system.app.assets.get(t))):(t=e,s=this.system.app.assets.get(t)),!(!s||this._stateGraphAsset===t)&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",i=>{this._stateGraph=i.resource,this.loadStateGraph(this._stateGraph)}),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=t)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e}get speed(){return this._speed}set activate(e){this._activate=e}get activate(){return this._activate}set playing(e){this._playing=e}get playing(){return this._playing}set rootBone(e){if(typeof e=="string"){const t=this.entity.root.findByGuid(e);this._rootBone=t}else e instanceof Ce?this._rootBone=e:this._rootBone=null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set targets(e){this._targets=e}get targets(){return this._targets}get playable(){for(let e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){const t=this.animationAssets,s=this.layers.map(i=>i.mask);this.removeStateGraph(),this._stateGraph=new xc(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach((i,n)=>{i.mask=s[n]}),this.rebind()}dirtifyTargets(){const e=Object.values(this._targets);for(let t=0;t<e.length;t++)e[t].dirty=!0}_addLayer({name:e,states:t,transitions:s,weight:i,mask:n,blendType:r}){let a;this.rootBone?a=this.rootBone:a=this.entity;const l=this._layers.length,h=new gn(this,a,e,n,l),c=new C_(h),d=new ob(c,t,s,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new lb(e,d,this,i,r)),this._layerIndices[e]=l,this._layers[l]}addLayer(e,t,s,i){const n=this.findAnimationLayer(e);if(n)return n;const r=[{name:"START",speed:1}],a=[];return this._addLayer({name:e,states:r,transitions:a,weight:t,mask:s,blendType:i})}_assignParameters(e){this._parameters={};const t=Object.keys(e.parameters);for(let s=0;s<t.length;s++){const i=t[s];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value}}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];let t=!1;for(let s=0;s<e.layers.length;s++){const i=e.layers[s];this._addLayer(gt({},i)),i.states.some(n=>n.blendTree)&&(t=!0)}t||this.setupAnimationAssets()}setupAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e],s=t.name;for(let i=0;i<t.states.length;i++){const n=t.states[i];if(mc.indexOf(n)===-1){const r=s+":"+n;this._animationAssets[r]||(this._animationAssets[r]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e];for(let s=0;s<t.states.length;s++){const i=t.states[s];if(mc.indexOf(i)!==-1)continue;const n=this._animationAssets[t.name+":"+i];if(!n||!n.asset){this.findAnimationLayer(t.name).assignAnimation(i,ki.EMPTY);continue}const r=n.asset,a=this.system.app.assets.get(r);a&&(a.resource?this.onAnimationAssetLoaded(t.name,i,a):(a.once("load",(function(l,h){return(function(c){this.onAnimationAssetLoaded(l,h,c)}).bind(this)}).bind(this)(t.name,i)),this.system.app.assets.load(a)))}}}onAnimationAssetLoaded(e,t,s){this.findAnimationLayer(e).assignAnimation(t,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(let e=0;e<this._layers.length;e++){const t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach(e=>{this._targets[e].unbind()})}rebind(){this._targets={};for(let e=0;e<this._layers.length;e++)this._layers[e].rebind()}findAnimationLayer(e){const t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new xc({layers:[{name:n,states:[{name:"START",speed:1},{name:e,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));const r=this.findAnimationLayer(n);if(r)r.assignAnimation(e,t,s,i);else{var a;(a=this.addLayer(n))==null||a.assignAnimation(e,t,s,i)}}assignAnimation(e,t,s,i=1,n=!0){if(!this._stateGraph&&e.indexOf(".")===-1){this.loadStateGraph(new xc({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),this.baseLayer.assignAnimation(e,t);return}const r=s?this.findAnimationLayer(s):this.baseLayer;r&&r.assignAnimation(e,t,i,n)}removeNodeAnimations(e,t){const s=t?this.findAnimationLayer(t):this.baseLayer;s&&s.removeNodeAnimations(e)}getParameterValue(e,t){const s=this._parameters[e];if(s&&s.type===t)return s.value}setParameterValue(e,t,s){const i=this._parameters[e];if(i&&i.type===t){i.value=s;return}}getFloat(e){return this.getParameterValue(e,w_)}setFloat(e,t){this.setParameterValue(e,w_,t)}getInteger(e){return this.getParameterValue(e,T_)}setInteger(e,t){typeof t=="number"&&t%1===0&&this.setParameterValue(e,T_,t)}getBoolean(e){return this.getParameterValue(e,E_)}setBoolean(e,t){this.setParameterValue(e,E_,!!t)}getTrigger(e){return this.getParameterValue(e,pc)}setTrigger(e,t=!1){this.setParameterValue(e,pc,!0),t&&this._consumedTriggers.add(e)}resetTrigger(e){this.setParameterValue(e,pc,!1)}onBeforeRemove(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}update(e){for(let t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach(t=>{this.parameters[t].value=!1}),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind()}}class VB{constructor(){this.enabled=!0}}const L_=["enabled"];class hb extends Ve{constructor(e){super(e),this.id="anim",this.ComponentType=D_,this.DataType=VB,this.schema=L_,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,L_);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach(n=>{i.includes(n)||(e[n]=t[n])}),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers?t.layers.forEach((n,r)=>{n._controller.states.forEach(a=>{n._controller._states[a]._animationList.forEach(l=>{if(!l.animTrack||l.animTrack===ki.EMPTY){const h=this.app.assets.get(n._component._animationAssets[n.name+":"+l.name].asset);h&&!h.loaded&&h.once("load",()=>{e.layers[r].assignAnimation(l.name,h.resource)})}else e.layers[r].assignAnimation(l.name,l.animTrack)})})}):t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach(n=>{if(e.layers[n]){const r=t.masks[n].mask,a={};Object.keys(r).forEach(l=>{a[decodeURI(l)]=r[l]}),e.layers[n].mask=a}})}onAnimationUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(e)}}cloneComponent(e,t){let s;(!e.anim.rootBone||e.anim.rootBone===e)&&(s={},e.anim.layers.forEach((n,r)=>{if(n.mask){const a={};Object.keys(n.mask).forEach(l=>{const h=l.split("/");h.shift();const c=[t.name,...h].join("/");a[c]=n.mask[l]}),s[r]={mask:a}}}));const i={stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:s};return this.addComponent(t,i)}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}he._buildAccessors(D_.prototype,L_);class F_ extends he{constructor(e,t){super(e,t)}setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const e=this.system.current.getPosition();this.system.manager.listener.setPosition(e)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}class GB{constructor(){this.enabled=!0}}const cb=["enabled"];class db extends Ve{constructor(e){super(e),this.id="audiolistener",this.ComponentType=F_,this.DataType=GB,this.schema=cb,this.manager=e.soundManager,this.current=null,this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["enabled"],super.initializeComponentData(e,t,s)}onUpdate(e){if(this.current){const t=this.current.getPosition();this.manager.listener.setPosition(t);const s=this.current.getWorldTransform();this.manager.listener.setOrientation(s)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}he._buildAccessors(F_.prototype,cb);class O_ extends he{constructor(e,t){super(e,t),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}play(e){if(!this.enabled||!this.entity.enabled)return;this.channel&&this.stop();let t;const s=this.data;if(s.sources[e])if(!s["3d"])t=this.system.manager.playSound(s.sources[e],s),s.currentSource=e,s.channel=t;else{const i=this.entity.getPosition();t=this.system.manager.playSound3d(s.sources[e],i,s),s.currentSource=e,s.channel=t}}pause(){this.channel&&this.channel.pause()}unpause(){this.channel&&this.channel.paused&&this.channel.unpause()}stop(){this.channel&&(this.channel.stop(),this.channel=null)}onSetAssets(e,t,s){const i=[],n=s.length;if(t&&t.length){for(let r=0;r<t.length;r++)if(t[r]){const a=this.system.app.assets.get(t[r]);a&&(a.off("change",this.onAssetChanged,this),a.off("remove",this.onAssetRemoved,this),this.currentSource===a.name&&this.stop())}}if(n)for(let r=0;r<n;r++)t.indexOf(s[r])<0&&(s[r]instanceof se?i.push(s[r].id):i.push(s[r]));!this.system._inTools&&i.length&&this.loadAudioSourceAssets(i)}onAssetChanged(e,t,s,i){t==="resource"&&this.data.sources&&(this.data.sources[e.name]=s,this.data.currentSource===e.name&&this.channel&&(this.channel.paused?(this.play(e.name),this.pause()):this.play(e.name)))}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.sources[e.name]&&(delete this.data.sources[e.name],this.data.currentSource===e.name&&(this.stop(),this.data.currentSource=null))}onSetLoop(e,t,s){t!==s&&this.channel&&this.channel.setLoop(s)}onSetVolume(e,t,s){t!==s&&this.channel&&this.channel.setVolume(s)}onSetPitch(e,t,s){t!==s&&this.channel&&this.channel.setPitch(s)}onSetMaxDistance(e,t,s){t!==s&&this.channel instanceof en&&this.channel.setMaxDistance(s)}onSetMinDistance(e,t,s){t!==s&&this.channel instanceof en&&this.channel.setMinDistance(s)}onSetRollOffFactor(e,t,s){t!==s&&this.channel instanceof en&&this.channel.setRollOffFactor(s)}onSetDistanceModel(e,t,s){t!==s&&this.channel instanceof en&&this.channel.setDistanceModel(s)}onSet3d(e,t,s){if(t!==s&&this.system.initialized&&this.currentSource){let i=!1,n=!1;this.channel&&(i=this.channel.paused,n=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=i,this.channel.suspended=n)}}onEnable(){const e=this.data.assets;if(e){const t=this.system.app.assets;for(let s=0,i=e.length;s<i;s++){let n=e[s];n instanceof se||(n=t.get(n)),n&&!n.resource&&t.load(n)}}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())}onDisable(){this.pause()}loadAudioSourceAssets(e){const t=e.map(l=>this.system.app.assets.get(l)),s={};let i=null,n=t.length;const r=l=>{n--},a=()=>{this.data.sources=s,this.data.currentSource=i,this.enabled&&this.activate&&i&&this.onEnable()};t.forEach((l,h)=>{l?(i=i||l.name,l.off("change",this.onAssetChanged,this),l.on("change",this.onAssetChanged,this),l.off("remove",this.onAssetRemoved,this),l.on("remove",this.onAssetRemoved,this),l.off("error",r,this),l.on("error",r,this),l.ready(c=>{s[c.name]=c.resource,n--,n===0&&a()}),!l.resource&&this.enabled&&this.entity.enabled&&this.system.app.assets.load(l)):(n--,n===0&&a(),this.system.app.assets.on("add:"+e[h],c=>{c.ready(d=>{this.data.sources[d.name]=d.resource}),c.resource||this.system.app.assets.load(c)}))})}}class WB{constructor(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=Ll,this.paused=!0,this.sources={},this.currentSource=null,this.channel=null}}const ub=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"];class fb extends Ve{constructor(e){super(e),this.id="audiosource",this.ComponentType=O_,this.DataType=WB,this.schema=ub,this.manager=e.soundManager,this.initialized=!1,this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}initializeComponentData(e,t,s){s=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],super.initializeComponentData(e,t,s),e.paused=!(e.enabled&&e.activate)}onInitialize(e){e.audiosource&&e.enabled&&e.audiosource.enabled&&e.audiosource.activate&&e.audiosource.play(e.audiosource.currentSource);const t=e._children;for(let s=0,i=t.length;s<i;s++)t[s]instanceof Ce&&this.onInitialize(t[s]);this.initialized=!0}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s],n=i.entity,r=i.data;if(r.enabled&&n.enabled&&r.channel instanceof en){const a=n.getPosition();r.channel.setPosition(a)}}}onRemove(e,t){t.channel&&(t.channel.stop(),t.channel=null)}setVolume(e){this.manager.setVolume(e)}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("update",this.onUpdate,this)}}he._buildAccessors(O_.prototype,ub);class ar extends Q{constructor(e,t,s){if(super(),!e||!(e instanceof he))throw new Error("The parentComponent argument is required and must be a Component");if(!t||typeof t!="string")throw new Error("The propertyName argument is required and must be a string");if(s&&typeof s!="object")throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=e,this._entityPropertyName=t,this._entity=null,this._app=e.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(e,t){const s=this._parseEventListenerConfig(e,"external",this._parentComponent),i=this._parseEventListenerConfig(t,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(e,t,s){return Object.keys(e).map(function(i,n){const r=i.split("#"),a=r[0],l=r[1],h=e[i];if(r.length!==2||typeof a!="string"||a.length===0||typeof l!="string"||l.length===0)throw new Error("Invalid event listener description: `"+i+"`");if(typeof h!="function")throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:t+"_"+n+"_"+i,sourceName:a,eventName:l,callback:h,scope:s}},this)}_toggleLifecycleListeners(e){this._parentComponent[e]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[e]("beforeremove",this._onParentComponentRemove,this),this._app.systems[e]("postPostInitialize",this._updateEntityReference,this),this._app[e]("tools:sceneloaded",this._onSceneLoaded,this);const t=[];for(let s=0;s<this._eventListenerConfigs.length;++s){const i=this._eventListenerConfigs[s],n=this._app.systems[i.sourceName];n&&(t.indexOf(n)===-1&&t.push(n),n&&i.eventName==="gain"&&(this._gainListeners[i.sourceName]=i),n&&i.eventName==="lose"&&(this._loseListeners[i.sourceName]=i))}for(let s=0;s<t.length;++s)t[s][e]("add",this._onComponentAdd,this),t[s][e]("beforeremove",this._onComponentRemove,this)}_onSetEntity(e,t,s){if(s instanceof Ce)this._updateEntityReference();else{if(s!=null&&typeof s!="string"){console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");return}t!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let e=this._parentComponent.data[this._entityPropertyName],t;if(e instanceof Ce)t=e,e=t.getGuid(),this._parentComponent.data[this._entityPropertyName]=e;else{const i=this._parentComponent.system.app.root;t=this._parentComponent.entity.isDescendantOf(i)&&e?i.findByGuid(e):null}this._entity!==t&&(this._entity&&this._onBeforeEntityChange(),this._entity=t,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(e){for(const t in this._entity.c)this._callGainOrLoseListener(t,e)}_callGainOrLoseListener(e,t){if(this._entity.c.hasOwnProperty(e)&&t[e]){const s=t[e];s.callback.call(s.scope)}}_toggleEntityListeners(e,t){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(e,this._eventListenerConfigs[s],t)}_toggleComponentListeners(e,t,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===t&&this._safeToggleListener(e,n,s)}}_safeToggleListener(e,t,s){const i=e==="on";if(i&&this._listenerStatusFlags[t.id])return;const n=this._getEventSource(t.sourceName,s);n&&(n[e](t.eventName,t.callback,t.scope),this._listenerStatusFlags[t.id]=i)}_getEventSource(e,t){if(e==="entity")return this._entity;const s=this._entity[e];return s||(t||console.warn("Entity has no component with name "+e),null)}_onEntityDestroy(e){this._entity===e&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(e,t){t===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(e){return this._entity&&this._entity.c?!!this._entity.c[e]:!1}get entity(){return this._entity}}const Xu=0,B_=1,Sc="group",$u="image",N_="text",bc="stretch",pb="contain",mb="cover",ht={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},Tc={};Tc[ht.DEFAULT]="_defaultTint",Tc[ht.HOVER]="hoverTint",Tc[ht.PRESSED]="pressedTint",Tc[ht.INACTIVE]="inactiveTint";const wc={};wc[ht.DEFAULT]="_defaultSpriteAsset",wc[ht.HOVER]="hoverSpriteAsset",wc[ht.PRESSED]="pressedSpriteAsset",wc[ht.INACTIVE]="inactiveSpriteAsset";const Ec={};Ec[ht.DEFAULT]="_defaultSpriteFrame",Ec[ht.HOVER]="hoverSpriteFrame",Ec[ht.PRESSED]="pressedSpriteFrame",Ec[ht.INACTIVE]="inactiveSpriteFrame";class dt extends he{constructor(e,t){super(e,t),this._visualState=ht.DEFAULT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new H(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new ar(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",e)}_toggleLifecycleListeners(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)}_onSetActive(e,t,s){t!==s&&this._updateVisualState()}_onSetTransitionMode(e,t,s){t!==s&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())}_onSetTransitionValue(e,t,s){t!==s&&this._forceReapplyVisualState()}_onElementComponentRemove(e){this.entity===e&&this._toggleHitElementListeners("off")}_onElementComponentAdd(e){this.entity===e&&this._toggleHitElementListeners("on")}_onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(e){if(this.entity.element){const t=e==="on";if(t&&this._hasHitElementListeners)return;this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t}}_storeDefaultVisualState(){if(this._imageReference.hasComponent("element")){const e=this._imageReference.entity.element;e.type!==Sc&&(this._storeDefaultColor(e.color),this._storeDefaultOpacity(e.opacity),this._storeDefaultSpriteAsset(e.spriteAsset),this._storeDefaultSpriteFrame(e.spriteFrame))}}_storeDefaultColor(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b}_storeDefaultOpacity(e){this._defaultTint.a=e}_storeDefaultSpriteAsset(e){this._defaultSpriteAsset=e}_storeDefaultSpriteFrame(e){this._defaultSpriteFrame=e}_onSetColor(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())}_onSetOpacity(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())}_onSetSpriteAsset(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())}_onSetSpriteFrame(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())}_onMouseEnter(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)}_onMouseLeave(e){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)}_onMouseDown(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)}_onMouseUp(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)}_onTouchStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)}_onTouchEnd(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)}_onTouchLeave(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)}_onTouchCancel(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)}_onSelectStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)}_onSelectEnd(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)}_onSelectEnter(e){this._hoveringCounter++,this._hoveringCounter===1&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)}_onSelectLeave(e){this._hoveringCounter--,this._hoveringCounter===0&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)}_onClick(e){this._fireIfActive("click",e)}_fireIfActive(e,t){this.data.active&&this.fire(e,t)}_updateVisualState(e){const t=this._visualState,s=this._determineVisualState();if((t!==s||e)&&this.enabled)switch(this._visualState=s,t===ht.HOVER&&this._fireIfActive("hoverend"),t===ht.PRESSED&&this._fireIfActive("pressedend"),s===ht.HOVER&&this._fireIfActive("hoverstart"),s===ht.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case Xu:{const i=Tc[this._visualState],n=this[i];this._applyTint(n);break}case B_:{const i=wc[this._visualState],n=Ec[this._visualState],r=this[i],a=this[n];this._applySprite(r,a);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(e){if(this._imageReference.hasComponent("element"))switch(e){case Xu:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case B_:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame);break}}_determineVisualState(){if(this.active){if(this._isPressed)return ht.PRESSED;if(this._isHovering)return ht.HOVER}else return ht.INACTIVE;return ht.DEFAULT}_applySprite(e,t){t=t||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset!==e&&(this._imageReference.entity.element.spriteAsset=e),this._imageReference.entity.element.spriteFrame!==t&&(this._imageReference.entity.element.spriteFrame=t),this._isApplyingSprite=!1)}_applyTint(e){this._cancelTween(),this.fadeDuration===0?this._applyTintImmediately(e):this._applyTintWithTween(e)}_applyTintImmediately(e){if(!e||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===Sc)return;const t=_b(e);this._isApplyingTint=!0,t.equals(this._imageReference.entity.element.color)||(this._imageReference.entity.element.color=t),this._imageReference.entity.element.opacity!==e.a&&(this._imageReference.entity.element.opacity=e.a),this._isApplyingTint=!1}_applyTintWithTween(e){if(!e||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===Sc)return;const t=_b(e),s=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;t.equals(s)&&e.a===i||(this._tweenInfo={startTime:jt(),from:new H(s.r,s.g,s.b,i),to:e.clone(),lerpColor:new H})}_updateTintTween(){const e=jt()-this._tweenInfo.startTime;let t=this.fadeDuration===0?1:e/this.fadeDuration;if(t=U.clamp(t,0,1),Math.abs(t-1)>1e-5){const s=this._tweenInfo.lerpColor;s.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new H(s.r,s.g,s.b,s.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}dt.EVENT_MOUSEDOWN="mousedown",dt.EVENT_MOUSEUP="mouseup",dt.EVENT_MOUSEENTER="mouseenter",dt.EVENT_MOUSELEAVE="mouseleave",dt.EVENT_CLICK="click",dt.EVENT_TOUCHSTART="touchstart",dt.EVENT_TOUCHEND="touchend",dt.EVENT_TOUCHCANCEL="touchcancel",dt.EVENT_TOUCHLEAVE="touchleave",dt.EVENT_SELECTSTART="selectstart",dt.EVENT_SELECTEND="selectend",dt.EVENT_SELECTENTER="selectenter",dt.EVENT_SELECTLEAVE="selectleave",dt.EVENT_HOVERSTART="hoverstart",dt.EVENT_HOVEREND="hoverend",dt.EVENT_PRESSEDSTART="pressedstart",dt.EVENT_PRESSEDEND="pressedend";function _b(o){return new H(o.r,o.g,o.b)}class HB{constructor(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new X,this.transitionMode=Xu,this.hoverTint=new H(.75,.75,.75),this.pressedTint=new H(.5,.5,.5),this.inactiveTint=new H(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}const k_=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class gb extends Ve{constructor(e){super(e),this.id="button",this.ComponentType=dt,this.DataType=HB,this.schema=k_,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,k_)}onUpdate(e){const t=this.store;for(const s in t){const i=t[s].entity,n=i.button;n.enabled&&i.enabled&&n.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}he._buildAccessors(dt.prototype,k_);const yb=new y,vb=new Z;class or extends he{constructor(e,t){super(e,t),this._compoundParent=null,this._hasOffset=!1,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_linearOffset",this.onSetOffset,this),this.on("set_angularOffset",this.onSetOffset,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}onSetType(e,t,s){t!==s&&this.system.changeType(this,t,s)}onSetHalfExtents(e,t,s){const i=this.data.type;this.data.initialized&&i==="box"&&this.system.recreatePhysicalShapes(this)}onSetOffset(e,t,s){this._hasOffset=!this.data.linearOffset.equals(y.ZERO)||!this.data.angularOffset.equals(Z.IDENTITY),this.data.initialized&&this.system.recreatePhysicalShapes(this)}onSetRadius(e,t,s){const i=this.data.type;this.data.initialized&&(i==="sphere"||i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetHeight(e,t,s){const i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAxis(e,t,s){const i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&n.off("remove",this.onAssetRemoved,this)}if(s){s instanceof se&&(this.data.asset=s.id);const n=i.get(this.data.asset);n&&(n.off("remove",this.onAssetRemoved,this),n.on("remove",this.onAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&n.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof se&&(this.data.renderAsset=s.id);const n=i.get(this.data.renderAsset);n&&(n.off("remove",this.onRenderAssetRemoved,this),n.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(e,t,s){this.data.initialized&&this.data.type==="mesh"&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(e,t,s){this.onSetModel(e,t,s)}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)}onRenderAssetRemoved(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null)}_getCompoundChildShapeIndex(e){const t=this.data.shape,s=t.getNumChildShapes();for(let i=0;i<s;i++)if(t.getChildShape(i).ptr===e.ptr)return i;return null}_onInsert(e){if(!(typeof Ammo>"u")){if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let t=this.entity.parent;for(;t;){if(t.collision&&t.collision.type==="compound"){t.collision.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent}}}}_updateCompound(){const e=this.entity;if(e._dirtyWorld){let t=e._dirtyLocal,s=e;for(;s&&!t&&!(s.collision&&s.collision===this._compoundParent);)s._dirtyLocal&&(t=!0),s=s.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);const i=this._compoundParent.entity.rigidbody;i&&i.activate()}}}getShapePosition(){const e=this.entity.getPosition();if(this._hasOffset){const t=this.entity.getRotation(),s=this.data.linearOffset;return vb.copy(t).transformVector(s,yb),yb.add(e)}return e}getShapeRotation(){const e=this.entity.getRotation();return this._hasOffset?vb.copy(e).mul(this.data.angularOffset):e}onEnable(){if(this.data.type==="mesh"&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){const e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(this._compoundParent.shape.getNumChildShapes()===0)this.system.recreatePhysicalShapes(this._compoundParent);else{const e=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(e,this.data.shape),Ammo.destroy(e),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}}or.EVENT_CONTACT="contact",or.EVENT_COLLISIONSTART="collisionstart",or.EVENT_COLLISIONEND="collisionend",or.EVENT_TRIGGERENTER="triggerenter",or.EVENT_TRIGGERLEAVE="triggerleave";class XB{constructor(){this.enabled=!0,this.type="box",this.halfExtents=new y(.5,.5,.5),this.linearOffset=new y,this.angularOffset=new Z,this.radius=.5,this.axis=1,this.height=2,this.asset=null,this.renderAsset=null,this.checkVertexDuplicates=!0,this.shape=null,this.model=null,this.render=null,this.initialized=!1}}const ga="static",Ss="dynamic",lr="kinematic",xb=1,U_=2,ya=4,Ac=1,Sb=2,bb=3,qu=4,ju=5,$B=0,qB=1,Tb=1,z_=2,wb=4,jB=8,V_=16,YB=32,KB=64,ZB=128,QB=256,JB=512,eN=1024,tN=2048,sN=4096,iN=8192,nN=16384,rN=0,G_=65535,aN=2,Yu=65533,oN=65529;let yi,va,ul;class Eb{constructor(e,t,s){this.entity=t.entity,this.component=t,this.app=e,typeof Ammo<"u"&&!yi&&(yi=new Ammo.btVector3,va=new Ammo.btQuaternion,ul=new Ammo.btTransform),this.initialize(s)}initialize(e){const t=this.entity,s=e.shape;if(s&&typeof Ammo<"u"){t.trigger&&t.trigger.destroy();const i=1,n=this.component;if(n){const a=n.getShapePosition(),l=n.getShapeRotation();yi.setValue(a.x,a.y,a.z),va.setValue(l.x,l.y,l.z,l.w)}else{const a=t.getPosition(),l=t.getRotation();yi.setValue(a.x,a.y,a.z),va.setValue(l.x,l.y,l.z,l.w)}ul.setOrigin(yi),ul.setRotation(va);const r=this.app.systems.rigidbody.createBody(i,s,ul);r.setRestitution(0),r.setFriction(0),r.setDamping(0,0),yi.setValue(0,0,0),r.setLinearFactor(yi),r.setAngularFactor(yi),r.setCollisionFlags(r.getCollisionFlags()|ya),r.entity=t,this.body=r,this.component.enabled&&t.enabled&&this.enable()}}destroy(){const e=this.body;e&&(this.disable(),this.app.systems.rigidbody.destroyBody(e))}_getEntityTransform(e){const t=this.component;if(t){const s=t.getShapePosition(),i=t.getShapeRotation();yi.setValue(s.x,s.y,s.z),va.setValue(i.x,i.y,i.z,i.w)}else{const s=this.entity.getPosition(),i=this.entity.getRotation();yi.setValue(s.x,s.y,s.z),va.setValue(i.x,i.y,i.z,i.w)}e.setOrigin(yi),e.setRotation(va)}updateTransform(){this._getEntityTransform(ul);const e=this.body;e.setWorldTransform(ul),e.activate()}enable(){const e=this.body;if(!e)return;const t=this.app.systems;t.rigidbody.addBody(e,V_,Yu^V_),t.rigidbody._triggers.push(this),e.forceActivationState(Ac),this.updateTransform()}disable(){const e=this.body;if(!e)return;const t=this.app.systems,s=t.rigidbody._triggers.indexOf(this);s>-1&&t.rigidbody._triggers.splice(s,1),t.rigidbody.removeBody(e),e.forceActivationState(ju)}}const Ku=new W,lN=new y,hN=new y,xa=new Z,cN=new we,Ab=["enabled","type","halfExtents","linearOffset","angularOffset","radius","axis","height","asset","renderAsset","shape","model","render","checkVertexDuplicates"];class Sa{constructor(e){this.system=e}beforeInitialize(e,t){t.shape=null,t.model=new _i,t.model.graph=new we}afterInitialize(e,t){this.recreatePhysicalShapes(e),e.data.initialized=!0}reset(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t)}recreatePhysicalShapes(e){const t=e.entity,s=e.data;if(typeof Ammo<"u"){t.trigger&&(t.trigger.destroy(),delete t.trigger),s.shape&&(e._compoundParent&&(this.system._removeCompoundChild(e._compoundParent,s.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),this.destroyShape(s)),s.shape=this.createPhysicalShape(e.entity,s);const i=!e._compoundParent;if(s.type==="compound"&&(!e._compoundParent||e===e._compoundParent))e._compoundParent=e,t.forEach(this._addEachDescendant,e);else if(s.type!=="compound"&&(e._compoundParent&&e===e._compoundParent&&t.forEach(this.system.implementations.compound._updateEachDescendant,e),!e.rigidbody)){e._compoundParent=null;let n=t.parent;for(;n;){if(n.collision&&n.collision.type==="compound"){e._compoundParent=n.collision;break}n=n.parent}}e._compoundParent&&e!==e._compoundParent&&(i&&e._compoundParent.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(s):t.trigger=new Eb(this.system.app,e,s))}}createPhysicalShape(e,t){}updateTransform(e,t,s,i){e.entity.trigger&&e.entity.trigger.updateTransform()}destroyShape(e){e.shape&&(Ammo.destroy(e.shape),e.shape=null)}beforeRemove(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,this.destroyShape(t.data))}remove(e,t){e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger)}clone(e,t){const s=this.system.store[e.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],linearOffset:[s.data.linearOffset.x,s.data.linearOffset.y,s.data.linearOffset.z],angularOffset:[s.data.angularOffset.x,s.data.angularOffset.y,s.data.angularOffset.z,s.data.angularOffset.w],radius:s.data.radius,axis:s.data.axis,height:s.data.height,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render,checkVertexDuplicates:s.data.checkVertexDuplicates};return this.system.addComponent(t,i)}}class dN extends Sa{createPhysicalShape(e,t){if(typeof Ammo<"u"){const s=t.halfExtents,i=new Ammo.btVector3(s?s.x:.5,s?s.y:.5,s?s.z:.5),n=new Ammo.btBoxShape(i);return Ammo.destroy(i),n}}}class uN extends Sa{createPhysicalShape(e,t){if(typeof Ammo<"u")return new Ammo.btSphereShape(t.radius)}}class fN extends Sa{createPhysicalShape(e,t){var s,i,n;const r=(s=t.axis)!=null?s:1,a=(i=t.radius)!=null?i:.5,l=Math.max(((n=t.height)!=null?n:2)-2*a,0);let h=null;if(typeof Ammo<"u")switch(r){case 0:h=new Ammo.btCapsuleShapeX(a,l);break;case 1:h=new Ammo.btCapsuleShape(a,l);break;case 2:h=new Ammo.btCapsuleShapeZ(a,l);break}return h}}class pN extends Sa{createPhysicalShape(e,t){var s,i,n;const r=(s=t.axis)!=null?s:1,a=(i=t.radius)!=null?i:.5,l=(n=t.height)!=null?n:1;let h=null,c=null;if(typeof Ammo<"u")switch(r){case 0:h=new Ammo.btVector3(l*.5,a,a),c=new Ammo.btCylinderShapeX(h);break;case 1:h=new Ammo.btVector3(a,l*.5,a),c=new Ammo.btCylinderShape(h);break;case 2:h=new Ammo.btVector3(a,a,l*.5),c=new Ammo.btCylinderShapeZ(h);break}return h&&Ammo.destroy(h),c}}class mN extends Sa{createPhysicalShape(e,t){var s,i,n;const r=(s=t.axis)!=null?s:1,a=(i=t.radius)!=null?i:.5,l=(n=t.height)!=null?n:1;let h=null;if(typeof Ammo<"u")switch(r){case 0:h=new Ammo.btConeShapeX(a,l);break;case 1:h=new Ammo.btConeShape(a,l);break;case 2:h=new Ammo.btConeShapeZ(a,l);break}return h}}class _N extends Sa{beforeInitialize(e,t){}createAmmoMesh(e,t,s,i,n=!0){const r=this.system;let a;if(r._triMeshCache[e.id])a=r._triMeshCache[e.id];else{const d=e.vertexBuffer,u=d.getFormat();let f,p;for(let I=0;I<u.elements.length;I++){const B=u.elements[I];if(B.name===We){p=new Float32Array(d.lock(),B.offset),f=B.stride/4;break}}const _=[];e.getIndices(_);const m=e.primitive[0].count/3,g=new Ammo.btVector3;let x,S,v;const b=e.primitive[0].base;a=new Ammo.btTriangleMesh,r._triMeshCache[e.id]=a;const w=new Map,T=a.getIndexedMeshArray();T.at(0).m_numTriangles=m;const E=i?i.x:1,C=i?i.y:1,M=i?i.z:1,O=I=>{const B=p[I*f]*E,P=p[I*f+1]*C,D=p[I*f+2]*M;let R;if(n){const A=`${B}:${P}:${D}`;if(R=w.get(A),R!==void 0)return R;g.setValue(B,P,D),R=a.findOrAddVertex(g,!1),w.set(A,R)}else g.setValue(B,P,D),R=a.findOrAddVertex(g,!1);return R};for(var l=0;l<m;l++)x=O(_[b+l*3]),S=O(_[b+l*3+1]),v=O(_[b+l*3+2]),a.addIndex(x),a.addIndex(S),a.addIndex(v);Ammo.destroy(g)}const h=new Ammo.btBvhTriangleMeshShape(a,!0);if(!i){const d=r._getNodeScaling(t);h.setLocalScaling(d),Ammo.destroy(d)}const c=r._getNodeTransform(t);s.addChildShape(c,h),Ammo.destroy(c)}createPhysicalShape(e,t){if(!(typeof Ammo>"u")&&(t.model||t.render)){const s=new Ammo.btCompoundShape,n=e.getWorldTransform().getScale();if(t.model){const r=t.model.meshInstances;for(let l=0;l<r.length;l++)this.createAmmoMesh(r[l].mesh,r[l].node,s,null,t.checkVertexDuplicates);const a=new Ammo.btVector3(n.x,n.y,n.z);s.setLocalScaling(a),Ammo.destroy(a)}else if(t.render){const r=t.render.meshes;for(let a=0;a<r.length;a++)this.createAmmoMesh(r[a],cN,s,n,t.checkVertexDuplicates)}return s}}recreatePhysicalShapes(e){const t=e.data;if((t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled){this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model");return}this.doRecreatePhysicalShape(e)}loadAsset(e,t,s){const i=e.data,n=this.system.app.assets,r=i[s],a=c=>{i[s]===r&&(i[s]=c.resource,this.doRecreatePhysicalShape(e))},l=c=>{c.ready(d=>{if(d.data.containerAsset){const u=n.get(d.data.containerAsset);u.loaded?a(d):(u.ready(()=>{a(d)}),n.load(u))}else a(d)}),n.load(c)},h=n.get(t);h?l(h):n.once("add:"+t,l)}doRecreatePhysicalShape(e){const t=e.entity,s=e.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(t,s),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(s):t.trigger=new Eb(this.system.app,e,s)):(this.beforeRemove(t,e),this.remove(t,s))}updateTransform(e,t,s,i){if(e.shape){const r=e.entity.getWorldTransform().getScale(),a=e.shape.getLocalScaling();(r.x!==a.x()||r.y!==a.y()||r.z!==a.z())&&this.doRecreatePhysicalShape(e)}super.updateTransform(e,t,s,i)}destroyShape(e){if(!e.shape)return;const t=e.shape.getNumChildShapes();for(let s=0;s<t;s++){const i=e.shape.getChildShape(s);Ammo.destroy(i)}Ammo.destroy(e.shape),e.shape=null}}class gN extends Sa{createPhysicalShape(e,t){if(typeof Ammo<"u")return new Ammo.btCompoundShape}_addEachDescendant(e){!e.collision||e.rigidbody||(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendant(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e!==this.entity&&!e.rigidbody&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendantTransform(e){!e.collision||e.collision._compoundParent!==this.collision._compoundParent||this.collision.system.updateCompoundChildTransform(e)}}class Cb extends Ve{constructor(e){super(e),this.id="collision",this.ComponentType=or,this.DataType=XB,this.schema=Ab,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(e,t,s){s=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled","linearOffset","angularOffset","checkVertexDuplicates"];const i={};for(let a=0,l=s.length;a<l;a++){const h=s[a];i[h]=t[h]}let n;if(t.hasOwnProperty("asset")?(n=s.indexOf("model"),n!==-1&&s.splice(n,1),n=s.indexOf("render"),n!==-1&&s.splice(n,1)):t.hasOwnProperty("model")&&(n=s.indexOf("asset"),n!==-1&&s.splice(n,1)),i.type||(i.type=e.data.type),e.data.type=i.type,Array.isArray(i.halfExtents)&&(i.halfExtents=new y(i.halfExtents)),Array.isArray(i.linearOffset)&&(i.linearOffset=new y(i.linearOffset)),Array.isArray(i.angularOffset)){const a=i.angularOffset;a.length===3?i.angularOffset=new Z().setFromEulerAngles(a[0],a[1],a[2]):i.angularOffset=new Z(i.angularOffset)}const r=this._createImplementation(i.type);r.beforeInitialize(e,i),super.initializeComponentData(e,i,s),r.afterInitialize(e,i)}_createImplementation(e){if(this.implementations[e]===void 0){let t;switch(e){case"box":t=new dN(this);break;case"sphere":t=new uN(this);break;case"capsule":t=new fN(this);break;case"cylinder":t=new pN(this);break;case"cone":t=new mN(this);break;case"mesh":t=new _N(this);break;case"compound":t=new gN(this);break}this.implementations[e]=t}return this.implementations[e]}_getImplementation(e){return this.implementations[e.collision.data.type]}cloneComponent(e,t){return this._getImplementation(e).clone(e,t)}onBeforeRemove(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove()}onRemove(e,t){this.implementations[t.type].remove(e,t)}updateCompoundChildTransform(e){if(this._removeCompoundChild(e.collision._compoundParent,e.collision.data.shape),e.enabled&&e.collision.enabled){const t=this._getNodeTransform(e,e.collision._compoundParent.entity);e.collision._compoundParent.shape.addChildShape(t,e.collision.data.shape),Ammo.destroy(t)}}_removeCompoundChild(e,t){if(e.shape.removeChildShape)e.shape.removeChildShape(t);else{const s=e._getCompoundChildShapeIndex(t);s!==null&&e.shape.removeChildShapeByIndex(s)}}onTransformChanged(e,t,s,i){this.implementations[e.data.type].updateTransform(e,t,s,i)}changeType(e,t,s){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(s).reset(e,e.data)}recreatePhysicalShapes(e){this.implementations[e.data.type].recreatePhysicalShapes(e)}_calculateNodeRelativeTransform(e,t){if(e===t){const s=e.getWorldTransform().getScale();Ku.setScale(s.x,s.y,s.z)}else this._calculateNodeRelativeTransform(e.parent,t),Ku.mul(e.getLocalTransform())}_getNodeScaling(e){const s=e.getWorldTransform().getScale();return new Ammo.btVector3(s.x,s.y,s.z)}_getNodeTransform(e,t){let s,i;t?(this._calculateNodeRelativeTransform(e,t),s=lN,i=xa,Ku.getTranslation(s),i.setFromMat4(Ku)):(s=e.getPosition(),i=e.getRotation());const n=new Ammo.btQuaternion,r=new Ammo.btTransform;r.setIdentity();const a=r.getOrigin(),l=e.collision;if(l&&l._hasOffset){const h=l.data.linearOffset,c=l.data.angularOffset,d=hN;xa.copy(i).transformVector(h,d),d.add(s),xa.copy(i).mul(c),a.setValue(d.x,d.y,d.z),n.setValue(xa.x,xa.y,xa.z,xa.w)}else a.setValue(s.x,s.y,s.z),n.setValue(i.x,i.y,i.z,i.w);return r.setRotation(n),Ammo.destroy(n),Ammo.destroy(a),r}destroy(){for(const e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,super.destroy()}}he._buildAccessors(or.prototype,Ab);const yN=new Rs;class vN{constructor(e,t,s){this._entity=e,this._element=e.element,this.model=new _i,this.node=new we,this.model.graph=this.node,this.mesh=t,this.meshInstance=new Te(this.mesh,s,this.node),this.meshInstance.name="ImageElement: "+e.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null}setMesh(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb())}setMask(e){if(this.meshInstance){if(e){this.unmaskMeshInstance=new Te(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(const t in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data)}else{const t=this.model.meshInstances.indexOf(this.unmaskMeshInstance);t>=0&&this.model.meshInstances.splice(t,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}}setMaterial(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e))}setParameter(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t))}deleteParameter(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e))}setUnmaskDrawOrder(){if(!this.meshInstance)return;const e=function t(s){let i;const n=s.children,r=n.length;if(r){for(let l=0;l<r;l++)n[l].element&&(i=n[l]);if(!i)return null;const a=t(i);return a||i}return null};if(this.unmaskMeshInstance){const t=e(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(e){this.meshInstance&&(this.meshInstance.drawOrder=e)}setCull(e){if(!this.meshInstance)return;const t=this._element;let s=null;e&&t._isScreenSpace()&&(s=function(i){return t.isVisibleForCamera(i)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e))}setLayer(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e))}forceUpdateAabb(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e))}}class Mb{constructor(e){this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new X(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new G,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new X,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new X,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new vN(this._entity,this._defaultMesh,this._material),this._color=new H(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(e){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onScreenChange(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&this._system.defaultImageMaterials.indexOf(this._material)===-1}_use9Slicing(){return this.sprite&&(this.sprite.renderMode===ot||this.sprite.renderMode===st)}_updateMaterial(e){const t=!!this._mask,s=!!(this.sprite&&this.sprite.renderMode===ot),i=!!(this.sprite&&this.sprite.renderMode===st);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,s,i)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(e?k0:im))}_createMesh(){const e=this._element,t=e.calculatedWidth,s=e.calculatedHeight,i=this._rect,n=this._system.app.graphicsDevice,r=new Float32Array([t,0,0,0,0,1,i.x+i.z,1-i.y,t,s,0,0,0,1,i.x+i.z,1-(i.y+i.w),0,0,0,0,0,1,i.x,1-i.y,0,s,0,0,0,1,i.x,1-(i.y+i.w)]),a=yN.get(n,()=>new Tt(n,[{semantic:We,components:3,type:le},{semantic:Dt,components:3,type:le},{semantic:Lt,components:2,type:le}])),l=new es(n,a,4,St,r.buffer),h=new Ut(n);return h.vertexBuffer=l,h.primitive[0].type=As,h.primitive[0].base=0,h.primitive[0].count=4,h.primitive[0].indexed=!1,h.aabb.setMinMax(y.ZERO,new y(t,s,0)),this._updateMesh(h),h}_updateMesh(e){const t=this._element;let s=t.calculatedWidth,i=t.calculatedHeight;if(t.fitMode!==bc&&this._targetAspectRatio>0){const r=t.calculatedWidth/t.calculatedHeight;t.fitMode===pb&&r>this._targetAspectRatio||t.fitMode===mb&&r<this._targetAspectRatio?s=t.calculatedHeight*this._targetAspectRatio:i=t.calculatedWidth/this._targetAspectRatio}const n=t._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),this.sprite&&(this.sprite.renderMode===ot||this.sprite.renderMode===st)){const r=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],a=2/r.rect.z,l=2/r.rect.w;this._innerOffset.set(r.border.x*a,r.border.y*l,r.border.z*a,r.border.w*l);const h=this.sprite.atlas.texture;this._atlasRect.set(r.rect.x/h.width,r.rect.y/h.height,r.rect.z/h.width,r.rect.w/h.height);const c=this._pixelsPerUnit!==null?this._pixelsPerUnit:this.sprite.pixelsPerUnit,d=r.rect.z/c,u=r.rect.w/c;this._outerScale.set(Math.max(s,this._innerOffset.x*d),Math.max(i,this._innerOffset.y*u));let f=d,p=u;this._outerScale.x/=d,this._outerScale.y/=u,f*=U.clamp(s/(this._innerOffset.x*d),1e-4,1),p*=U.clamp(i/(this._innerOffset.y*u),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(f,p,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*s,(.5-t.pivot.y)*i,0))}else{const r=e.vertexBuffer,a=new Float32Array(r.lock()),l=t.pivot.x,h=t.pivot.y;a[0]=s-l*s,a[1]=0-h*i,a[8]=s-l*s,a[9]=i-h*i,a[16]=0-l*s,a[17]=0-h*i,a[24]=0-l*s,a[25]=i-h*i;let c=1,d=1,u=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){const _=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];_&&(u=_.rect,c=this._sprite.atlas.texture.width,d=this._sprite.atlas.texture.height)}a[6]=(u.x+u.z)/c,a[7]=1-u.y/d,a[14]=(u.x+u.z)/c,a[15]=1-(u.y+u.w)/d,a[22]=u.x/c,a[23]=1-u.y/d,a[30]=u.x/c,a[31]=1-(u.y+u.w)/d,r.unlock();const f=new y(0-l*s,0-h*i,0),p=new y(s-l*s,i-h*i,0);e.aabb.setMinMax(f,p),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}this._meshDirty=!1}_updateSprite(){let e=!1,t=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){t=this._sprite.meshes[this.spriteFrame],e=this._sprite.renderMode===ot||this._sprite.renderMode===st;const s=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];(s==null?void 0:s.rect.w)>0&&(this._targetAspectRatio=s.rect.z/s.rect.w)}this.mesh=e?t:this._defaultMesh,this.refreshMesh()}refreshMesh(){this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e}_toggleMask(){this._element._dirtifyMask();const e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask)}_onMaterialLoad(e){this.material=e.resource}_onMaterialAdded(e){this._system.app.assets.off("add:"+e.id,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_bindMaterialAsset(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e))}_unbindMaterialAsset(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(e){this._system.app.assets.off("add:"+e.id,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e)}_bindTextureAsset(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e))}_unbindTextureAsset(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)}_onTextureLoad(e){this.texture=e.resource}_onTextureChange(e){}_onTextureRemove(e){}_onSpriteAssetAdded(e){this._system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e))}_unbindSpriteAsset(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(e){if(!e||!e.resource)this.sprite=null;else if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset;if(t){const s=this._system.app.assets;s.off("load:"+t,this._onTextureAtlasLoad,this),s.once("load:"+t,this._onTextureAtlasLoad,this)}}}_onSpriteAssetChange(e){this._onSpriteAssetLoad(e)}_onSpriteAssetRemove(e){}_bindSprite(e){e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(e){e.off("set:meshes",this._onSpriteMeshesChange,this),e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=U.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){this.sprite.renderMode!==Fi&&this._pixelsPerUnit===null&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof se?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t))}onEnable(){if(this._materialAsset){const e=this._system.app.assets.get(this._materialAsset);e&&e.resource!==this._material&&this._bindMaterialAsset(e)}if(this._textureAsset){const e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==this._texture&&this._bindTextureAsset(e)}if(this._spriteAsset){const e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==this._sprite&&this._bindSpriteAsset(e)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;let t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){const s=new cs({ref:t+1,func:Nl,zpass:qy});this._renderable.unmaskMeshInstance.stencilFront=s,this._renderable.unmaskMeshInstance.stencilBack=s}}set color(e){const t=e.r,s=e.g,i=e.b;(this._color.r!==t||this._color.g!==s||this._color.b!==i)&&(this._color.r=t,this._color.g=s,this._color.b=i,this._colorUniform[0]=t,this._colorUniform[1]=s,this._colorUniform[2]=i,this._renderable.setParameter("material_emissive",this._colorUniform)),this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e)),this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set rect(e){let t,s,i,n;e instanceof X?(t=e.x,s=e.y,i=e.z,n=e.w):(t=e[0],s=e[1],i=e[2],n=e[3]),!(t===this._rect.x&&s===this._rect.y&&i===this._rect.z&&n===this._rect.w)&&(this._rect.set(t,s,i,n),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get rect(){return this._rect}_removeMaterialAssetEvents(){if(this._materialAsset){const e=this._system.app.assets;e.off("add:"+this._materialAsset,this._onMaterialAdded,this);const t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this))}}set material(e){if(this._material!==e){if(!e){const t=this._element._isScreenSpace();this.mask?e=t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e=t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}if(this._material=e,this._materialAsset){const t=this._system.app.assets.get(this._materialAsset);(!t||t.resource!==e)&&(this._removeMaterialAssetEvents(),this._materialAsset=null)}e&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}get material(){return this._material}set materialAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof se&&(s=e.id),this._materialAsset!==s)if(this._removeMaterialAssetEvents(),this._materialAsset=s,this._materialAsset){const i=t.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._materialAsset=null,this.material=null,this._materialAsset=s,t.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this._materialAsset=null,this.material=null,this._materialAsset=s}get materialAsset(){return this._materialAsset}set texture(e){if(this._texture!==e){if(this._textureAsset){const t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null)}if(this._texture=e,e){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a);const t=this._texture.width/this._texture.height;t!==this._targetAspectRatio&&(this._targetAspectRatio=t,this._element.fitMode!==bc&&this.refreshMesh())}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,this._element.fitMode!==bc&&this.refreshMesh()}}get texture(){return this._texture}set textureAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof se&&(s=e.id),this._textureAsset!==s){if(this._textureAsset){t.off("add:"+this._textureAsset,this._onTextureAdded,this);const i=t.get(this._textureAsset);i&&(i.off("load",this._onTextureLoad,this),i.off("change",this._onTextureChange,this),i.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){const i=t.get(this._textureAsset);i?this._bindTextureAsset(i):(this.texture=null,t.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}get textureAsset(){return this._textureAsset}set spriteAsset(e){const t=this._system.app.assets;let s=e;if(e instanceof se&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){t.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);const i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){const i=t.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get spriteAsset(){return this._spriteAsset}set sprite(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){const t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null)}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=U.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get sprite(){return this._sprite}set spriteFrame(e){const t=this._spriteFrame;this._sprite?this._spriteFrame=U.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e)}get spriteFrame(){return this._spriteFrame}set mesh(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mesh(){return this._renderable.mesh}set mask(e){this._mask!==e&&(this._mask=e,this._toggleMask())}get mask(){return this._mask}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._sprite&&(this._sprite.renderMode===ot||this._sprite.renderMode===st)&&this._updateSprite())}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}class Pb extends Q{constructor(e){super(),this._app=e,e.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}set defaultAsset(e){const t=e instanceof se?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get defaultAsset(){return this._defaultAsset}set localizedAsset(e){const t=e instanceof se?e.id:e;this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=t,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)))}get localizedAsset(){return this._localizedAsset}set autoLoad(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get autoLoad(){return this._autoLoad}set disableLocalization(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){const e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);const e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;const e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}_unbindLocalizedAsset(){const e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(e){this.fire("load",e)}_onLocalizedAssetChange(e,t,s,i){this.fire("change",e,t,s,i)}_onLocalizedAssetRemove(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)}_onLocaleAdd(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onLocaleRemove(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onSetLocale(e){if(!this._defaultAsset){this.localizedAsset=null;return}const t=this._app.assets.get(this._defaultAsset);if(!t||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}const s=t.getLocalizedAssetId(e);if(!s){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=s}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()}}const Cc="msdf",Rb="bitmap",Mc=0,fl=1,W_=2,Ib=3,H_=4,X_=5,$_=6,q_=7,Db=8,xN=` 	
\r\v\f`,SN=/[A-Z|a-z|0-9|_|-|/]/;class bN{constructor(e){this._symbols=e,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let e=this._read();for(;e===Db;)e=this._read();return e!==Mc&&e!==fl&&(this._last=this._index),e}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){const e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];let t=this.read(),s="";for(;s+=(s.length>0?`
`:"")+e[t]+" '"+this.buf().join("")+"'",!(t===Mc||t===fl);)t=this.read();return s}_read(){return this._buf=[],this._eof()?Mc:this._mode==="text"?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?W_:Mc;case"[":return this._mode="tag",this._buf.length>0?W_:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\");break}break;default:this._store();break}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",fl;case"[":return this._store(),Ib;case"]":return this._store(),this._mode="text",H_;case"=":return this._store(),X_;case" ":case"	":case`
`:case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",fl)}}_whitespace(){for(this._store();xN.indexOf(this._cur)!==-1;)this._store();return Db}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",fl;case'"':return this._next(),$_;default:this._store();break}}_identifier(){for(this._store();this._cur!==null&&this._isIdentifierSymbol(this._cur);)this._store();return q_}_isIdentifierSymbol(e){return e.length===1&&e.match(SN)!==null}_eof(){return this._cur===null}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(e){this._buf.push(e)}}class TN{constructor(e){this._scanner=new bN(e),this._error=null}parse(e,t){for(;;)switch(this._scanner.read()){case Mc:return!0;case fl:return!1;case W_:Array.prototype.push.apply(e,this._scanner.buf());break;case Ib:if(!this._parseTag(e,t))return!1;break;default:return!1}}error(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"}_parseTag(e,t){let s=this._scanner.read();if(s!==q_)return this._error="expected identifier",!1;const i=this._scanner.buf().join("");if(i[0]==="/"){for(let r=t.length-1;r>=0;--r)if(i==="/"+t[r].name&&t[r].end===null)return t[r].end=e.length,s=this._scanner.read(),s!==H_?(this._error="expected close bracket",!1):!0;return this._error="failed to find matching tag",!1}const n={name:i,value:null,attributes:{},start:e.length,end:null};if(s=this._scanner.read(),s===X_){if(s=this._scanner.read(),s!==$_)return this._error="expected string",!1;n.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case H_:return t.push(n),!0;case q_:{const r=this._scanner.buf().join("");if(s=this._scanner.read(),s!==X_)return this._error="expected equals",!1;if(s=this._scanner.read(),s!==$_)return this._error="expected string",!1;const a=this._scanner.buf().join("");n.attributes[r]=a;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}}function Lb(o,e){for(const t in e){if(!e.hasOwnProperty(t))continue;const s=e[t];s instanceof Object?(o.hasOwnProperty(t)||(o[t]={}),Lb(o[t],e[t])):o[t]=s}}function wN(o){if(o.length===0)return null;const e={};for(let t=0;t<o.length;++t){const s=o[t],i={};i[s.name]={value:s.value,attributes:s.attributes},Lb(e,i)}return e}function EN(o,e){if(o.length===0)return null;const t={};for(let c=0;c<o.length;++c){const d=o[c];t.hasOwnProperty(d.start)?t[d.start].open===null?t[d.start].open=[d]:t[d.start].open.push(d):t[d.start]={open:[d],close:null},t.hasOwnProperty(d.end)?t[d.end].close===null?t[d.end].close=[d]:t[d.end].close.push(d):t[d.end]={open:null,close:[d]}}let s=[];function i(c){s=s.filter(function(d){return c.find(function(u){return u===d})===void 0})}function n(c){for(let d=0;d<c.length;++d)s.push(c[d])}const r=Object.keys(t).sort(function(c,d){return c-d}),a=[];for(let c=0;c<r.length;++c){const d=t[r[c]];d.close!==null&&i(d.close),d.open!==null&&n(d.open),a.push({start:r[c],tags:wN(s)})}const l=[];let h=null;for(let c=0;c<a.length;++c){const d=a[c];for(;l.length<d.start;)l.push(h?h.tags:null);h=d}for(;l.length<e;)l.push(null);return l}function AN(o){const e=new TN(o),t=[],s=[];if(!e.parse(t,s))return console.warn(e.error()),{symbols:o,tags:null};const i=s.find(function(r){return r.end===null});if(i)return console.warn(`Markup error: found unclosed tag='${i.name}'`),{symbols:o,tags:null};const n=EN(s,t.length);return{symbols:t,tags:n}}class CN{static evaluate(e){return AN(e)}}class MN{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null}}function PN(o,e){const t=new Ut(o);return t.setPositions(e.positions),t.setNormals(e.normals),t.setColors32(e.colors),t.setUvs(0,e.uvs),t.setIndices(e.indices),t.setVertexStream(Fn,e.outlines,3,void 0,le,!1),t.setVertexStream(On,e.shadows,3,void 0,le,!1),t.update(),t}const Fb=/^[\r\n]$/,RN=/^[ \t]$/,Ob=/^[ \t\-]|[\u200b]$/,IN=/^[a-z0-9]$/i,Bb=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,DN=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,LN=["​","؜","‎","‏","‪","‫","‬","‭","‮","⁦","⁧","⁨","⁩"],FN={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},Nb=new H,ON=new G;class kb{constructor(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new Pb(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new H(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new G(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new we,this._model=new _i,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new ye,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new H(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new H(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new G(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(e,t){this._noResize||this._font&&this._updateText()}_onScreenChange(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onDrawOrderChange(e){if(this._drawOrder=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].drawOrder=e}_onPivotChange(e){this._font&&this._updateText()}_onLocaleSet(e){if(this._i18nKey){if(this.fontAsset){const t=this._system.app.assets.get(this.fontAsset);(!t||!t.resource||t.resource!==this._font)&&(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(e){if(this.unicodeConverter){const t=this._system.getUnicodeConverter();t?e=t(e):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==e&&(this._font&&this._updateText(e),this._text=e)}_updateText(e){let t;if(e===void 0&&(e=this._text),this._symbols=bi.getSymbols(e.normalize?e.normalize("NFC"):e),this._symbols.length===0&&(this._symbols=[" "]),this._enableMarkup){const d=CN.evaluate(this._symbols);this._symbols=d.symbols,t=d.tags||[]}if(this._rtlReorder){const d=this._system.app.systems.element.getRtlReorder();if(d){const u=d(this._symbols);this._rtl=u.rtl,this._symbols=u.mapping.map(function(f){return this._symbols[f]},this),t&&(t=u.mapping.map(function(f){return t[f]}))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;const s=(d,u)=>`${d.toString(!0).toLowerCase()}:${u.toFixed(2)}`,i=(d,u)=>`${d.toString(!0).toLowerCase()}:${u.x.toFixed(2)}:${u.y.toFixed(2)}`;if(t){const d={},u={},f={};this._colorPalette=[Math.round(this._color.r*255),Math.round(this._color.g*255),Math.round(this._color.b*255)],this._outlinePalette=[Math.round(this._outlineColor.r*255),Math.round(this._outlineColor.g*255),Math.round(this._outlineColor.b*255),Math.round(this._outlineColor.a*255),Math.round(this._outlineThickness*255)],this._shadowPalette=[Math.round(this._shadowColor.r*255),Math.round(this._shadowColor.g*255),Math.round(this._shadowColor.b*255),Math.round(this._shadowColor.a*255),Math.round(this._shadowOffset.x*127),Math.round(this._shadowOffset.y*127)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],d[this._color.toString(!1).toLowerCase()]=0,u[s(this._outlineColor,this._outlineThickness)]=0,f[i(this._shadowColor,this._shadowOffset)]=0;for(let p=0,_=this._symbols.length;p<_;++p){const m=t[p];let g=0;if(m&&m.color&&m.color.value){const v=m.color.value;if(v.length===7&&v[0]==="#"){const b=v.substring(1).toLowerCase();d.hasOwnProperty(b)?g=d[b]:/^([0-9a-f]{2}){3}$/.test(b)&&(g=this._colorPalette.length/3,d[b]=g,this._colorPalette.push(parseInt(b.substring(0,2),16)),this._colorPalette.push(parseInt(b.substring(2,4),16)),this._colorPalette.push(parseInt(b.substring(4,6),16)))}}this._symbolColors.push(g);let x=0;if(m&&m.outline&&(m.outline.attributes.color||m.outline.attributes.thickness)){let v=m.outline.attributes.color?Nb.fromString(m.outline.attributes.color):this._outlineColor,b=Number(m.outline.attributes.thickness);(Number.isNaN(v.r)||Number.isNaN(v.g)||Number.isNaN(v.b)||Number.isNaN(v.a))&&(v=this._outlineColor),Number.isNaN(b)&&(b=this._outlineThickness);const w=s(v,b);u.hasOwnProperty(w)?x=u[w]:(x=this._outlinePalette.length/5,u[w]=x,this._outlinePalette.push(Math.round(v.r*255),Math.round(v.g*255),Math.round(v.b*255),Math.round(v.a*255),Math.round(b*255)))}this._symbolOutlineParams.push(x);let S=0;if(m&&m.shadow&&(m.shadow.attributes.color||m.shadow.attributes.offset||m.shadow.attributes.offsetX||m.shadow.attributes.offsetY)){let v=m.shadow.attributes.color?Nb.fromString(m.shadow.attributes.color):this._shadowColor;const b=Number(m.shadow.attributes.offset),w=Number(m.shadow.attributes.offsetX),T=Number(m.shadow.attributes.offsetY);(Number.isNaN(v.r)||Number.isNaN(v.g)||Number.isNaN(v.b)||Number.isNaN(v.a))&&(v=this._shadowColor);const E=ON.set(Number.isNaN(w)?Number.isNaN(b)?this._shadowOffset.x:b:w,Number.isNaN(T)?Number.isNaN(b)?this._shadowOffset.y:b:T),C=i(v,E);f.hasOwnProperty(C)?S=f[C]:(S=this._shadowPalette.length/6,f[C]=S,this._shadowPalette.push(Math.round(v.r*255),Math.round(v.g*255),Math.round(v.b*255),Math.round(v.a*255),Math.round(E.x*127),Math.round(E.y*127)))}this._symbolShadowParams.push(S)}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();const n=this._calculateCharsPerTexture();let r=!1;const a=this._element,l=a._isScreenSpace(),h=a._isScreenCulled(),c=function(u){return a.isVisibleForCamera(u)};for(let d=0,u=this._meshInfo.length;d<u;d++){const f=n[d]||0,p=this._meshInfo[d];if(p.count!==f){if(r||(a.removeModelFromLayers(this._model),r=!0),p.count=f,p.positions.length=p.normals.length=f*3*4,p.indices.length=f*3*2,p.uvs.length=f*2*4,p.colors.length=f*4*4,p.outlines.length=f*4*3,p.shadows.length=f*4*3,p.meshInstance&&this._removeMeshInstance(p.meshInstance),f===0){p.meshInstance=null;continue}for(let g=0;g<f;g++)p.indices[g*3*2+0]=g*4,p.indices[g*3*2+1]=g*4+1,p.indices[g*3*2+2]=g*4+3,p.indices[g*3*2+3]=g*4+2,p.indices[g*3*2+4]=g*4+3,p.indices[g*3*2+5]=g*4+1,p.normals[g*4*3+0]=0,p.normals[g*4*3+1]=0,p.normals[g*4*3+2]=-1,p.normals[g*4*3+3]=0,p.normals[g*4*3+4]=0,p.normals[g*4*3+5]=-1,p.normals[g*4*3+6]=0,p.normals[g*4*3+7]=0,p.normals[g*4*3+8]=-1,p.normals[g*4*3+9]=0,p.normals[g*4*3+10]=0,p.normals[g*4*3+11]=-1;const _=PN(this._system.app.graphicsDevice,p),m=new Te(_,this._material,this._node);if(m.name="Text Element: "+this._entity.name,m.castShadow=!1,m.receiveShadow=!1,m.cull=!l,m.screenSpace=l,m.drawOrder=this._drawOrder,h&&(m.cull=!0,m.isVisibleFunc=c),this._setTextureParams(m,this._font.textures[d]),m.setParameter("material_emissive",this._colorUniform),m.setParameter("material_opacity",this._color.a),m.setParameter("font_sdfIntensity",this._font.intensity),m.setParameter("font_pxrange",this._getPxRange(this._font)),m.setParameter("font_textureWidth",this._font.data.info.maps[d].width),m.setParameter("outline_color",this._outlineColorUniform),m.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),m.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else{const g=-this._font.data.info.maps[d].width/this._font.data.info.maps[d].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=g*this._shadowOffsetScale*this._shadowOffset.y}m.setParameter("shadow_offset",this._shadowOffsetUniform),p.meshInstance=m,this._model.meshInstances.push(m)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),r&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(e){e.destroy();const t=this._model.meshInstances.indexOf(e);t!==-1&&this._model.meshInstances.splice(t,1)}_setMaterial(e){if(this._material=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++){const i=this._model.meshInstances[t];i.material=e}}_updateMaterial(e){const t=this._element,s=t._isScreenCulled(),i=function(a){return t.isVisibleForCamera(a)},n=this._font&&this._font.type===Cc;if(this._material=this._system.getTextElementMaterial(e,n,this._enableMarkup),this._model)for(let r=0,a=this._model.meshInstances.length;r<a;r++){const l=this._model.meshInstances[r];l.cull=!e,l.material=this._material,l.screenSpace=e,s?(l.cull=!0,l.isVisibleFunc=i):l.isVisibleFunc=null}}_updateMaterialEmissive(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b)}_updateMaterialOutline(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a)}_updateMaterialShadow(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a)}_isWordBoundary(e){return Ob.test(e)}_isValidNextChar(e){return e!==null&&!DN.test(e)}_isNextCJKBoundary(e,t){return Bb.test(e)&&(Ob.test(t)||IN.test(t))}_isNextCJKWholeWord(e){return Bb.test(e)}_updateMeshes(){const e=this._font.data,t=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,n=this._shouldAutoFit();n&&(this._fontSize=this._maxFontSize);const r=32,a=this._symbols.length;let l=0,h=0,c=0,d=0,u=1,f=0,p=0,_=0,m=0,g=0,x=0;const S=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;let v=this._element.calculatedWidth;(this.autoWidth&&!S||!this._wrapLines)&&(v=Number.POSITIVE_INFINITY);let b=0,w=0,T,E,C,M;function O(A,L,F){t._lineWidths.push(Math.abs(F));const N=_>L?L+1:_,V=_>L?_+1:L,k=A.slice(N,V);if(x){let $=k.length;for(;$--&&x>0;)Fb.test(k[$])&&(k.splice($,1),x--)}t._lineContents.push(k.join("")),l=0,h-=t._scaledLineHeight,u++,m=0,g=0,x=0,f=0,_=L}let I=!0;for(;I;){I=!1,n?this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._scaledLineHeight=this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],l=0,h=0,c=0,d=0,u=1,f=0,p=0,_=0,m=0,g=0,x=0;const A=this._fontSize/r;b=this._fontMinY*A,w=this._fontMaxY*A;for(let ie=0;ie<this._meshInfo.length;ie++)this._meshInfo[ie].quad=0,this._meshInfo[ie].lines={};let L=255,F=255,N=255,V=255+255*256,k=255+255*256,$=0,j=255+255*256,K=255+255*256,ee=127+127*256;for(let ie=0;ie<a;ie++){if(T=this._symbols[ie],M=ie+1>=a?null:this._symbols[ie+1],Fb.test(T)){x++,(!this._wrapLines||this._maxLines<0||u<this._maxLines)&&(O(this._symbols,ie,d),p=ie+1,_=ie+1);continue}let It=0,Ht=0,Xt=0,Ml=1,hE,cE;if(E=e.chars[T],!E)if(LN.indexOf(T)!==-1)E=FN;else if(e.chars[" "])E=e.chars[" "];else for(const De in e.chars){E=e.chars[De];break}if(E){let De=0;if(g>0){const $f=this._font.data.kerning;if($f){const qf=$f[bi.getCodePoint(this._symbols[ie-1])||0];qf&&(De=qf[bi.getCodePoint(this._symbols[ie])||0]||0)}}hE=E.scale||1,cE=(E.width+E.height)/2,Ml=A*cE/hE,Xt=(E.xadvance+De)*A,It=(E.xoffset-De)*A,Ht=E.yoffset*A}else console.error(`Couldn't substitute missing character: '${T}'`);const dE=RN.test(T),iy=E&&E.map||0,Xz=-this._font.data.info.maps[iy].width/this._font.data.info.maps[iy].height,Y=this._meshInfo[iy],uE=l+this._spacing*Xt;if(uE>v&&g>0&&!dE&&(this._maxLines<0||u<this._maxLines))if(m===0)p=ie,O(this._symbols,ie,d);else{const De=Math.max(ie-p,0);if(this._meshInfo.length<=1)Y.lines[u-1]-=De,Y.quad-=De;else{const $f=p,qf=ie;for(let ay=$f;ay<qf;ay++){const $z=this._symbols[ay],pE=e.chars[$z],mE=this._meshInfo[pE&&pE.map||0];mE.lines[u-1]-=1,mE.quad-=1}}ie-=De+1,O(this._symbols,p,f);continue}C=Y.quad,Y.lines[u-1]=C;let Xf=l-It,ny=Xf+Ml;const ry=h-Ht,fE=ry+Ml;if(this._rtl){const De=Ml-It-this._spacing*Xt-It;Xf-=De,ny-=De}Y.positions[C*4*3+0]=Xf,Y.positions[C*4*3+1]=ry,Y.positions[C*4*3+2]=c,Y.positions[C*4*3+3]=ny,Y.positions[C*4*3+4]=ry,Y.positions[C*4*3+5]=c,Y.positions[C*4*3+6]=ny,Y.positions[C*4*3+7]=fE,Y.positions[C*4*3+8]=c,Y.positions[C*4*3+9]=Xf,Y.positions[C*4*3+10]=fE,Y.positions[C*4*3+11]=c,this.width=Math.max(this.width,uE);let _r;if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(_r=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),_r=U.clamp(_r,s,i),_r!==this._element.fontSize)){this._fontSize=_r,I=!0;break}if(this.height=Math.max(this.height,w-(h+b)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(_r=U.clamp(this._fontSize-1,s,i),_r!==this._element.fontSize)){this._fontSize=_r,I=!0;break}l+=this._spacing*Xt,dE||(d=l),(this._isWordBoundary(T)||this._isValidNextChar(M)&&(this._isNextCJKBoundary(T,M)||this._isNextCJKWholeWord(M)))&&(m++,f=d,p=ie+1),g++;const gr=this._getUv(T);if(Y.uvs[C*4*2+0]=gr[0],Y.uvs[C*4*2+1]=1-gr[1],Y.uvs[C*4*2+2]=gr[2],Y.uvs[C*4*2+3]=1-gr[1],Y.uvs[C*4*2+4]=gr[2],Y.uvs[C*4*2+5]=1-gr[3],Y.uvs[C*4*2+6]=gr[0],Y.uvs[C*4*2+7]=1-gr[3],this._symbolColors){const De=this._symbolColors[ie]*3;L=this._colorPalette[De],F=this._colorPalette[De+1],N=this._colorPalette[De+2]}if(Y.colors[C*4*4+0]=L,Y.colors[C*4*4+1]=F,Y.colors[C*4*4+2]=N,Y.colors[C*4*4+3]=255,Y.colors[C*4*4+4]=L,Y.colors[C*4*4+5]=F,Y.colors[C*4*4+6]=N,Y.colors[C*4*4+7]=255,Y.colors[C*4*4+8]=L,Y.colors[C*4*4+9]=F,Y.colors[C*4*4+10]=N,Y.colors[C*4*4+11]=255,Y.colors[C*4*4+12]=L,Y.colors[C*4*4+13]=F,Y.colors[C*4*4+14]=N,Y.colors[C*4*4+15]=255,this._symbolOutlineParams){const De=this._symbolOutlineParams[ie]*5;V=this._outlinePalette[De]+this._outlinePalette[De+1]*256,k=this._outlinePalette[De+2]+this._outlinePalette[De+3]*256,$=this._outlinePalette[De+4]}if(Y.outlines[C*4*3+0]=V,Y.outlines[C*4*3+1]=k,Y.outlines[C*4*3+2]=$,Y.outlines[C*4*3+3]=V,Y.outlines[C*4*3+4]=k,Y.outlines[C*4*3+5]=$,Y.outlines[C*4*3+6]=V,Y.outlines[C*4*3+7]=k,Y.outlines[C*4*3+8]=$,Y.outlines[C*4*3+9]=V,Y.outlines[C*4*3+10]=k,Y.outlines[C*4*3+11]=$,this._symbolShadowParams){const De=this._symbolShadowParams[ie]*6;j=this._shadowPalette[De]+this._shadowPalette[De+1]*256,K=this._shadowPalette[De+2]+this._shadowPalette[De+3]*256,ee=this._shadowPalette[De+4]+127+Math.round(Xz*this._shadowPalette[De+5]+127)*256}Y.shadows[C*4*3+0]=j,Y.shadows[C*4*3+1]=K,Y.shadows[C*4*3+2]=ee,Y.shadows[C*4*3+3]=j,Y.shadows[C*4*3+4]=K,Y.shadows[C*4*3+5]=ee,Y.shadows[C*4*3+6]=j,Y.shadows[C*4*3+7]=K,Y.shadows[C*4*3+8]=ee,Y.shadows[C*4*3+9]=j,Y.shadows[C*4*3+10]=K,Y.shadows[C*4*3+11]=ee,Y.quad++}I||_<a&&O(this._symbols,a,l)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;const B=this._element.pivot.x,P=this._element.pivot.y,D=this._alignment.x,R=this._alignment.y;for(let A=0;A<this._meshInfo.length;A++){if(this._meshInfo[A].count===0)continue;let L=0;for(const k in this._meshInfo[A].lines){const $=this._meshInfo[A].lines[k],j=this._lineWidths[parseInt(k,10)],K=-B*this._element.calculatedWidth+D*(this._element.calculatedWidth-j)*(this._rtl?-1:1),ee=(1-P)*this._element.calculatedHeight-w-(1-R)*(this._element.calculatedHeight-this.height);for(let ie=L;ie<=$;ie++)this._meshInfo[A].positions[ie*4*3]+=K,this._meshInfo[A].positions[ie*4*3+3]+=K,this._meshInfo[A].positions[ie*4*3+6]+=K,this._meshInfo[A].positions[ie*4*3+9]+=K,this._meshInfo[A].positions[ie*4*3+1]+=ee,this._meshInfo[A].positions[ie*4*3+4]+=ee,this._meshInfo[A].positions[ie*4*3+7]+=ee,this._meshInfo[A].positions[ie*4*3+10]+=ee;if(this._rtl)for(let ie=L;ie<=$;ie++){const Ke=ie*4*3;for(let Xt=0;Xt<4;++Xt)this._meshInfo[A].positions[Ke+Xt*3]=this._element.calculatedWidth-this._meshInfo[A].positions[Ke+Xt*3]+K*2;const It=this._meshInfo[A].positions[Ke+3],Ht=this._meshInfo[A].positions[Ke+6];this._meshInfo[A].positions[Ke+3]=this._meshInfo[A].positions[Ke+0],this._meshInfo[A].positions[Ke+6]=this._meshInfo[A].positions[Ke+9],this._meshInfo[A].positions[Ke+0]=It,this._meshInfo[A].positions[Ke+9]=Ht}L=$+1}const F=this._meshInfo[A].count*4,N=this._meshInfo[A].quad*4,V=new Kr(this._meshInfo[A].meshInstance.mesh.vertexBuffer);for(let k=0;k<F;k++)k>=N?(V.element[We].set(0,0,0),V.element[Lt].set(0,0),V.element[_t].set(0,0,0,0),V.element[Fn].set(0,0,0,0),V.element[On].set(0,0,0,0)):(V.element[We].set(this._meshInfo[A].positions[k*3+0],this._meshInfo[A].positions[k*3+1],this._meshInfo[A].positions[k*3+2]),V.element[Lt].set(this._meshInfo[A].uvs[k*2+0],this._meshInfo[A].uvs[k*2+1]),V.element[_t].set(this._meshInfo[A].colors[k*4+0],this._meshInfo[A].colors[k*4+1],this._meshInfo[A].colors[k*4+2],this._meshInfo[A].colors[k*4+3]),V.element[Fn].set(this._meshInfo[A].outlines[k*3+0],this._meshInfo[A].outlines[k*3+1],this._meshInfo[A].outlines[k*3+2]),V.element[On].set(this._meshInfo[A].shadows[k*3+0],this._meshInfo[A].shadows[k*3+1],this._meshInfo[A].shadows[k*3+2])),V.next();V.end(),this._meshInfo[A].meshInstance.mesh.aabb.compute(this._meshInfo[A].positions),this._meshInfo[A].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(e){this.font!==e.resource&&(this.font=e.resource)}_onFontChange(e,t,s,i){if(t==="data"){this._font.data=s;const n=this._font.data.info.maps.length;for(let r=0;r<n;r++){if(!this._meshInfo[r])continue;const a=this._meshInfo[r].meshInstance;a&&(a.setParameter("font_sdfIntensity",this._font.intensity),a.setParameter("font_pxrange",this._getPxRange(this._font)),a.setParameter("font_textureWidth",this._font.data.info.maps[r].width))}}}_onFontRemove(e){}_setTextureParams(e,t){this._font&&(this._font.type===Cc?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):this._font.type===Rb&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)))}_getPxRange(e){const t=Object.keys(this._font.data.chars);for(let s=0;s<t.length;s++){const i=this._font.data.chars[t[s]];if(i.range)return(i.scale||1)*i.range}return 2}_getUv(e){const t=this._font.data;if(!t.chars[e]){const f=" ";return t.chars[f]?this._getUv(f):[0,0,0,0]}const s=t.chars[e].map,i=t.info.maps[s].width,n=t.info.maps[s].height,r=t.chars[e].x,a=t.chars[e].y,l=r,h=a,c=r+t.chars[e].width,d=a-t.chars[e].height,u=1-t.chars[e].height/n;return[l/i,u-h/n,c/i,u-d/n]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(e){if(this._model){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].stencilFront=e,t[s].stencilBack=e}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(e){const t={};e===void 0&&(e=this._symbols.length);for(let s=0,i=e;s<i;s++){const n=this._symbols[s];let r=this._font.data.chars[n];r||(r=this._font.data.chars[" "],r||(r=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));const a=r.map;t[a]?t[a]++:t[a]=1}return t}_updateRenderRange(){const e=this._rangeStart===0?0:this._calculateCharsPerTexture(this._rangeStart),t=this._rangeEnd===0?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){const n=e[s]||0,r=t[s]||0,a=this._meshInfo[s].meshInstance;if(a){const l=a.mesh;l&&(l.primitive[0].base=n*3*2,l.primitive[0].count=(r-n)*3*2)}}}set text(e){this._i18nKey=null;const t=e!=null&&e.toString()||"";this._setText(t)}get text(){return this._text}set key(e){const t=e!==null?e.toString():null;this._i18nKey!==t&&(this._i18nKey=t,t?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get key(){return this._i18nKey}set color(e){const t=e.r,s=e.g,i=e.b;if(!(this._color.r===t&&this._color.g===s&&this._color.b===i)&&(this._color.r=t,this._color.g=s,this._color.b=i,!!this._model)){if(this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(let n=0,r=this._model.meshInstances.length;n<r;n++)this._model.meshInstances[n].setParameter("material_emissive",this._colorUniform)}this._element&&this._element.fire("set:color",this._color)}}get color(){return this._color}set opacity(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].setParameter("material_opacity",e);this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set lineHeight(e){const t=this._lineHeight;this._lineHeight=e,this._scaledLineHeight=e,t!==e&&this._font&&this._updateText()}get lineHeight(){return this._lineHeight}set wrapLines(e){const t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(e){const t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText()}get spacing(){return this._spacing}set fontSize(e){const t=this._fontSize;this._fontSize=e,this._originalFontSize=e,t!==e&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontAsset(e){this._fontAsset.defaultAsset=e}get fontAsset(){return this._fontAsset.localizedAsset}set font(e){let t;if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,!e)return;const s=this._font.data;for(const n in s.chars){const r=s.chars[n];r.bounds&&(this._fontMinY=Math.min(this._fontMinY,r.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,r.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==t){const n=this._element._isScreenSpace();this._updateMaterial(n)}for(let n=0,r=this._font.textures.length;n<r;n++)if(!this._meshInfo[n])this._meshInfo[n]=new MN;else{const a=this._meshInfo[n].meshInstance;a&&(a.setParameter("font_sdfIntensity",this._font.intensity),a.setParameter("font_pxrange",this._getPxRange(this._font)),a.setParameter("font_textureWidth",this._font.data.info.maps[n].width),this._setTextureParams(a,this._font.textures[n]))}let i=!1;for(let n=this._font.textures.length;n<this._meshInfo.length;n++)this._meshInfo[n].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[n].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get font(){return this._font}set alignment(e){e instanceof G?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText()}get alignment(){return this._alignment}set autoWidth(e){const t=this._autoWidth;if(this._autoWidth=e,e&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),t!==e){const s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoWidth(){return this._autoWidth}set autoHeight(e){const t=this._autoHeight;if(this._autoHeight=e,e&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),t!==e){const s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set rtlReorder(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText())}get rtlReorder(){return this._rtlReorder}set unicodeConverter(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text))}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let e=!1;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=!0));this._aabbDirty=!1}return this._aabb}set outlineColor(e){const t=e instanceof H?e.r:e[0],s=e instanceof H?e.g:e[1],i=e instanceof H?e.b:e[2],n=e instanceof H?e.a:e[3];if(!(this._outlineColor.r===t&&this._outlineColor.g===s&&this._outlineColor.b===i&&this._outlineColor.a===n)&&(this._outlineColor.r=t,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=n,!!this._model)){if(this._symbolOutlineParams)this._font&&this._updateText();else{this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(let r=0,a=this._model.meshInstances.length;r<a;r++)this._model.meshInstances[r].setParameter("outline_color",this._outlineColorUniform)}this._element&&this._element.fire("set:outline",this._color)}}get outlineColor(){return this._outlineColor}set outlineThickness(e){const t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(let s=0,i=this._model.meshInstances.length;s<i;s++)this._model.meshInstances[s].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}get outlineThickness(){return this._outlineThickness}set shadowColor(e){const t=e instanceof H?e.r:e[0],s=e instanceof H?e.g:e[1],i=e instanceof H?e.b:e[2],n=e instanceof H?e.a:e[3];if(!(this._shadowColor.r===t&&this._shadowColor.g===s&&this._shadowColor.b===i&&this._shadowColor.a===n)&&(this._shadowColor.r=t,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=n,!!this._model))if(this._symbolShadowParams)this._font&&this._updateText();else{this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(let r=0,a=this._model.meshInstances.length;r<a;r++)this._model.meshInstances[r].setParameter("shadow_color",this._shadowColorUniform)}}get shadowColor(){return this._shadowColor}set shadowOffset(e){const t=e instanceof G?e.x:e[0],s=e instanceof G?e.y:e[1];if(!(this._shadowOffset.x===t&&this._shadowOffset.y===s)&&(this._shadowOffset.set(t,s),this._font&&this._model))if(this._symbolShadowParams)this._updateText();else for(let i=0,n=this._model.meshInstances.length;i<n;i++){const r=-this._font.data.info.maps[i].width/this._font.data.info.maps[i].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=r*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[i].setParameter("shadow_offset",this._shadowOffsetUniform)}}get shadowOffset(){return this._shadowOffset}set minFontSize(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get minFontSize(){return this._minFontSize}set maxFontSize(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set autoFitWidth(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set maxLines(e){this._maxLines!==e&&(e===null&&this._maxLines===-1||(this._maxLines=e===null?-1:e,this.font&&this._wrapLines&&this._updateText()))}get maxLines(){return this._maxLines}set enableMarkup(e){if(e=!!e,this._enableMarkup===e)return;this._enableMarkup=e,this.font&&this._updateText();const t=this._element._isScreenSpace();this._updateMaterial(t)}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return this._symbolColors===null?null:this._symbolColors.map(function(e){return this._colorPalette.slice(e*3,e*3+3)},this)}get symbolOutlineParams(){return this._symbolOutlineParams===null?null:this._symbolOutlineParams.map(function(e){return this._outlinePalette.slice(e*5,e*5+5)},this)}get symbolShadowParams(){return this._symbolShadowParams===null?null:this._symbolShadowParams.map(function(e){return this._shadowPalette.slice(e*6,e*6+6)},this)}get rtl(){return this._rtl}set rangeStart(e){e=Math.max(0,Math.min(e,this._symbols.length)),e!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange())}get rangeStart(){return this._rangeStart}set rangeEnd(e){e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)),e!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}}const j_=new y,Ub=new W,yn=new y,BN=new y,Ys=new W,Zu=new W,Qu=new W,pl=new W;class Rt extends he{constructor(e,t){super(e,t),this._beingInitialized=!1,this._anchor=new X,this._localAnchor=new X,this._pivot=new G,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new X(0,0,-32,-32),this._modelTransform=new W,this._screenToWorld=new W,this._anchorTransform=new W,this._anchorDirty=!0,this._parentWorldTransform=new W,this._screenTransform=new W,this._screenCorners=[new y,new y,new y,new y],this._canvasCorners=[new G,new G,new G,new G],this._worldCorners=[new y,new y,new y,new y],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=Sc,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._fitMode=bc,this._useInput=!1,this._layers=[Fh],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(e){e instanceof X?this._anchor.copy(e):this._anchor.set(...e),!this.entity._parent&&!this.screen?this._calculateLocalAnchors():this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}get anchor(){return this._anchor}set batchGroupId(e){if(this._batchGroupId!==e){if(this.entity.enabled&&this._batchGroupId>=0){var t;(t=this.system.app.batcher)==null||t.remove(it.ELEMENT,this.batchGroupId,this.entity)}if(this.entity.enabled&&e>=0){var s;(s=this.system.app.batcher)==null||s.insert(it.ELEMENT,e,this.entity)}e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set bottom(e){this._margin.y=e;const t=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+e;this._setHeight(s-i),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t)}get bottom(){return this._margin.y}set calculatedWidth(e){this._setCalculatedWidth(e,!0)}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(e){this._setCalculatedHeight(e,!0)}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;const e=this.system.app.graphicsDevice,t=this.screenCorners,s=e.canvas.clientWidth/e.width,i=e.canvas.clientHeight/e.height;for(let n=0;n<4;n++)this._canvasCorners[n].set(t[n].x*s,(e.height-t[n].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}set drawOrder(e){let t=0;this.screen&&(t=this.screen.screen.priority),e>16777215&&(e=16777215),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder)}get drawOrder(){return this._drawOrder}set height(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}get height(){return this._height}set layers(e){if(this._addedModels.length)for(let t=0;t<this._layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);if(s)for(let i=0;i<this._addedModels.length;i++)s.removeMeshInstances(this._addedModels[i].meshInstances)}if(this._layers=e,!(!this.enabled||!this.entity.enabled||!this._addedModels.length))for(let t=0;t<this._layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this._layers[t]);if(s)for(let i=0;i<this._addedModels.length;i++)s.addMeshInstances(this._addedModels[i].meshInstances)}}get layers(){return this._layers}set left(e){this._margin.x=e;const t=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+e;this._setWidth(s-i),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t)}get left(){return this._margin.x}set margin(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(e){const{pivot:t,margin:s}=this,i=t.x,n=t.y;e instanceof G?t.copy(e):t.set(...e);const r=s.x+s.z,a=t.x-i;s.x+=r*a,s.z-=r*a;const l=s.y+s.w,h=t.y-n;s.y+=l*h,s.w-=l*h,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",t)}get pivot(){return this._pivot}set right(e){this._margin.z=e;const t=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-e;this._setWidth(i-s),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t)}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;const e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);const t=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),t&&this._screenCorners[s].mulScalar(this.screen.screen.scale),e&&this._screenCorners[s].add(e);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(e){this._margin.w=e;const t=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-e;this._setHeight(i-s),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t)}get top(){return this._margin.w}set type(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===$u?this._image=new Mb(this):e===N_&&(this._text=new kb(this)))}get type(){return this._type}set useInput(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e))}get useInput(){return this._useInput}set fitMode(e){this._fitMode=e,this._calculateSize(!0,!0),this._image&&this._image.refreshMesh()}get fitMode(){return this._fitMode}set width(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){const e=this.screenCorners;if(!this.screen.screen.screenSpace){Ys.copy(this.screen.screen._screenMatrix),Ys.data[13]=-Ys.data[13],Ys.mul2(this.screen.getWorldTransform(),Ys);for(let t=0;t<4;t++)Ys.transformPoint(e[t],this._worldCorners[t])}}else{const e=this.entity.getLocalPosition();Ys.setTranslate(-e.x,-e.y,-e.z),Zu.setTRS(y.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),Qu.setTranslate(e.x,e.y,e.z);const t=this.entity.parent?this.entity.parent:this.entity;pl.copy(t.getWorldTransform()),pl.mul(Qu).mul(Zu).mul(Ys),yn.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),pl.transformPoint(yn,this._worldCorners[0]),yn.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),pl.transformPoint(yn,this._worldCorners[1]),yn.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),pl.transformPoint(yn,this._worldCorners[2]),yn.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),pl.transformPoint(yn,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=Ce.prototype._sync,this.entity.setPosition=Ce.prototype.setPosition,this.entity.setLocalPosition=Ce.prototype.setLocalPosition}_setPosition(e,t,s){if(!this.element.screen){Ce.prototype.setPosition.call(this,e,t,s);return}e instanceof y?j_.copy(e):j_.set(e,t,s),this.getWorldTransform(),Ub.copy(this.element._screenToWorld).invert(),Ub.transformPoint(j_,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}_setLocalPosition(e,t,s){e instanceof y?this.localPosition.copy(e):this.localPosition.set(e,t,s);const i=this.element,n=this.localPosition,r=i._pivot;i._margin.x=n.x-i._calculatedWidth*r.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=n.y-i._calculatedHeight*r.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){const e=this.element,t=e.screen;if(t){if(e._anchorDirty){let s=0,i=0,n=0,r=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,r=this._parent.element.pivot.y;else{const a=t.screen.resolution;s=a.x/t.screen.scale,i=a.y/t.screen.scale}e._anchorTransform.setTranslate(s*(e.anchor.x-n),-(i*(r-e.anchor.y)),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);const s=this.localPosition,i=e._pivot;e._margin.x=s.x-e._calculatedWidth*i.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=s.y-e._calculatedHeight*i.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1}if(!t){this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),Ce.prototype._sync.call(this);return}if(this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);const s=e._parentWorldTransform;s.setIdentity();const i=this._parent;i&&i.element&&i!==t&&(Ys.setTRS(y.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,Ys));const n=yn;n.set(0,0,this.localPosition.z);const r=BN;r.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),Ys.setTranslate(-r.x,-r.y,-r.z),Zu.setTRS(n,this.getLocalRotation(),this.getLocalScale()),Qu.setTranslate(r.x,r.y,r.z),e._screenTransform.mul2(e._parentWorldTransform,Qu).mul(Zu).mul(Ys),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=!1}}_onInsert(e){const t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask()}_dirtifyMask(){let e=this.entity;for(;e;){const t=e.parent;if((t===null||t.screen)&&e.element){(!this.system._prerender||!this.system._prerender.length)&&(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));const s=this.system._prerender.indexOf(this.entity);s>=0&&this.system._prerender.splice(s,1),this.system._prerender.indexOf(e)<0&&this.system._prerender.push(e)}e=t}}_onPrerender(){for(let e=0;e<this.system._prerender.length;e++){const t=this.system._prerender[e];t.element&&t.element.syncMask(1)}this.system._prerender.length=0}_bindScreen(e){e._bindElement(this)}_unbindScreen(e){e._unbindElement(this)}_updateScreen(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);const t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=!0;const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(e){const t=this._parseUpToScreen();this._updateMask(t.mask,e)}_setMaskedBy(e){const t=this._image||this._text;if(e){const s=e.element._image._maskRef;t==null||t._setStencil(new cs({ref:s,func:Nl})),this._maskedBy=e}else t==null||t._setStencil(null),this._maskedBy=null}_updateMask(e,t){if(e){if(this._setMaskedBy(e),this.mask){const r=e.element._image._maskRef,a=new cs({ref:r,func:Nl,zpass:$y});this._image._setStencil(a),this._image._maskRef=t,t++,e=this.entity}const n=this.entity.children;for(let r=0,a=n.length;r<a;r++){var s;(s=n[r].element)==null||s._updateMask(e,t)}this.mask&&t--}else{if(this._setMaskedBy(null),this.mask){const r=new cs({ref:t,func:Ci,zpass:Xy});this._image._setStencil(r),this._image._maskRef=t,t++,e=this.entity}const n=this.entity.children;for(let r=0,a=n.length;r<a;r++){var i;(i=n[r].element)==null||i._updateMask(e,t)}this.mask&&t--}}_parseUpToScreen(){const e={screen:null,mask:null};let t=this.entity._parent;for(;t&&!t.screen;)t.element&&t.element.mask&&(e.mask||(e.mask=t)),t=t.parent;return t&&t.screen&&(e.screen=t),e}_onScreenResize(e){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let e=1e3,t=1e3;const s=this.entity._parent;if(s&&s.element)e=s.element.calculatedWidth,t=s.element.calculatedHeight;else if(this.screen){const i=this.screen.screen.resolution,n=this.screen.screen.scale;e=i.x/n,t=i.y/n}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t)}getOffsetPosition(e,t){const s=this.entity.getLocalPosition().clone();return s.x+=e,s.y+=t,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(e){this.layers.indexOf(e.id)<0||(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))}onEnable(){if(this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0){var e;(e=this.system.app.batcher)==null||e.insert(it.ELEMENT,this.batchGroupId,this.entity)}this.fire("enableelement")}onDisable(){if(this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0){var e;(e=this.system.app.batcher)==null||e.remove(it.ELEMENT,this.batchGroupId,this.entity)}this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(e,t){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();const s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;e?this._setWidth(s):this._setCalculatedWidth(s,!1),t?this._setHeight(i):this._setCalculatedHeight(i,!1);const n=this.entity.getLocalPosition();n.x=this._margin.x+this._calculatedWidth*this._pivot.x,n.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n),this._sizeDirty=!1}_setWidth(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)}_setHeight(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)}_setCalculatedWidth(e,t){if(!(Math.abs(e-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){const s=this.entity.getLocalPosition(),i=this._pivot;this._margin.x=s.x-this._calculatedWidth*i.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(e,t){if(!(Math.abs(e-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){const s=this.entity.getLocalPosition(),i=this._pivot;this._margin.y=s.y-this._calculatedHeight*i.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){const e=this.entity._children;for(let t=0,s=e.length;t<s;t++)e[t].element&&(e[t].element._anchorDirty=!0,e[t].element._sizeDirty=!0)}addModelToLayers(e){this._addedModels.push(e);for(let t=0;t<this.layers.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.addMeshInstances(e.meshInstances)}}removeModelFromLayers(e){const t=this._addedModels.indexOf(e);t>=0&&this._addedModels.splice(t,1);for(let s=0;s<this.layers.length;s++){const i=this.system.app.scene.layers.getLayerById(this.layers[s]);i&&i.removeMeshInstances(e.meshInstances)}}getMaskOffset(){const e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);const t=this._maskOffset;return this._maskOffset-=.001,t}isVisibleForCamera(e){let t,s,i,n;if(this.maskedBy){const d=this.maskedBy.element.screenCorners;t=Math.min(Math.min(d[0].x,d[1].x),Math.min(d[2].x,d[3].x)),s=Math.max(Math.max(d[0].x,d[1].x),Math.max(d[2].x,d[3].x)),n=Math.min(Math.min(d[0].y,d[1].y),Math.min(d[2].y,d[3].y)),i=Math.max(Math.max(d[0].y,d[1].y),Math.max(d[2].y,d[3].y))}else{const d=this.system.app.graphicsDevice.width,u=this.system.app.graphicsDevice.height,f=e._rect.z*d,p=e._rect.w*u;t=e._rect.x*d,s=t+f,i=(1-e._rect.y)*u,n=i-p}const r=this.screenCorners,a=Math.min(Math.min(r[0].x,r[1].x),Math.min(r[2].x,r[3].x)),l=Math.max(Math.max(r[0].x,r[1].x),Math.max(r[2].x,r[3].x)),h=Math.min(Math.min(r[0].y,r[1].y),Math.min(r[2].y,r[3].y)),c=Math.max(Math.max(r[0].y,r[1].y),Math.max(r[2].y,r[3].y));return!(l<t||a>s||h>i||c<n)}_isScreenSpace(){return this.screen&&this.screen.screen?this.screen.screen.screenSpace:!1}_isScreenCulled(){return this.screen&&this.screen.screen?this.screen.screen.cull:!1}_dirtyBatch(){if(this.batchGroupId!==-1){var e;(e=this.system.app.batcher)==null||e.markGroupDirty(this.batchGroupId)}}}Rt.EVENT_MOUSEDOWN="mousedown",Rt.EVENT_MOUSEUP="mouseup",Rt.EVENT_MOUSEENTER="mouseenter",Rt.EVENT_MOUSELEAVE="mouseleave",Rt.EVENT_MOUSEMOVE="mousemove",Rt.EVENT_MOUSEWHEEL="mousewheel",Rt.EVENT_CLICK="click",Rt.EVENT_TOUCHSTART="touchstart",Rt.EVENT_TOUCHEND="touchend",Rt.EVENT_TOUCHMOVE="touchmove",Rt.EVENT_TOUCHCANCEL="touchcancel";function _e(o){Object.defineProperty(Rt.prototype,o,{get:function(){return this._text?this._text[o]:this._image?this._image[o]:null},set:function(e){this._text?(this._text[o]!==e&&this._dirtyBatch(),this._text[o]=e):this._image&&(this._image[o]!==e&&this._dirtyBatch(),this._image[o]=e)}})}_e("fontSize"),_e("minFontSize"),_e("maxFontSize"),_e("maxLines"),_e("autoFitWidth"),_e("autoFitHeight"),_e("color"),_e("font"),_e("fontAsset"),_e("spacing"),_e("lineHeight"),_e("wrapLines"),_e("lines"),_e("alignment"),_e("autoWidth"),_e("autoHeight"),_e("rtlReorder"),_e("unicodeConverter"),_e("text"),_e("key"),_e("texture"),_e("textureAsset"),_e("material"),_e("materialAsset"),_e("sprite"),_e("spriteAsset"),_e("spriteFrame"),_e("pixelsPerUnit"),_e("opacity"),_e("rect"),_e("mask"),_e("outlineColor"),_e("outlineThickness"),_e("shadowColor"),_e("shadowOffset"),_e("enableMarkup"),_e("rangeStart"),_e("rangeEnd");class NN{constructor(){this.enabled=!0}}const zb=["enabled"];class Vb extends Ve{constructor(e){super(e),this.id="element",this.ComponentType=Rt,this.DataType=NN,this.schema=zb,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new re(e.graphicsDevice,{width:1,height:1,format:oe,name:"element-system"});const t=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,t.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this._defaultTextMaterials={},this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}destroy(){super.destroy(),this._defaultTexture.destroy()}initializeComponentData(e,t,s){e._beingInitialized=!0,t.anchor!==void 0&&(t.anchor instanceof X?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),t.pivot!==void 0&&(t.pivot instanceof G?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));const i=Math.abs(e.anchor.x-e.anchor.z)>.001,n=Math.abs(e.anchor.y-e.anchor.w)>.001;let r=!1,a;t.margin!==void 0&&(t.margin instanceof X?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),r=!0),t.left!==void 0&&(e._margin.x=t.left,r=!0),t.bottom!==void 0&&(e._margin.y=t.bottom,r=!0),t.right!==void 0&&(e._margin.z=t.right,r=!0),t.top!==void 0&&(e._margin.w=t.top,r=!0),r&&(e.margin=e._margin);let l=!1;t.width!==void 0&&!i?e.width=t.width:i&&(l=!0),t.height!==void 0&&!n?e.height=t.height:n&&(l=!0),l&&(e.anchor=e.anchor),t.enabled!==void 0&&(e.enabled=t.enabled),t.useInput!==void 0&&(e.useInput=t.useInput),t.fitMode!==void 0&&(e.fitMode=t.fitMode),e.batchGroupId=t.batchGroupId===void 0||t.batchGroupId===null?-1:t.batchGroupId,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),t.type!==void 0&&(e.type=t.type),e.type===$u?(t.rect!==void 0&&(e.rect=t.rect),t.color!==void 0&&(a=t.color,a instanceof H||(a=new H(t.color[0],t.color[1],t.color[2])),e.color=a),t.opacity!==void 0&&(e.opacity=t.opacity),t.textureAsset!==void 0&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),t.spriteAsset!==void 0&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),t.spriteFrame!==void 0&&(e.spriteFrame=t.spriteFrame),t.pixelsPerUnit!==void 0&&t.pixelsPerUnit!==null&&(e.pixelsPerUnit=t.pixelsPerUnit),t.materialAsset!==void 0&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),t.mask!==void 0&&(e.mask=t.mask)):e.type===N_&&(t.autoWidth!==void 0&&(e.autoWidth=t.autoWidth),t.autoHeight!==void 0&&(e.autoHeight=t.autoHeight),t.rtlReorder!==void 0&&(e.rtlReorder=t.rtlReorder),t.unicodeConverter!==void 0&&(e.unicodeConverter=t.unicodeConverter),t.text!==null&&t.text!==void 0?e.text=t.text:t.key!==null&&t.key!==void 0&&(e.key=t.key),t.color!==void 0&&(a=t.color,a instanceof H||(a=new H(a[0],a[1],a[2])),e.color=a),t.opacity!==void 0&&(e.opacity=t.opacity),t.spacing!==void 0&&(e.spacing=t.spacing),t.fontSize!==void 0&&(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),t.lineHeight!==void 0&&(e.lineHeight=t.lineHeight),t.maxLines!==void 0&&(e.maxLines=t.maxLines),t.wrapLines!==void 0&&(e.wrapLines=t.wrapLines),t.minFontSize!==void 0&&(e.minFontSize=t.minFontSize),t.maxFontSize!==void 0&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),t.fontAsset!==void 0&&(e.fontAsset=t.fontAsset),t.font!==void 0&&(e.font=t.font),t.alignment!==void 0&&(e.alignment=t.alignment),t.outlineColor!==void 0&&(e.outlineColor=t.outlineColor),t.outlineThickness!==void 0&&(e.outlineThickness=t.outlineThickness),t.shadowColor!==void 0&&(e.shadowColor=t.shadowColor),t.shadowOffset!==void 0&&(e.shadowOffset=t.shadowOffset),t.enableMarkup!==void 0&&(e.enableMarkup=t.enableMarkup));const h=e._parseUpToScreen();h.screen&&e._updateScreen(h.screen),super.initializeComponentData(e,t,s),e._beingInitialized=!1,e.type===$u&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh)}onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){const s=e.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,fitMode:s.fitMode,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return s.key!==void 0&&s.key!==null?i.key=s.key:i.text=s.text,this.addComponent(t,i)}getTextElementMaterial(e,t,s){const i=(e&&1)|(t&&2)|(s&&4);let n=this._defaultTextMaterials[i];if(n)return n;let r="TextMaterial";return n=new Ct,t?(n.msdfMap=this._defaultTexture,n.msdfTextAttribute=s,n.emissive.set(1,1,1)):(r="Bitmap"+r,n.emissive.set(.5,.5,.5),n.emissiveMap=this._defaultTexture,n.emissiveTint=!0,n.opacityMap=this._defaultTexture,n.opacityMapChannel="a"),e&&(r="ScreenSpace"+r,n.depthTest=!1),n.name="default"+r,n.useLighting=!1,n.useGammaTonemap=!1,n.useFog=!1,n.useSkybox=!1,n.diffuse.set(0,0,0),n.opacity=.5,n.blendType=jn,n.depthWrite=!1,n.emissiveVertexColor=!0,n.update(),this._defaultTextMaterials[i]=n,n}_createBaseImageMaterial(){const e=new Ct;return e.diffuse.set(0,0,0),e.emissive.set(.5,.5,.5),e.emissiveMap=this._defaultTexture,e.emissiveTint=!0,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.opacityTint=!0,e.opacity=0,e.useLighting=!1,e.useGammaTonemap=!1,e.useFog=!1,e.useSkybox=!1,e.blendType=jn,e.depthWrite=!1,e}getImageElementMaterial(e,t,s,i){return e?t?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=ot,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=st,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=ot,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=st,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):t?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=ot,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=st,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=ot,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=st,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(e){this._unicodeConverter=e}registerRtlReorder(e){this._rtlReorder=e}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}}he._buildAccessors(Rt.prototype,zb);const ba="free",Ta="limited",wa="locked",kN=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class Ju extends he{constructor(e,t){super(e,t),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX=wa,this._linearLimitsX=new G(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=wa,this._linearLimitsY=new G(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=wa,this._linearLimitsZ=new G(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=wa,this._angularLimitsX=new G(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=wa,this._angularLimitsY=new G(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=wa,this._angularLimitsZ=new G(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(e){this._destroyConstraint(),this._entityA=e,this._createConstraint()}get entityA(){return this._entityA}set entityB(e){this._destroyConstraint(),this._entityB=e,this._createConstraint()}get entityB(){return this._entityB}set breakForce(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e)}get breakForce(){return this._breakForce}set enableCollision(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(e,t){const s=e.getTranslation(),i=new Z;i.setFromMat4(e);const n=new Ammo.btVector3(s.x,s.y,s.z),r=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);t.setOrigin(n),t.setRotation(r),Ammo.destroy(n),Ammo.destroy(r)}_updateAngularLimits(){const e=this._constraint;if(e){let t,s,i,n,r,a;this._angularMotionX===Ta?(t=this._angularLimitsX.x*U.DEG_TO_RAD,n=this._angularLimitsX.y*U.DEG_TO_RAD):this._angularMotionX===ba?(t=1,n=0):t=n=0,this._angularMotionY===Ta?(s=this._angularLimitsY.x*U.DEG_TO_RAD,r=this._angularLimitsY.y*U.DEG_TO_RAD):this._angularMotionY===ba?(s=1,r=0):s=r=0,this._angularMotionZ===Ta?(i=this._angularLimitsZ.x*U.DEG_TO_RAD,a=this._angularLimitsZ.y*U.DEG_TO_RAD):this._angularMotionZ===ba?(i=1,a=0):i=a=0;const l=new Ammo.btVector3(t,s,i);e.setAngularLowerLimit(l),l.setValue(n,r,a),e.setAngularUpperLimit(l),Ammo.destroy(l)}}_updateLinearLimits(){const e=this._constraint;if(e){let t,s,i,n,r,a;this._linearMotionX===Ta?(t=this._linearLimitsX.x,n=this._linearLimitsX.y):this._linearMotionX===ba?(t=1,n=0):t=n=0,this._linearMotionY===Ta?(s=this._linearLimitsY.x,r=this._linearLimitsY.y):this._linearMotionY===ba?(s=1,r=0):s=r=0,this._linearMotionZ===Ta?(i=this._linearLimitsZ.x,a=this._linearLimitsZ.y):this._linearMotionZ===ba?(i=1,a=0):i=a=0;const l=new Ammo.btVector3(t,s,i);e.setLinearLowerLimit(l),l.setValue(n,r,a),e.setLinearUpperLimit(l),Ammo.destroy(l)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();const e=new W,t=this._entityA.rigidbody.body;t.activate();const s=this.entity.getWorldTransform(),n=this._entityA.getWorldTransform().clone().invert();e.mul2(n,s);const r=new Ammo.btTransform;if(this._convertTransform(e,r),this._entityB&&this._entityB.rigidbody){const c=this._entityB.rigidbody.body;c.activate();const u=this._entityB.getWorldTransform().clone().invert();e.mul2(u,s);const f=new Ammo.btTransform;this._convertTransform(e,f),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,c,r,f,!this._enableCollision),Ammo.destroy(f)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,r,!this._enableCollision);Ammo.destroy(r);const a=["X","Y","Z","X","Y","Z"];for(let c=0;c<6;c++){const d=c<3?"_linear":"_angular";this._constraint.enableSpring(c,this[d+"Spring"+a[c]]),this._constraint.setDamping(c,this[d+"Damping"+a[c]]),this._constraint.setEquilibriumPoint(c,this[d+"Equilibrium"+a[c]]),this._constraint.setStiffness(c,this[d+"Stiffness"+a[c]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null)}initFromData(e){for(const t of kN)e.hasOwnProperty(t)&&(e[t]instanceof G?this["_"+t].copy(e[t]):this["_"+t]=e[t]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(e,t,s){}_onBeforeRemove(){this.fire("remove")}}const UN={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(o=>{["Damping","Equilibrium","Spring","Stiffness"].forEach(e=>{["X","Y","Z"].forEach(t=>{const s=o+e+t,i="_"+s;let n=o==="linear"?0:3;t==="Y"&&(n+=1),t==="Z"&&(n+=2),Object.defineProperty(Ju.prototype,s,{get:function(){return this[i]},set:function(r){this[i]!==r&&(this[i]=r,this._constraint[UN[e]](n,r))}})})})});class zN{constructor(){this.enabled=!0}}const Gb=["enabled"];class Wb extends Ve{constructor(e){super(e),this.id="joint",this.app=e,this.ComponentType=Ju,this.DataType=zN,this.schema=Gb}initializeComponentData(e,t,s){e.initFromData(t)}}he._buildAccessors(Ju.prototype,Gb);class Y_ extends he{constructor(e,t){super(e,t),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}set minWidth(e){e!==this._minWidth&&(this._minWidth=e,this.fire("resize"))}get minWidth(){return this._minWidth}set minHeight(e){e!==this._minHeight&&(this._minHeight=e,this.fire("resize"))}get minHeight(){return this._minHeight}set maxWidth(e){e!==this._maxWidth&&(this._maxWidth=e,this.fire("resize"))}get maxWidth(){return this._maxWidth}set maxHeight(e){e!==this._maxHeight&&(this._maxHeight=e,this.fire("resize"))}get maxHeight(){return this._maxHeight}set fitWidthProportion(e){e!==this._fitWidthProportion&&(this._fitWidthProportion=e,this.fire("resize"))}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(e){e!==this._fitHeightProportion&&(this._fitHeightProportion=e,this.fire("resize"))}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(e){e!==this._excludeFromLayout&&(this._excludeFromLayout=e,this.fire("resize"))}get excludeFromLayout(){return this._excludeFromLayout}}class VN{constructor(){this.enabled=!0}}const Hb=["enabled"];class Xb extends Ve{constructor(e){super(e),this.id="layoutchild",this.ComponentType=Y_,this.DataType=VN,this.schema=Hb}initializeComponentData(e,t,s){t.enabled!==void 0&&(e.enabled=t.enabled),t.minWidth!==void 0&&(e.minWidth=t.minWidth),t.minHeight!==void 0&&(e.minHeight=t.minHeight),t.maxWidth!==void 0&&(e.maxWidth=t.maxWidth),t.maxHeight!==void 0&&(e.maxHeight=t.maxHeight),t.fitWidthProportion!==void 0&&(e.fitWidthProportion=t.fitWidthProportion),t.fitHeightProportion!==void 0&&(e.fitHeightProportion=t.fitHeightProportion),t.excludeFromLayout!==void 0&&(e.excludeFromLayout=t.excludeFromLayout),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.layoutchild;return this.addComponent(t,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}}he._buildAccessors(Y_.prototype,Hb);const ef=0,$b=1,K_=2,qb=3,tf={};tf[pe]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},tf[Ae]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};const Z_={};Z_[pe]=Ae,Z_[Ae]=pe;const GN={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},bs={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},Ts=new G;function jb(o){let e;const t=tf[o],s=tf[Z_[o]];function i(A,L){return-L[t.size]*A.pivot[t.axis]}function n(A,L){return-L[s.size]*A.pivot[s.axis]}function r(A,L){return L[t.size]*(1-A.pivot[t.axis])}function a(A,L){A=A.filter(l),e=L,Ts.x=e.containerSize.x-e.padding.x-e.padding.z,Ts.y=e.containerSize.y-e.padding.y-e.padding.w,h(A);const F=d(c(A)),N=f(F,u(F)),V=S(F,N);return v(F,N,V),b(F,N,V),w(F)}function l(A){const L=A.entity.layoutchild;return!L||!L.enabled||!L.excludeFromLayout}function h(A){for(let L=0;L<A.length;++L){const F=A[L],N=F.anchor;(N.x!==0||N.y!==0||N.z!==0||N.w!==0)&&(F.anchor=X.ZERO)}}function c(A){if(!e.wrap)return[A];const L=[[]],F=T(A);let N=0;const V=e[t.fitting]===K_;for(let k=0;k<A.length;++k){L[L.length-1].length>0&&(N+=e.spacing[t.axis]);const $=F[k][t.size];N+=$,!V&&N>Ts[t.axis]&&L[L.length-1].length!==0&&(N=$,L.push([])),L[L.length-1].push(A[k]),V&&N>Ts[t.axis]&&k!==A.length-1&&(N=0,L.push([]))}return L}function d(A){const L=e.orientation===pe&&e.reverseX||e.orientation===Ae&&e.reverseY,F=e.orientation===pe&&e.reverseY||e.orientation===Ae&&e.reverseX;if(L)for(let N=0;N<A.length;++N)L&&A[N].reverse();return F&&A.reverse(),A}function u(A){const L=[];for(let F=0;F<A.length;++F){const N=A[F],V=T(N),k=_(V,t),$=p(e[t.fitting],k,Ts[t.axis]);$===bs.APPLY_STRETCHING?m(V,k,t):$===bs.APPLY_SHRINKING&&g(V,k,t),L.push(V)}return L}function f(A,L){const F=[],N=[];for(let $=0;$<A.length;++$){const j=A[$];j.largestElement=null,j.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let K=0;K<j.length;++K){const ee=L[$][K];ee[s.size]>j.largestSize[s.size]&&(j.largestElement=j[K],j.largestSize=ee)}F.push(j.largestElement),N.push(j.largestSize)}const V=_(N,s),k=p(e[s.fitting],V,Ts[s.axis]);k===bs.APPLY_STRETCHING?m(N,V,s):k===bs.APPLY_SHRINKING&&g(N,V,s);for(let $=0;$<A.length;++$){const j=A[$];for(let K=0;K<j.length;++K){const ee=L[$][K],ie=ee[s.size],Ke=A.length===1?Ts[s.axis]:j.largestSize[s.size],It=p(e[s.fitting],ie,Ke);It===bs.APPLY_STRETCHING?ee[s.size]=Math.min(Ke,ee[s.maxSize]):It===bs.APPLY_SHRINKING&&(ee[s.size]=Math.max(Ke,ee[s.minSize]))}}return L}function p(A,L,F){switch(A){case ef:return bs.NONE;case $b:return L<F?bs.APPLY_STRETCHING:bs.NONE;case K_:return L>=F?bs.APPLY_SHRINKING:bs.NONE;case qb:return L<F?bs.APPLY_STRETCHING:bs.APPLY_SHRINKING;default:throw new Error(`Unrecognized fitting mode: ${A}`)}}function _(A,L){const F=M(A,L.size),N=(A.length-1)*e.spacing[L.axis];return F+N}function m(A,L,F){const N=B(A,F.maxSize),V=O(A,F.fittingProportion),k=R(V,N);let $=Ts[F.axis]-L;for(let j=0;j<A.length;++j){const K=N[j],ee=x(K,$,V,k),ie=A[K][F.size]+ee,Ke=A[K][F.maxSize],It=Math.min(ie,Ke);A[K][F.size]=It;const Ht=Math.max(ie-It,0),Xt=ee-Ht;$-=Xt}}function g(A,L,F){const N=B(A,F.minSize,!0),V=O(A,F.fittingProportion),k=I(V),$=R(k,N);let j=L-Ts[F.axis];for(let K=0;K<A.length;++K){const ee=N[K],ie=x(ee,j,k,$),Ke=A[ee][F.size]-ie,It=A[ee][F.minSize],Ht=Math.max(Ke,It);A[ee][F.size]=Ht;const Xt=Math.max(Ht-Ke,0),Ml=ie-Xt;j-=Ml}}function x(A,L,F,N){const V=F[A],k=N[A];return Math.abs(V)<1e-5&&Math.abs(k)<1e-5?L:L*V/k}function S(A,L){const F={};F[t.axis]=0,F[s.axis]=0,A[t.size]=Number.NEGATIVE_INFINITY;const N=[];for(let V=0;V<A.length;++V){const k=A[V];if(k.length===0){N.push([]);continue}const $=[],j=L[V];for(let K=0;K<k.length;++K){const ee=k[K],ie=j[K];F[s.axis]-=n(ee,ie),F[t.axis]-=i(ee,ie),$[K]={},$[K][t.axis]=F[t.axis],$[K][s.axis]=F[s.axis],F[s.axis]+=n(ee,ie),F[t.axis]+=r(ee,ie)+e.spacing[t.axis]}k[t.size]=F[t.axis]-e.spacing[t.axis],k[s.size]=k.largestSize[s.size],A[t.size]=Math.max(A[t.size],k[t.size]),F[t.axis]=0,F[s.axis]+=k[s.size]+e.spacing[s.axis],N.push($)}return A[s.size]=F[s.axis]-e.spacing[s.axis],N}function v(A,L,F){const N=e.alignment[t.axis],V=e.alignment[s.axis],k=e.padding[t.axis],$=e.padding[s.axis];for(let j=0;j<A.length;++j){const K=A[j],ee=L[j],ie=F[j],Ke=(Ts[t.axis]-K[t.size])*N+k,It=(Ts[s.axis]-A[s.size])*V+$;for(let Ht=0;Ht<K.length;++Ht){const Xt=(K[s.size]-ee[Ht][s.size])*e.alignment[s.axis];ie[Ht][t.axis]+=Ke,ie[Ht][s.axis]+=It+Xt}}}function b(A,L,F){for(let N=0;N<A.length;++N){const V=A[N],k=L[N],$=F[N];for(let j=0;j<V.length;++j){const K=V[j];K[t.calculatedSize]=k[j][t.size],K[s.calculatedSize]=k[j][s.size],e.orientation===pe?K.entity.setLocalPosition($[j][t.axis],$[j][s.axis],K.entity.getLocalPosition().z):K.entity.setLocalPosition($[j][s.axis],$[j][t.axis],K.entity.getLocalPosition().z)}}}function w(A){const L=A.width,F=A.height,N=(Ts.x-L)*e.alignment.x+e.padding.x,V=(Ts.y-F)*e.alignment.y+e.padding.y;return{bounds:new X(N,V,L,F)}}function T(A){const L=[];for(let F=0;F<A.length;++F){const N=A[F],V=Math.max(E(N,"minWidth"),0),k=Math.max(E(N,"minHeight"),0),$=Math.max(E(N,"maxWidth"),V),j=Math.max(E(N,"maxHeight"),k),K=C(E(N,"width"),V,$),ee=C(E(N,"height"),k,j),ie=E(N,"fitWidthProportion"),Ke=E(N,"fitHeightProportion");L.push({minWidth:V,minHeight:k,maxWidth:$,maxHeight:j,width:K,height:ee,fitWidthProportion:ie,fitHeightProportion:Ke})}return L}function E(A,L){const F=A.entity.layoutchild;return F&&F.enabled&&F[L]!==void 0&&F[L]!==null?F[L]:A[L]!==void 0?A[L]:GN[L]}function C(A,L,F){return Math.min(Math.max(A,L),F)}function M(A,L){return A.reduce(function(F,N){return F+N[L]},0)}function O(A,L){const F=M(A,L),N=[],V=A.length;if(F===0)for(let k=0;k<V;++k)N.push(1/V);else for(let k=0;k<V;++k)N.push(A[k][L]/F);return N}function I(A){if(A.length===1)return[1];const L=[],F=A.length;for(let N=0;N<F;++N)L.push((1-A[N])/(F-1));return L}function B(A,L,F){return A.forEach(P),A.slice().sort(function(N,V){return F?V[L]-N[L]:N[L]-V[L]}).map(D)}function P(A,L){A.index=L}function D(A){return A.index}function R(A,L){const F=[];F[L[A.length-1]]=A[L[A.length-1]];for(let N=A.length-2;N>=0;--N)F[L[N]]=F[L[N+1]]+A[L[N]];return F}return a}const Q_={};Q_[pe]=jb(pe),Q_[Ae]=jb(Ae);class Yb{calculateLayout(e,t){const s=Q_[t.orientation];if(s)return s(e,t);throw new Error("Unrecognized orientation value: "+t.orientation)}}function Kb(o){return o.element}function WN(o){return o.enabled&&o.element&&o.element.enabled}class J_ extends he{constructor(e,t){super(e,t),this._orientation=pe,this._reverseX=!1,this._reverseY=!0,this._alignment=new G(0,1),this._padding=new X,this._spacing=new G,this._widthFitting=ef,this._heightFitting=ef,this._wrap=!1,this._layoutCalculator=new Yb,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(s=>{this._listenForReflowEvents(s,"on")}),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}set orientation(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow())}get orientation(){return this._orientation}set reverseX(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow())}get reverseX(){return this._reverseX}set reverseY(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow())}get reverseY(){return this._reverseY}set alignment(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow())}get alignment(){return this._alignment}set padding(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow())}get padding(){return this._padding}set spacing(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow())}get spacing(){return this._spacing}set widthFitting(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow())}get widthFitting(){return this._widthFitting}set heightFitting(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow())}get heightFitting(){return this._heightFitting}set wrap(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow())}get wrap(){return this._wrap}_isSelfOrChild(e){return e===this.entity||this.entity.children.indexOf(e)!==-1}_listenForReflowEvents(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())}_onChildInsert(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()}_onChildRemove(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){const e=Kb(this.entity),t=this.entity.children.filter(WN).map(Kb);if(!e||t.length===0)return;const s=Math.max(e.calculatedWidth,0),i=Math.max(e.calculatedHeight,0),n={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new G(s,i)};this._isPerformingReflow=!0;const r=this._layoutCalculator.calculateLayout(t,n);this._isPerformingReflow=!1,this.fire("reflow",r)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(e=>{this._listenForReflowEvents(e,"off")}),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}class HN{constructor(){this.enabled=!0}}const Zb=["enabled"],XN=100;class Qb extends Ve{constructor(e){super(e),this.id="layoutgroup",this.ComponentType=J_,this.DataType=HN,this.schema=Zb,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t,s){t.enabled!==void 0&&(e.enabled=t.enabled),t.orientation!==void 0&&(e.orientation=t.orientation),t.reverseX!==void 0&&(e.reverseX=t.reverseX),t.reverseY!==void 0&&(e.reverseY=t.reverseY),t.alignment!==void 0&&(e.alignment=Array.isArray(t.alignment)?new G(t.alignment):t.alignment),t.padding!==void 0&&(e.padding=Array.isArray(t.padding)?new X(t.padding):t.padding),t.spacing!==void 0&&(e.spacing=Array.isArray(t.spacing)?new G(t.spacing):t.spacing),t.widthFitting!==void 0&&(e.widthFitting=t.widthFitting),t.heightFitting!==void 0&&(e.heightFitting=t.heightFitting),t.wrap!==void 0&&(e.wrap=t.wrap),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.layoutgroup;return this.addComponent(t,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(e){this._reflowQueue.indexOf(e)===-1&&this._reflowQueue.push(e)}_onPostUpdate(){this._processReflowQueue()}_processReflowQueue(){if(this._reflowQueue.length===0)return;let e=0;for(;this._reflowQueue.length>0;){const t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort(function(s,i){return s.entity.graphDepth-i.entity.graphDepth});for(let s=0;s<t.length;++s)t[s].reflow();if(++e>=XN){console.warn("Max reflow iterations limit reached, bailing.");break}}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}he._buildAccessors(J_.prototype,Zb);class Pc extends he{constructor(e,t){super(e,t),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._material=void 0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._layers=[is],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(e){this._model&&(this._model.meshInstances=e)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(e){if(this._customAabb=e,this._model){const t=this._model.meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(e){if(this._type!==e)if(this._area=null,this._type=e,e==="asset")this._asset!==null?this._bindModelAsset(this._asset):this.model=null;else{const t=ax(this.system.app.graphicsDevice,e);this._area=t.area;const s=t.mesh,i=new we,n=new _i;n.graph=i,n.meshInstances=[new Te(s,this._material,i)],this.model=n,this._asset=null}}get type(){return this._type}set asset(e){const t=this.system.app.assets;let s=e;if(e instanceof se&&(s=e.id),this._asset!==s){if(this._asset){t.off("add:"+this._asset,this._onModelAssetAdded,this);const i=t.get(this._asset);i&&this._unbindModelAsset(i)}if(this._asset=s,this._asset){const i=t.get(this._asset);i?this._bindModelAsset(i):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(e){if(this._model!==e&&!(e&&e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e,this._model)){this._model._immutable=!0;const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].castShadow=this._castShadows,t[s].receiveShadow=this._receiveShadows,t[s].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),this.type==="asset"?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){const t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows===e)return;const t=this._model;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let r=0;r<s.length;r++){const a=this.system.app.scene.layers.getLayerById(this.layers[r]);a&&a.removeShadowCasters(t.meshInstances)}const n=t.meshInstances;for(let r=0;r<n.length;r++)n[r].castShadow=e;if(!this._castShadows&&e)for(let r=0;r<s.length;r++){const a=i.layers.getLayerById(s[r]);a&&a.addShadowCasters(t.meshInstances)}}this._castShadows=e}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model)){const t=this._model.meshInstances;for(let s=0,i=t.length;s<i;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){const t=this.system.app.scene.layers;if(this.meshInstances)for(let s=0;s<this._layers.length;s++){const i=t.getLayerById(this._layers[s]);i&&i.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let s=0;s<e.length;s++)this._layers[s]=e[s];if(!(!this.enabled||!this.entity.enabled||!this.meshInstances))for(let s=0;s<this._layers.length;s++){const i=t.getLayerById(this._layers[s]);i&&i.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){if(this.entity.enabled&&this._batchGroupId>=0){var t;(t=this.system.app.batcher)==null||t.remove(it.MODEL,this.batchGroupId,this.entity)}if(this.entity.enabled&&e>=0){var s;(s=this.system.app.batcher)==null||s.insert(it.MODEL,e,this.entity)}e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set materialAsset(e){let t=e;e instanceof se&&(t=e.id);const s=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);const i=s.get(this._materialAsset);i&&this._unbindMaterialAsset(i)}if(this._materialAsset=t,this._materialAsset){const i=s.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._setMaterial(this.system.defaultMaterial),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}get material(){return this._material}set mapping(e){if(this._type!=="asset"||(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,!this._model))return;const t=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let n=null;for(let r=0,a=t.length;r<a;r++)if(e[r]!==void 0)e[r]?(n=this.system.app.assets.get(e[r]),this._loadAndSetMeshInstanceMaterial(n,t[r],r)):t[r].material=this.system.defaultMaterial;else if(i)if(i[r]&&(i[r].material||i[r].path)){if(i[r].material!==void 0)n=this.system.app.assets.get(i[r].material);else if(i[r].path!==void 0){const l=this._getMaterialAssetUrl(i[r].path);l&&(n=this.system.app.assets.getByUrl(l))}this._loadAndSetMeshInstanceMaterial(n,t[r],r)}else t[r].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this.meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.meshInstances)}_setMaterialEvent(e,t,s,i){const n=t+":"+s;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][n]={id:s,handler:i}}_unsetMaterialEvents(){const e=this.system.app.assets,t=this._materialEvents;if(t){for(let s=0,i=t.length;s<i;s++){if(!t[s])continue;const n=t[s];for(const r in n)e.off(r,n[r].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(e){let t=null;if(!isNaN(parseInt(e,10)))t=this.system.app.assets.get(e);else if(this.asset){const i=this._getMaterialAssetUrl(e);i&&(t=this.system.app.assets.getByUrl(i))}return t}_getMaterialAssetUrl(e){if(!this.asset)return null;const t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null}_loadAndSetMeshInstanceMaterial(e,t,s){const i=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial})):(this._setMaterialEvent(s,"load",e.id,function(n){t.material=n.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&i.load(e)))}onEnable(){const e=this.system.app,t=e.scene;t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));const s=this._type==="asset";let i;if(this._model?this.addModelToLayers():s&&this._asset&&(i=e.assets.get(this._asset),i&&i.resource!==this._model&&this._bindModelAsset(i)),this._materialAsset&&(i=e.assets.get(this._materialAsset),i&&i.resource!==this._material&&this._bindMaterialAsset(i)),s&&this._mapping)for(const r in this._mapping)this._mapping[r]&&(i=this._getAssetByIdOrPath(this._mapping[r]),i&&!i.resource&&e.assets.load(i));if(this._batchGroupId>=0){var n;(n=e.batcher)==null||n.insert(it.MODEL,this.batchGroupId,this.entity)}}onDisable(){const e=this.system.app,t=e.scene;if(t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0){var s;(s=e.batcher)==null||s.remove(it.MODEL,this.batchGroupId,this.entity)}this._model&&this.removeModelFromLayers()}hide(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!1}}show(){if(this._model){const e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!0}}_bindMaterialAsset(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMaterialAsset(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_onMaterialAssetLoad(e){this._setMaterial(e.resource)}_onMaterialAssetUnload(e){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(e){this._onMaterialAssetUnload(e)}_onMaterialAssetChange(e){}_bindModelAsset(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindModelAsset(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e)}_onModelAssetLoad(e){this.model=e.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(e){this.model=null}_onModelAssetChange(e,t,s,i){t==="data"&&(this.mapping=this._mapping)}_onModelAssetRemove(e){this.model=null}_setMaterial(e){if(this._material===e)return;this._material=e;const t=this._model;if(t&&this._type!=="asset"){const s=t.meshInstances;for(let i=0,n=s.length;i<n;i++)s[i].material=e}}}class $N{constructor(){this.enabled=!0}}const Jb=["enabled"];class eT extends Ve{constructor(e){super(e),this.id="model",this.ComponentType=Pc,this.DataType=$N,this.schema=Jb,this.defaultMaterial=Xo(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],(t.batchGroupId===null||t.batchGroupId===void 0)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new ye(new y(t.aabbCenter),new y(t.aabbHalfExtents))),super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:Gi({},e.model.mapping)};let i=e.model.materialAsset;!(i instanceof se)&&i!=null&&(i=this.app.assets.get(i));const n=e.model.material;(!n||n===this.defaultMaterial||!i||n===i.resource)&&(s.materialAsset=i);const r=this.addComponent(t,s);if(e.model.model&&e.model.type==="asset"&&!e.model.asset&&(r.model=e.model.model.clone(),r._clonedModel=!0),s.materialAsset||(r.material=n),e.model.model){const a=e.model.model.meshInstances,l=r.model.meshInstances;for(let h=0;h<a.length;h++)l[h].mask=a[h].mask,l[h].material=a[h].material,l[h].layer=a[h].layer,l[h].receiveShadow=a[h].receiveShadow}return e.model.customAabb&&(r.customAabb=e.model.customAabb.clone()),r}onRemove(e,t){t.onRemove()}}he._buildAccessors(Pc.prototype,Jb);const qN=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],jN=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],YN=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],sf=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];let ml;class eg extends he{constructor(e,t){super(e,t),this._requestedDepth=!1,this._drawOrder=0,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),qN.forEach(s=>{this.on(`set_${s}`,this.onSetSimpleProperty,this)}),jN.forEach(s=>{this.on(`set_${s}`,this.onSetComplexProperty,this)}),YN.forEach(s=>{this.on(`set_${s}`,this.onSetGraphProperty,this)})}set drawOrder(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e)}get drawOrder(){return this._drawOrder}addMeshInstanceToLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=t)}}removeMeshInstanceFromLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this.emitter.meshInstance])}}onSetLayers(e,t,s){if(this.emitter){for(let i=0;i<t.length;i++){const n=this.system.app.scene.layers.getLayerById(t[i]);n&&n.removeMeshInstances([this.emitter.meshInstance])}if(!(!this.enabled||!this.entity.enabled))for(let i=0;i<s.length;i++){const n=this.system.app.scene.layers.getLayerById(s[i]);n&&n.addMeshInstances([this.emitter.meshInstance])}}}onLayersChanged(e,t){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){!this.emitter||this.layers.indexOf(e.id)<0||e.addMeshInstances([this.emitter.meshInstance])}onLayerRemoved(e){!this.emitter||this.layers.indexOf(e.id)<0||e.removeMeshInstances([this.emitter.meshInstance])}_bindColorMapAsset(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindColorMapAsset(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(e){this.colorMap=e.resource}_onColorMapAssetUnload(e){this.colorMap=null}_onColorMapAssetRemove(e){this._onColorMapAssetUnload(e)}_onColorMapAssetChange(e){}onSetColorMapAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&this._unbindColorMapAsset(n)}if(s){s instanceof se&&(this.data.colorMapAsset=s.id,s=s.id);const n=i.get(s);n?this._bindColorMapAsset(n):i.once("add:"+s,r=>{this._bindColorMapAsset(r)})}else this.colorMap=null}_bindNormalMapAsset(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindNormalMapAsset(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(e){this.normalMap=e.resource}_onNormalMapAssetUnload(e){this.normalMap=null}_onNormalMapAssetRemove(e){this._onNormalMapAssetUnload(e)}_onNormalMapAssetChange(e){}onSetNormalMapAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&this._unbindNormalMapAsset(n)}if(s){s instanceof se&&(this.data.normalMapAsset=s.id,s=s.id);const n=i.get(s);n?this._bindNormalMapAsset(n):i.once("add:"+s,r=>{this._bindNormalMapAsset(r)})}else this.normalMap=null}_bindMeshAsset(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMeshAsset(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(e){this._onMeshChanged(e.resource)}_onMeshAssetUnload(e){this.mesh=null}_onMeshAssetRemove(e){this._onMeshAssetUnload(e)}_onMeshAssetChange(e){}onSetMeshAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&this._unbindMeshAsset(n)}if(s){s instanceof se&&(this.data.meshAsset=s.id,s=s.id);const n=i.get(s);n&&this._bindMeshAsset(n)}else this._onMeshChanged(null)}onSetMesh(e,t,s){!s||s instanceof se||typeof s=="number"?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(e){e&&!(e instanceof Ut)&&(e.meshInstances[0]?e=e.meshInstances[0].mesh:e=null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(e,t,s){const i=this.system.app.assets;if(t){const n=i.get(t);n&&this._unbindRenderAsset(n)}if(s){s instanceof se&&(this.data.renderAsset=s.id,s=s.id);const n=i.get(s);n&&this._bindRenderAsset(n)}else this._onRenderChanged(null)}_bindRenderAsset(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindRenderAsset(e){e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),e.resource&&e.resource.off("set:meshes",this._onRenderSetMeshes,this)}_onRenderAssetLoad(e){this._onRenderChanged(e.resource)}_onRenderAssetUnload(e){this._onRenderChanged(null)}_onRenderAssetRemove(e){this._onRenderAssetUnload(e)}_onRenderChanged(e){if(!e){this._onMeshChanged(null);return}e.off("set:meshes",this._onRenderSetMeshes,this),e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes)}_onRenderSetMeshes(e){this._onMeshChanged(e&&e[0])}onSetLoop(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetTime())}onSetBlendType(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||(ml||(ml=this.system.app.scene.layers.getLayerById(kt)),ml&&(ml.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){this._requestedDepth&&ml&&(ml.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(e,t,s){t!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[e]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial())}onSetComplexProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){const e=this.data;for(let t=0,s=sf.length;t<s;t++){let i=e[sf[t]];if(i){if(!(i instanceof se))if(parseInt(i,10)>=0)i=this.system.app.assets.get(i);else continue;i&&!i.resource&&this.system.app.assets.load(i)}}if(!this.system.app.graphicsDevice.disableParticleSystem){if(!this.emitter){let t=e.mesh;t instanceof Ut||(t=null),this.emitter=new o_(this.system.app.graphicsDevice,{numParticles:e.numParticles,emitterExtents:e.emitterExtents,emitterExtentsInner:e.emitterExtentsInner,emitterRadius:e.emitterRadius,emitterRadiusInner:e.emitterRadiusInner,emitterShape:e.emitterShape,initialVelocity:e.initialVelocity,wrap:e.wrap,localSpace:e.localSpace,screenSpace:e.screenSpace,wrapBounds:e.wrapBounds,lifetime:e.lifetime,rate:e.rate,rate2:e.rate2,orientation:e.orientation,particleNormal:e.particleNormal,animTilesX:e.animTilesX,animTilesY:e.animTilesY,animStartFrame:e.animStartFrame,animNumFrames:e.animNumFrames,animNumAnimations:e.animNumAnimations,animIndex:e.animIndex,randomizeAnimIndex:e.randomizeAnimIndex,animSpeed:e.animSpeed,animLoop:e.animLoop,startAngle:e.startAngle,startAngle2:e.startAngle2,scaleGraph:e.scaleGraph,scaleGraph2:e.scaleGraph2,colorGraph:e.colorGraph,colorGraph2:e.colorGraph2,alphaGraph:e.alphaGraph,alphaGraph2:e.alphaGraph2,localVelocityGraph:e.localVelocityGraph,localVelocityGraph2:e.localVelocityGraph2,velocityGraph:e.velocityGraph,velocityGraph2:e.velocityGraph2,rotationSpeedGraph:e.rotationSpeedGraph,rotationSpeedGraph2:e.rotationSpeedGraph2,radialSpeedGraph:e.radialSpeedGraph,radialSpeedGraph2:e.radialSpeedGraph2,colorMap:e.colorMap,normalMap:e.normalMap,loop:e.loop,preWarm:e.preWarm,sort:e.sort,stretch:e.stretch,alignToMotion:e.alignToMotion,lighting:e.lighting,halfLambert:e.halfLambert,intensity:e.intensity,depthSoftening:e.depthSoftening,scene:this.system.app.scene,mesh:t,depthWrite:e.depthWrite,noFog:e.noFog,node:this.entity,blendType:e.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,e.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&e.depthSoftening&&this._requestDepth()}}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let e=0;e<sf.length;e++){const t=sf[e];this.data[t]&&(this[t]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime}rebuild(){const e=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity),this.enabled=e}}class KN{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new y,this.emitterExtentsInner=new y,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=oi,this.initialVelocity=0,this.wrapBounds=new y,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=nm,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=Oh,this.particleNormal=new y(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=Bt,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[is]}}const tT=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class sT extends Ve{constructor(e){super(e),this.id="particlesystem",this.ComponentType=eg,this.DataType=KN,this.schema=tT,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){const i={};s=[];const n=this.propertyTypes;(t.mesh instanceof se||typeof t.mesh=="number")&&(t.meshAsset=t.mesh,delete t.mesh);for(const r in t){if(t.hasOwnProperty(r)&&(s.push(r),i[r]=t[r]),n[r]==="vec3")Array.isArray(i[r])&&(i[r]=new y(i[r][0],i[r][1],i[r][2]));else if(n[r]==="curve"){if(!(i[r]instanceof os)){const a=i[r].type;i[r]=new os(i[r].keys),i[r].type=a}}else if(n[r]==="curveset"&&!(i[r]instanceof Wi)){const a=i[r].type;i[r]=new Wi(i[r].keys),i[r].type=a}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0))}super.initializeComponentData(e,i,s)}cloneComponent(e,t){const s=e.particlesystem.data,i=this.schema,n={};for(let r=0,a=i.length;r<a;r++){const l=i[r];let h=s[l];h instanceof y||h instanceof os||h instanceof Wi?(h=h.clone(),n[l]=h):l==="layers"?n.layers=s.layers.slice(0):h!=null&&(n[l]=h)}return this.addComponent(t,n)}onUpdate(e){const t=this.store;let s;const i=this.app.stats.particles,n=this.app.scene.layers;for(let r=0;r<n.layerList.length;r++)n.layerList[r].requiresLightCube=!1;for(const r in t)if(t.hasOwnProperty(r)){const a=t[r],l=a.entity,h=a.data;if(h.enabled&&l.enabled){const c=l.particlesystem.emitter;if(!(c!=null&&c.meshInstance.visible))continue;if(c.lighting){const d=h.layers;for(let u=0;u<d.length;u++){const f=n.getLayerById(d[u]);f&&(f.requiresLightCube=!0)}}if(!h.paused){if(c.simTime+=e,c.simTime>c.fixedTimeStep&&(s=Math.floor(c.simTime/c.fixedTimeStep),c.simTime-=s*c.fixedTimeStep),s){s=Math.min(s,c.maxSubSteps);for(let d=0;d<s;d++)c.addTime(c.fixedTimeStep,!1);i._updatesPerFrame+=s,i._frameTime+=c._addTimeTime,c._addTimeTime=0}c.finishFrame()}}}}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}he._buildAccessors(eg.prototype,tT);class ZN extends pm{constructor(e,t){super(),this.skin=e,this.skinInstance=t}}class Ks{static createCachedSkinInstance(e,t,s){let i=Ks.getCachedSkinInstance(e,t);return i||(i=new ta(e),i.resolve(t,s),Ks.addCachedSkinInstance(e,t,i)),i}static getCachedSkinInstance(e,t){let s=null;const i=Ks._skinInstanceCache.get(t);if(i){const n=i.find(r=>r.skin===e);n&&(n.incRefCount(),s=n.skinInstance)}return s}static addCachedSkinInstance(e,t,s){let i=Ks._skinInstanceCache.get(t);i||(i=[],Ks._skinInstanceCache.set(t,i));let n=i.find(r=>r.skin===e);n||(n=new ZN(e,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(e){if(e){const t=e.rootBone;if(t){const s=Ks._skinInstanceCache.get(t);if(s){const i=s.findIndex(n=>n.skinInstance===e);if(i>=0){const n=s[i];n.decRefCount(),n.refCount===0&&(s.splice(i,1),s.length||Ks._skinInstanceCache.delete(t),e&&(e.destroy(),n.skinInstance=null))}}}}}}Ks._skinInstanceCache=new Map;class _l{constructor(e,t,s,i,n){this.propertyName=e,this.parent=t,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))}_unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)}}class nf extends he{constructor(e,t){super(e,t),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[is],this._renderStyle=Lo,this._meshInstances=[],this._customAabb=null,this._area=null,this._assetReference=void 0,this._materialReferences=[],this._material=void 0,this._rootBone=void 0,this._rootBone=new ar(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new _l("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,Te._prepareRenderStyleForArray(this._meshInstances,e))}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),e!=="asset")){let t=this._material;(!t||t===this.system.defaultMaterial)&&(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=ax(this.system.app.graphicsDevice,e);this._area=s.area,this.meshInstances=[new Te(s.mesh,t||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){const t=this._meshInstances;for(let s=0;s<t.length;s++)t[s].node||(t[s].node=this.entity),t[s].castShadow=this._castShadows,t[s].receiveShadow=this._receiveShadows,t[s].renderStyle=this._renderStyle,t[s].setLightmapped(this._lightmapped),t[s].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){const t=this._meshInstances;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let n=0;n<s.length;n++){const r=i.layers.getLayerById(this.layers[n]);r&&r.removeShadowCasters(t)}for(let n=0;n<t.length;n++)t[n].castShadow=e;if(!this._castShadows&&e)for(let n=0;n<s.length;n++){const r=i.layers.getLayerById(s[n]);r&&r.addShadowCasters(t)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){const t=this.system.app.scene.layers;let s;if(this._meshInstances)for(let i=0;i<this._layers.length;i++)s=t.getLayerById(this._layers[i]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let i=0;i<e.length;i++)this._layers[i]=e[i];if(!(!this.enabled||!this.entity.enabled||!this._meshInstances))for(let i=0;i<this._layers.length;i++)s=t.getLayerById(this._layers[i]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){if(this.entity.enabled&&this._batchGroupId>=0){var t;(t=this.system.app.batcher)==null||t.remove(it.RENDER,this.batchGroupId,this.entity)}if(this.entity.enabled&&e>=0){var s;(s=this.system.app.batcher)==null||s.insert(it.RENDER,e,this.entity)}e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&this._type!=="asset"))for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}get material(){return this._material}set materialAssets(e=[]){if(this._materialReferences.length>e.length){for(let t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(let t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new _l(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){const s=e[t]instanceof se?e[t].id:e[t];this._materialReferences[t].id!==s&&(this._materialReferences[t].id=s),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset)}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map(function(e){return e.id})}set asset(e){const t=e instanceof se?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof se?e.id:e;this._assetReference.id=t}_onSetRootBone(e){e&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(let t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}}addToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)}onEnable(){const e=this.system.app,t=e.scene;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),t.on("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.on("add",this.onLayerAdded,this),t.layers.on("remove",this.onLayerRemoved,this));const s=this._type==="asset";this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let n=0;n<this._materialReferences.length;n++)this._materialReferences[n].asset&&this.system.app.assets.load(this._materialReferences[n].asset);if(this._batchGroupId>=0){var i;(i=e.batcher)==null||i.insert(it.RENDER,this.batchGroupId,this.entity)}}onDisable(){const e=this.system.app,t=e.scene;if(t.off("set:layers",this.onLayersChanged,this),t.layers&&(t.layers.off("add",this.onLayerAdded,this),t.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0){var s;(s=e.batcher)==null||s.remove(it.RENDER,this.batchGroupId,this.entity)}this.removeFromLayers()}hide(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1}show(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const e=this._assetReference.asset.resource;e.off("set:meshes",this._onSetMeshes,this),e.on("set:meshes",this._onSetMeshes,this),e.meshes&&this._onSetMeshes(e.meshes)}}_onSetMeshes(e){this._cloneMeshes(e)}_clearSkinInstances(){for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e];Ks.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof we)for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e],s=t.mesh;s.skin&&!t.skinInstance&&(t.skinInstance=Ks.createCachedSkinInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(e){if(e&&e.length){const t=[];for(let s=0;s<e.length;s++){const i=e[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,r=new Te(i,n||this.system.defaultMaterial,this.entity);t.push(r),i.morph&&(r.morphInstance=new tr(i.morph))}this.meshInstances=t,this._cloneSkinInstances()}}_onRenderAssetUnload(){this._type==="asset"&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onMaterialAdded(e,t,s){s.resource?this._onMaterialLoad(e,t,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(e,t){e===0&&(this.material=t)}_onMaterialLoad(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=s.resource),this._updateMainMaterial(e,s.resource)}_onMaterialRemove(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}_onMaterialUnload(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone]&&(this.rootBone=t[e.rootBone]),this._clearSkinInstances()}}class QN{constructor(){this.enabled=!0,this.rootBone=null}}const tg=[{name:"rootBone",type:"entity"},"enabled"],Ea=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"];class iT extends Ve{constructor(e){super(e),this.id="render",this.ComponentType=nf,this.DataType=QN,this.schema=tg,this.defaultMaterial=Xo(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){(t.batchGroupId===null||t.batchGroupId===void 0)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<Ea.length;i++)t.hasOwnProperty(Ea[i])&&(e[Ea[i]]=t[Ea[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new ye(new y(t.aabbCenter),new y(t.aabbHalfExtents))),super.initializeComponentData(e,t,tg)}cloneComponent(e,t){const s={};for(let a=0;a<Ea.length;a++)s[Ea[a]]=e.render[Ea[a]];s.enabled=e.render.enabled,delete s.meshInstances;const i=this.addComponent(t,s),n=e.render.meshInstances,r=n.map(a=>a.mesh);i._onSetMeshes(r);for(let a=0;a<n.length;a++)i.meshInstances[a].material=n[a].material;return e.render.customAabb&&(i.customAabb=e.render.customAabb.clone()),i}onRemove(e,t){t.onRemove()}}he._buildAccessors(nf.prototype,tg);class sg{constructor(e,t){this._pool=[],this._count=0,this._constructor=e,this._resize(t)}_resize(e){if(e>this._pool.length)for(let t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(this._pool.length*2),this._pool[this._count++]}freeAll(){this._count=0}}let vi,Pe,vn,rf;const JN=new Z,e3=new Z,af=new y;class xi extends he{constructor(e,t){super(e,t),this._angularDamping=0,this._angularFactor=new y(1,1,1),this._angularVelocity=new y,this._body=null,this._friction=.5,this._group=z_,this._linearDamping=0,this._linearFactor=new y(1,1,1),this._linearVelocity=new y,this._mask=Yu,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=ga}static onLibraryLoaded(){typeof Ammo<"u"&&(vi=new Ammo.btTransform,Pe=new Ammo.btVector3,vn=new Ammo.btVector3,rf=new Ammo.btQuaternion)}set angularDamping(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e))}get angularDamping(){return this._angularDamping}set angularFactor(e){this._angularFactor.equals(e)||(this._angularFactor.copy(e),this._body&&this._type===Ss&&(Pe.setValue(e.x,e.y,e.z),this._body.setAngularFactor(Pe)))}get angularFactor(){return this._angularFactor}set angularVelocity(e){this._body&&this._type===Ss&&(this._body.activate(),Pe.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(Pe),this._angularVelocity.copy(e))}get angularVelocity(){if(this._body&&this._type===Ss){const e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity}set body(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate())}get body(){return this._body}set friction(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e))}get friction(){return this._friction}set group(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(e){this._linearFactor.equals(e)||(this._linearFactor.copy(e),this._body&&this._type===Ss&&(Pe.setValue(e.x,e.y,e.z),this._body.setLinearFactor(Pe)))}get linearFactor(){return this._linearFactor}set linearVelocity(e){this._body&&this._type===Ss&&(this._body.activate(),Pe.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(Pe),this._linearVelocity.copy(e))}get linearVelocity(){if(this._body&&this._type===Ss){const e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity}set mask(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===Ss)){const t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,Pe),this._body.setMassProps(e,Pe),this._body.updateInertiaTensor(),t&&this.enableSimulation()}}get mass(){return this._mass}set restitution(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e))}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e))}get rollingFriction(){return this._rollingFriction}set type(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case Ss:this._group=Tb,this._mask=G_;break;case lr:this._group=wb,this._mask=G_;break;case ga:default:this._group=z_,this._mask=Yu;break}this.createBody()}}get type(){return this._type}createBody(){const e=this.entity;let t;if(e.collision&&(t=e.collision.shape,e.trigger&&(e.trigger.destroy(),delete e.trigger)),t){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);const s=this._type===Ss?this._mass:0;this._getEntityTransform(vi);const i=this.system.createBody(s,t,vi);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===Ss){const n=this._linearFactor;Pe.setValue(n.x,n.y,n.z),i.setLinearFactor(Pe);const r=this._angularFactor;Pe.setValue(r.x,r.y,r.z),i.setAngularFactor(Pe)}else this._type===lr&&(i.setCollisionFlags(i.getCollisionFlags()|U_),i.setActivationState(qu));i.entity=e,this.body=i,this.enabled&&e.enabled&&this.enableSimulation()}}isActive(){return this._body?this._body.isActive():!1}activate(){this._body&&this._body.activate()}enableSimulation(){const e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){const t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case Ss:this.system._dynamic.push(this),t.forceActivationState(Ac),this.syncEntityToBody();break;case lr:this.system._kinematic.push(this),t.forceActivationState(qu);break;case ga:t.forceActivationState(Ac),this.syncEntityToBody();break}e.collision.type==="compound"&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=!0}}}disableSimulation(){const e=this._body;if(e&&this._simulationEnabled){const t=this.system;let s=t._compounds.indexOf(this.entity.collision);s>-1&&t._compounds.splice(s,1),s=t._dynamic.indexOf(this),s>-1&&t._dynamic.splice(s,1),s=t._kinematic.indexOf(this),s>-1&&t._kinematic.splice(s,1),t.removeBody(e),e.forceActivationState(ju),this._simulationEnabled=!1}}applyForce(e,t,s,i,n,r){const a=this._body;a&&(a.activate(),e instanceof y?Pe.setValue(e.x,e.y,e.z):Pe.setValue(e,t,s),t instanceof y?vn.setValue(t.x,t.y,t.z):i!==void 0?vn.setValue(i,n,r):vn.setValue(0,0,0),a.applyForce(Pe,vn))}applyTorque(e,t,s){const i=this._body;i&&(i.activate(),e instanceof y?Pe.setValue(e.x,e.y,e.z):Pe.setValue(e,t,s),i.applyTorque(Pe))}applyImpulse(e,t,s,i,n,r){const a=this._body;a&&(a.activate(),e instanceof y?Pe.setValue(e.x,e.y,e.z):Pe.setValue(e,t,s),t instanceof y?vn.setValue(t.x,t.y,t.z):i!==void 0?vn.setValue(i,n,r):vn.setValue(0,0,0),a.applyImpulse(Pe,vn))}applyTorqueImpulse(e,t,s){const i=this._body;i&&(i.activate(),e instanceof y?Pe.setValue(e.x,e.y,e.z):Pe.setValue(e,t,s),i.applyTorqueImpulse(Pe))}isStatic(){return this._type===ga}isStaticOrKinematic(){return this._type===ga||this._type===lr}isKinematic(){return this._type===lr}_getEntityTransform(e){const t=this.entity,s=t.collision;if(s){const i=s.getShapePosition(),n=s.getShapeRotation();Pe.setValue(i.x,i.y,i.z),rf.setValue(n.x,n.y,n.z,n.w)}else{const i=t.getPosition(),n=t.getRotation();Pe.setValue(i.x,i.y,i.z),rf.setValue(n.x,n.y,n.z,n.w)}e.setOrigin(Pe),e.setRotation(rf)}syncEntityToBody(){const e=this._body;if(e){if(this._getEntityTransform(vi),e.setWorldTransform(vi),this._type===lr){const t=e.getMotionState();t&&t.setWorldTransform(vi)}e.activate()}}_updateDynamic(){const e=this._body;if(e.isActive()){const t=e.getMotionState();if(t){const s=this.entity;t.getWorldTransform(vi);const i=vi.getOrigin(),n=vi.getRotation(),r=s.collision;if(r&&r._hasOffset){const a=r.data.linearOffset,l=r.data.angularOffset,h=e3.copy(l).invert(),c=JN.set(n.x(),n.y(),n.z(),n.w()).mul(h);c.transformVector(a,af),s.setPosition(i.x()-af.x,i.y()-af.y,i.z()-af.z),s.setRotation(c)}else s.setPosition(i.x(),i.y(),i.z()),s.setRotation(n.x(),n.y(),n.z(),n.w())}}}_updateKinematic(){const e=this._body.getMotionState();e&&(this._getEntityTransform(vi),e.setWorldTransform(vi))}teleport(e,t,s,i,n,r){e instanceof y?this.entity.setPosition(e):this.entity.setPosition(e,t,s),t instanceof Z?this.entity.setRotation(t):t instanceof y?this.entity.setEulerAngles(t):i!==void 0&&this.entity.setEulerAngles(i,n,r),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}}xi.EVENT_CONTACT="contact",xi.EVENT_COLLISIONSTART="collisionstart",xi.EVENT_COLLISIONEND="collisionend",xi.EVENT_TRIGGERENTER="triggerenter",xi.EVENT_TRIGGERLEAVE="triggerleave";class t3{constructor(){this.enabled=!0}}let Aa,Ca;class ig{constructor(e,t,s,i){this.entity=e,this.point=t,this.normal=s,this.hitFraction=i}}class nT{constructor(e,t,s){arguments.length===0?(this.a=null,this.b=null,this.impulse=0,this.localPointA=new y,this.localPointB=new y,this.pointA=new y,this.pointB=new y,this.normal=new y):(this.a=e,this.b=t,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal)}}class rT{constructor(e=new y,t=new y,s=new y,i=new y,n=new y,r=0){this.localPoint=e,this.localPointOther=t,this.point=s,this.pointOther=i,this.normal=n,this.impulse=r}}class aT{constructor(e,t){this.other=e,this.contacts=t}}const oT=["enabled"];class of extends Ve{constructor(e){super(e),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new y(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=e.stats.frame,this.ComponentType=xi,this.DataType=t3,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=oT,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this)}onLibraryLoaded(){if(typeof Ammo<"u"){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e)}Aa=new Ammo.btVector3,Ca=new Ammo.btVector3,xi.onLibraryLoaded(),this.contactPointPool=new sg(rT,1),this.contactResultPool=new sg(aT,1),this.singleContactResultPool=new sg(nT,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(e,t,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const n of i)if(t.hasOwnProperty(n)){const r=t[n];Array.isArray(r)?e[n]=new y(r[0],r[1],r[2]):e[n]=r}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&(t.enabled=!1),t.body&&(this.destroyBody(t.body),t.body=null)}addBody(e,t,s){t!==void 0&&s!==void 0?this.dynamicsWorld.addRigidBody(e,t,s):this.dynamicsWorld.addRigidBody(e)}removeBody(e){this.dynamicsWorld.removeRigidBody(e)}createBody(e,t,s){const i=new Ammo.btVector3(0,0,0);e!==0&&t.calculateLocalInertia(e,i);const n=new Ammo.btDefaultMotionState(s),r=new Ammo.btRigidBodyConstructionInfo(e,n,t,i),a=new Ammo.btRigidBody(r);return Ammo.destroy(r),Ammo.destroy(i),a}destroyBody(e){const t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e)}raycastFirst(e,t,s={}){if(s.filterTags||s.filterCallback)return s.sort=!0,this.raycastAll(e,t,s)[0]||null;let i=null;Aa.setValue(e.x,e.y,e.z),Ca.setValue(t.x,t.y,t.z);const n=new Ammo.ClosestRayResultCallback(Aa,Ca);if(typeof s.filterCollisionGroup=="number"&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),typeof s.filterCollisionMask=="number"&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(Aa,Ca,n),n.hasHit()){const r=n.get_m_collisionObject(),a=Ammo.castObject(r,Ammo.btRigidBody);if(a){const l=n.get_m_hitPointWorld(),h=n.get_m_hitNormalWorld();i=new ig(a.entity,new y(l.x(),l.y(),l.z()),new y(h.x(),h.y(),h.z()),n.get_m_closestHitFraction())}}return Ammo.destroy(n),i}raycastAll(e,t,s={}){const i=[];Aa.setValue(e.x,e.y,e.z),Ca.setValue(t.x,t.y,t.z);const n=new Ammo.AllHitsRayResultCallback(Aa,Ca);if(typeof s.filterCollisionGroup=="number"&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),typeof s.filterCollisionMask=="number"&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(Aa,Ca,n),n.hasHit()){const r=n.get_m_collisionObjects(),a=n.get_m_hitPointWorld(),l=n.get_m_hitNormalWorld(),h=n.get_m_hitFractions(),c=r.size();for(let d=0;d<c;d++){const u=Ammo.castObject(r.at(d),Ammo.btRigidBody);if(u&&u.entity){if(s.filterTags&&!u.entity.tags.has(...s.filterTags)||s.filterCallback&&!s.filterCallback(u.entity))continue;const f=a.at(d),p=l.at(d),_=new ig(u.entity,new y(f.x(),f.y(),f.z()),new y(p.x(),p.y(),p.z()),h.at(d));i.push(_)}}s.sort&&i.sort((d,u)=>d.hitFraction-u.hitFraction)}return Ammo.destroy(n),i}_storeCollision(e,t){let s=!1;const i=e.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:e},this.collisions[i].others.indexOf(t)<0&&(this.collisions[i].others.push(t),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:e},this.frameCollisions[i].others.push(t),s}_createContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),r=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPoint.set(t.x(),t.y(),t.z()),a.localPointOther.set(s.x(),s.y(),s.z()),a.point.set(i.x(),i.y(),i.z()),a.pointOther.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=e.getAppliedImpulse(),a}_createReverseContactPointFromAmmo(e){const t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),r=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPointOther.set(t.x(),t.y(),t.z()),a.localPoint.set(s.x(),s.y(),s.z()),a.pointOther.set(i.x(),i.y(),i.z()),a.point.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=e.getAppliedImpulse(),a}_createSingleContactResult(e,t,s){const i=this.singleContactResultPool.allocate();return i.a=e,i.b=t,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(e,t){const s=this.contactResultPool.allocate();return s.other=e,s.contacts=t,s}_cleanOldCollisions(){for(const e in this.collisions)if(this.collisions.hasOwnProperty(e)){const t=this.frameCollisions[e],s=this.collisions[e],i=s.entity,n=i.collision,r=i.rigidbody,a=s.others;let h=a.length;for(;h--;){const c=a[h];(!t||t.others.indexOf(c)<0)&&(a.splice(h,1),i.trigger?(n&&n.fire("triggerleave",c),c.rigidbody&&c.rigidbody.fire("triggerleave",i)):c.trigger||(r&&r.fire("collisionend",c),n&&n.fire("collisionend",c)))}a.length===0&&delete this.collisions[e]}}_hasContactEvent(e){const t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return!0;const s=e.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(e,t){const i=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),n=i.getNumManifolds();this.frameCollisions={};for(let r=0;r<n;r++){const a=i.getManifoldByIndexInternal(r),l=a.getBody0(),h=a.getBody1(),c=Ammo.castObject(l,Ammo.btRigidBody),d=Ammo.castObject(h,Ammo.btRigidBody),u=c.entity,f=d.entity;if(!u||!f)continue;const p=c.getCollisionFlags(),_=d.getCollisionFlags(),m=a.getNumContacts(),g=[],x=[];let S;if(m>0)if(p&ya||_&ya){const v=u.collision&&(u.collision.hasEvent("triggerenter")||u.collision.hasEvent("triggerleave")),b=f.collision&&(f.collision.hasEvent("triggerenter")||f.collision.hasEvent("triggerleave")),w=u.rigidbody&&(u.rigidbody.hasEvent("triggerenter")||u.rigidbody.hasEvent("triggerleave")),T=f.rigidbody&&(f.rigidbody.hasEvent("triggerenter")||f.rigidbody.hasEvent("triggerleave"));v&&(S=this._storeCollision(u,f),S&&!(_&ya)&&u.collision.fire("triggerenter",f)),b&&(S=this._storeCollision(f,u),S&&!(p&ya)&&f.collision.fire("triggerenter",u)),w&&(S||(S=this._storeCollision(f,u)),S&&u.rigidbody.fire("triggerenter",f)),T&&(S||(S=this._storeCollision(u,f)),S&&f.rigidbody.fire("triggerenter",u))}else{const v=this._hasContactEvent(u),b=this._hasContactEvent(f),w=this.hasEvent("contact");if(w||v||b){for(let T=0;T<m;T++){const E=a.getContactPoint(T),C=this._createContactPointFromAmmo(E);if(v||b){g.push(C);const M=this._createReverseContactPointFromAmmo(E);x.push(M)}if(w){const M=this._createSingleContactResult(u,f,C);this.fire("contact",M)}}if(v){const T=this._createContactResult(f,g);S=this._storeCollision(u,f),u.collision&&(u.collision.fire("contact",T),S&&u.collision.fire("collisionstart",T)),u.rigidbody&&(u.rigidbody.fire("contact",T),S&&u.rigidbody.fire("collisionstart",T))}if(b){const T=this._createContactResult(u,x);S=this._storeCollision(f,u),f.collision&&(f.collision.fire("contact",T),S&&f.collision.fire("collisionstart",T)),f.rigidbody&&(f.rigidbody.fire("contact",T),S&&f.rigidbody.fire("collisionstart",T))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(e){let t,s;this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;const i=this.dynamicsWorld.getGravity();(i.x()!==this._gravityFloat32[0]||i.y()!==this._gravityFloat32[1]||i.z()!==this._gravityFloat32[2])&&(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const n=this._triggers;for(t=0,s=n.length;t<s;t++)n[t].updateTransform();const r=this._compounds;for(t=0,s=r.length;t<s;t++)r[t]._updateCompound();const a=this._kinematic;for(t=0,s=a.length;t<s;t++)a[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);const l=this._dynamic;for(t=0,s=l.length;t<s;t++)l[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),typeof Ammo<"u"&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)}}of.EVENT_CONTACT="contact",he._buildAccessors(xi.prototype,oT);const Ma="none",lT="blend",hT=new W;class ng extends he{constructor(e,t){super(e,t),this._resolution=new G(640,320),this._referenceResolution=new G(640,320),this._scaleMode=Ma,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new W,this._elements=new Set,e.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(e,t){if(!(e instanceof Ce))return t;if(e.element){const n=e.element.drawOrder;if(e.element.drawOrder=t++,e.element._batchGroupId>=0&&n!==e.element.drawOrder){var s;(s=this.system.app.batcher)==null||s.markGroupDirty(e.element._batchGroupId)}}e.particlesystem&&(e.particlesystem.drawOrder=t++);const i=e.children;for(let n=0;n<i.length;n++)t=this._recurseDrawOrderSync(i[n],t);return t}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")}_calcProjectionMatrix(){const e=this._resolution.x/this.scale,t=this._resolution.y/this.scale,s=0,i=e,n=-t;this._screenMatrix.setOrtho(s,i,n,0,1,-1),this._screenSpace||(hT.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(hT,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(e,t){const s=Math.log2((e.x||1)/t.x),i=Math.log2((e.y||1)/t.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution)}_bindElement(e){this._elements.add(e)}_unbindElement(e){this._elements.delete(e)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(e=>e._onScreenRemove()),this._elements.clear(),this.off()}set resolution(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get resolution(){return this._resolution}set referenceResolution(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get referenceResolution(){return this._scaleMode===Ma?this._resolution:this._referenceResolution}set screenSpace(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(t=>t._onScreenSpaceChange())}get screenSpace(){return this._screenSpace}set scaleMode(e){e!==Ma&&e!==lT&&(e=Ma),!this._screenSpace&&e!==Ma&&(e=Ma),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get scaleBlend(){return this._scaleBlend}set priority(e){e>255&&(e=255),this._priority!==e&&(this._priority=e,this.syncDrawOrder())}get priority(){return this._priority}}class s3{constructor(){this.enabled=!0}}const cT=["enabled"];class dT extends Ve{constructor(e){super(e),this.id="screen",this.ComponentType=ng,this.DataType=s3,this.schema=cT,this.windowResolution=new G,this._drawOrderSyncQueue=new vy,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}initializeComponentData(e,t,s){t.priority!==void 0&&(e.priority=t.priority),t.screenSpace!==void 0&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,t.scaleMode!==void 0&&(e.scaleMode=t.scaleMode),t.scaleBlend!==void 0&&(e.scaleBlend=t.scaleBlend),t.resolution!==void 0&&(t.resolution instanceof G?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),t.referenceResolution!==void 0&&(t.referenceResolution instanceof G?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),e.syncDrawOrder(),super.initializeComponentData(e,t,s)}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)}_onUpdate(e){const t=this.store;for(const s in t)t[s].entity.screen.update&&t[s].entity.screen.update(e)}_onResize(e,t){this.windowResolution.x=e,this.windowResolution.y=t}cloneComponent(e,t){const s=e.screen;return this.addComponent(t,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(e,t){t.onRemove()}processDrawOrderSyncQueue(){const e=this._drawOrderSyncQueue.list();for(let t=0;t<e.length;t++){const s=e[t];s.callback.call(s.scope)}this._drawOrderSyncQueue.clear()}queueDrawOrderSync(e,t,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:s})}}he._buildAccessors(ng.prototype,cT);class rg extends he{constructor(e,t){super(e,t),this.on("set_scripts",this.onSetScripts,this)}send(e,t){const s=Array.prototype.slice.call(arguments,2),i=this.entity.script.instances;let n;if(i&&i[e]&&(n=i[e].instance[t],n))return n.apply(i[e].instance,s)}onEnable(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))}onDisable(){this.system._disableScriptComponent(this)}onSetScripts(e,t,s){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(t,s))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;const n=s.map(function(r){return r.url});if(this._loadFromCache(n))return;this._loadScripts(n)}}_updateScriptAttributes(e,t){let s=!0;if(e.length!==t.length)s=!1;else for(let i=0,n=t.length;i<n;i++)if(e[i].url!==t[i].url){s=!1;break}if(s)for(const i in this.instances)this.instances.hasOwnProperty(i)&&this.system._updateAccessors(this.entity,this.instances[i]);return s}_loadFromCache(e){const t=[],s=this.system.app._scriptPrefix||"",i=/^http(s)?:\/\//i;for(let n=0,r=e.length;n<r;n++){let a=e[n];i.test(a)||(a=ce.join(s,a));const l=this.system.app.loader.getFromCache(a,"script");if(!l)return!1;t.push(l)}for(let n=0,r=t.length;n<r;n++){const a=t[n];if(a!==!0&&a&&this.entity.script&&!this.entity.script.instances[a._pcScriptName]){const l=new a(this.entity);this.system._preRegisterInstance(this.entity,e[n],a._pcScriptName,l)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0}_loadScripts(e){let t=e.length;const s=this.system.app._scriptPrefix||"";e.forEach(i=>{let n=null,r=null;i.toLowerCase().startsWith("http://")||i.toLowerCase().startsWith("https://")?(r=i,n=i):(r=i,n=ce.join(s,i)),this.system.app.loader.load(n,"script",(a,l)=>{if(t--,a)console.error(a);else if(l&&this.entity.script&&!this.entity.script.instances[l._pcScriptName]){const h=new l(this.entity);this.system._preRegisterInstance(this.entity,r,l._pcScriptName,h)}t===0&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))})})}}class i3{constructor(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.initialized=!1,this.postInitialized=!1,this.areScriptsLoaded=!1}}const uT=["enabled","scripts","instances","runInTools"],ag="initialize",og="postInitialize",lg="update",hg="postUpdate",cg="fixedUpdate",dg="toolsUpdate",n3="onEnable",r3="onDisable";class fT extends Ve{constructor(e){super(e),this.id="script",this.ComponentType=rg,this.DataType=i3,this.schema=uT,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on(ag,this.onInitialize,this),this.app.systems.on(og,this.onPostInitialize,this),this.app.systems.on(lg,this.onUpdate,this),this.app.systems.on(cg,this.onFixedUpdate,this),this.app.systems.on(hg,this.onPostUpdate,this),this.app.systems.on(dg,this.onToolsUpdate,this)}initializeComponentData(e,t,s){s=["runInTools","enabled","scripts"],t.scripts&&t.scripts.length&&t.scripts.forEach(function(i){if(i.attributes&&Array.isArray(i.attributes)){const n={};for(let r=0;r<i.attributes.length;r++)n[i.attributes[r].name]=i.attributes[r];i.attributes=n}}),super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=this.store[e.getGuid()],i={runInTools:s.data.runInTools,scripts:[],enabled:s.data.enabled},n=s.data.scripts;for(let r=0,a=n.length;r<a;r++){const l=n[r].attributes;l&&delete n[r].attributes,i.scripts.push(Gi({},n[r])),l&&(i.scripts[r].attributes=this._cloneAttributes(l),n[r].attributes=l)}return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&this._disableScriptComponent(t),this._destroyScriptComponent(t)}onInitialize(e){if(this._registerInstances(e),e.enabled){e.script&&e.script.enabled&&this._initializeScriptComponent(e.script);const t=e._children;for(let s=0,i=t.length;s<i;s++)t[s]instanceof Ce&&this.onInitialize(t[s])}}onPostInitialize(e){if(e.enabled){e.script&&e.script.enabled&&this._postInitializeScriptComponent(e.script);const t=e._children;for(let s=0,i=t.length;s<i;s++)t[s]instanceof Ce&&this.onPostInitialize(t[s])}}_callInstancesMethod(e,t){const s=e.data.instances;for(const i in s)if(s.hasOwnProperty(i)){const n=s[i].instance;n[t]&&n[t]()}}_initializeScriptComponent(e){this._callInstancesMethod(e,ag),e.data.initialized=!0,e.enabled&&e.entity.enabled&&this._enableScriptComponent(e)}_enableScriptComponent(e){this._callInstancesMethod(e,n3)}_disableScriptComponent(e){this._callInstancesMethod(e,r3)}_destroyScriptComponent(e){const t=e.data.instances;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s].instance;if(i.destroy&&i.destroy(),i.update){const n=this.instancesWithUpdate.indexOf(i);n>=0&&this.instancesWithUpdate.splice(n,1)}if(i.fixedUpdate){const n=this.instancesWithFixedUpdate.indexOf(i);n>=0&&this.instancesWithFixedUpdate.splice(n,1)}if(i.postUpdate){const n=this.instancesWithPostUpdate.indexOf(i);n>=0&&this.instancesWithPostUpdate.splice(n,1)}if(i.toolsUpdate){const n=this.instancesWithToolsUpdate.indexOf(i);n>=0&&this.instancesWithToolsUpdate.splice(n,1)}e.instances[s].instance===e[s]&&delete e[s],delete e.instances[s]}}_postInitializeScriptComponent(e){this._callInstancesMethod(e,og),e.data.postInitialized=!0}_updateInstances(e,t,s){for(let i=0,n=t.length;i<n;i++){const r=t[i];r&&r.entity&&r.entity.enabled&&r.entity.script.enabled&&r[e](s)}}onUpdate(e){this._updateInstances(lg,this.instancesWithUpdate,e)}onFixedUpdate(e){this._updateInstances(cg,this.instancesWithFixedUpdate,e)}onPostUpdate(e){this._updateInstances(hg,this.instancesWithPostUpdate,e)}onToolsUpdate(e){this._updateInstances(dg,this.instancesWithToolsUpdate,e)}broadcast(e,t){const s=Array.prototype.slice.call(arguments,2),i=this.store;for(const n in i)if(i.hasOwnProperty(n)){const r=i[n].data;if(r.instances[e]){const a=r.instances[e].instance[t];a&&a.apply(r.instances[e].instance,s)}}}_preRegisterInstance(e,t,s,i){if(e.script){if(e.script.data._instances=e.script.data._instances||{},e.script.data._instances[s])throw Error(`Script name collision '${s}'. Scripts from '${t}' and '${e.script.data._instances[s].url}' {${e.getGuid()}}`);e.script.data._instances[s]={url:t,name:s,instance:i}}}_registerInstances(e){if(e.script&&e.script.data._instances){e.script.instances=e.script.data._instances;for(const s in e.script.instances){const i=e.script.instances[s],n=i.instance;if(zc.attach(n),n.update&&this.instancesWithUpdate.push(n),n.fixedUpdate&&this.instancesWithFixedUpdate.push(n),n.postUpdate&&this.instancesWithPostUpdate.push(n),n.toolsUpdate&&this.instancesWithToolsUpdate.push(n),e.script.scripts&&this._createAccessors(e,i),e.script[s])throw Error(`Script with name '${s}' is already attached to Script Component`);e.script[s]=n}delete e.script.data._instances}const t=e._children;for(let s=0,i=t.length;s<i;s++)t[s]instanceof Ce&&this._registerInstances(t[s])}_cloneAttributes(e){const t={};for(const s in e)if(e.hasOwnProperty(s))if(e[s].type!=="entity")t[s]=Gi({},e[s]);else{const i=e[s].value;delete e[s].value,t[s]=Gi({},e[s]),t[s].value=i,e[s].value=i}return t}_createAccessors(e,t){const s=e.script.scripts.length,i=t.url;for(let n=0;n<s;n++){const r=e.script.scripts[n];if(r.url===i){const a=r.attributes;if(r.name&&a){for(const l in a)a.hasOwnProperty(l)&&this._createAccessor(a[l],t);e.script.data.attributes[r.name]=this._cloneAttributes(a)}break}}}_createAccessor(e,t){const s=this;e={name:e.name,value:e.value,type:e.type},this._convertAttributeValue(e),Object.defineProperty(t.instance,e.name,{get:function(){return e.value},set:function(i){const n=e.value;e.value=i,s._convertAttributeValue(e),t.instance.fire("set",e.name,n,e.value)},configurable:!0})}_updateAccessors(e,t){const s=e.script.scripts.length,i=t.url;for(let n=0;n<s;n++){const r=e.script,a=r.scripts[n];if(a.url===i){const l=a.name,h=a.attributes;if(l){if(h)for(const d in h)h.hasOwnProperty(d)&&this._createAccessor(h[d],t);const c=r.data.attributes[l];if(c)for(const d in c){const u=c[d];d in h?h[d].value!==u.value&&t.instance.onAttributeChanged&&t.instance.onAttributeChanged(u.name,u.value,h[d].value):delete t.instance[u.name]}h?r.data.attributes[l]=this._cloneAttributes(h):delete r.data.attributes[l]}break}}}_convertAttributeValue(e){if(e.type==="rgb"||e.type==="rgba")Array.isArray(e.value)&&(e.value=e.value.length===3?new H(e.value[0],e.value[1],e.value[2]):new H(e.value[0],e.value[1],e.value[2],e.value[3]));else if(e.type==="vec2")Array.isArray(e.value)&&(e.value=new G(e.value[0],e.value[1]));else if(e.type==="vec3"||e.type==="vector")Array.isArray(e.value)&&(e.value=new y(e.value[0],e.value[1],e.value[2]));else if(e.type==="vec4")Array.isArray(e.value)&&(e.value=new X(e.value[0],e.value[1],e.value[2],e.value[3]));else if(e.type==="entity")e.value!==null&&typeof e.value=="string"&&(e.value=this.app.root.findByGuid(e.value));else if(e.type==="curve"||e.type==="colorcurve"){const t=e.value.keys[0]instanceof Array?Wi:os;e.value=new t(e.value.keys),e.value.type=e.value.type}}destroy(){super.destroy(),this.app.systems.off(ag,this.onInitialize,this),this.app.systems.off(og,this.onPostInitialize,this),this.app.systems.off(lg,this.onUpdate,this),this.app.systems.off(cg,this.onFixedUpdate,this),this.app.systems.off(hg,this.onPostUpdate,this),this.app.systems.off(dg,this.onToolsUpdate,this)}}he._buildAccessors(rg.prototype,uT);const hr=new G,pT=new y,Pa=new Mn,mT=new cp,_T=new y,Rc=new y,a3=new Z,o3={x:"y",y:"x"};class gl extends Q{constructor(e,t){if(super(),!e||!(e instanceof Rt))throw new Error("Element was null or not an ElementComponent");if(t&&t!=="x"&&t!=="y")throw new Error("Unrecognized axis: "+t);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=!0,this._dragScale=new y,this._dragStartMousePosition=new y,this._dragStartHandlePosition=new y,this._deltaMousePosition=new y,this._deltaHandlePosition=new y,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this),this._element[e]("selectstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(e){const t=e==="on";this._hasDragListeners&&t||(this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._onMouseUpOrTouchEnd,this)),ge.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._onMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._onMouseUpOrTouchEnd,this)),this._element[e]("selectmove",this._onMove,this),this._element[e]("selectend",this._onMouseUpOrTouchEnd,this),this._hasDragListeners=t)}_onMouseDownOrTouchStart(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();const t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(e){return e.inputSource?Pa.set(e.inputSource.getOrigin(),e.inputSource.getDirection()):(this._determineInputPosition(e),this._chooseRayOriginAndDirection()),_T.copy(this._element.entity.forward).mulScalar(-1),mT.setFromPointNormal(this._element.entity.getPosition(),_T),mT.intersectsRay(Pa,Rc)?(a3.copy(this._element.entity.getRotation()).invert().transformVector(Rc,Rc),Rc.mul(this._dragScale),Rc):null}_determineInputPosition(e){const t=this._app.graphicsDevice.maxPixelRatio;typeof e.x<"u"&&typeof e.y<"u"?(hr.x=e.x*t,hr.y=e.y*t):e.changedTouches?(hr.x=e.changedTouches[0].x*t,hr.y=e.changedTouches[0].y*t):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(Pa.origin.set(hr.x,-hr.y,0),Pa.direction.copy(y.FORWARD)):(pT.copy(this._dragCamera.screenToWorld(hr.x,hr.y,1)),Pa.origin.copy(this._dragCamera.entity.getPosition()),Pa.direction.copy(pT).sub(Pa.origin).normalize())}_calculateDragScale(){let e=this._element.entity.parent;const t=this._element.screen&&this._element.screen.screen,s=t&&t.screenSpace,i=s?t.scale:1,n=this._dragScale;for(n.set(i,i,i);e&&(n.mul(e.getLocalScale()),e=e.parent,!(s&&e.screen)););n.x=1/n.x,n.y=1/n.y,n.z=0}_onMove(e){const{_element:t,_deltaMousePosition:s,_deltaHandlePosition:i,_axis:n}=this;if(t&&this._isDragging&&this.enabled&&t.enabled&&t.entity.enabled){const r=this._screenToLocal(e);if(r){if(s.sub2(r,this._dragStartMousePosition),i.add2(this._dragStartHandlePosition,s),n){const a=t.entity.getLocalPosition(),l=o3[n];i[l]=a[l]}t.entity.setLocalPosition(i),this.fire("drag:move",i)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}set enabled(e){this._enabled=e}get enabled(){return this._enabled}get isDragging(){return this._isDragging}}gl.EVENT_DRAGSTART="drag:start",gl.EVENT_DRAGEND="drag:end",gl.EVENT_DRAGMOVE="drag:move";const gT=0,ug=1,yT=2,vT=0,xT=1,Ic=new G;class lf extends he{constructor(e,t){super(e,t),this._viewportReference=new ar(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new ar(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[pe]=new ar(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[Ae]=new ar(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[pe]=null,this._prevContentSizes[Ae]=null,this._scroll=new G,this._velocity=new y,this._dragStartPosition=new y,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",e),this._toggleElementListeners("on")}_toggleLifecycleListeners(e,t){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),t.app.systems.element[e]("add",this._onElementComponentAdd,this),t.app.systems.element[e]("beforeremove",this._onElementComponentRemove,this)}_toggleElementListeners(e){if(this.entity.element){if(e==="on"&&this._hasElementListeners)return;this.entity.element[e]("resize",this._onSetContentOrViewportSize,this),this.entity.element[e](Pd,this._onMouseWheel,this),this._hasElementListeners=e==="on"}}_onElementComponentAdd(e){this.entity===e&&this._toggleElementListeners("on")}_onElementComponentRemove(e){this.entity===e&&this._toggleElementListeners("off")}_onViewportElementGain(){this._syncAll()}_onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new gl(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[pe]=null,this._prevContentSizes[Ae]=null,this._syncAll()}_onContentElementLose(){this._destroyDragHelper()}_onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(e){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){const t=e.x-this._dragStartPosition.x,s=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_onSetContentOrViewportSize(){this._syncAll()}_onSetHorizontalScrollbarValue(e){!this._scrollbarUpdateFlags[pe]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)}_onSetVerticalScrollbarValue(e){!this._scrollbarUpdateFlags[Ae]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(pe)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(Ae)}_onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(pe),this._syncScrollbarPosition(pe)}_onVerticalScrollbarGain(){this._syncScrollbarEnabledState(Ae),this._syncScrollbarPosition(Ae)}_onSetScroll(e,t,s){s!==!1&&this._velocity.set(0,0,0);const i=this._updateAxis(e,"x",pe),n=this._updateAxis(t,"y",Ae);(i||n)&&this.fire("set:scroll",this._scroll)}_updateAxis(e,t,s){const i=e!==null&&Math.abs(e-this._scroll[t])>1e-5;return(i||this._isDragging()||e===0)&&(this._scroll[t]=this._determineNewScrollValue(e,t,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(e,t,s){if(!this._getScrollingEnabled(s))return this._scroll[t];switch(this.scrollMode){case gT:return U.clamp(e,0,this._getMaxScrollValue(s));case ug:return this._setVelocityFromOvershoot(e,t,s),e;case yT:return e;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),e}}_syncAll(){this._syncContentPosition(pe),this._syncContentPosition(Ae),this._syncScrollbarPosition(pe),this._syncScrollbarPosition(Ae),this._syncScrollbarEnabledState(pe),this._syncScrollbarEnabledState(Ae)}_syncContentPosition(e){const t=this._getAxis(e),s=this._getSign(e),i=this._contentReference.entity;if(i){const n=this._prevContentSizes[e],r=this._getContentSize(e);if(n!==null&&Math.abs(n-r)>1e-4){const h=this._getMaxOffset(e,n),c=this._getMaxOffset(e,r);c===0?this._scroll[t]=1:this._scroll[t]=U.clamp(this._scroll[t]*h/c,0,1)}const a=this._scroll[t]*this._getMaxOffset(e),l=i.getLocalPosition();l[t]=a*s,i.setLocalPosition(l),this._prevContentSizes[e]=r}}_syncScrollbarPosition(e){const t=this._getAxis(e),s=this._scrollbarReferences[e].entity;s&&s.scrollbar&&(this._scrollbarUpdateFlags[e]=!0,s.scrollbar.value=this._scroll[t],s.scrollbar.handleSize=this._getScrollbarHandleSize(t,e),this._scrollbarUpdateFlags[e]=!1)}_syncScrollbarEnabledState(e){const t=this._scrollbarReferences[e].entity;if(t){const s=this._getScrollingEnabled(e),i=this._getScrollbarVisibility(e);switch(i){case vT:t.enabled=s;return;case xT:t.enabled=s&&this._contentIsLargerThanViewport(e);return;default:console.warn("Unhandled scrollbar visibility:"+i),t.enabled=s}}}_contentIsLargerThanViewport(e){return this._getContentSize(e)>this._getViewportSize(e)}_contentPositionToScrollValue(e){const t=this._getMaxOffset(pe),s=this._getMaxOffset(Ae);return t===0?Ic.x=0:Ic.x=e.x/t,s===0?Ic.y=0:Ic.y=e.y/-s,Ic}_getMaxOffset(e,t){t=t===void 0?this._getContentSize(e):t;const s=this._getViewportSize(e);return t<s?-this._getViewportSize(e):s-t}_getMaxScrollValue(e){return this._contentIsLargerThanViewport(e)?1:0}_getScrollbarHandleSize(e,t){const s=this._getViewportSize(t),i=this._getContentSize(t);if(Math.abs(i)<.001)return 1;const n=Math.min(s/i,1),r=this._toOvershoot(this._scroll[e],t);return r===0?n:n/(1+Math.abs(r))}_getViewportSize(e){return this._getSize(e,this._viewportReference)}_getContentSize(e){return this._getSize(e,this._contentReference)}_getSize(e,t){return t.entity&&t.entity.element?t.entity.element[this._getCalculatedDimension(e)]:0}_getScrollingEnabled(e){if(e===pe)return this.horizontal;if(e===Ae)return this.vertical}_getScrollbarVisibility(e){if(e===pe)return this.horizontalScrollbarVisibility;if(e===Ae)return this.verticalScrollbarVisibility}_getSign(e){return e===pe?1:-1}_getAxis(e){return e===pe?"x":"y"}_getCalculatedDimension(e){return e===pe?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(pe),this._syncScrollbarEnabledState(Ae))}_updateVelocity(){if(!this._isDragging()){if(this.scrollMode===ug&&(this._hasOvershoot("x",pe)&&this._setVelocityFromOvershoot(this.scroll.x,"x",pe),this._hasOvershoot("y",Ae)&&this._setVelocityFromOvershoot(this.scroll.y,"y",Ae)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const e=this._contentReference.entity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(e),this._setScrollFromContentPosition(e)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(e,t){return Math.abs(this._toOvershoot(this.scroll[e],t))>.001}_toOvershoot(e,t){const s=this._getMaxScrollValue(t);return e<0?e:e>s?e-s:0}_setVelocityFromOvershoot(e,t,s){const n=this._toOvershoot(e,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(n)>0&&(this._velocity[t]=-n/(this.bounceAmount*50+1))}_setVelocityFromContentPositionDelta(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())}_setScrollFromContentPosition(e){let t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,!1)}_applyScrollValueTension(e){let s=this._getMaxScrollValue(pe),i=this._toOvershoot(e.x,pe);return i>0?e.x=s+1*Math.log10(1+i):i<0&&(e.x=-1*Math.log10(1-i)),s=this._getMaxScrollValue(Ae),i=this._toOvershoot(e.y,Ae),i>0?e.y=s+1*Math.log10(1+i):i<0&&(e.y=-1*Math.log10(1-i)),e}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(e){this._scrollbarReferences[pe].hasComponent("scrollbar")&&(this._scrollbarReferences[pe].entity.scrollbar.enabled=e),this._scrollbarReferences[Ae].hasComponent("scrollbar")&&(this._scrollbarReferences[Ae].entity.scrollbar.enabled=e)}_setContentDraggingEnabled(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)}_onMouseWheel(e){if(this.useMouseWheel){const t=e.event,s=t.deltaX/this._contentReference.entity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=t.deltaY/this._contentReference.entity.element.calculatedHeight*this.mouseWheelSensitivity.y,n=U.clamp(this._scroll.x+s,0,this._getMaxScrollValue(pe)),r=U.clamp(this._scroll.y+i,0,this._getMaxScrollValue(Ae));this.scroll=new G(n,r)}}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const e=s=>{s.element&&s.element.useInput&&(this._disabledContentInputEntities.push(s),s.element.useInput=!1);const i=s.children;for(let n=0,r=i.length;n<r;n++)e(i[n])},t=this._contentReference.entity;if(t){const s=t.children;for(let i=0,n=s.length;i<n;i++)e(s[i])}this._disabledContentInput=!0}onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[pe].onParentComponentEnable(),this._scrollbarReferences[Ae].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}set scroll(e){this._onSetScroll(e.x,e.y)}get scroll(){return this._scroll}}lf.EVENT_SETSCROLL="set:scroll";class l3{constructor(){this.enabled=!0}}const fg=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],h3=10;class ST extends Ve{constructor(e){super(e),this.id="scrollview",this.ComponentType=lf,this.DataType=l3,this.schema=fg,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){t.dragThreshold===void 0&&(t.dragThreshold=h3),t.useMouseWheel===void 0&&(t.useMouseWheel=!0),t.mouseWheelSensitivity===void 0&&(t.mouseWheelSensitivity=new G(1,1)),super.initializeComponentData(e,t,fg)}onUpdate(e){const t=this.store;for(const s in t){const i=t[s].entity,n=i.scrollview;n.enabled&&i.enabled&&n.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}he._buildAccessors(lf.prototype,fg);class hf extends he{constructor(e,t){super(e,t),this._handleReference=new ar(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)}_onHandleElementGain(){this._destroyDragHelper(),this._handleDragHelper=new gl(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._destroyDragHelper()}_onHandleDrag(e){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))}_onSetValue(e,t,s){Math.abs(s-t)>1e-5&&(this.data.value=U.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(e,t,s){Math.abs(s-t)>1e-5&&(this.data.handleSize=U.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(e,t,s){s!==t&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){const e=this._handleReference.entity,t=e&&e.element;if(e){const s=e.getLocalPosition();s[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(s)}t&&(t[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(e){return e*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(e){return e*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?this.orientation===pe?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return this.orientation===pe?1:-1}_getAxis(){return this.orientation===pe?"x":"y"}_getDimension(){return this.orientation===pe?"width":"height"}_getOppositeDimension(){return this.orientation===pe?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)}onEnable(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}}hf.EVENT_SETVALUE="set:value";class c3{constructor(){this.enabled=!0}}const pg=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];class bT extends Ve{constructor(e){super(e),this.id="scrollbar",this.ComponentType=hf,this.DataType=c3,this.schema=pg,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,pg)}_onRemoveComponent(e,t){t.onRemove()}}he._buildAccessors(hf.prototype,pg);const d3={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new y,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class xn extends Q{constructor(e,t="Untitled",s={}){super(),this.name=void 0,this.instances=[],this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this.name=t,this._volume=s.volume!==void 0?U.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0&&s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof se&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this)}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;const e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else{const t=function(i){const n=e._playWhenLoaded;e.sound=i,n&&e.play()};this.off("load",t),this.once("load",t),this.load()}return e}pause(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pause()&&(e=!0);return e}resume(){let e=!1;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].resume()&&(e=!0);return e}stop(){let e=!1;const t=this.instances;let s=t.length;for(;s--;)t[s].stop(),e=!0;return t.length=0,e}load(){if(!this._hasAsset())return;const e=this._assets.get(this._asset);if(!e){this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this);return}if(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),!e.resource){e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e);return}this.fire("load",e.resource)}setExternalNodes(e,t){if(!e){console.error("The firstNode must have a valid AudioNode");return}if(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap){const s=this.instances;for(let i=0,n=s.length;i<n;i++)s[i].setExternalNodes(e,t)}}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return this._asset!=null}_createInstance(){let e=null;const t=this._component;let s=null;if(this._hasAsset()){const n=this._assets.get(this._asset);n&&(s=n.resource)}const i=d3;return i.volume=this._volume*t.volume,i.pitch=this._pitch*t.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,t.positional?(i.position.copy(t.entity.getPosition()),i.maxDistance=t.maxDistance,i.refDistance=t.refDistance,i.rollOffFactor=t.rollOffFactor,i.distanceModel=t.distanceModel,e=new Zr(this._manager,s,i)):e=new us(this._manager,s,i),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e}_onInstancePlay(e){this.fire("play",e),this._component.fire("play",this,e)}_onInstancePause(e){this.fire("pause",e),this._component.fire("pause",this,e)}_onInstanceResume(e){this.fire("resume",e),this._component.fire("resume",this,e)}_onInstanceStop(e){const t=this.instances.indexOf(e);t!==-1&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e)}_onInstanceEnd(e){const t=this.instances.indexOf(e);t!==-1&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e)}_onAssetAdd(e){this.load()}_onAssetLoad(e){this.load()}_onAssetRemoved(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop()}updatePosition(e){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].position=e}set asset(e){const t=this._asset;if(t){this._assets.off("add:"+t,this._onAssetAdd,this);const s=this._assets.get(t);s&&s.off("remove",this._onAssetRemoved,this)}this._asset=e,this._asset instanceof se&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get asset(){return this._asset}set autoPlay(e){this._autoPlay=!!e}get autoPlay(){return this._autoPlay}set duration(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].duration=this._duration}}get duration(){let e=0;if(this._hasAsset()){const t=this._assets.get(this._asset);e=t!=null&&t.resource?t.resource.duration:0}return this._duration!=null?this._duration%(e||1):e}get isLoaded(){if(this._hasAsset()){const e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}get isPaused(){const e=this.instances,t=e.length;if(t===0)return!1;for(let s=0;s<t;s++)if(!e[s].isPaused)return!1;return!0}get isPlaying(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(e[t].isPlaying)return!0;return!1}get isStopped(){const e=this.instances;for(let t=0,s=e.length;t<s;t++)if(!e[t].isStopped)return!1;return!0}set loop(e){this._loop=!!e;const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].loop=this._loop}get loop(){return this._loop}set overlap(e){this._overlap=!!e}get overlap(){return this._overlap}set pitch(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pitch=this.pitch*this._component.pitch}}get pitch(){return this._pitch}set startTime(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].startTime=this._startTime}}get startTime(){return this._startTime}set volume(e){if(this._volume=U.clamp(Number(e)||0,0,1),!this._overlap){const t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].volume=this._volume*this._component.volume}}get volume(){return this._volume}}xn.EVENT_PLAY="play",xn.EVENT_PAUSE="pause",xn.EVENT_RESUME="resume",xn.EVENT_STOP="stop",xn.EVENT_LOAD="load";class cr extends he{constructor(e,t){super(e,t),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=Dl,this._slots={},this._playingBeforeDisable={}}_updateSoundInstances(e,t,s){const i=this._slots;for(const n in i){const r=i[n];if(!r.overlap){const a=r.instances;for(let l=0,h=a.length;l<h;l++)a[l][e]=s?r[e]*t:t}}}set distanceModel(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,!1)}get distanceModel(){return this._distanceModel}set maxDistance(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,!1)}get maxDistance(){return this._maxDistance}set refDistance(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,!1)}get refDistance(){return this._refDistance}set rollOffFactor(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,!1)}get rollOffFactor(){return this._rollOffFactor}set pitch(e){this._pitch=e,this._updateSoundInstances("pitch",e,!0)}get pitch(){return this._pitch}set volume(e){this._volume=e,this._updateSoundInstances("volume",e,!0)}get volume(){return this._volume}set positional(e){this._positional=e;const t=this._slots;for(const s in t){const i=t[s];if(!i.overlap){const n=i.instances,r=n.length;for(let a=r-1;a>=0;a--){const l=n[a].isPlaying||n[a].isSuspended,h=n[a].currentTime;l&&n[a].stop();const c=i._createInstance();l&&(c.play(),c.currentTime=h),n.push(c)}}}}get positional(){return this._positional}set slots(e){const t=this._slots;if(t)for(const i in t)t[i].stop();const s={};for(const i in e)e[i]instanceof xn?s[e[i].name]=e[i]:e[i].name&&(s[e[i].name]=new xn(this,e[i].name,e[i]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;const e=this._slots,t=this._playingBeforeDisable;for(const s in e){const i=e[s];i.autoPlay&&i.isStopped?i.play():t[s]?i.resume():i.isLoaded||i.load()}}onDisable(){const e=this._slots,t={};for(const s in e)e[s].overlap||e[s].isPlaying&&(e[s].pause(),t[s]=!0);this._playingBeforeDisable=t}onRemove(){this.off()}addSlot(e,t){const s=this._slots;if(s[e])return null;const i=new xn(this,e,t);return s[e]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(e){const t=this._slots;t[e]&&(t[e].stop(),delete t[e])}slot(e){return this._slots[e]}_getSlotProperty(e,t){if(!this.enabled||!this.entity.enabled)return;const s=this._slots[e];if(s)return s[t]}isPlaying(e){return this._getSlotProperty(e,"isPlaying")||!1}isLoaded(e){return this._getSlotProperty(e,"isLoaded")||!1}isPaused(e){return this._getSlotProperty(e,"isPaused")||!1}isStopped(e){return this._getSlotProperty(e,"isStopped")||!1}play(e){if(!this.enabled||!this.entity.enabled)return null;const t=this._slots[e];return t?t.play():null}pause(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.pause()}else for(const s in t)t[s].pause()}resume(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.isPaused&&s.resume()}else for(const s in t)t[s].resume()}stop(e){const t=this._slots;if(e){const s=t[e];if(!s)return;s.stop()}else for(const s in t)t[s].stop()}}cr.EVENT_PLAY="play",cr.EVENT_PAUSE="pause",cr.EVENT_RESUME="resume",cr.EVENT_STOP="stop",cr.EVENT_END="end";class u3{constructor(){this.enabled=!0}}const TT=["enabled"];class wT extends Ve{constructor(e){super(e),this.id="sound",this.ComponentType=cr,this.DataType=u3,this.schema=TT,this.manager=e.soundManager,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set volume(e){this.manager.volume=e}get volume(){return this.manager.volume}get context(){return Ji()?this.manager.context:null}initializeComponentData(e,t,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.sound,i=s.slots,n={};for(const a in i){const l=i[a];n[a]={name:l.name,volume:l.volume,pitch:l.pitch,loop:l.loop,duration:l.duration,startTime:l.startTime,overlap:l.overlap,autoPlay:l.autoPlay,asset:l.asset}}const r={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:n,volume:s.volume};return this.addComponent(t,r)}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const n=t[s].entity;if(n.enabled){const r=n.sound;if(r.enabled&&r.positional){const a=n.getPosition(),l=r.slots;for(const h in l)l[h].updatePosition(a)}}}}onBeforeRemove(e,t){const s=t.slots;for(const i in s)s[i].overlap||s[i].stop();t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}he._buildAccessors(cr.prototype,TT);const mg="simple",_g="animated";class Ui extends Q{constructor(e,t){super(),this._component=e,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||!1,this._playing=!1,this._paused=!1,this._time=0}get duration(){if(this._sprite){const e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}set frame(e){this._setFrame(e);const t=this.fps||Number.MIN_VALUE;this._setTime(this._frame/t)}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(e){if(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let t;!e||!e.atlas?(t=this._component._meshInstance,t&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel()):(e.atlas.texture&&(t=this._component._meshInstance,t&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame)}}get sprite(){return this._sprite}set spriteAsset(e){const t=this._component.system.app.assets;let s=e;if(e instanceof se&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){const i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){const i=t.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}get spriteAsset(){return this._spriteAsset}set time(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}get time(){return this._time}_onSpriteAssetAdded(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)}_unbindSpriteAsset(e){e&&(e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&!e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this))}_onSpriteAssetLoad(e){if(!e.resource)this.sprite=null;else if(e.resource.atlas)this.sprite=e.resource;else{const t=e.data.textureAtlasAsset,s=this._component.system.app.assets;s.off("load:"+t,this._onTextureAtlasLoad,this),s.once("load:"+t,this._onTextureAtlasLoad,this)}}_onTextureAtlasLoad(e){const t=this._spriteAsset;t instanceof se?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t))}_onSpriteAssetRemove(e){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&this.sprite.renderMode!==Fi&&this._component._showFrame(this.frame)}_update(e){if(this.fps===0||!this._playing||this._paused||!this._sprite)return;const t=this.fps<0?-1:1,s=this._time+e*this._component.speed*t,i=this.duration,n=s>i||s<0;this._setTime(s);let r=this.frame;this._sprite?r=Math.floor(this._sprite.frameKeys.length*this._time/i):r=0,r!==this._frame&&this._setFrame(r),n&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(e){this._time=e;const t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t)}_setFrame(e){this._sprite?this._frame=U.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){if(this._spriteAsset){const e=this._component.system.app.assets;this._unbindSpriteAsset(e.get(this._spriteAsset))}this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){!this._playing||this._paused||(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}}Ui.EVENT_PLAY="play",Ui.EVENT_PAUSE="pause",Ui.EVENT_RESUME="resume",Ui.EVENT_STOP="stop",Ui.EVENT_END="end",Ui.EVENT_LOOP="loop";const ET="texture_emissiveMap",AT="texture_opacityMap",CT="material_emissive",MT="material_opacity",f3="innerOffset",p3="outerScale",m3="atlasRect";class Sn extends he{constructor(e,t){super(e,t),this._type=mg,this._material=e.defaultMaterial,this._color=new H(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[is],this._outerScale=new G(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new X,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new X,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new we,this._model=new _i,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new Ui(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}set type(e){this._type!==e&&(this._type=e,this._type===mg?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===_g&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get type(){return this._type}set frame(e){this._currentClip.frame=e}get frame(){return this._currentClip.frame}set spriteAsset(e){this._defaultClip.spriteAsset=e}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(e){this._currentClip.sprite=e}get sprite(){return this._currentClip.sprite}set material(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}get material(){return this._material}set color(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(CT,this._colorUniform))}get color(){return this._color}set opacity(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(MT,e)}get opacity(){return this._color.a}set clips(e){if(!e){for(const t in this._clips)this.removeClip(t);return}for(const t in this._clips){let s=!1;for(const i in e)if(e[i].name===t){s=!0,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}s||this.removeClip(t)}for(const t in e)this._clips[e[t].name]||this.addClip(e[t]);this._autoPlayClip&&this._tryAutoPlay(),(!this._currentClip||!this._currentClip.sprite)&&this._hideModel()}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(e){this._speed=e}get speed(){return this._speed}set flipX(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}get flipX(){return this._flipX}set flipY(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}get flipY(){return this._flipY}set width(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,this.sprite&&(this.sprite.renderMode===st||this.sprite.renderMode===ot)&&this._updateTransform())}get width(){return this._width}set height(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,this.sprite&&(this.sprite.renderMode===st||this.sprite.renderMode===ot)&&this._updateTransform())}get height(){return this._height}set batchGroupId(e){if(this._batchGroupId===e)return;const t=this._batchGroupId;if(this._batchGroupId=e,this.entity.enabled&&t>=0){var s;(s=this.system.app.batcher)==null||s.remove(it.SPRITE,t,this.entity)}if(this.entity.enabled&&e>=0){var i;(i=this.system.app.batcher)==null||i.insert(it.SPRITE,e,this.entity)}else t>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get batchGroupId(){return this._batchGroupId}set autoPlayClip(e){this._autoPlayClip=e instanceof Ui?e.name:e,this._tryAutoPlay()}get autoPlayClip(){return this._autoPlayClip}set drawOrder(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}get drawOrder(){return this._drawOrder}set layers(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){const e=this.system.app,t=e.scene;if(t.on("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.on("add",this._onLayerAdded,this),t.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0){var s;(s=e.batcher)==null||s.insert(it.SPRITE,this._batchGroupId,this.entity)}}onDisable(){const e=this.system.app,t=e.scene;if(t.off("set:layers",this._onLayersChanged,this),t.layers&&(t.layers.off("add",this._onLayerAdded,this),t.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),this._batchGroupId>=0){var s;(s=e.batcher)==null||s.remove(it.SPRITE,this._batchGroupId,this.entity)}}onDestroy(){var e;this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(const t in this._clips)this._clips[t]._destroy();this._clips=null,this._hideModel(),this._model=null,(e=this._node)==null||e.remove(),this._node=null,this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel||!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.addMeshInstances(e)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;const e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){const i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.removeMeshInstances(e)}this._addedModel=!1}_showFrame(e){if(!this.sprite)return;const t=this.sprite.meshes[e];if(!t){this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1);return}let s;if(this.sprite.renderMode===ot?s=this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===st?s=this.system.default9SlicedMaterialTiledMode:s=this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new Te(t,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(CT,this._colorUniform),this._meshInstance.setParameter(MT,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==t&&(this._meshInstance.mesh=t,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(ET,this.sprite.atlas.texture),this._meshInstance.setParameter(AT,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(ET),this._meshInstance.deleteParameter(AT)),this.sprite.atlas&&(this.sprite.renderMode===ot||this.sprite.renderMode===st)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;const i=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(i){const n=2/i.rect.z,r=2/i.rect.w;this._innerOffset.set(i.border.x*n,i.border.y*r,i.border.z*n,i.border.w*r);const a=this.sprite.atlas.texture;this._atlasRect.set(i.rect.x/a.width,i.rect.y/a.height,i.rect.z/a.width,i.rect.w/a.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter(f3,this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter(m3,this._atlasRectUniform)}else this._meshInstance._updateAabbFunc=null;this._updateTransform()}_updateTransform(){let e=this.flipX?-1:1,t=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(this.sprite.renderMode===ot||this.sprite.renderMode===st)){let n=1,r=1;if(this.sprite.atlas){const h=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];h&&(n=h.rect.z,r=h.rect.w,s=(.5-h.pivot.x)*this._width,i=(.5-h.pivot.y)*this._height)}const a=n/this.sprite.pixelsPerUnit,l=r/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*a),Math.max(this._height,this._innerOffset.y*l)),e*=a,t*=l,this._outerScale.x/=a,this._outerScale.y/=l,e*=U.clamp(this._width/(this._innerOffset.x*a),1e-4,1),t*=U.clamp(this._height/(this._innerOffset.y*l),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter(p3,this._outerScaleUniform))}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(s,i,0)}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e}_tryAutoPlay(){if(!this._autoPlayClip||this.type!==_g)return;const e=this._clips[this._autoPlayClip];e&&!e.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying)&&this.enabled&&this.entity.enabled&&this.play(e.name)}_onLayersChanged(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(e){this.layers.indexOf(e.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])}_onLayerRemoved(e){!this._meshInstance||this.layers.indexOf(e.id)<0||e.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this._meshInstance])}}addClip(e){const t=new Ui(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t}removeClip(e){delete this._clips[e]}clip(e){return this._clips[e]}play(e){const t=this._clips[e],s=this._currentClip;return s&&s!==t&&(s._playing=!1),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}Sn.EVENT_PLAY="play",Sn.EVENT_PAUSE="pause",Sn.EVENT_RESUME="resume",Sn.EVENT_STOP="stop",Sn.EVENT_END="end",Sn.EVENT_LOOP="loop";class _3{constructor(){this.enabled=!0}}const PT=["enabled"];class RT extends Ve{constructor(e){super(e),this.id="sprite",this.ComponentType=Sn,this.DataType=_3,this.schema=PT,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set defaultMaterial(e){this._defaultMaterial=e}get defaultMaterial(){if(!this._defaultMaterial){const e=new re(this.app.graphicsDevice,{width:1,height:1,format:oe,name:"sprite"}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.unlock();const s=new Ct;s.diffuse.set(0,0,0),s.emissive.set(.5,.5,.5),s.emissiveMap=e,s.emissiveTint=!0,s.opacityMap=e,s.opacityMapChannel="a",s.opacityTint=!0,s.opacity=0,s.useLighting=!1,s.useGammaTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.blendType=jn,s.depthWrite=!1,s.pixelSnap=!1,s.cull=Je,s.update(),this._defaultTexture=e,this._defaultMaterial=s}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(e){this._default9SlicedMaterialSlicedMode=e}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){const e=this.defaultMaterial.clone();e.nineSlicedMode=ot,e.update(),this._default9SlicedMaterialSlicedMode=e}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(e){this._default9SlicedMaterialTiledMode=e}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){const e=this.defaultMaterial.clone();e.nineSlicedMode=st,e.update(),this._default9SlicedMaterialTiledMode=e}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)}initializeComponentData(e,t,s){if(t.enabled!==void 0&&(e.enabled=t.enabled),e.type=t.type,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),t.drawOrder!==void 0&&(e.drawOrder=t.drawOrder),t.color!==void 0){if(t.color instanceof H){var i;e.color.set(t.color.r,t.color.g,t.color.b,(i=t.opacity)!=null?i:1)}else{var n;e.color.set(t.color[0],t.color[1],t.color[2],(n=t.opacity)!=null?n:1)}e.color=e.color}if(t.opacity!==void 0&&(e.opacity=t.opacity),t.flipX!==void 0&&(e.flipX=t.flipX),t.flipY!==void 0&&(e.flipY=t.flipY),t.width!==void 0&&(e.width=t.width),t.height!==void 0&&(e.height=t.height),t.spriteAsset!==void 0&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),t.frame!==void 0&&(e.frame=t.frame),t.clips)for(const r in t.clips)e.addClip(t.clips[r]);t.speed!==void 0&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=t.batchGroupId===void 0||t.batchGroupId===null?-1:t.batchGroupId,super.initializeComponentData(e,t,s)}cloneComponent(e,t){const s=e.sprite;return this.addComponent(t,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,width:s.width,height:s.height,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s];if(i.data.enabled&&i.entity.enabled){const n=i.entity.sprite;n._currentClip&&n._currentClip._update(e)}}}onBeforeRemove(e,t){t.onDestroy()}}he._buildAccessors(Sn.prototype,PT);class Ra extends he{constructor(e,t){super(e,t),this._oldState=!0,this._size=new y,this.on("set_enabled",this._onSetEnabled,this)}set size(e){e instanceof y?this._size.copy(e):e instanceof Array&&e.length>=3&&this.size.set(e[0],e[1],e[2])}get size(){return this._size}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(e,t,s){this._checkState()}_checkState(){const e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}}Ra.EVENT_ENABLE="enable",Ra.EVENT_DISABLE="disable",Ra.EVENT_STATE="state",Ra.EVENT_REMOVE="remove";class g3{constructor(){this.enabled=!0}}const IT=["enabled"];class DT extends Ve{constructor(e){super(e),this.id="zone",this.ComponentType=Ra,this.DataType=g3,this.schema=IT,this.on("beforeremove",this._onBeforeRemove,this)}initializeComponentData(e,t,s){e.enabled=t.hasOwnProperty("enabled")?!!t.enabled:!0,t.size&&(t.size instanceof y?e.size.copy(t.size):t.size instanceof Array&&t.size.length>=3&&e.size.set(t.size[0],t.size[1],t.size[2]))}cloneComponent(e,t){const s={size:e.zone.size};return this.addComponent(t,s)}_onBeforeRemove(e,t){t._onBeforeRemove()}}he._buildAccessors(Ra.prototype,IT);class y3{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name}}class gg{constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(e,t){var s,i;const n=this.camera.rect,r=this.destinationRenderTarget,a=this.app.graphicsDevice,l=Math.floor(n.z*((s=r==null?void 0:r.width)!=null?s:a.width)),h=Math.floor(n.w*((i=r==null?void 0:r.height)!=null?i:a.height));return new re(a,{name:t,format:e,width:l,height:h,mipmaps:!1,minFilter:de,magFilter:de,addressU:q,addressV:q})}_createOffscreenTarget(e,t){const s=this.app.graphicsDevice,i=t&&s.getRenderableHdrFormat([et,Ge],!0)||oe,n=this.camera.entity.name+"-posteffect-"+this.effects.length,r=this._allocateColorBuffer(i,n);return new qe({colorBuffer:r,depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?s.samples:1})}_resizeOffscreenTarget(e){const t=e.colorBuffer.format,s=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,s),e._colorBuffers=[e._colorBuffer]}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy()}addEffect(e){const t=this.effects,s=t.length===0,i=this._createOffscreenTarget(s,e.hdr),n=new y3(e,i);t.push(n),this._sourceTarget=n.inputTarget,t.length>1&&(t[t.length-2].outputTarget=n.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(e){let t=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===e){t=s;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),this.effects.length===0&&this.disable()}_requestDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){const s=this.effects[e].effect;this._newPostEffect!==s&&s.needsDepthBuffer&&this._requestDepthMap()}}_releaseDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()}_requestDepthMap(){const e=this.app.scene.layers.getLayerById(kt);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const e=this.app.scene.layers.getLayerById(kt);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let e=null;const t=this.effects.length;if(t)for(let s=0;s<t;s++){const i=this.effects[s];let n=i.outputTarget;s===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,e)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)}_onCanvasResized(e,t){var s,i;const n=this.camera.rect,r=this.destinationRenderTarget;e=(s=r==null?void 0:r.width)!=null?s:e,t=(i=r==null?void 0:r.height)!=null?i:t,this.camera.camera.aspectRatio=e*n.z/(t*n.w),this.resizeRenderTargets()}resizeRenderTargets(){var e,t;const s=this.app.graphicsDevice,i=this.destinationRenderTarget,n=(e=i==null?void 0:i.width)!=null?e:s.width,r=(t=i==null?void 0:i.height)!=null?t:s.height,a=this.camera.rect,l=Math.floor(a.z*n),h=Math.floor(a.w*r),c=this.effects;for(let d=0,u=c.length;d<u;d++){const f=c[d];(f.inputTarget.width!==l||f.inputTarget.height!==h)&&this._resizeOffscreenTarget(f.inputTarget)}}onCameraRectChanged(e,t,s){this.enabled&&this.resizeRenderTargets()}}class cf extends he{constructor(e,t){super(e,t),this.onPostprocessing=null,this.onPreRender=null,this.onPostRender=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=Fh,this._camera=new sa,this._camera.node=t,this._postEffects=new gg(e.app,this)}setShaderPass(e){const t=zs.get(this.system.app.graphicsDevice),s=e?t.allocate(e,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){var e;return(e=this._camera.shaderPassInfo)==null?void 0:e.name}set renderPasses(e){this._camera.renderPasses=e}get renderPasses(){return this._camera.renderPasses}set aperture(e){this._camera.aperture=e}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e}get horizontalFov(){return this._camera.horizontalFov}set layers(e){const t=this._camera.layers;for(let s=0;s<t.length;s++){const i=this.system.app.scene.layers.getLayerById(t[s]);i&&i.removeCamera(this)}if(this._camera.layers=e,!(!this.enabled||!this.entity.enabled))for(let s=0;s<e.length;s++){const i=this.system.app.scene.layers.getLayerById(e[s]);i&&i.addCamera(this)}}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(e){this._camera.projection=e}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find(s=>s===kt)){const s=this.system.app.scene.layers.getLayerById(kt);e?s==null||s.incrementCounter():s==null||s.decrementCounter()}else if(e)return!1;return!0}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap)}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap)}dirtyLayerCompositionCameras(){const e=this.system.app.scene.layers;e._dirty=!0}screenToWorld(e,t,s,i){const n=this.system.app.graphicsDevice,r=n.clientRect.width,a=n.clientRect.height;return this._camera.screenToWorld(e,t,s,r,a,i)}worldToScreen(e,t){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(e,i,n,t)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}removeCameraFromLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addCamera(this)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)}onEnable(){const e=this.system,t=e.app.scene,s=t.layers;e.addCamera(this),t.on("set:layers",this.onLayersChanged,this),s&&(s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const e=this.system,t=e.app.scene,s=t.layers;this.postEffects.disable(),this.removeCameraFromLayers(),t.off("set:layers",this.onLayersChanged,this),s&&(s.off("add",this.onLayerAdded,this),s.off("remove",this.onLayerRemoved,this)),e.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(e){const t=this.system.app.graphicsDevice,s=e?e.width:t.width,i=e?e.height:t.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(e){this.aspectRatioMode===jd&&(this.aspectRatio=this.calculateAspectRatio(e))}startXr(e,t,s){this.system.app.xr.start(this,e,t,s)}endXr(e){if(!this._camera.xr){e&&e(new Error("Camera is not in XR"));return}this._camera.xr.end(e)}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter}}class v3{constructor(){this.enabled=!0}}const LT=["enabled"];class FT extends Ve{constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=cf,this.DataType=v3,this.schema=LT,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity"];for(let i=0;i<s.length;i++){const n=s[i];if(t.hasOwnProperty(n)){const r=t[n];switch(n){case"rect":case"scissorRect":Array.isArray(r)?e[n]=new X(r[0],r[1],r[2],r[3]):e[n]=r;break;case"clearColor":Array.isArray(r)?e[n]=new H(r[0],r[1],r[2],r[3]):e[n]=r;break;default:e[n]=r;break}}}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.camera;return this.addComponent(t,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter})}onBeforeRemove(e,t){this.removeCamera(t),t.onRemove()}onUpdate(e){}onAppPrerender(){for(let e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender()}addCamera(e){this.cameras.push(e),nc(this.cameras)}removeCamera(e){const t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),nc(this.cameras))}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}he._buildAccessors(cf.prototype,LT);const Ia=[],yg=[];class df extends he{constructor(e,t){super(e,t),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}addLightToLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t))}}removeLightFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t))}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e))}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e))}refreshProperties(){for(let e=0;e<Ia.length;e++){const t=Ia[e];this[t]=this[t]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){let e=!1;this._cookieAsset.type==="cubemap"&&!this._cookieAsset.loadFaces&&(this._cookieAsset.loadFaces=!0,e=!0),(!this._cookieAsset.resource||e)&&this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){!this._cookieAsset||!this._cookieAsset.resource||(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}set shadowUpdateOverrides(e){this.light.shadowUpdateOverrides=e}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set penumbraSize(e){this.light.penumbraSize=e}get penumbraSize(){return this.light.penumbraSize}}function ue(o,e,t,s){const i=df.prototype;Ia.push(o),yg.push(e),Object.defineProperty(i,o,{get:function(){return this.data[o]},set:function(n){const r=this.data,a=r[o];!s&&a===n||(r[o]=n,t&&t.call(this,n,a))},configurable:!0})}function x3(){ue("enabled",!0,function(o,e){this.onSetEnabled(null,e,o)}),ue("light",null),ue("type","directional",function(o,e){this.system.changeType(this,e,o),this.refreshProperties()}),ue("color",new H(1,1,1),function(o,e){this.light.setColor(o)},!0),ue("intensity",1,function(o,e){this.light.intensity=o}),ue("luminance",0,function(o,e){this.light.luminance=o}),ue("shape",yt,function(o,e){this.light.shape=o}),ue("affectSpecularity",!0,function(o,e){this.light.affectSpecularity=o}),ue("castShadows",!1,function(o,e){this.light.castShadows=o}),ue("shadowDistance",40,function(o,e){this.light.shadowDistance=o}),ue("shadowIntensity",1,function(o,e){this.light.shadowIntensity=o}),ue("shadowResolution",1024,function(o,e){this.light.shadowResolution=o}),ue("shadowBias",.05,function(o,e){this.light.shadowBias=-.01*U.clamp(o,0,1)}),ue("numCascades",1,function(o,e){this.light.numCascades=U.clamp(Math.floor(o),1,4)}),ue("bakeNumSamples",1,function(o,e){this.light.bakeNumSamples=U.clamp(Math.floor(o),1,255)}),ue("bakeArea",0,function(o,e){this.light.bakeArea=U.clamp(o,0,180)}),ue("cascadeDistribution",.5,function(o,e){this.light.cascadeDistribution=U.clamp(o,0,1)}),ue("normalOffsetBias",0,function(o,e){this.light.normalOffsetBias=U.clamp(o,0,1)}),ue("range",10,function(o,e){this.light.attenuationEnd=o}),ue("innerConeAngle",40,function(o,e){this.light.innerConeAngle=o}),ue("outerConeAngle",45,function(o,e){this.light.outerConeAngle=o}),ue("falloffMode",Ud,function(o,e){this.light.falloffMode=o}),ue("shadowType",at,function(o,e){this.light.shadowType=o}),ue("vsmBlurSize",11,function(o,e){this.light.vsmBlurSize=o}),ue("vsmBlurMode",zd,function(o,e){this.light.vsmBlurMode=o}),ue("vsmBias",.01*.25,function(o,e){this.light.vsmBias=U.clamp(o,0,1)}),ue("cookieAsset",null,function(o,e){if(!(this._cookieAssetId&&(o instanceof se&&o.id===this._cookieAssetId||o===this._cookieAssetId))){if(this.onCookieAssetRemove(),this._cookieAssetId=null,o instanceof se)this.data.cookieAsset=o.id,this._cookieAssetId=o.id,this.onCookieAssetAdd(o);else if(typeof o=="number"){this._cookieAssetId=o;const t=this.system.app.assets.get(o);t?this.onCookieAssetAdd(t):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}}}),ue("cookie",null,function(o,e){this.light.cookie=o}),ue("cookieIntensity",1,function(o,e){this.light.cookieIntensity=U.clamp(o,0,1)}),ue("cookieFalloff",!0,function(o,e){this.light.cookieFalloff=o}),ue("cookieChannel","rgb",function(o,e){this.light.cookieChannel=o}),ue("cookieAngle",0,function(o,e){if(o!==0||this.cookieScale!==null){this._cookieMatrix||(this._cookieMatrix=new X);let t=1,s=1;this.cookieScale&&(t=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(o*U.DEG_TO_RAD),n=Math.sin(o*U.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),ue("cookieScale",null,function(o,e){if(o!==null||this.cookieAngle!==0){this._cookieMatrix||(this._cookieMatrix=new X);const t=o.x,s=o.y,i=Math.cos(this.cookieAngle*U.DEG_TO_RAD),n=Math.sin(this.cookieAngle*U.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0),ue("cookieOffset",null,function(o,e){this.light.cookieOffset=o},!0),ue("shadowUpdateMode",$d,function(o,e){this.light.shadowUpdateMode=o},!0),ue("mask",1,function(o,e){this.light.mask=o}),ue("affectDynamic",!0,function(o,e){o?this.light.mask|=ns:this.light.mask&=~ns,this.light.layersDirty()}),ue("affectLightmapped",!1,function(o,e){o?(this.light.mask|=hi,this.bake&&(this.light.mask&=~ci)):(this.light.mask&=~hi,this.bake&&(this.light.mask|=ci))}),ue("bake",!1,function(o,e){o?(this.light.mask|=ci,this.affectLightmapped&&(this.light.mask&=~hi)):(this.light.mask&=~ci,this.affectLightmapped&&(this.light.mask|=hi)),this.light.layersDirty()}),ue("bakeDir",!0,function(o,e){this.light.bakeDir=o}),ue("isStatic",!1,function(o,e){this.light.isStatic=o}),ue("layers",[is],function(o,e){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&(s.removeLight(this),this.light.removeLayer(s))}for(let t=0;t<o.length;t++){const s=this.system.app.scene.layers.getLayerById(o[t]);s&&this.enabled&&this.entity.enabled&&(s.addLight(this),this.light.addLayer(s))}}),Ia.push("penumbraSize"),yg.push(1)}x3();class S3{constructor(){const e=Ia,t=yg;for(let s=0;s<e.length;s++){const i=t[s];i&&i.clone?this[e[s]]=i.clone():this[e[s]]=i}}}class OT extends Ve{constructor(e){super(e),this.id="light",this.ComponentType=df,this.DataType=S3,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t){const s=Ia,i={};for(let r=0,a=s.length;r<a;r++){const l=s[r];i[l]=t[l]}i.type||(i.type=e.data.type),e.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new H(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new G(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new G(i.cookieScale[0],i.cookieScale[1])),i.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),i.enabled=i.enable),i.shape||(i.shape=yt);const n=new el(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);n.type=t_[i.type],n._node=e.entity,e.data.light=n,super.initializeComponentData(e,i,s)}_onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){const s=e.light,i=[];let n;const r=Ia;for(let a=0;a<r.length;a++)n=r[a],n!=="light"&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);return this.addComponent(t,i)}changeType(e,t,s){t!==s&&(e.light.type=t_[s])}}const b3=["x","y","z","w"],T3=[void 0,void 0,G,y,X];function uf(o,e,t,s){switch(e.type){case"boolean":return!!t;case"number":if(typeof t=="number")return t;if(typeof t=="string"){const i=parseInt(t,10);return isNaN(i)?null:i}else if(typeof t=="boolean")return 0+t;return null;case"json":{const i={};if(Array.isArray(e.schema)){(!t||typeof t!="object")&&(t={});for(let n=0;n<e.schema.length;n++){const r=e.schema[n];if(r.name)if(r.array){i[r.name]=[];const a=Array.isArray(t[r.name])?t[r.name]:[];for(let l=0;l<a.length;l++)i[r.name].push(uf(o,r,a[l]))}else{const a=t.hasOwnProperty(r.name)?t[r.name]:r.default;i[r.name]=uf(o,r,a)}}}return i}case"asset":return t instanceof se?t:typeof t=="number"?o.assets.get(t)||null:typeof t=="string"&&o.assets.get(parseInt(t,10))||null;case"entity":return t instanceof we?t:typeof t=="string"?o.getEntityFromIndex(t):null;case"rgb":case"rgba":if(t instanceof H)return s instanceof H?(s.copy(t),s):t.clone();if(t instanceof Array&&t.length>=3&&t.length<=4){for(let i=0;i<t.length;i++)if(typeof t[i]!="number")return null;return s||(s=new H),s.r=t[0],s.g=t[1],s.b=t[2],s.a=t.length===3?1:t[3],s}else if(typeof t=="string"&&/#([0-9abcdef]{2}){3,4}/i.test(t))return s||(s=new H),s.fromString(t),s;return null;case"vec2":case"vec3":case"vec4":{const i=parseInt(e.type.slice(3),10),n=T3[i];if(t instanceof n)return s instanceof n?(s.copy(t),s):t.clone();if(t instanceof Array&&t.length===i){for(let r=0;r<t.length;r++)if(typeof t[r]!="number")return null;s||(s=new n);for(let r=0;r<i;r++)s[b3[r]]=t[r];return s}return null}case"curve":if(t){let i;if(t instanceof os||t instanceof Wi)i=t.clone();else{const n=t.keys[0]instanceof Array?Wi:os;i=new n(t.keys),i.type=t.type}return i}break}return t}class dr{constructor(e){this.scriptType=e,this.index={}}add(e,t){this.index[e]||dr.reservedNames.has(e)||(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(s){const i="attr",n="attr:"+e,r=this.__attributes[e];let a=r;if(r&&t.type!=="json"&&t.type!=="entity"&&r.clone&&(this.hasEvent(i)||this.hasEvent(n))&&(a=r.clone()),t.array){if(this.__attributes[e]=[],s)for(let l=0,h=s.length;l<h;l++)this.__attributes[e].push(uf(this.app,t,s[l],r?r[l]:null))}else this.__attributes[e]=uf(this.app,t,s,r);this.fire(i,e,this.__attributes[e],a),this.fire(n,this.__attributes[e],a)}}))}remove(e){return this.index[e]?(delete this.index[e],delete this.scriptType.prototype[e],!0):!1}has(e){return!!this.index[e]}get(e){return this.index[e]||null}}dr.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);const vg="initialize",xg="postInitialize",w3="update",E3="postUpdate",A3="swap";class zi extends he{constructor(e,t){super(e,t),this._scripts=[],this._updateList=new Rl({sortBy:"__executionOrder"}),this._postUpdateList=new Rl({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(e){this._scriptsData=e;for(const t in e){if(!e.hasOwnProperty(t))continue;const s=this._scriptsIndex[t];if(s){if(typeof e[t].enabled=="boolean"&&(s.enabled=!!e[t].enabled),typeof e[t].attributes=="object"){for(const i in e[t].attributes)if(!dr.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const n=this.system.app.scripts.get(t);n&&n.attributes.add(i,{})}s[i]=e[t].attributes[i]}}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(e){const t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const e=this._beginLooping();for(let t=0,s=this.scripts.length;t<s;t++){const i=this.scripts[t];i._initialized&&!i._postInitialized&&i.enabled&&(i._postInitialized=!0,i.postInitialize&&this._scriptMethod(i,xg))}this._endLooping(e)}_beginLooping(){const e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(e,t,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const e=this.enabled&&this.entity.enabled;if(e===this._oldState)return;this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const t=this._beginLooping();for(let s=0,i=this.scripts.length;s<i;s++){const n=this.scripts[s];n.enabled=n._enabled}this._endLooping(t)}_onBeforeRemove(){this.fire("remove");const e=this._beginLooping();for(let t=0;t<this.scripts.length;t++){const s=this.scripts[t];s&&this.destroy(s.__scriptType.__name)}this._endLooping(e)}_removeDestroyedScripts(){const e=this._destroyedScripts.length;if(e){for(let t=0;t<e;t++){const s=this._destroyedScripts[t];this._removeScriptInstance(s)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let e=0,t=this.scripts.length;e<t;e++)this.scripts[e].__initializeAttributes()}_scriptMethod(e,t,s){e[t](s)}_onInitialize(){const e=this._scripts,t=this._beginLooping();for(let s=0,i=e.length;s<i;s++){const n=e[s];!n._initialized&&n.enabled&&(n._initialized=!0,n.initialize&&this._scriptMethod(n,vg))}this._endLooping(t)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(e){const t=this._updateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,w3,e)}this._endLooping(s)}_onPostUpdate(e){const t=this._postUpdateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,E3,e)}this._endLooping(s)}_insertScriptInstance(e,t,s){t===-1?(this._scripts.push(e),e.__executionOrder=s,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,s+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))}_removeScriptInstance(e){const t=this._scripts.indexOf(e);return t===-1||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(let s=e;s<t;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(e,t,s,i,n,r){if(e.array){const a=s.length;if(!a)return;const l=s.slice();for(let h=0;h<a;h++){const c=l[h]instanceof Ce?l[h].getGuid():l[h];r[c]&&(l[h]=i?r[c].getGuid():r[c])}n[t]=l}else{if(s instanceof Ce)s=s.getGuid();else if(typeof s!="string")return;r[s]&&(n[t]=r[s])}}has(e){if(typeof e=="string")return!!this._scriptsIndex[e];if(!e)return!1;const t=e,s=t.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof t}get(e){if(typeof e=="string"){const r=this._scriptsIndex[e];return r?r.instance:null}if(!e)return null;const t=e,s=t.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof t?n:null}create(e,t={}){const s=this;let i=e,n=e;if(typeof i=="string"?i=this.system.app.scripts.get(i):i&&(n=i.__name),i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const r=new i({app:this.system.app,entity:this.entity,enabled:t.hasOwnProperty("enabled")?t.enabled:!0,attributes:t.attributes}),a=this._scripts.length;let l=-1;return typeof t.ind=="number"&&t.ind!==-1&&a>t.ind&&(l=t.ind),this._insertScriptInstance(r,l,a),this._scriptsIndex[n]={instance:r,onSwap:function(){s.swap(n)}},this[n]=r,t.preloading||r.__initializeAttributes(),this.fire("create",n,r),this.fire("create:"+n,r),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),t.preloading||(r.enabled&&!r._initialized&&(r._initialized=!0,r.initialize&&this._scriptMethod(r,vg)),r.enabled&&!r._postInitialized&&(r._postInitialized=!0,r.postInitialize&&this._scriptMethod(r,xg))),r}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null}destroy(e){let t=e,s=e;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!i)return!1;const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const r=this._removeScriptInstance(n);r>=0&&this._resetExecutionOrder(r,this._scripts.length)}return this.system.app.scripts.off("swap:"+t,i.onSwap),delete this[t],this.fire("destroy",t,n||null),this.fire("destroy:"+t,n||null),n&&n.fire("destroy"),!0}swap(e){let t=e,s=e;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(!i||!i.instance)return!1;const n=i.instance,r=this._scripts.indexOf(n),a=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return a.swap?(a.__initializeAttributes(),this._scripts[r]=a,this._scriptsIndex[t].instance=a,this[t]=a,a.__executionOrder=r,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a),this._scriptMethod(a,A3,n),this.fire("swap",t,a),this.fire("swap:"+t,a),!0):!1}resolveDuplicatedEntityReferenceProperties(e,t){const s=this.entity.script;for(const i in e._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const r=e._scriptsIndex[i];if(!r||!r.instance)continue;const a=s[i].__attributesRaw,l=s[i].__attributes;if(!a&&!l)continue;const h=!!a,c=r.instance.__attributes;for(const d in c){if(!c[d])continue;const u=n.attributes.get(d);if(u){if(u.type==="entity")this._resolveEntityScriptAttribute(u,d,c[d],h,a||l,t);else if(u.type==="json"&&Array.isArray(u.schema)){const f=c[d],p=a?a[d]:l[d];for(let _=0;_<u.schema.length;_++){const m=u.schema[_];if(m.type==="entity")if(u.array)for(let g=0;g<f.length;g++)this._resolveEntityScriptAttribute(m,m.name,f[g][m.name],h,p[g],t);else this._resolveEntityScriptAttribute(m,m.name,f[m.name],h,p,t)}}}}}}move(e,t){const s=this._scripts.length;if(t>=s||t<0)return!1;let i=e,n=e;typeof n!="string"?n=e.__name:i=null;const r=this._scriptsIndex[n];if(!r||!r.instance)return!1;const a=r.instance;if(i&&!(a instanceof i))return!1;const l=this._scripts.indexOf(a);return l===-1||l===t?!1:(this._scripts.splice(t,0,this._scripts.splice(l,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,a,t,l),this.fire("move:"+n,a,t,l),!0)}}zi.EVENT_CREATE="create",zi.EVENT_DESTROY="destroy",zi.EVENT_ENABLE="enable",zi.EVENT_DISABLE="disable",zi.EVENT_REMOVE="remove",zi.EVENT_STATE="state",zi.EVENT_MOVE="move",zi.EVENT_ERROR="error";class C3{constructor(){this.enabled=!0}}const M3="_onInitializeAttributes",P3="_onInitialize",R3="_onPostInitialize",I3="_onUpdate",D3="_onPostUpdate";let ff=0;class BT extends Ve{constructor(e){super(e),this.id="script",this.ComponentType=zi,this.DataType=C3,this._components=new Rl({sortBy:"_executionOrder"}),this._enabledComponents=new Rl({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t){if(e._executionOrder=ff++,this._components.append(e),ff>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=t.hasOwnProperty("enabled")?!!t.enabled:!0,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(let s=0;s<t.order.length;s++)e.create(t.order[s],{enabled:t.scripts[t.order[s]].enabled,attributes:t.scripts[t.order[s]].attributes,preloading:this.preloading})}}cloneComponent(e,t){const s=[],i={};for(let r=0;r<e.script._scripts.length;r++){const a=e.script._scripts[r],l=a.__scriptType.__name;s.push(l);const h={};for(const c in a.__attributes)h[c]=a.__attributes[c];i[l]={enabled:a._enabled,attributes:h}}for(const r in e.script._scriptsIndex)r.awaiting&&s.splice(r.ind,0,r);const n={enabled:e.script.enabled,order:s,scripts:i};return this.addComponent(t,n)}_resetExecutionOrder(){ff=0;for(let e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=ff++}_callComponentMethod(e,t,s){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,M3),this._callComponentMethod(this._enabledComponents,P3)}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,R3)}_onUpdate(e){this._callComponentMethod(this._enabledComponents,I3,e)}_onPostUpdate(e){this._callComponentMethod(this._enabledComponents,D3,e)}_addComponentToEnabled(e){this._enabledComponents.insert(e)}_removeComponentFromEnabled(e){this._enabledComponents.remove(e)}_onBeforeRemove(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}class Sg extends he{constructor(e,t){super(e,t),this._layers=[is],this._instance=null,this._customAabb=null,this._assetReference=void 0,this._materialOptions=null,this._assetReference=new _l("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set customAabb(e){var t;this._customAabb=e,(t=this._instance)==null||t.meshInstance.setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set instance(e){if(this.destroyInstance(),this._instance=e,this._instance){const t=this._instance.meshInstance;t.node||(t.node=this.entity),t.setCustomAabb(this._customAabb),this._materialOptions&&this._instance.createMaterial(this._materialOptions),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set materialOptions(e){this._materialOptions=Object.assign({},e),this._instance&&this._instance.createMaterial(this._materialOptions)}get materialOptions(){return this._materialOptions}get material(){var e;return(e=this._instance)==null?void 0:e.material}set layers(e){this.removeFromLayers(),this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];!this.enabled||!this.entity.enabled||this.addToLayers()}get layers(){return this._layers}set asset(e){const t=e instanceof se?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof se?e.id:e;this._assetReference.id=t}destroyInstance(){if(this._instance){var e;this.removeFromLayers(),(e=this._instance)==null||e.destroy(),this._instance=null}}addToLayers(){var e;const t=(e=this.instance)==null?void 0:e.meshInstance;if(t){const i=this.system.app.scene.layers;for(let n=0;n<this._layers.length;n++){var s;(s=i.getLayerById(this._layers[n]))==null||s.addMeshInstances([t])}}}removeFromLayers(){var e;const t=(e=this.instance)==null?void 0:e.meshInstance;if(t){const i=this.system.app.scene.layers;for(let n=0;n<this._layers.length;n++){var s;(s=i.getLayerById(this._layers[n]))==null||s.removeMeshInstances([t])}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||this._instance&&e.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||this._instance&&e.removeMeshInstances(this._instance.meshInstance)}onEnable(){const e=this.system.app.scene;e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){const e=this.system.app.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();const e=this._assetReference.asset;e&&(this.instance=e.resource.createInstance())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}}class L3{constructor(){this.enabled=!0}}const bg=["enabled"],Da=["instance","asset","layers"];class NT extends Ve{constructor(e){super(e),this.id="gsplat",this.ComponentType=Sg,this.DataType=L3,this.schema=bg,this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<Da.length;i++)t.hasOwnProperty(Da[i])&&(e[Da[i]]=t[Da[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new ye(new y(t.aabbCenter),new y(t.aabbHalfExtents))),super.initializeComponentData(e,t,bg)}cloneComponent(e,t){const s=e.gsplat,i={};for(let r=0;r<Da.length;r++)i[Da[r]]=s[Da[r]];i.enabled=s.enabled,delete i.instance;const n=this.addComponent(t,i);return n.instance=s.instance.clone(),s.customAabb&&(n.customAabb=s.customAabb.clone()),n}onRemove(e,t){t.onRemove()}}he._buildAccessors(Sg.prototype,bg);class Tg extends Q{constructor(){super(),this._meshes=null}set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){if(this._meshes){const e=this._meshes.length;for(let t=0;t<e;t++){const s=this._meshes[t];s&&(s.decRefCount(),s.refCount<1&&(s.destroy(),this._meshes[t]=null))}}}incRefMeshes(){if(this._meshes){const e=this._meshes.length;for(let t=0;t<e;t++)this._meshes[t]&&this._meshes[t].incRefCount()}}}Tg.EVENT_SETMESHES="set:meshes";function pf(o){const e=this;if(!e.resource)return;const t=o.resource,s=t.renders&&t.renders[e.data.renderIndex];s&&(e.resource.meshes=s.resource.meshes)}function kT(o){const e=this;e.registry.off("load:"+o.id,pf,e),e.registry.on("load:"+o.id,pf,e),e.registry.off("remove:"+o.id,UT,e),e.registry.once("remove:"+o.id,UT,e),o.resource?pf.call(e,o):e.registry.load(o)}function UT(o){const e=this;e.registry.off("load:"+o.id,pf,e),e.resource&&e.resource.destroy()}class zT extends Le{constructor(e){super(e,"render"),this._registry=e.assets}open(e,t){return new Tg}patch(e,t){if(!e.data.containerAsset)return;const s=t.get(e.data.containerAsset);if(!s){t.once("add:"+e.data.containerAsset,kT,e);return}kT.call(e,s)}}class wg{constructor(e,t,s,i){this._paths=e,this._input=t,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class Dc{constructor(e,t){this._components=e,this._data=t}get components(){return this._components}get data(){return this._data}}function F3(o,e){let t;const n=(f,p)=>{switch(p){case t.DT_INT8:return new Int8Array(f.buffer,f.byteOffset,f.byteLength);case t.DT_INT16:return new Int16Array(f.buffer,f.byteOffset,f.byteLength/2);case t.DT_INT32:return new Int32Array(f.buffer,f.byteOffset,f.byteLength/4);case t.DT_UINT8:return new Uint8Array(f.buffer,f.byteOffset,f.byteLength);case t.DT_UINT16:return new Uint16Array(f.buffer,f.byteOffset,f.byteLength/2);case t.DT_UINT32:return new Uint32Array(f.buffer,f.byteOffset,f.byteLength/4);case t.DT_FLOAT32:return new Float32Array(f.buffer,f.byteOffset,f.byteLength/4)}return null},r=f=>{switch(f){case t.DT_INT8:return 1;case t.DT_INT16:return 2;case t.DT_INT32:return 4;case t.DT_UINT8:return 1;case t.DT_UINT16:return 2;case t.DT_UINT32:return 4;case t.DT_FLOAT32:return 4}return 1},a=f=>f.num_components()*r(f.data_type()),l={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},h=(f,p)=>{const _=(I,B,P)=>{I[0]=B[0]-P[0],I[1]=B[1]-P[1],I[2]=B[2]-P[2]},m=(I,B,P)=>{I[0]=B[1]*P[2]-P[1]*B[2],I[1]=B[2]*P[0]-P[2]*B[0],I[2]=B[0]*P[1]-P[0]*B[1]},g=(I,B)=>{const P=I[B+0],D=I[B+1],R=I[B+2],A=1/Math.sqrt(P*P+D*D+R*R);I[B+0]*=A,I[B+1]*=A,I[B+2]*=A},x=(I,B,P)=>{for(let D=0;D<3;++D)I[D]=B[P+D]},S=p.length/3,v=f.length/3,b=new Float32Array(f.length),w=[0,0,0],T=[0,0,0],E=[0,0,0],C=[0,0,0],M=[0,0,0],O=[0,0,0];for(let I=0;I<S;++I){const B=p[I*3+0]*3,P=p[I*3+1]*3,D=p[I*3+2]*3;x(w,f,B),x(T,f,P),x(E,f,D),_(C,T,w),_(M,E,w),m(O,C,M),g(O,0);for(let R=0;R<3;++R)b[B+R]+=O[R],b[P+R]+=O[R],b[D+R]+=O[R]}for(let I=0;I<v;++I)g(b,I*3);return new Uint8Array(b.buffer)},c=f=>{const p={},_=new t.DecoderBuffer;_.Init(f,f.length);const m=new t.Decoder;if(m.GetEncodedGeometryType(_)!==t.TRIANGULAR_MESH)return p.error="Failed to decode draco mesh: not a mesh",p;const g=new t.Mesh,x=m.DecodeBufferToMesh(_,g);if(!x||!x.ok()||g.ptr===0)return p.error="Failed to decode draco asset",p;const S=g.num_faces()*3,v=g.num_points()<=65535,b=S*(v?2:4),w=t._malloc(b);v?(m.GetTrianglesUInt16Array(g,b,w),p.indices=new Uint16Array(t.HEAPU16.buffer,w,S).slice().buffer):(m.GetTrianglesUInt32Array(g,b,w),p.indices=new Uint32Array(t.HEAPU32.buffer,w,S).slice().buffer),t._free(w);const T=[];for(let B=0;B<g.num_attributes();++B)T.push(m.GetAttribute(g,B));T.sort((B,P)=>{var D,R;return((D=l[B.attribute_type()])!=null?D:l.length)-((R=l[P.attribute_type()])!=null?R:l.length)}),p.attributes=T.map(B=>B.unique_id());let E=0;const C=T.map(B=>{const P=E;return E+=Math.ceil(a(B)/4)*4,P}),M=T.some(B=>B.attribute_type()===1),O=C[1];if(!M){for(let B=1;B<C.length;++B)C[B]+=12;E+=12}p.vertices=new ArrayBuffer(g.num_points()*E);const I=new Uint8Array(p.vertices);for(let B=0;B<g.num_attributes();++B){const P=T[B],D=a(P),R=g.num_points()*D,A=t._malloc(R);m.GetAttributeDataArrayForAllPoints(g,P,P.data_type(),R,A);const L=new Uint8Array(t.HEAPU8.buffer,A,R);for(let F=0;F<g.num_points();++F)for(let N=0;N<D;++N)I[F*E+C[B]+N]=L[F*D+N];if(!M&&P.attribute_type()===0){const F=h(n(L,P.data_type()),v?new Uint16Array(p.indices):new Uint32Array(p.indices));for(let N=0;N<g.num_points();++N)for(let V=0;V<12;++V)I[N*E+O+V]=F[N*12+V]}t._free(A)}return t.destroy(g),t.destroy(m),t.destroy(_),p},d=f=>{const p=c(new Uint8Array(f.buffer));self.postMessage({jobId:f.jobId,error:p.error,indices:p.indices,vertices:p.vertices,attributes:p.attributes},[p.indices,p.vertices].filter(_=>_!=null))},u=[];self.onmessage=f=>{const p=f.data;switch(p.type){case"init":self.DracoDecoderModule({instantiateWasm:(_,m)=>(WebAssembly.instantiate(p.module,_).then(g=>m(g)).catch(g=>console.error("instantiate failed + "+g)),{})}).then(_=>{t=_,u.forEach(m=>d(m))});break;case"decodeMesh":t?d(p):u.push(p);break}}}const VT=3;class O3{constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(e,t)=>{e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer])}}init(e){for(e.forEach(t=>{t.addEventListener("message",s=>{const i=s.data,n=this.jobCallbacks.get(i.jobId);if(n&&n(i.error,{indices:i.indices,vertices:i.vertices,attributes:i.attributes}),this.jobCallbacks.delete(i.jobId),this.jobQueue.length>0){const r=this.jobQueue.shift();this.run(t,r)}else{const r=this.workers[2].indexOf(t);if(r!==-1)this.workers[2].splice(r,1),this.workers[1].push(t);else{const a=this.workers[1].indexOf(t);a!==-1&&(this.workers[1].splice(a,1),this.workers[0].push(t))}}})}),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){const t=this.jobQueue.shift();if(this.workers[0].length>0){const s=this.workers[0].shift();this.workers[1].push(s),this.run(s,t)}else{const s=this.workers[1].shift();this.workers[2].push(s),this.run(s,t)}}}enqueueJob(e,t){const s={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(s.jobId,t),this.workers[0].length>0){const i=this.workers[0].shift();this.workers[1].push(i),this.run(i,s)}else if(this.workers[1].length>0){const i=this.workers[1].shift();this.workers[2].push(i),this.run(i,s)}else this.jobQueue.push(s)}}const B3=o=>new Promise((e,t)=>{const s={cache:!0,responseType:"text",retry:VT>0,maxRetries:VT};He.get(o,s,(i,n)=>{i?t(i):e(n)})}),N3=o=>{const e=()=>fetch(o).then(s=>s.arrayBuffer()).then(s=>WebAssembly.compile(s)),t=()=>WebAssembly.compileStreaming(fetch(o)).catch(s=>e());return WebAssembly.compileStreaming?t():e()},GT=1;let mf,Eg;const WT=o=>{if(mf)return!0;if(!o)if(Eg)o=Eg;else{const e=za.getConfig("DracoDecoderModule");e?o={jsUrl:e.glueUrl,wasmUrl:e.wasmUrl,numWorkers:e.numWorkers}:o={jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:GT}}return!o.jsUrl||!o.wasmUrl?!1:(mf=new O3,Promise.all([B3(o.jsUrl),N3(o.wasmUrl)]).then(([e,t])=>{const s=["/* draco */",e,"/* worker */",`(
${F3.toString()}
)()

`].join(`
`),i=new Blob([s],{type:"application/javascript"}),n=URL.createObjectURL(i),r=Math.max(1,Math.min(16,o.numWorkers||GT)),a=[];for(let l=0;l<r;++l){const h=new Worker(n);h.postMessage({type:"init",module:t}),a.push(h)}mf.init(a)}),!0)},Ag=o=>{o!=null&&o.lazyInit?Eg=o:WT(o)},k3=(o,e)=>WT()?(mf.enqueueJob(o,e),!0):!1;class U3{constructor(){this.gltf=void 0,this.nodes=void 0,this.scenes=void 0,this.animations=void 0,this.textures=void 0,this.materials=void 0,this.variants=void 0,this.meshVariants=void 0,this.meshDefaultMaterials=void 0,this.renders=void 0,this.skins=void 0,this.lights=void 0,this.cameras=void 0}destroy(){this.renders&&this.renders.forEach(e=>{e.meshes=null})}}const HT=o=>/^data:.*,.*$/i.test(o),z3=o=>o.substring(o.indexOf(":")+1,o.indexOf(";")),Lc=o=>{switch(o){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},_f=o=>{switch(o){case 5120:return si;case 5121:return Zt;case 5122:return ii;case 5123:return Ms;case 5124:return xe;case 5125:return tt;case 5126:return le;default:return 0}},V3=o=>{switch(o){case 5120:return 1;case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},G3=o=>{switch(o){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},gf={POSITION:We,NORMAL:Dt,TANGENT:ei,COLOR_0:_t,JOINTS_0:Kt,WEIGHTS_0:ti,TEXCOORD_0:Lt,TEXCOORD_1:Ri,TEXCOORD_2:to,TEXCOORD_3:so,TEXCOORD_4:io,TEXCOORD_5:no,TEXCOORD_6:ro,TEXCOORD_7:ao},XT={[We]:0,[Dt]:1,[ei]:2,[_t]:3,[Kt]:4,[ti]:5,[Lt]:6,[Ri]:7,[to]:8,[so]:9,[io]:10,[no]:11,[ro]:12,[ao]:13},W3=o=>{switch(o){case si:return e=>Math.max(e/127,-1);case Zt:return e=>e/255;case ii:return e=>Math.max(e/32767,-1);case Ms:return e=>e/65535;default:return e=>e}},Cg=(o,e,t)=>{const s=W3(t),i=e.length;for(let n=0;n<i;++n)o[n]=s(e[n]);return o},La=(o,e,t=!1)=>{const s=Lc(o.type),i=G3(o.componentType);if(!i)return null;let n;if(o.sparse){const r=o.sparse,a={count:r.count,type:"SCALAR"},l=La(Object.assign(a,r.indices),e,!0),h={count:r.count,type:o.type,componentType:o.componentType},c=La(Object.assign(h,r.values),e,!0);if(o.hasOwnProperty("bufferView")){const d={bufferView:o.bufferView,byteOffset:o.byteOffset,componentType:o.componentType,count:o.count,type:o.type};n=La(d,e,!0).slice()}else n=new i(o.count*s);for(let d=0;d<r.count;++d){const u=l[d];for(let f=0;f<s;++f)n[u*s+f]=c[d*s+f]}}else if(o.hasOwnProperty("bufferView")){const r=e[o.bufferView];if(t&&r.hasOwnProperty("byteStride")){const a=s*i.BYTES_PER_ELEMENT,l=new ArrayBuffer(o.count*a),h=new Uint8Array(l);let c=0;for(let d=0;d<o.count;++d){let u=(o.byteOffset||0)+d*r.byteStride;for(let f=0;f<a;++f)h[c++]=r[u++]}n=new i(l)}else n=new i(r.buffer,r.byteOffset+(o.byteOffset||0),o.count*s)}else n=new i(o.count*s);return n},Mg=(o,e)=>{const t=La(o,e,!0);if(t instanceof Float32Array||!o.normalized)return t;const s=new Float32Array(t.length);return Cg(s,t,_f(o.componentType)),s},Pg=o=>{let e=o.min,t=o.max;if(!e||!t)return null;if(o.normalized){const s=_f(o.componentType);e=Cg([],e,s),t=Cg([],t,s)}return new ye(new y((t[0]+e[0])*.5,(t[1]+e[1])*.5,(t[2]+e[2])*.5),new y((t[0]-e[0])*.5,(t[1]-e[1])*.5,(t[2]-e[2])*.5))},$T=o=>{if(!o.hasOwnProperty("mode"))return Js;switch(o.mode){case 0:return Lr;case 1:return eo;case 2:return rd;case 3:return ad;case 4:return Js;case 5:return As;case 6:return Xi;default:return Js}},H3=o=>{const e=new Uint16Array(o);for(let t=0;t<o;t++)e[t]=t;return e},X3=(o,e)=>{const t=o[We];if(!t||t.components!==3)return;let s;if(t.size!==t.stride){const a=t.stride/To[t.type],l=new Yr[t.type](t.buffer,t.offset,t.count*a);s=new Yr[t.type](t.count*3);for(let h=0;h<t.count;++h)s[h*3+0]=l[h*a+0],s[h*3+1]=l[h*a+1],s[h*3+2]=l[h*a+2]}else s=new Yr[t.type](t.buffer,t.offset,t.count*3);const i=t.count;e||(e=H3(i));const n=rx(s,e),r=new Float32Array(n.length);r.set(n),o[Dt]={buffer:r.buffer,size:12,offset:0,stride:12,count:i,components:3,type:le}},$3=o=>{let e,t;const s=[],i=[],n=[];for(e=0;e<o.format.elements.length;++e){const a=o.format.elements[e];if(a.name===Lt||a.name===Ri)switch(a.dataType){case le:s.push({offset:a.offset/4+1,stride:a.stride/4});break;case Ms:i.push({offset:a.offset/2+1,stride:a.stride/2});break;case Zt:n.push({offset:a.offset+1,stride:a.stride});break}}const r=(a,l,h)=>{const c=new l(o.storage);for(e=0;e<a.length;++e){let d=a[e].offset;const u=a[e].stride;for(t=0;t<o.numVertices;++t)c[d]=h-c[d],d+=u}};s.length>0&&r(s,Float32Array,1),i.length>0&&r(i,Uint16Array,65535),n.length>0&&r(n,Uint8Array,255)},q3=o=>{const e=s=>{const i=[];for(let n=0;n<s._levels.length;++n){let r=[];if(s.cubemap)for(let a=0;a<6;++a)r.push(s._levels[n][a]);else r=s._levels[n];i.push(r)}return i},t=new re(o.device,o);return t._levels=e(o),t},j3=o=>{const e=new se(o.name+"_clone",o.type,o.file,o.data,o.options);return e.loaded=!0,e.resource=q3(o.resource),o.registry.add(e),e},Y3=(o,e,t)=>{const s=e[We];if(!s)return null;const i=s.count,n=[];for(const x in e)if(e.hasOwnProperty(x)){const S={semantic:x,components:e[x].components,type:e[x].type,normalize:!!e[x].normalize};Tt.isElementValid(o,S)||S.components++,n.push(S)}n.sort((x,S)=>XT[x.semantic]-XT[S.semantic]);let r,a,l,h,c,d;const u=new Tt(o,n);let f=!0;for(r=0;r<u.elements.length;++r)if(c=u.elements[r],h=e[c.name],d=h.offset-s.offset,h.buffer!==s.buffer||h.stride!==c.stride||h.size!==c.size||d!==c.offset){f=!1;break}const p=new es(o,u,i,St),_=p.lock(),m=new Uint32Array(_);let g;if(f)g=new Uint32Array(s.buffer,s.offset,i*p.format.size/4),m.set(g);else{let x,S;for(r=0;r<p.format.elements.length;++r){c=p.format.elements[r],x=c.stride/4,h=e[c.name],S=h.stride/4,g=new Uint32Array(h.buffer,h.offset,(h.count-1)*S+(h.size+3)/4);let v=0,b=c.offset/4;const w=Math.floor((h.size+3)/4);for(a=0;a<i;++a){for(l=0;l<w;++l)m[b+l]=g[v+l];v+=S,b+=x}}}return t&&$3(p),p.unlock(),p},K3=(o,e,t,s,i,n,r)=>{const a={},l=[];for(const d in e)e.hasOwnProperty(d)&&gf.hasOwnProperty(d)&&(a[d]=e[d],l.push(d+":"+e[d]));l.sort();const h=l.join();let c=r[h];if(!c){const d={};for(const u in a){const f=s[e[u]],p=La(f,i),_=i[f.bufferView],m=gf[u],g=Lc(f.type)*V3(f.componentType),x=_&&_.hasOwnProperty("byteStride")?_.byteStride:g;d[m]={buffer:p.buffer,size:g,offset:p.byteOffset,stride:x,count:f.count,components:Lc(f.type),type:_f(f.componentType),normalize:f.normalized}}d.hasOwnProperty(Dt)||X3(d,t),c=Y3(o,d,n),r[h]=c}return c},Z3=(o,e,t,s,i,n)=>{let r,a,l;const h=e.joints,c=h.length,d=[];if(e.hasOwnProperty("inverseBindMatrices")){const _=e.inverseBindMatrices,m=La(t[_],s,!0),g=[];for(r=0;r<c;r++){for(a=0;a<16;a++)g[a]=m[r*16+a];l=new W,l.set(g),d.push(l)}}else for(r=0;r<c;r++)l=new W,d.push(l);const u=[];for(r=0;r<c;r++)u[r]=i[h[r]].name;const f=u.join("#");let p=n.get(f);return p||(p=new Eu(o,d,u),n.set(f,p)),p},Q3=(o,e,t,s,i,n,r)=>{var a;const l=new Ut(o);l.aabb=Pg(t[e.attributes.POSITION]);const h=[];for(const[d,u]of Object.entries(e.attributes)){var c;const f=t[u],p=gf[d],_=_f(f.componentType);h.push({semantic:p,components:Lc(f.type),type:_,normalize:(c=f.normalized)!=null?c:p===_t&&(_===Zt||_===Ms)})}if(r.push(new Promise((d,u)=>{const f=e.extensions.KHR_draco_mesh_compression;k3(s[f.bufferView].slice().buffer,(p,_)=>{if(p)console.log(p),u(p);else{var m;const g={};for(const[E,C]of Object.entries(f.attributes))g[gf[E]]=_.attributes.indexOf(C);h.sort((E,C)=>g[E.semantic]-g[C.semantic]),(m=e.attributes)!=null&&m.NORMAL||h.splice(1,0,{semantic:"NORMAL",components:3,type:le});const x=new Tt(o,h),S=_.vertices.byteLength/x.size,v=S<=65535?Yt:Mi,b=_.indices.byteLength/(S<=65535?2:4),w=new es(o,x,S,St,_.vertices),T=new Di(o,v,b,St,_.indices);l.vertexBuffer=w,l.indexBuffer[0]=T,l.primitive[0].type=$T(e),l.primitive[0].base=0,l.primitive[0].count=T?b:S,l.primitive[0].indexed=!!T,d()}})})),e!=null&&(a=e.extensions)!=null&&a.KHR_materials_variants){const d=e.extensions.KHR_materials_variants,u={};d.mappings.forEach(f=>{f.variants.forEach(p=>{u[p]=f.material})}),i[l.id]=u}return n[l.id]=e.material,l},J3=(o,e,t,s,i,n,r,a,l,h)=>{const c=[];return e.primitives.forEach(d=>{var u;if((u=d.extensions)!=null&&u.KHR_draco_mesh_compression)c.push(Q3(o,d,t,s,r,a,h));else{let f=d.hasOwnProperty("indices")?La(t[d.indices],s,!0):null;const p=K3(o,d.attributes,f,t,s,i,n),_=$T(d),m=new Ut(o);if(m.vertexBuffer=p,m.primitive[0].type=_,m.primitive[0].base=0,m.primitive[0].indexed=f!==null,f!==null){let x;f instanceof Uint8Array?x=kl:f instanceof Uint16Array?x=Yt:x=Mi,x===Mi&&!o.extUintElement&&(x=Yt,f=new Uint16Array(f)),x===kl&&o.isWebGPU&&(x=Yt,f=new Uint16Array(f));const S=new Di(o,x,f.length,St,f);m.indexBuffer[0]=S,m.primitive[0].count=f.length}else m.primitive[0].count=p.numVertices;if(d.hasOwnProperty("extensions")&&d.extensions.hasOwnProperty("KHR_materials_variants")){const x=d.extensions.KHR_materials_variants,S={};x.mappings.forEach(v=>{v.variants.forEach(b=>{S[b]=v.material})}),r[m.id]=S}a[m.id]=d.material;let g=t[d.attributes.POSITION];if(m.aabb=Pg(g),d.hasOwnProperty("targets")){const x=[];d.targets.forEach((S,v)=>{const b={};S.hasOwnProperty("POSITION")&&(g=t[S.POSITION],b.deltaPositions=Mg(g,s),b.deltaPositionsType=le,b.aabb=Pg(g)),S.hasOwnProperty("NORMAL")&&(g=t[S.NORMAL],b.deltaNormals=Mg(g,s),b.deltaNormalsType=le),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?b.name=e.extras.targetNames[v]:b.name=v.toString(10),e.hasOwnProperty("weights")&&(b.defaultWeight=e.weights[v]),b.preserveData=l.morphPreserveData,x.push(new rc(b))}),m.morph=new gu(x,o,{preferHighPrecision:l.morphPreferHighPrecision})}c.push(m)}}),c},xt=(o,e,t)=>{var s;let i;const n=o.texCoord;if(n)for(i=0;i<t.length;++i)e[t[i]+"MapUv"]=n;const r=[0,0],a=[1,1],l=(s=o.extensions)==null?void 0:s.KHR_texture_transform;if(l){const h=l.offset||r,c=l.scale||a,d=l.rotation?-l.rotation*U.RAD_TO_DEG:0,u=new G(c[0],c[1]),f=new G(h[0],1-c[1]-h[1]);for(i=0;i<t.length;++i)e[`${t[i]}MapTiling`]=u,e[`${t[i]}MapOffset`]=f,e[`${t[i]}MapRotation`]=d}},ek=(o,e,t)=>{let s,i;if(o.hasOwnProperty("diffuseFactor")?(s=o.diffuseFactor,e.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),e.opacity=s[3]):(e.diffuse.set(1,1,1),e.opacity=1),o.hasOwnProperty("diffuseTexture")){const n=o.diffuseTexture;i=t[n.index],e.diffuseMap=i,e.diffuseMapChannel="rgb",e.opacityMap=i,e.opacityMapChannel="a",xt(n,e,["diffuse","opacity"])}if(e.useMetalness=!1,o.hasOwnProperty("specularFactor")?(s=o.specularFactor,e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))):e.specular.set(1,1,1),o.hasOwnProperty("glossinessFactor")?e.gloss=o.glossinessFactor:e.gloss=1,o.hasOwnProperty("specularGlossinessTexture")){const n=o.specularGlossinessTexture;e.specularEncoding="srgb",e.specularMap=e.glossMap=t[n.index],e.specularMapChannel="rgb",e.glossMapChannel="a",xt(n,e,["gloss","metalness"])}},tk=(o,e,t)=>{if(o.hasOwnProperty("clearcoatFactor")?e.clearCoat=o.clearcoatFactor*.25:e.clearCoat=0,o.hasOwnProperty("clearcoatTexture")){const s=o.clearcoatTexture;e.clearCoatMap=t[s.index],e.clearCoatMapChannel="r",xt(s,e,["clearCoat"])}if(o.hasOwnProperty("clearcoatRoughnessFactor")?e.clearCoatGloss=o.clearcoatRoughnessFactor:e.clearCoatGloss=0,o.hasOwnProperty("clearcoatRoughnessTexture")){const s=o.clearcoatRoughnessTexture;e.clearCoatGlossMap=t[s.index],e.clearCoatGlossMapChannel="g",xt(s,e,["clearCoatGloss"])}if(o.hasOwnProperty("clearcoatNormalTexture")){const s=o.clearcoatNormalTexture;e.clearCoatNormalMap=t[s.index],xt(s,e,["clearCoatNormal"]),s.hasOwnProperty("scale")&&(e.clearCoatBumpiness=s.scale)}e.clearCoatGlossInvert=!0},sk=(o,e,t)=>{e.useLighting=!1,e.emissive.copy(e.diffuse),e.emissiveTint=e.diffuseTint,e.emissiveMap=e.diffuseMap,e.emissiveMapUv=e.diffuseMapUv,e.emissiveMapTiling.copy(e.diffuseMapTiling),e.emissiveMapOffset.copy(e.diffuseMapOffset),e.emissiveMapRotation=e.diffuseMapRotation,e.emissiveMapChannel=e.diffuseMapChannel,e.emissiveVertexColor=e.diffuseVertexColor,e.emissiveVertexColorChannel=e.diffuseVertexColorChannel,e.useLighting=!1,e.useSkybox=!1,e.diffuse.set(0,0,0),e.diffuseTint=!1,e.diffuseMap=null,e.diffuseVertexColor=!1},ik=(o,e,t)=>{if(e.useMetalnessSpecularColor=!0,o.hasOwnProperty("specularColorTexture")&&(e.specularEncoding="srgb",e.specularMap=t[o.specularColorTexture.index],e.specularMapChannel="rgb",xt(o.specularColorTexture,e,["specular"])),o.hasOwnProperty("specularColorFactor")){const s=o.specularColorFactor;e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.specular.set(1,1,1);o.hasOwnProperty("specularFactor")?e.specularityFactor=o.specularFactor:e.specularityFactor=1,o.hasOwnProperty("specularTexture")&&(e.specularityFactorMapChannel="a",e.specularityFactorMap=t[o.specularTexture.index],xt(o.specularTexture,e,["specularityFactor"]))},nk=(o,e,t)=>{o.hasOwnProperty("ior")&&(e.refractionIndex=1/o.ior)},rk=(o,e,t)=>{e.blendType=Bt,e.useDynamicRefraction=!0,o.hasOwnProperty("transmissionFactor")&&(e.refraction=o.transmissionFactor),o.hasOwnProperty("transmissionTexture")&&(e.refractionMapChannel="r",e.refractionMap=t[o.transmissionTexture.index],xt(o.transmissionTexture,e,["refraction"]))},ak=(o,e,t)=>{if(e.useSheen=!0,o.hasOwnProperty("sheenColorFactor")){const s=o.sheenColorFactor;e.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.sheen.set(1,1,1);o.hasOwnProperty("sheenColorTexture")&&(e.sheenMap=t[o.sheenColorTexture.index],e.sheenEncoding="srgb",xt(o.sheenColorTexture,e,["sheen"])),o.hasOwnProperty("sheenRoughnessFactor")?e.sheenGloss=o.sheenRoughnessFactor:e.sheenGloss=0,o.hasOwnProperty("sheenRoughnessTexture")&&(e.sheenGlossMap=t[o.sheenRoughnessTexture.index],e.sheenGlossMapChannel="a",xt(o.sheenRoughnessTexture,e,["sheenGloss"])),e.sheenGlossInvert=!0},ok=(o,e,t)=>{if(e.blendType=Bt,e.useDynamicRefraction=!0,o.hasOwnProperty("thicknessFactor")&&(e.thickness=o.thicknessFactor),o.hasOwnProperty("thicknessTexture")&&(e.thicknessMap=t[o.thicknessTexture.index],e.thicknessMapChannel="g",xt(o.thicknessTexture,e,["thickness"])),o.hasOwnProperty("attenuationDistance")&&(e.attenuationDistance=o.attenuationDistance),o.hasOwnProperty("attenuationColor")){const s=o.attenuationColor;e.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}},lk=(o,e,t)=>{o.hasOwnProperty("emissiveStrength")&&(e.emissiveIntensity=o.emissiveStrength)},hk=(o,e,t)=>{e.useIridescence=!0,o.hasOwnProperty("iridescenceFactor")&&(e.iridescence=o.iridescenceFactor),o.hasOwnProperty("iridescenceTexture")&&(e.iridescenceMapChannel="r",e.iridescenceMap=t[o.iridescenceTexture.index],xt(o.iridescenceTexture,e,["iridescence"])),o.hasOwnProperty("iridescenceIor")&&(e.iridescenceRefractionIndex=o.iridescenceIor),o.hasOwnProperty("iridescenceThicknessMinimum")&&(e.iridescenceThicknessMin=o.iridescenceThicknessMinimum),o.hasOwnProperty("iridescenceThicknessMaximum")&&(e.iridescenceThicknessMax=o.iridescenceThicknessMaximum),o.hasOwnProperty("iridescenceThicknessTexture")&&(e.iridescenceThicknessMapChannel="g",e.iridescenceThicknessMap=t[o.iridescenceThicknessTexture.index],xt(o.iridescenceThicknessTexture,e,["iridescenceThickness"]))},qT=(o,e,t)=>{const s=new Ct;s.occludeSpecular=Jr,s.diffuseTint=!0,s.diffuseVertexColor=!0,s.specularTint=!0,s.specularVertexColor=!0,o.hasOwnProperty("name")&&(s.name=o.name);let i,n;if(o.hasOwnProperty("pbrMetallicRoughness")){const a=o.pbrMetallicRoughness;if(a.hasOwnProperty("baseColorFactor")?(i=a.baseColorFactor,s.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),s.opacity=i[3]):(s.diffuse.set(1,1,1),s.opacity=1),a.hasOwnProperty("baseColorTexture")){const l=a.baseColorTexture;n=e[l.index],s.diffuseMap=n,s.diffuseMapChannel="rgb",s.opacityMap=n,s.opacityMapChannel="a",xt(l,s,["diffuse","opacity"])}if(s.useMetalness=!0,s.specular.set(1,1,1),a.hasOwnProperty("metallicFactor")?s.metalness=a.metallicFactor:s.metalness=1,a.hasOwnProperty("roughnessFactor")?s.gloss=a.roughnessFactor:s.gloss=1,s.glossInvert=!0,a.hasOwnProperty("metallicRoughnessTexture")){const l=a.metallicRoughnessTexture;s.metalnessMap=s.glossMap=e[l.index],s.metalnessMapChannel="b",s.glossMapChannel="g",xt(l,s,["gloss","metalness"])}}if(o.hasOwnProperty("normalTexture")){const a=o.normalTexture;s.normalMap=e[a.index],xt(a,s,["normal"]),a.hasOwnProperty("scale")&&(s.bumpiness=a.scale)}if(o.hasOwnProperty("occlusionTexture")){const a=o.occlusionTexture;s.aoMap=e[a.index],s.aoMapChannel="r",xt(a,s,["ao"])}if(o.hasOwnProperty("emissiveFactor")?(i=o.emissiveFactor,s.emissive.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),s.emissiveTint=!0):(s.emissive.set(0,0,0),s.emissiveTint=!1),o.hasOwnProperty("emissiveTexture")){const a=o.emissiveTexture;s.emissiveMap=e[a.index],xt(a,s,["emissive"])}if(o.hasOwnProperty("alphaMode"))switch(o.alphaMode){case"MASK":s.blendType=Nt,o.hasOwnProperty("alphaCutoff")?s.alphaTest=o.alphaCutoff:s.alphaTest=.5;break;case"BLEND":s.blendType=Bt,s.depthWrite=!1;break;default:case"OPAQUE":s.blendType=Nt;break}else s.blendType=Nt;o.hasOwnProperty("doubleSided")?(s.twoSidedLighting=o.doubleSided,s.cull=o.doubleSided?Je:Ai):(s.twoSidedLighting=!1,s.cull=Ai);const r={KHR_materials_clearcoat:tk,KHR_materials_emissive_strength:lk,KHR_materials_ior:nk,KHR_materials_iridescence:hk,KHR_materials_pbrSpecularGlossiness:ek,KHR_materials_sheen:ak,KHR_materials_specular:ik,KHR_materials_transmission:rk,KHR_materials_unlit:sk,KHR_materials_volume:ok};if(o.hasOwnProperty("extensions"))for(const a in o.extensions){const l=r[a];l!==void 0&&l(o.extensions[a],s,e)}return s.update(),s},ck=(o,e,t,s,i,n,r)=>{const a=E=>new Dc(Lc(E.type),Mg(E,s)),l={STEP:x_,LINEAR:Uu,CUBICSPLINE:zu},h={},c={},d={};let u=1,f;for(f=0;f<o.samplers.length;++f){const E=o.samplers[f];h.hasOwnProperty(E.input)||(h[E.input]=a(t[E.input])),c.hasOwnProperty(E.output)||(c[E.output]=a(t[E.output]));const C=E.hasOwnProperty("interpolation")&&l.hasOwnProperty(E.interpolation)?l[E.interpolation]:Uu,M={paths:[],input:E.input,output:E.output,interpolation:C};d[f]=M}const p=[],_={translation:"localPosition",rotation:"localRotation",scale:"localScale"},m=E=>{const C=[];for(;E;)C.unshift(E.name),E=E.parent;return C},g=(E,C,M)=>{const O=c[E.output];if(!O)return;let I;if(n&&n[C.mesh]){const F=n[C.mesh];F.hasOwnProperty("extras")&&F.extras.hasOwnProperty("targetNames")&&(I=F.extras.targetNames)}const B=O.data,P=B.length/h[E.input].data.length,D=B.length/P,R=D*4,A=new ArrayBuffer(R*P);for(let F=0;F<P;F++){var L;const N=new Float32Array(A,R*F,D);for(let j=0;j<D;j++)N[j]=B[j*P+F];const V=new Dc(1,N),k=(L=I)!=null&&L[F]?`name.${I[F]}`:F;c[-u]=V;const $={paths:[{entityPath:M,component:"graph",propertyPath:[`weight.${k}`]}],input:E.input,output:-u,interpolation:E.interpolation};u++,d[`morphCurve-${f}-${F}`]=$}};for(f=0;f<o.channels.length;++f){const E=o.channels[f],C=E.target,M=d[E.sampler],O=i[C.node],I=r[C.node],B=m(O);C.path.startsWith("weights")?(g(M,I,B),d[E.sampler].morphCurve=!0):M.paths.push({entityPath:B,component:"graph",propertyPath:[_[C.path]]})}const x=[],S=[],v=[];for(const E in h)x.push(h[E]),h[E]=x.length-1;for(const E in c)S.push(c[E]),c[E]=S.length-1;for(const E in d){const C=d[E];C.morphCurve||(v.push(new wg(C.paths,h[C.input],c[C.output],C.interpolation)),C.paths.length>0&&C.paths[0].propertyPath[0]==="localRotation"&&C.interpolation!==zu&&p.push(v[v.length-1].output))}p.sort();let b=null,w;for(f=0;f<p.length;++f){const E=p[f];if(f===0||E!==b){if(w=S[E],w.components===4){const C=w.data,M=C.length-4;for(let O=0;O<M;O+=4)C[O+0]*C[O+4]+C[O+1]*C[O+5]+C[O+2]*C[O+6]+C[O+3]*C[O+7]<0&&(C[O+4]*=-1,C[O+5]*=-1,C[O+6]*=-1,C[O+7]*=-1)}b=E}}let T=0;for(f=0;f<x.length;f++)w=x[f]._data,T=Math.max(T,w.length===0?0:w[w.length-1]);return new ki(o.hasOwnProperty("name")?o.name:"animation_"+e,T,x,S,v)},yf=new W,yl=new y,dk=(o,e)=>{const t=new we;if(o.hasOwnProperty("name")&&o.name.length>0?t.name=o.name:t.name="node_"+e,o.hasOwnProperty("matrix")&&(yf.data.set(o.matrix),yf.getTranslation(yl),t.setLocalPosition(yl),yf.getEulerAngles(yl),t.setLocalEulerAngles(yl),yf.getScale(yl),t.setLocalScale(yl)),o.hasOwnProperty("rotation")){const s=o.rotation;t.setLocalRotation(s[0],s[1],s[2],s[3])}if(o.hasOwnProperty("translation")){const s=o.translation;t.setLocalPosition(s[0],s[1],s[2])}if(o.hasOwnProperty("scale")){const s=o.scale;t.setLocalScale(s[0],s[1],s[2])}return t},uk=(o,e)=>{const t=o.type==="orthographic"?Yn:Os,s=t===Yn?o.orthographic:o.perspective,i={enabled:!1,projection:t,nearClip:s.znear,aspectRatioMode:jd};s.zfar&&(i.farClip=s.zfar),t===Yn?(i.orthoHeight=.5*s.ymag,s.ymag&&(i.aspectRatioMode=Yd,i.aspectRatio=s.xmag/s.ymag)):(i.fov=s.yfov*U.RAD_TO_DEG,s.aspectRatio&&(i.aspectRatioMode=Yd,i.aspectRatio=s.aspectRatio));const n=new Ce(o.name);return n.addComponent("camera",i),n},fk=(o,e)=>{const t={enabled:!1,type:o.type==="point"?"omni":o.type,color:o.hasOwnProperty("color")?new H(o.color):H.WHITE,range:o.hasOwnProperty("range")?o.range:9999,falloffMode:W0,intensity:o.hasOwnProperty("intensity")?U.clamp(o.intensity,0,2):1};o.hasOwnProperty("spot")&&(t.innerConeAngle=o.spot.hasOwnProperty("innerConeAngle")?o.spot.innerConeAngle*U.RAD_TO_DEG:0,t.outerConeAngle=o.spot.hasOwnProperty("outerConeAngle")?o.spot.outerConeAngle*U.RAD_TO_DEG:Math.PI/4),o.hasOwnProperty("intensity")&&(t.luminance=o.intensity*el.getLightUnitConversion(t_[t.type],t.outerConeAngle,t.innerConeAngle));const s=new Ce(e.name);return s.rotateLocal(90,0,0),s.addComponent("light",t),s},pk=(o,e,t,s)=>{if(!e.hasOwnProperty("skins")||e.skins.length===0)return[];const i=new Map;return e.skins.map(n=>Z3(o,n,e.accessors,s,t,i))},mk=(o,e,t,s,i)=>{var n,r,a;const l={},h={},c={},d=[];return{meshes:!i.skipMeshes&&(e==null||(n=e.meshes)==null?void 0:n.length)&&(e==null||(r=e.accessors)==null?void 0:r.length)&&(e==null||(a=e.bufferViews)==null?void 0:a.length)?e.meshes.map(p=>J3(o,p,e.accessors,t,s,l,h,c,i,d)):[],meshVariants:h,meshDefaultMaterials:c,promises:d}},_k=(o,e,t,s)=>{var i,n,r,a;if(!o.hasOwnProperty("materials")||o.materials.length===0)return[];const l=t==null||(i=t.material)==null?void 0:i.preprocess,h=(n=t==null||(r=t.material)==null?void 0:r.process)!=null?n:qT,c=t==null||(a=t.material)==null?void 0:a.postprocess;return o.materials.map(d=>{l&&l(d);const u=h(d,e,s);return c&&c(d,u),u})},gk=o=>{if(!o.hasOwnProperty("extensions")||!o.extensions.hasOwnProperty("KHR_materials_variants"))return null;const e=o.extensions.KHR_materials_variants.variants,t={};for(let s=0;s<e.length;s++)t[e[s].name]=s;return t},yk=(o,e,t,s)=>{var i,n;if(!o.hasOwnProperty("animations")||o.animations.length===0)return[];const r=s==null||(i=s.animation)==null?void 0:i.preprocess,a=s==null||(n=s.animation)==null?void 0:n.postprocess;return o.animations.map((l,h)=>{r&&r(l);const c=ck(l,h,o.accessors,t,e,o.meshes,o.nodes);return a&&a(l,c),c})},vk=(o,e)=>{var t,s,i,n;if(!o.hasOwnProperty("nodes")||o.nodes.length===0)return[];const r=e==null||(t=e.node)==null?void 0:t.preprocess,a=(s=e==null||(i=e.node)==null?void 0:i.process)!=null?s:dk,l=e==null||(n=e.node)==null?void 0:n.postprocess,h=o.nodes.map((c,d)=>{r&&r(c);const u=a(c,d);return l&&l(c,u),u});for(let c=0;c<o.nodes.length;++c){const d=o.nodes[c];if(d.hasOwnProperty("children")){const u=h[c],f={};for(let p=0;p<d.children.length;++p){const _=h[d.children[p]];_.parent||(f.hasOwnProperty(_.name)?_.name+=f[_.name]++:f[_.name]=1,u.addChild(_))}}}return h},xk=(o,e)=>{var t;const s=[],i=o.scenes.length;if(i===1&&((t=o.scenes[0].nodes)==null?void 0:t.length)===1){const n=o.scenes[0].nodes[0];s.push(e[n])}else for(let n=0;n<i;n++){const r=o.scenes[n];if(r.nodes){const a=new we(r.name);for(let l=0;l<r.nodes.length;l++){const h=e[r.nodes[l]];a.addChild(h)}s.push(a)}}return s},Sk=(o,e,t)=>{let s=null;if(o.hasOwnProperty("nodes")&&o.hasOwnProperty("cameras")&&o.cameras.length>0){var i,n,r,a;const l=t==null||(i=t.camera)==null?void 0:i.preprocess,h=(n=t==null||(r=t.camera)==null?void 0:r.process)!=null?n:uk,c=t==null||(a=t.camera)==null?void 0:a.postprocess;o.nodes.forEach((d,u)=>{if(d.hasOwnProperty("camera")){const f=o.cameras[d.camera];if(f){l&&l(f);const p=h(f,e[u]);c&&c(f,p),p&&(s||(s=new Map),s.set(d,p))}}})}return s},bk=(o,e,t)=>{let s=null;if(o.hasOwnProperty("nodes")&&o.hasOwnProperty("extensions")&&o.extensions.hasOwnProperty("KHR_lights_punctual")&&o.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const l=o.extensions.KHR_lights_punctual.lights;if(l.length){var i,n,r,a;const h=t==null||(i=t.light)==null?void 0:i.preprocess,c=(n=t==null||(r=t.light)==null?void 0:r.process)!=null?n:fk,d=t==null||(a=t.light)==null?void 0:a.postprocess;o.nodes.forEach((u,f)=>{if(u.hasOwnProperty("extensions")&&u.extensions.hasOwnProperty("KHR_lights_punctual")&&u.extensions.KHR_lights_punctual.hasOwnProperty("light")){const p=u.extensions.KHR_lights_punctual.light,_=l[p];if(_){h&&h(_);const m=c(_,e[f]);d&&d(_,m),m&&(s||(s=new Map),s.set(u,m))}}})}}return s},Tk=(o,e,t)=>{o.nodes.forEach(s=>{s.hasOwnProperty("mesh")&&s.hasOwnProperty("skin")&&e[s.mesh].meshes.forEach(n=>{n.skin=t[s.skin]})})},wk=async(o,e,t,s,i)=>{var n,r;const a=i==null||(n=i.global)==null?void 0:n.preprocess,l=i==null||(r=i.global)==null?void 0:r.postprocess;a&&a(e);const h=e.asset&&e.asset.generator==="PlayCanvas",c=vk(e,i),d=xk(e,c),u=bk(e,c,i),f=Sk(e,c,i),p=gk(e),_=await Promise.all(t),{meshes:m,meshVariants:g,meshDefaultMaterials:x,promises:S}=mk(o,e,_,h,i),v=yk(e,c,_,i),b=await Promise.all(s),w=b.map(O=>O.resource),T=_k(e,w,i,h),E=pk(o,e,c,_),C=[];for(let O=0;O<m.length;O++)C[O]=new Tg,C[O].meshes=m[O];Tk(e,C,E);const M=new U3;return M.gltf=e,M.nodes=c,M.scenes=d,M.animations=v,M.textures=b,M.materials=T,M.variants=p,M.meshVariants=g,M.meshDefaultMaterials=x,M.renders=C,M.skins=E,M.lights=u,M.cameras=f,l&&l(e,M),await Promise.all(S),M},Ek=(o,e)=>{const t=(n,r)=>{switch(n){case 9728:return de;case 9729:return Oe;case 9984:return Tr;case 9985:return Er;case 9986:return wr;case 9987:return Qs;default:return r}},s=(n,r)=>{switch(n){case 33071:return q;case 33648:return Ha;case 10497:return Qe;default:return r}};if(o){var i;e=(i=e)!=null?i:{},o.minFilter=t(e.minFilter,Qs),o.magFilter=t(e.magFilter,Oe),o.addressU=s(e.wrapS,Qe),o.addressV=s(e.wrapT,Qe)}};let Ak=0;const Ck=(o,e,t,s,i)=>{var n,r,a;if(!o.images||o.images.length===0)return[];const l=i==null||(n=i.image)==null?void 0:n.preprocess,h=i==null||(r=i.image)==null?void 0:r.processAsync,c=i==null||(a=i.image)==null?void 0:a.postprocess,d={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=(f,p,_,m,g)=>new Promise((x,S)=>{const v=b=>{const w=(f.name||"gltf-texture")+"-"+Ak++,T={url:p||w};if(b&&(T.contents=b.slice(0).buffer),m){const C=d[m];C&&(T.filename=T.url+"."+C)}const E=new se(w,"texture",T,null,g);E.on("load",C=>x(C)),E.on("error",C=>S(C)),s.add(E),s.load(E)};_?_.then(b=>v(b)):v(null)});return o.images.map((f,p)=>{l&&l(f);let _;return h?_=new Promise((m,g)=>{h(f,(x,S)=>{x?g(x):m(S)})}):_=new Promise(m=>{m(null)}),_=_.then(m=>m||(f.hasOwnProperty("uri")?HT(f.uri)?u(f,f.uri,null,z3(f.uri),null):u(f,ua.test(f.uri)?f.uri:ce.join(t,f.uri),null,null,{crossOrigin:"anonymous"}):f.hasOwnProperty("bufferView")&&f.hasOwnProperty("mimeType")?u(f,null,e[f.bufferView],f.mimeType,null):Promise.reject(new Error(`Invalid image found in gltf (neither uri or bufferView found). index=${p}`)))),c&&(_=_.then(m=>(c(f,m),m))),_})},Mk=(o,e,t)=>{var s,i,n,r,a;if(!(o!=null&&(s=o.images)!=null&&s.length)||!(o!=null&&(i=o.textures)!=null&&i.length))return[];const l=t==null||(n=t.texture)==null?void 0:n.preprocess,h=t==null||(r=t.texture)==null?void 0:r.processAsync,c=t==null||(a=t.texture)==null?void 0:a.postprocess,d=new Set;return o.textures.map(u=>{l&&l(u);let f;return h?f=new Promise((p,_)=>{h(u,o.images,(m,g)=>{m?_(m):p(g)})}):f=new Promise(p=>{p(null)}),f=f.then(p=>{var _,m,g,x,S;p=(_=(m=(g=p)!=null?g:u==null||(x=u.extensions)==null||(x=x.KHR_texture_basisu)==null?void 0:x.source)!=null?m:u==null||(S=u.extensions)==null||(S=S.EXT_texture_webp)==null?void 0:S.source)!=null?_:u.source;const v=d.has(p);return d.add(p),e[p].then(b=>{var w;const T=v?j3(b):b;return Ek(T.resource,((w=o.samplers)!=null?w:[])[u.sampler]),T})}),c&&(f=f.then(p=>(c(u,p),p))),f})},Pk=(o,e,t,s)=>{var i,n,r;if(!o.buffers||o.buffers.length===0)return[];const a=s==null||(i=s.buffer)==null?void 0:i.preprocess,l=s==null||(n=s.buffer)==null?void 0:n.processAsync,h=s==null||(r=s.buffer)==null?void 0:r.postprocess;return o.buffers.map((c,d)=>{a&&a(c);let u;return l?u=new Promise((f,p)=>{l(c,(_,m)=>{_?p(_):f(m)})}):u=new Promise(f=>{f(null)}),u=u.then(f=>{if(f)return f;if(c.hasOwnProperty("uri")){if(HT(c.uri)){const p=atob(c.uri.split(",")[1]),_=new Uint8Array(p.length);for(let m=0;m<p.length;m++)_[m]=p.charCodeAt(m);return _}return new Promise((p,_)=>{He.get(ua.test(c.uri)?c.uri:ce.join(t,c.uri),{cache:!0,responseType:"arraybuffer",retry:!1},(m,g)=>{m?_(m):p(new Uint8Array(g))})})}return e}),h&&(u=u.then(f=>(h(o.buffers[d],f),f))),u})},Rk=(o,e)=>{const s=JSON.parse((i=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(i);let n="";for(let r=0;r<i.length;r++)n+=String.fromCharCode(i[r]);return decodeURIComponent(escape(n))})(o));if(s.asset&&s.asset.version&&parseFloat(s.asset.version)<2){e(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`);return}e(null,s)},Ik=(o,e)=>{const t=o instanceof ArrayBuffer?new DataView(o):new DataView(o.buffer,o.byteOffset,o.byteLength),s=t.getUint32(0,!0),i=t.getUint32(4,!0),n=t.getUint32(8,!0);if(s!==1179937895){e("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+s.toString(16));return}if(i!==2){e("Invalid version number found in glb header. Expected 2, found "+i);return}if(n<=0||n>t.byteLength){e("Invalid length found in glb header. Found "+n);return}const r=[];let a=12;for(;a<n;){const l=t.getUint32(a,!0);a+l+8>t.byteLength&&e(`Invalid chunk length found in glb. Found ${l}`);const h=t.getUint32(a+4,!0),c=new Uint8Array(t.buffer,t.byteOffset+a+8,l);r.push({length:l,type:h,data:c}),a+=l+8}if(r.length!==1&&r.length!==2){e("Invalid number of chunks found in glb file.");return}if(r[0].type!==1313821514){e(`Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x${r[0].type.toString(16)}`);return}if(r.length>1&&r[1].type!==5130562){e(`Invalid chunk type found in glb file. Expected 0x004E4942, found 0x${r[1].type.toString(16)}`);return}e(null,{gltfChunk:r[0].data,binaryChunk:r.length===2?r[1].data:null})},Dk=(o,e,t)=>{const s=()=>{const i=new Uint8Array(e);return i[0]===103&&i[1]===108&&i[2]===84&&i[3]===70};o&&o.toLowerCase().endsWith(".glb")||s()?Ik(e,t):t(null,{gltfChunk:e,binaryChunk:null})},Lk=(o,e,t)=>{var s,i,n,r;const a=[],l=t==null||(s=t.bufferView)==null?void 0:s.preprocess,h=t==null||(i=t.bufferView)==null?void 0:i.processAsync,c=t==null||(n=t.bufferView)==null?void 0:n.postprocess;if(!((r=o.bufferViews)!=null&&r.length))return a;for(let d=0;d<o.bufferViews.length;++d){const u=o.bufferViews[d];l&&l(u);let f;h?f=new Promise((p,_)=>{h(u,e,(m,g)=>{m?_(m):p(g)})}):f=new Promise(p=>{p(null)}),f=f.then(p=>p||e[u.buffer].then(_=>new Uint8Array(_.buffer,_.byteOffset+(u.byteOffset||0),u.byteLength))),u.hasOwnProperty("byteStride")&&(f=f.then(p=>(p.byteStride=u.byteStride,p))),c&&(f=f.then(p=>(c(u,p),p))),a.push(f)}return a};class vf{static parse(e,t,s,i,n,r,a){Dk(e,s,(l,h)=>{if(l){a(l);return}Rk(h.gltfChunk,(c,d)=>{if(c){a(c);return}const u=Pk(d,h.binaryChunk,t,r),f=Lk(d,u,r),p=Ck(d,f,t,n,r),_=Mk(d,p,r);wk(i,d,f,_,r).then(m=>a(null,m)).catch(m=>a(m))})})}static createDefaultMaterial(){return qT({name:"defaultGlbMaterial"},[])}}class jT extends Le{constructor(e){super(e,"animation"),this.device=e.graphicsDevice,this.assets=e.assets}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});const i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(ce.getExtension(e.original).toLowerCase()===".glb"?i.responseType=fe.ResponseType.ARRAY_BUFFER:i.responseType=fe.ResponseType.JSON),He.get(e.load,i,(n,r)=>{if(n)t(`Error loading animation resource: ${e.original} [${n}]`);else if(ce.getExtension(e.original).toLowerCase()===".glb"){var a;vf.parse("filename.glb","",r,this.device,this.assets,(a=s==null?void 0:s.options)!=null?a:{},(l,h)=>{if(l)t(l);else{var c;const d=h.animations;if(s!=null&&(c=s.data)!=null&&c.events)for(let u=0;u<d.length;u++)d[u].events=new M_(Object.values(s.data.events));h.destroy(),t(null,d)}})}else t(null,this["_parseAnimationV"+r.animation.version](r))})}open(e,t,s){return t}_parseAnimationV3(e){const t=e.animation,s=new un;s.name=t.name,s.duration=t.duration;for(let i=0;i<t.nodes.length;i++){const n=new Cu,r=t.nodes[i];n._name=r.name;for(let a=0;a<r.keys.length;a++){const l=r.keys[a],h=l.time,c=l.pos,d=l.rot,u=l.scale,f=new y(c[0],c[1],c[2]),p=new Z().setFromEulerAngles(d[0],d[1],d[2]),_=new y(u[0],u[1],u[2]),m=new Au(h,f,p,_);n._keys.push(m)}s.addNode(n)}return s}_parseAnimationV4(e){const t=e.animation,s=new un;s.name=t.name,s.duration=t.duration;for(let i=0;i<t.nodes.length;i++){const n=new Cu,r=t.nodes[i];n._name=r.name;const a=r.defaults.p,l=r.defaults.r,h=r.defaults.s;for(let c=0;c<r.keys.length;c++){const d=r.keys[c],u=d.t,f=a||d.p,p=l||d.r,_=h||d.s,m=new y(f[0],f[1],f[2]),g=new Z().setFromEulerAngles(p[0],p[1],p[2]),x=new y(_[0],_[1],_[2]),S=new Au(u,m,g,x);n._keys.push(S)}s.addNode(n)}return s}}class YT extends Le{constructor(e){super(e,"animclip")}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=fe.ResponseType.JSON),He.get(e.load,s,function(i,n){i?t(`Error loading animation clip resource: ${e.original} [${i}]`):t(null,n)})}open(e,t){const s=t.name,i=t.duration,n=t.inputs.map(function(l){return new Dc(1,l)}),r=t.outputs.map(function(l){return new Dc(l.components,l.data)}),a=t.curves.map(function(l){return new wg([l.path],l.inputIndex,l.outputIndex,l.interpolation)});return new ki(s,i,n,r,a)}}class KT extends Le{constructor(e){super(e,"animstategraph")}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=fe.ResponseType.JSON),He.get(e.load,s,function(i,n){i?t(`Error loading animation state graph resource: ${e.original} [${i}]`):t(null,n)})}open(e,t){return new xc(t)}}const Rg=function(){if(typeof window>"u")return!1;const o=window.navigator.userAgent,e=o.indexOf("MSIE ");if(e>0)return parseInt(o.substring(e+5,o.indexOf(".",e)),10);if(o.indexOf("Trident/")>0){const s=o.indexOf("rv:");return parseInt(o.substring(s+3,o.indexOf(".",s)),10)}return!1}(),Fk=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"];class ZT extends Le{constructor(e){super(e,"audio"),this.manager=e.soundManager}_isSupported(e){const t=ce.getExtension(e);return Fk.indexOf(t)>-1}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s=function(r){t(null,new Zp(r))},i=function(r){let a="Error loading audio url: "+e.original;r&&(a+=": "+(r.message||r)),console.warn(a),t(a)};if(this._createSound){if(!this._isSupported(e.original)){i(`Audio format for ${e.original} not supported`);return}this._createSound(e.load,s,i)}else i(null)}_createSound(e,t,s){if(Ji()){const i=this.manager;if(!i.context){s("Audio manager has no audio context");return}const n={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.startsWith("blob:")||e.startsWith("data:"))&&(n.responseType=fe.ResponseType.ARRAY_BUFFER),He.get(e,n,function(r,a){if(r){s(r);return}i.context.decodeAudioData(a,t,s)})}else{let i=null;try{i=new Audio}catch{s("No support for Audio element");return}Rg&&document.body.appendChild(i);const n=function r(){i.removeEventListener("canplaythrough",r),Rg&&document.body.removeChild(i),t(i)};i.onerror=function(){i.onerror=null,Rg&&document.body.removeChild(i),s()},i.addEventListener("canplaythrough",n),i.src=e}}}class QT extends Le{constructor(e){super(e,"binary")}load(e,t){typeof e=="string"&&(e={load:e,original:e}),He.get(e.load,{responseType:fe.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading binary resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return e.buffer}}class ur{constructor(e,t,s,i){const n=function(c,d,u){const f=ur.createAsset(t.name,c,d,u);return s.add(f),f},r=[];for(let h=0;h<e.renders.length;++h)r.push(n("render",e.renders[h],h));const a=[];for(let h=0;h<e.materials.length;++h)a.push(n("material",e.materials[h],h));const l=[];for(let h=0;h<e.animations.length;++h)l.push(n("animation",e.animations[h],h));this.data=e,this._model=null,this._assetName=t.name,this._assets=s,this._defaultMaterial=i,this.renders=r,this.materials=a,this.textures=e.textures,this.animations=l}get model(){if(!this._model){const e=ur.createModel(this.data,this._defaultMaterial),t=ur.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t}return this._model}static createAsset(e,t,s,i){const n=new se(e+"/"+t+"/"+i,t,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(e){const t=new Ce;return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){const t=this._defaultMaterial,s=[],i=function(l,h,c,d,u,f,p){const _=u[c.id],m=_===void 0?t:d[_],g=new Te(c,m);return c.morph&&(g.morphInstance=new tr(c.morph)),p.hasOwnProperty("skin")&&s.push({meshInstance:g,rootBone:l,entity:h}),g},n=(a,l,h)=>{const c=new Ce;l._cloneInternal(c),a||(a=c);let d=null,u=null;for(let p=0;p<h.nodes.length;p++)if(h.nodes[p]===l){const m=h.gltf.nodes[p];if(m.hasOwnProperty("mesh")){const g=h.renders[m.mesh].meshes;u=this.renders[m.mesh];for(let x=0;x<g.length;x++){const S=g[x];if(S){const v=i(a,c,S,h.materials,h.meshDefaultMaterials,h.skins,m);d||(d=[]),d.push(v)}}}if(h.lights){const g=h.lights.get(m);g&&c.addChild(g.clone())}if(h.cameras){const g=h.cameras.get(m);g&&g.camera.system.cloneComponent(g,c)}}d&&(c.addComponent("render",Object.assign({type:"asset",meshInstances:d,rootBone:a},e)),c.render.assignAsset(u));const f=l.children;for(let p=0;p<f.length;p++){const _=n(a,f[p],h);c.addChild(_)}return c},r=[];for(const a of this.data.scenes)r.push(n(null,a,this.data));return s.forEach(a=>{a.meshInstance.skinInstance=Ks.createCachedSkinInstance(a.meshInstance.mesh.skin,a.rootBone,a.entity)}),ur.createSceneHierarchy(r,"Entity")}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){const s=t?this.data.variants[t]:null;if(s===void 0)return;const i=e.findComponents("render");for(let n=0;n<i.length;n++){const r=i[n];this._applyMaterialVariant(s,r.meshInstances)}}applyMaterialVariantInstances(e,t){const s=t?this.data.variants[t]:null;s!==void 0&&this._applyMaterialVariant(s,e)}_applyMaterialVariant(e,t){t.forEach(s=>{if(e===null)s.material=this._defaultMaterial;else{const i=this.data.meshVariants[s.mesh.id];i&&(s.material=this.data.materials[i[e]])}})}static createSceneHierarchy(e,t){let s=null;if(e.length===1)s=e[0];else{s=new t("SceneGroup");for(const i of e)s.addChild(i)}return s}static createModel(e,t){const s=function(a,l,h,c,d,u,f){const p=e.meshDefaultMaterials[l.id],_=p===void 0?t:d[p],m=new Te(l,_,u);if(l.morph){const g=new tr(l.morph);m.morphInstance=g,a.morphInstances.push(g)}if(f.hasOwnProperty("skin")){const g=f.skin,x=h[g];l.skin=x;const S=c[g];m.skinInstance=S,a.skinInstances.push(S)}a.meshInstances.push(m)},i=new _i,n=[];for(const r of e.skins){const a=new ta(r);a.bones=r.bones,n.push(a)}i.graph=ur.createSceneHierarchy(e.scenes,"GraphNode");for(let r=0;r<e.nodes.length;r++){const a=e.nodes[r];if(a.root===i.graph){const l=e.gltf.nodes[r];if(l.hasOwnProperty("mesh")){const h=e.renders[l.mesh].meshes;for(let c=0;c<h.length;c++){const d=h[c];d&&s(i,d,e.skins,n,e.materials,a,l)}}}}return i}destroy(){const e=this._assets,t=function(n){e.remove(n),n.unload()},s=function(n){n.forEach(function(r){t(r)})};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null}}class Ok{constructor(e,t,s){this._device=e,this._assets=t,this._defaultMaterial=vf.createDefaultMaterial(),this.maxRetries=s}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,s){se.fetchArrayBuffer(e.load,(i,n)=>{i?t(i):vf.parse(this._getUrlWithoutParams(e.original),ce.extractPath(e.load),n,this._device,s.registry,s.options,(r,a)=>{r?t(r):t(null,new ur(a,s,this._assets,this._defaultMaterial))})},s,this.maxRetries)}open(e,t,s){return t}patch(e,t){}}class Bk{instantiateModelEntity(e){return null}instantiateRenderEntity(e){return null}getMaterialVariants(){return null}applyMaterialVariant(e,t){}applyMaterialVariantInstances(e,t){}}class JT extends Le{constructor(e){super(e,"container"),this.glbContainerParser=new Ok(e.graphicsDevice,e.assets,0),this.parsers={}}set maxRetries(e){this.glbContainerParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=e?ce.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){return this._getParser(e).open(e,t,s)}}class ew extends Le{constructor(e){super(e,"css"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),He.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading css resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}class tw extends Le{constructor(e){super(e,"cubemap"),this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}load(e,t,s){this.loadAssets(s,t)}open(e,t,s){return s?s.resource:null}patch(e,t){this.loadAssets(e,function(s,i){s&&(t.fire("error",e),t.fire("error:"+e.id,s,e),e.fire("error",e))})}getAssetIds(e){const t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let s=0;s<6;++s)t[s+1]=e.data.textures[s];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||typeof e=="string"?e===t:e.url===t.url:e!==null==(t!==null)}update(e,t,s){const i=e.data||{},n=e._handlerState.assets,r=e._resources;let a,l,h;const c=[null,null,null,null,null,null,null],d=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?Cs:bt:null};if(!e.loaded||s[0]!==n[0]){if(s[0])if(a=s[0].resource,a.cubemap)for(h=0;h<6;++h)c[h+1]=new re(this._device,{name:e.name+"_prelitCubemap"+(a.width>>h),cubemap:!0,type:d()||a.type,width:a.width>>h,height:a.height>>h,format:a.format,levels:[a._levels[h]],fixCubemapSeams:!0,addressU:q,addressV:q,mipmaps:h===0});else a.type=Or,a.addressU=q,a.addressV=q,a.mipmaps=!1,c[1]=a}else c[1]=r[1]||null,c[2]=r[2]||null,c[3]=r[3]||null,c[4]=r[4]||null,c[5]=r[5]||null,c[6]=r[6]||null;const u=s.slice(1);if(!e.loaded||!this.cmpArrays(u,n.slice(1))){if(u.indexOf(null)===-1){var f;const p=u.map(function(x){return x.resource}),_=[];for(l=0;l<p[0]._levels.length;++l)_.push(p.map(function(x){return x._levels[l]}));const m=p[0].format,g=new re(this._device,{name:e.name+"_faces",cubemap:!0,type:d()||p[0].type,width:p[0].width,height:p[0].height,format:m===Es?oe:m,mipmaps:(f=i.mipmaps)!=null?f:!0,levels:_,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:p[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:p[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:q,addressV:q,fixCubemapSeams:!!s[0]});c[0]=g}}else c[0]=r[0]||null;if(!this.cmpArrays(c,r))for(e.resources=c,e._handlerState.assetIds=t,e._handlerState.assets=s,h=0;h<r.length;++h)r[h]!==null&&c.indexOf(r[h])===-1&&r[h].destroy();for(h=0;h<n.length;++h)n[h]!==null&&s.indexOf(n[h])===-1&&n[h].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0}resolveId(e){const t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(e),n=[null,null,null,null,null,null,null],r=e._handlerState.assetIds,a=e._handlerState.assets,l=s._registry;let h=7;const c=function(_,m){n[_]=m,h--,h===0&&(s.update(e,i,n),t(null,e.resources))},d=function(_,m,g){t(m)},u=function(_,m){m.loaded?c(_,m):(l.once("load:"+m.id,c.bind(s,_)),l.once("error:"+m.id,d.bind(s,_)),m.loading||l.load(m))};let f;for(let p=0;p<7;++p){const _=this.resolveId(i[p]);if(!_)c(p,null);else if(s.compareAssetIds(_,r[p]))c(p,a[p]);else if(parseInt(_,10)===_)f=l.get(_),f?u(p,f):setTimeout((function(m,g){const x=l.get(g);x?u(m,x):d(m,"failed to find dependent cubemap asset="+g)}).bind(null,p,_));else{const m=typeof _=="string"?{url:_,filename:_}:_;f=new se(e.name+"_part_"+p,"texture",m),l.add(f),l.once("load:"+f.id,c.bind(s,p)),l.once("error:"+f.id,d.bind(s,p)),l.load(f)}}}}class sw extends Le{constructor(e){super(e,"folder")}load(e,t){t(null,null)}}class Ig{constructor(e,t){this.type=t&&t.type||Cc,this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t}set data(e){if(this._data=e,!!e&&(this._data.intensity!==void 0&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(const t in this._data.chars)this._data.chars[t].map=0}get data(){return this._data}}function Dg(o){return o.version<3&&(o.version<2&&(o.info.maps=o.info.maps||[{width:o.info.width,height:o.info.height}]),o.chars=Object.keys(o.chars||{}).reduce(function(e,t){const s=o.chars[t],i=s.letter!==void 0?s.letter:bi.fromCodePoint(t);return o.version<2&&(s.map=s.map||0),e[i]=s,e},{}),o.version=3),o}class iw extends Le{constructor(e){super(e,"font"),this._loader=e.loader,this.maxRetries=0}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});const i=this;ce.getExtension(e.original)===".json"?He.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){if(n)t(`Error loading font resource: ${e.original} [${n}]`);else{const a=Dg(r);i._loadTextures(e.load.replace(".json",".png"),a,function(l,h){l?t(l):t(null,{data:a,textures:h})})}}):(s&&s.data&&(s.data=Dg(s.data)),this._loadTextures(e.load,s&&s.data,t))}_loadTextures(e,t,s){const i=t.info.maps.length;let n=0,r=null;const a=new Array(i),l=this._loader,h=function(d){const u=function(p,_){if(!r){if(p){r=p,s(p);return}_.upload(),a[d]=_,n++,n===i&&s(null,a)}};d===0?l.load(e,"texture",u):l.load(e.replace(".png",d+".png"),"texture",u)};for(let c=0;c<i;c++)h(c)}open(e,t,s){let i;return t.textures?i=new Ig(t.textures,t.data):i=new Ig(t,null),i}patch(e,t){const s=e.resource;!s.data&&e.data?s.data=e.data:!e.data&&s.data&&(e.data=s.data),e.data&&(e.data=Dg(e.data))}}class nw{constructor(e,t){this.device=void 0,this.splatData=void 0,this.splat=null,this.device=e,this.splatData=t.isCompressed?t.decompress():t}destroy(){var e;this.device=null,this.splatData=null,(e=this.splat)==null||e.destroy(),this.splat=null}createSplat(){if(!this.splat){const e=this.splatData,t=new ye;this.splatData.calcAabb(t);const s=new SS(this.device,e.numSplats,t);this.splat=s,s.updateColorData(e.getProp("f_dc_0"),e.getProp("f_dc_1"),e.getProp("f_dc_2"),e.getProp("opacity")),s.updateTransformData(e.getProp("x"),e.getProp("y"),e.getProp("z"),e.getProp("rot_0"),e.getProp("rot_1"),e.getProp("rot_2"),e.getProp("rot_3"),e.getProp("scale_0"),e.getProp("scale_1"),e.getProp("scale_2"));const i=e.getProp("x"),n=e.getProp("y"),r=e.getProp("z"),a=new Float32Array(this.splatData.numSplats*3);for(let l=0;l<this.splatData.numSplats;++l)a[l*3+0]=i[l],a[l*3+1]=n[l],a[l*3+2]=r[l];s.centers=a}return this.splat}instantiate(e={}){const t=this.createInstance(e),s=new Ce,i=s.addComponent("gsplat",{instance:t});return i.customAabb=t.splat.aabb.clone(),s}createInstance(e={}){const t=this.createSplat();return new Ru(t,e)}}const rw=new Uint8Array([112,108,121,10]),aw=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),ow=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]),Nk=async(o,e=null)=>{const t=(f,p)=>{const _=new Uint8Array(f.byteLength+p.byteLength);return _.set(f),_.set(p,f.byteLength),_},s=(f,p)=>{const _=f.length-p.length;let m,g;for(m=0;m<=_;++m){for(g=0;g<p.length&&f[m+g]===p[g];++g);if(g===p.length)return m}return-1},i=(f,p)=>{if(f.length<p.length)return!1;for(let _=0;_<p.length;++_)if(f[_]!==p[_])return!1;return!0};let n,r;for(;;){const{value:f,done:p}=await o.read();if(p)throw new Error("Stream finished before end of header");if(n=n?t(n,f):f,n.length>=rw.length&&!i(n,rw))throw new Error("Invalid ply header");if(r=s(n,aw),r!==-1)break}const l=new TextDecoder("ascii").decode(n.slice(0,r)).split(`
`).filter(f=>!f.startsWith("comment ")),h=[];for(let f=1;f<l.length;++f){const p=l[f].split(" ");switch(p[0]){case"format":if(p[1]!=="binary_little_endian")throw new Error("Unsupported ply format");break;case"element":h.push({name:p[1],count:parseInt(p[2],10),properties:[]});break;case"property":{if(!ow.has(p[1]))throw new Error(`Unrecognized property data type '${p[1]}' in ply header`);const _=h[h.length-1],m=ow.get(p[1]),g=!e||e(p[2])?new m(_.count):null;_.properties.push({type:p[1],name:p[2],storage:g,byteSize:m.BYTES_PER_ELEMENT});break}default:throw new Error(`Unrecognized header value '${p[0]}' in ply header`)}}let c=r+aw.length,d=n.length-c,u=new DataView(n.buffer);for(let f=0;f<h.length;++f){const p=h[f];for(let _=0;_<p.count;++_)for(let m=0;m<p.properties.length;++m){const g=p.properties[m];for(;d<g.byteSize;){const{value:x,done:S}=await o.read();if(S)throw new Error("Stream finished before end of data");const v=new Uint8Array(d+x.byteLength);v.set(n.slice(c)),v.set(x,d),n=v,u=new DataView(n.buffer),c=0,d=n.length}if(g.storage)switch(g.type){case"char":g.storage[_]=u.getInt8(c);break;case"uchar":g.storage[_]=u.getUint8(c);break;case"short":g.storage[_]=u.getInt16(c,!0);break;case"ushort":g.storage[_]=u.getUint16(c,!0);break;case"int":g.storage[_]=u.getInt32(c,!0);break;case"uint":g.storage[_]=u.getUint32(c,!0);break;case"float":g.storage[_]=u.getFloat32(c,!0);break;case"double":g.storage[_]=u.getFloat64(c,!0);break}c+=g.byteSize,d-=g.byteSize}}return h},kk=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","rot_0","rot_1","rot_2","rot_3","scale_0","scale_1","scale_2","min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","packed_position","packed_rotation","packed_scale","packed_color"],Uk=new Set(kk),zk=o=>Uk.has(o);class Vk{constructor(e,t,s){this.device=void 0,this.assets=void 0,this.maxRetries=void 0,this.device=e,this.assets=t,this.maxRetries=s}async load(e,t,s){const i=await fetch(e.load);if(!i||!i.body)t("Error loading resource",null);else{var n;Nk(i.body.getReader(),(n=s.data.elementFilter)!=null?n:zk).then(r=>{t(null,new nw(this.device,new ol(r)))}).catch(r=>{t(r,null)})}}open(e,t){return t}}class lw extends Le{constructor(e){super(e,"gsplat"),this.parser=new Vk(e.graphicsDevice,e.assets,3)}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this.parser.load(e,t,s)}open(e,t,s){return this.parser.open(e,t,s)}}class Lg{static setCompressedPRS(e,t,s){const i=s.singleVecs;let n,r;const a=t.___1;a||(n=s.tripleVecs,r=t.___2);let l=a?a[0]:n[r];e.setLocalPosition(i[l],i[l+1],i[l+2]),l=a?a[1]:n[r+1],e.setLocalEulerAngles(i[l],i[l+1],i[l+2]),l=a?a[2]:n[r+2],e.setLocalScale(i[l],i[l+1],i[l+2])}static oneCharToKey(e,t){const s=e.charCodeAt(0)-t.fieldFirstCode;return t.fieldArray[s]}static multCharToKey(e,t){let s=0;for(let i=0;i<e.length;i++)s=s*t.fieldCodeBase+e.charCodeAt(i)-t.fieldFirstCode;return t.fieldArray[s]}}class xf{constructor(e,t){this._node=e,this._data=t}run(){const e=Object.prototype.toString.call(this._node);return e==="[object Object]"?this._handleMap():e==="[object Array]"?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={},Object.keys(this._node).forEach(this._handleKey,this)}_handleKey(e){let t=e;const s=e.length;s===1?t=Lg.oneCharToKey(e,this._data):s===2&&(t=Lg.multCharToKey(e,this._data)),this._result[t]=new xf(this._node[e],this._data).run()}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)}_handleArElt(e){const t=new xf(e,this._data).run();this._result.push(t)}}class Fg{constructor(e,t){this._app=e,this._isTemplate=t}parse(e){const t={};let s=null;const i=e.compressedFormat;i&&!e.entDecompressed&&(e.entDecompressed=!0,e.entities=new xf(e.entities,i).run());for(const n in e.entities){const r=e.entities[n],a=this._createEntity(r,i);t[n]=a,r.parent===null&&(s=a)}for(const n in e.entities){const r=t[n],a=e.entities[n].children,l=a.length;for(let h=0;h<l;h++){const c=t[a[h]];c&&r.addChild(c)}}return this._openComponentData(s,e.entities),s}_createEntity(e,t){var s;const i=new Ce(e.name,this._app);if(i.setGuid(e.resource_id),this._setPosRotScale(i,e,t),i._enabled=(s=e.enabled)!=null?s:!0,this._isTemplate?i._template=!0:i._enabledInHierarchy=i._enabled,i.template=e.template,e.tags)for(let n=0;n<e.tags.length;n++)i.tags.add(e.tags[n]);return e.labels&&e.labels.forEach(function(n){i.addLabel(n)}),i}_setPosRotScale(e,t,s){if(s)Lg.setCompressedPRS(e,t,s);else{const i=t.position,n=t.rotation,r=t.scale;e.setLocalPosition(i[0],i[1],i[2]),e.setLocalEulerAngles(n[0],n[1],n[2]),e.setLocalScale(r[0],r[1],r[2])}}_openComponentData(e,t){const s=this._app.systems.list;let i=s.length;const n=t[e.getGuid()];for(let a=0;a<i;a++){const l=s[a],h=n.components[l.id];h&&l.addComponent(e,h)}i=n.children.length;const r=e._children;for(let a=0;a<i;a++)r[a]&&(r[a]=this._openComponentData(r[a],t));return e}}class Og{static load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),He.get(e.load,{retry:t>0,maxRetries:t},function(i,n){if(!i)s(i,n);else{let r="Error while loading scene JSON "+e.original;i.message?(r+=": "+i.message,i.stack&&(r+=`
`+i.stack)):r+=": "+i,s(r)}})}}class hw extends Le{constructor(e){super(e,"hierarchy")}load(e,t){Og.load(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;const i=new Fg(this._app,!1).parse(t);return this._app.systems.script.preloading=!1,i}}class cw extends Le{constructor(e){super(e,"html"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),He.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading html resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}class dw extends Le{constructor(e){super(e,"json"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=fe.ResponseType.JSON),He.get(e.load,s,function(i,n){i?t(`Error loading JSON resource: ${e.original} [${i}]`):t(null,n)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),JSON.parse(this.decoder.decode(e))}}class Gk{constructor(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([Q0,Jr,Gd]),cull:this._createEnumValidator([Je,Ai,br,gp]),blendType:this._createEnumValidator([Qp,Od,Bt,Nt,jn,Bd,Nd,Jp,em,tm,sm]),depthFunc:this._createEnumValidator([Oy,jc,Nl,Yc,By,Ny,ky,Ci]),shadingModel:this._createEnumValidator([li,Qr])}}setInvalid(e,t){this.valid=!1,this.removeInvalid&&delete t[e]}validate(e){const t=Ko,s=pF,i=e.mappingFormat==="path";for(const n in e){const r=t[n];if(!r){s[n]?delete e[n]:this.valid=!1;continue}if(r.startsWith("enum")){const a=r.split(":")[1];this.enumValidators[a]&&(this.enumValidators[a](e[n])||this.setInvalid(n,e))}else if(r==="number")typeof e[n]!="number"&&this.setInvalid(n,e);else if(r==="boolean")typeof e[n]!="boolean"&&this.setInvalid(n,e);else if(r==="string")typeof e[n]!="string"&&this.setInvalid(n,e);else if(r==="vec2")e[n]instanceof Array&&e[n].length===2||this.setInvalid(n,e);else if(r==="rgb")e[n]instanceof Array&&e[n].length===3||this.setInvalid(n,e);else if(r==="texture")i?typeof e[n]=="string"||e[n]===null||e[n]instanceof re||this.setInvalid(n,e):typeof e[n]=="number"||e[n]===null||e[n]instanceof re||this.setInvalid(n,e);else if(r==="boundingbox")e[n].center&&e[n].center instanceof Array&&e[n].center.length===3||this.setInvalid(n,e),e[n].halfExtents&&e[n].halfExtents instanceof Array&&e[n].halfExtents.length===3||this.setInvalid(n,e);else if(r==="cubemap")typeof e[n]=="number"||e[n]===null||e[n]===void 0||e[n]instanceof re&&e[n].cubemap||this.setInvalid(n,e);else if(r==="chunks"){const a=Object.keys(e[n]);for(let l=0;l<a.length;l++)typeof e[n][a[l]]!="string"&&this.setInvalid(a[l],e[n])}else console.error("Unknown material type: "+r)}return e.validated=!0,this.valid}_createEnumValidator(e){return function(t){return e.indexOf(t)>=0}}}class uw{constructor(){this._validator=null}parse(e){const t=this.migrate(e),s=this._validate(t),i=new Ct;return this.initialize(i,s),i}initialize(e,t){t.validated||(t=this._validate(t)),t.chunks&&(e.chunks=gt({},t.chunks));for(const s in t){const i=Ko[s],n=t[s];if(i==="vec2")e[s]=new G(n[0],n[1]);else if(i==="rgb")e[s]=new H(n[0],n[1],n[2]);else if(i==="texture")n instanceof re?e[s]=n:e[s]instanceof re&&typeof n=="number"&&n>0||(e[s]=null);else if(i==="cubemap")n instanceof re?e[s]=n:e[s]instanceof re&&typeof n=="number"&&n>0||(e[s]=null),s==="cubeMap"&&!n&&(e.prefilteredCubemaps=null);else if(i==="boundingbox"){const r=new y(n.center[0],n.center[1],n.center[2]),a=new y(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]);e[s]=new ye(r,a)}else e[s]=t[s]}e.update()}migrate(e){e.shadingModel===void 0&&(e.shader==="blinn"?e.shadingModel=Qr:e.shadingModel=li),e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);let t;const s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"],["clearCoatGlossiness","clearCoatGloss"]];for(t=0;t<s.length;t++){const n=s[t][0],r=s[t][1];e[n]!==void 0&&(e[r]===void 0&&(e[r]=e[n]),delete e[n])}const i=["fresnelFactor","shadowSampleType"];for(t=0;t<i.length;t++){const n=i[t];e.hasOwnProperty(n)&&delete e[n]}return e}_validate(e){return e.validated||(this._validator||(this._validator=new Gk),this._validator.validate(e)),e}}const Wk={aoMap:"white",diffuseMap:"gray",specularMap:"gray",specularityFactorMap:"white",metalnessMap:"black",glossMap:"gray",sheenMap:"black",sheenGlossinessMap:"gray",clearCoatMap:"black",clearCoatGlossMap:"gray",clearCoatNormalMap:"normal",refractionMap:"white",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};class fw extends Le{constructor(e){super(e,"material"),this._assets=e.assets,this._device=e.graphicsDevice,this._placeholderTextures=null,this._parser=new uw}load(e,t){typeof e=="string"&&(e={load:e,original:e}),He.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t&&t(`Error loading material: ${e.original} [${s}]`):t&&(i._engine=!0,t(null,i))})}open(e,t){const s=this._parser.parse(t);return t._engine&&(s._data=t,delete t._engine),s}_createPlaceholders(){this._placeholderTextures={};const e={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(const t in e){if(!e.hasOwnProperty(t))continue;this._placeholderTextures[t]=new re(this._device,{width:2,height:2,format:oe,name:"material_placeholder"});const s=this._placeholderTextures[t].lock();for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[i*4+n]=e[t][n];this._placeholderTextures[t].unlock()}}patch(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this)}_onAssetUnload(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name}_assignTexture(e,t,s){t.resource[e]=s}_getPlaceholderTexture(e){this._placeholderTextures||this._createPlaceholders();const t=Wk[e];return this._placeholderTextures[t]}_assignPlaceholderTexture(e,t){t.resource[e]=this._getPlaceholderTexture(e)}_onTextureLoad(e,t,s){this._assignTexture(e,t,s.resource),t.resource.update()}_onTextureAdd(e,t,s){this._assets.load(s)}_onTextureRemoveOrUnload(e,t,s){const i=t.resource;i&&t.resource[e]===s.resource&&(this._assignPlaceholderTexture(e,t),i.update())}_assignCubemap(e,t,s){if(t.resource[e]=s[0],e==="cubeMap"){const i=s.slice(1);i.every(n=>n)?t.resource.prefilteredCubemaps=i:i[0]&&(t.resource.envAtlas=i[0])}}_onCubemapLoad(e,t,s){this._assignCubemap(e,t,s.resources),this._parser.initialize(t.resource,t.data)}_onCubemapAdd(e,t,s){t.data.shadingModel===li&&(t.loadFaces=!0),this._assets.load(s)}_onCubemapRemoveOrUnload(e,t,s){const i=t.resource;t.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),i.update())}_bindAndAssignAssets(e,t){const s=this._parser.migrate(e.data),i=e.resource,n=s.mappingFormat==="path",r=ou;let a,l,h;for(a=0;a<r.length;a++){l=r[a],h=i._assetReferences[l];const d=s[l],u=i[l],f=u===this._getPlaceholderTexture(l),p=s.validated;d&&(!u||!p||f)?(h||(h=new _l(l,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),i._assetReferences[l]=h),n?h.url=e.getAbsoluteUrl(d):h.id=d,h.asset&&(h.asset.resource?this._assignTexture(l,e,h.asset.resource):this._assignPlaceholderTexture(l,e),t.load(h.asset))):h&&(n?h.url=null:h.id=null)}const c=Um;for(a=0;a<c.length;a++)l=c[a],h=i._assetReferences[l],s[l]&&!e.data.prefilteredCubeMap128&&(h||(h=new _l(l,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),i._assetReferences[l]=h),n?h.url=s[l]:h.id=s[l],h.asset&&(h.asset.loaded&&this._assignCubemap(l,e,h.asset.resources),t.load(h.asset)));this._parser.initialize(i,s)}}class Hk{constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial,this._assets=e.assets}parse(e,t,s){var i;vf.parse("filename.glb","",e,this._device,this._assets,(i=s==null?void 0:s.options)!=null?i:{},(n,r)=>{if(n)t(n);else{const a=ur.createModel(r,this._defaultMaterial);r.destroy(),t(null,a)}})}}class Xk{constructor(){this.index=0,this.boneIndices=[0,0,0,0]}}class $k{constructor(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={},this.originalMesh=null}addVertex(e,t,s){let i=-1;if(this.indexMap[t]!==void 0)i=this.indexMap[t],this.indices.push(i);else{for(let n=0;n<4;n++){if(s.blendWeight.data[t*4+n]===0)continue;const r=s.blendIndices.data[e.index*4+n];e.boneIndices[n]=this.getBoneRemap(r)}i=this.vertices.length,this.indices.push(i),this.vertices.push(e),this.indexMap[t]=i}}addPrimitive(e,t,s,i){const n=[];let r=0;const a=e.length;for(let l=0;l<a;l++){const c=e[l].index;for(let d=0;d<4;d++)if(s.blendWeight.data[c*4+d]>0){const u=s.blendIndices.data[c*4+d];let f=!0;for(let p=0;p<r;p++)if(n[p]===u){f=!1;break}if(f){n[r]=u;const p=this.getBoneRemap(u);r+=p===-1?1:0}}}if(this.boneIndices.length+r>i)return!1;for(let l=0;l<r;l++)this.boneIndices.push(n[l]);for(let l=0;l<a;l++)this.addVertex(e[l],t[l],s);return!0}getBoneRemap(e){for(let t=0;t<this.boneIndices.length;t++)if(this.boneIndices[t]===e)return t;return-1}}function qk(o){const e=o.vertices,t=o.skins,s=o.meshes,i=o.meshInstances;for(let n=0;n<s.length;n++)s[n].vertices=e[s[n].vertices],s[n].skin!==void 0&&(s[n].skin=t[s[n].skin]);for(let n=0;n<i.length;n++)i[n].mesh=s[i[n].mesh]}function jk(o){const e=o.vertices,t=o.skins,s=o.meshes,i=o.meshInstances;for(let n=0;n<s.length;n++)s[n].vertices=e.indexOf(s[n].vertices),s[n].skin!==void 0&&(s[n].skin=t.indexOf(s[n].skin));for(let n=0;n<i.length;n++)i[n].mesh=s.indexOf(i[n].mesh)}function pw(o,e,t){let s,i,n,r;qk(o);const a=o.vertices,l=o.skins;let h;const c=o.meshes,d=o.meshInstances,u=function(p){const _=new Xk;return _.index=p,_};for(s=l.length-1;s>=0;s--)if(l[s].boneNames.length>t){const f=l.splice(s,1)[0],p=[];for(i=0;i<c.length;i++)c[i].skin===f&&p.push(c[i]);for(i=0;i<p.length;i++)r=c.indexOf(p[i]),r!==-1&&c.splice(r,1);if(p.length===0)throw new Error("partitionSkin: There should be at least one mesh that references a skin");const _=p[0].vertices;for(i=1;i<p.length;i++)if(p[i].vertices!==_)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");let m;const g=[],x=[],S=[];let v=0;for(i=0;i<p.length;i++){h=p[i];const B=h.indices;for(let P=h.base;P<h.base+h.count;){r=B[P++],x[0]=u(r),S[0]=r,r=B[P++],x[1]=u(r),S[1]=r,r=B[P++],x[2]=u(r),S[2]=r;let D=!1;for(let R=v;R<g.length;R++)if(m=g[R],m.addPrimitive(x,S,_,t)){D=!0;break}D||(m=new $k,m.originalMesh=h,m.addPrimitive(x,S,_,t),g.push(m))}v=g.length}const b=[],w=[];for(i=0;i<g.length;i++)if(m=g[i],m.vertices.length&&m.indices.length){const B=b.length,P=m.vertices.length,D=w.length,R=m.indices.length;m.partition=i,m.vertexStart=B,m.vertexCount=P,m.indexStart=D,m.indexCount=R;let A,L;for(A=0,L=B;A<P;)b[L++]=m.vertices[A++];for(A=0,L=D;A<R;)w[L++]=m.indices[A++]+B}const T=[];for(i=0;i<g.length;i++){m=g[i];const B=[],P=[];for(n=0;n<m.boneIndices.length;n++)B.push(f.inverseBindMatrices[m.boneIndices[n]]),P.push(f.boneNames[m.boneIndices[n]]);const D={inverseBindMatrices:B,boneNames:P};T.push(D),l.push(D)}let E,C,M,O;const I={};for(C in _)I[C]={components:_[C].components,data:[],type:_[C].type};for(C in _)if(C==="blendIndices"){const B=I[C].data;for(i=0;i<b.length;i++){const P=b[i].boneIndices;B.push(P[0],P[1],P[2],P[3])}}else for(E=_[C],M=E.data,O=E.components,i=0;i<b.length;i++)for(r=b[i].index,n=0;n<O;n++)I[C].data.push(M[r*O+n]);for(a[a.indexOf(_)]=I,i=0;i<g.length;i++)for(m=g[i],h={aabb:{min:[0,0,0],max:[0,0,0]},vertices:I,skin:T[i],indices:w.splice(0,m.indexCount),type:"triangles",base:0,count:m.indexCount},c.push(h),n=d.length-1;n>=0;n--)d[n].mesh===m.originalMesh&&(d.push({mesh:h,node:d[n].node}),e&&e.push({material:e[n].material,path:e[n].path}));for(i=0;i<g.length;i++)for(m=g[i],n=d.length-1;n>=0;n--)d[n].mesh===m.originalMesh&&(d.splice(n,1),e&&e.splice(n,1))}jk(o)}const Yk={points:Lr,lines:eo,lineloop:rd,linestrip:ad,triangles:Js,trianglestrip:As,trianglefan:Xi},Kk={int8:si,uint8:Zt,int16:ii,uint16:Ms,int32:xe,uint32:tt,float32:le};class Zk{constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial}parse(e,t){const s=e.model;if(!s){t(null,null);return}if(s.version<=1){t("JsonModelParser#parse: Trying to parse unsupported model format.");return}const i=this._parseNodes(e),n=this._parseSkins(e,i),r=this._parseVertexBuffers(e),a=this._parseIndexBuffers(e,r),l=this._parseMorphs(e,i,r),h=this._parseMeshes(e,n.skins,l.morphs,r,a.buffer,a.data),c=this._parseMeshInstances(e,i,h,n.skins,n.instances,l.morphs,l.instances),d=new _i;d.graph=i[0],d.meshInstances=c,d.skinInstances=n.instances,d.morphInstances=l.instances,d.getGraph().syncHierarchy(),t(null,d)}_parseNodes(e){const t=e.model,s=[];let i;for(i=0;i<t.nodes.length;i++){const n=t.nodes[i],r=new we(n.name);r.setLocalPosition(n.position[0],n.position[1],n.position[2]),r.setLocalEulerAngles(n.rotation[0],n.rotation[1],n.rotation[2]),r.setLocalScale(n.scale[0],n.scale[1],n.scale[2]),r.scaleCompensation=!!n.scaleCompensation,s.push(r)}for(i=1;i<t.parents.length;i++)s[t.parents[i]].addChild(s[i]);return s}_parseSkins(e,t){const s=e.model,i=[],n=[];let r,a;if(!this._device.supportsBoneTextures&&s.skins.length>0){const l=this._device.getBoneLimit();pw(s,null,l)}for(r=0;r<s.skins.length;r++){const l=s.skins[r],h=[];for(a=0;a<l.inverseBindMatrices.length;a++){const f=l.inverseBindMatrices[a];h[a]=new W().set(f)}const c=new Eu(this._device,h,l.boneNames);i.push(c);const d=new ta(c),u=[];for(a=0;a<c.boneNames.length;a++){const f=c.boneNames[a],p=t[0].findByName(f);u.push(p)}d.bones=u,n.push(d)}return{skins:i,instances:n}}_getMorphVertexCount(e,t,s){for(let i=0;i<e.meshes.length;i++){const n=e.meshes[i];if(n.morph===t)return s[n.vertices].numVertices}}_parseMorphs(e,t,s){const i=e.model,n=[],r=[];let a,l,h,c,d,u;if(i.morphs){const f=function(_,m,g){const x=new Float32Array(g*3);for(let S=0;S<m.length;S++){const v=m[S]*3;x[v]=_[S*3],x[v+1]=_[S*3+1],x[v+2]=_[S*3+2]}return x};for(a=0;a<i.morphs.length;a++){for(c=i.morphs[a].targets,u=[],h=this._getMorphVertexCount(i,a,s),l=0;l<c.length;l++){const m=c[l].aabb,g=m.min,x=m.max,S=new ye(new y((x[0]+g[0])*.5,(x[1]+g[1])*.5,(x[2]+g[2])*.5),new y((x[0]-g[0])*.5,(x[1]-g[1])*.5,(x[2]-g[2])*.5)),v=c[l].indices;let b=c[l].deltaPositions,w=c[l].deltaNormals;v&&(b=f(b,v,h),w=f(w,v,h)),d=new rc({deltaPositions:b,deltaNormals:w,name:c[l].name,aabb:S}),u.push(d)}const p=new gu(u,this._device);n.push(p);const _=new tr(p);r.push(_)}}return{morphs:n,instances:r}}_parseVertexBuffers(e){const t=e.model,s=[],i={position:We,normal:Dt,tangent:ei,blendWeight:ti,blendIndices:Kt,color:_t,texCoord0:Lt,texCoord1:Ri,texCoord2:to,texCoord3:so,texCoord4:io,texCoord5:no,texCoord6:ro,texCoord7:ao};for(let n=0;n<t.vertices.length;n++){const r=t.vertices[n],a=[];for(const u in r){const f=r[u];a.push({semantic:i[u],components:f.components,type:Kk[f.type],normalize:i[u]===_t})}const l=new Tt(this._device,a),h=r.position.data.length/r.position.components,c=new es(this._device,l,h),d=new Kr(c);for(let u=0;u<h;u++){for(const f in r){const p=r[f];switch(p.components){case 1:d.element[i[f]].set(p.data[u]);break;case 2:d.element[i[f]].set(p.data[u*2],1-p.data[u*2+1]);break;case 3:d.element[i[f]].set(p.data[u*3],p.data[u*3+1],p.data[u*3+2]);break;case 4:d.element[i[f]].set(p.data[u*4],p.data[u*4+1],p.data[u*4+2],p.data[u*4+3]);break}}d.next()}d.end(),s.push(c)}return s}_parseIndexBuffers(e,t){const s=e.model;let i=null,n=null,r,a=0;for(r=0;r<s.meshes.length;r++){const h=s.meshes[r];h.indices!==void 0&&(a+=h.indices.length)}let l=0;for(r=0;r<t.length;r++)l=Math.max(l,t[r].numVertices);return a>0&&(l>65535&&this._device.extUintElement?(i=new Di(this._device,Mi,a),n=new Uint32Array(i.lock())):(i=new Di(this._device,Yt,a),n=new Uint16Array(i.lock()))),{buffer:i,data:n}}_parseMeshes(e,t,s,i,n,r){const a=e.model,l=[];let h=0;for(let c=0;c<a.meshes.length;c++){const d=a.meshes[c],u=d.aabb,f=u.min,p=u.max,_=new ye(new y((p[0]+f[0])*.5,(p[1]+f[1])*.5,(p[2]+f[2])*.5),new y((p[0]-f[0])*.5,(p[1]-f[1])*.5,(p[2]-f[2])*.5)),m=d.indices!==void 0,g=new Ut(this._device);g.vertexBuffer=i[d.vertices],g.indexBuffer[0]=m?n:null,g.primitive[0].type=Yk[d.type],g.primitive[0].base=m?d.base+h:d.base,g.primitive[0].count=d.count,g.primitive[0].indexed=m,g.skin=d.skin!==void 0?t[d.skin]:null,g.morph=d.morph!==void 0?s[d.morph]:null,g.aabb=_,m&&(r.set(d.indices,h),h+=d.indices.length),l.push(g)}return n!==null&&n.unlock(),l}_parseMeshInstances(e,t,s,i,n,r,a){const l=e.model,h=[];let c;for(c=0;c<l.meshInstances.length;c++){const d=l.meshInstances[c],u=t[d.node],f=s[d.mesh],p=new Te(f,this._defaultMaterial,u);if(f.skin){const _=i.indexOf(f.skin);p.skinInstance=n[_]}if(f.morph){const _=r.indexOf(f.morph);p.morphInstance=a[_]}h.push(p)}return h}}class mw extends Le{constructor(e){super(e,"model"),this._parsers=[],this.device=e.graphicsDevice,this.assets=e.assets,this.defaultMaterial=Xo(this.device),this.addParser(new Zk(this),function(t,s){return ce.getExtension(t)===".json"}),this.addParser(new Hk(this),function(t,s){return ce.getExtension(t)===".glb"})}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});const i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(ce.getExtension(e.original).toLowerCase()===".glb"?i.responseType=fe.ResponseType.ARRAY_BUFFER:i.responseType=fe.ResponseType.JSON),He.get(e.load,i,(n,r)=>{if(t)if(n)t(`Error loading model: ${e.original} [${n}]`);else{for(let a=0;a<this._parsers.length;a++){const l=this._parsers[a];if(l.decider(e.original,r)){l.parser.parse(r,(h,c)=>{h?t(h):t(null,c)},s);return}}t("No parsers found")}})}open(e,t){return t}patch(e,t){if(!e.resource)return;const s=e.data,i=this;e.resource.meshInstances.forEach(function(n,r){if(s.mapping){const a=function d(u){u.resource?n.material=u.resource:(u.once("load",d),t.load(u)),u.once("remove",function(f){n.material===f.resource&&(n.material=i.defaultMaterial)})};if(!s.mapping[r]){n.material=i.defaultMaterial;return}const l=s.mapping[r].material,h=s.mapping[r].path;let c;if(l!==void 0)l?(c=t.get(l),c?a(c):t.once("add:"+l,a)):n.material=i.defaultMaterial;else if(h){const d=e.getAbsoluteUrl(s.mapping[r].path);c=t.getByUrl(d),c?a(c):t.once("add:url:"+d,a)}}})}addParser(e,t){this._parsers.push({parser:e,decider:t})}}class _w extends Le{constructor(e){super(e,"scene")}load(e,t){Og.load(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;const i=new Fg(this._app,!1).parse(t),n=this._app.scene;return n.root=i,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=!1,n}}const Qk=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*");class Gt extends Q{constructor(e){super(),this.app=void 0,this.entity=void 0,this._enabled=void 0,this._enabledOld=void 0,this._initialized=void 0,this._postInitialized=void 0,this.__destroyed=void 0,this.__attributes=void 0,this.__attributesRaw=void 0,this.__scriptType=void 0,this.__executionOrder=void 0,this.initScriptType(e)}set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,vg)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,xg)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScriptType(e){const t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled=typeof e.enabled=="boolean"?e.enabled:!0,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=e.attributes||{},this.__scriptType=t,this.__executionOrder=-1}static __getScriptName(e){if(typeof e!="function")return;if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return"Function";const t=(""+e).match(Qk);return t?t[1]:void 0}static get scriptName(){return this.__name}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new dr(this)),this.__attributes}__initializeAttributes(e){if(!(!e&&!this.__attributesRaw)){for(const t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(e){for(const t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])}}Gt.EVENT_ENABLE="enable",Gt.EVENT_DISABLE="disable",Gt.EVENT_STATE="state",Gt.EVENT_DESTROY="destroy",Gt.EVENT_ATTR="attr",Gt.EVENT_ERROR="error",Gt.__name=null;const Bg=new Set(["system","entity","create","destroy","swap","move","data","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);function Jk(){return Bg}function gw(o,e){if(vt.legacy)return null;if(Bg.has(o))throw new Error(`Script name '${o}' is reserved, please rename the script`);const t=function(i){Q.prototype.initEventHandler.call(this),Gt.prototype.initScriptType.call(this,i)};return t.prototype=Object.create(Gt.prototype),t.prototype.constructor=t,t.extend=Gt.extend,t.attributes=new dr(t),Ng(t,o,e),t}const yw={};dr.reservedNames.forEach((o,e,t)=>{yw[o]=1}),gw.reservedAttributes=yw;function Ng(o,e,t){if(o.legacy)return;if(typeof o!="function")throw new Error(`script class: '${o}' must be a constructor function (i.e. class).`);if(!(o.prototype instanceof Gt))throw new Error(`script class: '${Gt.__getScriptName(o)}' does not extend pc.ScriptType.`);if(e=e||o.__name||Gt.__getScriptName(o),Bg.has(e))throw new Error(`script name: '${e}' is reserved, please change script name`);o.__name=e,(t?t.scripts:nt.getApplication().scripts).add(o),js.push(o,o.legacy)}class vw extends Le{constructor(e){super(e,"script"),this._scripts={},this._cache={}}clearCache(){for(const e in this._cache){const t=this._cache[e],s=t.parentNode;s&&s.removeChild(t)}this._cache={}}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s=this;vt.app=this._app;const i=(e.load,(l,h,c)=>{if(l)t(l);else if(vt.legacy){let d=null;js._types.length&&(d=js._types.pop()),d?this._scripts[h]=d:d=null,t(null,d,c)}else{const d={};for(let u=0;u<js._types.length;u++)d[js._types[u].name]=js._types[u];js._types.length=0,t(null,d,c),delete s._loader._cache[pa.makeKey(h,"script")]}}),[n,r]=e.load.split("?");if(n.endsWith(".mjs")){let l=e.load;l.startsWith(this._app.assets.prefix)&&(l=l.replace(this._app.assets.prefix,""));const h=this._app.assets.getByUrl(l).file.hash,c=new URLSearchParams(r);c.set("hash",h);const d=`${n}?${c.toString()}`;this._loadModule(d,i)}else this._loadScript(e.load,i)}open(e,t){return t}patch(e,t){}_loadScript(e,t){const s=document.head,i=document.createElement("script");this._cache[e]=i,i.async=!1,i.addEventListener("error",function(r){t(`Script: ${r.target.src} failed to load`)},!1);let n=!1;i.onload=i.onreadystatechange=function(){!n&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")&&(n=!0,t(null,e,i))},i.src=e,s.appendChild(i)}_loadModule(e,t){const s=ge.browser?window.location.origin:typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__filename).href:typeof document>"u"?location.href:$t&&$t.src||new URL("vpcr.umd.cjs",document.baseURI).href;import(new URL(e,s).toString()).then(n=>{for(const r in n){const a=n[r];if(a.prototype instanceof Gt){if(vt.attributesDefinition)for(const h in vt.attributesDefinition)a.attributes.add(h,vt.attributesDefinition[h]);Ng(a,a.name.toLowerCase())}}t(null,e,null)}).catch(n=>{t(n)})}}class xw extends Le{constructor(e){super(e,"shader"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),He.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading shader resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}function kg(o){const e=this;e.resource&&(e.resource.atlas=o.resource)}function Ug(o){this.registry.load(o)}class Sw extends Le{constructor(e){super(e,"sprite"),this._assets=e.assets,this._device=e.graphicsDevice}load(e,t){typeof e=="string"&&(e={load:e,original:e}),ce.getExtension(e.original)===".json"&&He.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(s):t(null,i)})}open(e,t){const s=new pS(this._device);return e&&(s.__data=t),s}patch(e,t){const s=e.resource;if(s.__data&&(e.data.pixelsPerUnit=s.__data.pixelsPerUnit,e.data.renderMode=s.__data.renderMode,e.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){const i=t.getByUrl(s.__data.textureAtlasAsset);i?e.data.textureAtlasAsset=i.id:console.warn("Could not find textureatlas with url: "+s.__data.textureAtlasAsset)}s.startUpdate(),s.renderMode=e.data.renderMode,s.pixelsPerUnit=e.data.pixelsPerUnit,s.frameKeys=e.data.frameKeys,this._updateAtlas(e),s.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_updateAtlas(e){const t=e.resource;if(!e.data.textureAtlasAsset){t.atlas=null;return}this._assets.off("load:"+e.data.textureAtlasAsset,kg,e),this._assets.on("load:"+e.data.textureAtlasAsset,kg,e);const s=this._assets.get(e.data.textureAtlasAsset);s&&s.resource?t.atlas=s.resource:s?this._assets.load(s):(this._assets.off("add:"+e.data.textureAtlasAsset,Ug,e),this._assets.on("add:"+e.data.textureAtlasAsset,Ug,e))}_onAssetChange(e,t,s,i){t==="data"&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off("load:"+i.textureAtlasAsset,kg,e),this._assets.off("add:"+i.textureAtlasAsset,Ug,e))}}class zg{constructor(e,t){this._app=void 0,this._data=void 0,this._templateRoot=null,this._app=e,this._data=t}instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){const e=new Fg(this._app,!0);this._templateRoot=e.parse(this._data)}}class bw extends Le{constructor(e){super(e,"template"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};He.get(e.load,s,function(i,n){i?t("Error requesting template: "+e.original):t(i,n)})}open(e,t){return new zg(this._app,t)}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),new zg(this._app,JSON.parse(this.decoder.decode(e)))}}class Tw extends Le{constructor(e){super(e,"text"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),He.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?t(`Error loading text resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){var t;return(t=this.decoder)!=null||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}}const Sf={repeat:Qe,clamp:q,mirror:Ha},bf={nearest:de,linear:Oe,nearest_mip_nearest:Tr,linear_mip_nearest:Er,nearest_mip_linear:wr,linear_mip_linear:Qs},eU=/^data\.frames\.(\d+)$/;class ww extends Le{constructor(e){super(e,"textureatlas"),this._loader=e.loader}load(e,t){typeof e=="string"&&(e={load:e,original:e});const s=this,i=this._loader.getHandler("texture");ce.getExtension(e.original)===".json"?He.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){if(n)t(n);else{const a=e.original.replace(".json",".png");s._loader.load(a,"texture",function(l,h){l?t(l):t(null,{data:r,texture:h})})}}):i.load(e,t)}open(e,t){const s=new mS;if(t.texture&&t.data)s.texture=t.texture,s.__data=t.data;else{const n=this._loader.getHandler("texture").open(e,t);if(!n)return null;s.texture=n}return s}patch(e,t){if(!e.resource)return;e.resource.__data&&(e.resource.__data.minfilter!==void 0&&(e.data.minfilter=e.resource.__data.minfilter),e.resource.__data.magfilter!==void 0&&(e.data.magfilter=e.resource.__data.magfilter),e.resource.__data.addressu!==void 0&&(e.data.addressu=e.resource.__data.addressu),e.resource.__data.addressv!==void 0&&(e.data.addressv=e.resource.__data.addressv),e.resource.__data.mipmaps!==void 0&&(e.data.mipmaps=e.resource.__data.mipmaps),e.resource.__data.anisotropy!==void 0&&(e.data.anisotropy=e.resource.__data.anisotropy),e.resource.__data.rgbm!==void 0&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);const s=e.resource.texture;if(s&&(s.name=e.name,e.data.hasOwnProperty("minfilter")&&s.minFilter!==bf[e.data.minfilter]&&(s.minFilter=bf[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&s.magFilter!==bf[e.data.magfilter]&&(s.magFilter=bf[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&s.addressU!==Sf[e.data.addressu]&&(s.addressU=Sf[e.data.addressu]),e.data.hasOwnProperty("addressv")&&s.addressV!==Sf[e.data.addressv]&&(s.addressV=Sf[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&s.mipmaps!==e.data.mipmaps&&(s.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&s.anisotropy!==e.data.anisotropy&&(s.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){const n=e.data.rgbm?Cs:bt;s.type!==n&&(s.type=n)}e.resource.texture=s;const i={};for(const n in e.data.frames){const r=e.data.frames[n];i[n]={rect:new X(r.rect),pivot:new G(r.pivot),border:new X(r.border)}}e.resource.frames=i,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_onAssetChange(e,t,s){let i;if(t==="data"||t==="data.frames"){const n={};for(const r in s.frames)i=s.frames[r],n[r]={rect:new X(i.rect),pivot:new G(i.pivot),border:new X(i.border)};e.resource.frames=n}else{const n=t.match(eU);if(n){const r=n[1];s?(e.resource.frames[r]?(i=e.resource.frames[r],i.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):e.resource.frames[r]={rect:new X(s.rect),pivot:new G(s.pivot),border:new X(s.border)},e.resource.fire("set:frame",r,e.resource.frames[r])):e.resource.frames[r]&&(delete e.resource.frames[r],e.resource.fire("remove:frame",r))}}}}function tU(){const o={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFRGBA4444:16},e={astc:o.cTFASTC_4x4,dxt:o.cTFBC1,etc1:o.cTFETC1,etc2:o.cTFETC1,pvr:o.cTFPVRTC1_4_RGB,atc:o.cTFATC_RGB,none:o.cTFRGB565},t={astc:o.cTFASTC_4x4,dxt:o.cTFBC3,etc1:o.cTFRGBA4444,etc2:o.cTFETC2,pvr:o.cTFPVRTC1_4_RGBA,atc:o.cTFATC_RGBA_INTERPOLATED_ALPHA,none:o.cTFRGBA4444},s={ETC1:21,ETC2_RGB:22,ETC2_RGBA:23,DXT1:8,DXT5:10,PVRTC_4BPP_RGB_1:26,PVRTC_4BPP_RGBA_1:27,ASTC_4x4:28,ATC_RGB:29,ATC_RGBA:30,R8_G8_B8_A8:7,R5_G6_B5:3,R4_G4_B4_A4:5},i=(v,b)=>{switch(v){case o.cTFETC1:return b.formats.etc1?s.ETC1:s.ETC2_RGB;case o.cTFETC2:return s.ETC2_RGBA;case o.cTFBC1:return s.DXT1;case o.cTFBC3:return s.DXT5;case o.cTFPVRTC1_4_RGB:return s.PVRTC_4BPP_RGB_1;case o.cTFPVRTC1_4_RGBA:return s.PVRTC_4BPP_RGBA_1;case o.cTFASTC_4x4:return s.ASTC_4x4;case o.cTFATC_RGB:return s.ATC_RGB;case o.cTFATC_RGBA_INTERPOLATED_ALPHA:return s.ATC_RGBA;case o.cTFRGBA32:return s.R8_G8_B8_A8;case o.cTFRGB565:return s.R5_G6_B5;case o.cTFRGBA4444:return s.R4_G4_B4_A4}},n=v=>{const b=function(T,E){const C=T*.00784313725490196-1,M=E*(2/255)-1,O=Math.sqrt(1-Math.min(1,C*C+M*M));return Math.max(0,Math.min(255,Math.floor((O+1)*.5*255)))};for(let w=0;w<v.length;w+=4){const T=v[w+3],E=v[w+1];v[w+0]=T,v[w+2]=b(T,E),v[w+3]=255}return v},r=v=>{const b=new Uint16Array(v.length/4);for(let w=0;w<v.length;w+=4){const T=v[w+0],E=v[w+1],C=v[w+2];b[w/4]=(T&248)<<8|(E&252)<<3|C>>3}return b},a=(v,b)=>(v&v-1)===0&&(b&b-1)===0,l=()=>typeof performance<"u"?performance.now():0;let h,c,d;const u=(v,b,w)=>{if(w){if(v.formats.astc)return"astc"}else if(b){if(v.formats.etc2)return"etc2"}else if(v.formats.etc1||v.formats.etc2)return"etc1";return(E=>{for(let C=0;C<E.length;++C){const M=E[C];if(v.formats[M])return M}return"none"})(b?d:c)},f=(v,b,w,T)=>{switch(w){case o.cTFETC1:case o.cTFETC2:return!0;case o.cTFBC1:case o.cTFBC3:return(v&3)===0&&(b&3)===0;case o.cTFPVRTC1_4_RGB:case o.cTFPVRTC1_4_RGBA:return a(v,b)&&(v===b||T);case o.cTFASTC_4x4:return!0;case o.cTFATC_RGB:case o.cTFATC_RGBA_INTERPOLATED_ALPHA:return!0}return!1},p=(v,b,w)=>{if(!h.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const T=l(),E=new h.KTX2File(new Uint8Array(b)),C=E.getWidth(),M=E.getHeight(),O=E.getLevels(),I=!!E.getHasAlpha(),B=E.isUASTC&&E.isUASTC();if(!C||!M||!O)throw E.close(),E.delete(),new Error(`Invalid image dimensions url=${v} width=${C} height=${M} levels=${O}`);const P=u(w.deviceDetails,I,B),D=!!w.isGGGR&&P==="pvr";let R;if(D?R=o.cTFRGBA32:(R=I?t[P]:e[P],f(C,M,R,w.deviceDetails.webgl2)||(R=I?o.cTFRGBA32:o.cTFRGB565)),!E.startTranscoding())throw E.close(),E.delete(),new Error("Failed to start transcoding url="+v);let A;const L=[];for(let F=0;F<O;++F){const N=E.getImageTranscodedSizeInBytes(F,0,0,R),V=new Uint8Array(N);if(!E.transcodeImage(V,F,0,0,R,0,-1,-1))throw E.close(),E.delete(),new Error("Failed to transcode image url="+v);const k=R===o.cTFRGB565||R===o.cTFRGBA4444;L.push(k?new Uint16Array(V.buffer):V)}if(E.close(),E.delete(),D)for(R=o.cTFRGB565,A=0;A<L.length;++A)L[A]=r(n(L[A]));return{format:i(R,w.deviceDetails),width:C,height:M,levels:L,cubemap:!1,transcodeTime:l()-T,url:v,unswizzledGGGR:D}},_=(v,b,w)=>{const T=l(),E=new h.BasisFile(new Uint8Array(b)),C=E.getImageWidth(0,0),M=E.getImageHeight(0,0),O=E.getNumImages(),I=E.getNumLevels(0),B=!!E.getHasAlpha(),P=E.isUASTC&&E.isUASTC();if(!C||!M||!O||!I)throw E.close(),E.delete(),new Error(`Invalid image dimensions url=${v} width=${C} height=${M} images=${O} levels=${I}`);const D=u(w.deviceDetails,B,P),R=!!w.isGGGR&&D==="pvr";let A;if(R?A=o.cTFRGBA32:(A=B?t[D]:e[D],f(C,M,A,w.deviceDetails.webgl2)||(A=B?o.cTFRGBA32:o.cTFRGB565)),!E.startTranscoding())throw E.close(),E.delete(),new Error("Failed to start transcoding url="+v);let L;const F=[];for(let N=0;N<I;++N){const V=E.getImageTranscodedSizeInBytes(0,N,A),k=new Uint8Array(V);if(!E.transcodeImage(k,0,N,A,0,0))if(N===I-1&&V===F[N-1].buffer.byteLength)k.set(new Uint8Array(F[N-1].buffer)),console.warn("Failed to transcode last mipmap level, using previous level instead url="+v);else throw E.close(),E.delete(),new Error("Failed to transcode image url="+v);const $=A===o.cTFRGB565||A===o.cTFRGBA4444;F.push($?new Uint16Array(k.buffer):k)}if(E.close(),E.delete(),R)for(A=o.cTFRGB565,L=0;L<F.length;++L)F[L]=r(n(F[L]));return{format:i(A,w.deviceDetails),width:C,height:M,levels:F,cubemap:!1,transcodeTime:l()-T,url:v,unswizzledGGGR:R}},m=(v,b,w)=>w.isKTX2?p(v,b,w):_(v,b,w),g=(v,b,w)=>{try{const T=m(v,b,w);T.levels=T.levels.map(E=>E.buffer),self.postMessage({url:v,data:T},T.levels)}catch(T){self.postMessage({url:v,err:T},null)}},x=(v,b)=>{const w=(T,E)=>(WebAssembly.instantiate(v.module,T).then(C=>{E(C)}).catch(C=>{console.error("instantiate failed + "+C)}),{});self.BASIS(v.module?{instantiateWasm:w}:null).then(T=>{T.initializeBasis(),h=T,c=v.rgbPriority,d=v.rgbaPriority,b(null)})},S=[];self.onmessage=v=>{const b=v.data;switch(b.type){case"init":x(b.config,()=>{for(let w=0;w<S.length;++w)g(S[w].url,S[w].data,S[w].options);S.length=0});break;case"transcode":h?g(b.url,b.data,b.options):S.push(b);break}}}const sU=o=>({astc:!!o.extCompressedTextureASTC,atc:!!o.extCompressedTextureATC,dxt:!!o.extCompressedTextureS3TC,etc1:!!o.extCompressedTextureETC1,etc2:!!o.extCompressedTextureETC,pvr:!!o.extCompressedTexturePVRTC}),iU=(o,e)=>{const t=r=>{const a=["/* basis */",r,"","("+tU.toString()+`)()

`].join(`
`);return new Blob([a],{type:"application/javascript"})},s=()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){const r=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(r instanceof WebAssembly.Module)return new WebAssembly.Instance(r)instanceof WebAssembly.Instance}}catch{}return!1},i=(r,a)=>{e(null,{workerUrl:URL.createObjectURL(t(r)),module:a,rgbPriority:o.rgbPriority,rgbaPriority:o.rgbaPriority})},n={cache:!0,responseType:"text",retry:o.maxRetries>0,maxRetries:o.maxRetries};if(o.glueUrl&&o.wasmUrl&&s()){let r=null,a=null;He.get(o.glueUrl,n,(c,d)=>{c?e(c):a?i(d,a):r=d});const l=fetch(o.wasmUrl),h=()=>{l.then(c=>c.arrayBuffer()).then(c=>WebAssembly.compile(c)).then(c=>{r?i(r,c):a=c}).catch(c=>{e(c,null)})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(l).then(c=>{r?i(r,c):a=c}).catch(c=>{h()}):h()}else He.get(o.fallbackUrl,n,(r,a)=>{r?e(r,null):i(a,null)})};class nU{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(e,t,s,i){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(s);else{this.callbacks[e]=[s];const n={url:e,data:t,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e)}handleResponse(e,t,s){const i=this.callbacks[e];if(t)for(let n=0;n<i.length;++n)i[n](t);else{s.format===Rn||s.format===Ar?s.levels=s.levels.map(function(n){return new Uint16Array(n)}):s.levels=s.levels.map(function(n){return new Uint8Array(n)});for(let n=0;n<i.length;++n)i[n](null,s)}delete this.callbacks[e]}}class rU{constructor(e,t,s){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",i=>{const n=i.data;this.queue.handleResponse(n.url,n.err,n.data),this.eager||this.queue.enqueueClient(this)}),this.worker.postMessage({type:"init",config:t}),this.eager=s}run(e){const t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this)}}const aU=1,oU=["etc1","etc2","astc","dxt","pvr","atc"],lU=["astc","dxt","etc2","pvr","atc"],hU=5,Vg=new nU;let Ew=null,Gg=!1;function Tf(o){if(!Gg){if(!o)o=Ew||{};else if(o.lazyInit){Ew=o;return}if(!o.glueUrl||!o.wasmUrl||!o.fallbackUrl){const e=za.getConfig("BASIS");e&&(o={glueUrl:e.glueUrl,wasmUrl:e.wasmUrl,fallbackUrl:e.fallbackUrl,numWorkers:e.numWorkers})}if(o.glueUrl||o.wasmUrl||o.fallbackUrl){Gg=!0;const e=Math.max(1,Math.min(16,o.numWorkers||aU)),t=o.numWorkers===1||(o.hasOwnProperty("eagerWorkers")?o.eagerWorkers:!0);o.rgbPriority=o.rgbPriority||oU,o.rgbaPriority=o.rgbaPriority||lU,o.maxRetries=o.hasOwnProperty("maxRetries")?o.maxRetries:hU,iU(o,(s,i)=>{if(s)console.error(`failed to initialize basis worker: ${s}`);else for(let n=0;n<e;++n)Vg.enqueueClient(new rU(Vg,i,t))})}}}let Wg=null;function Aw(o,e,t,s,i){return Tf(),Wg||(Wg={webgl2:o.isWebGL2,formats:sU(o)}),Vg.enqueueJob(e,t,s,{deviceDetails:Wg,isGGGR:!!(i!=null&&i.isGGGR),isKTX2:!!(i!=null&&i.isKTX2)}),Gg}class cU{constructor(e,t){this.device=t,this.maxRetries=0}load(e,t,s){const i=this.device,n=r=>{var a;Aw(i,e.load,r,t,{isGGGR:((s==null||(a=s.file)==null||(a=a.variants)==null||(a=a.basis)==null?void 0:a.opt)&8)!==0})||t(`Basis module not found. Asset '${s.name}' basis texture variant will not be loaded.`)};se.fetchArrayBuffer(e.load,(r,a)=>{r?t(r):n(a)},s,this.maxRetries)}open(e,t,s,i={}){const n=new re(s,gt({name:e,addressU:t.cubemap?q:Qe,addressV:t.cubemap?q:Qe,width:t.width,height:t.height,format:t.format,cubemap:t.cubemap,levels:t.levels},i));return n.upload(),n}}class dU{constructor(e,t){this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.device=t}load(e,t,s){var i;const n=!!(s!=null&&(i=s.file)!=null&&i.contents);if(n){if(this.device.supportsImageBitmap){this._loadImageBitmapFromBlob(new Blob([s.file.contents]),t);return}e={load:URL.createObjectURL(new Blob([s.file.contents])),original:e.original}}const r=(l,h)=>{n&&URL.revokeObjectURL(e.load),t(l,h)};let a;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?a=s.options.crossOrigin:ua.test(e.load)&&(a=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,a,r):this._loadImage(e.load,e.original,a,r)}open(e,t,s,i={}){const n=new re(s,gt({name:e,width:t.width,height:t.height,format:oe},i));return n.setSource(t),n}_loadImage(e,t,s,i){const n=new Image;s&&(n.crossOrigin=s);let r=0;const a=this.maxRetries;let l;n.onload=function(){i(null,n)},n.onerror=function(){if(!l)if(a>0&&++r<=a){const h=Math.pow(2,r)*100;console.log(`Error loading Texture from: '${t}' - Retrying in ${h}ms...`);const d=e.indexOf("?")>=0?"&":"?";l=setTimeout(function(){n.src=e+d+"retry="+Date.now(),l=null},h)}else i(`Error loading Texture from: '${t}'`)},n.src=e}_loadImageBitmap(e,t,s,i){const n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};He.get(e,n,(r,a)=>{r?i(r):this._loadImageBitmapFromBlob(a,i)})}_loadImageBitmapFromBlob(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(s=>t(null,s)).catch(s=>t(s))}}const Hg=[1481919403,3140563232,169478669],uU={33776:ja,33778:zl,33779:Cr,36196:Ya,37492:Wl,37496:Hl,35840:Ka,35841:Rr,35842:Za,35843:Ir,32849:Es,32856:oe,35905:Vl,35907:Gl,35898:Ln,34843:Mr,34842:et};function fU(o,e,t,s){return o===Ln?new Uint32Array(e,t,s/4):new Uint8Array(e,t,s)}class pU{constructor(e){this.maxRetries=0}load(e,t,s){se.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const n=this.parse(t);if(!n)return null;const r=new re(s,gt({name:e,addressU:n.cubemap?q:Qe,addressV:n.cubemap?q:Qe,width:n.width,height:n.height,format:n.format,cubemap:n.cubemap,levels:n.levels},i));return r.upload(),r}parse(e){const t=new Uint32Array(e);if(Hg[0]!==t[0]||Hg[1]!==t[1]||Hg[2]!==t[2])return null;const s={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(s.pixelDepth>1||s.numberOfArrayElements!==0)return null;const i=uU[s.glInternalFormat];if(i===void 0)return null;let n=16+s.bytesOfKeyValueData/4;const r=s.numberOfFaces>1,a=[];for(let l=0;l<(s.numberOfMipmapLevels||1);l++){const h=t[n++];r&&a.push([]);const c=r?a[l]:a;for(let d=0;d<(r?6:1);++d)c.push(fU(i,e,n*4,h)),n+=h+3>>2}return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:a,cubemap:r}}}const mU={KHR_DF_MODEL_ETC1S:163,KHR_DF_MODEL_UASTC:166};class _U{constructor(e,t){this.maxRetries=0,this.device=t}load(e,t,s){se.fetchArrayBuffer(e.load,(i,n)=>{i?t(i,n):this.parse(n,e,t,s)},s,this.maxRetries)}open(e,t,s,i={}){const n=new re(s,gt({name:e,addressU:t.cubemap?q:Qe,addressV:t.cubemap?q:Qe,width:t.width,height:t.height,format:t.format,cubemap:t.cubemap,levels:t.levels},i));return n.upload(),n}parse(e,t,s,i){const n=new ep(e),r=[n.readU32be(),n.readU32be(),n.readU32be()];if(r[0]!==2873840728||r[1]!==540160187||r[2]!==218765834)return null;const a={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},l={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},h=[];for(let f=0;f<Math.max(1,a.levelCount);++f)h.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==l.kvdByteOffset-l.dfdByteOffset)return null;n.skip(8);const d=n.readU8();if(n.skip(l.dfdByteLength-9),n.skip(l.kvdByteLength),a.supercompressionScheme===1||d===mU.KHR_DF_MODEL_UASTC){var u;Aw(this.device,t.load,e,s,{isGGGR:((i==null||(u=i.file)==null||(u=u.variants)==null||(u=u.basis)==null?void 0:u.opt)&8)!==0,isKTX2:!0})||s('Basis module not found. Asset "'+i.name+'" basis texture variant will not be loaded.')}else s("unsupported KTX2 pixel format")}}class gU{constructor(e){this.maxRetries=0}load(e,t,s){se.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const n=new Uint32Array(t,0,32),r=n[4],a=n[3],l=Math.max(n[7],1),h=n[20]===4,c=n[21],d=n[22],u=n[28]===65024,f=827611204,p=894720068,_=113,m=116,g=826496069,x=825438800,S=825504336,v=825439312,b=825504848;let w=!1,T=!1,E=!1,C=!1,M=null,O=1,I;if(h?c===f?(M=ja,w=!0):c===p?(M=Cr,w=!0):c===_?(M=et,O=2):c===m?(M=Ge,O=4):c===g?(M=Ya,w=!0,T=!0):c===x||c===S?(M=c===x?Rr:Ir,w=!0,E=!0):(c===v||c===b)&&(M=c===v?Ka:Za,w=!0,C=!0):d===32&&(M=oe),!M)return I=new re(s,{width:4,height:4,format:Es,name:"dds-legacy-empty"}),I;I=new re(s,gt({name:e,addressU:u?q:Qe,addressV:u?q:Qe,width:r,height:a,format:M,cubemap:u,mipmaps:l>1},i));let B=128;const P=u?6:1;let D;const R=4,A=4,L=c===f?8:16;let F,N,V;for(let k=0;k<P;k++){let $=r,j=a;for(let K=0;K<l;K++){w?T?D=Math.floor(($+3)/4)*Math.floor((j+3)/4)*8:E?D=Math.max($,16)*Math.max(j,8)/4:C?D=Math.max($,8)*Math.max(j,8)/2:(F=Math.floor(($+R-1)/R),N=Math.floor((j+A-1)/A),V=F*N,D=V*L):D=$*j*4;const ee=M===Ge?new Float32Array(t,B,D):M===et?new Uint16Array(t,B,D):new Uint8Array(t,B,D);u?(I._levels[K]||(I._levels[K]=[]),I._levels[K][k]=ee):I._levels[K]=ee,B+=D*O,$=Math.max($*.5,1),j=Math.max(j*.5,1)}}return I.upload(),I}}class yU{constructor(e){this.maxRetries=0}load(e,t,s){se.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const n=this.parse(t);if(!n)return null;const r=new re(s,gt({name:e,addressU:Qe,addressV:q,minFilter:de,magFilter:de,width:n.width,height:n.height,levels:n.levels,format:oe,type:pd,mipmaps:!1},i));return r.upload(),r}parse(e){const t=new ep(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;const i={};for(;;){const h=t.readLine();if(h.length===0)break;{const c=h.split("=");c.length===2&&(i[c[0]]=c[1])}}if(!i.hasOwnProperty("FORMAT"))return null;const n=t.readLine().split(" ");if(n.length!==4)return null;const r=parseInt(n[1],10),a=parseInt(n[3],10),l=this._readPixels(t,a,r,n[0]==="-Y");return l?{width:a,height:r,levels:[l]}:null}_readPixels(e,t,s,i){if(t<8||t>32767)return this._readPixelsFlat(e,t,s);const n=[0,0,0,0];if(e.readArray(n),n[0]!==2||n[1]!==2||n[2]&128)return e.skip(-4),this._readPixelsFlat(e,t,s);const r=new ArrayBuffer(t*s*4),a=new Uint8Array(r);let l=i?0:t*4*(s-1),h,c,d,u,f,p;for(c=0;c<s;++c){if(c&&e.readArray(n),(n[2]<<8)+n[3]!==t)return null;for(u=0;u<4;++u)for(h=0;h<t;)if(f=e.readU8(),f>128){if(f-=128,h+f>t)return null;for(p=e.readU8(),d=0;d<f;++d)a[l+u+4*h++]=p}else{if(f===0||h+f>t)return null;for(d=0;d<f;++d)a[l+u+4*h++]=e.readU8()}l+=t*4*(i?1:-1)}return a}_readPixelsFlat(e,t,s){return e.remainingBytes===t*s*4?new Uint8Array(e.arraybuffer,e.offset):null}}const Cw={repeat:Qe,clamp:q,mirror:Ha},Mw={nearest:de,linear:Oe,nearest_mip_nearest:Tr,linear_mip_nearest:Er,nearest_mip_linear:wr,linear_mip_linear:Qs},vU={default:bt,rgbm:Cs,rgbe:pd,rgbp:Or,swizzleGGGR:Br};class xU{load(e,t,s){throw new Error("not implemented")}open(e,t,s){throw new Error("not implemented")}}const SU=function(e){const t=Ii.calcMipLevelsCount(e._width,e._height),s=function(r){return r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof HTMLVideoElement};if(!(e._format===oe||e._format===Ge)||e._volume||e._compressed||e._levels.length===1||e._levels.length===t||s(e._cubemap?e._levels[0][0]:e._levels[0]))return;const i=function(r,a,l){const h=Math.max(1,r>>1),c=Math.max(1,a>>1),d=new l.constructor(h*c*4),u=Math.floor(r/h),f=Math.floor(a/c),p=u*f;for(let _=0;_<c;++_)for(let m=0;m<h;++m)for(let g=0;g<4;++g){let x=0;for(let S=0;S<f;++S)for(let v=0;v<u;++v)x+=l[(m*u+v+(_*f+S)*r)*4+g];d[(m+_*h)*4+g]=x/p}return d};for(let n=e._levels.length;n<t;++n){const r=Math.max(1,e._width>>n-1),a=Math.max(1,e._height>>n-1);if(e._cubemap){const l=[];for(let h=0;h<6;++h)l.push(i(r,a,e._levels[n-1][h]));e._levels.push(l)}else e._levels.push(i(r,a,e._levels[n-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]};class Pw extends Le{constructor(e){super(e,"texture");const t=e.assets,s=e.graphicsDevice;this._device=s,this._assets=t,this.imgParser=new dU(t,s),this.parsers={dds:new gU(t),ktx:new pU(t),ktx2:new _U(t,s),basis:new cU(t,s),hdr:new yU(t)}}set crossOrigin(e){this.imgParser.crossOrigin=e}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){this.imgParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=ce.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}_getTextureOptions(e){const t={};if(e){var s;((s=e.name)==null?void 0:s.length)>0&&(t.name=e.name);const i=e.data;i.hasOwnProperty("minfilter")&&(t.minFilter=Mw[i.minfilter]),i.hasOwnProperty("magfilter")&&(t.magFilter=Mw[i.magfilter]),i.hasOwnProperty("addressu")&&(t.addressU=Cw[i.addressu]),i.hasOwnProperty("addressv")&&(t.addressV=Cw[i.addressv]),i.hasOwnProperty("mipmaps")&&(t.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(t.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(t.flipY=!!i.flipY),i.hasOwnProperty("type")?t.type=vU[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?t.type=Cs:e.file&&e.file.opt&8&&(t.type=Br)}return t}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){if(!e)return;const i=this._getTextureOptions(s);let n=this._getParser(e).open(e,t,this._device,i);return n===null?n=new re(this._device,{width:4,height:4,format:Es}):(SU(n),t.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),n}patch(e,t){const s=e.resource;if(!s)return;const i=this._getTextureOptions(e);for(const n of Object.keys(i))s[n]=i[n]}}const Rw="inline",Iw="immersive-vr",vl="immersive-ar",Dw="viewer",bU="local",TU="local-floor",wU="bounded-floor",EU="unbounded",AU="gaze",CU="screen",MU="tracked-pointer",PU="none",RU="left",IU="right",DU="none",Lw="left",LU="right",FU="point",OU="plane",BU="mesh",Fw="cpu-optimized",Ow="gpu-optimized",Xg="luminance-alpha",Bw="float32";class Fc extends Q{constructor(e){super(),this._manager=void 0,this._views=void 0,this._available=!1,this._evtDepthResize=null,this._uvMatrix=W.IDENTITY.clone(),this._manager=e,this._views=e.views,this._views.supportedDepth&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){var e;this._views.availableDepth&&(this._evtDepthResize=(e=this._views.list[0])==null?void 0:e.on("depth:resize",this._onDepthResize,this))}_onSessionEnd(){this._evtDepthResize&&(this._evtDepthResize.off(),this._evtDepthResize=null),this._available&&(this._available=!1,this.fire("unavailable"))}_onDepthResize(e,t){this.fire("resize",e,t)}getDepth(e,t){var s,i;return(s=(i=this._views.list[0])==null?void 0:i.getDepth(e,t))!=null?s:null}update(){this._manager.session&&this.supported&&this._views.availableDepth&&this._views.list.length&&!this._available&&(this._available=!0,this.fire("available"))}get supported(){return this._views.supportedDepth}get available(){return this._views.availableDepth}get usage(){return this._views.depthUsage}get dataFormat(){return this._views.depthFormat}get width(){var e,t;return(e=(t=this._views.list[0])==null||(t=t.textureDepth)==null?void 0:t.width)!=null?e:0}get height(){var e,t;return(e=(t=this._views.list[0])==null||(t=t.textureDepth)==null?void 0:t.height)!=null?e:0}get texture(){var e;return(e=this._views.list[0])==null?void 0:e.textureDepth}get uvMatrix(){var e,t;return(e=(t=this._views.list[0])==null?void 0:t.depthUvMatrix)!=null?e:this._uvMatrix}get rawValueToMeters(){var e,t;return(e=(t=this._views.list[0])==null?void 0:t.depthValueToMeters)!=null?e:0}}Fc.EVENT_AVAILABLE="available",Fc.EVENT_UNAVAILABLE="unavailable",Fc.EVENT_RESIZE="resize";class Nw{constructor(e){this._manager=void 0,this._supported=ge.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState!==null}get state(){return!this._supported||!this._manager.active||!this._manager._session.domOverlayState?null:this._manager._session.domOverlayState.type}set root(e){!this._supported||this._manager.active||(this._root=e)}get root(){return this._root}}const wf=[],kw=[];class Ef extends Q{constructor(e,t,s,i=null){super(),this.manager=void 0,this._xrHitTestSource=void 0,this._transient=void 0,this._inputSource=void 0,this.manager=e,this._xrHitTestSource=t,this._transient=s,this._inputSource=i}remove(){if(!this._xrHitTestSource)return;const e=this.manager.hitTest.sources,t=e.indexOf(this);t!==-1&&e.splice(t,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(e){if(this._transient){const t=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let s=0;s<t.length;s++){const i=t[s];if(!i.results.length)continue;let n;i.inputSource&&(n=this.manager.input._getByInputSource(i.inputSource)),this.updateHitResults(i.results,n)}}else{const t=e.getHitTestResults(this._xrHitTestSource);if(!t.length)return;this.updateHitResults(t)}}updateHitResults(e,t){var s,i,n;if(this._inputSource&&this._inputSource!==t)return;const r=(s=wf.pop())!=null?s:new y;t?r.copy(t.getOrigin()):r.copy(this.manager.camera.getPosition());let a=1/0,l=null;const h=(i=wf.pop())!=null?i:new y,c=(n=kw.pop())!=null?n:new Z;for(let d=0;d<e.length;d++){const u=e[d].getPose(this.manager._referenceSpace),f=r.distance(u.transform.position);f>=a||(a=f,l=e[d],h.copy(u.transform.position),c.copy(u.transform.orientation))}this.fire("result",h,c,t||this._inputSource,l),this.manager.hitTest.fire("result",this,h,c,t||this._inputSource,l),wf.push(r),wf.push(h),kw.push(c)}}Ef.EVENT_REMOVE="remove",Ef.EVENT_RESULT="result";class fr extends Q{constructor(e){super(),this.manager=void 0,this._supported=ge.browser&&!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource),this._available=!1,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const e=this.manager.session.enabledFeatures.indexOf("hit-test")!==-1;e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(this._available){this._available=!1;for(let e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable")}}start(e={}){if(!this._supported){e.callback==null||e.callback(new Error("XR HitTest is not supported"),null);return}if(!this._available){e.callback==null||e.callback(new Error("XR HitTest is not available"),null);return}!e.profile&&!e.spaceType&&(e.spaceType=Dw);let t;const s=e.offsetRay;if(s){const n=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),r=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);t=new XRRay(n,r)}const i=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then(n=>{if(!this.manager.session){const r=new Error("XR Session is not started (2)");i&&i(r),this.fire("error",r);return}this.manager.session.requestHitTestSource({space:n,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(r=>{this._onHitTestSource(r,!1,e.inputSource,i)}).catch(r=>{i&&i(r),this.fire("error",r)})}).catch(n=>{i&&i(n),this.fire("error",n)}):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(n=>{this._onHitTestSource(n,!0,e.inputSource,i)}).catch(n=>{i&&i(n),this.fire("error",n)})}_onHitTestSource(e,t,s,i){if(!this.manager.session){e.cancel();const r=new Error("XR Session is not started (3)");i&&i(r),this.fire("error",r);return}const n=new Ef(this.manager,e,t,s??null);this.sources.push(n),i&&i(null,n),this.fire("add",n)}update(e){for(let t=0;t<this.sources.length;t++)this.sources[t].update(e)}get supported(){return this._supported}get available(){return this._available}}fr.EVENT_AVAILABLE="available",fr.EVENT_UNAVAILABLE="unavailable",fr.EVENT_ADD="add",fr.EVENT_REMOVE="remove",fr.EVENT_RESULT="result",fr.EVENT_ERROR="error";class Af extends Q{constructor(e,t){super(),this._image=void 0,this._width=void 0,this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new y,this._rotation=new Z,this._image=e,this._width=t}get image(){return this._image}set width(e){this._width=e}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width}))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}Af.EVENT_TRACKED="tracked",Af.EVENT_UNTRACKED="untracked";class $g extends Q{constructor(e){super(),this._manager=void 0,this._supported=ge.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(e,t){if(!this._supported||this._manager.active)return null;const s=new Af(e,t);return this._images.push(s),s}remove(e){if(this._manager.active)return;const t=this._images.indexOf(e);t!==-1&&(e.destroy(),this._images.splice(t,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then(e=>{this._available=!0;for(let t=0;t<e.length;t++)this._images[t]._trackable=e[t]==="trackable"}).catch(e=>{this._available=!1,this.fire("error",e)})}_onSessionEnd(){this._available=!1;for(let e=0;e<this._images.length;e++){const t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=!1,t.fire("untracked"))}}prepareImages(e){this._images.length?Promise.all(this._images.map(function(t){return t.prepare()})).then(function(t){e(null,t)}).catch(function(t){e(t,null)}):e(null,null)}update(e){if(!this._available)return;const t=e.getImageTrackingResults(),s={};for(let i=0;i<t.length;i++){s[t[i].index]=t[i];const n=this._images[t[i].index];n._emulated=t[i].trackingState==="emulated",n._measuredWidth=t[i].measuredWidthInMeters,n._pose=e.getPose(t[i].imageSpace,this._manager._referenceSpace)}for(let i=0;i<this._images.length;i++)this._images[i]._tracking&&!s[i]?(this._images[i]._tracking=!1,this._images[i].fire("untracked")):!this._images[i]._tracking&&s[i]&&(this._images[i]._tracking=!0,this._images[i].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}$g.EVENT_ERROR="error";class Uw{constructor(e,t){this._index=void 0,this._hand=void 0,this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const zw=ge.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],Vw={};for(let o=0;o<zw.length;o++)Vw[zw[o]]=!0;class qg{constructor(e,t,s,i=null){this._index=void 0,this._id=void 0,this._hand=void 0,this._finger=void 0,this._wrist=void 0,this._tip=void 0,this._radius=null,this._localTransform=new W,this._worldTransform=new W,this._localPosition=new y,this._localRotation=new Z,this._position=new y,this._rotation=new Z,this._dirtyLocal=!0,this._index=e,this._id=t,this._hand=s,this._finger=i,this._wrist=t==="wrist",this._tip=this._finger&&!!Vw[t]}update(e){this._dirtyLocal=!0,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,y.ONE));const t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let Cf=[];const Fa=new y,Mf=new y,Gw=new y;ge.browser&&window.XRHand&&(Cf=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class Pf extends Q{constructor(e){super(),this._manager=void 0,this._inputSource=void 0,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){const s=new qg(0,"wrist",this,null);this._wrist=s,this._joints.push(s),this._jointsById.wrist=s}for(let s=0;s<Cf.length;s++){const i=new Uw(s,this);for(let n=0;n<Cf[s].length;n++){const r=Cf[s][n];if(!t.get(r))continue;const a=new qg(n,r,this,i);this._joints.push(a),this._jointsById[r]=a,a.tip&&(this._tips.push(a),i._tip=a),i._joints.push(a)}}}update(e){const t=this._inputSource._xrInputSource;for(let c=0;c<this._joints.length;c++){const d=this._joints[c],u=t.hand.get(d._id);if(u){let f;if(e.session.visibilityState!=="hidden"&&(f=e.getJointPose(u,this._manager._referenceSpace)),f)d.update(f),d.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(d.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],r=this._jointsById["index-finger-tip"],a=this._jointsById["ring-finger-phalanx-proximal"],l=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&r&&a&&l){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,r._localPosition,.5);let c=s,d=l;if(this._inputSource.handedness===Lw){const u=c;c=d,d=u}Fa.sub2(c._localPosition,this._wrist._localPosition),Mf.sub2(d._localPosition,this._wrist._localPosition),Gw.cross(Fa,Mf).normalize(),Fa.lerp(n._localPosition,a._localPosition,.5),Fa.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(Gw,Fa,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(e){const t=this._fingers[e];return Fa.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),Mf.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),Fa.dot(Mf)<-.8}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}Pf.EVENT_TRACKING="tracking",Pf.EVENT_TRACKINGLOST="trackinglost";const Ww=new y,Hw=new Z;let NU=0;class Wt extends Q{constructor(e,t){super(),this._id=void 0,this._manager=void 0,this._xrInputSource=void 0,this._ray=new Mn,this._rayLocal=new Mn,this._grip=!1,this._hand=null,this._velocitiesAvailable=!1,this._velocitiesTimestamp=jt(),this._localTransform=null,this._worldTransform=null,this._position=new y,this._rotation=new Z,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++NU,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new Pf(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else{const t=this._xrInputSource.gripSpace;if(t){const i=e.getPose(t,this._manager._referenceSpace);if(i){this._grip||(this._grip=!0,this._localTransform=new W,this._worldTransform=new W,this._localPositionLast=new y,this._localPosition=new y,this._localRotation=new Z,this._linearVelocity=new y);const n=jt(),r=(n-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=n,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(i.transform.position),this._localRotation.copy(i.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&i.linearVelocity?this._linearVelocity.copy(i.linearVelocity):r>0&&(Ww.sub2(this._localPosition,this._localPositionLast).divScalar(r),this._linearVelocity.lerp(this._linearVelocity,Ww,.15))}else this._velocitiesAvailable=!1}const s=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=!0,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),Hw.copy(s.transform.orientation),Hw.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,y.ONE));const e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const e=this._dirtyRay;if(this._dirtyRay=!1,this._manager.camera.parent){const s=this._manager.camera.parent.getWorldTransform();s.getTranslation(this._position),this._rotation.setFromMat4(s),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e={}){e.inputSource=this,e.profile=this._xrInputSource.profiles[0];const t=e.callback;e.callback=(s,i)=>{i&&this.onHitTestSourceAdd(i),t&&t(s,i)},this._manager.hitTest.start(e)}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",(t,s,i,n)=>{i===this&&this.fire("hittest:result",e,t,s,n)}),e.once("remove",()=>{this.onHitTestSourceRemove(e),this.fire("hittest:remove",e)})}onHitTestSourceRemove(e){const t=this._hitTestSources.indexOf(e);t!==-1&&this._hitTestSources.splice(t,1)}}Wt.EVENT_REMOVE="remove",Wt.EVENT_SELECT="select",Wt.EVENT_SELECTSTART="selectstart",Wt.EVENT_SELECTEND="selectend",Wt.EVENT_SQUEEZE="squeeze",Wt.EVENT_SQUEEZESTART="squeezestart",Wt.EVENT_SQUEEZEEND="squeezeend",Wt.EVENT_HITTESTADD="hittest:add",Wt.EVENT_HITTESTREMOVE="hittest:remove",Wt.EVENT_HITTESTRESULT="hittest:result";class Vi extends Q{constructor(e){var t;super(),this.manager=void 0,this._inputSources=[],this._onInputSourcesChangeEvt=void 0,this.velocitiesSupported=!1,this.manager=e,this.velocitiesSupported=!!(ge.browser&&(t=window.XRPose)!=null&&(t=t.prototype)!=null&&t.hasOwnProperty("linearVelocity")),this._onInputSourcesChangeEvt=s=>{this._onInputSourcesChange(s)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("select",s),this.fire("select",i,s)}),e.addEventListener("selectstart",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!0,i.fire("selectstart",s),this.fire("selectstart",i,s)}),e.addEventListener("selectend",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!1,i.fire("selectend",s),this.fire("selectend",i,s)}),e.addEventListener("squeeze",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("squeeze",s),this.fire("squeeze",i,s)}),e.addEventListener("squeezestart",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!0,i.fire("squeezestart",s),this.fire("squeezestart",i,s)}),e.addEventListener("squeezeend",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!1,i.fire("squeezeend",s),this.fire("squeezeend",i,s)});const t=e.inputSources;for(let s=0;s<t.length;s++)this._addInputSource(t[s])}_onSessionEnd(){let e=this._inputSources.length;for(;e--;){const s=this._inputSources[e];this._inputSources.splice(e,1),s.fire("remove"),this.fire("remove",s)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(e){for(let t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(let t=0;t<e.added.length;t++)this._addInputSource(e.added[t])}_getByInputSource(e){for(let t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(this._getByInputSource(e))return;const t=new Wt(this.manager,e);this._inputSources.push(t),this.fire("add",t)}_removeInputSource(e){for(let t=0;t<this._inputSources.length;t++){if(this._inputSources[t].inputSource!==e)continue;const s=this._inputSources[t];this._inputSources.splice(t,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();s.fire("remove"),this.fire("remove",s);return}}update(e){for(let t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)}get inputSources(){return this._inputSources}}Vi.EVENT_ADD="add",Vi.EVENT_REMOVE="remove",Vi.EVENT_SELECT="select",Vi.EVENT_SELECTSTART="selectstart",Vi.EVENT_SELECTEND="selectend",Vi.EVENT_SQUEEZE="squeeze",Vi.EVENT_SQUEEZESTART="squeezestart",Vi.EVENT_SQUEEZEEND="squeezeend";const xl=new y,Xw=new y,jg=new W,$w=new W;class Rf extends Q{constructor(e){super(),this._manager=void 0,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new Z,this._color=new H,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let e;if(this._manager.session||(e=new Error("XR session is not running")),!e&&this._manager.type!==vl&&(e=new Error("XR session type is not AR")),!e&&!this._supported&&(e=new Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=new Error("light estimation is already requested")),e){this.fire("error",e);return}this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(t=>{const s=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?s&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))}).catch(t=>{this._lightProbeRequested=!1,this.fire("error",t)})}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(e){if(!this._lightProbe)return;const t=e.getLightEstimate(this._lightProbe);if(!t)return;this._available||(this._available=!0,this.fire("available"));const s=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),xl.copy(s).mulScalar(1/this._intensity),this._color.set(xl.x,xl.y,xl.z),xl.set(0,0,0),Xw.copy(t.primaryLightDirection),jg.setLookAt(Xw,xl,y.UP),$w.setFromAxisAngle(y.RIGHT,90),jg.mul($w),this._rotation.setFromMat4(jg),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}Rf.EVENT_AVAILABLE="available",Rf.EVENT_ERROR="error";let kU=0;class If extends Q{constructor(e,t){super(),this._id=void 0,this._planeDetection=void 0,this._xrPlane=void 0,this._lastChangedTime=void 0,this._orientation=void 0,this._position=new y,this._rotation=new Z,this._id=++kU,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation}destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))}update(e){const t=this._planeDetection._manager,s=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}}If.EVENT_REMOVE="remove",If.EVENT_CHANGE="change";class Sl extends Q{constructor(e){super(),this._manager=void 0,this._supported=ge.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this._supported&&this._manager.session.enabledFeatures.indexOf("plane-detection")!==-1&&(this._available=!0,this.fire("available"))}_onSessionEnd(){for(let e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))}update(e){if(!this._supported||!this._available)return;const t=e.detectedPlanes;for(const[s,i]of this._planesIndex)t.has(s)||(this._planesIndex.delete(s),this._planes.splice(this._planes.indexOf(i),1),i.destroy(),this.fire("remove",i));for(const s of t){let i=this._planesIndex.get(s);i?i.update(e):(i=new If(this,s),this._planesIndex.set(s,i),this._planes.push(i),i.update(e),this.fire("add",i))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}Sl.EVENT_AVAILABLE="available",Sl.EVENT_UNAVAILABLE="unavailable",Sl.EVENT_ADD="add",Sl.EVENT_REMOVE="remove";class bl extends Q{constructor(e,t,s=null){super(),this._position=new y,this._rotation=new Z,this._uuid=null,this._uuidRequests=null,this._anchors=e,this._xrAnchor=t,this._uuid=s}destroy(){if(!this._xrAnchor)return;const e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this)}update(e){if(!this._xrAnchor)return;const t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change")}}getPosition(){return this._position}getRotation(){return this._rotation}persist(e){if(!this._anchors.persistence){e==null||e(new Error("Persistent Anchors are not supported"),null);return}if(this._uuid){e==null||e(null,this._uuid);return}if(this._uuidRequests){e&&this._uuidRequests.push(e);return}this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then(t=>{this._uuid=t,this._anchors._indexByUuid.set(this._uuid,this),e==null||e(null,t);for(let s=0;s<this._uuidRequests.length;s++)this._uuidRequests[s](null,t);this._uuidRequests=null,this.fire("persist",t)}).catch(t=>{e==null||e(t,null);for(let s=0;s<this._uuidRequests.length;s++)this._uuidRequests[s](t);this._uuidRequests=null})}forget(e){if(!this._uuid){e==null||e(new Error("Anchor is not persistent"));return}this._anchors.forget(this._uuid,t=>{this._uuid=null,e==null||e(t),this.fire("forget")})}get uuid(){return this._uuid}get persistent(){return!!this._uuid}}bl.EVENT_DESTROY="destroy",bl.EVENT_CHANGE="change",bl.EVENT_PERSIST="persist",bl.EVENT_FORGET="forget";class Oa extends Q{constructor(e){var t;super(),this.manager=void 0,this._supported=ge.browser&&!!window.XRAnchor,this._available=!1,this._persistence=ge.browser&&!!((t=window)!=null&&(t=t.XRSession)!=null&&t.prototype.restorePersistentAnchor),this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const e=this.manager.session.enabledFeatures.indexOf("anchors")!==-1;e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(!this._available)return;this._available=!1;for(let t=0;t<this._creationQueue.length;t++)this._creationQueue[t].callback&&this._creationQueue[t].callback(new Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let e=this._list.length;for(;e--;)this._list[e].destroy();this._list.length=0,this.fire("unavailable")}_createAnchor(e,t=null){const s=new bl(this,e,t);return this._index.set(e,s),t&&this._indexByUuid.set(t,s),this._list.push(s),s.once("destroy",this._onAnchorDestroy,this),s}_onAnchorDestroy(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);const s=this._list.indexOf(t);s!==-1&&this._list.splice(s,1),this.fire("destroy",t)}create(e,t,s){if(!this._available){s==null||s(new Error("Anchors API is not available"),null);return}if(window.XRHitTestResult&&e instanceof XRHitTestResult){const i=e;if(s=t,!this._supported){s==null||s(new Error("Anchors API is not supported"),null);return}if(!i.createAnchor){s==null||s(new Error("Creating Anchor from Hit Test is not supported"),null);return}i.createAnchor().then(n=>{const r=this._createAnchor(n);s==null||s(null,r),this.fire("add",r)}).catch(n=>{s==null||s(n,null),this.fire("error",n)})}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:s})}restore(e,t){if(!this._available){t==null||t(new Error("Anchors API is not available"),null);return}if(!this._persistence){t==null||t(new Error("Anchor Persistence is not supported"),null);return}if(!this.manager.active){t==null||t(new Error("WebXR session is not active"),null);return}this.manager.session.restorePersistentAnchor(e).then(s=>{const i=this._createAnchor(s,e);t==null||t(null,i),this.fire("add",i)}).catch(s=>{t==null||t(s,null),this.fire("error",s)})}forget(e,t){if(!this._available){t==null||t(new Error("Anchors API is not available"));return}if(!this._persistence){t==null||t(new Error("Anchor Persistence is not supported"));return}if(!this.manager.active){t==null||t(new Error("WebXR session is not active"));return}this.manager.session.deletePersistentAnchor(e).then(()=>{t==null||t(null)}).catch(s=>{t==null||t(s),this.fire("error",s)})}update(e){if(this._available){if(this._creationQueue.length){for(let t=0;t<this._creationQueue.length;t++){const s=this._creationQueue[t];e.createAnchor(s.transform,this.manager._referenceSpace).then(i=>{s.callback&&this._callbacksAnchors.set(i,s.callback)}).catch(i=>{s.callback&&s.callback(i,null),this.fire("error",i)})}this._creationQueue.length=0}for(const[t,s]of this._index)e.trackedAnchors.has(t)||(this._index.delete(t),s.destroy());for(let t=0;t<this._list.length;t++)this._list[t].update(e);for(const t of e.trackedAnchors){if(this._index.has(t))continue;try{const n=t.anchorSpace}catch{continue}const s=this._createAnchor(t);s.update(e);const i=this._callbacksAnchors.get(t);i&&(this._callbacksAnchors.delete(t),i(null,s)),this.fire("add",s)}}}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return!this._available||!this._persistence||!this.manager.active?null:this.manager.session.persistentAnchors}get list(){return this._list}}Oa.EVENT_AVAILABLE="available",Oa.EVENT_UNAVAILABLE="unavailable",Oa.EVENT_ERROR="error",Oa.EVENT_ADD="add",Oa.EVENT_DESTROY="destroy";class Yg extends Q{constructor(e,t){super(),this._meshDetection=void 0,this._xrMesh=void 0,this._lastChanged=0,this._position=new y,this._rotation=new Z,this._meshDetection=e,this._xrMesh=t,this._lastChanged=this._xrMesh.lastChangedTime}get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))}update(e){const t=this._meshDetection._manager,s=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}}Yg.EVENT_REMOVE="remove",Yg.EVENT_CHANGE="change";class Tl extends Q{constructor(e){super(),this._manager=void 0,this._supported=ge.browser&&!!window.XRMesh,this._available=!1,this._index=new Map,this._list=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}update(e){if(!(!this._supported||!this._available)){for(const t of e.detectedMeshes){let s=this._index.get(t);s?s.update(e):(s=new Yg(this,t),this._index.set(t,s),this._list.push(s),s.update(e),this.fire("add",s))}for(const t of this._index.values())e.detectedMeshes.has(t.xrMesh)||this._removeMesh(t)}}_removeMesh(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e)}_onSessionStart(){const e=this._manager.session.enabledFeatures.indexOf("mesh-detection")!==-1;e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(this._available){this._available=!1;for(const e of this._index.values())this._removeMesh(e);this.fire("unavailable")}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}}Tl.EVENT_AVAILABLE="available",Tl.EVENT_UNAVAILABLE="unavailable",Tl.EVENT_ADD="add",Tl.EVENT_REMOVE="remove";class Kg extends Q{constructor(e,t,s){super(),this._manager=void 0,this._xrView=void 0,this._positionData=new Float32Array(3),this._viewport=new X,this._projMat=new W,this._projViewOffMat=new W,this._viewMat=new W,this._viewOffMat=new W,this._viewMat3=new ls,this._viewInvMat=new W,this._viewInvOffMat=new W,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new W,this._manager=e,this._xrView=t;const i=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new re(i,{format:Es,mipmaps:!1,addressU:q,addressV:q,minFilter:Oe,magFilter:Oe,width:this._xrCamera.width,height:this._xrCamera.height,name:`XrView-${this._xrView.eye}-Color`}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){this._textureDepth=new re(i,{format:this._manager.views.depthPixelFormat,arrayLength:s===1?0:s,mipmaps:!1,addressU:q,addressV:q,minFilter:Oe,magFilter:Oe,width:4,height:4,name:`XrView-${this._xrView.eye}-Depth`});for(let n=0;n<this._textureDepth._levels.length;n++)this._textureDepth._levels[n]=this._emptyDepthBuffer}(this._textureColor||this._textureDepth)&&i.on("devicelost",this._onDeviceLost,this)}get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){var e;return((e=this._depthInfo)==null?void 0:e.rawValueToMeters)||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);const i=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=i.x,this._viewport.y=i.y,this._viewport.z=i.width,this._viewport.w=i.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e)}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;const e=this._manager.webglBinding;if(!e)return;const t=e.getCameraImage(this._xrCamera);if(!t)return;const s=this._manager.app.graphicsDevice,i=s.gl;if(!this._frameBufferSource)this._frameBufferSource=i.createFramebuffer(),this._frameBuffer=i.createFramebuffer();else{var n,r;const a=s.isWebGL2?i.COLOR_ATTACHMENT0:(n=(r=s.extDrawBuffers)==null?void 0:r.COLOR_ATTACHMENT0_WEBGL)!=null?n:i.COLOR_ATTACHMENT0,l=this._xrCamera.width,h=this._xrCamera.height;s.setFramebuffer(this._frameBufferSource),i.framebufferTexture2D(i.FRAMEBUFFER,a,i.TEXTURE_2D,t,0),s.setFramebuffer(this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,a,i.TEXTURE_2D,this._textureColor.impl._glTexture,0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._frameBufferSource),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._frameBuffer),i.blitFramebuffer(0,h,l,0,0,0,l,h,i.COLOR_BUFFER_BIT,i.NEAREST)}}_updateDepth(e){var t,s;if(!this._manager.views.availableDepth||!this._textureDepth)return;const i=this._manager.views.depthGpuOptimized,n=i?this._manager.webglBinding:e;if(!n){this._depthInfo=null;return}const r=n.getDepthInformation(this._xrView);if(!r){this._depthInfo=null;return}let a=!this._depthInfo!=!r;this._depthInfo=r;const l=((t=this._depthInfo)==null?void 0:t.width)||4,h=((s=this._depthInfo)==null?void 0:s.height)||4;let c=!1;(this._textureDepth.width!==l||this._textureDepth.height!==h)&&(this._textureDepth._width=l,this._textureDepth._height=h,a=!0,c=!0),a&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo?i?this._depthInfo.texture&&(this._textureDepth.impl._glTexture=this._depthInfo.texture):(this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload()):(this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload()),c&&this.fire("depth:resize",l,h)}updateTransforms(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null}getDepth(e,t){var s,i;return this._manager.views.depthGpuOptimized?null:(s=(i=this._depthInfo)==null?void 0:i.getDepthInMeters(e,t))!=null?s:null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){const e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}}}Kg.EVENT_DEPTHRESIZE="depth:resize";class Oc extends Q{constructor(e){super(),this._manager=void 0,this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=ge.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=ge.browser&&!!window.XRDepthInformation,this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._depthFormats={[Xg]:$a,[Bw]:Pi},this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===Ow}get depthFormat(){return this._depthFormat}get depthPixelFormat(){var e;return(e=this._depthFormats[this._depthFormat])!=null?e:null}update(e,t){for(let s=0;s<t.length;s++)this._indexTmp.set(t[s].eye,t[s]);for(const[s,i]of this._indexTmp){let n=this._index.get(s);n?n.update(e,i):(n=new Kg(this._manager,i,t.length),this._index.set(s,n),this._list.push(n),n.update(e,i),this.fire("add",n))}for(const[s,i]of this._index){if(this._indexTmp.has(s))continue;i.destroy(),this._index.delete(s);const n=this._list.indexOf(i);n!==-1&&this._list.splice(n,1),this.fire("remove",i)}this._indexTmp.clear()}get(e){return this._index.get(e)||null}_onSessionStart(){if(this._manager.type===vl&&(this._availableColor=this._manager.session.enabledFeatures.indexOf("camera-access")!==-1,this._availableDepth=this._manager.session.enabledFeatures.indexOf("depth-sensing")!==-1,this._availableDepth)){const e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat}}_onSessionEnd(){for(const e of this._index.values())e.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0}}Oc.EVENT_ADD="add",Oc.EVENT_REMOVE="remove";class Ba extends Q{constructor(e){super(),this.app=void 0,this._supported=ge.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this.depthSensing=void 0,this.domOverlay=void 0,this.hitTest=void 0,this.imageTracking=void 0,this.planeDetection=void 0,this.meshDetection=void 0,this.input=void 0,this.lightEstimation=void 0,this.views=void 0,this.anchors=void 0,this._camera=null,this._localPosition=new y,this._localRotation=new Z,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=e,this._available[Rw]=!1,this._available[Iw]=!1,this._available[vl]=!1,this.views=new Oc(this),this.depthSensing=new Fc(this),this.domOverlay=new Nw(this),this.hitTest=new fr(this),this.imageTracking=new $g(this),this.planeDetection=new Sl(this),this.meshDetection=new Tl(this),this.input=new Vi(this),this.lightEstimation=new Rf(this),this.anchors=new Oa(this),this.views=new Oc(this),this._supported&&(navigator.xr.addEventListener("devicechange",()=>{this._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this))}destroy(){}start(e,t,s,i){var n,r,a;let l=i;if(typeof i=="object"&&(l=i.callback),!this._available[t]){l&&l(new Error("XR is not available"));return}if(this._session){l&&l(new Error("XR session is already started"));return}this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=s,this._framebufferScaleFactor=(n=i==null?void 0:i.framebufferScaleFactor)!=null?n:1,this._setClipPlanes(e.nearClip,e.farClip);const h={requiredFeatures:[s],optionalFeatures:[]},c=((r=this.app.graphicsDevice)==null?void 0:r.isWebGL1)||((a=this.app.graphicsDevice)==null?void 0:a.isWebGL2);if(t===vl){if(h.optionalFeatures.push("light-estimation"),h.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&h.optionalFeatures.push("image-tracking"),i.planeDetection&&h.optionalFeatures.push("plane-detection"),i.meshDetection&&h.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(h.optionalFeatures.push("dom-overlay"),h.domOverlay={root:this.domOverlay.root}),i&&i.anchors&&this.anchors.supported&&h.optionalFeatures.push("anchors"),i&&i.depthSensing&&this.depthSensing.supported){h.optionalFeatures.push("depth-sensing");const d=[Fw],u=[Xg];if(i.depthSensing.usagePreference){const f=d.indexOf(i.depthSensing.usagePreference);f!==-1&&d.splice(f,1),d.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const f=u.indexOf(i.depthSensing.dataFormatPreference);f!==-1&&u.splice(f,1),u.unshift(i.depthSensing.dataFormatPreference)}h.depthSensing={usagePreference:d,dataFormatPreference:u}}c&&i&&i.cameraColor&&this.views.supportedColor&&h.optionalFeatures.push("camera-access")}h.optionalFeatures.push("hand-tracking"),i&&i.optionalFeatures&&(h.optionalFeatures=h.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages((d,u)=>{if(d){l&&l(d),this.fire("error",d);return}u!==null&&(h.trackedImages=u),this._onStartOptionsReady(t,s,h,l)}):this._onStartOptionsReady(t,s,h,l)}_onStartOptionsReady(e,t,s,i){navigator.xr.requestSession(e,s).then(n=>{this._onSessionStart(n,t,i)}).catch(n=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(n),this.fire("error",n)})}end(e){if(!this._session){e&&e(new Error("XR Session is not initialized"));return}this.webglBinding=null,e&&this.once("end",e),this._session.end()}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(const e in this._available)this._sessionSupportCheck(e)}initiateRoomCapture(e){if(!this._session){e(new Error("Session is not active"));return}if(!this._session.initiateRoomCapture){e(new Error("Session does not support manual room capture"));return}this._session.initiateRoomCapture().then(()=>{e&&e(null)}).catch(t=>{e&&e(t)})}updateTargetFrameRate(e,t){var s;if(!((s=this._session)!=null&&s.updateTargetFrameRate)){t==null||t(new Error("unable to update frameRate"));return}this._session.updateTargetFrameRate(e).then(()=>{t==null||t()}).catch(i=>{t==null||t(i)})}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then(t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire("available:"+e,t))}).catch(t=>{this.fire("error",t)})}_onSessionStart(e,t,s){let i=!1;this._session=e;const n=()=>{this.fire("visibility:change",e.visibilityState)},r=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},a=()=>{this._camera&&(this._camera.off("set_nearClip",r),this._camera.off("set_farClip",r),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",a),e.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.tick()};e.addEventListener("end",a),e.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",r),this._camera.on("set_farClip",r),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",()=>{var l;this.fire("frameratechange",(l=this._session)==null?void 0:l.frameRate)}),e.requestReferenceSpace(t).then(l=>{this._referenceSpace=l,this.app.tick(),s&&s(null),this.fire("start")}).catch(l=>{i=!0,e.end(),s&&s(l),this.fire("error",l)})}_setClipPlanes(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}_createBaseLayer(){const e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:t,antialias:!1});const s=e.deviceType;if((s===xo||s===qr)&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl)}catch(i){this.fire("error",i)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))}_onDeviceRestored(){this._session&&setTimeout(()=>{this.app.graphicsDevice.gl.makeXRCompatible().then(()=>{this._createBaseLayer()}).catch(e=>{this.fire("error",e)})},0)}update(e){if(!this._session)return!1;const t=e.session.renderState.baseLayer.framebufferWidth,s=e.session.renderState.baseLayer.framebufferHeight;(this._width!==t||this._height!==s)&&(this._width=t,this._height=s,this.app.graphicsDevice.setResolution(t,s));const i=e.getViewerPose(this._referenceSpace);if(!i)return!1;const n=this.views.list.length;this.views.update(e,i.views);const r=i.transform.position,a=i.transform.orientation;if(this._localPosition.set(r.x,r.y,r.z),this._localRotation.set(a.x,a.y,a.z,a.w),n===0&&this.views.list.length>0){const l=new W,h=this.views.list[0];l.copy(h.projMat);const c=l.data,d=2*Math.atan(1/c[5])*180/Math.PI,u=c[5]/c[0],f=c[14]/(c[10]+1),p=c[14]/(c[10]-1);this._camera.camera.setXrProperties({aspectRatio:u,farClip:f,fov:d,horizontalFov:!1,nearClip:p})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===vl&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.depthSensing.supported&&this.depthSensing.update(),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){var e,t;return(e=(t=this._session)==null?void 0:t.frameRate)!=null?e:null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(e){var t,s;((t=(s=this._baseLayer)==null?void 0:s.fixedFoveation)!=null?t:null)!==null&&(this.app.graphicsDevice.samples>1,this._baseLayer.fixedFoveation=e)}get fixedFoveation(){var e,t;return(e=(t=this._baseLayer)==null?void 0:t.fixedFoveation)!=null?e:null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}Ba.EVENT_AVAILABLE="available",Ba.EVENT_START="start",Ba.EVENT_END="end",Ba.EVENT_UPDATE="update",Ba.EVENT_ERROR="error";class qw extends nt{constructor(e,t={}){var s;super(e);const i=new NS;i.graphicsDevice=(s=t.graphicsDevice)!=null?s:this.createDevice(e,t),this.addComponentSystems(i),this.addResourceHandles(i),i.elementInput=t.elementInput,i.keyboard=t.keyboard,i.mouse=t.mouse,i.touch=t.touch,i.gamepads=t.gamepads,i.scriptPrefix=t.scriptPrefix,i.assetPrefix=t.assetPrefix,i.scriptsOrder=t.scriptsOrder,i.soundManager=new Io,i.lightmapper=GS,i.batchManager=Ex,i.xr=Ba,this.init(i)}createDevice(e,t){return t.graphicsDeviceOptions||(t.graphicsDeviceOptions={}),ge.browser&&navigator.xr&&(t.graphicsDeviceOptions.xrCompatible=!0),t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||!1,new Op(e,t.graphicsDeviceOptions)}addComponentSystems(e){e.componentSystems=[of,Cb,Wb,rb,hb,eT,iT,FT,OT,vt.legacy?fT:BT,fb,wT,db,sT,dT,Vb,gb,ST,bT,RT,Qb,Xb,DT,NT]}addResourceHandles(e){e.resourceHandlers=[zT,jT,YT,KT,mw,fw,Pw,Tw,dw,ZT,vw,_w,tw,cw,ew,xw,hw,sw,iw,QT,ww,Sw,bw,JT,lw]}}class UU extends Q{constructor(e,t){super(),this._assets=new Set,this._loadingAssets=new Set,this._waitingAssets=new Set,this._registry=t,this._loading=!1,this._loaded=!1,this._failed=[],e.forEach(s=>{if(s instanceof se)s.registry||(s.registry=t),this._assets.add(s);else{const i=t.get(s);i?this._assets.add(i):this._waitForAsset(s)}})}destroy(){const e=this;this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(function(t){e._registry.off("add:"+t,this._onAddAsset)}),this.off("progress"),this.off("load")}_assetHasDependencies(e){var t;return e.type==="model"&&((t=e.file)==null?void 0:t.url)&&e.file.url&&e.file.url.match(/.json$/g)}load(e,t){if(this._loading)return;this._loading=!0,this._callback=e,this._scope=t,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this);let s=!1;this._assets.forEach(i=>{i.loaded||(s=!0,this._assetHasDependencies(i)&&this._registry.loadFromUrl(i.file.url,i.type,(n,r)=>{if(n){this._onError(n,i);return}this._onLoad(i)}),this._loadingAssets.add(i),this._registry.add(i))}),this._loadingAssets.forEach(i=>{this._assetHasDependencies(i)||this._registry.load(i)}),!s&&this._waitingAssets.size===0&&this._loadingComplete()}ready(e,t=this){this._loaded?e.call(t,Array.from(this._assets)):this.once("load",function(s){e.call(t,s)})}_loadingComplete(){this._loaded||(this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",Array.from(this._assets))))}_onLoad(e){this._loadingAssets.has(e)&&(this.fire("progress",e),this._loadingAssets.delete(e)),this._loadingAssets.size===0&&setTimeout(()=>{this._loadingComplete(this._failed)},0)}_onError(e,t){this._loadingAssets.has(t)&&(this._failed.push(t),this._loadingAssets.delete(t)),this._loadingAssets.size===0&&setTimeout(()=>{this._loadingComplete(this._failed)},0)}_onAddAsset(e){this._waitingAssets.delete(e),this._assets.add(e),e.loaded||(this._loadingAssets.add(e),this._registry.load(e))}_waitForAsset(e){this._waitingAssets.add(e),this._registry.once("add:"+e,this._onAddAsset,this)}}const jw=4096,Yw=512;class zU{constructor(e,t,s,i){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=s,this.texture=new re(e,{name:i,format:oe,width:t,height:s,mipmaps:!0,minFilter:Qs,magFilter:Oe,addressU:q,addressV:q,levels:[this.canvas]}),this.ctx=this.canvas.getContext("2d",{alpha:!0})}destroy(){this.texture.destroy()}clear(e){const{width:t,height:s}=this.canvas;this.ctx.clearRect(0,0,t,s),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,t,s)}}class VU extends Q{constructor(e,t={}){super(),this.type="bitmap",this.app=e,this.intensity=0,this.fontWeight=t.fontWeight||"normal",this.fontSize=parseInt(t.fontSize,10),this.glyphSize=this.fontSize,this.fontName=t.fontName||"Arial",this.color=t.color||new H(1,1,1),this.padding=t.padding||0,this.width=Math.min(jw,t.width||Yw),this.height=Math.min(jw,t.height||Yw),this.atlases=[],this.chars="",this.data={}}createTextures(e){const t=this._normalizeCharsSet(e);if(t.length!==this.chars.length){this._renderAtlas(t);return}for(let s=0;s<t.length;s++)if(t[s]!==this.chars[s]){this._renderAtlas(t);return}}updateTextures(e){const t=this._normalizeCharsSet(e),s=[];for(let i=0;i<t.length;i++){const n=t[i];this.data.chars[n]||s.push(n)}s.length>0&&this._renderAtlas(this.chars.concat(s))}destroy(){this.atlases.forEach(e=>e.destroy()),this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.atlases=null,this.type=null,this.fontWeight=null}_colorToRgbString(e,t){let s;const i=Math.round(255*e.r),n=Math.round(255*e.g),r=Math.round(255*e.b);return t?s=`rgba(${i}, ${n}, ${r}, ${e.a})`:s=`rgb(${i}, ${n}, ${r})`,s}renderCharacter(e,t,s,i,n){e.fillStyle=n,e.fillText(t,s,i)}_getAtlas(e){return e>=this.atlases.length&&(this.atlases[e]=new zU(this.app.graphicsDevice,this.width,this.height,`font-atlas-${this.fontName}-${e}`)),this.atlases[e]}_renderAtlas(e){this.chars=e;const t=this.width,s=this.height,i=this._colorToRgbString(this.color,!1),n=this.color.a;this.color.a=1/255;const r=this._colorToRgbString(this.color,!0);this.color.a=n;const a="center",l="alphabetic";let h=0,c=this._getAtlas(h++);c.clear(r),this.data=this._createJson(this.chars,this.fontName,t,s);const d=bi.getSymbols(this.chars.join(""));let u=0,f=0;const p={};for(let b=0;b<d.length;b++){const w=d[b];p[w]=this._getTextMetrics(w),u=Math.max(u,p[w].height),f=Math.max(f,p[w].descent)}this.glyphSize=Math.max(this.glyphSize,u);const _=this.glyphSize+this.padding*2,m=this.glyphSize+this.padding*2,g=this.glyphSize/2+this.padding,x=m-f-this.padding;let S=0,v=0;for(let b=0;b<d.length;b++){const w=d[b],T=bi.getCodePoint(d[b]);let E=this.fontSize;c.ctx.font=this.fontWeight+" "+E.toString()+"px "+this.fontName,c.ctx.textAlign=a,c.ctx.textBaseline=l;let C=c.ctx.measureText(w).width;C>E&&(E=this.fontSize*this.fontSize/C,c.ctx.font=this.fontWeight+" "+E.toString()+"px "+this.fontName,C=this.fontSize),this.renderCharacter(c.ctx,w,S+g,v+x,i);const M=this.padding+(this.glyphSize-C)/2,O=-this.padding+p[w].descent-f,I=C;this._addChar(this.data,w,T,S,v,_,m,M,O,I,h-1,t,s),S+=_,S+_>t&&(S=0,v+=m,v+m>s&&(c=this._getAtlas(h++),c.clear(r),v=0))}this.atlases.splice(h).forEach(b=>b.destroy()),this.atlases.forEach(b=>b.texture.upload()),this.fire("render")}_createJson(e,t,s,i){return{version:3,intensity:this.intensity,info:{face:t,width:s,height:i,maps:[{width:s,height:i}]},chars:{}}}_addChar(e,t,s,i,n,r,a,l,h,c,d,u,f){e.info.maps.length<d+1&&e.info.maps.push({width:u,height:f});const p=this.fontSize/32;e.chars[t]={id:s,letter:t,x:i,y:n,width:r,height:a,xadvance:c/p,xoffset:l/p,yoffset:(h+this.padding)/p,scale:p,range:1,map:d,bounds:[0,0,r/p,a/p]}}_normalizeCharsSet(e){const t=this.app.systems.element.getUnicodeConverter();t&&(e=t(e));const s={},i=bi.getSymbols(e);for(let r=0;r<i.length;r++){const a=i[r];s[a]||(s[a]=a)}return Object.keys(s).sort()}_getTextMetrics(e){const t=document.createElement("span");t.id="content-span",t.innerHTML=e;const s=document.createElement("div");s.id="content-block",s.style.display="inline-block",s.style.width="1px",s.style.height="0px";const i=document.createElement("div");i.appendChild(t),i.appendChild(s),i.style.font=this.fontSize+"px "+this.fontName,document.body.appendChild(i);let r=-1,a=-1,l=-1;try{s.style["vertical-align"]="baseline",r=s.offsetTop-t.offsetTop,s.style["vertical-align"]="bottom",l=s.offsetTop-t.offsetTop,a=l-r}finally{document.body.removeChild(i)}return{ascent:r,descent:a,height:l}}get textures(){return this.atlases.map(e=>e.texture)}}const Df=[],GU=[[],[],[]];class WU extends Ot{constructor(e,t){super(e),this.pickColor=new Float32Array(4),this.renderer=t}update(e,t,s,i){this.camera=e,this.scene=t,this.layers=s,this.mapping=i}execute(){const e=this.device,{renderer:t,camera:s,scene:i,layers:n,mapping:r,renderTarget:a}=this,l=i.layers.layerList,h=i.layers.subLayerEnabled,c=i.layers.subLayerList,d=e.scope.resolve("uColor"),u=this.pickColor;for(let f=0;f<l.length;f++){const p=l[f];if(!(n&&n.indexOf(p)<0)&&p.enabled&&h[f]&&p.camerasSet.has(s.camera)){const _=c[f];p._clearDepthBuffer&&t.clear(s.camera,!1,!0,!1);const m=p.meshInstances;for(let g=0;g<m.length;g++){const x=m[g];x.pick&&x.transparent===_&&(Df.push(x),r.set(x.id,x))}Df.length>0&&(t.setCameraUniforms(s.camera,a),t.renderForward(s.camera,Df,GU,ea,g=>{const x=g.id;u[0]=(x>>16&255)/255,u[1]=(x>>8&255)/255,u[2]=(x&255)/255,u[3]=(x>>24&255)/255,d.setValue(u),e.setBlendState(Ee.NOBLEND)}),Df.length=0)}}}}const Zg=new Set;class Kw{constructor(e,t,s){this.renderTarget=null,this.mapping=new Map,e instanceof Ue&&(e=qs()),this.renderer=e.renderer,this.device=e.graphicsDevice,this.renderPass=new WU(this.device,e.renderer),this.width=0,this.height=0,this.resize(t,s)}getSelection(e,t,s=1,i=1){const n=this.device;t=this.renderTarget.height-(t+i),e=Math.floor(e),t=Math.floor(t),s=Math.floor(Math.max(s,1)),i=Math.floor(Math.max(i,1)),n.setRenderTarget(this.renderTarget),n.updateBegin();const r=new Uint8Array(4*s*i);n.readPixels(e,t,s,i,r),n.updateEnd();const a=this.mapping;for(let h=0;h<s*i;h++){const c=r[4*h+0],d=r[4*h+1],u=r[4*h+2],p=r[4*h+3]<<24|c<<16|d<<8|u;p!==-1&&Zg.add(a.get(p))}const l=[];return Zg.forEach(h=>l.push(h)),Zg.clear(),l}allocateRenderTarget(){const e=new re(this.device,{format:oe,width:this.width,height:this.height,mipmaps:!1,minFilter:de,magFilter:de,addressU:q,addressV:q,name:"pick"});this.renderTarget=new qe({colorBuffer:e,depth:!0})}releaseRenderTarget(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}prepare(e,t,s){e instanceof sa&&(e=e.node.camera),s instanceof ln&&(s=[s]),(!this.renderTarget||this.width!==this.renderTarget.width||this.height!==this.renderTarget.height)&&(this.releaseRenderTarget(),this.allocateRenderTarget()),this.mapping.clear();const i=this.renderPass;i.init(this.renderTarget),i.colorOps.clearValue=H.WHITE,i.colorOps.clear=!0,i.depthStencilOps.clearDepth=!0,i.update(e,t,s,this.mapping),i.render()}resize(e,t){this.width=Math.floor(e),this.height=Math.floor(t)}}class HU extends Le{constructor(e){super(e,"scenesettings")}load(e,t){Og.load(e,this.maxRetries,t)}open(e,t){return t.settings}}let pr,mr;const Qg=new y,Zw=new y,bn=new Mn,Bc=new Mn,Jg=new Mn;bn.end=new y,Bc.end=new y,Jg.end=new y;const wl=new y,Lf=new y,ey=new y,Qw=new y,ty=new y,Ff=new y,Of=new y,Bf=new y,Nf=new y,sy=new y,XU=new y,El=new y,Nc=new y,kf=new y,Uf=new y,kc=new y,Jw=new y,eE=new y,tE=new y,sE=new y,$U=new X;function iE(o,e,t){return XU.cross(o,e).dot(t)}function qU(o,e,t){wl.sub2(e,o),Lf.sub2(t[0],o),ey.sub2(t[1],o),Qw.sub2(t[2],o),Ff.cross(Qw,wl);let s=Lf.dot(Ff),i,n;if(s>=0){if(i=-ey.dot(Ff),i<0||(n=iE(wl,ey,Lf),n<0))return-1;const r=1/(i+s+n);Of.copy(t[0]).mulScalar(i*r),Bf.copy(t[1]).mulScalar(s*r),Nf.copy(t[2]).mulScalar(n*r),sy.copy(Of).add(Bf).add(Nf)}else{if(ty.sub2(t[3],o),i=ty.dot(Ff),i<0||(n=iE(wl,Lf,ty),n<0))return-1;s=-s;const r=1/(i+s+n);Of.copy(t[0]).mulScalar(i*r),Bf.copy(t[3]).mulScalar(s*r),Nf.copy(t[2]).mulScalar(n*r),sy.copy(Of).add(Bf).add(Nf)}return wl.sub2(t[0],t[2]).lengthSq()<1e-4*1e-4||wl.sub2(t[1],t[3]).lengthSq()<1e-4*1e-4?-1:sy.sub(o).lengthSq()}class zf{constructor(e,t,s){this.event=e,this.element=t,this.camera=s,this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}class Al extends zf{constructor(e,t,s,i,n,r,a){super(e,t,s),this.x=i,this.y=n,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.button=e.button,ni.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=i-r,this.dy=n-a),this.wheelDelta=0,e.type==="wheel"&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1))}}class Cl extends zf{constructor(e,t,s,i,n,r){super(e,t,s),this.touches=e.touches,this.changedTouches=e.changedTouches,this.x=i,this.y=n,this.touch=r}}class Tn extends zf{constructor(e,t,s,i){super(e,t,s),this.inputSource=i}}class Na{constructor(e,t){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||t.useMouse!==!1,this._useTouch=!t||t.useTouch!==!1,this._useXr=!t||t.useXr!==!1,this._selectEventsAttached=!1,ge.touch&&(this._clickedEntities={}),this.attach(e)}set enabled(e){this._enabled=e}get enabled(){return this._enabled}set app(e){this._app=e}get app(){return this._app||qs()}attach(e){this._attached&&(this._attached=!1,this.detach()),this._target=e,this._attached=!0;const t=ge.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&ge.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))}detach(){if(!this._attached)return;this._attached=!1;const e=ge.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}addElement(e){this._elements.indexOf(e)===-1&&this._elements.push(e)}removeElement(e){const t=this._elements.indexOf(e);t!==-1&&this._elements.splice(t,1)}_handleUp(e){this._enabled&&(ni.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mouseup",e)))}_handleDown(e){this._enabled&&(ni.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mousedown",e)))}_handleMove(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousemove",e),this._lastX=pr,this._lastY=mr)}_handleWheel(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousewheel",e))}_determineTouchedElements(e){const t={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){const n=s[i];let r=0;const a=e.changedTouches.length;for(let l=0;l<a;l++){if(t[e.changedTouches[l].identifier]){r++;continue}const h=this._calcTouchCoords(e.changedTouches[l]),c=this._getTargetElementByCoords(n,h.x,h.y);c&&(r++,t[e.changedTouches[l].identifier]={element:c,camera:n,x:h.x,y:h.y})}if(r===a)break}return t}_handleTouchStart(e){if(!this._enabled)return;const t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){const n=e.changedTouches[s],r=t[n.identifier],a=this._touchedElements[n.identifier];r&&(!a||r.element!==a.element)&&(this._fireEvent(e.type,new Cl(e,r.element,r.camera,r.x,r.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!1)}for(const s in t)this._touchedElements[s]=t[s]}_handleTouchEnd(e){if(!this._enabled)return;const t=this.app.systems.camera.cameras;for(const s in this._clickedEntities)delete this._clickedEntities[s];for(let s=0,i=e.changedTouches.length;s<i;s++){const n=e.changedTouches[s],r=this._touchedElements[n.identifier];if(!r)continue;const a=r.element,l=r.camera,h=r.x,c=r.y;delete this._touchedElements[n.identifier],delete this._touchesForWhichTouchLeaveHasFired[n.identifier];const d=this._calcTouchCoords(n);for(let u=t.length-1;u>=0;u--)this._getTargetElementByCoords(t[u],d.x,d.y)===a&&(this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new Cl(e,a,l,h,c,n)),this._clickedEntities[a.entity.getGuid()]=Date.now()));this._fireEvent(e.type,new Cl(e,a,l,h,c,n))}}_handleTouchMove(e){if(e.preventDefault(),!this._enabled)return;const t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){const n=e.changedTouches[s],r=t[n.identifier],a=this._touchedElements[n.identifier];if(a){const l=this._calcTouchCoords(n);(!r||r.element!==a.element)&&!this._touchesForWhichTouchLeaveHasFired[n.identifier]&&(this._fireEvent("touchleave",new Cl(e,a.element,a.camera,l.x,l.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!0),this._fireEvent("touchmove",new Cl(e,a.element,a.camera,l.x,l.y,n))}}}_onElementMouseEvent(e,t){let s=null;const i=this._hoveredElement;this._hoveredElement=null;const n=this.app.systems.camera.cameras;let r;for(let a=n.length-1;a>=0&&(r=n[a],s=this._getTargetElementByCoords(r,pr,mr),!s);a--);if(this._hoveredElement=s,(e==="mousemove"||e==="mouseup")&&this._pressedElement?this._fireEvent(e,new Al(t,this._pressedElement,r,pr,mr,this._lastX,this._lastY)):s&&(this._fireEvent(e,new Al(t,s,r,pr,mr,this._lastX,this._lastY)),e==="mousedown"&&(this._pressedElement=s)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new Al(t,i,r,pr,mr,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new Al(t,this._hoveredElement,r,pr,mr,this._lastX,this._lastY))),e==="mouseup"&&this._pressedElement){if(this._pressedElement===this._hoveredElement){const a=this._hoveredElement.entity.getGuid();let l=!this._clickedEntities;if(this._clickedEntities){const h=this._clickedEntities[a]||0;l=Date.now()-h>300,delete this._clickedEntities[a]}l&&this._fireEvent("click",new Al(t,this._hoveredElement,r,pr,mr,this._lastX,this._lastY))}this._pressedElement=null}}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)}_onXrUpdate(){if(!this._enabled)return;const e=this.app.xr.input.inputSources;for(let t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null)}_onXrInputRemove(e){const t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new Tn(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id]}_onSelectStart(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t)}_onSelectEnd(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t)}_onElementSelectEvent(e,t,s){let i;const n=this._selectedElements[t.id];let r;const a=this.app.systems.camera.cameras;let l;if(t.elementInput){Jg.set(t.getOrigin(),t.getDirection());for(let c=a.length-1;c>=0&&(l=a[c],i=this._getTargetElementByRay(Jg,l),!i);c--);}t._elementEntity=i||null,i?(this._selectedElements[t.id]=i,r=i):delete this._selectedElements[t.id],n!==r&&(n&&this._fireEvent("selectleave",new Tn(s,n,l,t)),r&&this._fireEvent("selectenter",new Tn(s,r,l,t)));const h=this._selectedPressedElements[t.id];e==="selectmove"&&h&&this._fireEvent("selectmove",new Tn(s,h,l,t)),e==="selectstart"&&(this._selectedPressedElements[t.id]=r,r&&this._fireEvent("selectstart",new Tn(s,r,l,t))),!t.elementInput&&h&&(delete this._selectedPressedElements[t.id],n&&this._fireEvent("selectend",new Tn(s,h,l,t))),e==="selectend"&&t.elementInput&&(delete this._selectedPressedElements[t.id],h&&this._fireEvent("selectend",new Tn(s,h,l,t)),h&&h===n&&this._fireEvent("click",new Tn(s,h,l,t)))}_fireEvent(e,t){let s=t.element;for(;s.fire(e,t),!(t._stopPropagation||!s.entity.parent||(s=s.entity.parent.element,!s)););}_calcMouseCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);pr=e.clientX-s,mr=e.clientY-i}_calcTouchCoords(e){let t=0,s=0,i=e.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do t+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent;while(n);return{x:e.pageX-t,y:e.pageY-s}}_sortElements(e,t){const s=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return s!==0?s:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:!e.screen&&!t.screen?0:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder}_getTargetElementByCoords(e,t,s){const i=this._calculateRayScreen(t,s,e,bn)?bn:null,n=this._calculateRay3d(t,s,e,Bc)?Bc:null;return this._getTargetElement(e,i,n)}_getTargetElementByRay(e,t){bn.origin.copy(e.origin),bn.direction.copy(e.direction),bn.end.copy(bn.direction).mulScalar(t.farClip*2).add(bn.origin);const s=bn,i=t.worldToScreen(s.origin,Qg),n=this._calculateRayScreen(i.x,i.y,t,Bc)?Bc:null;return this._getTargetElement(t,n,s)}_getTargetElement(e,t,s){let i=null,n=1/0;this._elements.sort(this._sortHandler);for(let r=0,a=this._elements.length;r<a;r++){const l=this._elements[r];if(l.layers.some(h=>e.layersSet.has(h)))if(l.screen&&l.screen.screen.screenSpace){if(!t)continue;if(this._checkElement(t,l,!0)>=0){i=l;break}}else{if(!s)continue;const h=this._checkElement(s,l,!1);if(h>=0&&(h<n&&(i=l,n=h),l.screen)){i=l;break}}}return i}_calculateRayScreen(e,t,s,i){const n=this.app.graphicsDevice.width,r=this.app.graphicsDevice.height,a=s.rect.z*n,l=s.rect.w*r,h=s.rect.x*n,c=h+a,d=(1-s.rect.y)*r,u=d-l;let f=e*n/this._target.clientWidth,p=t*r/this._target.clientHeight;return f>=h&&f<=c&&p<=d&&p>=u?(f=n*(f-h)/a,p=r*(p-u)/l,p=r-p,i.origin.set(f,p,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),!0):!1}_calculateRay3d(e,t,s,i){const n=this._target.clientWidth,r=this._target.clientHeight,a=s.rect.z*n,l=s.rect.w*r,h=s.rect.x*n,c=h+a,d=(1-s.rect.y)*r,u=d-l;let f=e,p=t;return e>=h&&e<=c&&t<=d&&p>=u?(f=n*(f-h)/a,p=r*(p-u)/l,s.screenToWorld(f,p,s.nearClip,Qg),s.screenToWorld(f,p,s.farClip,Zw),i.origin.copy(Qg),i.direction.set(0,0,-1),i.end.copy(Zw),!0):!1}_checkElement(e,t,s){if(t.maskedBy&&this._checkElement(e,t.maskedBy.element,s)<0)return-1;let i;s?i=Na.calculateScaleToScreen(t):i=Na.calculateScaleToWorld(t);const n=Na.buildHitCorners(t,s?t.screenCorners:t.worldCorners,i);return qU(e.origin,e.end,n)}static buildHitCorners(e,t,s){let i=t;if(e.entity&&e.entity.button){const r=e.entity.button.hitPadding||$U;Nc.copy(e.entity.up),kf.copy(Nc).mulScalar(-1),kc.copy(e.entity.right),Uf.copy(kc).mulScalar(-1),Nc.mulScalar(r.w*s.y),kf.mulScalar(r.y*s.y),kc.mulScalar(r.z*s.x),Uf.mulScalar(r.x*s.x),Jw.copy(i[0]).add(kf).add(Uf),eE.copy(i[1]).add(kf).add(kc),tE.copy(i[2]).add(Nc).add(kc),sE.copy(i[3]).add(Nc).add(Uf),i=[Jw,eE,tE,sE]}if(s.x<0){const r=i[2].x,a=i[0].x;i[0].x=r,i[1].x=a,i[2].x=a,i[3].x=r}if(s.y<0){const r=i[2].y,a=i[0].y;i[0].y=r,i[1].y=r,i[2].y=a,i[3].y=a}if(s.z<0){const r=i[2].x,a=i[2].y,l=i[2].z;i[2].x=i[0].x,i[2].y=i[0].y,i[2].z=i[0].z,i[0].x=r,i[0].y=a,i[0].z=l}return i}static calculateScaleToScreen(e){let t=e.entity;const s=e.screen.screen.scale;for(El.set(s,s,s);t&&!t.screen;)El.mul(t.getLocalScale()),t=t.parent;return El}static calculateScaleToWorld(e){let t=e.entity;for(El.set(1,1,1);t;)El.mul(t.getLocalScale()),t=t.parent;return El}}const jU=0,Vf=1,YU=2,Gf={write:function(o){console.log(o)},open:function(){Gf.write("Powered by PlayCanvas "+jf+" "+Yf)},info:function(o){console.info("INFO:    "+o)},debug:function(o){console.debug("DEBUG:   "+o)},error:function(o){console.error("ERROR:   "+o)},warning:function(o){console.warn("WARNING: "+o)},alert:function(o){Gf.write("ALERT:   "+o),alert(o)},assert:function(o,e){o===!1&&Gf.write("ASSERT:  "+e)}};bi.endsWith=function(o,e){return o.endsWith(e)},bi.startsWith=function(o,e){return o.startsWith(e)};class KU{constructor(){this._isRunning=!1,this._a=0,this._b=0}start(){this._isRunning=!0,this._a=jt()}stop(){this._isRunning=!1,this._b=jt()}getMilliseconds(){return this._b-this._a}}const ZU={now:jt,Timer:KU};Object.defineProperty(H.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(H.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}});function QU(o,e){const t=function(){},s=function(n,r,a,l,h,c,d,u){e.call(this,n,r,a,l,h,c,d,u),o.call(this,n,r,a,l,h,c,d,u)};return s._super=e.prototype,t.prototype=e.prototype,s.prototype=new t,s}function JU(o){return Array.prototype.slice.call(o)}function ez(o){const e=document.createElement("style");return e.type="text/css",e.styleSheet?e.styleSheet.cssText=o:e.appendChild(document.createTextNode(o)),e}U.INV_LOG2=Math.LOG2E,U.intToBytes=U.intToBytes32,U.bytesToInt=U.bytesToInt32,Object.defineProperty(G.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),G.prototype.scale=G.prototype.mulScalar,Object.defineProperty(y.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),y.prototype.scale=y.prototype.mulScalar,Object.defineProperty(X.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),X.prototype.scale=X.prototype.mulScalar;const tz={Aabb:ye,Sphere:Cn,Plane:cp};Cn.prototype.intersectRay=Cn.prototype.intersectsRay,lp.prototype.update=function(o,e){const t=new W;t.mul2(o,e),this.setFromMat4(t)};const sz=si,iz=Zt,nz=ii,rz=Ms,az=xe,oz=tt,lz=le,hz=$a,cz=Rn,dz=qa,uz=Ar,fz=Es,pz=oe,mz=pp,_z=mp,gz=pp,yz=mp;function Wf(o){this.name="UnsupportedBrowserError",this.message=o||""}Wf.prototype=Error.prototype;function Hf(o){this.name="ContextCreationError",this.message=o||""}Hf.prototype=Error.prototype;const nE={begin:me.begin,dummyFragmentCode:je.dummyFragmentCode,end:me.end,fogCode:me.fogCode,gammaCode:me.gammaCode,precisionCode:je.precisionCode,skinCode:me.skinCode,tonemapCode:me.tonemapCode,versionCode:je.versionCode},vz={ADDRESS_CLAMP_TO_EDGE:q,ADDRESS_MIRRORED_REPEAT:Ha,ADDRESS_REPEAT:Qe,BLENDMODE_ZERO:Fl,BLENDMODE_ONE:ut,BLENDMODE_SRC_COLOR:up,BLENDMODE_ONE_MINUS_SRC_COLOR:My,BLENDMODE_DST_COLOR:$c,BLENDMODE_ONE_MINUS_DST_COLOR:fp,BLENDMODE_SRC_ALPHA:Ol,BLENDMODE_SRC_ALPHA_SATURATE:Py,BLENDMODE_ONE_MINUS_SRC_ALPHA:Bl,BLENDMODE_DST_ALPHA:Ry,BLENDMODE_ONE_MINUS_DST_ALPHA:Iy,BUFFER_STATIC:St,BUFFER_DYNAMIC:Pn,BUFFER_STREAM:_p,CULLFACE_NONE:Je,CULLFACE_BACK:Ai,CULLFACE_FRONT:br,CULLFACE_FRONTANDBACK:gp,ELEMENTTYPE_INT8:si,ELEMENTTYPE_UINT8:Zt,ELEMENTTYPE_INT16:ii,ELEMENTTYPE_UINT16:Ms,ELEMENTTYPE_INT32:xe,ELEMENTTYPE_UINT32:tt,ELEMENTTYPE_FLOAT32:le,FILTER_NEAREST:de,FILTER_LINEAR:Oe,FILTER_NEAREST_MIPMAP_NEAREST:Tr,FILTER_NEAREST_MIPMAP_LINEAR:wr,FILTER_LINEAR_MIPMAP_NEAREST:Er,FILTER_LINEAR_MIPMAP_LINEAR:Qs,INDEXFORMAT_UINT8:kl,INDEXFORMAT_UINT16:Yt,INDEXFORMAT_UINT32:Mi,PIXELFORMAT_RGB565:Rn,PIXELFORMAT_RGB8:Es,PIXELFORMAT_RGBA8:oe,PRIMITIVE_POINTS:Lr,PRIMITIVE_LINES:eo,PRIMITIVE_LINELOOP:rd,PRIMITIVE_LINESTRIP:ad,PRIMITIVE_TRIANGLES:Js,PRIMITIVE_TRISTRIP:As,PRIMITIVE_TRIFAN:Xi,SEMANTIC_POSITION:We,SEMANTIC_NORMAL:Dt,SEMANTIC_COLOR:_t,SEMANTIC_TEXCOORD:od,SEMANTIC_TEXCOORD0:Lt,SEMANTIC_TEXCOORD1:Ri,SEMANTIC_ATTR0:oo,SEMANTIC_ATTR1:oh,SEMANTIC_ATTR2:ld,SEMANTIC_ATTR3:hd,TEXTURELOCK_READ:vp,TEXTURELOCK_WRITE:fd,drawQuadWithShader:_s,programlib:nE,shaderChunks:z,ContextCreationError:Hf,Device:Ue,IndexBuffer:Di,ProgramLibrary:h_,RenderTarget:qe,ScopeId:Ep,Shader:Is,ShaderInput:Dp,Texture:re,UnsupportedBrowserError:Wf,VertexBuffer:es,VertexFormat:Tt,VertexIterator:Kr},xz=new X;function rE(o,e,t,s,i){let n;if(i){const r=e?e.width:o.width,a=e?e.height:o.height;n=xz.set(i.x*r,i.y*a,i.z*r,i.w*a)}_s(o,e,s,n)}const Sz={createFullscreenQuad:o=>o.quadVertexBuffer,drawFullscreenQuad:rE,PostEffect:l_,PostEffectQueue:gg};Object.defineProperty(z,"transformSkinnedVS",{get:function(){return`#define SKIN
`+z.transformVS}}),Object.keys({"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"}).forEach(o=>{Object.defineProperty(z,o,{get:function(){return null},set:function(){}})}),Object.defineProperties(qe.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(o){}}}),Object.defineProperty(Tt,"defaultInstancingFormat",{get:function(){return null}}),Object.defineProperties(re.prototype,{rgbm:{get:function(){return this.type===Cs},set:function(o){this.type=o?Cs:bt}},swizzleGGGR:{get:function(){return this.type===Br},set:function(o){this.type=o?Br:bt}},_glTexture:{get:function(){return this.impl._glTexture}},autoMipmap:{get:function(){return this._mipmaps},set:function(o){this._mipmaps=o}}}),Object.defineProperty(Ue.prototype,"webgl2",{get:function(){return this.isWebGL2}}),Ue.prototype.getProgramLibrary=function(){return Us(this)},Ue.prototype.setProgramLibrary=function(o){cx(this,o)},Ue.prototype.removeShaderFromCache=function(o){Us(this).removeFromCache(o)},Ee.DEFAULT=Object.freeze(new Ee);const Re=new Ee,wn=new ft;Ue.prototype.setBlendFunction=function(o,e){const t=this.blendState;Re.copy(t),Re.setColorBlend(t.colorOp,o,e),Re.setAlphaBlend(t.alphaOp,o,e),this.setBlendState(Re)},Ue.prototype.setBlendFunctionSeparate=function(o,e,t,s){const i=this.blendState;Re.copy(i),Re.setColorBlend(i.colorOp,o,e),Re.setAlphaBlend(i.alphaOp,t,s),this.setBlendState(Re)},Ue.prototype.setBlendEquation=function(o){const e=this.blendState;Re.copy(e),Re.setColorBlend(o,e.colorSrcFactor,e.colorDstFactor),Re.setAlphaBlend(o,e.alphaSrcFactor,e.alphaDstFactor),this.setBlendState(Re)},Ue.prototype.setBlendEquationSeparate=function(o,e){const t=this.blendState;Re.copy(t),Re.setColorBlend(o,t.colorSrcFactor,t.colorDstFactor),Re.setAlphaBlend(e,t.alphaSrcFactor,t.alphaDstFactor),this.setBlendState(Re)},Ue.prototype.setColorWrite=function(o,e,t,s){const i=this.blendState;Re.copy(i),Re.setColorWrite(o,e,t,s),this.setBlendState(Re)},Ue.prototype.getBlending=function(){return this.blendState.blend},Ue.prototype.setBlending=function(o){Re.copy(this.blendState),Re.blend=o,this.setBlendState(Re)},Ue.prototype.setDepthWrite=function(o){wn.copy(this.depthState),wn.write=o,this.setDepthState(wn)},Ue.prototype.setDepthFunc=function(o){wn.copy(this.depthState),wn.func=o,this.setDepthState(wn)},Ue.prototype.setDepthTest=function(o){wn.copy(this.depthState),wn.test=o,this.setDepthState(wn)},Ue.prototype.getCullMode=function(){return this.cullMode};const bz=Ct,Tz=Yh,wz={partitionSkin:pw,procedural:{calculateTangents:sn,createMesh:ks,createTorus:mm,createCylinder:gm,createCapsule:ym,createCone:vm,createSphere:xm,createPlane:Sm,createBox:Ho},BasicMaterial:bm,ForwardRenderer:fu,GraphNode:we,Material:pt,Mesh:Ut,MeshInstance:Te,Model:_i,ParticleEmitter:o_,PhongMaterial:Ct,Picker:Kw,Projection:{ORTHOGRAPHIC:Yn,PERSPECTIVE:Os},Scene:Vt,Skin:Eu,SkinInstance:ta};Object.defineProperty(Vt.prototype,"defaultMaterial",{get:function(){return Xo(qs().graphicsDevice)}}),Object.defineProperty(mu.prototype,"_meshInstances",{get:function(){return null}}),Object.defineProperty(Vt.prototype,"drawCalls",{get:function(){return null}}),["128","64","32","16","8","4"].forEach((o,e)=>{Object.defineProperty(Vt.prototype,`skyboxPrefiltered${o}`,{get:function(){return this._prefilteredCubemaps[e]},set:function(t){this._prefilteredCubemaps[e]=t,this.updateShaders=!0}})}),Object.defineProperty(Vt.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),Object.defineProperty(ln.prototype,"renderTarget",{set:function(o){this._renderTarget=o,this._dirtyComposition=!0},get:function(){return this._renderTarget}}),Vt.prototype.addModel=function(o){if(this.containsModel(o))return;const e=this.layers.getLayerById(is);e&&(e.addMeshInstances(o.meshInstances),this.models.push(o))},Vt.prototype.addShadowCaster=function(o){const e=this.layers.getLayerById(is);e&&e.addShadowCasters(o.meshInstances)},Vt.prototype.removeModel=function(o){const e=this.models.indexOf(o);if(e!==-1){const t=this.layers.getLayerById(is);if(!t)return;t.removeMeshInstances(o.meshInstances),this.models.splice(e,1)}},Vt.prototype.removeShadowCasters=function(o){const e=this.layers.getLayerById(is);e&&e.removeShadowCasters(o.meshInstances)},Vt.prototype.containsModel=function(o){return this.models.indexOf(o)>=0},Vt.prototype.getModels=function(o){return this.models},Object.defineProperty(Kd.prototype,"model",{get:function(){return null}}),fu.prototype.renderComposition=function(o){qs().renderComposition(o)},Te.prototype.syncAabb=function(){},gu.prototype.getTarget=function(o){return this.targets[o]},we.prototype._dirtify=function(o){o?this._dirtifyLocal():this._dirtifyWorld()},we.prototype.addLabel=function(o){this._labels[o]=!0},we.prototype.getLabels=function(){return Object.keys(this._labels)},we.prototype.hasLabel=function(o){return!!this._labels[o]},we.prototype.removeLabel=function(o){delete this._labels[o]},we.prototype.findByLabel=function(o,e=[]){this.hasLabel(o)&&e.push(this);for(let t=0;t<this._children.length;++t)e=this._children[t].findByLabel(o,e);return e},we.prototype.getChildren=function(){return this.children},we.prototype.getName=function(){return this.name},we.prototype.getPath=function(){return this.path},we.prototype.getRoot=function(){return this.root},we.prototype.getParent=function(){return this.parent},we.prototype.setName=function(o){this.name=o},pt.prototype.getName=function(){return this.name},pt.prototype.setName=function(o){this.name=o},pt.prototype.getShader=function(){return this.shader},pt.prototype.setShader=function(o){this.shader=o},Object.defineProperty(pt.prototype,"blend",{set:function(o){this.blendState.blend=o},get:function(){return this.blendState.blend}}),Object.defineProperty(pt.prototype,"blendSrc",{set:function(o){const e=this.blendState;Re.copy(e),Re.setColorBlend(e.colorOp,o,e.colorDstFactor),Re.setAlphaBlend(e.alphaOp,o,e.alphaDstFactor),this.blendState=Re},get:function(){return this.blendState.colorSrcFactor}}),Object.defineProperty(pt.prototype,"blendDst",{set:function(o){const e=this.blendState;Re.copy(e),Re.setColorBlend(e.colorOp,e.colorSrcFactor,o),Re.setAlphaBlend(e.alphaOp,e.alphaSrcFactor,o),this.blendState=Re},get:function(){return this.blendState.colorDstFactor}}),Object.defineProperty(Ct.prototype,"shininess",{get:function(){return this.gloss*100},set:function(o){this.gloss=o*.01}});function ws(o,e){Object.defineProperty(Ct.prototype,e,{get:function(){return this[o]},set:function(t){this[o]=t}})}ws("diffuseTint","diffuseMapTint"),ws("specularTint","specularMapTint"),ws("emissiveTint","emissiveMapTint"),ws("aoVertexColor","aoMapVertexColor"),ws("diffuseVertexColor","diffuseMapVertexColor"),ws("specularVertexColor","specularMapVertexColor"),ws("emissiveVertexColor","emissiveMapVertexColor"),ws("metalnessVertexColor","metalnessMapVertexColor"),ws("glossVertexColor","glossMapVertexColor"),ws("opacityVertexColor","opacityMapVertexColor"),ws("lightVertexColor","lightMapVertexColor"),ws("sheenGloss","sheenGlossiess"),ws("clearCoatGloss","clearCostGlossiness");function aE(o,e){o!=="pass"&&Object.defineProperty(jo.prototype,o,{get:function(){return this.litOptions[e||o]},set:function(t){this.litOptions[e||o]=t}})}aE("refraction","useRefraction");const Ez=new Yh,oE=Object.getOwnPropertyNames(Ez);for(const o in oE)aE(oE[o]);const Az={Animation:un,Key:Au,Node:Cu,Skeleton:$s};un.prototype.getDuration=function(){return this.duration},un.prototype.getName=function(){return this.name},un.prototype.getNodes=function(){return this.nodes},un.prototype.setDuration=function(o){this.duration=o},un.prototype.setName=function(o){this.name=o},$s.prototype.getAnimation=function(){return this.animation},$s.prototype.getCurrentTime=function(){return this.currentTime},$s.prototype.getLooping=function(){return this.looping},$s.prototype.getNumNodes=function(){return this.numNodes},$s.prototype.setAnimation=function(o){this.animation=o},$s.prototype.setCurrentTime=function(o){this.currentTime=o},$s.prototype.setLooping=function(o){this.looping=o};const Cz={AudioManager:Io,Channel:Ih,Channel3d:en,Listener:O0,Sound:Zp};Io.prototype.getListener=function(){return this.listener},Io.prototype.getVolume=function(){return this.volume},Io.prototype.setVolume=function(o){this.volume=o};const Mz={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};fa.prototype.getAssetById=function(o){return this.get(o)},Object.defineProperty(Wt.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(Wt.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(Wt.prototype,"rotation",{get:function(){return this._localRotation}});const Pz={getTouchTargetCoords:Yp,Controller:P0,GamePads:Rh,Keyboard:Po,KeyboardEvent:Gp,Mouse:ni,MouseEvent:Qi,Touch:Ld,TouchDevice:Kp,TouchEvent:Ro};Object.defineProperty(Na.prototype,"wheel",{get:function(){return this.wheelDelta*-2}}),Object.defineProperty(Qi.prototype,"wheel",{get:function(){return this.wheelDelta*-2}});const Rz=ga,Iz=Ss,Dz=lr,Lz=xb,Fz=U_,Oz=ya,Bz=Ac,Nz=Sb,kz=bb,Uz=qu,zz=ju;nt.prototype.isFullscreen=function(){return!!document.fullscreenElement},nt.prototype.enableFullscreen=function(o,e,t){o=o||this.graphicsDevice.canvas;const s=function n(){e(),document.removeEventListener("fullscreenchange",n)},i=function n(){t(),document.removeEventListener("fullscreenerror",n)};e&&document.addEventListener("fullscreenchange",s,!1),t&&document.addEventListener("fullscreenerror",i,!1),o.requestFullscreen?o.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):t()},nt.prototype.disableFullscreen=function(o){const e=function t(){o(),document.removeEventListener("fullscreenchange",t)};o&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()},nt.prototype.getSceneUrl=function(o){const e=this.scenes.find(o);return e?e.url:null},nt.prototype.loadScene=function(o,e){this.scenes.loadScene(o,e)},nt.prototype.loadSceneHierarchy=function(o,e){this.scenes.loadSceneHierarchy(o,e)},nt.prototype.loadSceneSettings=function(o,e){this.scenes.loadSceneSettings(o,e)},nt.prototype.renderMeshInstance=function(o,e){const t=e!=null&&e.layer?e.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(null,null,null,o,t)},nt.prototype.renderMesh=function(o,e,t,s){const i=s!=null&&s.layer?s.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(e,t,o,null,i)},nt.prototype._addLines=function(o,e,t){const s=t&&t.layer?t.layer:this.scene.layers.getLayerById(Ds),i=t&&t.depthTest!==void 0?t.depthTest:!0;this.scene.immediate.getBatch(s,i).addLines(o,e)},nt.prototype.renderLine=function(o,e,t){let s=t,i;const n=arguments[3],r=arguments[4];n instanceof H?(s=n,typeof r=="number"?r===Vf?i={layer:this.scene.layers.getLayerById(Ds),depthTest:!1}:i={layer:this.scene.layers.getLayerById(Ds),depthTest:!0}:i=r):typeof n=="number"?(s=t,n===Vf?i={layer:this.scene.layers.getLayerById(Ds),depthTest:!1}:i={layer:this.scene.layers.getLayerById(Ds),depthTest:!0}):n&&(i=n),this._addLines([o,e],[t,s],i)},nt.prototype.renderLines=function(o,e,t){if(t?typeof t=="number"&&(t===Vf?t={layer:this.scene.layers.getLayerById(Ds),depthTest:!1}:t={layer:this.scene.layers.getLayerById(Ds),depthTest:!0}):t={layer:this.scene.layers.getLayerById(Ds),depthTest:!0},!!e.length&&o.length!==e.length){console.error("renderLines: position/color arrays have different lengths");return}if(o.length%2!==0){console.error("renderLines: array length is not divisible by 2");return}this._addLines(o,e,t)},nt.prototype.enableVr=function(){},Object.defineProperty(cf.prototype,"node",{get:function(){return this.entity}}),Object.defineProperty(df.prototype,"enable",{get:function(){return this.enabled},set:function(o){this.enabled=o}}),Pc.prototype.setVisible=function(o){this.enabled=o},Object.defineProperty(Pc.prototype,"aabb",{get:function(){return null},set:function(o){}}),Object.defineProperty(nf.prototype,"aabb",{get:function(){return null},set:function(o){}}),Object.defineProperty(xi.prototype,"bodyType",{get:function(){return this.type},set:function(o){this.type=o}}),xi.prototype.syncBodyToEntity=function(){this._updateDynamic()},of.prototype.setGravity=function(){arguments.length===1?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};function Vz(o,e,t){Tf({glueUrl:o,wasmUrl:e,fallbackUrl:t,lazyInit:!0})}function Gz(o){}const Wz=Object.freeze(Object.defineProperty({__proto__:null,ABSOLUTE_URL:ua,ACTION_GAMEPAD:Md,ACTION_KEYBOARD:Cd,ACTION_MOUSE:Ad,ADDRESS_CLAMP_TO_EDGE:q,ADDRESS_MIRRORED_REPEAT:Ha,ADDRESS_REPEAT:Qe,ANIM_BLEND_1D:JS,ANIM_BLEND_2D_CARTESIAN:tb,ANIM_BLEND_2D_DIRECTIONAL:eb,ANIM_BLEND_DIRECT:sb,ANIM_CONTROL_STATES:mc,ANIM_EQUAL_TO:ZS,ANIM_GREATER_THAN:qS,ANIM_GREATER_THAN_EQUAL_TO:YS,ANIM_INTERRUPTION_NEXT:HS,ANIM_INTERRUPTION_NEXT_PREV:$S,ANIM_INTERRUPTION_NONE:b_,ANIM_INTERRUPTION_PREV:WS,ANIM_INTERRUPTION_PREV_NEXT:XS,ANIM_LAYER_ADDITIVE:ib,ANIM_LAYER_OVERWRITE:A_,ANIM_LESS_THAN:jS,ANIM_LESS_THAN_EQUAL_TO:KS,ANIM_NOT_EQUAL_TO:QS,ANIM_PARAMETER_BOOLEAN:E_,ANIM_PARAMETER_FLOAT:w_,ANIM_PARAMETER_INTEGER:T_,ANIM_PARAMETER_TRIGGER:pc,ANIM_STATE_ANY:rr,ANIM_STATE_END:Vu,ANIM_STATE_START:cl,ASPECT_AUTO:jd,ASPECT_MANUAL:Yd,ASSET_ANIMATION:oB,ASSET_AUDIO:lB,ASSET_CONTAINER:SB,ASSET_CSS:yB,ASSET_CUBEMAP:_B,ASSET_HTML:vB,ASSET_IMAGE:hB,ASSET_JSON:cB,ASSET_MATERIAL:uB,ASSET_MODEL:dB,ASSET_SCRIPT:xB,ASSET_SHADER:gB,ASSET_TEXT:fB,ASSET_TEXTURE:pB,ASSET_TEXTUREATLAS:mB,AXIS_KEY:LM,AXIS_MOUSE_X:CM,AXIS_MOUSE_Y:MM,AXIS_PAD_L_X:PM,AXIS_PAD_L_Y:RM,AXIS_PAD_R_X:IM,AXIS_PAD_R_Y:DM,AnimBinder:_a,AnimClip:ma,AnimClipHandler:YT,AnimComponent:D_,AnimComponentLayer:lb,AnimComponentSystem:hb,AnimController:ob,AnimCurve:wg,AnimData:Dc,AnimEvaluator:C_,AnimEvents:M_,AnimSnapshot:S_,AnimStateGraph:xc,AnimStateGraphHandler:KT,AnimTarget:Gu,AnimTrack:ki,Animation:un,AnimationComponent:P_,AnimationComponentSystem:rb,AnimationHandler:jT,AppBase:nt,AppOptions:NS,Application:qw,Asset:se,AssetListLoader:UU,AssetReference:_l,AssetRegistry:fa,AudioHandler:ZT,AudioListenerComponent:F_,AudioListenerComponentSystem:db,AudioSourceComponent:O_,AudioSourceComponentSystem:fb,BAKE_COLOR:gR,BAKE_COLORDIR:zh,BINDGROUP_MESH:So,BINDGROUP_VIEW:xd,BLENDEQUATION_ADD:hs,BLENDEQUATION_MAX:Fy,BLENDEQUATION_MIN:Ly,BLENDEQUATION_REVERSE_SUBTRACT:Dy,BLENDEQUATION_SUBTRACT:cA,BLENDMODE_CONSTANT:pp,BLENDMODE_CONSTANT_ALPHA:gz,BLENDMODE_CONSTANT_COLOR:mz,BLENDMODE_DST_ALPHA:Ry,BLENDMODE_DST_COLOR:$c,BLENDMODE_ONE:ut,BLENDMODE_ONE_MINUS_CONSTANT:mp,BLENDMODE_ONE_MINUS_CONSTANT_ALPHA:yz,BLENDMODE_ONE_MINUS_CONSTANT_COLOR:_z,BLENDMODE_ONE_MINUS_DST_ALPHA:Iy,BLENDMODE_ONE_MINUS_DST_COLOR:fp,BLENDMODE_ONE_MINUS_SRC_ALPHA:Bl,BLENDMODE_ONE_MINUS_SRC_COLOR:My,BLENDMODE_SRC_ALPHA:Ol,BLENDMODE_SRC_ALPHA_SATURATE:Py,BLENDMODE_SRC_COLOR:up,BLENDMODE_ZERO:Fl,BLEND_ADDITIVE:Od,BLEND_ADDITIVEALPHA:Nd,BLEND_MAX:sm,BLEND_MIN:tm,BLEND_MULTIPLICATIVE:Bd,BLEND_MULTIPLICATIVE2X:Jp,BLEND_NONE:Nt,BLEND_NORMAL:Bt,BLEND_PREMULTIPLIED:jn,BLEND_SCREEN:em,BLEND_SUBTRACTIVE:Qp,BLUR_BOX:Y1,BLUR_GAUSSIAN:zd,BODYFLAG_KINEMATIC_OBJECT:U_,BODYFLAG_NORESPONSE_OBJECT:ya,BODYFLAG_STATIC_OBJECT:xb,BODYGROUP_DEFAULT:qB,BODYGROUP_DYNAMIC:Tb,BODYGROUP_ENGINE_1:jB,BODYGROUP_ENGINE_2:YB,BODYGROUP_ENGINE_3:KB,BODYGROUP_KINEMATIC:wb,BODYGROUP_NONE:$B,BODYGROUP_STATIC:z_,BODYGROUP_TRIGGER:V_,BODYGROUP_USER_1:ZB,BODYGROUP_USER_2:QB,BODYGROUP_USER_3:JB,BODYGROUP_USER_4:eN,BODYGROUP_USER_5:tN,BODYGROUP_USER_6:sN,BODYGROUP_USER_7:iN,BODYGROUP_USER_8:nN,BODYMASK_ALL:G_,BODYMASK_NONE:rN,BODYMASK_NOT_STATIC:Yu,BODYMASK_NOT_STATIC_KINEMATIC:oN,BODYMASK_STATIC:aN,BODYSTATE_ACTIVE_TAG:Ac,BODYSTATE_DISABLE_DEACTIVATION:qu,BODYSTATE_DISABLE_SIMULATION:ju,BODYSTATE_ISLAND_SLEEPING:Sb,BODYSTATE_WANTS_DEACTIVATION:bb,BODYTYPE_DYNAMIC:Ss,BODYTYPE_KINEMATIC:lr,BODYTYPE_STATIC:ga,BUFFER_DYNAMIC:Pn,BUFFER_GPUDYNAMIC:qc,BUFFER_STATIC:St,BUFFER_STREAM:_p,BUTTON_TRANSITION_MODE_SPRITE_CHANGE:B_,BUTTON_TRANSITION_MODE_TINT:Xu,BasicMaterial:bm,Batch:Kd,BatchGroup:it,BatchManager:Ex,BinaryHandler:QT,BindBufferFormat:Eh,BindGroupFormat:Ah,BindStorageTextureFormat:cC,BindTextureFormat:Yi,BlendState:Ee,BoundingBox:ye,BoundingSphere:Cn,Bundle:Ou,BundleHandler:IS,BundleRegistry:PS,ButtonComponent:dt,ButtonComponentSystem:gb,CHUNKAPI_1_51:IA,CHUNKAPI_1_55:DA,CHUNKAPI_1_56:LA,CHUNKAPI_1_57:FA,CHUNKAPI_1_58:OA,CHUNKAPI_1_60:BA,CHUNKAPI_1_62:NA,CHUNKAPI_1_65:fv,CLEARFLAG_COLOR:xr,CLEARFLAG_DEPTH:Sr,CLEARFLAG_STENCIL:Xa,CUBEFACE_NEGX:uA,CUBEFACE_NEGY:pA,CUBEFACE_NEGZ:_A,CUBEFACE_POSX:dA,CUBEFACE_POSY:fA,CUBEFACE_POSZ:mA,CUBEPROJ_BOX:$0,CUBEPROJ_NONE:rm,CULLFACE_BACK:Ai,CULLFACE_FRONT:br,CULLFACE_FRONTANDBACK:gp,CULLFACE_NONE:Je,CURVE_CARDINAL:Sy,CURVE_CATMULL:tp,CURVE_LINEAR:xy,CURVE_SMOOTHSTEP:Gc,CURVE_SPLINE:sp,CURVE_STEP:by,Camera:sa,CameraComponent:cf,CameraComponentSystem:FT,CanvasFont:VU,ChunkBuilder:Gs,CollisionComponent:or,CollisionComponentSystem:Cb,Color:H,Component:he,ComponentSystem:Ve,ComponentSystemRegistry:RS,Compute:hM,ContactPoint:rT,ContactResult:aT,ContainerHandler:JT,ContainerResource:Bk,ContextCreationError:Hf,Controller:P0,CssHandler:ew,CubemapHandler:tw,Curve:os,CurveSet:Wi,DETAILMODE_ADD:tR,DETAILMODE_MAX:rR,DETAILMODE_MIN:nR,DETAILMODE_MUL:am,DETAILMODE_OVERLAY:iR,DETAILMODE_SCREEN:sR,DEVICETYPE_NULL:xh,DEVICETYPE_WEBGL1:xo,DEVICETYPE_WEBGL2:qr,DEVICETYPE_WEBGPU:Tp,DISTANCE_EXPONENTIAL:dp,DISTANCE_INVERSE:Ll,DISTANCE_LINEAR:Dl,DITHER_BAYER8:fm,DITHER_BLUENOISE:xR,DITHER_NONE:wt,DefaultAnimBinder:pn,DepthState:ft,ELEMENTTYPE_FLOAT32:lz,ELEMENTTYPE_GROUP:Sc,ELEMENTTYPE_IMAGE:$u,ELEMENTTYPE_INT16:nz,ELEMENTTYPE_INT32:az,ELEMENTTYPE_INT8:sz,ELEMENTTYPE_TEXT:N_,ELEMENTTYPE_UINT16:rz,ELEMENTTYPE_UINT32:oz,ELEMENTTYPE_UINT8:iz,EMITTERSHAPE_BOX:oi,EMITTERSHAPE_SPHERE:H0,EVENT_GAMEPADCONNECTED:g0,EVENT_GAMEPADDISCONNECTED:y0,EVENT_KEYDOWN:FM,EVENT_KEYUP:OM,EVENT_MOUSEDOWN:Bp,EVENT_MOUSEMOVE:Mh,EVENT_MOUSEUP:Np,EVENT_MOUSEWHEEL:Pd,EVENT_SELECT:zM,EVENT_SELECTEND:GM,EVENT_SELECTSTART:VM,EVENT_TOUCHCANCEL:UM,EVENT_TOUCHEND:NM,EVENT_TOUCHMOVE:kM,EVENT_TOUCHSTART:BM,ElementComponent:Rt,ElementComponentSystem:Vb,ElementDragHelper:gl,ElementInput:Na,ElementInputEvent:zf,ElementMouseEvent:Al,ElementSelectEvent:Tn,ElementTouchEvent:Cl,Entity:Ce,EntityReference:ar,EnvLighting:Bm,EventHandle:ly,EventHandler:Q,FILLMODE_FILL_WINDOW:bS,FILLMODE_KEEP_ASPECT:Iu,FILLMODE_NONE:u_,FILTER_LINEAR:Oe,FILTER_LINEAR_MIPMAP_LINEAR:Qs,FILTER_LINEAR_MIPMAP_NEAREST:Er,FILTER_NEAREST:de,FILTER_NEAREST_MIPMAP_LINEAR:wr,FILTER_NEAREST_MIPMAP_NEAREST:Tr,FITMODE_CONTAIN:pb,FITMODE_COVER:mb,FITMODE_STRETCH:bc,FITTING_BOTH:qb,FITTING_NONE:ef,FITTING_SHRINK:K_,FITTING_STRETCH:$b,FOG_EXP:G1,FOG_EXP2:W1,FOG_LINEAR:N0,FOG_NONE:Dh,FONT_BITMAP:Rb,FONT_MSDF:Cc,FRESNEL_NONE:H1,FRESNEL_SCHLICK:Lh,FUNC_ALWAYS:Ci,FUNC_EQUAL:Nl,FUNC_GREATER:By,FUNC_GREATEREQUAL:ky,FUNC_LESS:jc,FUNC_LESSEQUAL:Yc,FUNC_NEVER:Oy,FUNC_NOTEQUAL:Ny,FloatPacking:Fe,FolderHandler:sw,Font:Ig,FontHandler:iw,ForwardRenderer:fu,Frustum:lp,GAMMA_NONE:Fo,GAMMA_SRGB:om,GAMMA_SRGBFAST:q0,GAMMA_SRGBHDR:Oo,GSplat:SS,GSplatComponent:Sg,GSplatComponentSystem:NT,GSplatData:ol,GSplatHandler:lw,GSplatInstance:Ru,GSplatResource:nw,GamePads:Rh,GraphNode:we,GraphicsDevice:Ue,HierarchyHandler:hw,HtmlHandler:cw,Http:fe,I18n:DS,INDEXFORMAT_UINT16:Yt,INDEXFORMAT_UINT32:Mi,INDEXFORMAT_UINT8:kl,INTERPOLATION_CUBIC:zu,INTERPOLATION_LINEAR:Uu,INTERPOLATION_STEP:x_,ImageElement:Mb,IndexBuffer:Di,IndexedList:vy,JointComponent:Ju,JointComponentSystem:Wb,JsonHandler:dw,JsonStandardMaterialParser:uw,KEY_0:dP,KEY_1:uP,KEY_2:fP,KEY_3:pP,KEY_4:mP,KEY_5:_P,KEY_6:gP,KEY_7:yP,KEY_8:vP,KEY_9:xP,KEY_A:TP,KEY_ADD:l1,KEY_ALT:YM,KEY_B:wP,KEY_BACKSPACE:WM,KEY_BACK_SLASH:P1,KEY_C:EP,KEY_CAPS_LOCK:ZM,KEY_CLOSE_BRACKET:R1,KEY_COMMA:E1,KEY_CONTEXT_MENU:KP,KEY_CONTROL:jM,KEY_D:AP,KEY_DECIMAL:d1,KEY_DELETE:cP,KEY_DIVIDE:u1,KEY_DOWN:oP,KEY_E:CP,KEY_END:sP,KEY_ENTER:$M,KEY_EQUAL:bP,KEY_ESCAPE:QM,KEY_F:MP,KEY_F1:f1,KEY_F10:b1,KEY_F11:T1,KEY_F12:w1,KEY_F2:p1,KEY_F3:m1,KEY_F4:_1,KEY_F5:g1,KEY_F6:y1,KEY_F7:v1,KEY_F8:x1,KEY_F9:S1,KEY_G:PP,KEY_H:RP,KEY_HOME:iP,KEY_I:IP,KEY_INSERT:hP,KEY_J:DP,KEY_K:LP,KEY_L:FP,KEY_LEFT:nP,KEY_M:OP,KEY_META:I1,KEY_MULTIPLY:o1,KEY_N:BP,KEY_NUMPAD_0:ZP,KEY_NUMPAD_1:QP,KEY_NUMPAD_2:JP,KEY_NUMPAD_3:e1,KEY_NUMPAD_4:t1,KEY_NUMPAD_5:s1,KEY_NUMPAD_6:i1,KEY_NUMPAD_7:n1,KEY_NUMPAD_8:r1,KEY_NUMPAD_9:a1,KEY_O:NP,KEY_OPEN_BRACKET:M1,KEY_P:kP,KEY_PAGE_DOWN:tP,KEY_PAGE_UP:eP,KEY_PAUSE:KM,KEY_PERIOD:A1,KEY_PRINT_SCREEN:lP,KEY_Q:UP,KEY_R:zP,KEY_RETURN:XM,KEY_RIGHT:aP,KEY_S:VP,KEY_SEMICOLON:SP,KEY_SEPARATOR:h1,KEY_SHIFT:qM,KEY_SLASH:C1,KEY_SPACE:JM,KEY_SUBTRACT:c1,KEY_T:GP,KEY_TAB:HM,KEY_U:WP,KEY_UP:rP,KEY_V:HP,KEY_W:XP,KEY_WINDOWS:YP,KEY_X:$P,KEY_Y:qP,KEY_Z:jP,Key:Au,Keyboard:Po,KeyboardEvent:Gp,LAYERID_DEPTH:kt,LAYERID_IMMEDIATE:Ds,LAYERID_SKYBOX:kd,LAYERID_UI:Fh,LAYERID_WORLD:is,LAYER_FX:U0,LAYER_GIZMO:X1,LAYER_HUD:k0,LAYER_WORLD:im,LIGHTFALLOFF_INVERSESQUARED:W0,LIGHTFALLOFF_LINEAR:Ud,LIGHTSHAPE_DISK:V0,LIGHTSHAPE_PUNCTUAL:yt,LIGHTSHAPE_RECT:z0,LIGHTSHAPE_SPHERE:G0,LIGHTTYPE_COUNT:q1,LIGHTTYPE_DIRECTIONAL:ae,LIGHTTYPE_OMNI:be,LIGHTTYPE_POINT:$1,LIGHTTYPE_SPOT:Ie,LINEBATCH_GIZMO:YU,LINEBATCH_OVERLAY:Vf,LINEBATCH_WORLD:jU,Layer:ln,LayerComposition:mu,LayoutCalculator:Yb,LayoutChildComponent:Y_,LayoutChildComponentSystem:Xb,LayoutGroupComponent:J_,LayoutGroupComponentSystem:Qb,Light:el,LightComponent:df,LightComponentSystem:OT,LightingParams:s_,Lightmapper:GS,LitMaterial:V2,LitOptions:Tz,LitShaderOptions:Yh,LocalizedAsset:Pb,MASK_AFFECT_DYNAMIC:ns,MASK_AFFECT_LIGHTMAPPED:hi,MASK_BAKE:ci,MOTION_FREE:ba,MOTION_LIMITED:Ta,MOTION_LOCKED:wa,MOUSEBUTTON_LEFT:D1,MOUSEBUTTON_MIDDLE:L1,MOUSEBUTTON_NONE:Qv,MOUSEBUTTON_RIGHT:F1,Mat3:ls,Mat4:W,Material:pt,MaterialHandler:fw,Mesh:Ut,MeshInstance:Te,Model:_i,ModelComponent:Pc,ModelComponentSystem:eT,ModelHandler:mw,Morph:gu,MorphInstance:tr,MorphTarget:rc,Mouse:ni,MouseEvent:Qi,Node:Cu,NullGraphicsDevice:Zv,ORIENTATION_HORIZONTAL:pe,ORIENTATION_VERTICAL:Ae,OrientedBox:hA,PAD_1:Jv,PAD_2:O1,PAD_3:B1,PAD_4:N1,PAD_DOWN:f0,PAD_FACE_1:e0,PAD_FACE_2:t0,PAD_FACE_3:s0,PAD_FACE_4:i0,PAD_LEFT:p0,PAD_L_SHOULDER_1:n0,PAD_L_SHOULDER_2:a0,PAD_L_STICK_BUTTON:c0,PAD_L_STICK_X:kp,PAD_L_STICK_Y:Up,PAD_RIGHT:m0,PAD_R_SHOULDER_1:r0,PAD_R_SHOULDER_2:o0,PAD_R_STICK_BUTTON:d0,PAD_R_STICK_X:zp,PAD_R_STICK_Y:Vp,PAD_SELECT:l0,PAD_START:h0,PAD_UP:u0,PAD_VENDOR:_0,PARTICLEMODE_CPU:J1,PARTICLEMODE_GPU:nm,PARTICLEORIENTATION_EMITTER:eR,PARTICLEORIENTATION_SCREEN:Oh,PARTICLEORIENTATION_WORLD:X0,PARTICLESORT_DISTANCE:K1,PARTICLESORT_NEWER_FIRST:Z1,PARTICLESORT_NONE:Vd,PARTICLESORT_OLDER_FIRST:Q1,PIXELFORMAT_111110F:Ln,PIXELFORMAT_A8:Kc,PIXELFORMAT_ASTC_4x4:Zc,PIXELFORMAT_ATC_RGB:Qc,PIXELFORMAT_ATC_RGBA:Jc,PIXELFORMAT_BGRA8:ed,PIXELFORMAT_DEPTH:In,PIXELFORMAT_DEPTHSTENCIL:Dn,PIXELFORMAT_DXT1:ja,PIXELFORMAT_DXT3:zl,PIXELFORMAT_DXT5:Cr,PIXELFORMAT_ETC1:Ya,PIXELFORMAT_ETC2_RGB:Wl,PIXELFORMAT_ETC2_RGBA:Hl,PIXELFORMAT_L8:Ul,PIXELFORMAT_L8_A8:hz,PIXELFORMAT_LA8:$a,PIXELFORMAT_PVRTC_2BPP_RGBA_1:Ir,PIXELFORMAT_PVRTC_2BPP_RGB_1:Rr,PIXELFORMAT_PVRTC_4BPP_RGBA_1:Za,PIXELFORMAT_PVRTC_4BPP_RGB_1:Ka,PIXELFORMAT_R16F:Qa,PIXELFORMAT_R16I:$l,PIXELFORMAT_R16U:ql,PIXELFORMAT_R32F:Pi,PIXELFORMAT_R32I:jl,PIXELFORMAT_R32U:Yl,PIXELFORMAT_R4_G4_B4_A4:uz,PIXELFORMAT_R5_G5_B5_A1:dz,PIXELFORMAT_R5_G6_B5:cz,PIXELFORMAT_R8I:Xl,PIXELFORMAT_R8U:td,PIXELFORMAT_R8_G8_B8:fz,PIXELFORMAT_R8_G8_B8_A8:pz,PIXELFORMAT_RG16F:ah,PIXELFORMAT_RG16I:Zl,PIXELFORMAT_RG16U:Ql,PIXELFORMAT_RG32I:Jl,PIXELFORMAT_RG32U:eh,PIXELFORMAT_RG8I:Kl,PIXELFORMAT_RG8U:sd,PIXELFORMAT_RGB16F:Mr,PIXELFORMAT_RGB32F:Pr,PIXELFORMAT_RGB565:Rn,PIXELFORMAT_RGB8:Es,PIXELFORMAT_RGBA16F:et,PIXELFORMAT_RGBA16I:sh,PIXELFORMAT_RGBA16U:ih,PIXELFORMAT_RGBA32F:Ge,PIXELFORMAT_RGBA32I:nh,PIXELFORMAT_RGBA32U:rh,PIXELFORMAT_RGBA4:Ar,PIXELFORMAT_RGBA5551:qa,PIXELFORMAT_RGBA8:oe,PIXELFORMAT_RGBA8I:th,PIXELFORMAT_RGBA8U:id,PIXELFORMAT_SRGB:Vl,PIXELFORMAT_SRGBA:Gl,PRIMITIVE_LINELOOP:rd,PRIMITIVE_LINES:eo,PRIMITIVE_LINESTRIP:ad,PRIMITIVE_POINTS:Lr,PRIMITIVE_TRIANGLES:Js,PRIMITIVE_TRIFAN:Xi,PRIMITIVE_TRISTRIP:As,PROJECTION_ORTHOGRAPHIC:Yn,PROJECTION_PERSPECTIVE:Os,ParticleEmitter:o_,ParticleSystemComponent:eg,ParticleSystemComponentSystem:sT,PhongMaterial:bz,Picker:Kw,Plane:cp,PostEffect:l_,PostEffectQueue:gg,ProgramLibrary:h_,QuadRender:qh,Quat:Z,RENDERSTYLE_POINTS:Bh,RENDERSTYLE_SOLID:Lo,RENDERSTYLE_WIREFRAME:Kn,RESOLUTION_AUTO:f_,RESOLUTION_FIXED:TS,RIGIDBODY_ACTIVE_TAG:Bz,RIGIDBODY_CF_KINEMATIC_OBJECT:Fz,RIGIDBODY_CF_NORESPONSE_OBJECT:Oz,RIGIDBODY_CF_STATIC_OBJECT:Lz,RIGIDBODY_DISABLE_DEACTIVATION:Uz,RIGIDBODY_DISABLE_SIMULATION:zz,RIGIDBODY_ISLAND_SLEEPING:Nz,RIGIDBODY_TYPE_DYNAMIC:Iz,RIGIDBODY_TYPE_KINEMATIC:Dz,RIGIDBODY_TYPE_STATIC:Rz,RIGIDBODY_WANTS_DEACTIVATION:kz,Ray:Mn,RaycastResult:ig,ReadStream:ep,RenderComponent:nf,RenderComponentSystem:iT,RenderHandler:zT,RenderPass:Ot,RenderPassColorGrab:Cx,RenderPassForward:eS,RenderPassShaderQuad:Mu,RenderTarget:qe,ResourceHandler:Le,ResourceLoader:pa,RigidBodyComponent:xi,RigidBodyComponentSystem:of,SAMPLETYPE_DEPTH:Nr,SAMPLETYPE_FLOAT:kn,SAMPLETYPE_INT:fo,SAMPLETYPE_UINT:po,SAMPLETYPE_UNFILTERABLE_FLOAT:Un,SCALEMODE_BLEND:lT,SCALEMODE_NONE:Ma,SCROLLBAR_VISIBILITY_SHOW_ALWAYS:vT,SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED:xT,SCROLL_MODE_BOUNCE:ug,SCROLL_MODE_CLAMP:gT,SCROLL_MODE_INFINITE:yT,SEMANTIC_ATTR:zy,SEMANTIC_ATTR0:oo,SEMANTIC_ATTR1:oh,SEMANTIC_ATTR10:cd,SEMANTIC_ATTR11:dd,SEMANTIC_ATTR12:lo,SEMANTIC_ATTR13:Bn,SEMANTIC_ATTR14:ho,SEMANTIC_ATTR15:Nn,SEMANTIC_ATTR2:ld,SEMANTIC_ATTR3:hd,SEMANTIC_ATTR4:yp,SEMANTIC_ATTR5:Vy,SEMANTIC_ATTR6:Gy,SEMANTIC_ATTR7:Wy,SEMANTIC_ATTR8:Fn,SEMANTIC_ATTR9:On,SEMANTIC_BLENDINDICES:Kt,SEMANTIC_BLENDWEIGHT:ti,SEMANTIC_COLOR:_t,SEMANTIC_NORMAL:Dt,SEMANTIC_POSITION:We,SEMANTIC_TANGENT:ei,SEMANTIC_TEXCOORD:od,SEMANTIC_TEXCOORD0:Lt,SEMANTIC_TEXCOORD1:Ri,SEMANTIC_TEXCOORD2:to,SEMANTIC_TEXCOORD3:so,SEMANTIC_TEXCOORD4:io,SEMANTIC_TEXCOORD5:no,SEMANTIC_TEXCOORD6:ro,SEMANTIC_TEXCOORD7:ao,SHADERDEF_DIRLM:Wd,SHADERDEF_INSTANCING:ko,SHADERDEF_LM:kh,SHADERDEF_LMAMBIENT:Xd,SHADERDEF_MORPH_NORMAL:Vo,SHADERDEF_MORPH_POSITION:zo,SHADERDEF_MORPH_TEXTURE_BASED:Go,SHADERDEF_NOSHADOW:Nh,SHADERDEF_SCREENSPACE:Uo,SHADERDEF_SKIN:No,SHADERDEF_TANGENTS:Hd,SHADERDEF_UV0:lm,SHADERDEF_UV1:hm,SHADERDEF_VCOLOR:cm,SHADERLANGUAGE_GLSL:CA,SHADERLANGUAGE_WGSL:mo,SHADERPASS_ALBEDO:oR,SHADERPASS_AO:fR,SHADERPASS_EMISSION:pR,SHADERPASS_FORWARD:aR,SHADERPASS_GLOSS:dR,SHADERPASS_LIGHTING:mR,SHADERPASS_METALNESS:uR,SHADERPASS_OPACITY:hR,SHADERPASS_SPECULARITY:cR,SHADERPASS_UV0:_R,SHADERPASS_WORLDNORMAL:lR,SHADERSTAGE_COMPUTE:cv,SHADERSTAGE_FRAGMENT:Jt,SHADERSTAGE_VERTEX:jr,SHADERTAG_MATERIAL:Hy,SHADER_DEPTH:ui,SHADER_FORWARD:Wo,SHADER_FORWARDHDR:di,SHADER_PICK:ea,SHADER_PREPASS_VELOCITY:Uh,SHADER_SHADOW:dm,SHADOWUPDATE_NONE:Bs,SHADOWUPDATE_REALTIME:$d,SHADOWUPDATE_THISFRAME:Zn,SHADOW_DEPTH:j1,SHADOW_PCF1:ai,SHADOW_PCF3:at,SHADOW_PCF5:Fs,SHADOW_PCSS:At,SHADOW_VSM16:Ls,SHADOW_VSM32:ps,SHADOW_VSM8:fs,SKYTYPE_BOX:ix,SKYTYPE_DOME:nx,SKYTYPE_INFINITE:Wh,SORTKEY_DEPTH:qd,SORTKEY_FORWARD:Li,SORTMODE_BACK2FRONT:um,SORTMODE_CUSTOM:sx,SORTMODE_FRONT2BACK:tx,SORTMODE_MANUAL:J0,SORTMODE_MATERIALMESH:ex,SORTMODE_NONE:Gh,SPECOCC_AO:Jr,SPECOCC_GLOSSDEPENDENT:Gd,SPECOCC_NONE:Q0,SPECULAR_BLINN:Qr,SPECULAR_PHONG:li,SPRITETYPE_ANIMATED:_g,SPRITETYPE_SIMPLE:mg,SPRITE_RENDERMODE_SIMPLE:Fi,SPRITE_RENDERMODE_SLICED:ot,SPRITE_RENDERMODE_TILED:st,STENCILOP_DECREMENT:qy,STENCILOP_DECREMENTWRAP:vA,STENCILOP_INCREMENT:$y,STENCILOP_INCREMENTWRAP:yA,STENCILOP_INVERT:xA,STENCILOP_KEEP:Fr,STENCILOP_REPLACE:Xy,STENCILOP_ZERO:gA,Scene:Vt,SceneHandler:_w,SceneRegistry:OS,SceneRegistryItem:g_,SceneSettingsHandler:HU,ScopeId:Ep,ScopeSpace:Pv,ScreenComponent:ng,ScreenComponentSystem:dT,ScriptAttributes:dr,ScriptComponent:zi,ScriptComponentSystem:BT,ScriptHandler:vw,ScriptLegacyComponent:rg,ScriptLegacyComponentSystem:fT,ScriptRegistry:LS,ScriptType:Gt,ScrollViewComponent:lf,ScrollViewComponentSystem:ST,ScrollbarComponent:hf,ScrollbarComponentSystem:bT,Shader:Is,ShaderGenerator:me,ShaderHandler:xw,ShaderPass:zs,ShaderProcessorOptions:Zi,ShaderUtils:je,SingleContactResult:nT,Skeleton:$s,Skin:Eu,SkinBatchInstance:Tm,SkinInstance:ta,SortedLoopArray:Rl,Sound:Zp,SoundComponent:cr,SoundComponentSystem:wT,SoundInstance:us,SoundInstance3d:Zr,SoundManager:Io,SoundSlot:xn,Sprite:pS,SpriteAnimationClip:Ui,SpriteComponent:Sn,SpriteComponentSystem:RT,SpriteHandler:Sw,StandardMaterial:Ct,StandardMaterialOptions:jo,StencilParameters:cs,TEXHINT_ASSET:TA,TEXHINT_LIGHTMAP:wA,TEXHINT_NONE:SA,TEXHINT_SHADOWMAP:bA,TEXTUREDIMENSION_1D:EA,TEXTUREDIMENSION_2D:Ft,TEXTUREDIMENSION_2D_ARRAY:co,TEXTUREDIMENSION_3D:lh,TEXTUREDIMENSION_CUBE:uo,TEXTUREDIMENSION_CUBE_ARRAY:AA,TEXTURELOCK_NONE:ud,TEXTURELOCK_READ:vp,TEXTURELOCK_WRITE:fd,TEXTUREPROJECTION_CUBE:md,TEXTUREPROJECTION_EQUIRECT:xp,TEXTUREPROJECTION_NONE:jy,TEXTUREPROJECTION_OCTAHEDRAL:Yy,TEXTURETYPE_DEFAULT:bt,TEXTURETYPE_RGBE:pd,TEXTURETYPE_RGBM:Cs,TEXTURETYPE_RGBP:Or,TEXTURETYPE_SWIZZLEGGGR:Br,TONEMAP_ACES:K0,TONEMAP_ACES2:Z0,TONEMAP_FILMIC:j0,TONEMAP_HEJL:Y0,TONEMAP_LINEAR:Bo,TRACEID_BINDGROUPFORMAT_ALLOC:ME,TRACEID_BINDGROUP_ALLOC:CE,TRACEID_COMPUTEPIPELINE_ALLOC:RE,TRACEID_GPU_TIMINGS:oy,TRACEID_PIPELINELAYOUT_ALLOC:IE,TRACEID_RENDERPIPELINE_ALLOC:PE,TRACEID_RENDER_ACTION:vE,TRACEID_RENDER_FRAME:yr,TRACEID_RENDER_FRAME_TIME:_E,TRACEID_RENDER_PASS:gE,TRACEID_RENDER_PASS_DETAIL:yE,TRACEID_RENDER_QUEUE:FE,TRACEID_RENDER_TARGET_ALLOC:xE,TRACEID_SHADER_ALLOC:bE,TRACEID_SHADER_COMPILE:TE,TRACEID_TEXTURES:LE,TRACEID_TEXTURE_ALLOC:SE,TRACEID_VRAM_IB:AE,TRACEID_VRAM_TEXTURE:wE,TRACEID_VRAM_VB:EE,TRACE_ID_ELEMENT:DE,TYPE_FLOAT16:_d,TYPE_FLOAT32:le,TYPE_INT16:ii,TYPE_INT32:xe,TYPE_INT8:si,TYPE_UINT16:Ms,TYPE_UINT32:tt,TYPE_UINT8:Zt,Tags:Va,Template:zg,TemplateHandler:bw,TextElement:kb,TextHandler:Tw,Texture:re,TextureAtlas:mS,TextureAtlasHandler:ww,TextureHandler:Pw,TextureParser:xU,TextureUtils:Ii,Touch:Ld,TouchDevice:Kp,TouchEvent:Ro,Tracing:Ua,TransformFeedback:fM,UNIFORMTYPE_BOOL:kr,UNIFORMTYPE_BOOLARRAY:ph,UNIFORMTYPE_BVEC2:_o,UNIFORMTYPE_BVEC2ARRAY:_h,UNIFORMTYPE_BVEC3:go,UNIFORMTYPE_BVEC3ARRAY:yh,UNIFORMTYPE_BVEC4:yo,UNIFORMTYPE_BVEC4ARRAY:vd,UNIFORMTYPE_FLOAT:Ps,UNIFORMTYPE_FLOATARRAY:ch,UNIFORMTYPE_INT:zn,UNIFORMTYPE_INTARRAY:Hr,UNIFORMTYPE_ITEXTURE2D:sv,UNIFORMTYPE_ITEXTURE2D_ARRAY:lv,UNIFORMTYPE_ITEXTURE3D:av,UNIFORMTYPE_ITEXTURECUBE:nv,UNIFORMTYPE_IVEC2:Gn,UNIFORMTYPE_IVEC2ARRAY:Xr,UNIFORMTYPE_IVEC3:Wn,UNIFORMTYPE_IVEC3ARRAY:$r,UNIFORMTYPE_IVEC4:Hn,UNIFORMTYPE_IVEC4ARRAY:vh,UNIFORMTYPE_MAT2:hh,UNIFORMTYPE_MAT3:vo,UNIFORMTYPE_MAT4:Ur,UNIFORMTYPE_MAT4ARRAY:Sp,UNIFORMTYPE_TEXTURE2D:Ky,UNIFORMTYPE_TEXTURE2D_ARRAY:tv,UNIFORMTYPE_TEXTURE2D_SHADOW:Qy,UNIFORMTYPE_TEXTURE3D:ev,UNIFORMTYPE_TEXTURECUBE:Zy,UNIFORMTYPE_TEXTURECUBE_SHADOW:Jy,UNIFORMTYPE_UINT:zr,UNIFORMTYPE_UINTARRAY:fh,UNIFORMTYPE_UTEXTURE2D:iv,UNIFORMTYPE_UTEXTURE2D_ARRAY:hv,UNIFORMTYPE_UTEXTURE3D:ov,UNIFORMTYPE_UTEXTURECUBE:rv,UNIFORMTYPE_UVEC2:Vr,UNIFORMTYPE_UVEC2ARRAY:mh,UNIFORMTYPE_UVEC3:Gr,UNIFORMTYPE_UVEC3ARRAY:gh,UNIFORMTYPE_UVEC4:Wr,UNIFORMTYPE_UVEC4ARRAY:yd,UNIFORMTYPE_VEC2:$i,UNIFORMTYPE_VEC2ARRAY:dh,UNIFORMTYPE_VEC3:Qt,UNIFORMTYPE_VEC3ARRAY:uh,UNIFORMTYPE_VEC4:Vn,UNIFORMTYPE_VEC4ARRAY:gd,UNIFORM_BUFFER_DEFAULT_SLOT_NAME:bo,URI:Vc,UniformBufferFormat:wh,UniformFormat:rt,UnsupportedBrowserError:Wf,VIEW_CENTER:Vh,VIEW_LEFT:yR,VIEW_RIGHT:vR,Vec2:G,Vec3:y,Vec4:X,VertexBuffer:es,VertexFormat:Tt,VertexIterator:Kr,WasmModule:za,WebglGraphicsDevice:Op,WebgpuGraphicsDevice:Vv,WorldClusters:nu,XRDEPTHSENSINGFORMAT_F32:Bw,XRDEPTHSENSINGFORMAT_L8A8:Xg,XRDEPTHSENSINGUSAGE_CPU:Fw,XRDEPTHSENSINGUSAGE_GPU:Ow,XREYE_LEFT:RU,XREYE_NONE:PU,XREYE_RIGHT:IU,XRHAND_LEFT:Lw,XRHAND_NONE:DU,XRHAND_RIGHT:LU,XRPAD_A:C0,XRPAD_B:M0,XRPAD_SQUEEZE:E0,XRPAD_STICK_BUTTON:A0,XRPAD_STICK_X:S0,XRPAD_STICK_Y:b0,XRPAD_TOUCHPAD_BUTTON:T0,XRPAD_TOUCHPAD_X:v0,XRPAD_TOUCHPAD_Y:x0,XRPAD_TRIGGER:w0,XRSPACE_BOUNDEDFLOOR:wU,XRSPACE_LOCAL:bU,XRSPACE_LOCALFLOOR:TU,XRSPACE_UNBOUNDED:EU,XRSPACE_VIEWER:Dw,XRTARGETRAY_GAZE:AU,XRTARGETRAY_POINTER:MU,XRTARGETRAY_SCREEN:CU,XRTRACKABLE_MESH:BU,XRTRACKABLE_PLANE:OU,XRTRACKABLE_POINT:FU,XRTYPE_AR:vl,XRTYPE_INLINE:Rw,XRTYPE_VR:Iw,XrAnchor:bl,XrAnchors:Oa,XrDepthSensing:Fc,XrDomOverlay:Nw,XrFinger:Uw,XrHand:Pf,XrHitTest:fr,XrHitTestSource:Ef,XrImageTracking:$g,XrInput:Vi,XrInputSource:Wt,XrJoint:qg,XrLightEstimation:Rf,XrManager:Ba,XrMeshDetection:Tl,XrPlane:If,XrPlaneDetection:Sl,XrTrackedImage:Af,XrView:Kg,XrViews:Oc,ZoneComponent:Ra,ZoneComponentSystem:DT,anim:Az,get app(){return y_},apps:NE,asset:Mz,audio:Cz,basisInitialize:Tf,basisSetDownloadConfig:Vz,bindGroupNames:dv,calculateNormals:rx,calculateTangents:sn,common:BE,config:OE,createBox:Ho,createCapsule:ym,createCone:vm,createCylinder:gm,createGraphicsDevice:lM,createMesh:ks,createPlane:Sm,createScript:gw,createShader:dx,createShaderFromCode:zt,createSphere:xm,createStyle:ez,createTorus:mm,createURI:iA,data:kE,dracoInitialize:Ag,drawFullscreenQuad:rE,drawQuadWithShader:_s,drawTexture:l2,events:zc,extend:Gi,getPixelFormatArrayType:Uy,getProgramLibrary:Us,getReservedScriptNames:Jk,getTouchTargetCoords:Yp,gfx:vz,guid:hy,http:He,inherits:QU,input:Pz,isCompressedPixelFormat:nd,isIntegerPixelFormat:Dr,log:Gf,makeArray:JU,math:U,now:jt,path:ce,pixelFormatInfo:Ja,platform:ge,posteffect:Sz,prefilterCubemap:Gz,programlib:nE,registerScript:Ng,reprojectTexture:Bi,revision:Yf,scene:wz,script:vt,semanticToLocation:Se,shFromCubemap:NO,shaderChunks:z,shaderChunksLightmapper:lc,shadowTypeToString:tn,shape:tz,string:bi,time:ZU,type:Uc,typedArrayIndexFormats:Sd,typedArrayIndexFormatsByteSize:uv,typedArrayToType:RA,typedArrayTypes:Yr,typedArrayTypesByteSize:To,uniformTypeToName:bp,uniformTypeToStorage:MA,version:jf,vertexTypesNames:PA},Symbol.toStringTag,{value:"Module"}));window.pc=Wz,window.loadModules=function(o,e,t){if(typeof o>"u"||o.length===0)setTimeout(t);else{let s=o.length;const i=()=>{--s===0&&t()};o.forEach(function(n){za.setConfig(n.moduleName,{glueUrl:e+n.glueUrl,wasmUrl:e+n.wasmUrl,fallbackUrl:e+n.fallbackUrl}),!n.hasOwnProperty("preload")||n.preload?n.moduleName==="BASIS"?(Tf(),i()):n.moduleName==="DracoDecoderModule"?Ag?(Ag(),i()):za.getInstance(n.moduleName,()=>{i()}):za.getInstance(n.moduleName,()=>{i()}):i()})}};class Hz{constructor(e){ka(this,"canvas",document.createElement("canvas"));ka(this,"devices",{});ka(this,"app");ka(this,"lastWindowSize");ka(this,"windowSizeChangeIntervalHandler");ka(this,"assetPrefix","test");const{innerWidth:t,innerHeight:s}=window;this.lastWindowSize={width:t,height:s},this.assetPrefix=window.ASSET_PREFIX,window.ASSET_PREFIX="",window.SCRIPT_PREFIX="",window.CONTEXT_OPTIONS={antialias:!0,alpha:!0,preserveDrawingBuffer:!0,preferWebGl2:!0,powerPreference:"high-performance"},window.SCRIPTS=[],window.CONFIG_FILENAME="config.json",window.INPUT_SETTINGS={useKeyboard:!0,useMouse:!0,useGamepads:!1,useTouch:!0},vt.legacy=!1,window.PRELOAD_MODULES=[],window.SCRIPT_PREFIX=this.assetPrefix,window.iosVersion=lE(),this.createCanvas(e),this.createInputDevices(),this.createApp();const i=this.configure.bind(this);window.PRELOAD_MODULES.length>0&&window.loadModules?window.loadModules(window.PRELOAD_MODULES,window.ASSET_PREFIX,i):i()}createCanvas(e="application-canvas"){this.canvas.setAttribute("id",e),this.canvas.setAttribute("tabindex","0"),this.canvas.onselectstart=function(){return!1},this.canvas.style["-webkit-user-select"]="none",document.body.appendChild(this.canvas)}createInputDevices(){const{INPUT_SETTINGS:e}=window;this.devices={elementInput:new Na(this.canvas,{useMouse:e.useMouse,useTouch:e.useTouch}),keyboard:e.useKeyboard?new Po(window):void 0,mouse:e.useMouse?new ni(this.canvas):void 0,gamepads:e.useGamepads?new Rh:void 0,touch:e.useTouch&&ge.touch?new Kp(this.canvas):void 0}}createApp(){const{CONTEXT_OPTIONS:e,ASSET_PREFIX:t="",SCRIPT_PREFIX:s="",SCRIPTS:i=[]}=window;try{this.app=new qw(this.canvas,{elementInput:this.devices.elementInput,keyboard:this.devices.keyboard,mouse:this.devices.mouse,gamepads:this.devices.gamepads,touch:this.devices.touch,graphicsDeviceOptions:e,assetPrefix:t,scriptPrefix:s,scriptsOrder:i}),window.app=this.app}catch(n){n instanceof Wf?this.displayError('This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to find out more.</a>'):n instanceof Hf?this.displayError(`It doesn't appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`):this.displayError("Could not initialize application. Error: "+n);return}}displayError(e){const t=document.createElement("div");t.innerHTML=['<table style="background-color: #8CE; width: 100%; height: 100%;">',"  <tr>",'      <td align="center">','          <div style="display: table-cell; vertical-align: middle;">','              <div style="">'+e+"</div>","          </div>","      </td>","  </tr>","</table>"].join(`
`),document.body.appendChild(t)}configureCss(e,t,s){this.canvas.classList&&this.canvas.classList.add("fill-mode-"+e);var i="@media screen and (min-aspect-ratio: "+t+"/"+s+") {";i+="    #application-canvas.fill-mode-KEEP_ASPECT {",i+="        width: auto;",i+="        height: 100%;",i+="        margin: 0 auto;",i+="    }",i+="}";let n=document.head.querySelector("style");n&&(n.innerHTML+=i)}resizeCanvas(){const{app:e,canvas:t}=this;if(!e||!t)throw new Error("resize canvas failed with app and canvs not found...");t.style.width="",t.style.height="",e.resizeCanvas(t.width,t.height);var s=e._fillMode;(s==u_||s==Iu)&&(s==u_&&t.clientHeight<window.innerHeight||t.clientWidth/t.clientHeight>=window.innerWidth/window.innerHeight?t.style.marginTop=Math.floor((window.innerHeight-t.clientHeight)/2)+"px":t.style.marginTop=""),this.lastWindowSize.height=window.innerHeight,this.lastWindowSize.width=window.innerWidth,window.iosVersion&&window.iosVersion[0]<=12&&window.scrollTo(0,0)}reflow(){const{lastWindowSize:e}=this,t=this.resizeCanvas.bind(this);let{windowSizeChangeIntervalHandler:s}=this;t(),s===null&&(s=setInterval(()=>{(e.height!==window.innerHeight||e.width!==window.innerWidth)&&t()},100),setTimeout(function(){s&&(clearInterval(s),s=null)},2e3))}configure(){const{app:e}=this,t=this.configureCss.bind(this),s=this.reflow.bind(this),i=()=>{s()},{CONFIG_FILENAME:n}=window;e==null||e.configure(`./${n}`,r=>{r&&console.error(r),t(e._fillMode,e._width,e._height);const a=[],l=[];a.length&&l.length&&e.setAreaLightLuts.length===2&&e.setAreaLightLuts(a,l),setTimeout(()=>{s(),window.addEventListener("resize",i,!1),window.addEventListener("orientationchange",i,!1)})})}}function lE(){if(/iP(hone|od|ad)/.test(navigator.platform)){var o=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);if(!o)return;var e=[parseInt(o[1],10),parseInt(o[2],10),parseInt(o[3]||"0",10)];return e}}as.PlaycanvasRenderer=Hz,as.getIosVersion=lE,Object.defineProperty(as,Symbol.toStringTag,{value:"Module"})});
